<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - CNPERP ERP System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">

    <style>
        :root {
            --settings-bg: #f4f6fb;
            --settings-sidebar-bg: #ffffff;
            --settings-sidebar-border: #e5ebf5;
            --settings-text-primary: #1f2a44;
            --settings-text-muted: #6f7d97;
            --settings-accent: #3b82f6;
            --settings-card-border: #e3e8f2;
        }

        body.settings-body {
            background: var(--settings-bg);
            color: var(--settings-text-primary);
            min-height: 100vh;
            font-family: "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
        }

        .settings-layout {
            max-width: 1500px;
        }

        .settings-sidebar {
            background: var(--settings-sidebar-bg);
            border: 1px solid var(--settings-sidebar-border);
            border-radius: 18px;
            box-shadow: 0 12px 30px -12px rgba(31, 51, 73, 0.25);
            padding: 1.75rem 1.5rem;
            position: sticky;
            top: 100px;
        }

        .settings-sidebar h4 {
            font-weight: 600;
            margin-bottom: 1.5rem;
        }

        .settings-nav .nav-link {
            display: flex;
            align-items: center;
            gap: 0.65rem;
            color: var(--settings-accent) !important;
            font-weight: 500;
            padding: 0.65rem 0.85rem;
            border-radius: 10px;
            transition: all 0.2s ease;
        }

        .settings-nav .nav-link i {
            font-size: 1.1rem;
            color: inherit;
        }

        .settings-nav .nav-link:hover {
            color: var(--settings-text-primary) !important;
            background: rgba(59, 130, 246, 0.16);
        }

        .settings-nav .nav-link.active {
            color: var(--settings-accent) !important;
            background: transparent;
            box-shadow: none;
        }

        .settings-card {
            background: #ffffff;
            border: 1px solid var(--settings-card-border);
            border-radius: 18px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 12px 24px -16px rgba(31, 51, 73, 0.3);
        }

        .settings-card h3 {
            font-size: 1.35rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .settings-card h3 i {
            font-size: 1.45rem;
            color: var(--settings-accent);
        }

        .settings-highlight-box {
            border-radius: 14px;
            border: 1px dashed rgba(59, 130, 246, 0.25);
            background: rgba(59, 130, 246, 0.08);
            padding: 1.5rem;
        }

        .settings-subheading {
            font-size: 1rem;
            font-weight: 600;
            color: var(--settings-text-primary);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .settings-subheading i {
            color: var(--settings-accent);
        }

        label.form-label {
            font-weight: 600;
            color: var(--settings-text-primary);
            font-size: 0.95rem;
        }

        .form-text,
        .text-muted {
            color: var(--settings-text-muted) !important;
        }

        .settings-toolbar .btn {
            border-radius: 999px;
            padding: 0.5rem 1.25rem;
        }

        .stats-card {
            border-radius: 16px;
            border: 1px solid rgba(59, 130, 246, 0.1);
            background: linear-gradient(180deg, rgba(59, 130, 246, 0.12) 0%, rgba(59, 130, 246, 0.05) 100%);
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.35);
            padding: 1.5rem;
            transition: transform 0.2s ease;
        }

        .stats-card:hover {
            transform: translateY(-4px);
        }

        .stats-card i {
            font-size: 1.8rem;
            color: var(--settings-accent);
        }

        .stats-card h4 {
            font-weight: 700;
            margin: 0.75rem 0 0.35rem;
        }

        .settings-section-tabs .nav-link {
            border-radius: 999px;
            padding: 0.4rem 1.25rem;
            color: var(--settings-text-muted);
        }

        .settings-section-tabs .nav-link.active {
            background: var(--settings-accent);
            color: #ffffff;
            box-shadow: 0 10px 18px -14px rgba(59, 130, 246, 0.9);
        }

        .table.table-hover thead th {
            background: rgba(59, 130, 246, 0.05);
            border-bottom: 1px solid rgba(59, 130, 246, 0.15);
            color: var(--settings-text-muted);
        }

        .badge {
            font-weight: 600;
            font-size: 0.75rem;
        }

        .currency-selector,
        .theme-selector,
        .business-selector {
            border-radius: 16px;
            padding: 1.5rem;
            background: #ffffff;
            color: var(--settings-text-primary);
        }

        .currency-selector {
            border: none;
            box-shadow: none;
        }

        .theme-selector,
        .business-selector {
            border: 1px solid var(--settings-card-border);
            box-shadow: inset 0 0 0 1px rgba(59, 130, 246, 0.08);
        }

        .currency-selector input,
        .currency-selector select,
        .theme-selector input,
        .business-selector input {
            background: #ffffff;
            border-color: rgba(31, 51, 73, 0.15);
        }

        .spinning {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body class="settings-body">
    <!-- Navigation Bar Container -->
    <div id="navbar-container"></div>
    <!-- Navbar Scripts -->
    <script src="js/navbar.js?v=20250106001"></script>

    <!-- Spacer to prevent content from being hidden under fixed navbar -->
    <div style="height: 70px;"></div>

    <!-- Main Content -->
    <div class="container-fluid mt-4">
        <div class="container-xxl settings-layout">
            <div class="row g-4">
                <aside class="col-lg-3">
                    <div class="settings-sidebar">
                        <h4 class="text-center">CNPERP Settings</h4>
                        <ul class="nav flex-column settings-nav">
                            <li class="nav-item">
                                <a class="nav-link active" href="#currency-settings">
                                    <i class="bi bi-currency-exchange"></i>
                                    <span>Currency & Regional</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#theme-settings">
                                    <i class="bi bi-palette"></i>
                                    <span>Theme & Appearance</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#business-settings">
                                    <i class="bi bi-building"></i>
                                    <span>Business Information</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#branch-settings">
                                    <i class="bi bi-diagram-3"></i>
                                    <span>Branch Management</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#user-settings">
                                    <i class="bi bi-people"></i>
                                    <span>User Management</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#inventory-allocation-settings">
                                    <i class="bi bi-arrow-left-right"></i>
                                    <span>Inventory Allocation</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#invoice-settings">
                                    <i class="bi bi-file-earmark-text"></i>
                                    <span>Invoice Settings</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#quotation-settings">
                                    <i class="bi bi-file-richtext"></i>
                                    <span>Quotation Settings</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#inventory-settings">
                                    <i class="bi bi-box-seam"></i>
                                    <span>Inventory Settings</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#sales-settings">
                                    <i class="bi bi-cart"></i>
                                    <span>Sales Settings</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#pos-settings">
                                    <i class="bi bi-credit-card-2-front"></i>
                                    <span>POS Settings</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#purchase-settings">
                                    <i class="bi bi-truck"></i>
                                    <span>Purchase Settings</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#vat-settings">
                                    <i class="bi bi-percent"></i>
                                    <span>VAT Settings</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#security-settings">
                                    <i class="bi bi-shield-lock"></i>
                                    <span>Security Settings</span>
                                </a>
                            </li>
                        </ul>
                    </div>
                </aside>

                <main class="col-lg-9">
                    <div class="settings-card mb-4">
                        <div class="d-flex flex-column flex-lg-row gap-3 justify-content-between align-items-lg-center">
                            <div>
                                <p class="text-uppercase text-muted fw-semibold mb-1">Control centre</p>
                                <h1 class="h3 fw-bold mb-0">Application Settings</h1>
                                <p class="text-muted mb-0">Manage global defaults, appearance, and operational
                                    preferences across the platform.</p>
                            </div>
                            <div class="settings-toolbar d-flex gap-2">
                                <button type="button" class="btn btn-outline-secondary" onclick="resetToDefaults()">
                                    <i class="bi bi-arrow-clockwise me-1"></i> Reset to Defaults
                                </button>
                                <button type="button" class="btn btn-primary" onclick="saveAllSettings()">
                                    <i class="bi bi-save me-1"></i> Save All
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Currency & Regional Settings -->
                    <div id="currency-settings" class="settings-card">
                        <h3 class="mb-4">
                            <i class="bi bi-currency-exchange text-primary"></i>
                            Currency & Regional Settings
                        </h3>
                        <div class="currency-selector">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="currency" class="form-label">Default Currency</label>
                                        <select class="form-select" id="currency" name="currency">
                                            <option value="BWP">Botswana Pula (P)</option>
                                            <option value="USD">US Dollar ($)</option>
                                            <option value="GBP">British Pound (Â£)</option>
                                            <option value="ZAR">South African Rand (R)</option>
                                            <option value="NAD">Namibian Pula (N$)</option>
                                            <option value="ZMW">Zambian Kwacha (K)</option>
                                            <option value="ZWL">Zimbabwean Dollar (Z$)</option>
                                            <option value="MWK">Malawian Kwacha (MK)</option>
                                            <option value="TZS">Tanzanian Shilling (TSh)</option>
                                            <option value="KES">Kenyan Shilling (KSh)</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="vat_rate" class="form-label">Default VAT Rate (%)</label>
                                        <input type="number" class="form-control" id="vat_rate" name="vat_rate"
                                            step="0.01" min="0" max="100">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="country" class="form-label">Country</label>
                                        <select class="form-select" id="country" name="country">
                                            <option value="BW">Botswana</option>
                                            <option value="ZA">South Africa</option>
                                            <option value="NA">Namibia</option>
                                            <option value="ZM">Zambia</option>
                                            <option value="ZW">Zimbabwe</option>
                                            <option value="MW">Malawi</option>
                                            <option value="TZ">Tanzania</option>
                                            <option value="KE">Kenya</option>
                                            <option value="UG">Uganda</option>
                                            <option value="US">United States</option>
                                            <option value="GB">United Kingdom</option>
                                            <option value="DE">Germany</option>
                                            <option value="FR">France</option>
                                            <option value="CA">Canada</option>
                                            <option value="AU">Australia</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="timezone" class="form-label">Timezone</label>
                                        <select class="form-select" id="timezone" name="timezone">
                                            <option value="Africa/Gaborone">Africa/Gaborone</option>
                                            <option value="Africa/Johannesburg">Africa/Johannesburg</option>
                                            <option value="Africa/Windhoek">Africa/Windhoek</option>
                                            <option value="Africa/Lusaka">Africa/Lusaka</option>
                                            <option value="Africa/Harare">Africa/Harare</option>
                                            <option value="Africa/Blantyre">Africa/Blantyre</option>
                                            <option value="Africa/Dar_es_Salaam">Africa/Dar es Salaam</option>
                                            <option value="Africa/Nairobi">Africa/Nairobi</option>
                                            <option value="UTC">UTC</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Theme Settings -->
                    <div id="theme-settings" class="settings-card">
                        <h3 class="mb-4">
                            <i class="bi bi-palette text-primary"></i>
                            Theme & Appearance Settings
                        </h3>
                        <div class="theme-selector">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="theme_mode" class="form-label">Theme Mode</label>
                                        <select class="form-select" id="theme_mode" name="theme_mode">
                                            <option value="light">Light Mode</option>
                                            <option value="dark">Dark Mode</option>
                                            <option value="auto">Auto (System)</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="primary_color" class="form-label">Primary Color</label>
                                        <input type="color" class="form-control form-control-color" id="primary_color"
                                            name="primary_color" value="#0d6efd">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="secondary_color" class="form-label">Secondary Color</label>
                                        <input type="color" class="form-control form-control-color" id="secondary_color"
                                            name="secondary_color" value="#6c757d">
                                    </div>
                                    <div class="mb-3">
                                        <label for="accent_color" class="form-label">Accent Color</label>
                                        <input type="color" class="form-control form-control-color" id="accent_color"
                                            name="accent_color" value="#198754">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Business Settings -->
                    <div id="business-settings" class="settings-card">
                        <h3 class="mb-4">
                            <i class="bi bi-building text-primary"></i>
                            Business Information
                        </h3>
                        <div class="business-selector">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="company_name" class="form-label">Company Name</label>
                                        <input type="text" class="form-control" id="company_name" name="company_name">
                                    </div>
                                    <div class="mb-3">
                                        <label for="app_name" class="form-label">Application Name</label>
                                        <input type="text" class="form-control" id="app_name" name="app_name">
                                    </div>
                                    <div class="mb-3">
                                        <label for="phone" class="form-label">Phone Number</label>
                                        <input type="tel" class="form-control" id="phone" name="phone">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="email" class="form-label">Email Address</label>
                                        <input type="email" class="form-control" id="email" name="email">
                                    </div>
                                    <div class="mb-3">
                                        <label for="website" class="form-label">Website</label>
                                        <input type="url" class="form-control" id="website" name="website">
                                    </div>
                                    <div class="mb-3">
                                        <label for="address" class="form-label">Address</label>
                                        <textarea class="form-control" id="address" name="address" rows="3"></textarea>
                                    </div>
                                </div>
                            </div>

                            <!-- Company Logo Section -->
                            <div class="row mt-4">
                                <div class="col-12">
                                    <h5 class="mb-3">
                                        <i class="bi bi-image"></i> Company Logo
                                    </h5>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="logoUploadSettings" class="form-label">Upload Company
                                                    Logo</label>
                                                <input type="file" class="form-control" id="logoUploadSettings"
                                                    accept="image/*">
                                                <small class="text-muted">Recommended: PNG or JPG, max 2MB. This logo
                                                    will be used in all documents (invoices, credit notes, receipts,
                                                    etc.)</small>
                                            </div>
                                            <div class="mb-3">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox"
                                                        id="invoice_show_logo" name="invoice_show_logo">
                                                    <label class="form-check-label" for="invoice_show_logo">
                                                        Show logo in invoices
                                                    </label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox"
                                                        id="document_show_logo" name="document_show_logo">
                                                    <label class="form-check-label" for="document_show_logo">
                                                        Show logo in all documents
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="logo-preview-container">
                                                <label class="form-label">Logo Preview</label>
                                                <div class="border rounded p-3 text-center"
                                                    style="min-height: 120px; background-color: #f8f9fa;">
                                                    <img id="logoPreviewSettings" src="" alt="Company Logo"
                                                        style="max-width: 100%; max-height: 100px; display: none;">
                                                    <div id="logoPlaceholderSettings" class="text-muted">
                                                        <i class="bi bi-image fs-1"></i>
                                                        <p class="mt-2">No logo uploaded</p>
                                                    </div>
                                                </div>
                                                <button type="button" class="btn btn-outline-danger btn-sm mt-2"
                                                    id="removeLogo" style="display: none;">
                                                    <i class="bi bi-trash"></i> Remove Logo
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Branch Management Settings -->
                    <div id="branch-settings" class="settings-card">
                        <h3 class="mb-4">
                            <i class="bi bi-diagram-3 text-primary"></i>
                            Branch Management
                        </h3>

                        <!-- Action Buttons -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <button type="button" class="btn btn-primary" data-bs-toggle="modal"
                                    data-bs-target="#addBranchModal">
                                    <i class="bi bi-plus"></i> Add New Branch
                                </button>
                                <a href="branches.html" class="btn btn-outline-secondary ms-2">
                                    <i class="bi bi-building"></i> Full Branch Management
                                </a>
                            </div>
                            <div class="col-md-6 text-end">
                                <button type="button" class="btn btn-outline-info" onclick="refreshBranches()">
                                    <i class="bi bi-arrow-clockwise"></i> Refresh
                                </button>
                            </div>
                        </div>

                        <!-- Branch Summary Stats -->
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <div class="card bg-primary bg-opacity-10 border-primary border-opacity-25">
                                    <div class="card-body text-center">
                                        <i class="bi bi-buildings fs-1 text-primary"></i>
                                        <h4 class="mt-2 mb-1" id="totalBranchesSettings">0</h4>
                                        <small class="text-muted">Total Branches</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-success bg-opacity-10 border-success border-opacity-25">
                                    <div class="card-body text-center">
                                        <i class="bi bi-check-circle fs-1 text-success"></i>
                                        <h4 class="mt-2 mb-1" id="activeBranchesSettings">0</h4>
                                        <small class="text-muted">Active Branches</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-warning bg-opacity-10 border-warning border-opacity-25">
                                    <div class="card-body text-center">
                                        <i class="bi bi-pause-circle fs-1 text-warning"></i>
                                        <h4 class="mt-2 mb-1" id="inactiveBranchesSettings">0</h4>
                                        <small class="text-muted">Inactive Branches</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-info bg-opacity-10 border-info border-opacity-25">
                                    <div class="card-body text-center">
                                        <i class="bi bi-building-check fs-1 text-info"></i>
                                        <h4 class="mt-2 mb-1" id="headOfficeBranchesSettings">0</h4>
                                        <small class="text-muted">Head Offices</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Branches List -->
                        <div class="row">
                            <div class="col-12">
                                <h5 class="mb-3">
                                    <i class="bi bi-list"></i> Branch Overview
                                </h5>
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Name</th>
                                                <th>Code</th>
                                                <th>Location</th>
                                                <th>Contact</th>
                                                <th>Status</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="branchesTableSettings">
                                            <tr>
                                                <td colspan="6" class="text-center text-muted py-4">
                                                    <i class="bi bi-arrow-clockwise spinning fs-4"></i>
                                                    <br>Loading branches...
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Branch Defaults Section -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <h5 class="mb-3">
                                    <i class="bi bi-gear"></i> Branch Defaults
                                </h5>
                                <div class="card bg-light border-primary border-opacity-25">
                                    <div class="card-body">
                                        <p class="text-muted mb-3">Configure default settings that will be applied to
                                            all branches</p>

                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="default_bank_account" class="form-label">
                                                        <i class="bi bi-bank"></i> Default Bank Account
                                                    </label>
                                                    <select class="form-select" id="default_bank_account"
                                                        name="default_bank_account">
                                                        <option value="">Select Default Bank Account</option>
                                                    </select>
                                                    <div class="form-text">This bank account will be used as default for
                                                        all branch transactions</div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="default_payment_method" class="form-label">
                                                        <i class="bi bi-credit-card"></i> Default Payment Method
                                                    </label>
                                                    <select class="form-select" id="default_payment_method"
                                                        name="default_payment_method">
                                                        <option value="cash">Cash</option>
                                                        <option value="bank_transfer">Bank Transfer</option>
                                                        <option value="check">Check</option>
                                                        <option value="card">Card Payment</option>
                                                        <option value="mobile_money">Mobile Money</option>
                                                    </select>
                                                    <div class="form-text">Default payment method for branch
                                                        transactions</div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="default_currency" class="form-label">
                                                        <i class="bi bi-currency-exchange"></i> Default Branch Currency
                                                    </label>
                                                    <select class="form-select" id="default_currency"
                                                        name="default_currency">
                                                        <option value="BWP">BWP - Botswana Pula</option>
                                                        <option value="USD">USD - US Dollar</option>
                                                        <option value="EUR">EUR - Euro</option>
                                                        <option value="GBP">GBP - British Pound</option>
                                                        <option value="ZAR">ZAR - South African Rand</option>
                                                    </select>
                                                    <div class="form-text">Currency used for branch operations</div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="allow_branch_override" class="form-label">
                                                        <i class="bi bi-toggles"></i> Branch Override Settings
                                                    </label>
                                                    <div class="form-check form-switch">
                                                        <input class="form-check-input" type="checkbox"
                                                            id="allow_branch_override" name="allow_branch_override">
                                                        <label class="form-check-label" for="allow_branch_override">
                                                            Allow branches to override defaults
                                                        </label>
                                                    </div>
                                                    <div class="form-text">When enabled, individual branches can
                                                        override these default settings</div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="row">
                                            <div class="col-12">
                                                <button type="button" class="btn btn-primary"
                                                    onclick="saveBranchDefaults()">
                                                    <i class="bi bi-save"></i> Save Branch Defaults
                                                </button>
                                                <button type="button" class="btn btn-outline-secondary ms-2"
                                                    onclick="refreshBankAccounts()">
                                                    <i class="bi bi-arrow-clockwise"></i> Refresh Bank Accounts
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- User Management Settings -->
                    <div id="user-settings" class="settings-card">
                        <h3 class="mb-4">
                            <i class="bi bi-people text-primary"></i>
                            User Management
                        </h3>

                        <!-- Action Buttons -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <button type="button" class="btn btn-primary" data-bs-toggle="modal"
                                    data-bs-target="#addUserModal">
                                    <i class="bi bi-person-plus"></i> Add New User
                                </button>
                                <a href="users.html" class="btn btn-outline-secondary ms-2">
                                    <i class="bi bi-people"></i> Full User Management
                                </a>
                            </div>
                            <div class="col-md-6 text-end">
                                <button type="button" class="btn btn-outline-info" onclick="refreshUsers()">
                                    <i class="bi bi-arrow-clockwise"></i> Refresh
                                </button>
                            </div>
                        </div>

                        <!-- User Role Summary -->
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <div class="card bg-success bg-opacity-10 border-success border-opacity-25">
                                    <div class="card-body text-center">
                                        <i class="bi bi-shield-check fs-1 text-success"></i>
                                        <h4 class="mt-2 mb-1" id="globalUsersSettings">0</h4>
                                        <small class="text-muted">Global Users</small>
                                        <div class="small mt-1">Can access any branch</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-primary bg-opacity-10 border-primary border-opacity-25">
                                    <div class="card-body text-center">
                                        <i class="bi bi-building fs-1 text-primary"></i>
                                        <h4 class="mt-2 mb-1" id="branchUsersSettings">0</h4>
                                        <small class="text-muted">Branch-Specific Users</small>
                                        <div class="small mt-1">Restricted to assigned branch</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-warning bg-opacity-10 border-warning border-opacity-25">
                                    <div class="card-body text-center">
                                        <i class="bi bi-person-x fs-1 text-warning"></i>
                                        <h4 class="mt-2 mb-1" id="inactiveUsersSettings">0</h4>
                                        <small class="text-muted">Inactive Users</small>
                                        <div class="small mt-1">Disabled accounts</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Users by Role -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="mb-3">
                                    <i class="bi bi-person-badge"></i> Users by Role
                                </h5>
                                <div class="row" id="usersByRoleSettings">
                                    <div class="col-md-12 text-center text-muted">
                                        <i class="bi bi-arrow-clockwise spinning fs-4"></i>
                                        <br>Loading user statistics...
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Recent Users Table -->
                        <div class="row">
                            <div class="col-12">
                                <h5 class="mb-3">
                                    <i class="bi bi-clock-history"></i> Recent Users
                                </h5>
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>User</th>
                                                <th>Role</th>
                                                <th>Branch</th>
                                                <th>Status</th>
                                                <th>Last Login</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="usersTableSettings">
                                            <tr>
                                                <td colspan="6" class="text-center text-muted py-4">
                                                    <i class="bi bi-arrow-clockwise spinning fs-4"></i>
                                                    <br>Loading users...
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Inventory Allocation Settings -->
                    <div id="inventory-allocation-settings" class="settings-section" style="display: none;">
                        <div class="settings-card">
                            <h3 class="mb-4">
                                <i class="bi bi-arrow-left-right text-info"></i>
                                Inventory Allocation Management
                            </h3>
                            <p class="text-muted mb-4">
                                Manage inventory distribution from headquarters to branches. Allocate stock received at
                                the main branch to other locations.
                            </p>

                            <!-- Quick Actions -->
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <button type="button" class="btn btn-primary" data-bs-toggle="modal"
                                        data-bs-target="#allocateInventoryModal">
                                        <i class="bi bi-box-arrow-right"></i> Allocate Inventory to Branch
                                    </button>
                                    <button type="button" class="btn btn-success ms-2" data-bs-toggle="modal"
                                        data-bs-target="#receiveInventoryModal">
                                        <i class="bi bi-box-arrow-in-down"></i> Receive at HQ
                                    </button>
                                </div>
                                <div class="col-md-6 text-end">
                                    <button type="button" class="btn btn-outline-info"
                                        onclick="refreshInventoryAllocation()">
                                        <i class="bi bi-arrow-clockwise"></i> Refresh
                                    </button>
                                    <a href="inventory.html" class="btn btn-outline-secondary ms-2">
                                        <i class="bi bi-boxes"></i> Full Inventory
                                    </a>
                                </div>
                            </div>

                            <!-- HQ Inventory Overview -->
                            <div class="row mb-4">
                                <div class="col-md-3">
                                    <div class="card bg-primary bg-opacity-10 border-primary border-opacity-25">
                                        <div class="card-body text-center">
                                            <i class="bi bi-building fs-1 text-primary"></i>
                                            <h4 class="mt-2 mb-1" id="hqProductsCount">0</h4>
                                            <small class="text-muted">Products at HQ</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-success bg-opacity-10 border-success border-opacity-25">
                                        <div class="card-body text-center">
                                            <i class="bi bi-box-seam fs-1 text-success"></i>
                                            <h4 class="mt-2 mb-1" id="totalAvailableUnits">0</h4>
                                            <small class="text-muted">Available Units</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-warning bg-opacity-10 border-warning border-opacity-25">
                                        <div class="card-body text-center">
                                            <i class="bi bi-arrow-right fs-1 text-warning"></i>
                                            <h4 class="mt-2 mb-1" id="totalAllocatedUnits">0</h4>
                                            <small class="text-muted">Allocated Units</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-info bg-opacity-10 border-info border-opacity-25">
                                        <div class="card-body text-center">
                                            <i class="bi bi-clock fs-1 text-info"></i>
                                            <h4 class="mt-2 mb-1" id="pendingAllocations">0</h4>
                                            <small class="text-muted">Pending Allocations</small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Recent Allocations Table -->
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">Recent Inventory Allocations</h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Product</th>
                                                    <th>Branch</th>
                                                    <th>Allocated Qty</th>
                                                    <th>Status</th>
                                                    <th>Allocation Date</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="inventoryAllocationsList">
                                                <tr>
                                                    <td colspan="6" class="text-center text-muted">
                                                        <i class="bi bi-box-seam fs-3"></i>
                                                        <div>Loading inventory allocations...</div>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Invoice Settings -->
                    <div id="invoice-settings" class="settings-card">
                        <h3 class="mb-4">
                            <i class="bi bi-file-earmark-text text-primary"></i>
                            Invoice Settings & Customization
                        </h3>

                        <!-- Invoice Action Buttons -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="btn-group-vertical btn-group-sm w-100" role="group">
                                    <button type="button" class="btn btn-primary mb-2" onclick="openInvoiceDesigner()">
                                        <i class="bi bi-file-earmark-plus"></i> Open Invoice Designer
                                        <small class="d-block">Create and design invoices with full A4 page
                                            layout</small>
                                    </button>
                                    <button type="button" class="btn btn-outline-primary mb-2"
                                        onclick="openInvoiceCustomization()">
                                        <i class="bi bi-gear"></i> Customize Invoice Templates
                                        <small class="d-block">Advanced customization with colors, fonts, and layout
                                            options</small>
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary"
                                        onclick="resetInvoiceToDefaults()">
                                        <i class="bi bi-arrow-clockwise"></i> Reset to Default Template
                                        <small class="d-block">Restore original invoice design and settings</small>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Invoice Configuration Tabs -->
                        <ul class="nav nav-pills mb-4" id="invoiceConfigTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="general-invoice-tab" data-bs-toggle="pill"
                                    data-bs-target="#general-invoice" type="button" role="tab">
                                    <i class="bi bi-gear"></i> General
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="appearance-tab" data-bs-toggle="pill"
                                    data-bs-target="#appearance" type="button" role="tab">
                                    <i class="bi bi-palette"></i> Appearance
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="templates-tab" data-bs-toggle="pill"
                                    data-bs-target="#templates" type="button" role="tab">
                                    <i class="bi bi-file-earmark-code"></i> Templates
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="preview-tab" data-bs-toggle="pill"
                                    data-bs-target="#preview" type="button" role="tab">
                                    <i class="bi bi-eye"></i> Preview
                                </button>
                            </li>
                        </ul>

                        <div class="tab-content" id="invoiceConfigTabsContent">
                            <!-- General Invoice Settings -->
                            <div class="tab-pane fade show active" id="general-invoice" role="tabpanel">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h5><i class="bi bi-file-text"></i> Basic Settings</h5>
                                        <div class="mb-3">
                                            <label for="invoice_prefix" class="form-label">Invoice Prefix</label>
                                            <input type="text" class="form-control" id="invoice_prefix"
                                                name="invoice_prefix" placeholder="INV">
                                        </div>
                                        <div class="mb-3">
                                            <label for="invoice_start_number" class="form-label">Starting Number</label>
                                            <input type="number" class="form-control" id="invoice_start_number"
                                                name="invoice_start_number" min="1">
                                        </div>
                                        <div class="mb-3">
                                            <label for="invoice_paper_size" class="form-label">Paper Size</label>
                                            <select class="form-select" id="invoice_paper_size"
                                                name="invoice_paper_size">
                                                <option value="A4">A4 (210mm Ã 297mm)</option>
                                                <option value="Letter">Letter (8.5" Ã 11")</option>
                                                <option value="Legal">Legal (8.5" Ã 14")</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label for="invoice_template_style" class="form-label">Template
                                                Style</label>
                                            <select class="form-select" id="invoice_template_style"
                                                name="invoice_template_style">
                                                <option value="modern">Modern</option>
                                                <option value="classic">Classic</option>
                                                <option value="minimal">Minimal</option>
                                                <option value="professional">Professional</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <h5><i class="bi bi-eye"></i> Display Options</h5>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="invoice_show_logo"
                                                name="invoice_show_logo">
                                            <label class="form-check-label" for="invoice_show_logo">Show Company
                                                Logo</label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox"
                                                id="invoice_show_company_address" name="invoice_show_company_address">
                                            <label class="form-check-label" for="invoice_show_company_address">Show
                                                Company Address</label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox"
                                                id="invoice_show_company_phone" name="invoice_show_company_phone">
                                            <label class="form-check-label" for="invoice_show_company_phone">Show
                                                Company Phone</label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox"
                                                id="invoice_show_customer_address" name="invoice_show_customer_address">
                                            <label class="form-check-label" for="invoice_show_customer_address">Show
                                                Customer Address</label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox"
                                                id="invoice_show_payment_terms" name="invoice_show_payment_terms">
                                            <label class="form-check-label" for="invoice_show_payment_terms">Show
                                                Payment Terms</label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="invoice_show_due_date"
                                                name="invoice_show_due_date">
                                            <label class="form-check-label" for="invoice_show_due_date">Show Due
                                                Date</label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox"
                                                id="invoice_show_vat_breakdown" name="invoice_show_vat_breakdown">
                                            <label class="form-check-label" for="invoice_show_vat_breakdown">Show VAT
                                                Breakdown</label>
                                        </div>
                                    </div>
                                </div>

                                <div class="row mt-4">
                                    <div class="col-12">
                                        <h5><i class="bi bi-chat-text"></i> Default Text</h5>
                                        <div class="mb-3">
                                            <label for="invoice_footer_text" class="form-label">Footer Text</label>
                                            <textarea class="form-control" id="invoice_footer_text"
                                                name="invoice_footer_text" rows="2"
                                                placeholder="Thank you for your business!"></textarea>
                                        </div>
                                        <div class="mb-3">
                                            <label for="invoice_terms_conditions" class="form-label">Terms &
                                                Conditions</label>
                                            <textarea class="form-control" id="invoice_terms_conditions"
                                                name="invoice_terms_conditions" rows="3"
                                                placeholder="Payment due within 30 days."></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Appearance Settings -->
                            <div class="tab-pane fade" id="appearance" role="tabpanel">
                                <div class="row">
                                    <div class="col-md-4">
                                        <h5><i class="bi bi-palette"></i> Colors</h5>
                                        <div class="mb-3">
                                            <label for="invoice_primary_color" class="form-label">Primary Color</label>
                                            <input type="color" class="form-control form-control-color"
                                                id="invoice_primary_color" name="invoice_primary_color" value="#007bff">
                                        </div>
                                        <div class="mb-3">
                                            <label for="invoice_secondary_color" class="form-label">Secondary
                                                Color</label>
                                            <input type="color" class="form-control form-control-color"
                                                id="invoice_secondary_color" name="invoice_secondary_color"
                                                value="#6c757d">
                                        </div>
                                        <div class="mb-3">
                                            <label for="invoice_accent_color" class="form-label">Accent Color</label>
                                            <input type="color" class="form-control form-control-color"
                                                id="invoice_accent_color" name="invoice_accent_color" value="#28a745">
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <h5><i class="bi bi-type"></i> Typography</h5>
                                        <div class="mb-3">
                                            <label for="invoice_font_family" class="form-label">Font Family</label>
                                            <select class="form-select" id="invoice_font_family"
                                                name="invoice_font_family">
                                                <option value="Arial, sans-serif">Arial</option>
                                                <option value="Helvetica, sans-serif">Helvetica</option>
                                                <option value="Times New Roman, serif">Times New Roman</option>
                                                <option value="Georgia, serif">Georgia</option>
                                                <option value="Roboto, sans-serif">Roboto</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label for="invoice_base_font_size" class="form-label">Base Font Size
                                                (px)</label>
                                            <input type="number" class="form-control" id="invoice_base_font_size"
                                                name="invoice_base_font_size" min="8" max="20" value="12">
                                        </div>
                                        <div class="mb-3">
                                            <label for="invoice_line_height" class="form-label">Line Height</label>
                                            <input type="number" class="form-control" id="invoice_line_height"
                                                name="invoice_line_height" min="1" max="3" step="0.1" value="1.4">
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <h5><i class="bi bi-layout-text-window-reverse"></i> Layout</h5>
                                        <div class="mb-3">
                                            <label for="invoice_margin_top" class="form-label">Top Margin (mm)</label>
                                            <input type="number" class="form-control" id="invoice_margin_top"
                                                name="invoice_margin_top" min="0" max="50" value="20">
                                        </div>
                                        <div class="mb-3">
                                            <label for="invoice_margin_bottom" class="form-label">Bottom Margin
                                                (mm)</label>
                                            <input type="number" class="form-control" id="invoice_margin_bottom"
                                                name="invoice_margin_bottom" min="0" max="50" value="20">
                                        </div>
                                        <div class="mb-3">
                                            <label for="invoice_header_height" class="form-label">Header Height
                                                (px)</label>
                                            <input type="number" class="form-control" id="invoice_header_height"
                                                name="invoice_header_height" min="50" max="200" value="120">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Templates Settings -->
                            <div class="tab-pane fade" id="templates" role="tabpanel">
                                <div class="row">
                                    <div class="col-12">
                                        <h5><i class="bi bi-file-earmark-code"></i> Template Management</h5>
                                        <p class="text-muted">Manage and customize invoice templates for different
                                            purposes.</p>

                                        <div class="row">
                                            <div class="col-md-4 mb-3">
                                                <div class="card h-100">
                                                    <div class="card-body text-center">
                                                        <i
                                                            class="bi bi-file-earmark-text display-4 text-primary mb-3"></i>
                                                        <h6>Standard Invoice</h6>
                                                        <p class="card-text small">Default invoice template for regular
                                                            transactions</p>
                                                        <button class="btn btn-outline-primary btn-sm"
                                                            onclick="customizeTemplate('standard')">Customize</button>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <div class="card h-100">
                                                    <div class="card-body text-center">
                                                        <i
                                                            class="bi bi-file-earmark-plus display-4 text-success mb-3"></i>
                                                        <h6>Proforma Invoice</h6>
                                                        <p class="card-text small">Template for proforma and quotation
                                                            invoices</p>
                                                        <button class="btn btn-outline-success btn-sm"
                                                            onclick="customizeTemplate('proforma')">Customize</button>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <div class="card h-100">
                                                    <div class="card-body text-center">
                                                        <i
                                                            class="bi bi-file-earmark-minus display-4 text-warning mb-3"></i>
                                                        <h6>Credit Note</h6>
                                                        <p class="card-text small">Template for credit notes and refunds
                                                        </p>
                                                        <button class="btn btn-outline-warning btn-sm"
                                                            onclick="customizeTemplate('credit')">Customize</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="mt-4">
                                            <button class="btn btn-primary" onclick="createNewTemplate()">
                                                <i class="bi bi-plus"></i> Create New Template
                                            </button>
                                            <button class="btn btn-outline-secondary" onclick="importTemplate()">
                                                <i class="bi bi-upload"></i> Import Template
                                            </button>
                                            <button class="btn btn-outline-secondary" onclick="exportTemplates()">
                                                <i class="bi bi-download"></i> Export Templates
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Preview -->
                            <div class="tab-pane fade" id="preview" role="tabpanel">
                                <div class="row">
                                    <div class="col-12">
                                        <h5><i class="bi bi-eye"></i> Invoice Preview</h5>
                                        <p class="text-muted">Live preview of your invoice with current settings</p>

                                        <div class="text-center mb-3">
                                            <button class="btn btn-primary" onclick="generatePreview()">
                                                <i class="bi bi-arrow-clockwise"></i> Refresh Preview
                                            </button>
                                            <button class="btn btn-outline-primary" onclick="previewInNewWindow()">
                                                <i class="bi bi-window-plus"></i> Open in New Window
                                            </button>
                                            <button class="btn btn-success" onclick="generateSamplePDF()">
                                                <i class="bi bi-file-pdf"></i> Generate Sample PDF
                                            </button>
                                        </div>

                                        <div class="border rounded p-3" style="background: #f8f9fa; min-height: 400px;">
                                            <div id="invoicePreviewContainer" class="text-center">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">Loading preview...</span>
                                                </div>
                                                <p class="mt-2">Loading invoice preview...</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Quotation Settings -->
                    <div id="quotation-settings" class="settings-card">
                        <h3 class="mb-4">
                            <i class="bi bi-file-richtext text-primary"></i>
                            Quotation Formatting & Branding
                        </h3>
                        <p class="text-muted mb-4">
                            Configure how quotations appear when generated as PDFs. These settings apply to the new
                            quotation layout and override default invoice branding where specified.
                        </p>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="quotation_title" class="form-label">Quotation Title</label>
                                    <input type="text" class="form-control" id="quotation_title"
                                        placeholder="e.g. QUOTATION">
                                    <div class="form-text">Displayed prominently at the top of the PDF.</div>
                                </div>
                                <div class="mb-3 form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="quotation_show_logo">
                                    <label class="form-check-label" for="quotation_show_logo">Show company logo on
                                        quotations</label>
                                    <div class="form-text">If disabled the header renders without any logo.</div>
                                </div>
                                <div class="mb-3">
                                    <label for="quotation_logo_url" class="form-label">Quotation Logo Override</label>
                                    <input type="text" class="form-control" id="quotation_logo_url"
                                        placeholder="Leave blank to reuse company logo">
                                    <div class="form-text">Provide a relative file path for a specific quotation logo.
                                        Remote URLs are not supported by the PDF generator.</div>
                                </div>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label for="quotation_logo_width_mm" class="form-label">Logo Width (mm)</label>
                                        <input type="number" class="form-control" id="quotation_logo_width_mm" min="10"
                                            max="120" step="1">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="quotation_logo_height_mm" class="form-label">Logo Height
                                            (mm)</label>
                                        <input type="number" class="form-control" id="quotation_logo_height_mm" min="10"
                                            max="80" step="1">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="quotation_footer_text" class="form-label">Footer Text</label>
                                    <textarea class="form-control" id="quotation_footer_text" rows="3"
                                        placeholder="Add payment instructions, thank you notes, or legal disclaimers"></textarea>
                                </div>
                                <div class="mb-3">
                                    <label for="quotation_footer_images" class="form-label">Footer Images</label>
                                    <textarea class="form-control" id="quotation_footer_images" rows="3"
                                        placeholder="One local file path per line"></textarea>
                                    <div class="form-text">Optional images appended beneath the footer text (signatures,
                                        stamps, marketing banners). Enter absolute or project-relative paths.</div>
                                </div>
                                <div class="alert alert-info small" role="alert">
                                    <i class="bi bi-info-circle"></i>
                                    Leave logo fields blank to continue using the company branding configured above.
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Inventory Settings -->
                    <div id="inventory-settings" class="settings-card">
                        <h3 class="mb-4">
                            <i class="bi bi-box-seam text-primary"></i>
                            Inventory Settings
                        </h3>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="low_stock_threshold" class="form-label">Low Stock Threshold</label>
                                    <input type="number" class="form-control" id="low_stock_threshold"
                                        name="low_stock_threshold" min="0">
                                </div>
                                <div class="mb-3">
                                    <label for="measurement_system" class="form-label">Measurement System</label>
                                    <select class="form-select" id="measurement_system" name="measurement_system">
                                        <option value="metric">Metric System</option>
                                        <option value="imperial">Imperial System</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="track_serial_numbers"
                                            name="track_serial_numbers">
                                        <label class="form-check-label" for="track_serial_numbers">
                                            Track Serial Numbers
                                        </label>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="allow_negative_stock"
                                            name="allow_negative_stock">
                                        <label class="form-check-label" for="allow_negative_stock">
                                            Allow Negative Stock
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sales Settings -->
                    <div id="sales-settings" class="settings-card">
                        <h3 class="mb-4">
                            <i class="bi bi-cart text-primary"></i>
                            Sales Settings
                        </h3>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="allow_credit_sales"
                                            name="allow_credit_sales">
                                        <label class="form-check-label" for="allow_credit_sales">
                                            Allow Credit Sales
                                        </label>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="auto_generate_invoices"
                                            name="auto_generate_invoices">
                                        <label class="form-check-label" for="auto_generate_invoices">
                                            Auto-Generate Invoices
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="invoice_prefix_sales" class="form-label">Invoice Prefix</label>
                                    <input type="text" class="form-control" id="invoice_prefix_sales"
                                        name="invoice_prefix">
                                </div>
                                <div class="mb-3">
                                    <label for="invoice_start_number" class="form-label">Invoice Start Number</label>
                                    <input type="number" class="form-control" id="invoice_start_number"
                                        name="invoice_start_number" min="1">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- POS Settings -->
                    <div id="pos-settings" class="settings-card">
                        <h3 class="mb-4">
                            <i class="bi bi-credit-card-2-front text-primary"></i>
                            POS Settings
                        </h3>
                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label for="posDefaultCardBank" class="form-label">Global Default Card Bank
                                        Account</label>
                                    <select class="form-select" id="posDefaultCardBank">
                                        <option value="">Loading bank accounts...</option>
                                    </select>
                                    <div class="form-text">This bank account will be used for card payments when no
                                        branch-specific default is configured.</div>
                                </div>
                            </div>
                            <div class="col-md-4 d-flex align-items-end justify-content-start">
                                <button type="button" id="savePosDefaultsBtn" class="btn btn-primary"
                                    onclick="savePosSettings()">
                                    <i class="bi bi-save"></i> Save POS Settings
                                </button>
                            </div>
                        </div>
                        <div id="posSettingsNotice" class="alert alert-info d-none mt-3">
                            <i class="bi bi-info-circle"></i>
                            Current global default: <span id="posCurrentDefaultLabel">None</span>
                        </div>

                        <hr class="my-4" />
                        <h5 class="mb-3"><i class="bi bi-diagram-3 me-1"></i> Per-Branch Defaults</h5>
                        <div class="table-responsive">
                            <table class="table table-sm align-middle">
                                <thead>
                                    <tr>
                                        <th style="width: 25%">Branch</th>
                                        <th>Default Card Bank Account</th>
                                        <th style="width: 180px">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="posBranchDefaultsTable">
                                    <tr>
                                        <td colspan="3" class="text-muted">Loading branchesâ¦</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Purchase Settings -->
                    <div id="purchase-settings" class="settings-card">
                        <h3 class="mb-4">
                            <i class="bi bi-truck text-primary"></i>
                            Purchase Settings
                        </h3>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="allow_credit_purchases"
                                            name="allow_credit_purchases">
                                        <label class="form-check-label" for="allow_credit_purchases">
                                            Allow Credit Purchases
                                        </label>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox"
                                            id="auto_generate_purchase_orders" name="auto_generate_purchase_orders">
                                        <label class="form-check-label" for="auto_generate_purchase_orders">
                                            Auto-Generate Purchase Orders
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="po_prefix" class="form-label">PO Prefix</label>
                                    <input type="text" class="form-control" id="po_prefix" name="po_prefix">
                                </div>
                                <div class="mb-3">
                                    <label for="po_start_number" class="form-label">PO Start Number</label>
                                    <input type="number" class="form-control" id="po_start_number"
                                        name="po_start_number" min="1">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- VAT Settings -->
                    <div id="vat-settings" class="settings-card">
                        <h3 class="mb-4">
                            <i class="bi bi-percent text-primary"></i>
                            VAT Settings
                        </h3>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="vat_rate" class="form-label">VAT Rate Percentage (%)</label>
                                    <input type="number" class="form-control" id="vat_rate" name="vat_rate" step="0.01"
                                        min="0" max="100" placeholder="14.00">
                                    <div class="form-text">Default VAT rate for sales, POS, invoices, and other
                                        transactions</div>
                                </div>
                                <div class="mb-3">
                                    <label for="vat_registration_number" class="form-label">VAT Registration
                                        Number</label>
                                    <input type="text" class="form-control" id="vat_registration_number"
                                        name="vat_registration_number">
                                </div>
                                <div class="mb-3">
                                    <label for="vat_filing_frequency" class="form-label">VAT Filing Frequency</label>
                                    <select class="form-select" id="vat_filing_frequency" name="vat_filing_frequency">
                                        <option value="monthly">Monthly</option>
                                        <option value="quarterly">Quarterly</option>
                                        <option value="yearly">Yearly</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="default_vat_rate" class="form-label">Backup VAT Rate (%)</label>
                                    <input type="number" class="form-control" id="default_vat_rate"
                                        name="default_vat_rate" step="0.01" min="0" max="100" placeholder="14.00">
                                    <div class="form-text">Fallback VAT rate if primary rate is not available</div>
                                </div>
                                <div class="mb-3">
                                    <label for="vat_due_date_offset" class="form-label">VAT Due Date Offset
                                        (Days)</label>
                                    <input type="number" class="form-control" id="vat_due_date_offset"
                                        name="vat_due_date_offset" min="1" max="31">
                                </div>
                                <div class="mb-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="vat_inclusive_pricing"
                                            name="vat_inclusive_pricing">
                                        <label class="form-check-label" for="vat_inclusive_pricing">
                                            VAT Inclusive Pricing
                                        </label>
                                        <div class="form-text">When enabled, displayed prices include VAT</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Security Settings -->
                    <div id="security-settings" class="settings-card">
                        <h3 class="mb-4">
                            <i class="bi bi-shield-lock text-primary"></i>
                            Security Settings
                        </h3>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="password_min_length" class="form-label">Minimum Password Length</label>
                                    <input type="number" class="form-control" id="password_min_length"
                                        name="password_min_length" min="6" max="20">
                                </div>
                                <div class="mb-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="suspend_timeouts"
                                            name="suspend_timeouts">
                                        <label class="form-check-label" for="suspend_timeouts">
                                            Suspend Session Timeouts (Dev)
                                        </label>
                                    </div>
                                    <div class="form-text">When enabled, tokens get very long expiries and inactivity
                                        logout is disabled for development.</div>
                                </div>
                                <div class="mb-3">
                                    <label for="session_timeout_minutes"
                                        class="form-label d-flex justify-content-between align-items-center">
                                        <span>Session Timeout (Minutes)</span>
                                        <span class="badge bg-warning text-dark">Security</span>
                                    </label>
                                    <input type="number" class="form-control" id="session_timeout_minutes"
                                        name="session_timeout_minutes" min="5" max="480">
                                    <div class="form-text">Users will be logged out after this period of inactivity.
                                        Increase if legitimate in-progress work is being lost.</div>
                                </div>
                                <div class="mb-3">
                                    <label for="idle_warning_minutes" class="form-label">Idle Warning Lead Time
                                        (Minutes)</label>
                                    <input type="number" class="form-control" id="idle_warning_minutes"
                                        name="idle_warning_minutes" min="1" max="120">
                                    <div class="form-text">How many minutes before timeout to show the idle warning
                                        dialog.</div>
                                </div>
                                <div class="mb-3">
                                    <label for="refresh_threshold_minutes" class="form-label">Token Refresh Threshold
                                        (Minutes)</label>
                                    <input type="number" class="form-control" id="refresh_threshold_minutes"
                                        name="refresh_threshold_minutes" min="1" max="240">
                                    <div class="form-text">If less than this amount of time remains on the token during
                                        activity, a refresh will be attempted.</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="require_special_chars"
                                            name="require_special_chars">
                                        <label class="form-check-label" for="require_special_chars">
                                            Require Special Characters
                                        </label>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="require_numbers"
                                            name="require_numbers">
                                        <label class="form-check-label" for="require_numbers">
                                            Require Numbers
                                        </label>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="require_uppercase"
                                            name="require_uppercase">
                                        <label class="form-check-label" for="require_uppercase">
                                            Require Uppercase Letters
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </main>
            </div>
        </div>
    </div>

    <!-- Add/Edit Branch Modal -->
    <div class="modal fade" id="addBranchModal" tabindex="-1" aria-labelledby="addBranchModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addBranchModalLabel">
                        <i class="bi bi-plus"></i> Add New Branch
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="branchForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="branchName" class="form-label">Branch Name <span
                                            class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="branchName" required>
                                </div>
                                <div class="mb-3">
                                    <label for="branchCode" class="form-label">Branch Code <span
                                            class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="branchCode" required
                                        placeholder="e.g., MAIN, NORTH, SOUTH">
                                    <div class="form-text">Unique identifier for this branch</div>
                                </div>
                                <div class="mb-3">
                                    <label for="branchLocation" class="form-label">Location</label>
                                    <input type="text" class="form-control" id="branchLocation">
                                </div>
                                <div class="mb-3">
                                    <label for="branchPhone" class="form-label">Phone</label>
                                    <input type="tel" class="form-control" id="branchPhone">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="branchEmail" class="form-label">Email</label>
                                    <input type="email" class="form-control" id="branchEmail">
                                </div>
                                <div class="mb-3">
                                    <label for="branchContactPerson" class="form-label">Contact Person</label>
                                    <input type="text" class="form-control" id="branchContactPerson">
                                </div>
                                <div class="mb-3">
                                    <label for="branchTimezone" class="form-label">Timezone</label>
                                    <select class="form-select" id="branchTimezone">
                                        <option value="UTC">UTC</option>
                                        <option value="Africa/Gaborone">Africa/Gaborone</option>
                                        <option value="Africa/Johannesburg">Africa/Johannesburg</option>
                                        <option value="Africa/Nairobi">Africa/Nairobi</option>
                                        <option value="America/New_York">America/New_York</option>
                                        <option value="Europe/London">Europe/London</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="branchCurrency" class="form-label">Currency</label>
                                    <select class="form-select" id="branchCurrency">
                                        <option value="USD">USD - US Dollar</option>
                                        <option value="BWP">BWP - Botswana Pula</option>
                                        <option value="ZAR">ZAR - South African Rand</option>
                                        <option value="GBP">GBP - British Pound</option>
                                        <option value="EUR">EUR - Euro</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="mb-3">
                                    <label for="branchAddress" class="form-label">Address</label>
                                    <textarea class="form-control" id="branchAddress" rows="3"></textarea>
                                </div>
                                <div class="mb-3">
                                    <label for="branchNotes" class="form-label">Notes</label>
                                    <textarea class="form-control" id="branchNotes" rows="2"
                                        placeholder="Additional notes about this branch"></textarea>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="branchIsHeadOffice">
                                    <label class="form-check-label" for="branchIsHeadOffice">
                                        This is a head office
                                    </label>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x"></i> Cancel
                    </button>
                    <button type="button" class="btn btn-primary" onclick="saveBranch()">
                        <i class="bi bi-save"></i> Save Branch
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit User Modal -->
    <div class="modal fade" id="addUserModal" tabindex="-1" aria-labelledby="addUserModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addUserModalLabel">
                        <i class="bi bi-person-plus"></i> Add New User
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="userForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="userUsername" class="form-label">Username <span
                                            class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="userUsername" required>
                                </div>
                                <div class="mb-3">
                                    <label for="userEmail" class="form-label">Email <span
                                            class="text-danger">*</span></label>
                                    <input type="email" class="form-control" id="userEmail" required>
                                </div>
                                <div class="mb-3">
                                    <label for="userPassword" class="form-label">Password <span
                                            class="text-danger">*</span></label>
                                    <input type="password" class="form-control" id="userPassword" required
                                        minlength="6">
                                    <div class="form-text">Minimum 6 characters</div>
                                </div>
                                <div class="mb-3">
                                    <label for="userRole" class="form-label">Role <span
                                            class="text-danger">*</span></label>
                                    <select class="form-select" id="userRole" required onchange="handleRoleChange()">
                                        <option value="">Select Role</option>
                                        <optgroup label="Global Roles (Can access any branch)">
                                            <option value="super_admin">Super Administrator</option>
                                            <option value="admin">Administrator</option>
                                            <option value="accountant">Accountant</option>
                                        </optgroup>
                                        <optgroup label="Branch-Specific Roles">
                                            <option value="manager">Manager</option>
                                            <option value="cashier">Cashier</option>
                                            <option value="staff">Staff</option>
                                        </optgroup>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="userFirstName" class="form-label">First Name</label>
                                    <input type="text" class="form-control" id="userFirstName">
                                </div>
                                <div class="mb-3">
                                    <label for="userLastName" class="form-label">Last Name</label>
                                    <input type="text" class="form-control" id="userLastName">
                                </div>
                                <div class="mb-3">
                                    <label for="userPhone" class="form-label">Phone</label>
                                    <input type="tel" class="form-control" id="userPhone">
                                </div>
                                <div class="mb-3">
                                    <label for="userBranch" class="form-label">Branch Assignment</label>
                                    <select class="form-select" id="userBranch">
                                        <option value="">Loading branches...</option>
                                    </select>
                                    <div class="form-text" id="branchHelp">
                                        Global roles can optionally be assigned to a default branch.
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="mb-3">
                                    <label for="userAddress" class="form-label">Address</label>
                                    <textarea class="form-control" id="userAddress" rows="2"></textarea>
                                </div>
                                <div class="mb-3">
                                    <label for="userNotes" class="form-label">Notes</label>
                                    <textarea class="form-control" id="userNotes" rows="2"
                                        placeholder="Additional notes about this user"></textarea>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x"></i> Cancel
                    </button>
                    <button type="button" class="btn btn-primary" onclick="saveUser()">
                        <i class="bi bi-save"></i> Save User
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Allocate Inventory Modal -->
    <div class="modal fade" id="allocateInventoryModal" tabindex="-1" aria-labelledby="allocateInventoryModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="allocateInventoryModalLabel">
                        <i class="bi bi-box-arrow-right"></i> Allocate Inventory to Branch
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="allocationForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="allocationProduct" class="form-label">Product <span
                                            class="text-danger">*</span></label>
                                    <select class="form-select" id="allocationProduct" required
                                        onchange="updateAvailableQuantity()">
                                        <option value="">Select Product</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="allocationBranch" class="form-label">Target Branch <span
                                            class="text-danger">*</span></label>
                                    <select class="form-select" id="allocationBranch" required>
                                        <option value="">Select Branch</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="allocationQuantity" class="form-label">Quantity to Allocate <span
                                            class="text-danger">*</span></label>
                                    <input type="number" class="form-control" id="allocationQuantity" required min="1">
                                    <div class="form-text" id="availableQuantityText">Available: Loading...</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="allocationCostPerUnit" class="form-label">Cost Per Unit <span
                                            class="text-danger">*</span></label>
                                    <input type="number" class="form-control" id="allocationCostPerUnit" step="0.01"
                                        required>
                                </div>
                                <div class="mb-3">
                                    <label for="allocationExpectedDate" class="form-label">Expected Delivery
                                        Date</label>
                                    <input type="date" class="form-control" id="allocationExpectedDate">
                                </div>
                                <div class="mb-3">
                                    <label for="allocationNotes" class="form-label">Notes</label>
                                    <textarea class="form-control" id="allocationNotes" rows="3"
                                        placeholder="Additional notes about this allocation"></textarea>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x"></i> Cancel
                    </button>
                    <button type="button" class="btn btn-primary" onclick="saveAllocation()">
                        <i class="bi bi-box-arrow-right"></i> Allocate Inventory
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Receive Inventory at HQ Modal -->
    <div class="modal fade" id="receiveInventoryModal" tabindex="-1" aria-labelledby="receiveInventoryModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="receiveInventoryModalLabel">
                        <i class="bi bi-box-arrow-in-down"></i> Receive Inventory at Headquarters
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="receiveForm">
                        <div class="mb-3">
                            <label for="receiveProduct" class="form-label">Product <span
                                    class="text-danger">*</span></label>
                            <select class="form-select" id="receiveProduct" required>
                                <option value="">Select Product</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="receiveQuantity" class="form-label">Quantity Received <span
                                    class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="receiveQuantity" required min="1">
                        </div>
                        <div class="mb-3">
                            <label for="receiveCostPerUnit" class="form-label">Cost Per Unit <span
                                    class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="receiveCostPerUnit" step="0.01" required>
                        </div>
                        <div class="mb-3">
                            <label for="receiveNotes" class="form-label">Notes</label>
                            <textarea class="form-control" id="receiveNotes" rows="2"
                                placeholder="Supplier, batch number, etc."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x"></i> Cancel
                    </button>
                    <button type="button" class="btn btn-success" onclick="saveReceipt()">
                        <i class="bi bi-box-arrow-in-down"></i> Receive Inventory
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>



    <!-- Modern Interactions -->
    <script src="js/modern-interactions.js"></script>
    <script>
        // Lightweight notification utility used on this page
        function showNotification(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type === 'success' ? 'success' : (type === 'info' ? 'info' : 'danger')} alert-dismissible fade show position-fixed`;
            alertDiv.style.top = '20px';
            alertDiv.style.right = '20px';
            alertDiv.style.zIndex = '9999';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alertDiv);

            setTimeout(() => { try { alertDiv.remove(); } catch { } }, 5000);
        }

        // Logo Management Functions (moved here from broken CSS block)
        async function handleLogoUpload(file) {
            if (!file) return;
            try {
                showNotification('Uploading logo...', 'info');
                const formData = new FormData();
                formData.append('file', file);
                const response = await fetch('/api/v1/app-settings/logo/upload', { method: 'POST', body: formData });
                if (!response.ok) throw new Error('Upload failed');
                const result = await response.json();
                const logoPreview = document.getElementById('logoPreviewSettings');
                const logoPlaceholder = document.getElementById('logoPlaceholderSettings');
                const removeLogoBtn = document.getElementById('removeLogo');
                if (result.company_logo_base64) {
                    logoPreview.src = result.company_logo_base64;
                    logoPreview.style.display = 'block';
                    logoPlaceholder.style.display = 'none';
                    removeLogoBtn.style.display = 'inline-block';
                }
                showNotification('Logo uploaded successfully!', 'success');
            } catch (error) {
                console.error('Logo upload error:', error);
                showNotification('Failed to upload logo', 'error');
            }
        }

        async function removeLogo() {
            if (!confirm('Are you sure you want to remove the company logo?')) return;
            try {
                const response = await fetch('/api/v1/app-settings/logo', { method: 'DELETE' });
                if (!response.ok) throw new Error('Failed to remove logo');
                const logoPreview = document.getElementById('logoPreviewSettings');
                const logoPlaceholder = document.getElementById('logoPlaceholderSettings');
                const removeBtn = document.getElementById('removeLogo');
                logoPreview.style.display = 'none';
                logoPlaceholder.style.display = 'block';
                removeBtn.style.display = 'none';
                showNotification('Logo removed successfully!', 'success');
            } catch (error) {
                console.error('Logo removal error:', error);
                showNotification('Failed to remove logo', 'error');
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            const logoUpload = document.getElementById('logoUploadSettings');
            if (logoUpload) {
                logoUpload.addEventListener('change', function (e) {
                    const file = e.target.files[0];
                    if (file) handleLogoUpload(file);
                });
            }
            const removeLogoBtn = document.getElementById('removeLogo');
            if (removeLogoBtn) removeLogoBtn.addEventListener('click', removeLogo);
        });
    </script>
    <script>
        // Load settings on page load
        document.addEventListener('DOMContentLoaded', function () {
            loadSettings();
            loadBranchesSettings();
            loadUsersSettings();
            // Temporarily disable inventory allocation loading to fix main settings issues
            // refreshInventoryAllocation(); // Load inventory allocation data
            loadPosSettings();
            loadBranchDefaults(); // Load branch default settings
            refreshBankAccounts(); // Load bank accounts for branch defaults
        });

        async function loadSettings() {
            try {
                const response = await fetch('/api/v1/settings/');

                if (response.ok) {
                    const data = await response.json();
                    console.log('Settings response:', data);
                    populateSettings(data.data);
                } else {
                    console.error('Failed to load settings:', response.status, response.statusText);
                    // Use default settings if API fails
                    populateSettings({
                        currency: {
                            currency: 'BWP',
                            vat_rate: 14.0,
                            country: 'BW',
                            timezone: 'Africa/Gaborone'
                        },
                        theme: {
                            theme_mode: 'light',
                            primary_color: '#0d6efd',
                            secondary_color: '#6c757d',
                            accent_color: '#198754'
                        },
                        business: {
                            company_name: 'Your Company',
                            app_name: 'CNPERP ERP',
                            phone: '',
                            email: '',
                            website: '',
                            address: ''
                        },
                        inventory: {
                            low_stock_threshold: 10,
                            measurement_system: 'metric',
                            track_serial_numbers: false,
                            allow_negative_stock: false
                        },
                        sales: {
                            allow_credit_sales: false,
                            auto_generate_invoices: false,
                            invoice_prefix: 'INV',
                            invoice_start_number: 1000
                        },
                        purchase: {
                            allow_credit_purchases: false,
                            auto_generate_purchase_orders: false,
                            po_prefix: 'PO',
                            po_start_number: 1000
                        },
                        vat: {
                            vat_registration_number: '',
                            vat_filing_frequency: 'monthly',
                            vat_due_date_offset: 21
                        },
                        security: {
                            password_min_length: 8
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading settings:', error);
                // Use default settings if API fails
                populateSettings({
                    currency: {
                        currency: 'BWP',
                        vat_rate: 14.0,
                        country: 'BW',
                        timezone: 'Africa/Gaborone'
                    },
                    theme: {
                        theme_mode: 'light',
                        primary_color: '#0d6efd',
                        secondary_color: '#6c757d',
                        accent_color: '#198754'
                    },
                    business: {
                        company_name: 'Your Company',
                        app_name: 'CNPERP ERP',
                        phone: '',
                        email: '',
                        website: '',
                        address: ''
                    },
                    inventory: {
                        low_stock_threshold: 10,
                        measurement_system: 'metric',
                        track_serial_numbers: false,
                        allow_negative_stock: false
                    },
                    sales: {
                        allow_credit_sales: false,
                        auto_generate_invoices: false,
                        invoice_prefix: 'INV',
                        invoice_start_number: 1000
                    },
                    purchase: {
                        allow_credit_purchases: false,
                        auto_generate_purchase_orders: false,
                        po_prefix: 'PO',
                        po_start_number: 1000
                    },
                    vat: {
                        vat_registration_number: '',
                        vat_filing_frequency: 'monthly',
                        vat_due_date_offset: 21
                    },
                    security: {
                        password_min_length: 8
                    }
                });
            }
        }

        // POS Settings Functions
        async function loadPosSettings() {
            try {
                const bankSelect = document.getElementById('posDefaultCardBank');
                bankSelect.innerHTML = '<option value="">Loading bank accounts...</option>';

                // Load branches
                const branchesRes = await fetch('/api/v1/branches/');
                const branches = branchesRes.ok ? await branchesRes.json() : [];

                // Fetch ALL bank accounts (don't filter by branch since many accounts don't have branch_id set)
                const allAccounts = [];
                try {
                    const res = await fetch('/api/v1/banking/accounts');
                    if (res.ok) {
                        const json = await res.json();
                        const accounts = json?.data || json?.value || [];
                        accounts.forEach(a => allAccounts.push({
                            id: a.id,
                            name: a.name,
                            account_number: a.account_number,
                            accounting_code: a.accounting_code,
                            branch_name: a.branch_name || 'Unassigned'  // Handle accounts without branch
                        }));
                    }
                } catch (e) {
                    console.error('Failed to load bank accounts:', e);
                }

                // Populate select
                bankSelect.innerHTML = '';
                if (allAccounts.length === 0) {
                    bankSelect.innerHTML = '<option value="">No bank accounts found</option>';
                    document.getElementById('savePosDefaultsBtn').disabled = true;
                } else {
                    document.getElementById('savePosDefaultsBtn').disabled = false;
                    // Group by branch name
                    const byBranch = {};
                    allAccounts.forEach(a => {
                        byBranch[a.branch_name] = byBranch[a.branch_name] || [];
                        byBranch[a.branch_name].push(a);
                    });
                    Object.keys(byBranch).sort().forEach(branchName => {
                        const optgroup = document.createElement('optgroup');
                        optgroup.label = branchName;
                        byBranch[branchName].forEach(a => {
                            const opt = document.createElement('option');
                            opt.value = a.id;
                            const suffix = a.account_number || a.accounting_code || '';
                            opt.textContent = `${a.name}${suffix ? ' (' + suffix + ')' : ''}`;
                            optgroup.appendChild(opt);
                        });
                        bankSelect.appendChild(optgroup);
                    });
                }

                // Load current global default
                const defRes = await fetch('/api/v1/pos/defaults/card-bank');
                if (defRes.ok) {
                    const defJson = await defRes.json();
                    const defId = defJson?.data?.default_card_bank_account_id;
                    if (defId) {
                        bankSelect.value = defId;
                        updatePosCurrentDefaultLabel(allAccounts, defId);
                    } else {
                        updatePosCurrentDefaultLabel(allAccounts, null);
                    }
                }

                // Render per-branch defaults table
                await renderPosBranchDefaultsTable(branches, allAccounts);
            } catch (e) {
                console.warn('Failed to load POS settings', e);
            }
        }

        function updatePosCurrentDefaultLabel(allAccounts, defId) {
            const notice = document.getElementById('posSettingsNotice');
            const label = document.getElementById('posCurrentDefaultLabel');
            if (!notice || !label) return;
            if (defId) {
                const match = (allAccounts || []).find(a => String(a.id) === String(defId));
                label.textContent = match ? `${match.branch_name} - ${match.name}${match.account_number ? ' (' + match.account_number + ')' : ''}` : `Account ${defId}`;
                notice.classList.remove('d-none');
            } else {
                label.textContent = 'None';
                notice.classList.remove('d-none');
            }
        }

        async function savePosSettings() {
            try {
                const bankId = document.getElementById('posDefaultCardBank').value;
                if (!bankId) {
                    showNotification('Please select a bank account first.', 'error');
                    return;
                }
                const btn = document.getElementById('savePosDefaultsBtn');
                const original = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = '<i class="bi bi-arrow-repeat spinner-border spinner-border-sm me-1"></i> Saving...';

                const res = await fetch('/api/v1/pos/defaults/card-bank', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ bank_account_id: bankId })
                });
                if (res.ok) {
                    showNotification('POS settings saved successfully!', 'success');
                    // Refresh the label
                    loadPosSettings();
                } else {
                    showNotification('Failed to save POS settings.', 'error');
                }
                btn.disabled = false;
                btn.innerHTML = original;
            } catch (e) {
                console.error('Save POS settings failed', e);
                showNotification('Error saving POS settings.', 'error');
            }
        }

        async function renderPosBranchDefaultsTable(branches, allAccounts) {
            const tbody = document.getElementById('posBranchDefaultsTable');
            if (!tbody) return;
            tbody.innerHTML = '';
            if (!Array.isArray(branches) || branches.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="text-muted">No branches found.</td></tr>';
                return;
            }
            for (const br of branches) {
                const tr = document.createElement('tr');
                const tdName = document.createElement('td');
                tdName.textContent = br.name;
                const tdSelect = document.createElement('td');
                const select = document.createElement('select');
                select.className = 'form-select form-select-sm';
                select.dataset.branchId = br.id;
                // Show ALL accounts (not filtered by branch) since most accounts don't have branch_id set
                const placeholder = document.createElement('option');
                placeholder.value = '';
                placeholder.textContent = allAccounts.length ? 'â Select account â' : 'No accounts';
                select.appendChild(placeholder);

                // Group accounts by branch_name for better organization
                const byBranch = {};
                allAccounts.forEach(a => {
                    const branchLabel = a.branch_name || 'Unassigned';
                    byBranch[branchLabel] = byBranch[branchLabel] || [];
                    byBranch[branchLabel].push(a);
                });

                // Add optgroups for each branch
                Object.keys(byBranch).sort().forEach(branchLabel => {
                    const optgroup = document.createElement('optgroup');
                    optgroup.label = branchLabel;
                    byBranch[branchLabel].forEach(a => {
                        const opt = document.createElement('option');
                        opt.value = a.id;
                        const suffix = a.account_number || a.accounting_code || '';
                        opt.textContent = `${a.name}${suffix ? ' (' + suffix + ')' : ''}`;
                        optgroup.appendChild(opt);
                    });
                    select.appendChild(optgroup);
                });
                // Load existing branch default
                try {
                    const res = await fetch(`/api/v1/pos/branch-defaults/${encodeURIComponent(br.id)}/card-bank`);
                    if (res.ok) {
                        const j = await res.json();
                        const defId = j?.data?.default_card_bank_account_id;
                        if (defId) select.value = defId;
                    }
                } catch { }
                tdSelect.appendChild(select);
                const tdActions = document.createElement('td');
                const saveBtn = document.createElement('button');
                saveBtn.className = 'btn btn-sm btn-primary me-2';
                saveBtn.innerHTML = '<i class="bi bi-save"></i> Save';
                saveBtn.onclick = async () => {
                    const bankId = select.value;
                    if (!bankId) { showNotification('Select an account first.', 'error'); return; }
                    const r = await fetch(`/api/v1/pos/branch-defaults/${encodeURIComponent(br.id)}/card-bank`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ bank_account_id: bankId })
                    });
                    if (r.ok) showNotification('Branch default saved.', 'success'); else showNotification('Failed to save.', 'error');
                };
                const clearBtn = document.createElement('button');
                clearBtn.className = 'btn btn-sm btn-outline-secondary';
                clearBtn.innerHTML = '<i class="bi bi-x"></i> Clear';
                clearBtn.onclick = async () => {
                    const r = await fetch(`/api/v1/pos/branch-defaults/${encodeURIComponent(br.id)}/card-bank`, { method: 'DELETE' });
                    if (r.ok) { select.value = ''; showNotification('Branch default cleared.', 'success'); } else showNotification('Failed to clear.', 'error');
                };
                tdActions.appendChild(saveBtn);
                tdActions.appendChild(clearBtn);
                tr.appendChild(tdName);
                tr.appendChild(tdSelect);
                tr.appendChild(tdActions);
                tbody.appendChild(tr);
            }
        }

        function populateSettings(settings) {
            console.log('Populating settings with:', settings);

            // Currency & Regional settings (nested structure)
            if (settings.currency) {
                document.getElementById('currency').value = settings.currency.currency || 'BWP';
                document.getElementById('country').value = settings.currency.country || 'BW';
                document.getElementById('timezone').value = settings.currency.timezone || 'Africa/Gaborone';
            }

            // Theme settings (nested structure)
            if (settings.theme) {
                document.getElementById('theme_mode').value = settings.theme.theme_mode || 'light';
                document.getElementById('primary_color').value = settings.theme.primary_color || '#0d6efd';
                document.getElementById('secondary_color').value = settings.theme.secondary_color || '#6c757d';
                document.getElementById('accent_color').value = settings.theme.accent_color || '#198754';
            }

            // Business settings (nested structure)
            if (settings.business) {
                document.getElementById('company_name').value = settings.business.company_name || '';
                document.getElementById('app_name').value = settings.business.app_name || '';
                document.getElementById('phone').value = settings.business.phone || '';
                document.getElementById('email').value = settings.business.email || '';
                document.getElementById('website').value = settings.business.website || '';
                document.getElementById('address').value = settings.business.address || '';

                // Handle logo settings
                const logoPreview = document.getElementById('logoPreviewSettings');
                const logoPlaceholder = document.getElementById('logoPlaceholderSettings');
                const removeLogo = document.getElementById('removeLogo');

                if (settings.business.company_logo_base64) {
                    logoPreview.src = settings.business.company_logo_base64;
                    logoPreview.style.display = 'block';
                    logoPlaceholder.style.display = 'none';
                    removeLogo.style.display = 'inline-block';
                } else {
                    logoPreview.style.display = 'none';
                    logoPlaceholder.style.display = 'block';
                    removeLogo.style.display = 'none';
                }

                // Set logo display checkboxes
                if (document.getElementById('invoice_show_logo')) {
                    document.getElementById('invoice_show_logo').checked = settings.business.invoice_show_logo || false;
                }
                if (document.getElementById('document_show_logo')) {
                    document.getElementById('document_show_logo').checked = settings.business.document_show_logo || false;
                }
            }

            // Quotation settings (nested structure)
            if (settings.quotation) {
                const quotation = settings.quotation;
                const footerImagesValue = Array.isArray(quotation.footer_images)
                    ? quotation.footer_images
                    : quotation.footer_images
                        ? String(quotation.footer_images).split(/[,\n]/).map(v => v.trim()).filter(Boolean)
                        : [];

                if (document.getElementById('quotation_title')) {
                    document.getElementById('quotation_title').value = quotation.title || 'QUOTATION';
                }
                if (document.getElementById('quotation_show_logo')) {
                    document.getElementById('quotation_show_logo').checked = quotation.show_logo ?? true;
                }
                if (document.getElementById('quotation_logo_url')) {
                    document.getElementById('quotation_logo_url').value = quotation.logo_url || '';
                }
                if (document.getElementById('quotation_logo_width_mm')) {
                    document.getElementById('quotation_logo_width_mm').value = quotation.logo_width_mm ?? 60;
                }
                if (document.getElementById('quotation_logo_height_mm')) {
                    document.getElementById('quotation_logo_height_mm').value = quotation.logo_height_mm ?? 25;
                }
                if (document.getElementById('quotation_footer_text')) {
                    document.getElementById('quotation_footer_text').value = quotation.footer_text || '';
                }
                if (document.getElementById('quotation_footer_images')) {
                    document.getElementById('quotation_footer_images').value = footerImagesValue.join('\n');
                }
            }

            // Inventory settings (nested structure)
            if (settings.inventory) {
                document.getElementById('low_stock_threshold').value = settings.inventory.low_stock_threshold || 10;
                document.getElementById('measurement_system').value = settings.inventory.measurement_system || 'metric';
                document.getElementById('track_serial_numbers').checked = settings.inventory.track_serial_numbers || false;
                document.getElementById('allow_negative_stock').checked = settings.inventory.allow_negative_stock || false;
            }

            // Sales settings (nested structure)
            if (settings.sales) {
                document.getElementById('allow_credit_sales').checked = settings.sales.allow_credit_sales || false;
                document.getElementById('auto_generate_invoices').checked = settings.sales.auto_generate_invoices || false;
                if (document.getElementById('invoice_prefix')) {
                    document.getElementById('invoice_prefix').value = settings.sales.invoice_prefix || 'INV';
                }
                if (document.getElementById('invoice_prefix_sales')) {
                    document.getElementById('invoice_prefix_sales').value = settings.sales.invoice_prefix || 'INV';
                }
                document.getElementById('invoice_start_number').value = settings.sales.invoice_start_number || 1000;
            }

            // Purchase settings (nested structure)
            if (settings.purchase) {
                document.getElementById('allow_credit_purchases').checked = settings.purchase.allow_credit_purchases || false;
                document.getElementById('auto_generate_purchase_orders').checked = settings.purchase.auto_generate_purchase_orders || false;
                document.getElementById('po_prefix').value = settings.purchase.po_prefix || 'PO';
                document.getElementById('po_start_number').value = settings.purchase.po_start_number || 1000;
            }

            // VAT settings (nested structure)
            if (settings.vat) {
                document.getElementById('vat_rate').value = settings.vat.vat_rate || settings.currency?.vat_rate || 14.0;
                document.getElementById('default_vat_rate').value = settings.vat.default_vat_rate || settings.currency?.default_vat_rate || 14.0;
                document.getElementById('vat_registration_number').value = settings.vat.vat_registration_number || '';
                document.getElementById('vat_filing_frequency').value = settings.vat.vat_filing_frequency || 'monthly';
                document.getElementById('vat_due_date_offset').value = settings.vat.vat_due_date_offset || 21;
                document.getElementById('vat_inclusive_pricing').checked = settings.vat.vat_inclusive_pricing || false;
            } else {
                // Fallback to currency settings if VAT settings don't exist
                document.getElementById('vat_rate').value = settings.currency?.vat_rate || 14.0;
                document.getElementById('default_vat_rate').value = settings.currency?.default_vat_rate || 14.0;
            }

            // Security settings (nested structure)
            if (settings.security) {
                document.getElementById('password_min_length').value = settings.security.password_min_length || 8;
                document.getElementById('session_timeout_minutes').value = settings.security.session_timeout_minutes || 30;
                if (document.getElementById('suspend_timeouts')) {
                    // Derive suspend flag from debug_mode (backend) or explicit unsafe dev mode scenario
                    const debugMode = (settings.general && settings.general.debug_mode) || settings.debug_mode || false;
                    document.getElementById('suspend_timeouts').checked = !!debugMode;
                }
                if (document.getElementById('idle_warning_minutes')) {
                    document.getElementById('idle_warning_minutes').value = settings.security.idle_warning_minutes || 2;
                }
                if (document.getElementById('refresh_threshold_minutes')) {
                    document.getElementById('refresh_threshold_minutes').value = settings.security.refresh_threshold_minutes || 10;
                }
                document.getElementById('require_special_chars').checked = settings.security.require_special_chars || false;
                document.getElementById('require_numbers').checked = settings.security.require_numbers || false;
                document.getElementById('require_uppercase').checked = settings.security.require_uppercase || false;
            }
        }

        async function saveAllSettings() {
            const quotationFooterImagesRaw = document.getElementById('quotation_footer_images')?.value || '';
            const parsedFooterImages = quotationFooterImagesRaw
                ? quotationFooterImagesRaw
                    .split(/\n|,/) // newline or comma separated
                    .map(item => item.trim())
                    .filter(Boolean)
                : [];

            const logoWidthInput = document.getElementById('quotation_logo_width_mm');
            const widthCandidate = logoWidthInput ? parseInt(logoWidthInput.value, 10) : NaN;
            const logoHeightInput = document.getElementById('quotation_logo_height_mm');
            const heightCandidate = logoHeightInput ? parseInt(logoHeightInput.value, 10) : NaN;

            const settingsData = {
                currency: document.getElementById('currency').value,
                vat_rate: parseFloat(document.getElementById('vat_rate').value),
                default_vat_rate: parseFloat(document.getElementById('default_vat_rate').value),
                country: document.getElementById('country').value,
                timezone: document.getElementById('timezone').value,
                theme_mode: document.getElementById('theme_mode').value,
                primary_color: document.getElementById('primary_color').value,
                secondary_color: document.getElementById('secondary_color').value,
                accent_color: document.getElementById('accent_color').value,
                company_name: document.getElementById('company_name').value,
                app_name: document.getElementById('app_name').value,
                phone: document.getElementById('phone').value,
                email: document.getElementById('email').value,
                website: document.getElementById('website').value,
                address: document.getElementById('address').value,
                low_stock_threshold: parseInt(document.getElementById('low_stock_threshold').value, 10),
                measurement_system: document.getElementById('measurement_system').value,
                track_serial_numbers: document.getElementById('track_serial_numbers').checked,
                allow_negative_stock: document.getElementById('allow_negative_stock').checked,
                allow_credit_sales: document.getElementById('allow_credit_sales').checked,
                auto_generate_invoices: document.getElementById('auto_generate_invoices').checked,
                invoice_prefix: (document.getElementById('invoice_prefix') || document.getElementById('invoice_prefix_sales')).value,
                invoice_start_number: parseInt(document.getElementById('invoice_start_number').value, 10),
                allow_credit_purchases: document.getElementById('allow_credit_purchases').checked,
                auto_generate_purchase_orders: document.getElementById('auto_generate_purchase_orders').checked,
                po_prefix: document.getElementById('po_prefix').value,
                po_start_number: parseInt(document.getElementById('po_start_number').value, 10),
                vat_registration_number: document.getElementById('vat_registration_number').value,
                vat_filing_frequency: document.getElementById('vat_filing_frequency').value,
                vat_due_date_offset: parseInt(document.getElementById('vat_due_date_offset').value, 10),
                vat_inclusive_pricing: document.getElementById('vat_inclusive_pricing').checked,
                password_min_length: parseInt(document.getElementById('password_min_length').value, 10),
                session_timeout_minutes: parseInt(document.getElementById('session_timeout_minutes').value, 10),
                idle_warning_minutes: parseInt(document.getElementById('idle_warning_minutes').value, 10),
                refresh_threshold_minutes: parseInt(document.getElementById('refresh_threshold_minutes').value, 10),
                require_special_chars: document.getElementById('require_special_chars').checked,
                require_numbers: document.getElementById('require_numbers').checked,
                require_uppercase: document.getElementById('require_uppercase').checked,
                quotation_settings: {
                    title: (document.getElementById('quotation_title')?.value || 'QUOTATION').trim() || 'QUOTATION',
                    show_logo: document.getElementById('quotation_show_logo')?.checked ?? true,
                    logo_url: (document.getElementById('quotation_logo_url')?.value || '').trim() || null,
                    logo_width_mm: Number.isNaN(widthCandidate) ? 60 : widthCandidate,
                    logo_height_mm: Number.isNaN(heightCandidate) ? 25 : heightCandidate,
                    footer_text: document.getElementById('quotation_footer_text')?.value || '',
                    footer_images: parsedFooterImages,
                }
            };

            if (document.getElementById('suspend_timeouts')?.checked) {
                settingsData.debug_mode = true;
            }

            try {
                const response = await fetch('/api/v1/app-settings/', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(settingsData)
                });

                if (response.ok) {
                    showNotification('Settings saved successfully!', 'success');
                } else {
                    showNotification('Failed to save settings', 'error');
                }
            } catch (error) {
                console.error('Error saving settings:', error);
                showNotification('Error saving settings', 'error');
            }
        }

        async function resetToDefaults() {
            if (confirm('Are you sure you want to reset all settings to defaults?')) {
                try {
                    const response = await fetch('/api/v1/settings/reset', {
                        method: 'POST',
                        headers: {
                            'Authorization': 'Bearer ' + localStorage.getItem('token')
                        }
                    });

                    if (response.ok) {
                        showNotification('Settings reset to defaults!', 'success');
                        loadSettings(); // Reload the form
                    } else {
                        showNotification('Failed to reset settings', 'error');
                    }
                } catch (error) {
                    console.error('Error resetting settings:', error);
                    showNotification('Error resetting settings', 'error');
                }
            }
        }

        function showNotification(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show position-fixed`;
            alertDiv.style.top = '20px';
            alertDiv.style.right = '20px';
            alertDiv.style.zIndex = '9999';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alertDiv);

            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        // Branch Management Functions
        async function loadBranchesSettings() {
            try {
                const response = await fetch('/api/v1/branches/');
                if (!response.ok) throw new Error('Failed to fetch branches');

                const branches = await response.json();
                console.log('Branches loaded:', branches);

                // Update statistics
                const total = branches.length;
                const active = branches.filter(b => b.active).length;
                const inactive = total - active;
                const headOffices = branches.filter(b => b.is_head_office).length;

                document.getElementById('totalBranchesSettings').textContent = total;
                document.getElementById('activeBranchesSettings').textContent = active;
                document.getElementById('inactiveBranchesSettings').textContent = inactive;
                document.getElementById('headOfficeBranchesSettings').textContent = headOffices;

                // Update table
                const tableBody = document.getElementById('branchesTableSettings');
                tableBody.innerHTML = '';

                if (branches.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center text-muted py-4">
                                <i class="bi bi-building fs-4"></i>
                                <br>No branches found
                                <br><small>Click "Add New Branch" to create your first branch</small>
                            </td>
                        </tr>
                    `;
                } else {
                    branches.forEach(branch => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>
                                <strong>${branch.name}</strong>
                                ${branch.is_head_office ? '<span class="badge bg-warning ms-1">Head Office</span>' : ''}
                            </td>
                            <td><code>${branch.code}</code></td>
                            <td>${branch.location || '<span class="text-muted">Not specified</span>'}</td>
                            <td>
                                ${branch.contact_person ? `<div><i class="bi bi-person"></i> ${branch.contact_person}</div>` : ''}
                                ${branch.phone ? `<div><i class="bi bi-telephone"></i> ${branch.phone}</div>` : ''}
                                ${branch.email ? `<div><i class="bi bi-envelope"></i> ${branch.email}</div>` : ''}
                            </td>
                            <td>
                                <span class="badge ${branch.active ? 'bg-success' : 'bg-secondary'}">
                                    ${branch.active ? 'Active' : 'Inactive'}
                                </span>
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary" onclick="editBranch('${branch.id}')" title="Edit">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-outline-${branch.active ? 'warning' : 'success'}" onclick="toggleBranchStatus('${branch.id}', ${!branch.active})" title="${branch.active ? 'Deactivate' : 'Activate'}">
                                        <i class="bi bi-${branch.active ? 'pause' : 'play'}"></i>
                                    </button>
                                </div>
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });
                }
            } catch (error) {
                console.error('Error loading branches:', error);
                showNotification('Failed to load branches', 'error');

                document.getElementById('branchesTableSettings').innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-danger py-4">
                            <i class="bi bi-exclamation-triangle fs-4"></i>
                            <br>Failed to load branches
                            <br><small>Please check your connection and try again</small>
                        </td>
                    </tr>
                `;
            }
        }

        async function saveBranch() {
            try {
                const branchData = {
                    name: document.getElementById('branchName').value.trim(),
                    code: document.getElementById('branchCode').value.trim().toUpperCase(),
                    location: document.getElementById('branchLocation').value.trim(),
                    phone: document.getElementById('branchPhone').value.trim(),
                    email: document.getElementById('branchEmail').value.trim(),
                    contact_person: document.getElementById('branchContactPerson').value.trim(),
                    address: document.getElementById('branchAddress').value.trim(),
                    notes: document.getElementById('branchNotes').value.trim(),
                    timezone: document.getElementById('branchTimezone').value || 'UTC',
                    currency: document.getElementById('branchCurrency').value || 'USD',
                    is_head_office: document.getElementById('branchIsHeadOffice').checked,
                    active: true
                };

                // Basic validation
                if (!branchData.name) {
                    showNotification('Branch name is required', 'error');
                    document.getElementById('branchName').focus();
                    return;
                }

                if (!branchData.code) {
                    showNotification('Branch code is required', 'error');
                    document.getElementById('branchCode').focus();
                    return;
                }

                // Show loading state
                const saveButton = document.querySelector('#addBranchModal .btn-primary');
                const originalText = saveButton.innerHTML;
                saveButton.innerHTML = '<i class="bi bi-spinner-border spinner-border-sm"></i> Saving...';
                saveButton.disabled = true;

                const response = await fetch('/api/v1/branches/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(branchData)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Failed to create branch');
                }

                const newBranch = await response.json();
                console.log('Branch created:', newBranch);

                showNotification(`Branch "${branchData.name}" created successfully!`, 'success');

                // Clear form and close modal
                document.getElementById('branchForm').reset();
                bootstrap.Modal.getInstance(document.getElementById('addBranchModal')).hide();

                // Refresh the branches list
                await loadBranchesSettings();

            } catch (error) {
                console.error('Error creating branch:', error);
                showNotification(error.message || 'Failed to create branch', 'error');
            } finally {
                // Reset button state
                const saveButton = document.querySelector('#addBranchModal .btn-primary');
                saveButton.innerHTML = '<i class="bi bi-save"></i> Save Branch';
                saveButton.disabled = false;
            }
        }

        async function refreshBranches() {
            const button = event.target;
            const originalHTML = button.innerHTML;
            button.innerHTML = '<i class="bi bi-arrow-clockwise spinning"></i> Refreshing...';
            button.disabled = true;

            try {
                await loadBranchesSettings();
                showNotification('Branches refreshed successfully', 'success');
            } catch (error) {
                showNotification('Failed to refresh branches', 'error');
            } finally {
                setTimeout(() => {
                    button.innerHTML = originalHTML;
                    button.disabled = false;
                }, 1000);
            }
        }

        async function refreshBankAccounts() {
            try {
                console.log('Refreshing bank accounts...');
                const response = await fetch('/api/v1/banking/accounts', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('Bank accounts response:', result);
                    const accounts = result.data || result || [];
                    console.log('Processing accounts:', accounts);

                    const select = document.getElementById('default_bank_account');
                    if (!select) {
                        console.error('Default bank account select element not found');
                        return;
                    }

                    select.innerHTML = '<option value="">Select Default Bank Account</option>';

                    if (accounts.length === 0) {
                        select.innerHTML += '<option value="" disabled>No bank accounts found</option>';
                        showNotification('No bank accounts found. Please add bank accounts first.', 'warning');
                        return;
                    }

                    accounts.forEach(account => {
                        const option = document.createElement('option');
                        option.value = account.id;
                        // Use correct field names from the API response
                        const accountName = account.name || account.account_name || 'Unknown Account';
                        const accountNumber = account.account_number || 'N/A';
                        const bankName = account.institution || account.bank_name || 'Unknown Bank';
                        const displayText = `${accountName} (${accountNumber.trim()}) - ${bankName}`;
                        option.textContent = displayText;
                        console.log('Adding option:', displayText);
                        select.appendChild(option);
                    });

                    showNotification('Bank accounts refreshed successfully', 'success');
                } else {
                    throw new Error(`Failed to fetch bank accounts: ${response.status} ${response.statusText}`);
                }
            } catch (error) {
                console.error('Error refreshing bank accounts:', error);
                showNotification('Failed to refresh bank accounts', 'error');

                // Show error option in dropdown
                const select = document.getElementById('default_bank_account');
                if (select) {
                    select.innerHTML = '<option value="">Select Default Bank Account</option><option value="" disabled>Error loading accounts</option>';
                }
            }
        }

        async function saveBranchDefaults() {
            const branchDefaults = {
                default_bank_account: document.getElementById('default_bank_account').value,
                default_payment_method: document.getElementById('default_payment_method').value,
                default_currency: document.getElementById('default_currency').value,
                allow_branch_override: document.getElementById('allow_branch_override').checked
            };

            try {
                const response = await fetch('/api/v1/app-settings/', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(branchDefaults)
                });

                if (response.ok) {
                    showNotification('Branch defaults saved successfully', 'success');
                } else {
                    throw new Error('Failed to save branch defaults');
                }
            } catch (error) {
                console.error('Error saving branch defaults:', error);
                showNotification('Failed to save branch defaults', 'error');
            }
        }

        async function loadBranchDefaults() {
            try {
                const response = await fetch('/api/v1/settings/', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    const settings = result.data || {};

                    // Load branch defaults if they exist
                    if (settings.general || settings.business) {
                        const branchSettings = settings.general || settings.business || {};

                        if (branchSettings.default_bank_account) {
                            document.getElementById('default_bank_account').value = branchSettings.default_bank_account;
                        }
                        if (branchSettings.default_payment_method) {
                            document.getElementById('default_payment_method').value = branchSettings.default_payment_method;
                        }
                        if (branchSettings.default_currency) {
                            document.getElementById('default_currency').value = branchSettings.default_currency;
                        }
                        if (branchSettings.allow_branch_override !== undefined) {
                            document.getElementById('allow_branch_override').checked = branchSettings.allow_branch_override;
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading branch defaults:', error);
            }
        }

        async function toggleBranchStatus(branchId, newStatus) {
            try {
                const response = await fetch(`/api/v1/branches/${branchId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ active: newStatus })
                });

                if (!response.ok) throw new Error('Failed to update branch status');

                showNotification(`Branch ${newStatus ? 'activated' : 'deactivated'} successfully`, 'success');
                await loadBranchesSettings();

            } catch (error) {
                console.error('Error updating branch status:', error);
                showNotification('Failed to update branch status', 'error');
            }
        }

        function editBranch(branchId) {
            // For now, redirect to full branch management page
            window.open(`branches.html#${branchId}`, '_blank');
        }

        // User Management Functions
        async function loadUsersSettings() {
            try {
                const response = await fetch('/api/v1/users/');
                if (!response.ok) throw new Error('Failed to fetch users');

                const users = await response.json();
                console.log('Users loaded:', users);

                // Update statistics
                const globalRoles = ['super_admin', 'admin', 'accountant'];
                const branchRoles = ['manager', 'cashier', 'staff'];

                const globalUsers = users.filter(u => globalRoles.includes(u.role) && u.active).length;
                const branchUsers = users.filter(u => branchRoles.includes(u.role) && u.active).length;
                const inactiveUsers = users.filter(u => !u.active).length;

                document.getElementById('globalUsersSettings').textContent = globalUsers;
                document.getElementById('branchUsersSettings').textContent = branchUsers;
                document.getElementById('inactiveUsersSettings').textContent = inactiveUsers;

                // Update role breakdown
                const roleBreakdown = {};
                users.forEach(user => {
                    if (user.active) {
                        roleBreakdown[user.role] = (roleBreakdown[user.role] || 0) + 1;
                    }
                });

                const roleContainer = document.getElementById('usersByRoleSettings');
                roleContainer.innerHTML = '';

                Object.entries(roleBreakdown).forEach(([role, count]) => {
                    const roleCard = document.createElement('div');
                    roleCard.className = 'col-md-3 mb-2';
                    roleCard.innerHTML = `
                        <div class="card border-0 bg-light">
                            <div class="card-body text-center py-2">
                                <strong>${role.replace('_', ' ').toUpperCase()}</strong>
                                <div class="h5 mb-0 text-primary">${count}</div>
                            </div>
                        </div>
                    `;
                    roleContainer.appendChild(roleCard);
                });

                // Update recent users table
                const tableBody = document.getElementById('usersTableSettings');
                tableBody.innerHTML = '';

                if (users.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center text-muted py-4">
                                <i class="bi bi-person fs-4"></i>
                                <br>No users found
                                <br><small>Click "Add New User" to create your first user</small>
                            </td>
                        </tr>
                    `;
                } else {
                    // Show last 5 users
                    const recentUsers = users.slice(0, 5);
                    recentUsers.forEach(user => {
                        const row = document.createElement('tr');
                        const lastLogin = user.last_login ? new Date(user.last_login).toLocaleDateString() : 'Never';

                        row.innerHTML = `
                            <td>
                                <div>
                                    <strong>${user.username}</strong>
                                    ${user.first_name || user.last_name ? `<div class="small text-muted">${user.first_name || ''} ${user.last_name || ''}</div>` : ''}
                                </div>
                            </td>
                            <td>
                                <span class="badge ${getRoleBadgeClass(user.role)}">${user.role.replace('_', ' ').toUpperCase()}</span>
                            </td>
                            <td>
                                ${user.branch_id ?
                                `<span class="badge bg-info">${getBranchName(user.branch_id)}</span>` :
                                '<span class="text-muted">Not assigned</span>'}
                            </td>
                            <td>
                                <span class="badge ${user.active ? 'bg-success' : 'bg-secondary'}">
                                    ${user.active ? 'Active' : 'Inactive'}
                                </span>
                            </td>
                            <td>${lastLogin}</td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary" onclick="editUser('${user.id}')" title="Edit">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-outline-${user.active ? 'warning' : 'success'}" onclick="toggleUserStatus('${user.id}')" title="${user.active ? 'Deactivate' : 'Activate'}">
                                        <i class="bi bi-${user.active ? 'pause' : 'play'}"></i>
                                    </button>
                                </div>
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });
                }

            } catch (error) {
                console.error('Error loading users:', error);
                showNotification('Failed to load users', 'error');

                document.getElementById('usersTableSettings').innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-danger py-4">
                            <i class="bi bi-exclamation-triangle fs-4"></i>
                            <br>Failed to load users
                            <br><small>Please check your connection and try again</small>
                        </td>
                    </tr>
                `;
            }
        }

        function getRoleBadgeClass(role) {
            const globalRoles = ['super_admin', 'admin', 'accountant'];
            if (globalRoles.includes(role)) {
                return 'bg-success';
            }
            return 'bg-primary';
        }

        function getBranchName(branchId) {
            // This would be populated from loaded branches
            return 'Branch'; // Simplified for now
        }

        async function loadBranchesForUser() {
            try {
                const response = await fetch('/api/v1/branches/');
                const branches = await response.json();

                const branchSelect = document.getElementById('userBranch');
                branchSelect.innerHTML = '<option value="">Select Branch (Optional)</option>';

                branches.forEach(branch => {
                    if (branch.active) {
                        const option = document.createElement('option');
                        option.value = branch.id;
                        option.textContent = `${branch.name} (${branch.code})`;
                        branchSelect.appendChild(option);
                    }
                });
            } catch (error) {
                console.error('Error loading branches:', error);
                document.getElementById('userBranch').innerHTML = '<option value="">Error loading branches</option>';
            }
        }

        function handleRoleChange() {
            const roleSelect = document.getElementById('userRole');
            const branchSelect = document.getElementById('userBranch');
            const branchHelp = document.getElementById('branchHelp');

            const branchSpecificRoles = ['manager', 'cashier', 'staff'];
            const selectedRole = roleSelect.value;

            if (branchSpecificRoles.includes(selectedRole)) {
                branchSelect.required = true;
                branchHelp.textContent = 'Branch assignment is required for this role.';
                branchHelp.className = 'form-text text-danger';
            } else {
                branchSelect.required = false;
                branchHelp.textContent = 'Global roles can optionally be assigned to a default branch.';
                branchHelp.className = 'form-text';
            }
        }

        async function saveUser() {
            try {
                const userData = {
                    username: document.getElementById('userUsername').value.trim(),
                    email: document.getElementById('userEmail').value.trim(),
                    password: document.getElementById('userPassword').value,
                    first_name: document.getElementById('userFirstName').value.trim(),
                    last_name: document.getElementById('userLastName').value.trim(),
                    phone: document.getElementById('userPhone').value.trim(),
                    address: document.getElementById('userAddress').value.trim(),
                    role: document.getElementById('userRole').value,
                    branch_id: document.getElementById('userBranch').value || null,
                    notes: document.getElementById('userNotes').value.trim()
                };

                // Basic validation
                if (!userData.username) {
                    showNotification('Username is required', 'error');
                    document.getElementById('userUsername').focus();
                    return;
                }

                if (!userData.email) {
                    showNotification('Email is required', 'error');
                    document.getElementById('userEmail').focus();
                    return;
                }

                if (!userData.password || userData.password.length < 6) {
                    showNotification('Password must be at least 6 characters', 'error');
                    document.getElementById('userPassword').focus();
                    return;
                }

                if (!userData.role) {
                    showNotification('Role is required', 'error');
                    document.getElementById('userRole').focus();
                    return;
                }

                // Show loading state
                const saveButton = document.querySelector('#addUserModal .btn-primary');
                const originalText = saveButton.innerHTML;
                saveButton.innerHTML = '<i class="bi bi-spinner-border spinner-border-sm"></i> Saving...';
                saveButton.disabled = true;

                const response = await fetch('/api/v1/users/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(userData)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Failed to create user');
                }

                const newUser = await response.json();
                console.log('User created:', newUser);

                showNotification(`User "${userData.username}" created successfully!`, 'success');

                // Clear form and close modal
                document.getElementById('userForm').reset();
                bootstrap.Modal.getInstance(document.getElementById('addUserModal')).hide();

                // Refresh the users list
                await loadUsersSettings();

            } catch (error) {
                console.error('Error creating user:', error);
                showNotification(error.message || 'Failed to create user', 'error');
            } finally {
                // Reset button state
                const saveButton = document.querySelector('#addUserModal .btn-primary');
                saveButton.innerHTML = '<i class="bi bi-save"></i> Save User';
                saveButton.disabled = false;
            }
        }

        async function refreshUsers() {
            const button = event.target;
            const originalHTML = button.innerHTML;
            button.innerHTML = '<i class="bi bi-arrow-clockwise spinning"></i> Refreshing...';
            button.disabled = true;

            try {
                await loadUsersSettings();
                showNotification('Users refreshed successfully', 'success');
            } catch (error) {
                showNotification('Failed to refresh users', 'error');
            } finally {
                setTimeout(() => {
                    button.innerHTML = originalHTML;
                    button.disabled = false;
                }, 1000);
            }
        }

        async function toggleUserStatus(userId) {
            try {
                const response = await fetch(`/api/v1/users/${userId}/toggle-status`, {
                    method: 'POST'
                });

                if (!response.ok) throw new Error('Failed to update user status');

                const result = await response.json();
                showNotification(result.message, 'success');
                await loadUsersSettings();

            } catch (error) {
                console.error('Error updating user status:', error);
                showNotification('Failed to update user status', 'error');
            }
        }

        function editUser(userId) {
            // For now, redirect to full user management page
            window.open(`users.html#${userId}`, '_blank');
        }

        // Initialize user modal
        document.addEventListener('DOMContentLoaded', function () {
            const addUserModal = document.getElementById('addUserModal');
            addUserModal.addEventListener('show.bs.modal', function () {
                loadBranchesForUser();
            });
        });

        // Invoice Settings Functions
        function openInvoiceDesigner() {
            window.open('/static/invoice-designer.html', '_blank');
        }

        function openInvoiceCustomization() {
            window.open('/static/invoice-customization.html', '_blank');
        }

        async function resetInvoiceToDefaults() {
            if (confirm('Are you sure you want to reset all invoice settings to defaults?')) {
                try {
                    const response = await fetch('/api/v1/invoice-designer/reset-defaults', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });

                    if (response.ok) {
                        showNotification('Invoice settings reset to defaults!', 'success');
                        loadSettings(); // Reload the form
                    } else {
                        showNotification('Failed to reset invoice settings', 'error');
                    }
                } catch (error) {
                    console.error('Error resetting invoice settings:', error);
                    showNotification('Error resetting invoice settings', 'error');
                }
            }
        }

        function customizeTemplate(templateType) {
            const url = `/static/invoice-customization.html?template=${templateType}`;
            window.open(url, '_blank');
        }

        function createNewTemplate() {
            const url = '/static/invoice-customization.html?mode=create';
            window.open(url, '_blank');
        }

        function importTemplate() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json,.xml';
            input.onchange = async function (e) {
                const file = e.target.files[0];
                if (file) {
                    try {
                        const formData = new FormData();
                        formData.append('template', file);

                        const response = await fetch('/api/v1/invoice-designer/import-template', {
                            method: 'POST',
                            body: formData
                        });

                        if (response.ok) {
                            showNotification('Template imported successfully!', 'success');
                        } else {
                            showNotification('Failed to import template', 'error');
                        }
                    } catch (error) {
                        console.error('Error importing template:', error);
                        showNotification('Error importing template', 'error');
                    }
                }
            };
            input.click();
        }

        async function exportTemplates() {
            try {
                const response = await fetch('/api/v1/invoice-designer/export-templates');

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'invoice-templates.json';
                    a.click();
                    window.URL.revokeObjectURL(url);
                    showNotification('Templates exported successfully!', 'success');
                } else {
                    showNotification('Failed to export templates', 'error');
                }
            } catch (error) {
                console.error('Error exporting templates:', error);
                showNotification('Error exporting templates', 'error');
            }
        }

        async function generatePreview() {
            const previewContainer = document.getElementById('invoicePreviewContainer');
            previewContainer.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div><p class="mt-2">Generating preview...</p>';

            try {
                const response = await fetch('/api/v1/invoice-designer/preview', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        customer_name: 'Sample Customer',
                        items: [
                            { description: 'Sample Item 1', quantity: 2, price: 100 },
                            { description: 'Sample Item 2', quantity: 1, price: 250 }
                        ]
                    })
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    previewContainer.innerHTML = `<iframe src="${url}" width="100%" height="600px" frameborder="0"></iframe>`;
                } else {
                    previewContainer.innerHTML = '<p class="text-danger">Failed to generate preview</p>';
                }
            } catch (error) {
                console.error('Error generating preview:', error);
                previewContainer.innerHTML = '<p class="text-danger">Error generating preview</p>';
            }
        }

        function previewInNewWindow() {
            window.open('/static/invoice-designer.html?mode=preview', '_blank');
        }

        async function generateSamplePDF() {
            try {
                const response = await fetch('/api/v1/invoice-designer/preview', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        customer_name: 'Sample Customer',
                        items: [
                            { description: 'Sample Product', quantity: 1, price: 100 },
                            { description: 'Another Product', quantity: 2, price: 50 }
                        ]
                    })
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'sample-invoice.pdf';
                    a.click();
                    window.URL.revokeObjectURL(url);
                    showNotification('Sample PDF generated successfully!', 'success');
                } else {
                    showNotification('Failed to generate PDF', 'error');
                }
            } catch (error) {
                console.error('Error generating PDF:', error);
                showNotification('Error generating PDF', 'error');
            }
        }

        // Auto-generate preview when appearance settings change
        document.addEventListener('DOMContentLoaded', function () {
            const appearanceInputs = document.querySelectorAll('#appearance input, #appearance select');
            appearanceInputs.forEach(input => {
                input.addEventListener('change', function () {
                    if (document.querySelector('#preview-tab').classList.contains('active')) {
                        setTimeout(generatePreview, 500); // Debounce
                    }
                });
            });
        });

        // Inventory Allocation Management Functions
        async function refreshInventoryAllocation() {
            console.log('Refreshing inventory allocation data...');
            await Promise.all([
                loadHQInventoryStats(),
                loadInventoryAllocationsList(),
                loadProductsForAllocation(),
                loadBranchesForAllocation()
            ]);
        }

        async function loadHQInventoryStats() {
            try {
                const response = await fetch('/api/v1/inventory-allocation/headquarters/summary');
                if (response.ok) {
                    const result = await response.json();
                    const data = result.data || {};
                    document.getElementById('hqProductsCount').textContent = data.total_products || 0;
                    document.getElementById('totalAvailableUnits').textContent = data.total_available || 0;
                    document.getElementById('totalAllocatedUnits').textContent = data.total_allocated || 0;
                    document.getElementById('pendingAllocations').textContent = data.low_stock_count || 0;
                }
            } catch (error) {
                console.error('Error loading HQ inventory stats:', error);
                // Set default values on error
                if (document.getElementById('hqProductsCount')) document.getElementById('hqProductsCount').textContent = '0';
                if (document.getElementById('totalAvailableUnits')) document.getElementById('totalAvailableUnits').textContent = '0';
                if (document.getElementById('totalAllocatedUnits')) document.getElementById('totalAllocatedUnits').textContent = '0';
                if (document.getElementById('pendingAllocations')) document.getElementById('pendingAllocations').textContent = '0';
            }
        }

        async function loadInventoryAllocationsList() {
            const tbody = document.getElementById('inventoryAllocationsList');
            if (!tbody) return; // Exit if element doesn't exist

            tbody.innerHTML = '<tr><td colspan="6" class="text-center">Loading...</td></tr>';

            try {
                const response = await fetch('/api/v1/inventory-allocation/allocations');
                if (response.ok) {
                    const result = await response.json();
                    const allocations = result.data || result.allocations || [];
                    renderInventoryAllocationsList(allocations);
                } else {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Failed to load allocations</td></tr>';
                }
            } catch (error) {
                console.error('Error loading allocations:', error);
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Error loading allocations</td></tr>';
            }
        }

        function renderInventoryAllocationsList(allocations) {
            const tbody = document.getElementById('inventoryAllocationsList');

            if (allocations.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-muted">
                            <i class="bi bi-box-seam fs-3"></i>
                            <div>No inventory allocations found</div>
                            <small>Click "Allocate Inventory to Branch" to get started</small>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = allocations.map(allocation => `
                <tr>
                    <td>
                        <div class="fw-semibold">${allocation.product_name || allocation.product_id}</div>
                        <small class="text-muted">${allocation.product_sku || ''}</small>
                    </td>
                    <td>
                        <div class="fw-semibold">${allocation.branch_name || allocation.branch_id}</div>
                    </td>
                    <td>
                        <span class="badge bg-info">${allocation.allocated_quantity}</span>
                        <div class="small text-muted">Received: ${allocation.received_quantity || 0}</div>
                    </td>
                    <td>
                        <span class="badge bg-${getStatusColor(allocation.allocation_status)}">${allocation.allocation_status || 'pending'}</span>
                    </td>
                    <td>
                        <div>${new Date(allocation.allocation_date).toLocaleDateString()}</div>
                        ${allocation.expected_delivery_date ? `<small class="text-muted">Expected: ${new Date(allocation.expected_delivery_date).toLocaleDateString()}</small>` : ''}
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="viewAllocation('${allocation.id}')" title="View Details">
                            <i class="bi bi-eye"></i>
                        </button>
                        ${allocation.allocation_status === 'pending' ? `
                            <button class="btn btn-sm btn-outline-danger ms-1" onclick="cancelAllocation('${allocation.id}')" title="Cancel">
                                <i class="bi bi-x"></i>
                            </button>
                        ` : ''}
                    </td>
                </tr>
            `).join('');
        }

        function getStatusColor(status) {
            const colors = {
                'pending': 'warning',
                'shipped': 'info',
                'received': 'success',
                'cancelled': 'danger'
            };
            return colors[status] || 'secondary';
        }

        async function loadProductsForAllocation() {
            try {
                const response = await fetch('/api/v1/inventory-allocation/headquarters/summary');
                if (response.ok) {
                    const result = await response.json();
                    // For now, just populate with placeholder since we don't have a products endpoint
                    const productSelects = document.querySelectorAll('#allocationProduct, #receiveProduct');

                    productSelects.forEach(select => {
                        if (select) {
                            select.innerHTML = '<option value="">Select Product</option><option value="" disabled>No products loaded</option>';
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading products for allocation:', error);
                // Fail gracefully - just set empty options
                const productSelects = document.querySelectorAll('#allocationProduct, #receiveProduct');
                productSelects.forEach(select => {
                    if (select) {
                        select.innerHTML = '<option value="">Select Product</option><option value="" disabled>Error loading products</option>';
                    }
                });
            }
        }

        async function loadBranchesForAllocation() {
            try {
                const response = await fetch('/api/v1/branches/public');
                if (response.ok) {
                    const branches = await response.json();
                    const branchSelect = document.getElementById('allocationBranch');
                    if (branchSelect) {
                        branchSelect.innerHTML = '<option value="">Select Branch</option>';

                        if (Array.isArray(branches)) {
                            branches.forEach(branch => {
                                if (branch.name !== 'Headquarters') { // Don't allow allocation to HQ
                                    const option = document.createElement('option');
                                    option.value = branch.id;
                                    option.textContent = branch.name;
                                    branchSelect.appendChild(option);
                                }
                            });
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading branches:', error);
                const branchSelect = document.getElementById('allocationBranch');
                if (branchSelect) {
                    branchSelect.innerHTML = '<option value="">Select Branch</option><option value="" disabled>Error loading branches</option>';
                }
            }
        }

        function updateAvailableQuantity() {
            const productSelect = document.getElementById('allocationProduct');
            const selectedOption = productSelect.selectedOptions[0];
            const quantityText = document.getElementById('availableQuantityText');
            const costInput = document.getElementById('allocationCostPerUnit');

            if (selectedOption && selectedOption.value) {
                const available = selectedOption.dataset.available || 0;
                const cost = selectedOption.dataset.cost || 0;
                quantityText.textContent = `Available: ${available} units`;
                costInput.value = cost;

                // Update max quantity
                const quantityInput = document.getElementById('allocationQuantity');
                quantityInput.max = available;
            } else {
                quantityText.textContent = 'Available: Select a product first';
                costInput.value = '';
            }
        }

        async function saveAllocation() {
            const form = document.getElementById('allocationForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const allocationData = {
                product_id: document.getElementById('allocationProduct').value,
                branch_id: document.getElementById('allocationBranch').value,
                allocated_quantity: parseInt(document.getElementById('allocationQuantity').value),
                allocated_cost_per_unit: parseFloat(document.getElementById('allocationCostPerUnit').value),
                expected_delivery_date: document.getElementById('allocationExpectedDate').value || null,
                notes: document.getElementById('allocationNotes').value || null
            };

            try {
                const response = await fetch('/api/v1/inventory-allocation/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(allocationData)
                });

                if (response.ok) {
                    showNotification('Inventory allocated successfully!', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('allocateInventoryModal')).hide();
                    refreshInventoryAllocation();
                    form.reset();
                } else {
                    const error = await response.json();
                    showNotification(error.detail || 'Failed to allocate inventory', 'error');
                }
            } catch (error) {
                console.error('Error allocating inventory:', error);
                showNotification('Error allocating inventory', 'error');
            }
        }

        async function saveReceipt() {
            const form = document.getElementById('receiveForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const receiptData = {
                product_id: document.getElementById('receiveProduct').value,
                quantity: parseInt(document.getElementById('receiveQuantity').value),
                cost_per_unit: parseFloat(document.getElementById('receiveCostPerUnit').value),
                notes: document.getElementById('receiveNotes').value || null
            };

            try {
                const response = await fetch('/api/v1/inventory-allocation/hq/receive', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(receiptData)
                });

                if (response.ok) {
                    showNotification('Inventory received successfully!', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('receiveInventoryModal')).hide();
                    refreshInventoryAllocation();
                    form.reset();
                } else {
                    const error = await response.json();
                    showNotification(error.detail || 'Failed to receive inventory', 'error');
                }
            } catch (error) {
                console.error('Error receiving inventory:', error);
                showNotification('Error receiving inventory', 'error');
            }
        }

        async function viewAllocation(allocationId) {
            // Redirect to full inventory page or show details modal
            window.location.href = `inventory.html?allocation=${allocationId}`;
        }

        async function cancelAllocation(allocationId) {
            if (confirm('Are you sure you want to cancel this allocation?')) {
                try {
                    const response = await fetch(`/api/v1/inventory-allocation/${allocationId}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        showNotification('Allocation cancelled successfully!', 'success');
                        refreshInventoryAllocation();
                    } else {
                        showNotification('Failed to cancel allocation', 'error');
                    }
                } catch (error) {
                    console.error('Error cancelling allocation:', error);
                    showNotification('Error cancelling allocation', 'error');
                }
            }
        }


    </script>


    <script src="/static/js/auth.js"></script>
    <!-- Page Access Guard - Restrict POS users to POS page only -->
    <script src="/static/js/page-guard.js"></script>



</body>

</html>
