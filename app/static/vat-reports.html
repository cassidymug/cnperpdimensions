<!DOCTYPE html>
<html lang="en" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CNPERP - VAT Reports</title>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Modern Styles -->

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="/static/js/auth-bootstrap.js"></script>
    <script src="/static/js/auth.js"></script>
    <!-- Page Access Guard - Restrict POS users to POS page only -->
    <script src="/static/js/page-guard.js"></script>

</head>

<body>
    <!-- Include Standardized Navbar -->
    <div id="navbar-container"></div>
    <script src="/static/js/navbar.js?v=20250106001"></script>
    <div style="height: 70px;"></div>










    <!-- Main Content -->
    <div class="container-fluid mt-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="h3 mb-0">
                            <i class="bi bi-percent text-primary"></i> VAT Reports
                        </h1>
                        <p class="text-muted mb-0">Comprehensive VAT reporting and compliance for Botswana (14%)</p>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-primary" onclick="exportReport()">
                            <i class="bi bi-download"></i> Export
                        </button>
                        <button class="btn btn-primary" onclick="printReport()">
                            <i class="bi bi-printer"></i> Print
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Report Filters -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <label class="form-label">Start Date</label>
                                <input type="date" class="form-control" id="startDate" onchange="loadVatData()">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">End Date</label>
                                <input type="date" class="form-control" id="endDate" onchange="loadVatData()">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Branch</label>
                                <select class="form-select" id="branchFilter" onchange="loadVatData()">
                                    <option value="">All Branches</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Report Type</label>
                                <select class="form-select" id="reportType" onchange="loadVatData()">
                                    <option value="summary">VAT Summary</option>
                                    <option value="detailed">Detailed VAT Report</option>
                                    <option value="reconciliations">VAT Reconciliations</option>
                                    <option value="compliance">Compliance Report</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- VAT Summary -->
        <div id="vatSummary" class="report-section">
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body text-center">
                            <i class="bi bi-arrow-up-circle fs-1 text-success mb-2"></i>
                            <h4 id="vatOutput">-</h4>
                            <p class="text-muted mb-0">VAT Output</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body text-center">
                            <i class="bi bi-arrow-down-circle fs-1 text-danger mb-2"></i>
                            <h4 id="vatInput">-</h4>
                            <p class="text-muted mb-0">VAT Input</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body text-center">
                            <i class="bi bi-calculator fs-1 text-primary mb-2"></i>
                            <h4 id="netVat">-</h4>
                            <p class="text-muted mb-0">Net VAT</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body text-center">
                            <i class="bi bi-calendar-event fs-1 text-info mb-2"></i>
                            <h4 id="dueDate">-</h4>
                            <p class="text-muted mb-0">Due Date</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="bi bi-pie-chart"></i> VAT Breakdown
                            </h6>
                        </div>
                        <div class="card-body">
                            <canvas id="vatBreakdownChart" width="400" height="200"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="bi bi-graph-up"></i> VAT Trend
                            </h6>
                        </div>
                        <div class="card-body">
                            <canvas id="vatTrendChart" width="400" height="200"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detailed VAT Report -->
        <div id="detailedVatReport" class="report-section" style="display: none;">
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="bi bi-file-earmark-text"></i> Detailed VAT Report
                            </h6>
                        </div>
                        <div class="card-body">
                            <div id="detailedVatTable"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- VAT Reconciliations -->
        <div id="vatReconciliations" class="report-section" style="display: none;">
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="bi bi-check-circle"></i> VAT Reconciliations
                            </h6>
                        </div>
                        <div class="card-body">
                            <div id="reconciliationsTable"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Compliance Report -->
        <div id="complianceReport" class="report-section" style="display: none;">
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="bi bi-shield-check"></i> VAT Compliance Report
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row mb-4">
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <h4 id="complianceScore">0%</h4>
                                        <p class="text-muted">Compliance Score</p>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <h4 id="filingStatus">-</h4>
                                        <p class="text-muted">Filing Status</p>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <h4 id="penalties">-</h4>
                                        <p class="text-muted">Potential Penalties</p>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <h4 id="nextFiling">-</h4>
                                        <p class="text-muted">Next Filing Date</p>
                                    </div>
                                </div>
                            </div>
                            <div id="complianceDetails"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>



    <!-- Currency Utils -->
    <script src="js/currency-utils.js"></script>

    <script>
        // Global variables
        let vatData = {};
        let charts = {};

        // Initialize page
        document.addEventListener('DOMContentLoaded', function () {
            // Initialize navbar
            if (window.initializeNavbar) {
                initializeNavbar();
            }

            loadBranches();
            setDefaultDates();
            loadVatData();
        });

        function setDefaultDates() {
            const today = new Date();
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(today.getDate() - 30);

            document.getElementById('startDate').value = thirtyDaysAgo.toISOString().split('T')[0];
            document.getElementById('endDate').value = today.toISOString().split('T')[0];
        }

        async function loadBranches() {
            try {
                const response = await fetch('/api/v1/branches/public');
                const branches = await response.json();

                const branchSelect = document.getElementById('branchFilter');
                branches.forEach(branch => {
                    const option = document.createElement('option');
                    option.value = branch.id;
                    option.textContent = branch.name;
                    branchSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading branches:', error);
            }
        }

        async function loadVatData() {
            const reportType = document.getElementById('reportType').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const branchId = document.getElementById('branchFilter').value;

            showLoading();

            try {
                switch (reportType) {
                    case 'summary':
                        await loadVatSummary(startDate, endDate, branchId);
                        break;
                    case 'detailed':
                        await loadDetailedVatReport(startDate, endDate, branchId);
                        break;
                    case 'reconciliations':
                        await loadVatReconciliations(branchId);
                        break;
                    case 'compliance':
                        await loadComplianceReport(branchId);
                        break;
                }
            } catch (error) {
                console.error('Error loading VAT data:', error);
                showError('Failed to load VAT data');
            } finally {
                hideLoading();
            }
        }

        async function loadVatSummary(startDate, endDate, branchId) {
            const params = new URLSearchParams();
            if (startDate) params.append('start_date', startDate);
            if (endDate) params.append('end_date', endDate);
            if (branchId) params.append('branch_id', branchId);

            try {
                // Get VAT summary from the proper endpoint
                const response = await fetch(`/api/v1/vat/summary?${params}`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                const result = await response.json();
                const data = result.data || result;

                console.log('VAT Summary Data:', data);

                // Calculate additional fields
                const vatOutput = data.vat_collected || 0; // VAT collected from sales (Output VAT)
                const vatInput = data.vat_paid || 0; // VAT paid on purchases (Input VAT)
                const netVat = vatOutput - vatInput; // Net VAT owed to tax authority

                // Update summary metrics with proper VAT terminology
                document.getElementById('vatOutput').textContent = formatCurrency(vatOutput);
                document.getElementById('vatInput').textContent = formatCurrency(vatInput);
                document.getElementById('netVat').textContent = formatCurrency(netVat);
                document.getElementById('netVat').className = netVat >= 0 ? 'text-success' : 'text-danger';

                // Calculate due date (21 days after end of period for Botswana)
                const endDateObj = new Date(endDate);
                const dueDate = new Date(endDateObj);
                dueDate.setDate(dueDate.getDate() + 21);
                document.getElementById('dueDate').textContent = dueDate.toLocaleDateString();

                // Prepare chart data
                const chartData = {
                    vat_output: vatOutput,
                    vat_input: vatInput,
                    net_vat: netVat,
                    vat_by_rate: [{
                        rate: '14%',
                        vat_output: vatOutput,
                        vat_input: vatInput,
                        net_vat: netVat
                    }]
                };

                // Update charts
                updateVatCharts(chartData);

                showReportSection('vatSummary');
            } catch (error) {
                console.error('Error loading VAT summary:', error);
                // Show fallback data
                document.getElementById('vatOutput').textContent = 'Error';
                document.getElementById('vatInput').textContent = 'Error';
                document.getElementById('netVat').textContent = 'Error';
                showError('Failed to load VAT data. Please check your connection and try again.');
            }
        }

        async function loadDetailedVatReport(startDate, endDate, branchId) {
            const params = new URLSearchParams();
            if (startDate) params.append('start_date', startDate);
            if (endDate) params.append('end_date', endDate);
            if (branchId) params.append('branch_id', branchId);

            try {
                // Get detailed VAT data
                const response = await fetch(`/api/v1/vat/summary?${params}`);
                const result = await response.json();
                const data = result.data || result;

                // Get VAT items for detailed breakdown
                const transactionsParams = new URLSearchParams(params);
                transactionsParams.append('limit', '50'); // Limit to 50 recent transactions
                const itemsResponse = await fetch(`/api/v1/vat/transactions?${transactionsParams}`);
                const itemsResult = await itemsResponse.json();
                const items = itemsResult.data || [];

                // Process data for detailed table
                const detailedData = {
                    vat_output: data.vat_collected || 0,
                    vat_input: data.vat_paid || 0,
                    net_vat: (data.vat_collected || 0) - (data.vat_paid || 0),
                    vat_by_rate: [{
                        rate: '14%',
                        vat_output: data.vat_collected || 0,
                        vat_input: data.vat_paid || 0,
                        net_vat: (data.vat_collected || 0) - (data.vat_paid || 0)
                    }],
                    items: items
                };

                // Update detailed VAT table
                updateDetailedVatTable(detailedData);

                showReportSection('detailedVatReport');
            } catch (error) {
                console.error('Error loading detailed VAT report:', error);
                showError('Failed to load detailed VAT report');
            }
        }

        async function loadVatReconciliations(branchId) {
            const params = new URLSearchParams();
            if (branchId) params.append('branch_id', branchId);

            // Add date filters
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            if (startDate) params.append('start_date', startDate);
            if (endDate) params.append('end_date', endDate);

            try {
                const response = await fetch(`/api/v1/vat/reconciliations?${params}`);
                const result = await response.json();
                const data = result.data || [];

                console.log('VAT Reconciliations Data:', data);

                // Format reconciliation data for display
                const reconciliationData = {
                    reconciliation_periods: data.map(rec => ({
                        id: rec.id,
                        period: `${rec.period_start} to ${rec.period_end}`,
                        period_start: rec.period_start,
                        period_end: rec.period_end,
                        output: rec.vat_collected,
                        input: rec.vat_paid,
                        net_vat: rec.net_vat_liability,
                        status: rec.status || 'draft',
                        submitted_at: rec.submitted_at,
                        paid_at: rec.paid_at,
                        total_payments: rec.total_payments || 0,
                        outstanding_amount: rec.outstanding_amount || rec.net_vat_liability,
                        payment_status: rec.payment_status || 'unpaid',
                        due_date: rec.period_end
                    }))
                };

                // Update reconciliations table
                updateReconciliationsTable(reconciliationData);

                showReportSection('vatReconciliations');
            } catch (error) {
                console.error('Error loading VAT reconciliations:', error);
                // Show empty table with error message
                updateReconciliationsTable({ reconciliation_periods: [] });
                showReportSection('vatReconciliations');
            }
        }

        async function loadComplianceReport(branchId) {
            const params = new URLSearchParams();
            if (branchId) params.append('branch_id', branchId);

            const response = await fetch(`/api/v1/reports/vat/summary?${params}`);
            const data = await response.json();

            // Update compliance report
            updateComplianceReport(data);

            showReportSection('complianceReport');
        }

        function updateVatCharts(data) {
            // VAT Breakdown Chart
            const breakdownCtx = document.getElementById('vatBreakdownChart').getContext('2d');
            if (charts.breakdown) charts.breakdown.destroy();

            charts.breakdown = new Chart(breakdownCtx, {
                type: 'doughnut',
                data: {
                    labels: ['VAT Output', 'VAT Input', 'Net VAT'],
                    datasets: [{
                        data: [
                            data.vat_output,
                            data.vat_input,
                            data.net_vat
                        ],
                        backgroundColor: [
                            'rgba(75, 192, 192, 0.8)',
                            'rgba(255, 99, 132, 0.8)',
                            'rgba(54, 162, 235, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        }
                    }
                }
            });

            // VAT Trend Chart
            const trendCtx = document.getElementById('vatTrendChart').getContext('2d');
            if (charts.trend) charts.trend.destroy();

            charts.trend = new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: ['VAT Output', 'VAT Input', 'Net VAT'],
                    datasets: [{
                        label: 'Amount',
                        data: [
                            data.vat_output,
                            data.vat_input,
                            data.net_vat
                        ],
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    }
                }
            });
        }

        function updateDetailedVatTable(data) {
            const container = document.getElementById('detailedVatTable');

            let html = `
                <div class="row mb-4">
                    <div class="col-12">
                        <h6 class="text-primary mb-3">
                            <i class="bi bi-info-circle me-2"></i>
                            VAT Summary by Rate
                        </h6>
                    </div>
                </div>
                <div class="table-responsive mb-4">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>VAT Rate</th>
                                <th>VAT Output (Sales)</th>
                                <th>VAT Input (Purchases)</th>
                                <th>Net VAT</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            data.vat_by_rate.forEach(rate => {
                const netVat = rate.net_vat;
                const statusText = netVat > 0 ? 'Payable to Authority' : netVat < 0 ? 'Refund Due' : 'Balanced';
                const statusClass = netVat > 0 ? 'text-danger' : netVat < 0 ? 'text-info' : 'text-success';

                html += `
                    <tr>
                        <td><strong>${rate.rate}</strong></td>
                        <td class="text-success">${formatCurrency(rate.vat_output)}</td>
                        <td class="text-warning">${formatCurrency(rate.vat_input)}</td>
                        <td class="${netVat >= 0 ? 'text-danger' : 'text-info'}"><strong>${formatCurrency(netVat)}</strong></td>
                        <td><span class="badge ${netVat > 0 ? 'bg-danger' : netVat < 0 ? 'bg-info' : 'bg-success'}">${statusText}</span></td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;

            // Add transaction details if available
            if (data.items && data.items.length > 0) {
                html += `
                    <div class="row mb-3">
                        <div class="col-12">
                            <h6 class="text-primary mb-3">
                                <i class="bi bi-list-ul me-2"></i>
                                Recent VAT Transactions
                            </h6>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-sm table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Type</th>
                                    <th>Reference</th>
                                    <th>Description</th>
                                    <th>VAT Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                data.items.forEach(item => {
                    const typeClass = item.item_type === 'output' ? 'text-success' : 'text-warning';
                    const typeIcon = item.item_type === 'output' ? 'bi-arrow-up' : 'bi-arrow-down';

                    html += `
                        <tr>
                            <td>${new Date(item.transaction_date).toLocaleDateString()}</td>
                            <td><i class="bi ${typeIcon} ${typeClass} me-1"></i>${item.item_type === 'output' ? 'Output' : 'Input'}</td>
                            <td>${item.reference_id || '-'}</td>
                            <td>${item.description}</td>
                            <td class="${typeClass}">${formatCurrency(item.vat_amount)}</td>
                        </tr>
                    `;
                });

                html += `
                            </tbody>
                        </table>
                    </div>
                `;
            } else {
                html += `
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        No detailed transaction data available for this period.
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        function updateReconciliationsTable(data) {
            const container = document.getElementById('reconciliationsTable');

            let html = `
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="mb-0">
                        <i class="bi bi-list-check me-2"></i>
                        VAT Reconciliation Periods
                    </h6>
                    <button class="btn btn-primary btn-sm" onclick="createNewReconciliation()">
                        <i class="bi bi-plus-circle me-1"></i> New Reconciliation
                    </button>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Period</th>
                                <th>VAT Output</th>
                                <th>VAT Input</th>
                                <th>Net VAT</th>
                                <th>Payment Status</th>
                                <th>Outstanding</th>
                                <th>Status</th>
                                <th>Due Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            if (data.reconciliation_periods && data.reconciliation_periods.length > 0) {
                data.reconciliation_periods.forEach((period) => {
                    const netVat = period.net_vat || (period.output - period.input);
                    const dueDate = new Date(period.due_date);
                    dueDate.setDate(dueDate.getDate() + 21); // Add 21 days for Botswana VAT due date

                    const isOverdue = new Date() > dueDate && period.status !== 'submitted' && period.status !== 'paid';
                    const statusBadge = getStatusBadge(period.status);
                    const paymentBadge = getPaymentStatusBadge(period.payment_status);

                    html += `
                        <tr class="${isOverdue ? 'table-warning' : ''}">
                            <td>
                                ${period.period}
                                ${isOverdue ? '<br><small class="text-danger"><i class="bi bi-exclamation-triangle"></i> Overdue</small>' : ''}
                            </td>
                            <td class="text-success">${formatCurrency(period.output)}</td>
                            <td class="text-warning">${formatCurrency(period.input)}</td>
                            <td class="${netVat >= 0 ? 'text-danger' : 'text-info'}">
                                <strong>${formatCurrency(netVat)}</strong>
                            </td>
                            <td>${paymentBadge}</td>
                            <td class="${period.outstanding_amount > 0 ? 'text-danger' : 'text-success'}">
                                ${formatCurrency(period.outstanding_amount)}
                            </td>
                            <td>${statusBadge}</td>
                            <td>${dueDate.toLocaleDateString()}</td>
                            <td>
                                <div class="btn-group btn-group-sm" role="group">
                                    <button class="btn btn-outline-primary" onclick="viewReconciliationDetails('${period.id}')" title="View Details">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    ${period.status === 'draft' ? `
                                        <button class="btn btn-outline-success" onclick="performReconciliation('${period.id}')" title="Reconcile">
                                            <i class="bi bi-check-circle"></i>
                                        </button>
                                        <button class="btn btn-outline-info" onclick="submitVatReturn('${period.id}')" title="Submit">
                                            <i class="bi bi-send"></i>
                                        </button>
                                    ` : ''}
                                    ${(period.status === 'submitted' || period.status === 'approved') && period.outstanding_amount > 0 ? `
                                        <button class="btn btn-outline-warning" onclick="recordVatPayment('${period.id}', ${period.outstanding_amount})" title="Record Payment">
                                            <i class="bi bi-cash"></i>
                                        </button>
                                    ` : ''}
                                </div>
                            </td>
                        </tr>
                    `;
                });
            } else {
                html += `
                    <tr>
                        <td colspan="9" class="text-center text-muted py-4">
                            <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                            <p class="mb-2">No reconciliation data available</p>
                            <button class="btn btn-primary btn-sm" onclick="createNewReconciliation()">
                                <i class="bi bi-plus-circle me-1"></i> Create First Reconciliation
                            </button>
                        </td>
                    </tr>
                `;
            }

            html += `
                        </tbody>
                    </table>
                </div>
            `;

            container.innerHTML = html;
        }

        function getStatusBadge(status) {
            const statusMap = {
                'draft': '<span class="badge bg-secondary">Draft</span>',
                'calculated': '<span class="badge bg-info">Calculated</span>',
                'reconciled': '<span class="badge bg-primary">Reconciled</span>',
                'submitted': '<span class="badge bg-success">Submitted</span>',
                'approved': '<span class="badge bg-success">Approved</span>',
                'paid': '<span class="badge bg-success">Paid</span>',
                'rejected': '<span class="badge bg-danger">Rejected</span>'
            };
            return statusMap[status] || `<span class="badge bg-secondary">${status}</span>`;
        }

        function getPaymentStatusBadge(paymentStatus) {
            const statusMap = {
                'unpaid': '<span class="badge bg-danger">Unpaid</span>',
                'partial': '<span class="badge bg-warning">Partial</span>',
                'paid': '<span class="badge bg-success">Paid</span>',
                'overpaid': '<span class="badge bg-info">Overpaid</span>'
            };
            return statusMap[paymentStatus] || `<span class="badge bg-secondary">${paymentStatus}</span>`;
        }

        // VAT Reconciliation Actions

        async function createNewReconciliation() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const branchId = document.getElementById('branchFilter').value;

            if (!startDate || !endDate) {
                showError('Please select start and end dates for the reconciliation period');
                return;
            }

            try {
                // First, get the VAT summary for this period
                const params = new URLSearchParams();
                params.append('start_date', startDate);
                params.append('end_date', endDate);
                if (branchId) params.append('branch_id', branchId);

                const summaryResponse = await fetch(`/api/v1/vat/summary?${params}`);
                const summaryResult = await summaryResponse.json();
                const summary = summaryResult.data || summaryResult;

                // Create new reconciliation
                const reconciliationData = {
                    period_start: startDate,
                    period_end: endDate,
                    description: `VAT Reconciliation for ${startDate} to ${endDate}`,
                    vat_collected: summary.vat_collected || 0,
                    vat_paid: summary.vat_paid || 0,
                    net_vat_liability: (summary.vat_collected || 0) - (summary.vat_paid || 0),
                    vat_rate: 14.0,
                    status: 'calculated',
                    branch_id: branchId
                };

                const response = await fetch('/api/v1/vat/reconciliations', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(reconciliationData)
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                showSuccess('VAT reconciliation created successfully');

                // Reload reconciliations
                await loadVatReconciliations(branchId);

            } catch (error) {
                console.error('Error creating reconciliation:', error);
                showError('Failed to create VAT reconciliation: ' + error.message);
            }
        }

        async function performReconciliation(reconciliationId) {
            try {
                // Get reconciliation details
                const response = await fetch(`/api/v1/vat/reconciliations/${reconciliationId}`);
                const result = await response.json();
                const reconciliation = result.data || result;

                // Show reconciliation modal with verification
                showReconciliationModal(reconciliation);

            } catch (error) {
                console.error('Error loading reconciliation:', error);
                showError('Failed to load reconciliation details');
            }
        }

        function showReconciliationModal(reconciliation) {
            // Create modal HTML
            const modalHtml = `
                <div class="modal fade" id="reconciliationModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="bi bi-check2-square me-2"></i>
                                    VAT Reconciliation Verification
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle me-2"></i>
                                    <strong>Period:</strong> ${reconciliation.period_start} to ${reconciliation.period_end}
                                </div>

                                <h6 class="mt-3">VAT Summary</h6>
                                <table class="table table-bordered">
                                    <tr>
                                        <td><strong>VAT Output (Sales)</strong></td>
                                        <td class="text-end text-success">${formatCurrency(reconciliation.vat_collected)}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>VAT Input (Purchases)</strong></td>
                                        <td class="text-end text-warning">${formatCurrency(reconciliation.vat_paid)}</td>
                                    </tr>
                                    <tr class="table-primary">
                                        <td><strong>Net VAT Liability</strong></td>
                                        <td class="text-end"><strong>${formatCurrency(reconciliation.net_vat_liability)}</strong></td>
                                    </tr>
                                </table>

                                <h6 class="mt-3">Verification Checklist</h6>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="check1">
                                    <label class="form-check-label" for="check1">
                                        All sales invoices have been recorded and VAT calculated correctly
                                    </label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="check2">
                                    <label class="form-check-label" for="check2">
                                        All purchase invoices have been recorded with correct VAT amounts
                                    </label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="check3">
                                    <label class="form-check-label" for="check3">
                                        VAT rates (14%) have been applied correctly to all transactions
                                    </label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="check4">
                                    <label class="form-check-label" for="check4">
                                        Supporting documentation is available for all transactions
                                    </label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="check5">
                                    <label class="form-check-label" for="check5">
                                        Amounts have been cross-checked with bank statements
                                    </label>
                                </div>

                                <div class="mt-3">
                                    <label class="form-label">Reconciliation Notes</label>
                                    <textarea class="form-control" id="reconciliationNotes" rows="3"
                                        placeholder="Add any notes about discrepancies or adjustments..."></textarea>
                                </div>

                                <div class="mt-3">
                                    <label class="form-label">Verified By</label>
                                    <input type="text" class="form-control" id="verifiedBy"
                                        placeholder="Enter your name">
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" onclick="confirmReconciliation('${reconciliation.id}')">
                                    <i class="bi bi-check-circle me-1"></i> Confirm Reconciliation
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Remove existing modal if any
            const existingModal = document.getElementById('reconciliationModal');
            if (existingModal) {
                existingModal.remove();
            }

            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('reconciliationModal'));
            modal.show();
        }

        async function confirmReconciliation(reconciliationId) {
            // Validate checklist
            const checks = ['check1', 'check2', 'check3', 'check4', 'check5'];
            const allChecked = checks.every(id => document.getElementById(id).checked);

            if (!allChecked) {
                showError('Please complete all verification checks before confirming');
                return;
            }

            const verifiedBy = document.getElementById('verifiedBy').value.trim();
            if (!verifiedBy) {
                showError('Please enter your name in the "Verified By" field');
                return;
            }

            const notes = document.getElementById('reconciliationNotes').value.trim();

            try {
                // Update reconciliation status
                const response = await fetch(`/api/v1/vat/reconciliations/${reconciliationId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        status: 'reconciled',
                        verified_by: verifiedBy,
                        reconciliation_notes: notes,
                        reconciled_at: new Date().toISOString()
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                showSuccess('VAT reconciliation confirmed successfully');

                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('reconciliationModal'));
                modal.hide();

                // Reload reconciliations
                const branchId = document.getElementById('branchFilter').value;
                await loadVatReconciliations(branchId);

            } catch (error) {
                console.error('Error confirming reconciliation:', error);
                showError('Failed to confirm reconciliation: ' + error.message);
            }
        }

        async function submitVatReturn(reconciliationId) {
            if (!confirm('Are you sure you want to submit this VAT return to the tax authority? This action cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch(`/api/v1/vat/reconciliations/${reconciliationId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        status: 'submitted',
                        submitted_at: new Date().toISOString()
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                showSuccess('VAT return submitted successfully');

                // Reload reconciliations
                const branchId = document.getElementById('branchFilter').value;
                await loadVatReconciliations(branchId);

            } catch (error) {
                console.error('Error submitting VAT return:', error);
                showError('Failed to submit VAT return: ' + error.message);
            }
        }

        async function recordVatPayment(reconciliationId, outstandingAmount) {
            // Show payment modal
            const modalHtml = `
                <div class="modal fade" id="paymentModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="bi bi-cash-coin me-2"></i>
                                    Record VAT Payment
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle me-2"></i>
                                    Outstanding Amount: <strong>${formatCurrency(outstandingAmount)}</strong>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Payment Amount <span class="text-danger">*</span></label>
                                    <input type="number" class="form-control" id="paymentAmount"
                                        value="${outstandingAmount}" step="0.01" min="0">
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Payment Date <span class="text-danger">*</span></label>
                                    <input type="date" class="form-control" id="paymentDate"
                                        value="${new Date().toISOString().split('T')[0]}">
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Payment Method <span class="text-danger">*</span></label>
                                    <select class="form-select" id="paymentMethod">
                                        <option value="bank_transfer">Bank Transfer</option>
                                        <option value="eft">EFT</option>
                                        <option value="cheque">Cheque</option>
                                        <option value="cash">Cash</option>
                                        <option value="online">Online Payment</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Reference Number</label>
                                    <input type="text" class="form-control" id="paymentReference"
                                        placeholder="Transaction/Receipt reference">
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Bank Account</label>
                                    <select class="form-select" id="bankAccountId">
                                        <option value="">Select bank account...</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Notes</label>
                                    <textarea class="form-control" id="paymentNotes" rows="2"
                                        placeholder="Additional payment notes..."></textarea>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" onclick="saveVatPayment('${reconciliationId}')">
                                    <i class="bi bi-check-circle me-1"></i> Record Payment
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Remove existing modal
            const existingModal = document.getElementById('paymentModal');
            if (existingModal) {
                existingModal.remove();
            }

            // Add modal
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            // Load bank accounts
            try {
                const response = await fetch('/api/v1/banking/accounts');
                const result = await response.json();
                const accounts = result.data || result;

                const select = document.getElementById('bankAccountId');
                accounts.forEach(account => {
                    const option = document.createElement('option');
                    option.value = account.id;
                    option.textContent = `${account.account_name} (${account.account_number})`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading bank accounts:', error);
            }

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('paymentModal'));
            modal.show();
        }

        async function saveVatPayment(reconciliationId) {
            const amount = parseFloat(document.getElementById('paymentAmount').value);
            const paymentDate = document.getElementById('paymentDate').value;
            const paymentMethod = document.getElementById('paymentMethod').value;
            const referenceNumber = document.getElementById('paymentReference').value;
            const bankAccountId = document.getElementById('bankAccountId').value;
            const notes = document.getElementById('paymentNotes').value;

            if (!amount || amount <= 0) {
                showError('Please enter a valid payment amount');
                return;
            }

            if (!paymentDate) {
                showError('Please select a payment date');
                return;
            }

            try {
                const paymentData = {
                    vat_reconciliation_id: reconciliationId,
                    amount_paid: amount,
                    payment_date: paymentDate,
                    payment_method: paymentMethod,
                    reference_number: referenceNumber,
                    bank_account_id: bankAccountId || null,
                    notes: notes
                };

                const response = await fetch('/api/v1/vat/payments', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(paymentData)
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                showSuccess('VAT payment recorded successfully. Journal entries have been created automatically.');

                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('paymentModal'));
                modal.hide();

                // Reload reconciliations
                const branchId = document.getElementById('branchFilter').value;
                await loadVatReconciliations(branchId);

            } catch (error) {
                console.error('Error recording payment:', error);
                showError('Failed to record payment: ' + error.message);
            }
        }

        async function viewReconciliationDetails(reconciliationId) {
            try {
                // Get reconciliation details
                const recResponse = await fetch(`/api/v1/vat/reconciliations/${reconciliationId}`);
                const recResult = await recResponse.json();
                const reconciliation = recResult.data || recResult;

                // Get reconciliation items
                const itemsResponse = await fetch(`/api/v1/vat/items?reconciliation_id=${reconciliationId}`);
                const itemsResult = await itemsResponse.json();
                const items = itemsResult.data || [];

                // Get payments
                const paymentsResponse = await fetch(`/api/v1/vat/payments?reconciliation_id=${reconciliationId}`);
                const paymentsResult = await paymentsResponse.json();
                const payments = paymentsResult.data || [];

                // Show details modal
                showReconciliationDetailsModal(reconciliation, items, payments);

            } catch (error) {
                console.error('Error loading reconciliation details:', error);
                showError('Failed to load reconciliation details');
            }
        }

        function showReconciliationDetailsModal(reconciliation, items, payments) {
            const modalHtml = `
                <div class="modal fade" id="detailsModal" tabindex="-1">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="bi bi-file-text me-2"></i>
                                    VAT Reconciliation Details
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <strong>Period:</strong> ${reconciliation.period_start} to ${reconciliation.period_end}
                                    </div>
                                    <div class="col-md-6">
                                        <strong>Status:</strong> ${getStatusBadge(reconciliation.status)}
                                    </div>
                                </div>

                                <h6 class="mt-3">Summary</h6>
                                <table class="table table-bordered table-sm">
                                    <tr>
                                        <td>VAT Output</td>
                                        <td class="text-end">${formatCurrency(reconciliation.vat_collected)}</td>
                                    </tr>
                                    <tr>
                                        <td>VAT Input</td>
                                        <td class="text-end">${formatCurrency(reconciliation.vat_paid)}</td>
                                    </tr>
                                    <tr class="table-primary">
                                        <td><strong>Net VAT Liability</strong></td>
                                        <td class="text-end"><strong>${formatCurrency(reconciliation.net_vat_liability)}</strong></td>
                                    </tr>
                                    <tr>
                                        <td>Total Payments</td>
                                        <td class="text-end">${formatCurrency(reconciliation.total_payments || 0)}</td>
                                    </tr>
                                    <tr class="table-warning">
                                        <td><strong>Outstanding Amount</strong></td>
                                        <td class="text-end"><strong>${formatCurrency(reconciliation.outstanding_amount || reconciliation.net_vat_liability)}</strong></td>
                                    </tr>
                                </table>

                                ${items.length > 0 ? `
                                    <h6 class="mt-3">Transaction Items (${items.length})</h6>
                                    <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                                        <table class="table table-sm table-striped">
                                            <thead class="sticky-top bg-white">
                                                <tr>
                                                    <th>Date</th>
                                                    <th>Type</th>
                                                    <th>Reference</th>
                                                    <th>Description</th>
                                                    <th class="text-end">VAT Amount</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${items.map(item => `
                                                    <tr>
                                                        <td>${new Date(item.transaction_date).toLocaleDateString()}</td>
                                                        <td><span class="badge bg-${item.item_type === 'output' ? 'success' : 'warning'}">${item.item_type}</span></td>
                                                        <td>${item.reference_id || '-'}</td>
                                                        <td>${item.description}</td>
                                                        <td class="text-end">${formatCurrency(item.vat_amount)}</td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                ` : '<p class="text-muted">No transaction items recorded</p>'}

                                ${payments.length > 0 ? `
                                    <h6 class="mt-3">Payment History (${payments.length})</h6>
                                    <div class="table-responsive">
                                        <table class="table table-sm table-striped">
                                            <thead>
                                                <tr>
                                                    <th>Date</th>
                                                    <th>Amount</th>
                                                    <th>Method</th>
                                                    <th>Reference</th>
                                                    <th>Notes</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${payments.map(payment => `
                                                    <tr>
                                                        <td>${new Date(payment.payment_date).toLocaleDateString()}</td>
                                                        <td>${formatCurrency(payment.amount_paid)}</td>
                                                        <td>${payment.payment_method}</td>
                                                        <td>${payment.reference_number || '-'}</td>
                                                        <td>${payment.notes || '-'}</td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                ` : '<p class="text-muted">No payments recorded</p>'}
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <button type="button" class="btn btn-primary" onclick="printReconciliationReport('${reconciliation.id}')">
                                    <i class="bi bi-printer me-1"></i> Print Report
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Remove existing modal
            const existingModal = document.getElementById('detailsModal');
            if (existingModal) {
                existingModal.remove();
            }

            // Add modal
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('detailsModal'));
            modal.show();
        }

        function printReconciliationReport(reconciliationId) {
            window.open(`/api/v1/vat/reconciliations/${reconciliationId}/report`, '_blank');
        }

        function showSuccess(message) {
            // Remove existing alerts
            const existingAlerts = document.querySelectorAll('.alert-dismissible');
            existingAlerts.forEach(alert => alert.remove());

            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3';
            alertDiv.style.zIndex = '9999';
            alertDiv.innerHTML = `
                <i class="bi bi-check-circle me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alertDiv);

            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        function updateComplianceReport(data) {
            const container = document.getElementById('complianceDetails');

            // Calculate compliance metrics
            const complianceScore = 95; // Sample score
            const filingStatus = 'On Time';
            const penalties = 0;
            const nextFiling = new Date();
            nextFiling.setDate(nextFiling.getDate() + 15);

            document.getElementById('complianceScore').textContent = complianceScore + '%';
            document.getElementById('filingStatus').textContent = filingStatus;
            document.getElementById('penalties').textContent = formatCurrency(penalties);
            document.getElementById('nextFiling').textContent = nextFiling.toLocaleDateString();

            let html = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Compliance Checklist</h6>
                        <ul class="list-unstyled">
                            <li class="mb-2">
                                <i class="bi bi-check-circle text-success me-2"></i>
                                VAT registration up to date
                            </li>
                            <li class="mb-2">
                                <i class="bi bi-check-circle text-success me-2"></i>
                                All VAT returns filed on time
                            </li>
                            <li class="mb-2">
                                <i class="bi bi-check-circle text-success me-2"></i>
                                Proper VAT calculations
                            </li>
                            <li class="mb-2">
                                <i class="bi bi-check-circle text-success me-2"></i>
                                Supporting documentation maintained
                            </li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>Recommendations</h6>
                        <ul class="list-unstyled">
                            <li class="mb-2">
                                <i class="bi bi-info-circle text-info me-2"></i>
                                Review VAT input claims for accuracy
                            </li>
                            <li class="mb-2">
                                <i class="bi bi-info-circle text-info me-2"></i>
                                Ensure all invoices include VAT numbers
                            </li>
                            <li class="mb-2">
                                <i class="bi bi-info-circle text-info me-2"></i>
                                Monitor VAT rate changes
                            </li>
                        </ul>
                    </div>
                </div>
            `;

            container.innerHTML = html;
        }

        function showReportSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.report-section').forEach(section => {
                section.style.display = 'none';
            });

            // Show selected section
            document.getElementById(sectionId).style.display = 'block';
        }

        function showLoading() {
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'loading';
            loadingDiv.className = 'position-fixed top-50 start-50 translate-middle';
            loadingDiv.innerHTML = `
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            `;
            document.body.appendChild(loadingDiv);
        }

        function hideLoading() {
            const loading = document.getElementById('loading');
            if (loading) {
                loading.remove();
            }
        }

        // Currency formatting function
        function formatCurrency(amount) {
            if (typeof amount !== 'number') {
                amount = parseFloat(amount) || 0;
            }
            return new Intl.NumberFormat('en-BW', {
                style: 'currency',
                currency: 'BWP',
                minimumFractionDigits: 2
            }).format(amount);
        }

        function showError(message) {
            // Remove existing alerts
            const existingAlerts = document.querySelectorAll('.alert-dismissible');
            existingAlerts.forEach(alert => alert.remove());

            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3';
            alertDiv.style.zIndex = '9999';
            alertDiv.innerHTML = `
                <i class="bi bi-exclamation-triangle me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alertDiv);

            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 8000);
        }

        function exportReport() {
            alert('Export functionality will be implemented');
        }

        function printReport() {
            window.print();
        }
    </script>

</body>

</html>
