<!DOCTYPE html>
<html lang="en" class="light-mode">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CNPERP - Invoices</title>
    <script>console.info('[Invoices UI] Build v2025-09-04-1 loaded at', new Date().toISOString());</script>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Document Logo Manager -->
    <script src="js/document-logo-manager.js"></script>
    
    <style>
        :root {
            --primary-color: #0d6efd;
            --success-color: #198754;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #0dcaf0;
            --dark-color: #212529;
            --light-color: #f8f9fa;
        }

        .light-mode {
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --border-color: #dee2e6;
        }

        .dark-mode {
            --bg-primary: #212529;
            --bg-secondary: #343a40;
            --text-primary: #ffffff;
            --text-secondary: #adb5bd;
            --border-color: #495057;
        }

        body {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .card {
            background-color: var(--bg-primary);
            border-color: var(--border-color);
            transition: all 0.3s ease;
        }

        .navbar {
            background: linear-gradient(135deg, var(--primary-color), #0056b3) !important;
        }

        .invoice-card {
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease;
            cursor: pointer;
        }

        .invoice-card:hover {
            transform: translateY(-2px);
        }

        .status-badge {
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
        }

        .amount-positive {
            color: var(--success-color);
            font-weight: bold;
        }

        .amount-negative {
            color: var(--danger-color);
            font-weight: bold;
        }

        .filter-section {
            background-color: var(--bg-primary);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .stats-card {
            background: linear-gradient(135deg, var(--primary-color), #0056b3);
            color: white;
            border-radius: 15px;
            padding: 20px;
        }

        .stats-card.clickable {
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .stats-card.clickable:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .modal-content {
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }

        /* A4 Invoice Preview Styles */
        .invoice-preview-modal .modal-dialog {
            max-width: 95vw;
            height: 95vh;
        }

        .invoice-preview-modal .modal-content {
            height: 100%;
        }

        .invoice-preview-modal .modal-body {
            padding: 0;
            overflow: hidden;
        }

        .invoice-a4-container {
            width: 210mm;
            height: 297mm;
            margin: 0 auto;
            background: white;
            color: black;
            padding: 20mm;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            position: relative;
            font-family: 'Arial', sans-serif;
            font-size: 12pt;
            line-height: 1.4;
            overflow: hidden;
        }

        .invoice-a4-container.designer-active {
            padding: 0;
        }

        .invoice-designer-preview {
            position: relative;
            width: 210mm;
            min-height: 297mm;
            margin: 0 auto;
            background: white;
            color: #0f172a;
            border-radius: 12px;
            box-shadow: 0 24px 48px -32px rgba(15, 23, 42, 0.35);
            overflow: hidden;
            font-family: "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
        }

        .invoice-designer-preview .invoice-safe-area {
            position: absolute;
            inset: 15mm;
            border: 1px dashed rgba(37, 99, 235, 0.25);
            border-radius: 12px;
            pointer-events: none;
        }

        .invoice-designer-preview .designer-preview-element {
            position: absolute;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.92);
            padding: 12px;
            box-shadow: 0 18px 36px -24px rgba(15, 23, 42, 0.25);
            overflow: hidden;
            backdrop-filter: blur(2px);
        }

        .invoice-designer-preview .designer-preview-element[data-element-type="logo"] {
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            box-shadow: none;
        }

        .invoice-designer-preview .designer-preview-element[data-element-type="logo"] img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .invoice-designer-preview .designer-preview-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .invoice-designer-preview .designer-preview-table th,
        .invoice-designer-preview .designer-preview-table td {
            border: 1px solid rgba(100, 116, 139, 0.25);
            padding: 8px 10px;
            text-align: left;
        }

        .invoice-designer-preview .designer-preview-table thead th {
            background: rgba(15, 23, 42, 0.88);
            color: #fff;
        }

        .invoice-designer-preview .designer-preview-table tbody tr:nth-child(even) {
            background: rgba(241, 245, 249, 0.72);
        }

        .invoice-designer-preview .designer-preview-details {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .invoice-designer-preview .designer-preview-details .row {
            display: flex;
            justify-content: space-between;
            font-size: 0.95rem;
            color: #1f2937;
        }

        .invoice-designer-preview .designer-preview-details .row .label {
            font-weight: 600;
            margin-right: 12px;
        }

        .invoice-designer-preview .designer-preview-customer {
            display: flex;
            flex-direction: column;
            gap: 6px;
            font-size: 0.95rem;
        }

        .invoice-designer-preview .designer-preview-customer .title {
            font-weight: 600;
            color: #0f172a;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        .invoice-designer-preview .designer-preview-totals {
            width: 100%;
            border-collapse: collapse;
        }

        .invoice-designer-preview .designer-preview-totals td {
            padding: 6px 0;
            font-size: 0.95rem;
        }

        .invoice-designer-preview .designer-preview-totals tr.total-row td {
            font-weight: 600;
            font-size: 1.05rem;
            border-top: 1px solid rgba(15, 23, 42, 0.28);
        }

        .invoice-designer-preview .designer-preview-notes {
            font-size: 0.95rem;
            color: #1f2937;
        }

        .invoice-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 30px;
            border-bottom: 2px solid #eee;
            padding-bottom: 20px;
        }

        .company-info {
            flex: 1;
        }

        .company-logo {
            max-width: 150px;
            max-height: 75px;
            margin-bottom: 10px;
        }

        .company-name {
            font-size: 24pt;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .company-details {
            font-size: 10pt;
            color: #666;
        }

        .invoice-title {
            text-align: right;
            flex: 1;
        }

        .invoice-title h1 {
            font-size: 36pt;
            font-weight: bold;
            color: #2c3e50;
            margin: 0;
        }

        .invoice-meta {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
        }

        .customer-info, .invoice-info {
            flex: 1;
        }

        .customer-info {
            padding-right: 20px;
        }

        .invoice-info {
            text-align: right;
        }

        .info-label {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .invoice-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 30px;
        }

        .invoice-table th {
            background-color: #f8f9fa;
            padding: 12px 8px;
            border: 1px solid #dee2e6;
            font-weight: bold;
            text-align: left;
        }

        .invoice-table td {
            padding: 10px 8px;
            border: 1px solid #dee2e6;
        }

        .invoice-table .text-right {
            text-align: right;
        }

        .invoice-totals {
            width: 300px;
            margin-left: auto;
            margin-bottom: 30px;
        }

        .invoice-totals table {
            width: 100%;
        }

        .invoice-totals td {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .total-row {
            font-weight: bold;
            font-size: 14pt;
            border-top: 2px solid #2c3e50 !important;
        }

        .invoice-footer {
            margin-top: auto;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        .footer-section {
            margin-bottom: 15px;
        }

        .footer-title {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .print-controls {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        @media print {
            .invoice-preview-modal .modal-header,
            .invoice-preview-modal .modal-footer,
            .print-controls {
                display: none !important;
            }

            .invoice-preview-modal .modal-dialog {
                max-width: none;
                margin: 0;
            }

            .invoice-preview-modal .modal-content {
                border: none;
                box-shadow: none;
            }

            .invoice-a4-container {
                box-shadow: none;
                margin: 0;
                width: 100%;
                height: 100%;
                padding: 0;
            }

            .invoice-designer-preview {
                box-shadow: none;
                border-radius: 0;
            }
        }

        @page {
            size: A4;
            margin: 0;
        }

        .form-control, .form-select {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            border-color: var(--border-color);
        }

        .form-control:focus, .form-select:focus {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
        }

        .table {
            color: var(--text-primary);
        }

        .table th {
            background-color: var(--bg-secondary);
            border-color: var(--border-color);
        }

        .table td {
            border-color: var(--border-color);
        }
    </style>
</head>
<body>
    <!-- Navigation Bar Container -->
    <div id="navbar-container"></div>
    <!-- Navbar Scripts -->
    <script src="js/navbar.js?v=20250106001"></script>
    
    <!-- Spacer to prevent content from being hidden under fixed navbar -->
    <div style="height: 70px;"></div>

    <!-- Main Content -->
    <div class="container-fluid mt-4">
    

    <div class="container-fluid mt-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="h3 mb-0">
                            <i class="bi bi-receipt text-primary"></i> Invoices
                        </h1>
                        <p class="text-muted mb-0">Manage customer invoices and payments</p>
                        <div class="form-check form-switch mt-2">
                            <input class="form-check-input" type="checkbox" id="autoPrintToggle">
                            <label class="form-check-label" for="autoPrintToggle">Auto Print on Create</label>
                            <button class="btn btn-sm btn-outline-secondary ms-2" id="retryPrintBtn" disabled>
                                <i class="bi bi-printer"></i> Retry Last Print
                            </button>
                        </div>
                    </div>
                    <div class="d-flex gap-2 align-items-center">
                        <!-- Invoice Designer Button -->
                        <button class="btn btn-outline-primary btn-sm" onclick="openInvoiceDesigner()" title="Design Custom Invoices">
                            <i class="bi bi-palette"></i> Invoice Designer
                        </button>
                        
                        <!-- Invoice Customization Button -->
                        <button class="btn btn-outline-info btn-sm" onclick="openInvoiceCustomization()" title="Customize Invoice Templates">
                            <i class="bi bi-gear"></i> Customize Templates
                        </button>
                        
                        <!-- Print Settings Button -->
                        <button class="btn btn-outline-dark btn-sm" onclick="openInvoicePrintSettings()" title="Printer Settings">
                            <i class="bi bi-printer"></i> Print Settings
                        </button>
                        
                        <!-- Create Invoice Button -->
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addInvoiceModal">
                            <i class="bi bi-plus"></i> Create Invoice
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="stats-card clickable" onclick="filterByAllInvoices()">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="mb-1">Total Invoices</h6>
                            <h3 class="mb-0" id="totalInvoices">-</h3>
                        </div>
                        <i class="bi bi-receipt fs-1"></i>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="mb-1">Total Amount</h6>
                            <h3 class="mb-0" id="totalAmount">-</h3>
                        </div>
                        <i class="bi bi-currency-Pula fs-1"></i>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card clickable" onclick="filterByPaidInvoices()">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="mb-1">Paid Invoices</h6>
                            <h3 class="mb-0" id="paidInvoices">-</h3>
                        </div>
                        <i class="bi bi-check-circle fs-1"></i>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card clickable" onclick="filterByOutstanding()">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="mb-1">Outstanding</h6>
                            <h3 class="mb-0" id="outstandingAmount">-</h3>
                        </div>
                        <i class="bi bi-exclamation-triangle fs-1"></i>
                    </div>
                </div>
            </div>
        </div>
        <!-- Extended Statistics Cards -->
        <div class="row mb-4">
            <div class="col-md-2">
                <div class="stats-card">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="mb-1">Unpaid</h6>
                            <h3 class="mb-0" id="unpaidInvoices">-</h3>
                        </div>
                        <i class="bi bi-hourglass-split fs-1"></i>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="stats-card clickable" onclick="filterByOverdueInvoices()">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="mb-1">Overdue</h6>
                            <h3 class="mb-0" id="overdueInvoices">-</h3>
                        </div>
                        <i class="bi bi-alarm fs-1"></i>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="stats-card">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="mb-1">Total Paid</h6>
                            <h3 class="mb-0" id="totalPaid">-</h3>
                        </div>
                        <i class="bi bi-wallet2 fs-1"></i>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="stats-card">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="mb-1">Avg. Pay Time</h6>
                            <h3 class="mb-0" id="avgPaymentTime">-</h3>
                        </div>
                        <i class="bi bi-speedometer2 fs-1"></i>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="stats-card">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="mb-1">Highest Value</h6>
                            <h3 class="mb-0" id="highestInvoiceValue">-</h3>
                        </div>
                        <i class="bi bi-graph-up fs-1"></i>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="stats-card">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="mb-1">Top Customer</h6>
                            <h6 class="mb-0" id="customerWithMostInvoices">-</h6>
                        </div>
                        <i class="bi bi-person-badge fs-1"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="filter-section">
            <div class="row">
                <div class="col-md-2">
                    <label class="form-label">Customer</label>
                    <select class="form-select" id="customerFilter">
                        <option value="">All Customers</option>
                        <option value="1">John Doe</option>
                        <option value="2">ABC Corporation</option>
                        <option value="3">XYZ Wholesale</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Status</label>
                    <select class="form-select" id="statusFilter">
                        <option value="">All Status</option>
                        <option value="draft">Draft</option>
                        <option value="sent">Sent</option>
                        <option value="outstanding">Outstanding</option>
                        <option value="paid">Paid</option>
                        <option value="overdue">Overdue</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">From Date</label>
                    <input type="date" class="form-control" id="fromDateFilter">
                </div>
                <div class="col-md-2">
                    <label class="form-label">To Date</label>
                    <input type="date" class="form-control" id="toDateFilter">
                </div>
                <div class="col-md-2">
                    <label class="form-label">Search</label>
                    <input type="text" class="form-control" id="searchFilter" placeholder="Search invoices...">
                </div>
                <div class="col-md-2">
                    <label class="form-label">&nbsp;</label>
                    <button class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                        <i class="bi bi-arrow-clockwise"></i> Clear
                    </button>
                </div>
            </div>
        </div>

        <!-- Invoices Table -->
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Invoice History</h5>
                    <div>
                        <button class="btn btn-outline-info btn-sm me-2" onclick="configureInvoiceFormat()">
                            <i class="bi bi-gear"></i> Invoice Format
                        </button>
                        
                        <!-- Bulk Print Dropdown -->
                        <div class="btn-group me-2">
                            <button type="button" class="btn btn-outline-dark btn-sm dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="bi bi-printer"></i> Bulk Print
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" onclick="bulkPrintInvoices('auto')">
                                    <i class="bi bi-printer"></i> Print Selected (Auto Format)
                                </a></li>
                                <li><a class="dropdown-item" href="#" onclick="bulkPrintInvoices('pdf')">
                                    <i class="bi bi-file-pdf"></i> Print Selected as PDF
                                </a></li>
                                <li><a class="dropdown-item" href="#" onclick="bulkPrintInvoices('dot_matrix')">
                                    <i class="bi bi-grid-3x3"></i> Print Selected Dot Matrix
                                </a></li>
                                <li><hr class="dropdown-divider"></li>
                            </ul>
                        </div>
                        
                        <button class="btn btn-outline-primary btn-sm me-2" onclick="exportInvoices()">
                            <i class="bi bi-download"></i> Export
                        </button>
                        <button class="btn btn-outline-success btn-sm" onclick="sendInvoices()">
                            <i class="bi bi-envelope"></i> Send Selected
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>
                                    <input type="checkbox" class="form-check-input" id="selectAll">
                                </th>
                                <th>Invoice #</th>
                                <th>Date</th>
                                <th>Customer</th>
                                <th>Due Date</th>
                                <th>Total Amount</th>
                                <th>Amount Paid</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="invoicesTable">
                            <!-- Invoices will be dynamically generated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Invoice Modal -->
    <div class="modal fade" id="addInvoiceModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-plus-circle"></i> Create New Invoice
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addInvoiceForm">
                        <!-- Customer Selection Mode -->
                        <div class="mb-3">
                            <label class="form-label">Customer Information</label>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="customerMode" id="existingCustomer" value="existing" checked>
                                <label class="btn btn-outline-primary" for="existingCustomer">Existing Customer</label>
                                <input type="radio" class="btn-check" name="customerMode" id="newCustomer" value="new">
                                <label class="btn btn-outline-primary" for="newCustomer">New Customer</label>
                            </div>
                        </div>

                        <!-- Existing Customer Selection -->
                        <div id="existingCustomerSection">
                            <div class="mb-3">
                                <label class="form-label">Select Customer *</label>
                                <select class="form-select" id="invoiceCustomer" name="invoiceCustomer" required>
                                    <option value="">Select Customer</option>
                                    <option value="walk-in">Walk-in Customer (Cash Sales)</option>
                                    <option value="1">John Doe</option>
                                    <option value="2">ABC Corporation</option>
                                    <option value="3">XYZ Wholesale</option>
                                </select>
                            </div>
                        </div>

                        <!-- New Customer Details -->
                        <div id="newCustomerSection" style="display: none;">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Customer Name *</label>
                                        <input type="text" class="form-control" id="newCustomerName" name="newCustomerName" placeholder="Enter customer name">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Phone Number</label>
                                        <input type="tel" class="form-control" id="newCustomerPhone" name="newCustomerPhone" placeholder="Enter phone number">
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Email</label>
                                        <input type="email" class="form-control" id="newCustomerEmail" name="newCustomerEmail" placeholder="Enter email address">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">VAT Registration Number</label>
                                        <input type="text" class="form-control" id="newCustomerVAT" name="newCustomerVAT" placeholder="Enter VAT number">
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Address</label>
                                <textarea class="form-control" id="newCustomerAddress" name="newCustomerAddress" rows="2" placeholder="Enter customer address"></textarea>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Invoice Date *</label>
                                    <input type="date" class="form-control" id="invoiceDate" name="invoiceDate" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Payment Terms *</label>
                                    <select class="form-select" id="paymentTermsType" required>
                                        <option value="credit">Credit Terms</option>
                                        <option value="cash">Cash Sale (Immediate Payment)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Credit Terms Details -->
                        <div class="row" id="creditTermsSection">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Due Date</label>
                                    <input type="date" class="form-control" id="dueDate" name="dueDate">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Payment Terms (days)</label>
                                    <input type="number" class="form-control" id="paymentTerms" name="paymentTerms" value="30" min="0">
                                </div>
                            </div>
                        </div>

                        <!-- Cash Sale Details -->
                        <div class="row" id="cashSaleSection" style="display: none;">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Payment Method *</label>
                                    <select class="form-select" id="cashPaymentMethod" name="cashPaymentMethod">
                                        <option value="cash">Cash</option>
                                        <option value="card">Credit/Debit Card</option>
                                        <option value="mobile_money">Mobile Money</option>
                                        <option value="bank_transfer">Bank Transfer</option>
                                        <option value="cheque">Cheque</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Payment Reference</label>
                                    <input type="text" class="form-control" id="paymentReference" name="paymentReference" placeholder="Transaction ID, Receipt #, etc.">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Amount Tendered *</label>
                                    <input type="number" class="form-control" id="amountTendered" name="amountTendered" placeholder="0.00" step="0.01" min="0">
                                    <div class="form-text">Amount given by customer</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Change Due</label>
                                    <input type="number" class="form-control" id="changeDue" name="changeDue" placeholder="0.00" step="0.01" readonly style="background-color: #f8f9fa;">
                                    <div class="form-text">Calculated automatically</div>
                                </div>
                            </div>
                        </div>

                        <!-- Invoice Items -->
                        <div class="mb-3">
                            <label class="form-label">Invoice Items</label>
                            <div id="invoiceItems">
                                <div class="row mb-2 invoice-item">
                                    <div class="col-md-4">
                                        <select class="form-select" name="product[]" required>
                                            <option value="">Select Product</option>
                                            <option value="1">Product A</option>
                                            <option value="2">Product B</option>
                                            <option value="3">Product C</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <input type="number" class="form-control" name="quantity[]" placeholder="Qty" required>
                                    </div>
                                    <div class="col-md-2">
                                        <input type="number" class="form-control" name="price[]" placeholder="Price" step="0.01" required>
                                    </div>
                                    <div class="col-md-2">
                                        <input type="number" class="form-control" name="vat[]" placeholder="VAT" step="0.01" value="0">
                                    </div>
                                    <div class="col-md-1 d-flex align-items-center">
                                        <span class="fw-semibold small line-total" data-line-total="0">0.00</span>
                                    </div>
                                    <div class="col-md-1">
                                        <button type="button" class="btn btn-outline-danger btn-sm w-100" onclick="removeInvoiceItem(this)"><i class="bi bi-trash"></i></button>
                                    </div>
                                </div>
                            </div>
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="addInvoiceItem()">
                                <i class="bi bi-plus"></i> Add Item
                            </button>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Discount Amount</label>
                                    <input type="number" class="form-control" id="discountAmount" step="0.01" value="0">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Discount Percentage</label>
                                    <input type="number" class="form-control" id="discountPercentage" step="0.01" value="0">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Notes</label>
                            <textarea class="form-control" id="invoiceNotes" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-outline-primary" id="saveDraftBtn">
                        <i class="bi bi-save"></i> Save Draft
                    </button>
                    <button type="button" class="btn btn-primary" id="saveInvoiceBtn">
                        <i class="bi bi-check"></i> Create Invoice
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Invoice Details Modal -->
    <div class="modal fade" id="invoiceDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-receipt"></i> Invoice Details
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Invoice Information</h6>
                            <table class="table table-borderless">
                                <tr>
                                    <td><strong>Invoice #:</strong></td>
                                    <td id="detailInvoiceNumber">INV-001</td>
                                </tr>
                                <tr>
                                    <td><strong>Customer:</strong></td>
                                    <td id="detailCustomerName">John Doe</td>
                                </tr>
                                <tr>
                                    <td><strong>Date:</strong></td>
                                    <td id="detailInvoiceDate">2024-01-15</td>
                                </tr>
                                <tr>
                                    <td><strong>Due Date:</strong></td>
                                    <td id="detailDueDate">2024-02-15</td>
                                </tr>
                                <tr>
                                    <td><strong>Status:</strong></td>
                                    <td><span class="badge bg-warning" id="detailStatus">Pending</span></td>
                                </tr>
                                <tr>
                                    <td><strong>Total Amount:</strong></td>
                                    <td class="amount-positive" id="detailTotalAmount">P 1,250.00</td>
                                </tr>
                                <tr>
                                    <td><strong>Amount Paid:</strong></td>
                                    <td class="amount-positive" id="detailAmountPaid">P 0.00</td>
                                </tr>
                                <tr>
                                    <td><strong>Balance:</strong></td>
                                    <td class="amount-negative" id="detailBalance">P 1,250.00</td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6>Invoice Items</h6>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Item</th>
                                            <th>Qty</th>
                                            <th>Unit</th>
                                            <th>Net</th>
                                            <th>VAT</th>
                                            <th>Total</th>
                                        </tr>
                                    </thead>
                                    <tbody id="invoiceItemsList">
                                        <!-- Invoice items will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-outline-warning" onclick="createCreditNoteFromInvoiceModal()">
                        <i class="bi bi-arrow-return-left"></i> Create Credit Note
                    </button>
                    
                    <!-- Enhanced Print Dropdown -->
                    <div class="btn-group">
                        <button type="button" class="btn btn-outline-primary" onclick="printInvoice()">
                            <i class="bi bi-printer"></i> Print
                        </button>
                        <button type="button" class="btn btn-outline-primary dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false">
                            <span class="visually-hidden">Toggle Dropdown</span>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="printInvoice()">
                                <i class="bi bi-printer"></i> Quick Print (Auto Format)
                            </a></li>
                            <li><a class="dropdown-item" href="#" onclick="printInvoiceAsPDF(currentInvoiceId)">
                                <i class="bi bi-file-pdf"></i> Force Print as PDF
                            </a></li>
                            <li><a class="dropdown-item" href="#" onclick="printInvoiceDotMatrix(currentInvoiceId)">
                                <i class="bi bi-grid-3x3"></i> Force Print Dot Matrix
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="downloadInvoicePDF(currentInvoiceId)">
                                <i class="bi bi-download"></i> Download PDF
                            </a></li>
                        </ul>
                    </div>
                    
                    <button type="button" class="btn btn-primary" onclick="sendInvoice()">
                        <i class="bi bi-envelope"></i> Send
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- A4 Invoice Preview Modal -->
    <div class="modal fade invoice-preview-modal" id="invoicePreviewModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-file-earmark-text"></i> Invoice Preview - A4 Format
                    </h5>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="configureInvoiceFormat()">
                            <i class="bi bi-gear"></i> Settings
                        </button>
                        <button type="button" class="btn btn-primary btn-sm" onclick="printA4Invoice()">
                            <i class="bi bi-printer"></i> Print
                        </button>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                </div>
                <div class="modal-body">
                    <div class="print-controls d-print-none">
                        <button class="btn btn-sm btn-outline-primary me-2" onclick="window.print()">
                            <i class="bi bi-printer"></i> Print
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="downloadInvoicePDF()">
                            <i class="bi bi-download"></i> Download PDF
                        </button>
                    </div>
                    
                    <div class="invoice-a4-container" id="invoiceA4Container">
                        <div id="invoiceDesignerPreview" class="invoice-designer-preview d-none">
                            <div class="invoice-safe-area" aria-hidden="true"></div>
                        </div>
                        <div id="invoiceA4Default">
                        <!-- Invoice Header -->
                        <div class="invoice-header">
                            <div class="company-info">
                                <img class="company-logo d-none" id="companyLogo" src="" alt="Company Logo">
                                <div class="company-name" id="companyName">Your Company Name</div>
                                <div class="company-details">
                                    <div id="companyAddress">123 Business St, City, Country</div>
                                    <div id="companyContact">
                                        <span class="phone-display">Phone: +123 456 7890</span>
                                        <span class="email-display"> | Email: info@company.com</span>
                                        <span class="website-display"> | www.company.com</span>
                                    </div>
                                    <div id="companyVatNumber" class="vat-display">VAT: 123456789</div>
                                </div>
                            </div>
                            <div class="invoice-title">
                                <h1>INVOICE</h1>
                            </div>
                        </div>

                        <!-- Invoice Meta Information -->
                        <div class="invoice-meta">
                            <div class="customer-info">
                                <div class="info-label">Bill To:</div>
                                <div id="customerName"><strong>Customer Name</strong></div>
                                <div id="customerDetails">
                                    <div class="customer-address-display">Customer Address</div>
                                    <div class="customer-contact-display">
                                        <div class="customer-phone-display">Phone: Customer Phone</div>
                                        <div class="customer-email-display">Email: customer@email.com</div>
                                    </div>
                                    <div class="customer-vat-display">VAT: Customer VAT Number</div>
                                </div>
                            </div>
                            <div class="invoice-info">
                                <table>
                                    <tr>
                                        <td><strong>Invoice #:</strong></td>
                                        <td id="previewInvoiceNumber">INV-001</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Date:</strong></td>
                                        <td id="previewInvoiceDate">2025-09-06</td>
                                    </tr>
                                    <tr class="due-date-display">
                                        <td><strong>Due Date:</strong></td>
                                        <td id="previewDueDate">2025-10-06</td>
                                    </tr>
                                    <tr class="payment-terms-display">
                                        <td><strong>Payment Terms:</strong></td>
                                        <td id="previewPaymentTerms">30 days</td>
                                    </tr>
                                </table>
                            </div>
                        </div>

                        <!-- Invoice Items Table -->
                        <table class="invoice-table">
                            <thead>
                                <tr>
                                    <th style="width: 8%">#</th>
                                    <th style="width: 35%">Description</th>
                                    <th style="width: 12%" class="text-right">Qty</th>
                                    <th style="width: 15%" class="text-right">Unit Price</th>
                                    <th style="width: 10%" class="text-right discount-display">Discount</th>
                                    <th style="width: 10%" class="text-right vat-breakdown-display">VAT</th>
                                    <th style="width: 15%" class="text-right">Total</th>
                                </tr>
                            </thead>
                            <tbody id="previewInvoiceItems">
                                <!-- Items will be populated here -->
                            </tbody>
                        </table>

                        <!-- Invoice Totals -->
                        <div class="invoice-totals">
                            <table>
                                <tr>
                                    <td>Subtotal:</td>
                                    <td class="text-right" id="previewSubtotal">$0.00</td>
                                </tr>
                                <tr class="discount-display">
                                    <td>Discount:</td>
                                    <td class="text-right" id="previewDiscount">$0.00</td>
                                </tr>
                                <tr class="vat-breakdown-display">
                                    <td>VAT (14%):</td>
                                    <td class="text-right" id="previewVat">$0.00</td>
                                </tr>
                                <tr class="total-row">
                                    <td>Total:</td>
                                    <td class="text-right" id="previewTotal">$0.00</td>
                                </tr>
                            </table>
                        </div>

                        <!-- Invoice Footer -->
                        <div class="invoice-footer">
                            <div class="footer-section">
                                <div class="footer-title">Payment Information</div>
                                <div id="paymentInfo">Please make payment within the specified terms.</div>
                            </div>
                            <div class="footer-section">
                                <div class="footer-title">Terms & Conditions</div>
                                <div id="termsConditions">Payment due within 30 days. Late fees may apply.</div>
                            </div>
                            <div class="footer-section">
                                <div id="footerText">Thank you for your business!</div>
                            </div>
                        </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Invoice Format Settings Modal -->
    <div class="modal fade" id="invoiceFormatModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-gear"></i> Invoice Format Settings
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Company Information Display</h6>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="showLogo" checked>
                                <label class="form-check-label" for="showLogo">Show Company Logo</label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="showCompanyAddress" checked>
                                <label class="form-check-label" for="showCompanyAddress">Show Company Address</label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="showCompanyPhone" checked>
                                <label class="form-check-label" for="showCompanyPhone">Show Company Phone</label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="showCompanyEmail" checked>
                                <label class="form-check-label" for="showCompanyEmail">Show Company Email</label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="showCompanyWebsite" checked>
                                <label class="form-check-label" for="showCompanyWebsite">Show Company Website</label>
                            </div>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="showCompanyVat" checked>
                                <label class="form-check-label" for="showCompanyVat">Show VAT Registration Number</label>
                            </div>

                            <h6>Customer Information Display</h6>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="showCustomerAddress" checked>
                                <label class="form-check-label" for="showCustomerAddress">Show Customer Address</label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="showCustomerPhone" checked>
                                <label class="form-check-label" for="showCustomerPhone">Show Customer Phone</label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="showCustomerEmail" checked>
                                <label class="form-check-label" for="showCustomerEmail">Show Customer Email</label>
                            </div>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="showCustomerVat" checked>
                                <label class="form-check-label" for="showCustomerVat">Show Customer VAT Number</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>Invoice Details Display</h6>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="showPaymentTerms" checked>
                                <label class="form-check-label" for="showPaymentTerms">Show Payment Terms</label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="showDueDate" checked>
                                <label class="form-check-label" for="showDueDate">Show Due Date</label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="showDiscount" checked>
                                <label class="form-check-label" for="showDiscount">Show Discount Column</label>
                            </div>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="showVatBreakdown" checked>
                                <label class="form-check-label" for="showVatBreakdown">Show VAT Breakdown</label>
                            </div>

                            <div class="alert alert-info" role="alert">
                                <i class="bi bi-info-circle"></i>
                                <strong>Logo Management:</strong> Company logo is now managed in 
                                <a href="settings.html" target="_blank" class="alert-link">Application Settings</a>. 
                                The "Show Logo" option above controls whether the logo appears on invoices.
                            </div>

                            <h6>Footer Text</h6>
                            <div class="mb-3">
                                <label for="footerTextInput" class="form-label">Footer Message</label>
                                <textarea class="form-control" id="footerTextInput" rows="2" placeholder="Thank you for your business!"></textarea>
                            </div>
                            <div class="mb-3">
                                <label for="termsConditionsInput" class="form-label">Terms & Conditions</label>
                                <textarea class="form-control" id="termsConditionsInput" rows="3" placeholder="Payment due within 30 days..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveInvoiceFormatSettings()">
                        <i class="bi bi-check"></i> Save Settings
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- API Configuration -->
    <script src="js/api-config.js"></script>
    
    
    <!-- Modern Interactions -->
    <script src="js/modern-interactions.js"></script>
    
    <script>
        console.log('[Invoices UI] Main page script loaded');
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            console.error(`Global error at ${url}:${lineNo}:${columnNo} - ${msg}`, error);
        };

    // Global data storage
    let invoices = [];
    let customers = [];
    let products = [];
    let branches = [];
    let defaultBranchId = null;
    let loading = false;

    // Currency settings (fallback defaults)
    let currentCurrency = 'BWP';
    let currencySymbol = 'P';
    let currencyCode = 'BWP';
    let defaultVatRate = 0; // loaded from invoice settings if available
    let removedItemsStack = []; // Stack for undo functionality
    let invoiceDesignerConfig = null;
    let invoiceDesignerConfigLoaded = false;

    // Using centralized API configuration
    const SALES_ENDPOINT = API_CONFIG.ENDPOINTS.SALES;
    const INVOICES_ENDPOINT = API_CONFIG.ENDPOINTS.INVOICES;
    const CUSTOMERS_ENDPOINT = API_CONFIG.ENDPOINTS.SALES_CUSTOMERS;
    const PRODUCTS_ENDPOINT = API_CONFIG.ENDPOINTS.INVENTORY_PRODUCTS;
    const BRANCHES_ENDPOINT = API_CONFIG.ENDPOINTS.BRANCHES;
    const SETTINGS_ENDPOINT = API_CONFIG.ENDPOINTS.SETTINGS_CURRENCY;
    const INVOICE_SETTINGS_ENDPOINT = `${INVOICES_ENDPOINT}/settings`;
    const INVOICE_TOGGLE_ENDPOINT = `${INVOICES_ENDPOINT}/settings/auto-print`;
    const INVOICE_STATS_ENDPOINT = `${INVOICES_ENDPOINT}/statistics/summary`;
    const INVOICE_LAYOUT_ENDPOINT = '/api/v1/invoice-designer/layout';
    let lastPrintPayload = null;

        // Load settings and currency
        async function loadSettings() {
            try {
                const response = await fetch(SETTINGS_ENDPOINT);
                if (response.ok) {
                    const settings = await response.json();
                    currentCurrency = settings.data.currency || 'BWP';
                    currencySymbol = settings.data.currency_symbol || 'P';
                    currencyCode = settings.data.currency || 'BWP';
                }
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }

        // Format currency amount
        function formatCurrency(amount) {
            return `${currencySymbol}${parseFloat(amount).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
        }

        // Fetch invoices from backend (supports filters)
        async function fetchInvoices() {
            try {
                loading = true;
                showLoadingState();

                const params = new URLSearchParams();
                const customerFilter = document.getElementById('customerFilter').value;
                const statusFilter = document.getElementById('statusFilter').value;
                const fromDateFilter = document.getElementById('fromDateFilter').value;
                const toDateFilter = document.getElementById('toDateFilter').value;
                const searchFilter = document.getElementById('searchFilter').value.trim().toLowerCase();

                if (customerFilter) params.append('customer_id', customerFilter);
                if (statusFilter) params.append('status', statusFilter);
                if (fromDateFilter) params.append('date_from', fromDateFilter);
                if (toDateFilter) params.append('date_to', toDateFilter);
                params.append('limit', '500');

                const response = await fetch(`${INVOICES_ENDPOINT}?${params.toString()}`);
                console.log(`[DEBUG] fetchInvoices response status: ${response.status}`);
                if (!response.ok) throw new Error(`Failed to load invoices (${response.status})`);
                const data = await response.json();
                console.log(`[DEBUG] fetchInvoices received ${data.length} invoices:`, data.slice(0, 3));

                invoices = data.map(inv => ({
                    id: inv.id,
                    invoiceNumber: inv.invoice_number,
                    customer: inv.customer_name,
                    date: inv.invoice_date,
                    dueDate: inv.due_date,
                    status: inv.status,
                    totalAmount: parseFloat(inv.total_amount || 0),
                    amountPaid: parseFloat((inv.total_amount || 0) - (inv.amount_due || 0)),
                    amountDue: parseFloat(inv.amount_due || 0)
                }));
                console.log(`[DEBUG] Processed invoices:`, invoices.slice(0, 3));

                // Client-side search filtering (since API doesn't expose generic search for now)
                let filtered = invoices;
                if (searchFilter) {
                    filtered = invoices.filter(i =>
                        (i.invoiceNumber && i.invoiceNumber.toLowerCase().includes(searchFilter)) ||
                        (i.customer && i.customer.toLowerCase().includes(searchFilter))
                    );
                }

                renderInvoices(filtered);
                await fetchInvoiceStatistics();
                if (window.modernUI) window.modernUI.showNotification('Invoices loaded', 'success');
            } catch (e) {
                console.error(e);
                invoices = [];
                renderInvoices();
                if (window.modernUI) window.modernUI.showNotification('Failed to load invoices', 'error');
            } finally {
                loading = false;
            }
        }

        async function fetchInvoiceStatistics() {
            try {
                const params = new URLSearchParams();
                const fromDateEl = document.getElementById('fromDateFilter');
                const toDateEl = document.getElementById('toDateFilter');
                const fromDateFilter = fromDateEl ? fromDateEl.value : '';
                const toDateFilter = toDateEl ? toDateEl.value : '';
                if (fromDateFilter) params.append('date_from', fromDateFilter);
                if (toDateFilter) params.append('date_to', toDateFilter);
                const response = await fetch(`${INVOICE_STATS_ENDPOINT}?${params.toString()}`);
                if (!response.ok) throw new Error('Stats load failed');
                const stats = await response.json();
                // Adapt structure for updateStatistics plus legacy quick stats
                const breakdown = stats.status_breakdown || [];
                const paid = breakdown.find(s=>s.status==='paid')?.count || 0;
                const unpaid = breakdown.find(s=>s.status==='unpaid')?.count || 0;
                const overdue = breakdown.find(s=>s.status==='overdue')?.count || 0;
                updateStatistics({
                    total_invoices: stats.total_invoices ?? 0,
                    paid_invoices: paid,
                    unpaid_invoices: unpaid,
                    overdue_invoices: overdue,
                    total_revenue: stats.total_amount || 0,
                    total_paid: stats.total_paid || stats.total_amount_paid || 0,
                    total_outstanding: stats.total_outstanding || 0,
                    average_payment_time_days: stats.average_payment_time_days || 0,
                    highest_invoice_value: stats.highest_invoice_value || 0,
                    customer_with_most_invoices: stats.customer_with_most_invoices || ''
                });
                const totalAmountEl = document.getElementById('totalAmount');
                if(totalAmountEl) totalAmountEl.textContent = formatCurrency(stats.total_amount || 0);
                const outstandingAmountEl = document.getElementById('outstandingAmount');
                if(outstandingAmountEl) outstandingAmountEl.textContent = formatCurrency(stats.total_outstanding || 0);
            } catch (e) {
                console.warn('Stats error', e);
            }
        }

        // Fetch customers for filters & creation modal
        async function fetchCustomers() {
            try {
                const response = await fetch(`${CUSTOMERS_ENDPOINT}?limit=500`);
                if (!response.ok) throw new Error('Customers load failed');
                customers = await response.json();
                // Populate filter select
                const filterSelect = document.getElementById('customerFilter');
                if (filterSelect) {
                    const current = filterSelect.value;
                    filterSelect.innerHTML = '<option value="">All Customers</option>';
                    customers.forEach(c => {
                        const opt = document.createElement('option');
                        opt.value = c.id;
                        opt.textContent = c.name;
                        filterSelect.appendChild(opt);
                    });
                    filterSelect.value = current;
                }
                // Populate creation modal select
                const createSelect = document.getElementById('invoiceCustomer');
                if (createSelect) {
                    const current = createSelect.value;
                    createSelect.innerHTML = '<option value="">Select Customer</option>';
                    // Add walk-in customer option for cash sales
                    const walkInOption = document.createElement('option');
                    walkInOption.value = 'walk-in';
                    walkInOption.textContent = 'Walk-in Customer (Cash Sales)';
                    createSelect.appendChild(walkInOption);
                    
                    customers.forEach(c => {
                        const opt = document.createElement('option');
                        opt.value = c.id;
                        opt.textContent = c.name;
                        createSelect.appendChild(opt);
                    });
                    if (current) createSelect.value = current;
                }
            } catch (e) { console.error(e); }
        }

        async function fetchProducts() {
            try {
                const response = await fetch(`${PRODUCTS_ENDPOINT}?limit=500`);
                if (!response.ok) throw new Error('Products load failed');
                products = await response.json();
                refreshProductSelects();
            } catch (e) { console.error(e); }
        }

        async function fetchBranches() {
            try {
                const response = await fetch(`${BRANCHES_ENDPOINT}`);
                if (!response.ok) throw new Error('Branches load failed');
                branches = await response.json();
                if (branches.length) defaultBranchId = branches[0].id; // pick first for now
            } catch (e) { console.error(e); }
        }

        // Setup event listeners for invoice item row
        function setupInvoiceItemEvents(row) {
            const productSelect = row.querySelector('select[name="product[]"]');
            const qtyInput = row.querySelector('input[name="quantity[]"]');
            const priceInput = row.querySelector('input[name="price[]"]');
            const vatInput = row.querySelector('input[name="vat[]"]');
            
            // Product selection change event
            if (productSelect && !productSelect.dataset.autoBound) {
                productSelect.addEventListener('change', () => {
                    applyProductDefaults(row);
                    recalcInvoiceTotals();
                });
                productSelect.dataset.autoBound = '1';
            }
            
            // Input change events for calculations
            [qtyInput, priceInput, vatInput].forEach(inp => {
                if (inp && !inp.dataset.calcBound) {
                    inp.addEventListener('input', () => {
                        recalcInvoiceTotals();
                    });
                    inp.addEventListener('change', () => {
                        recalcInvoiceTotals();
                    });
                    inp.dataset.calcBound = '1';
                }
            });
        }

        function refreshProductSelects() {
            document.querySelectorAll('#invoiceItems select[name="product[]"]').forEach(sel => {
                const current = sel.value;
                sel.innerHTML = '<option value="">Select Product</option>';
                products.forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p.id;
                    opt.textContent = p.name;
                    
                    // Safely handle price data
                    const priceValue = p.selling_price || p.price || p.unit_price || 0;
                    opt.dataset.price = isNaN(parseFloat(priceValue)) ? '0' : parseFloat(priceValue).toString();
                    
                    // Safely handle VAT data
                    const vatValue = p.vat_rate || p.vat || 0;
                    opt.dataset.vat = isNaN(parseFloat(vatValue)) ? '0' : parseFloat(vatValue).toString();
                    
                    // Handle taxable flag
                    opt.dataset.taxable = (p.is_taxable === true || p.is_taxable === 1 || p.is_taxable === '1') ? '1' : '0';
                    
                    sel.appendChild(opt);
                });
                if (current) sel.value = current;
            });
            
            // Setup event listeners for all invoice item rows
            document.querySelectorAll('#invoiceItems .invoice-item').forEach(row => {
                setupInvoiceItemEvents(row);
            });
            
            recalcInvoiceTotals();
        }

        function applyProductDefaults(row){
            const sel = row.querySelector('select[name="product[]"]');
            if(!sel || !sel.value) return;
            
            const opt = sel.options[sel.selectedIndex];
            if(!opt || !opt.value) return;
            
            const priceData = opt.dataset.price || opt.getAttribute('data-price') || '0';
            const vatData = opt.dataset.vat || '0';
            
            const price = isNaN(parseFloat(priceData)) ? 0 : parseFloat(priceData);
            const datasetVat = isNaN(parseFloat(vatData)) ? 0 : parseFloat(vatData);
            const isTaxable = opt.dataset.taxable === '1';
            
            const priceInput = row.querySelector('input[name="price[]"]');
            const vatInput = row.querySelector('input[name="vat[]"]');
            const qtyInput = row.querySelector('input[name="quantity[]"]');
            
            // Set price automatically
            if(priceInput && price >= 0) {
                priceInput.value = price.toFixed(2);
            }
            
            // Set VAT rate
            if(vatInput){
                let effectiveVat = datasetVat;
                // If product doesn't have specific VAT rate but is taxable, use default VAT rate
                if((!effectiveVat || effectiveVat === 0) && isTaxable && defaultVatRate > 0){
                    effectiveVat = defaultVatRate;
                }
                if(effectiveVat && effectiveVat > 0) {
                    vatInput.value = parseFloat(effectiveVat).toFixed(2);
                }
            }
            
            // Set default quantity if empty
            if(qtyInput && (!qtyInput.value || qtyInput.value === '')) {
                qtyInput.value = '1';
            }
            
            // Recalculate totals
            recalcInvoiceTotals();
        }

        function recalcInvoiceTotals(){
            let subtotal = 0, totalVat = 0;
            // Always use VAT exclusive mode (VAT added on top of prices)
            
            document.querySelectorAll('#invoiceItems .invoice-item').forEach(row => {
                const qtyVal = row.querySelector('input[name="quantity[]"]')?.value || '0';
                const priceVal = row.querySelector('input[name="price[]"]')?.value || '0';
                const vatVal = row.querySelector('input[name="vat[]"]')?.value || '0';
                
                const qty = isNaN(parseFloat(qtyVal)) ? 0 : parseFloat(qtyVal);
                const price = isNaN(parseFloat(priceVal)) ? 0 : parseFloat(priceVal);
                let vatRate = isNaN(parseFloat(vatVal)) ? 0 : parseFloat(vatVal);
                
                // If VAT rate is not set, try to get it from product data
                if((!vatRate || vatRate === 0)){
                    const productSelect = row.querySelector('select[name="product[]"]');
                    if(productSelect && productSelect.value){
                        const opt = productSelect.options[productSelect.selectedIndex];
                        if(opt && opt.dataset.taxable === '1' && defaultVatRate > 0){
                            vatRate = defaultVatRate;
                            const vatInput = row.querySelector('input[name="vat[]"]');
                            if(vatInput && (!vatInput.value || vatInput.value === '0')) {
                                vatInput.value = vatRate.toFixed(2);
                            }
                        }
                    }
                }
                
                // Always use VAT exclusive calculation (VAT added on top)
                const lineBase = qty * price;
                const lineVat = lineBase * (vatRate/100);
                
                subtotal += lineBase;
                totalVat += lineVat;
                
                const lineTotalEl = row.querySelector('.line-total');
                const lineNetEl = row.querySelector('.line-net');
                const lineVatEl = row.querySelector('.line-vat');
                const displayTotal = lineBase + lineVat;
                
                if(lineTotalEl){
                    lineTotalEl.dataset.lineTotal = displayTotal;
                    lineTotalEl.textContent = formatCurrency(displayTotal);
                }
                if(lineNetEl){ 
                    lineNetEl.dataset.lineNet = lineBase; 
                    lineNetEl.textContent = formatCurrency(lineBase); 
                }
                if(lineVatEl){ 
                    lineVatEl.dataset.lineVat = lineVat; 
                    lineVatEl.textContent = formatCurrency(lineVat); 
                }
            });
            
            const discountAmt = parseFloat(document.getElementById('discountAmount')?.value || '0');
            const discountPct = parseFloat(document.getElementById('discountPercentage')?.value || '0');
            let discountTotal = discountAmt;
            if(discountPct > 0) discountTotal += (subtotal * (discountPct/100));
            const grandTotal = Math.max(0, subtotal - discountTotal + totalVat);
            
            // Store the grand total for change calculation
            window.currentGrandTotal = grandTotal;
            
            let summary = document.getElementById('invoiceSummaryTotals');
            if(!summary){
                summary = document.createElement('div');
                summary.id = 'invoiceSummaryTotals';
                summary.className = 'alert alert-secondary p-2 mt-2';
                const itemsContainer = document.getElementById('invoiceItems');
                itemsContainer.parentNode.appendChild(summary);
            }
            summary.innerHTML = `
                <div class="d-flex flex-wrap gap-3 align-items-center">
                    <span><strong>Subtotal:</strong> ${formatCurrency(subtotal)}</span>
                    <span><strong>VAT:</strong> ${formatCurrency(totalVat)}</span>
                    <span><strong>Discount:</strong> ${formatCurrency(discountTotal)}</span>
                    <span class="ms-auto"><strong>Total:</strong> <span id="totalAmountField" class="fs-6 badge bg-primary">${formatCurrency(grandTotal)}</span></span>
                    <span class="badge bg-success">VAT Exclusive</span>
                </div>`;
            
            // Trigger change calculation for cash sales
            if (typeof calculateChange === 'function') {
                calculateChange();
            }
        }

        // Show loading state
        function showLoadingState() {
            const table = document.getElementById('invoicesTable');
            if (table) {
                const tbody = table.querySelector('tbody');
                if (tbody) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="8" class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2">Loading invoices...</p>
                            </td>
                        </tr>
                    `;
                }
            }
        }

        // Hide loading state
        function hideLoadingState() {
            // Loading state will be replaced by render functions
        }

        // Load data from database
        function loadData() {
            // Invoices will be loaded from database
            renderInvoices();
            updateStatistics();
        }

    // Statistics updater with null guards
    function updateStatistics(stats) {
        if(!stats) return;
        const map = {
            totalInvoices: stats.total_invoices ?? 0,
            paidInvoices: stats.paid_invoices ?? 0,
            unpaidInvoices: stats.unpaid_invoices ?? 0,
            overdueInvoices: stats.overdue_invoices ?? 0,
            totalAmount: formatCurrency(stats.total_revenue || stats.total_amount || 0),
            totalPaid: formatCurrency(stats.total_paid || stats.total_amount_paid || 0),
            outstandingAmount: formatCurrency(stats.total_outstanding || 0),
            avgPaymentTime: ((stats.average_payment_time_days ?? 0) + ' d'),
            highestInvoiceValue: formatCurrency(stats.highest_invoice_value || 0),
            customerWithMostInvoices: stats.customer_with_most_invoices || 'N/A'
        };
        Object.entries(map).forEach(([id,val])=>{ const el=document.getElementById(id); if(el) el.textContent = val; });
    }

        // Render invoices
        function renderInvoices(invoicesToRender = invoices) {
            const tbody = document.getElementById('invoicesTable'); // tbody has id
            if (!tbody) return;
            tbody.innerHTML = '';
            if (!invoicesToRender.length) {
                tbody.innerHTML = `<tr><td colspan="9" class="text-center text-muted">No invoices found</td></tr>`;
                // return; // commented out stray return
            }
            invoicesToRender.forEach(inv => {
                const balance = (inv.totalAmount || 0) - (inv.amountPaid || 0);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><input type="checkbox" class="form-check-input" data-id="${inv.id}"></td>
            <td><a href="#" onclick="viewInvoice('${inv.id}');return false;">${inv.invoiceNumber || ''}</a></td>
            <td>${inv.date || inv.invoice_date || ''}</td>
                    <td>${inv.customer}</td>
                    <td>${inv.dueDate}</td>
                    <td class="text-end">${formatCurrency(inv.totalAmount)}</td>
                    <td class="text-end">${formatCurrency(inv.amountPaid)}</td>
            <td><span class="badge ${inv.status==='paid'?'bg-success':inv.status==='overdue'?'bg-danger':'bg-warning'}">${inv.status}</span>${inv.payment_terms === 'cash' ? '<br><small class="badge bg-info">Cash Sale</small>' : ''}<br><small class="text-muted">${inv.updated_at?('upd '+inv.updated_at.split('T')[0]):''}</small></td>
                    <td>
                        <div class="btn-group">
                <button class="btn btn-sm btn-outline-primary" onclick="viewInvoice('${inv.id}')" title="View"><i class="bi bi-eye"></i></button>
                <button class="btn btn-sm btn-outline-info" onclick="showInvoicePreview('${inv.id}')" title="Preview A4"><i class="bi bi-file-earmark-pdf"></i></button>
                
                <!-- Print Dropdown Menu -->
                <div class="btn-group">
                    <button type="button" class="btn btn-sm btn-outline-dark dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false" title="Print">
                        <i class="bi bi-printer"></i>
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" onclick="quickPrintInvoice('${inv.id}')">
                            <i class="bi bi-printer"></i> Quick Print (Auto Format)
                        </a></li>
                        <li><a class="dropdown-item" href="#" onclick="printInvoiceAsPDF('${inv.id}')">
                            <i class="bi bi-file-pdf"></i> Print as PDF
                        </a></li>
                        <li><a class="dropdown-item" href="#" onclick="printInvoiceDotMatrix('${inv.id}')">
                            <i class="bi bi-grid-3x3"></i> Print Dot Matrix
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" onclick="downloadInvoicePDF('${inv.id}')">
                            <i class="bi bi-download"></i> Download PDF
                        </a></li>
                        <li><a class="dropdown-item" href="#" onclick="openInvoicePrintSettings()">
                            <i class="bi bi-gear"></i> Print Settings
                        </a></li>
                    </ul>
                </div>
                
                <button class="btn btn-sm btn-outline-secondary" onclick="openEditInvoice('${inv.id}')" title="Edit"><i class="bi bi-pencil"></i></button>
                <button class="btn btn-sm btn-outline-success" onclick="openRecordPayment('${inv.id}')" title="Record Payment"><i class="bi bi-cash-coin"></i></button>
                ${inv.payment_terms === 'cash' && inv.sale_id ? `<button class="btn btn-sm btn-outline-info" onclick="viewCashSaleReceipt('${inv.sale_id}', '${inv.receipt_number || 'N/A'}')" title="View Receipt"><i class="bi bi-receipt"></i></button>` : ''}
                <button class="btn btn-sm btn-outline-warning" onclick="createCreditNoteFromInvoice('${inv.id}')" title="Create Credit Note"><i class="bi bi-arrow-return-left"></i></button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteInvoice('${inv.id}')" title="Delete"><i class="bi bi-trash"></i></button>
                        </div>
                    </td>`;
                tbody.appendChild(row);
            });
        }

        // Filter invoices
        function filterInvoices() {
            fetchInvoices();
        }

        // Clear filters
        function clearFilters() {
            document.getElementById('customerFilter').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('fromDateFilter').value = '';
            document.getElementById('toDateFilter').value = '';
            document.getElementById('searchFilter').value = '';
            fetchInvoices();
        }

        // Filter by Outstanding invoices
        function filterByOutstanding() {
            // Clear other filters first
            document.getElementById('customerFilter').value = '';
            document.getElementById('fromDateFilter').value = '';
            document.getElementById('toDateFilter').value = '';
            document.getElementById('searchFilter').value = '';
            
            // Set status filter to outstanding
            document.getElementById('statusFilter').value = 'outstanding';
            
            // Add visual feedback to clicked card
            const clickedCard = event.target.closest('.stats-card');
            clickedCard.style.transform = 'scale(0.98)';
            setTimeout(() => {
                clickedCard.style.transform = '';
            }, 150);
            
            // Refresh the invoice list
            fetchInvoices();
            
            // Scroll to the table to show the filtered results
            document.getElementById('invoicesTable').scrollIntoView({ behavior: 'smooth' });
            
            
            // Show a brief visual confirmation
            console.log('Filtering by outstanding invoices');
        }

        // Filter by All Invoices (clear all filters)
        function filterByAllInvoices() {
            // Clear all filters
            document.getElementById('customerFilter').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('fromDateFilter').value = '';
            document.getElementById('toDateFilter').value = '';
            document.getElementById('searchFilter').value = '';
            
            // Add visual feedback to the Total Invoices card
            const totalInvoicesCards = document.querySelectorAll('.stats-card.clickable');
            // Find the Total Invoices card (first one)
            const totalInvoicesCard = totalInvoicesCards[0];
            totalInvoicesCard.style.transform = 'scale(0.98)';
            setTimeout(() => {
                totalInvoicesCard.style.transform = '';
            }, 150);
            
            // Refresh the invoice list
            fetchInvoices();
            
            // Scroll to the table to show the filtered results
            document.getElementById('invoicesTable').scrollIntoView({ behavior: 'smooth' });
            
            // Show a brief visual confirmation
            console.log('Showing all invoices');
        }

        // Filter by Paid Invoices
        function filterByPaidInvoices() {
            // Clear other filters first
            document.getElementById('customerFilter').value = '';
            document.getElementById('fromDateFilter').value = '';
            document.getElementById('toDateFilter').value = '';
            document.getElementById('searchFilter').value = '';
            
            // Set status filter to paid
            document.getElementById('statusFilter').value = 'paid';
            
            // Add visual feedback to clicked card
            const clickedCard = event.target.closest('.stats-card');
            clickedCard.style.transform = 'scale(0.98)';
            setTimeout(() => {
                clickedCard.style.transform = '';
            }, 150);
            
            // Refresh the invoice list
            fetchInvoices();
            
            // Scroll to the table to show the filtered results
            document.getElementById('invoicesTable').scrollIntoView({ behavior: 'smooth' });
            
            // Show a brief visual confirmation
            console.log('Filtering by paid invoices');
        }

        // Filter by Overdue Invoices
        function filterByOverdueInvoices() {
            // Clear other filters first
            document.getElementById('customerFilter').value = '';
            document.getElementById('fromDateFilter').value = '';
            document.getElementById('toDateFilter').value = '';
            document.getElementById('searchFilter').value = '';
            
            // Set status filter to overdue
            document.getElementById('statusFilter').value = 'overdue';
            
            // Add visual feedback to clicked card
            const clickedCard = event.target.closest('.stats-card');
            clickedCard.style.transform = 'scale(0.98)';
            setTimeout(() => {
                clickedCard.style.transform = '';
            }, 150);
            
            // Refresh the invoice list
            fetchInvoices();
            
            // Scroll to the table to show the filtered results
            document.getElementById('invoicesTable').scrollIntoView({ behavior: 'smooth' });
            
            // Show a brief visual confirmation
            console.log('Filtering by overdue invoices');
        }

        // View invoice
        async function viewInvoice(id) {
            try {
                console.log(`[DEBUG] viewInvoice called with ID: ${id}`);
                
                // Store the current invoice ID for printing and other actions
                currentInvoiceId = id;
                currentInvoiceForActions = { id: id };
                
                const response = await fetch(`${INVOICES_ENDPOINT}/${id}`);
                console.log(`[DEBUG] Invoice fetch response status: ${response.status}`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(`[DEBUG] Invoice fetch failed:`, errorText);
                    throw new Error(`Failed to load invoice (${response.status}): ${errorText}`);
                }
                const invoice = await response.json();
                console.log(`[DEBUG] Invoice data received:`, invoice);
                if(!invoice.invoice_date && invoice.date) invoice.invoice_date = invoice.date; // backward compat
                document.getElementById('detailInvoiceNumber').textContent = invoice.invoice_number + (invoice.updated_by ? ` (edited)` : '');
                document.getElementById('detailCustomerName').textContent = invoice.customer_name;
                document.getElementById('detailInvoiceDate').textContent = invoice.invoice_date;
                document.getElementById('detailDueDate').textContent = invoice.due_date;
                document.getElementById('detailStatus').textContent = invoice.status;
                const totalAmt = invoice.total_amount ?? invoice.total ?? 0;
                const paidAmt = invoice.amount_paid ?? 0;
                const dueAmt = invoice.amount_due ?? (totalAmt - paidAmt);
                document.getElementById('detailTotalAmount').textContent = formatCurrency(totalAmt);
                document.getElementById('detailAmountPaid').textContent = formatCurrency(paidAmt);
                document.getElementById('detailBalance').textContent = formatCurrency(dueAmt);
                const itemsBody = document.getElementById('invoiceItemsList');
                itemsBody.innerHTML = '';
                invoice.invoice_items.forEach(it => {
                    const tr = document.createElement('tr');
                    const qty = it.quantity || 0;
                    const unit = it.price || 0;
                    const providedTotal = it.total_amount ?? (qty * unit);
                    let vatAmount = it.vat_amount;
                    let vatRate = it.vat_rate || it.vatpercentage || it.vat || 0;
                    let net = qty * unit;
                    if(vatAmount == null){
                        if(vatRate && vatRate>0){
                            vatAmount = net * (vatRate/100);
                        } else if(it.total_ex_vat){
                            net = it.total_ex_vat;
                            vatAmount = providedTotal - net;
                        } else {
                            vatAmount = (it.total_vat_amount_per_line) ? it.total_vat_amount_per_line : 0;
                        }
                    }
                    if(providedTotal && vatAmount && vatAmount>0){
                        // ensure net consistent
                        const maybeNet = providedTotal - vatAmount;
                        if(Math.abs(maybeNet - net) > 0.01) net = maybeNet;
                    }
                    const totalDisplay = providedTotal || (net + vatAmount);
                    tr.innerHTML = `
                        <td>${it.product_name}</td>
                        <td class="text-end">${qty}</td>
                        <td class="text-end">${formatCurrency(unit)}</td>
                        <td class="text-end">${formatCurrency(net)}</td>
                        <td class="text-end">${formatCurrency(vatAmount || 0)}</td>
                        <td class="text-end">${formatCurrency(totalDisplay)}</td>`;
                    itemsBody.appendChild(tr);
                });
                new bootstrap.Modal(document.getElementById('invoiceDetailsModal')).show();
            } catch (e) {
                console.error(`[DEBUG] viewInvoice error for ID ${id}:`, e);
                const errorMessage = e.message || 'Unknown error';
                if (window.modernUI) {
                    window.modernUI.showNotification(`Failed to load invoice: ${errorMessage}`, 'error');
                } else {
                    alert(`Failed to load invoice: ${errorMessage}`);
                }
            }
        }

        // Edit invoice
        function editInvoice(id) {
            if (window.modernUI) {
                window.modernUI.showNotification('Edit functionality will be implemented in the next phase', 'info');
            } else {
                alert(`Editing invoice ${id}...`);
            }
        }

        // Delete invoice
        function deleteInvoice(id) {
            if (confirm('Are you sure you want to delete this invoice?')) {
                if (window.modernUI) {
                    window.modernUI.showNotification('Delete functionality will be implemented in the next phase', 'info');
                } else {
                    alert(`Deleting invoice ${id}...`);
                }
            }
        }

        // Create invoice
        async function createInvoice() {
            const form = document.getElementById('addInvoiceForm');
            
            // Temporarily enable disabled fields for validation
            const disabledFields = form.querySelectorAll('input:disabled, select:disabled');
            disabledFields.forEach(field => field.disabled = false);
            
            const isValid = form.checkValidity();
            
            // Re-disable the fields
            disabledFields.forEach(field => field.disabled = true);
            
            if (!isValid) { 
                form.reportValidity(); 
                return; 
            }
            
            if (!defaultBranchId) {
                if (window.modernUI) window.modernUI.showNotification('No branch available', 'error');
                return;
            }
            try {
                // Validate customer information
                const customerMode = document.querySelector('input[name="customerMode"]:checked')?.value;
                let customerId = null;
                let newCustomerData = null;

                console.log('Customer mode:', customerMode);

                if (customerMode === 'existing') {
                    customerId = document.getElementById('invoiceCustomer').value;
                    console.log('Selected customer ID:', customerId);
                    
                    if (!customerId) {
                        // Show a more helpful message for cash sales
                        const isCashSale = document.getElementById('paymentTermsType').value === 'cash';
                        if (isCashSale) {
                            if (window.modernUI) {
                                window.modernUI.showNotification('For cash sales, please select a customer or switch to "New Customer" mode to add customer details', 'warning');
                            }
                        } else {
                            if (window.modernUI) window.modernUI.showNotification('Please select a customer', 'warning');
                        }
                        return;
                    }
                    
                    // Handle walk-in customer for cash sales
                    if (customerId === 'walk-in') {
                        customerId = null; // Clear customer ID
                        newCustomerData = {
                            name: 'Walk-in Customer',
                            phone: '',
                            email: '',
                            vat_reg_number: '',
                            address: ''
                        };
                        console.log('Using walk-in customer data:', newCustomerData);
                    }
                } else if (customerMode === 'new') {
                    const newCustomerName = document.getElementById('newCustomerName').value.trim();
                    console.log('New customer name:', newCustomerName);
                    if (!newCustomerName) {
                        if (window.modernUI) window.modernUI.showNotification('Please enter customer name', 'warning');
                        return;
                    }
                    newCustomerData = {
                        name: newCustomerName,
                        phone: document.getElementById('newCustomerPhone').value.trim(),
                        email: document.getElementById('newCustomerEmail').value.trim(),
                        vat_reg_number: document.getElementById('newCustomerVAT').value.trim(),
                        address: document.getElementById('newCustomerAddress').value.trim()
                    };
                    console.log('New customer data:', newCustomerData);
                } else {
                    if (window.modernUI) window.modernUI.showNotification('Please select customer mode', 'warning');
                    return;
                }

                console.log('Final customer values - ID:', customerId, 'New Data:', newCustomerData);

                // Validate invoice items
                const invoiceItems = [];
                document.querySelectorAll('#invoiceItems .invoice-item').forEach(row => {
                    const productId = row.querySelector('select[name="product[]"]').value;
                    const qty = parseFloat(row.querySelector('input[name="quantity[]"]').value || '0');
                    const price = parseFloat(row.querySelector('input[name="price[]"]').value || '0');
                    const vat = parseFloat(row.querySelector('input[name="vat[]"]').value || '0');
                    if (productId && qty > 0) {
                        invoiceItems.push({
                            product_id: productId,
                            quantity: qty,
                            price: price,
                            vat_rate: vat,
                            discount_percentage: 0.0
                        });
                    }
                });
                if (!invoiceItems.length) {
                    if (window.modernUI) window.modernUI.showNotification('Add at least one item', 'warning');
                    return;
                }

                // Determine payment terms
                const paymentTermsType = document.getElementById('paymentTermsType').value;
                const isCashSale = paymentTermsType === 'cash';
                const paymentTerms = isCashSale ? 0 : parseInt(document.getElementById('paymentTerms').value || '30');

                // Prepare invoice data
                const invoiceData = {
                    branch_id: defaultBranchId,
                    invoice_items: invoiceItems,
                    due_date: document.getElementById('dueDate').value || null,
                    payment_terms: paymentTerms,
                    discount_percentage: parseFloat(document.getElementById('discountPercentage').value || '0'),
                    notes: document.getElementById('invoiceNotes').value || '',
                    is_cash_sale: isCashSale
                };

                // Add customer data - either existing customer ID or new customer data
                console.log('Debug - customerId:', customerId);
                console.log('Debug - newCustomerData:', newCustomerData);
                console.log('Debug - customerId truthy:', !!customerId);
                console.log('Debug - newCustomerData truthy:', !!newCustomerData);
                console.log('Debug - typeof newCustomerData:', typeof newCustomerData);
                
                if (customerId) {
                    invoiceData.customer_id = customerId;
                    console.log('Debug - Added customer_id to invoiceData');
                } else if (newCustomerData && typeof newCustomerData === 'object' && newCustomerData.name) {
                    invoiceData.new_customer_data = newCustomerData;
                    console.log('Debug - Added new_customer_data to invoiceData');
                } else {
                    console.log('Debug - No customer data added!');
                    console.log('Debug - newCustomerData details:', JSON.stringify(newCustomerData));
                }

                // Add cash payment data if it's a cash sale
                if (isCashSale) {
                    const amountTendered = parseFloat(document.getElementById('amountTendered').value || '0');
                    const changeDue = parseFloat(document.getElementById('changeDue').value || '0');
                    
                    invoiceData.cash_payment = {
                        payment_method: document.getElementById('cashPaymentMethod').value,
                        payment_reference: document.getElementById('paymentReference').value.trim(),
                        payment_date: document.getElementById('invoiceDate').value,
                        amount_tendered: amountTendered,
                        change_due: changeDue
                    };
                }

                console.log('Invoice data being sent to API:', invoiceData);
                console.log('Invoice data JSON stringify:', JSON.stringify(invoiceData, null, 2));
                console.log('[CACHE-CHECK] Frontend code updated at 2025-09-09 20:30');
                console.log('[FIXED] Cash payment accounting integration completed');

                const response = await window.fetch(INVOICES_ENDPOINT + '/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(invoiceData)
                });
                if (!response.ok) {
                    // Extract error details
                    let detail = 'Invoice creation failed';
                    try {
                        const txt = await response.text();
                        const j = JSON.parse(txt);
                        detail = j.detail || j.message || txt;
                    } catch {};
                    // If 400 with credit-limit too low, show custom warning
                    if (response.status === 400 && detail.toLowerCase().includes('insufficient credit limit')) {
                        // Show visible alert and inline warning in modal
                        alert('Invoice cannot be processed because of insufficient credit balance');
                        displayModalWarning('Cannot process invoice: insufficient credit balance');
                        return;
                    }
                    if (window.modernUI) {
                        showNotification(detail, 'error');
                    } else {
                        alert(detail);
                    }
                    return;
                }
                const created = await response.json();
                
                let successMessage = isCashSale ? 'Cash sale invoice created and payment recorded' : 'Invoice created';
                
                // Add receipt information to success message if available
                if (isCashSale && created.receipt_generated && created.receipt_number) {
                    successMessage += ` | Receipt: ${created.receipt_number}`;
                    
                    // Show receipt viewing option for cash sales
                    showCashSaleReceiptOptions(created);
                }
                
                if (window.modernUI) window.modernUI.showNotification(successMessage, 'success');

                // Auto print handling (PDF or text)
                if (created.auto_print && created.print_content_b64) {
                    try {
                        const bytes = atob(created.print_content_b64);
                        const arr = new Uint8Array(bytes.length);
                        for (let i=0;i<bytes.length;i++) arr[i]=bytes.charCodeAt(i);
                        const blob = new Blob([arr], {type: created.print_format==='pdf'?'application/pdf':'text/plain'});
                        const url = URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = created.print_filename || 'invoice';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        URL.revokeObjectURL(url);
                        lastPrintPayload = created; // store for retry
                        document.getElementById('retryPrintBtn').disabled = false;
                    } catch(printErr){ console.warn('Auto print failed', printErr); }
                }
                form.reset();
                // Reset form to default state
                document.getElementById('existingCustomer').checked = true;
                document.getElementById('paymentTermsType').value = 'credit';
                handleCustomerMode();
                handlePaymentTerms();
                bootstrap.Modal.getInstance(document.getElementById('addInvoiceModal')).hide();
                await fetchInvoices();
            } catch (e) {
                console.error(e);
                const msg = e.message || 'Failed to create invoice';
                // Credit limit errors should be warnings
                if (msg.toLowerCase().includes('insufficient credit limit')) {
                    showNotification(msg, 'warning');
                } else {
                    if (window.modernUI) {
                        window.modernUI.showNotification(msg, 'error');
                    } else {
                        alert(msg);
                    }
                }
            }
        }

        // Edit invoice modal (lightweight inline approach)
        async function openEditInvoice(id) {
            const inv = invoices.find(i=>i.id===id);
            if(!inv){await fetchInvoices();return openEditInvoice(id);}            
            const newDue = prompt('New Due Date (YYYY-MM-DD)', inv.dueDate || '');
            if(newDue===null) return;
            const newNotes = prompt('Notes (leave blank to keep)', inv.notes || '');
            try {
                const payload = { };
                if(newDue) payload.due_date = newDue;
                if(newNotes!==null) payload.notes = newNotes;
                const resp = await fetch(`${INVOICES_ENDPOINT}/${id}`, {method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
                if(!resp.ok) throw new Error(await resp.text());
                if(window.modernUI) window.modernUI.showNotification('Invoice updated','success');
                await fetchInvoices();
            } catch(err){ console.error(err); if(window.modernUI) window.modernUI.showNotification('Update failed','error'); }
        }

        async function deleteInvoice(id){
            if(!confirm('Delete this invoice?')) return;
            try {
                const resp = await fetch(`${INVOICES_ENDPOINT}/${id}`, {method:'DELETE'});
                if(!resp.ok) throw new Error(await resp.text());
                if(window.modernUI) window.modernUI.showNotification('Invoice deleted','success');
                await fetchInvoices();
            } catch(e){ console.error(e); if(window.modernUI) window.modernUI.showNotification('Delete failed','error'); }
        }

        // Payment recording
        async function openRecordPayment(id){
            const amount = prompt('Payment amount');
            if(amount===null) return;
            const method = prompt('Payment method (cash/bank/mobile)', 'cash') || 'cash';
            const ref = prompt('Reference (optional)','');
            try {
                const resp = await fetch(`${INVOICES_ENDPOINT}/${id}/payment`, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({amount: parseFloat(amount), payment_method: method, reference: ref})});
                if(!resp.ok) throw new Error(await resp.text());
                if(window.modernUI) window.modernUI.showNotification('Payment recorded','success');
                await fetchInvoices();
            } catch(e){ console.error(e); if(window.modernUI) window.modernUI.showNotification('Payment failed','error'); }
        }

        // Save draft
        function saveDraft() {
            if (window.modernUI) {
                window.modernUI.showNotification('Draft saved successfully', 'success');
            } else {
                alert('Draft saved successfully!');
            }
        }

        // Export invoices
        function exportInvoices() {
            // Create CSV content
            const headers = ['Invoice Number', 'Customer', 'Date', 'Due Date', 'Status', 'Total Amount', 'Amount Paid', 'Balance'];
            const csvContent = [
                headers.join(','),
                ...invoices.map(invoice => [
                    invoice.invoiceNumber,
                    invoice.customer,
                    invoice.date,
                    invoice.dueDate,
                    invoice.status,
                    invoice.totalAmount,
                    invoice.amountPaid,
                    invoice.totalAmount - invoice.amountPaid
                ].join(','))
            ].join('\n');

            // Create and download file
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `invoices_export_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            if (window.modernUI) {
                window.modernUI.showNotification('Invoices exported successfully', 'success');
            }
        }

        // Send invoices
        function sendInvoices() {
            if (window.modernUI) {
                window.modernUI.showNotification('Send functionality will be implemented in the next phase', 'info');
            } else {
                alert('Sending selected invoices...');
            }
        }

        // Print invoice using configured printer settings
        async function printInvoice() {
            const invoiceId = currentInvoiceId;
            if (!invoiceId) {
                if (window.modernUI) {
                    window.modernUI.showNotification('No invoice selected for printing', 'error');
                } else {
                    alert('No invoice selected for printing');
                }
                return;
            }

            try {
                // Show loading state
                if (window.modernUI) {
                    window.modernUI.showNotification('Preparing invoice for printing...', 'info');
                }

                // Use the existing print endpoint that respects printer settings
                // Add cache-busting parameter to prevent browser caching of error responses
                const timestamp = new Date().getTime();
                const response = await fetch(`${API_BASE}/invoices/${invoiceId}/print?_=${timestamp}`, {
                    method: 'GET',
                    cache: 'no-cache',
                    headers: {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    }
                });
                
                if (!response.ok) {
                    // Get detailed error message from response
                    let errorMessage = `HTTP ${response.status} - ${response.statusText}`;
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.message || errorData.detail || errorMessage;
                    } catch (e) {
                        // If response is not JSON, use text content
                        try {
                            const errorText = await response.text();
                            if (errorText) {
                                errorMessage = errorText;
                            }
                        } catch (e2) {
                            // Keep original error message
                        }
                    }
                    throw new Error(`Failed to generate invoice: ${errorMessage}`);
                }

                // Get content type to determine format
                const contentType = response.headers.get('content-type');
                const contentDisposition = response.headers.get('content-disposition');
                
                // Extract filename from Content-Disposition header
                let filename = 'invoice';
                if (contentDisposition) {
                    const filenameMatch = contentDisposition.match(/filename="([^"]+)"/);
                    if (filenameMatch) {
                        filename = filenameMatch[1];
                    }
                }

                if (contentType.includes('application/pdf')) {
                    // Handle PDF - trigger download and open print dialog
                    const blob = await response.blob();
                    const url = URL.createObjectURL(blob);
                    
                    // For PDF, open in new tab with print dialog
                    const printWindow = window.open(url, '_blank');
                    printWindow.onload = function() {
                        printWindow.print();
                    };
                    
                    // Also trigger download
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = filename;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    if (window.modernUI) {
                        window.modernUI.showNotification('Invoice sent to printer (PDF)', 'success');
                    }
                    
                    // Clean up
                    setTimeout(() => URL.revokeObjectURL(url), 1000);
                    
                } else if (contentType.includes('text/plain')) {
                    // Handle dot matrix text format
                    const text = await response.text();
                    
                    // Create a new window for text printing
                    const printWindow = window.open('', '_blank');
                    printWindow.document.write(`
                        <html>
                        <head>
                            <title>Invoice - ${filename}</title>
                            <style>
                                body { 
                                    font-family: 'Courier New', monospace; 
                                    font-size: 12px; 
                                    line-height: 1.2; 
                                    white-space: pre-wrap; 
                                    margin: 0; 
                                    padding: 10px;
                                    background: white;
                                }
                                @media print {
                                    body { margin: 0; padding: 5px; font-size: 10px; }
                                }
                            </style>
                        </head>
                        <body>
    ${text}</body>
                        </html>
                    `);
                    printWindow.document.close();
                    
                    // Wait a moment then print
                    setTimeout(() => {
                        printWindow.print();
                    }, 500);
                    
                    if (window.modernUI) {
                        window.modernUI.showNotification('Invoice sent to printer (Dot Matrix)', 'success');
                    }
                }

            } catch (error) {
                console.error('Error printing invoice:', error);
                if (window.modernUI) {
                    window.modernUI.showNotification(`Failed to print invoice: ${error.message}`, 'error');
                } else {
                    alert(`Failed to print invoice: ${error.message}`);
                }
            }
        }

        // Send invoice
        function sendInvoice() {
            if (window.modernUI) {
                window.modernUI.showNotification('Send functionality will be implemented in the next phase', 'info');
            } else {
                alert('Sending invoice...');
            }
        }

        // Add invoice item
    function addInvoiceItem() {
            const container = document.getElementById('invoiceItems');
            const newItem = document.createElement('div');
            newItem.className = 'row mb-2 invoice-item';
            newItem.innerHTML = `
        <div class="col-md-3">
                    <select class="form-select" name="product[]" required></select>
                </div>
        <div class="col-md-1"><input type="number" class="form-control" name="quantity[]" placeholder="Qty" value="1" required></div>
        <div class="col-md-2"><input type="number" class="form-control" name="price[]" placeholder="Unit" step="0.01" required></div>
        <div class="col-md-1 d-flex align-items-center"><span class="small text-muted line-net" data-line-net="0">0.00</span></div>
        <div class="col-md-1"><input type="number" class="form-control" name="vat[]" placeholder="VAT%" step="0.01" value="0"></div>
        <div class="col-md-1 d-flex align-items-center"><span class="small text-muted line-vat" data-line-vat="0">0.00</span></div>
        <div class="col-md-1 d-flex align-items-center"><span class="fw-semibold small line-total" data-line-total="0">0.00</span></div>
        <div class="col-md-1"><button type="button" class="btn btn-outline-danger btn-sm w-100" onclick="removeInvoiceItem(this)"><i class="bi bi-trash"></i></button></div>`;
            container.appendChild(newItem);
            
            // Refresh products and setup event listeners for the new item
            refreshProductSelects();
            
            // Explicitly setup event listeners for this new row
            setupInvoiceItemEvents(newItem);
        }

        // Remove invoice item with undo support
        function removeInvoiceItem(button) {
            const row = button.closest('.invoice-item');
            if(!row) return;
            const snapshot = { html: row.outerHTML, index: Array.from(row.parentNode.children).indexOf(row) };
            removedItemsStack.push(snapshot);
            row.remove();
            recalcInvoiceTotals();
            showUndoRemoval();
        }

        function showUndoRemoval(){
            let bar = document.getElementById('undoRemovalBar');
            if(!bar){
                bar = document.createElement('div');
                bar.id='undoRemovalBar';
                bar.className='alert alert-warning py-2 px-3 d-flex justify-content-between align-items-center position-sticky top-0';
                bar.innerHTML = `<span>Item removed.</span><div class="d-flex gap-2"><button class="btn btn-sm btn-outline-secondary" type="button" onclick="undoLastRemoval()"><i class='bi bi-arrow-counterclockwise'></i> Undo</button><button class="btn btn-sm btn-outline-danger" type="button" onclick="clearRemovalStack()">Dismiss</button></div>`;
                const modalBody = document.querySelector('#addInvoiceModal .modal-body');
                if(modalBody) modalBody.prepend(bar);
            }
            bar.style.display='flex';
        }

        function undoLastRemoval(){
            const snapshot = removedItemsStack.pop();
            if(!snapshot) return;
            const container = document.getElementById('invoiceItems');
            const temp = document.createElement('div');
            temp.innerHTML = snapshot.html.trim();
            const restored = temp.firstElementChild;
            if(snapshot.index >= container.children.length) container.appendChild(restored); else container.insertBefore(restored, container.children[snapshot.index]);
            refreshProductSelects();
            setupInvoiceItemEvents(restored);
            recalcInvoiceTotals();
            if(!removedItemsStack.length) hideUndoRemoval();
        }

        function clearRemovalStack(){ removedItemsStack = []; hideUndoRemoval(); }
        function hideUndoRemoval(){ const bar=document.getElementById('undoRemovalBar'); if(bar) bar.style.display='none'; }

        // Customer mode switching
        function handleCustomerMode() {
            const existingSection = document.getElementById('existingCustomerSection');
            const newSection = document.getElementById('newCustomerSection');
            const existingRadio = document.getElementById('existingCustomer');
            const newRadio = document.getElementById('newCustomer');

            if (existingRadio.checked) {
                existingSection.style.display = 'block';
                newSection.style.display = 'none';
                // Make existing customer selection required
                document.getElementById('invoiceCustomer').setAttribute('required', 'required');
                // Remove required from new customer fields
                ['newCustomerName'].forEach(id => {
                    const field = document.getElementById(id);
                    if (field) field.removeAttribute('required');
                });
            } else if (newRadio.checked) {
                existingSection.style.display = 'none';
                newSection.style.display = 'block';
                // Remove required from existing customer selection
                document.getElementById('invoiceCustomer').removeAttribute('required');
                // Make new customer name required
                document.getElementById('newCustomerName').setAttribute('required', 'required');
            }
        }

        // Payment terms switching
        function handlePaymentTerms() {
            const paymentTermsType = document.getElementById('paymentTermsType').value;
            const creditSection = document.getElementById('creditTermsSection');
            const cashSection = document.getElementById('cashSaleSection');
            const paymentTermsInput = document.getElementById('paymentTerms');

            if (paymentTermsType === 'cash') {
                creditSection.style.display = 'none';
                cashSection.style.display = 'block';
                // Set due date to today for cash sales
                document.getElementById('dueDate').value = new Date().toISOString().split('T')[0];
                paymentTermsInput.value = '0';
                paymentTermsInput.disabled = true;
                // Make payment method and amount tendered required for cash sales
                document.getElementById('cashPaymentMethod').setAttribute('required', 'required');
                document.getElementById('amountTendered').setAttribute('required', 'required');
                
                // Calculate change when switching to cash mode
                setTimeout(() => calculateChange(), 100);
            } else {
                creditSection.style.display = 'block';
                cashSection.style.display = 'none';
                paymentTermsInput.disabled = false;
                // Clear due date and reset payment terms for credit
                document.getElementById('dueDate').value = '';
                document.getElementById('paymentTerms').value = '30';
                // Remove required from cash payment fields
                document.getElementById('cashPaymentMethod').removeAttribute('required');
                document.getElementById('amountTendered').removeAttribute('required');
            }
        }

        // Auto-calculate due date based on payment terms
        function calculateDueDate() {
            const invoiceDate = document.getElementById('invoiceDate').value;
            const paymentTerms = parseInt(document.getElementById('paymentTerms').value) || 30;
            
            if (invoiceDate && paymentTerms > 0) {
                const date = new Date(invoiceDate);
                date.setDate(date.getDate() + paymentTerms);
                document.getElementById('dueDate').value = date.toISOString().split('T')[0];
            }
        }

        // Calculate change for cash sales
        function calculateChange() {
            const amountTenderedElement = document.getElementById('amountTendered');
            const changeDueElement = document.getElementById('changeDue');
            
            if (!amountTenderedElement || !changeDueElement) return;
            
            // Use the stored grand total instead of parsing formatted text
            const totalAmount = window.currentGrandTotal || 0;
            
            const amountTenderedVal = amountTenderedElement.value || '0';
            const amountTendered = isNaN(parseFloat(amountTenderedVal)) ? 0 : parseFloat(amountTenderedVal);
            
            const changeDue = Math.max(0, amountTendered - totalAmount);
            
            changeDueElement.value = changeDue.toFixed(2);
            
            // Validate minimum amount
            if (amountTendered > 0 && amountTendered < totalAmount) {
                amountTenderedElement.setCustomValidity('Amount tendered must be at least the total amount');
            } else {
                amountTenderedElement.setCustomValidity('');
            }
        }

        // Update change when amount tendered changes
        function handleAmountTenderedChange() {
            calculateChange();
        }

        // Update change when invoice totals change
        function onInvoiceTotalsUpdate() {
            calculateChange();
        }

        // Add event listeners
    ['customerFilter','statusFilter','fromDateFilter','toDateFilter','searchFilter','saveInvoiceBtn'].forEach(id=>{
        const el = document.getElementById(id);
        if(!el) return;
        if(id==='saveInvoiceBtn') el.addEventListener('click', createInvoice);
        else if(id==='searchFilter') el.addEventListener('input', ()=>fetchInvoices());
        else el.addEventListener('change', ()=>fetchInvoices());
    });

        // Add event listeners for new functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Customer mode radio buttons
            document.getElementById('existingCustomer').addEventListener('change', handleCustomerMode);
            document.getElementById('newCustomer').addEventListener('change', handleCustomerMode);
            
            // Payment terms dropdown
            document.getElementById('paymentTermsType').addEventListener('change', handlePaymentTerms);
            
            // Payment terms input for auto-calculating due date
            document.getElementById('paymentTerms').addEventListener('change', calculateDueDate);
            document.getElementById('invoiceDate').addEventListener('change', calculateDueDate);
            
            // Amount tendered change calculation
            const amountTenderedField = document.getElementById('amountTendered');
            if (amountTenderedField) {
                amountTenderedField.addEventListener('input', handleAmountTenderedChange);
                amountTenderedField.addEventListener('change', handleAmountTenderedChange);
            }
            
            // Set default invoice date to today
            document.getElementById('invoiceDate').value = new Date().toISOString().split('T')[0];
        });

        // Fix modal accessibility issues
        document.getElementById('addInvoiceModal').addEventListener('shown.bs.modal', function () {
            // Remove aria-hidden to fix accessibility warning
            this.removeAttribute('aria-hidden');
        });
        
        document.getElementById('addInvoiceModal').addEventListener('hidden.bs.modal', function () {
            // Restore aria-hidden when modal is closed
            this.setAttribute('aria-hidden', 'true');
        });

        // Clear invoice variables when invoice details modal is closed
        document.getElementById('invoiceDetailsModal').addEventListener('hidden.bs.modal', function () {
            currentInvoiceId = null;
            currentInvoiceForActions = null;
        });

        // Initialize data loading
        async function initializeData() {
            try {
                await loadSettings();
                await ensureInvoiceDesignerConfig();
                 // Override with invoice-specific settings if available
                try {
                    const sResp = await fetch(INVOICE_SETTINGS_ENDPOINT);
                    if (sResp.ok) {
                        const sJson = await sResp.json();
                        if (sJson.settings) {
                            if (sJson.settings.currency_symbol) currencySymbol = sJson.settings.currency_symbol;
                            if (sJson.settings.currency) currencyCode = sJson.settings.currency;
                            if (sJson.settings.default_vat_rate !== undefined && sJson.settings.default_vat_rate !== null) {
                                const parsedVat = parseFloat(sJson.settings.default_vat_rate);
                                if(!isNaN(parsedVat)) defaultVatRate = parsedVat;
                            }
                            if (sJson.settings.auto_print) {
                                document.getElementById('autoPrintToggle').checked = String(sJson.settings.auto_print).toLowerCase()==='true';
                            }
                        }
                    }
                } catch(e){ console.warn('Invoice settings fetch failed', e); }
                try {
                    await fetchBranches();
                    await fetchCustomers();
                    await fetchProducts();
                } catch (initErr) {
                    console.error('Error fetching initial data:', initErr);
                }
                await fetchInvoices();
                 // Bind discount inputs for dynamic totals once
                 ['discountAmount','discountPercentage'].forEach(id=>{
                     const el=document.getElementById(id); if(el && !el.dataset.calcBound){ el.addEventListener('input', recalcInvoiceTotals); el.dataset.calcBound='1'; }
                 });
                recalcInvoiceTotals();
                // VAT toggle has been removed - all sales use VAT exclusive mode
            } catch (e) {
                console.error('Init error', e);
                invoices = []; renderInvoices();
            }
        }

        // Toggle auto print
        document.addEventListener('change', async (e)=>{
            if(e.target.id==='autoPrintToggle'){
                try {
                    const enabled = e.target.checked;
                    const resp = await fetch(`${INVOICE_TOGGLE_ENDPOINT}?enabled=${enabled}`, {method:'POST'});
                    if(!resp.ok) throw new Error('Toggle failed');
                    if(window.modernUI) window.modernUI.showNotification(`Auto print ${enabled?'enabled':'disabled'}`,'success');
                } catch(err){
                    console.error(err);
                    if(window.modernUI) window.modernUI.showNotification('Failed to update auto print','error');
                }
            }
        });

        // Retry last print
        document.getElementById('retryPrintBtn').addEventListener('click', ()=>{
            if(!lastPrintPayload) return;
            try {
                const bytes = atob(lastPrintPayload.print_content_b64);
                const arr = new Uint8Array(bytes.length);
                for(let i=0;i<bytes.length;i++) arr[i]=bytes.charCodeAt(i);
                const blob = new Blob([arr], {type: lastPrintPayload.print_format==='pdf'?'application/pdf':'text/plain'});
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href=url; link.download=lastPrintPayload.print_filename || 'invoice';
                document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(url);
            } catch(e){ console.error(e); if(window.modernUI) window.modernUI.showNotification('Retry print failed','error'); }
        });

        // A4 Invoice Preview Functions
        let appSettings = {}; // Store app settings for invoice formatting

        async function showInvoicePreview(invoiceId) {
            // Show A4 invoice preview modal
            try {
                // Load app settings if not already loaded
                if (!appSettings.company_name) {
                    await loadAppSettings();
                }

                // Find the invoice
                const invoice = invoices.find(inv => inv.id === invoiceId);
                if (!invoice) {
                    if(window.modernUI) window.modernUI.showNotification('Invoice not found', 'error');
                    return;
                }

                // Get full invoice details from API
                console.log(`[DEBUG] showInvoicePreview fetching invoice ID: ${invoiceId}`);
                const response = await fetch(`${INVOICES_ENDPOINT}/${invoiceId}`);
                console.log(`[DEBUG] showInvoicePreview response status: ${response.status}`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(`[DEBUG] showInvoicePreview fetch failed:`, errorText);
                    throw new Error(`Failed to load invoice details (${response.status}): ${errorText}`);
                }
                const invoiceData = await response.json();
                console.log(`[DEBUG] showInvoicePreview invoice data:`, invoiceData);

                // Populate the A4 preview
                await populateA4Preview(invoiceData);

                // Apply format settings
                applyFormatSettings();

                // Show the modal
                new bootstrap.Modal(document.getElementById('invoicePreviewModal')).show();

            } catch (error) {
                console.error(`[DEBUG] showInvoicePreview error for ID ${invoiceId}:`, error);
                const errorMessage = error.message || 'Unknown error';
                if(window.modernUI) {
                    window.modernUI.showNotification(`Failed to load invoice preview: ${errorMessage}`, 'error');
                } else {
                    alert(`Failed to load invoice preview: ${errorMessage}`);
                }
            }
        }

        async function loadAppSettings() {
            // Load app settings for invoice formatting
            try {
                const response = await fetch(`${API_BASE}/app-setting/`);
                if (response.ok) {
                    const result = await response.json();
                    appSettings = result.data || {};
                } else {
                    // Use defaults if settings not available
                    appSettings = {
                        company_name: 'Your Company Name',
                        address: '123 Business St, City, Country',
                        phone: '+123 456 7890',
                        email: 'info@company.com',
                        website: 'www.company.com',
                        vat_registration_number: '',
                        invoice_footer_text: 'Thank you for your business!',
                        invoice_terms_conditions: 'Payment due within 30 days.'
                    };
                }
                
                // Notify the logo manager of updated settings
                if (window.DocumentLogoManager) {
                    window.DocumentLogoManager.applyLogoToDocument('companyLogo', 'invoice', {
                        maxWidth: '200px',
                        maxHeight: '100px'
                    });
                } else {
                    // Fallback to original method if logo manager not available
                    const logoEl = document.getElementById('companyLogo');
                    if (appSettings.company_logo_base64 && logoEl) {
                        logoEl.src = appSettings.company_logo_base64;
                        logoEl.classList.remove('d-none');
                    }
                }

                if (typeof notifyAppSettingsLoaded === 'function') {
                    notifyAppSettingsLoaded(appSettings);
                }

                // Notify that settings have been loaded
                if (window.modernUI) {
                    window.modernUI.showNotification('App settings loaded', 'success');
                }
                
            } catch (error) {
                console.error('Error loading app settings:', error);
                appSettings = {};
            }
        }

        function parseNumber(value, fallback = 0) {
            const parsed = Number(value);
            return Number.isFinite(parsed) ? parsed : fallback;
        }

        function escapeHtml(str = '') {
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        function formatMultilineText(str = '') {
            return escapeHtml(str).replace(/\r?\n/g, '<br>');
        }

        function isSettingEnabled(settingKey, fallback = true) {
            const raw = appSettings?.[settingKey];
            if (raw === undefined || raw === null) {
                return fallback;
            }
            if (typeof raw === 'string') {
                return raw.toLowerCase() === 'true' || raw === '1';
            }
            return Boolean(raw);
        }

        async function ensureInvoiceDesignerConfig(force = false) {
            if (force) {
                invoiceDesignerConfigLoaded = false;
            }
            if (invoiceDesignerConfigLoaded) {
                return invoiceDesignerConfig;
            }
            try {
                const response = await fetch(INVOICE_LAYOUT_ENDPOINT);
                if (response.ok) {
                    invoiceDesignerConfig = await response.json();
                } else {
                    invoiceDesignerConfig = null;
                }
            } catch (error) {
                console.error('Failed to load invoice designer layout:', error);
                invoiceDesignerConfig = null;
            }
            invoiceDesignerConfigLoaded = true;
            return invoiceDesignerConfig;
        }

        function buildDesignerFieldContent(item, invoice) {
            const field = item.field;
            const formData = invoiceDesignerConfig?.form_data || {};
            const savedContent = item.content;

            switch (field) {
                case 'companyLogo': {
                    if (!isSettingEnabled('invoice_show_logo')) {
                        return '';
                    }

                    if (window.DocumentLogoManager) {
                        const logoElement = window.DocumentLogoManager.createLogoElement('invoice', {
                            className: 'designer-preview-logo',
                            maxWidth: '100%',
                            maxHeight: '100%'
                        });
                        if (logoElement) {
                            return logoElement.outerHTML;
                        }
                    }

                    let logoSrc = appSettings.company_logo_base64 || appSettings.company_logo_url;
                    if (!logoSrc && savedContent && typeof savedContent === 'object') {
                        logoSrc = savedContent.logo || savedContent.src;
                    }

                    if (logoSrc) {
                        return `<img src="${logoSrc}" alt="Company Logo" class="designer-preview-logo">`;
                    }

                    return `<div class="text-muted small">Company Logo</div>`;
                }
                case 'companyName': {
                    const name = appSettings.company_name || formData.company_name || (typeof savedContent === 'string' ? savedContent : 'Your Company Name');
                    return `<div class="fw-bold fs-4">${escapeHtml(name)}</div>`;
                }
                case 'companyAddress': {
                    const lines = [];
                    if (isSettingEnabled('invoice_show_company_address') && appSettings.address) {
                        lines.push(formatMultilineText(appSettings.address));
                    }
                    if (isSettingEnabled('invoice_show_company_phone') && appSettings.phone) {
                        lines.push(`Phone: ${escapeHtml(appSettings.phone)}`);
                    }
                    if (isSettingEnabled('invoice_show_company_email') && appSettings.email) {
                        lines.push(`Email: ${escapeHtml(appSettings.email)}`);
                    }
                    if (isSettingEnabled('invoice_show_company_website') && appSettings.website) {
                        lines.push(escapeHtml(appSettings.website));
                    }
                    if (isSettingEnabled('invoice_show_vat_number') && appSettings.vat_registration_number) {
                        lines.push(`VAT: ${escapeHtml(appSettings.vat_registration_number)}`);
                    }
                    if (!lines.length && typeof savedContent === 'string') {
                        lines.push(formatMultilineText(savedContent));
                    }
                    return `<div class="small text-muted">${lines.join('<br>')}</div>`;
                }
                case 'invoiceTitle': {
                    const title = (typeof savedContent === 'string' && savedContent.trim())
                        ? savedContent.trim()
                        : (appSettings.invoice_title_text || 'INVOICE');
                    return `<div class="fw-bold fs-2">${escapeHtml(title)}</div>`;
                }
                case 'invoiceDetails': {
                    const rows = [];
                    rows.push({ label: 'Invoice #', value: invoice.invoice_number });
                    rows.push({ label: 'Date', value: invoice.invoice_date });
                    if (isSettingEnabled('invoice_show_due_date') && invoice.due_date) {
                        rows.push({ label: 'Due Date', value: invoice.due_date });
                    }
                    if (isSettingEnabled('invoice_show_payment_terms')) {
                        rows.push({ label: 'Payment Terms', value: `${invoice.payment_terms || 0} days` });
                    }

                    const detailRows = rows.map(row => `
                        <div class="row">
                            <span class="label">${escapeHtml(row.label)}:</span>
                            <span class="value">${escapeHtml(row.value || '')}</span>
                        </div>`).join('');

                    return `<div class="designer-preview-details">${detailRows}</div>`;
                }
                case 'customerSection': {
                    const customerRecord = invoice.customer || {};
                    const name = invoice.customer_name || customerRecord.name || formData.customer_name || 'Customer';
                    const lines = [];
                    const addressValue = customerRecord.address || formData.customer_address;
                    if (isSettingEnabled('invoice_show_customer_address') && addressValue) {
                        lines.push(formatMultilineText(addressValue));
                    }
                    if (isSettingEnabled('invoice_show_customer_phone') && customerRecord.phone) {
                        lines.push(`Phone: ${escapeHtml(customerRecord.phone)}`);
                    }
                    if (isSettingEnabled('invoice_show_customer_email') && customerRecord.email) {
                        lines.push(`Email: ${escapeHtml(customerRecord.email)}`);
                    }
                    if (isSettingEnabled('invoice_show_customer_vat_number') && customerRecord.vat_reg_number) {
                        lines.push(`VAT: ${escapeHtml(customerRecord.vat_reg_number)}`);
                    }

                    return `
                        <div class="designer-preview-customer">
                            <div class="title">Bill To</div>
                            <div class="fw-semibold fs-5">${escapeHtml(name)}</div>
                            ${lines.length ? `<div class="text-muted small">${lines.join('<br>')}</div>` : ''}
                        </div>`;
                }
                case 'itemsTable': {
                    const showDiscount = isSettingEnabled('invoice_show_discount');
                    const showVat = isSettingEnabled('invoice_show_vat_breakdown');
                    const headers = [
                        '<th class="text-start">Description</th>',
                        '<th class="text-end">Qty</th>',
                        '<th class="text-end">Unit Price</th>'
                    ];
                    if (showDiscount) {
                        headers.push('<th class="text-end">Discount</th>');
                    }
                    if (showVat) {
                        headers.push('<th class="text-end">VAT %</th>');
                        headers.push('<th class="text-end">VAT</th>');
                    }
                    headers.push('<th class="text-end">Total</th>');

                    const columnCount = headers.length;
                    const rows = (invoice.invoice_items || []).map((item, index) => {
                        const description = formatMultilineText(item.description || item.product_name || `Item ${index + 1}`);
                        const quantityNumber = Number(item.quantity || 0);
                        const quantityDisplay = Number.isFinite(quantityNumber)
                            ? quantityNumber.toLocaleString('en-US', { maximumFractionDigits: 2 })
                            : '0';
                        const unitPrice = formatCurrency(item.unit_price ?? item.price ?? 0);
                        const totalValue = formatCurrency(item.total_amount ?? item.total ?? 0);
                        const discountValue = showDiscount ? formatCurrency(item.discount_amount || 0) : null;
                        const vatRate = showVat ? `${parseFloat(item.vat_rate || 0).toFixed(1)}%` : null;
                        const vatAmount = showVat ? formatCurrency(item.vat_amount || 0) : null;

                        const cells = [
                            `<td>${description}</td>`,
                            `<td class="text-end">${escapeHtml(quantityDisplay)}</td>`,
                            `<td class="text-end">${unitPrice}</td>`
                        ];
                        if (showDiscount) {
                            cells.push(`<td class="text-end">${discountValue}</td>`);
                        }
                        if (showVat) {
                            cells.push(`<td class="text-end">${vatRate}</td>`);
                            cells.push(`<td class="text-end">${vatAmount}</td>`);
                        }
                        cells.push(`<td class="text-end">${totalValue}</td>`);
                        return `<tr>${cells.join('')}</tr>`;
                    }).join('');

                    const bodyContent = rows || `<tr><td colspan="${columnCount}" class="text-center text-muted">No items</td></tr>`;

                    return `
                        <table class="designer-preview-table">
                            <thead><tr>${headers.join('')}</tr></thead>
                            <tbody>${bodyContent}</tbody>
                        </table>`;
                }
                case 'totalsSection': {
                    const subtotal = formatCurrency(invoice.subtotal || 0);
                    const discountValue = parseFloat(invoice.discount_amount || 0);
                    const vatValue = formatCurrency(invoice.total_vat_amount || 0);
                    const total = formatCurrency(invoice.total_amount || 0);

                    const rows = [`<tr><td>Subtotal</td><td class="text-end">${subtotal}</td></tr>`];
                    if (isSettingEnabled('invoice_show_discount') && discountValue > 0) {
                        rows.push(`<tr><td>Discount</td><td class="text-end">${formatCurrency(discountValue)}</td></tr>`);
                    }
                    if (isSettingEnabled('invoice_show_vat_breakdown')) {
                        rows.push(`<tr><td>VAT</td><td class="text-end">${vatValue}</td></tr>`);
                    }
                    rows.push(`<tr class="total-row"><td>Total</td><td class="text-end">${total}</td></tr>`);

                    return `<table class="designer-preview-totals">${rows.join('')}</table>`;
                }
                case 'notesSection': {
                    const notes = invoice.notes || formData.notes || (typeof savedContent === 'string' ? savedContent : '');
                    if (!notes) {
                        return '';
                    }
                    return `<div class="designer-preview-notes">${formatMultilineText(notes)}</div>`;
                }
                case 'footerMessage': {
                    const footer = appSettings.invoice_footer_text || formData.footer || (typeof savedContent === 'string' ? savedContent : '');
                    if (!footer) {
                        return '';
                    }
                    return `<div class="designer-preview-notes">${formatMultilineText(footer)}</div>`;
                }
                default: {
                    if (typeof savedContent === 'string') {
                        return savedContent;
                    }
                    if (savedContent && typeof savedContent === 'object' && savedContent.logo) {
                        return `<img src="${savedContent.logo}" alt="Logo" class="designer-preview-logo">`;
                    }
                    return '';
                }
            }
        }

        function renderInvoiceWithDesignerLayout(invoice) {
            const container = document.getElementById('invoiceDesignerPreview');
            const defaultPreview = document.getElementById('invoiceA4Default');
            const shell = document.getElementById('invoiceA4Container');

            if (!container) {
                return;
            }

            if (shell) {
                shell.classList.add('designer-active');
            }
            if (defaultPreview) {
                defaultPreview.classList.add('d-none');
            }

            container.classList.remove('d-none');
            container.innerHTML = '';

            const layout = Array.isArray(invoiceDesignerConfig?.layout) ? invoiceDesignerConfig.layout : [];
            if (!layout.length) {
                container.innerHTML = '<div class="text-center text-muted p-4">No layout configured.</div>';
                return;
            }

            layout.forEach(item => {
                if (!item || !item.field) {
                    return;
                }

                const element = document.createElement('div');
                element.classList.add('designer-preview-element');
                element.dataset.field = item.field;
                const elementType = item.type || item.element_type || item.elementType || 'text';
                element.dataset.elementType = elementType;

                const x = parseNumber(item.x, 0);
                const y = parseNumber(item.y, 0);
                const width = parseNumber(item.width, null);
                const height = parseNumber(item.height, null);

                element.style.left = `${x}px`;
                element.style.top = `${y}px`;
                if (width !== null) {
                    element.style.width = `${width}px`;
                }
                if (height !== null && height > 0) {
                    element.style.height = `${height}px`;
                }
                if (item.fontFamily) {
                    element.style.fontFamily = item.fontFamily;
                }
                if (item.fontSize) {
                    element.style.fontSize = `${item.fontSize}px`;
                }
                if (item.color) {
                    element.style.color = item.color;
                }
                if (item.align) {
                    element.style.textAlign = item.align;
                }
                if (elementType === 'logo') {
                    element.style.padding = '8px';
                    element.style.background = 'transparent';
                    element.style.boxShadow = 'none';
                }

                element.innerHTML = buildDesignerFieldContent(item, invoice);
                container.appendChild(element);
            });
        }

        function renderDefaultInvoicePreview(invoice) {
            // Populate the A4 invoice preview with data
            const shell = document.getElementById('invoiceA4Container');
            const designerPreview = document.getElementById('invoiceDesignerPreview');
            const defaultPreview = document.getElementById('invoiceA4Default');
            if (shell) shell.classList.remove('designer-active');
            if (designerPreview) designerPreview.classList.add('d-none');
            if (defaultPreview) defaultPreview.classList.remove('d-none');
            
            // Company information
            document.getElementById('companyName').textContent = appSettings.company_name || 'Your Company Name';
            document.getElementById('companyAddress').textContent = appSettings.address || '';
            
            // Company contact details
            const phoneEl = document.querySelector('.phone-display');
            const emailEl = document.querySelector('.email-display');
            const websiteEl = document.querySelector('.website-display');
            
            if (phoneEl) phoneEl.textContent = appSettings.phone ? `Phone: ${appSettings.phone}` : '';
            if (emailEl) emailEl.textContent = appSettings.email ? ` | Email: ${appSettings.email}` : '';
            if (websiteEl) websiteEl.textContent = appSettings.website ? ` | ${appSettings.website}` : '';
            
            // VAT number
            const vatEl = document.getElementById('companyVatNumber');
            if (vatEl) vatEl.textContent = appSettings.vat_registration_number ? `VAT: ${appSettings.vat_registration_number}` : '';

            // Company logo - Use centralized logo manager
            if (window.DocumentLogoManager) {
                window.DocumentLogoManager.applyLogoToDocument('companyLogo', 'invoice', {
                    maxWidth: '200px',
                    maxHeight: '100px'
                });
            } else {
                // Fallback to original method if logo manager not available
                const logoEl = document.getElementById('companyLogo');
                if (appSettings.company_logo_base64 && logoEl) {
                    logoEl.src = appSettings.company_logo_base64;
                    logoEl.classList.remove('d-none');
                }
            }

            // Invoice information
            document.getElementById('previewInvoiceNumber').textContent = invoice.invoice_number;
            document.getElementById('previewInvoiceDate').textContent = invoice.invoice_date;
            document.getElementById('previewDueDate').textContent = invoice.due_date;
            document.getElementById('previewPaymentTerms').textContent = `${invoice.payment_terms} days`;

            // Customer information
            document.getElementById('customerName').textContent = invoice.customer_name;
            
            // Customer details (if available)
            if (invoice.customer) {
                const customer = invoice.customer;
                const customerAddressEl = document.querySelector('.customer-address-display');
                const customerPhoneEl = document.querySelector('.customer-phone-display');
                const customerEmailEl = document.querySelector('.customer-email-display');
                const customerVatEl = document.querySelector('.customer-vat-display');

                if (customerAddressEl) customerAddressEl.textContent = customer.address || '';
                if (customerPhoneEl) customerPhoneEl.textContent = customer.phone ? `Phone: ${customer.phone}` : '';
                if (customerEmailEl) customerEmailEl.textContent = customer.email ? `Email: ${customer.email}` : '';
                if (customerVatEl) customerVatEl.textContent = customer.vat_reg_number ? `VAT: ${customer.vat_reg_number}` : '';
            }

            // Invoice items
            const itemsContainer = document.getElementById('previewInvoiceItems');
            itemsContainer.innerHTML = '';
            
            invoice.invoice_items.forEach((item, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${item.description || item.product_name}</td>
                    <td class="text-right">${item.quantity}</td>
                    <td class="text-right">${currencySymbol}${parseFloat(item.unit_price).toFixed(2)}</td>
                    <td class="text-right discount-display">${currencySymbol}${parseFloat(item.discount_amount || 0).toFixed(2)}</td>
                    <td class="text-right vat-breakdown-display">${currencySymbol}${parseFloat(item.vat_amount || 0).toFixed(2)}</td>
                    <td class="text-right">${currencySymbol}${parseFloat(item.total_amount).toFixed(2)}</td>
                `;
                itemsContainer.appendChild(row);
            });

            // Totals
            document.getElementById('previewSubtotal').textContent = `${currencySymbol}${parseFloat(invoice.subtotal || 0).toFixed(2)}`;
            document.getElementById('previewDiscount').textContent = `${currencySymbol}${parseFloat(invoice.discount_amount || 0).toFixed(2)}`;
            document.getElementById('previewVat').textContent = `${currencySymbol}${parseFloat(invoice.total_vat_amount || 0).toFixed(2)}`;
            document.getElementById('previewTotal').textContent = `${currencySymbol}${parseFloat(invoice.total_amount).toFixed(2)}`;

            // Footer
            document.getElementById('footerText').textContent = appSettings.invoice_footer_text || 'Thank you for your business!';
            document.getElementById('termsConditions').textContent = appSettings.invoice_terms_conditions || 'Payment due within 30 days.';

            window.currentGrandTotal = parseFloat(invoice.total_amount || 0) || 0;
        }

        async function populateA4Preview(invoice) {
            const config = await ensureInvoiceDesignerConfig();
            const layout = Array.isArray(config?.layout) ? config.layout : [];

            if (layout.length > 0) {
                renderInvoiceWithDesignerLayout(invoice);
                window.currentGrandTotal = parseFloat(invoice.total_amount || 0) || 0;
            } else {
                renderDefaultInvoicePreview(invoice);
            }
        }

        function applyFormatSettings() {
            // Apply formatting settings to show/hide elements
            const settings = appSettings;

            const defaultPreview = document.getElementById('invoiceA4Default');
            if (!defaultPreview || defaultPreview.classList.contains('d-none')) {
                return;
            }
            
            // Show/hide elements based on settings
            const toggleElements = [
                { setting: 'invoice_show_logo', selector: '.company-logo' },
                { setting: 'invoice_show_company_address', selector: '#companyAddress' },
                { setting: 'invoice_show_company_phone', selector: '.phone-display' },
                { setting: 'invoice_show_company_email', selector: '.email-display' },
                { setting: 'invoice_show_company_website', selector: '.website-display' },
                { setting: 'invoice_show_vat_number', selector: '.vat-display' },
                { setting: 'invoice_show_customer_address', selector: '.customer-address-display' },
                { setting: 'invoice_show_customer_phone', selector: '.customer-phone-display' },
                { setting: 'invoice_show_customer_email', selector: '.customer-email-display' },
                { setting: 'invoice_show_customer_vat_number', selector: '.customer-vat-display' },
                { setting: 'invoice_show_payment_terms', selector: '.payment-terms-display' },
                { setting: 'invoice_show_due_date', selector: '.due-date-display' },
                { setting: 'invoice_show_discount', selector: '.discount-display' },
                { setting: 'invoice_show_vat_breakdown', selector: '.vat-breakdown-display' }
            ];

            toggleElements.forEach(({ setting, selector }) => {
                const elements = document.querySelectorAll(selector);
                const show = settings[setting] !== false; // Default to true if not specified
                elements.forEach(el => {
                    if (show) {
                        el.classList.remove('d-none');
                        el.style.display = '';
                    } else {
                        el.style.display = 'none';
                    }
                });
            });
        }

        function configureInvoiceFormat() {
            // Show invoice format configuration modal
            // Load current settings into the form
            loadFormatSettingsForm();
            new bootstrap.Modal(document.getElementById('invoiceFormatModal')).show();
        }

        function loadFormatSettingsForm() {
            // Load current settings into the format settings form
            const checkboxes = [
                { id: 'showLogo', setting: 'invoice_show_logo' },
                { id: 'showCompanyAddress', setting: 'invoice_show_company_address' },
                { id: 'showCompanyPhone', setting: 'invoice_show_company_phone' },
                { id: 'showCompanyEmail', setting: 'invoice_show_company_email' },
                { id: 'showCompanyWebsite', setting: 'invoice_show_company_website' },
                { id: 'showCompanyVat', setting: 'invoice_show_vat_number' },
                { id: 'showCustomerAddress', setting: 'invoice_show_customer_address' },
                { id: 'showCustomerPhone', setting: 'invoice_show_customer_phone' },
                { id: 'showCustomerEmail', setting: 'invoice_show_customer_email' },
                { id: 'showCustomerVat', setting: 'invoice_show_customer_vat_number' },
                { id: 'showPaymentTerms', setting: 'invoice_show_payment_terms' },
                { id: 'showDueDate', setting: 'invoice_show_due_date' },
                { id: 'showDiscount', setting: 'invoice_show_discount' },
                { id: 'showVatBreakdown', setting: 'invoice_show_vat_breakdown' }
            ];

            checkboxes.forEach(({ id, setting }) => {
                const checkbox = document.getElementById(id);
                if (checkbox) {
                    checkbox.checked = appSettings[setting] !== false;
                }
            });

            // Load text fields into form
            const footerTextInput = document.getElementById('footerTextInput');
            const termsInput = document.getElementById('termsConditionsInput');
            if (footerTextInput) footerTextInput.value = appSettings.invoice_footer_text || '';
            if (termsInput) termsInput.value = appSettings.invoice_terms_conditions || '';
        }

        function printA4Invoice() {
            // Print the A4 invoice
            window.print();
        }

        async function downloadInvoicePDF() {
            // Download invoice as PDF
            // This would typically use a PDF generation library or server endpoint
            if(window.modernUI) window.modernUI.showNotification('PDF download feature coming soon', 'info');
        }

        // Add preview button to invoice actions
        function addPreviewButton(invoiceId) {
            return `<button class="btn btn-sm btn-outline-info me-1" onclick="showInvoicePreview('${invoiceId}')" title="Preview A4">
                <i class="bi bi-eye"></i>
            </button>`;
        }

        // Credit Note Creation Functions
        async function createCreditNoteFromInvoice(invoiceId) {
            if (!invoiceId) {
                if (window.modernUI) {
                    window.modernUI.showNotification('Invoice ID is required', 'error');
                }
                return;
            }

            try {
                // Redirect to credit notes page with invoice pre-filled
                const creditNotesUrl = `/static/credit-notes.html?invoice_id=${invoiceId}`;
                window.open(creditNotesUrl, '_blank');
                
                if (window.modernUI) {
                    window.modernUI.showNotification('Opening credit note creation page...', 'info');
                }
            } catch (error) {
                console.error('Error opening credit note creation:', error);
                if (window.modernUI) {
                    window.modernUI.showNotification('Failed to open credit note creation', 'error');
                }
            }
        }

        async function createCreditNoteFromInvoiceModal() {
            // Get the current invoice ID from the stored variable
            if (currentInvoiceForActions && currentInvoiceForActions.id) {
                await createCreditNoteFromInvoice(currentInvoiceForActions.id);
                
                // Close the invoice details modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('invoiceDetailsModal'));
                if (modal) {
                    modal.hide();
                }
            } else {
                if (window.modernUI) {
                    window.modernUI.showNotification('Unable to identify invoice for credit note creation', 'error');
                }
            }
        }

        // Global variable to store current invoice for modal actions
        let currentInvoiceForActions = null;
        let currentInvoiceId = null;

        // === COMPREHENSIVE INVOICE PRINT FUNCTIONS ===

        // Quick print using configured printer settings
        async function quickPrintInvoice(invoiceId) {
            if (!invoiceId) {
                showNotification('No invoice ID provided', 'error');
                return;
            }

            try {
                showNotification('Preparing invoice for printing...', 'info');

                const response = await fetch(`${API_BASE}/invoices/${invoiceId}/print`);
                if (!response.ok) {
                    throw new Error(`Failed to generate invoice: ${response.statusText}`);
                }

                const contentType = response.headers.get('content-type');
                const contentDisposition = response.headers.get('content-disposition');
                
                let filename = 'invoice';
                if (contentDisposition) {
                    const filenameMatch = contentDisposition.match(/filename="([^"]+)"/);
                    if (filenameMatch) filename = filenameMatch[1];
                }

                if (contentType.includes('application/pdf')) {
                    const blob = await response.blob();
                    const url = URL.createObjectURL(blob);
                    const printWindow = window.open(url, '_blank');
                    printWindow.onload = () => printWindow.print();
                    setTimeout(() => URL.revokeObjectURL(url), 1000);
                } else {
                    const text = await response.text();
                    const printWindow = window.open('', '_blank');
                    printWindow.document.write(`
                        <html>
                        <head>
                            <title>Invoice - ${filename}</title>
                            <style>
                                body { 
                                    font-family: 'Courier New', monospace; 
                                    font-size: 12px; 
                                    line-height: 1.2; 
                                    white-space: pre-wrap; 
                                    margin: 0; 
                                    padding: 10px;
                                    background: white;
                                }
                                @media print {
                                    body { margin: 0; padding: 5px; font-size: 10px; }
                                }
                            </style>
                        </head>
                        <body>
    ${text}</body>
                        </html>
                    `);
                    printWindow.document.close();
                    setTimeout(() => printWindow.print(), 500);
                }
            } catch (error) {
                console.error('Error printing invoice:', error);
                showNotification(`Failed to print invoice: ${error.message}`, 'error');
            }
        }

        // Force print as A4 PDF
        async function printInvoiceAsPDF(invoiceId) {
            try {
                showNotification('Generating PDF for printing...', 'info');
                
                const response = await fetch(`${API_BASE}/documents/print`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        document_type: 'invoice',
                        document_id: invoiceId
                    })
                });

                if (!response.ok) {
                    throw new Error(`Failed to generate PDF: ${response.statusText}`);
                }

                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                const printWindow = window.open(url, '_blank');
                printWindow.onload = () => printWindow.print();
                showNotification('PDF invoice sent to printer', 'success');
                setTimeout(() => URL.revokeObjectURL(url), 1000);
            } catch (error) {
                console.error('Error printing PDF:', error);
                showNotification(`Failed to print PDF: ${error.message}`, 'error');
            }
        }

        // Force print as dot matrix
        async function printInvoiceDotMatrix(invoiceId) {
            try {
                showNotification('Generating dot matrix format...', 'info');
                
                const response = await fetch(`${API_BASE}/invoices/${invoiceId}/print-dot-matrix`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        paper_width: 80,
                        form_length: 66,
                        compressed: false,
                        carbon_copies: 1
                    })
                });

                if (!response.ok) {
                    throw new Error(`Failed to generate dot matrix: ${response.statusText}`);
                }

                const data = await response.json();
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <html><head><title>Dot Matrix Invoice</title>
                    <style>body{font-family:'Courier New',monospace;font-size:12px;line-height:1.2;white-space:pre-wrap;margin:0;padding:10px;}
                    @media print{body{margin:0;padding:0;}}</style>
                    </head><body>
    ${data.content}</body></html>
                `);
                printWindow.document.close();
                setTimeout(() => printWindow.print(), 500);
                showNotification('Dot matrix invoice sent to printer', 'success');
            } catch (error) {
                console.error('Error printing dot matrix:', error);
                showNotification(`Failed to print dot matrix: ${error.message}`, 'error');
            }
        }

        // Download invoice as PDF
        async function downloadInvoicePDF(invoiceId) {
            try {
                showNotification('Preparing PDF download...', 'info');
                
                const response = await fetch(`${API_BASE}/documents/print`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        document_type: 'invoice',
                        document_id: invoiceId
                    })
                });

                if (!response.ok) {
                    throw new Error(`Failed to generate PDF: ${response.statusText}`);
                }

                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `invoice_${invoiceId}.pdf`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                showNotification('PDF downloaded successfully', 'success');
            } catch (error) {
                console.error('Error downloading PDF:', error);
                showNotification(`Failed to download PDF: ${error.message}`, 'error');
            }
        }

        // Open invoice printer settings
        function openInvoicePrintSettings() {
            window.open('/static/invoice-printer-settings.html', '_blank');
            showNotification('Opening printer settings...', 'info');
        }

        // Enhanced downloadInvoicePDF function for modal usage
        async function downloadInvoicePDF() {
            if (currentInvoiceId) {
                await downloadInvoicePDF(currentInvoiceId);
            } else {
                showNotification('No invoice selected', 'error');
            }
        }

        // Utility function for notifications
        function showNotification(message, type = 'info') {
            if (window.modernUI) {
                window.modernUI.showNotification(message, type);
            } else {
                console.log(`[${type.toUpperCase()}] ${message}`);
            }
        }

        // Display warning inside the Add Invoice modal
        function displayModalWarning(message) {
            const modal = document.getElementById('addInvoiceModal');
            if (!modal) return;
            const body = modal.querySelector('.modal-body');
            if (!body) return;
            // Remove any existing warning alerts
            const existing = body.querySelector('.alert');
            if (existing) existing.remove();
            // Create and insert warning alert
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-warning';
            alertDiv.textContent = message;
            body.insertBefore(alertDiv, body.firstChild);
        }

    // Bulk print & download functions removed due to previous syntax issues
    // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeData();
            
            // Setup "Select All" functionality
            const selectAllCheckbox = document.getElementById('selectAll');
            if (selectAllCheckbox) {
                selectAllCheckbox.addEventListener('change', function() {
                    const checkboxes = document.querySelectorAll('#invoicesTable input[type="checkbox"]');
                    checkboxes.forEach(cb => {
                        cb.checked = this.checked;
                    });
                });
            }
        });

        // Invoice Designer Functions
        function openInvoiceDesigner() {
            window.open('/static/invoice-designer.html', '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
        }

        function openInvoiceCustomization() {
            window.open('/static/invoice-customization.html', '_blank', 'width=1400,height=900,scrollbars=yes,resizable=yes');
        }

        // Cash Sale Receipt Functions
        function showCashSaleReceiptOptions(invoiceData) {
            if (!invoiceData.receipt_generated || !invoiceData.sale_id) return;
            
            // Create or update receipt notification bar
            let receiptBar = document.getElementById('cashSaleReceiptBar');
            if (!receiptBar) {
                receiptBar = document.createElement('div');
                receiptBar.id = 'cashSaleReceiptBar';
                receiptBar.className = 'alert alert-success py-2 px-3 d-flex justify-content-between align-items-center position-sticky top-0 mt-2';
                
                // Insert after the main content area
                const mainContent = document.querySelector('.container-fluid');
                if (mainContent) {
                    mainContent.insertBefore(receiptBar, mainContent.firstChild);
                }
            }
            
            receiptBar.innerHTML = `
                <div>
                    <i class="bi bi-receipt-cutoff me-2"></i>
                    <strong>Cash Sale Receipt Available:</strong> ${invoiceData.receipt_number}
                    <small class="text-muted ms-2">Invoice: ${invoiceData.invoice_number}</small>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-outline-primary" onclick="viewCashSaleReceipt('${invoiceData.sale_id}', '${invoiceData.receipt_number}')">
                        <i class="bi bi-eye"></i> View Receipt
                    </button>
                    <button class="btn btn-sm btn-outline-success" onclick="printCashSaleReceipt('${invoiceData.sale_id}')">
                        <i class="bi bi-printer"></i> Print Receipt
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="hideCashSaleReceiptBar()">
                        <i class="bi bi-x"></i>
                    </button>
                </div>
            `;
            
            receiptBar.style.display = 'flex';
            
            // Auto-hide after 30 seconds
            setTimeout(() => {
                if (receiptBar) {
                    receiptBar.style.display = 'none';
                }
            }, 30000);
        }

        async function viewCashSaleReceipt(saleId, receiptNumber) {
            try {
                // Fetch receipt from POS endpoint since cash sales generate POS receipts
                const response = await fetch(`/api/v1/pos/sales/${saleId}/receipt?copy_type=customer`);
                
                if (!response.ok) {
                    throw new Error('Failed to fetch receipt');
                }
                
                const receiptData = await response.json();
                
                if (receiptData.success && receiptData.data) {
                    displayCashSaleReceiptModal(receiptData.data, receiptNumber, saleId);
                } else {
                    throw new Error('Invalid receipt data received');
                }
                
            } catch (error) {
                console.error('Error fetching receipt:', error);
                if (window.modernUI) {
                    window.modernUI.showNotification('Error loading receipt: ' + error.message, 'error');
                } else {
                    alert('Error loading receipt: ' + error.message);
                }
            }
        }

        function displayCashSaleReceiptModal(receiptData, receiptNumber, saleId) {
            // Create or update receipt modal
            let modal = document.getElementById('cashSaleReceiptModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'cashSaleReceiptModal';
                modal.className = 'modal fade';
                modal.innerHTML = `
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="bi bi-receipt-cutoff me-2"></i>
                                    Cash Sale Receipt - <span id="receiptNumberTitle">${receiptNumber}</span>
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-8">
                                        <div class="card">
                                            <div class="card-header">
                                                <h6 class="mb-0">Receipt Preview</h6>
                                            </div>
                                            <div class="card-body" style="background-color: #f8f9fa;">
                                                <pre id="receiptContent" style="font-family: 'Courier New', monospace; font-size: 11px; line-height: 1.2; white-space: pre-wrap; background: white; border: 1px solid #dee2e6; padding: 15px; border-radius: 4px;">
                                                    <!-- Receipt content will be loaded here -->
                                                </pre>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card">
                                            <div class="card-header">
                                                <h6 class="mb-0">Receipt Actions</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="d-grid gap-2">
                                                    <button class="btn btn-primary" onclick="printCashSaleReceipt('${saleId}')">
                                                        <i class="bi bi-printer"></i> Print Receipt
                                                    </button>
                                                    <button class="btn btn-outline-success" onclick="downloadCashSaleReceipt('${saleId}')">
                                                        <i class="bi bi-download"></i> Download Receipt
                                                    </button>
                                                    <button class="btn btn-outline-info" onclick="viewCashSaleInvoice('${saleId}')">
                                                        <i class="bi bi-file-earmark-text"></i> View Invoice
                                                    </button>
                                                </div>
                                                
                                                <hr>
                                                
                                                <h6>Sale Information</h6>
                                                <div class="small text-muted">
                                                    <div><strong>Sale ID:</strong> <span id="saleIdInfo">${saleId}</span></div>
                                                    <div><strong>Receipt #:</strong> <span id="receiptNumberInfo">${receiptNumber}</span></div>
                                                    <div><strong>Type:</strong> Cash Sale Invoice</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <button type="button" class="btn btn-primary" onclick="printCashSaleReceipt('${saleId}')">
                                    <i class="bi bi-printer"></i> Print Receipt
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }

            // Load receipt content
            const receiptContent = receiptData.receipt_content || receiptData.customer_copy || '';
            document.getElementById('receiptContent').textContent = receiptContent;
            
            // Update modal title and info
            document.getElementById('receiptNumberTitle').textContent = receiptNumber;
            document.getElementById('receiptNumberInfo').textContent = receiptNumber;
            document.getElementById('saleIdInfo').textContent = saleId;

            // Show modal
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
        }

        async function printCashSaleReceipt(saleId) {
            try {
                // Use the POS receipt print endpoint for direct printing
                const response = await fetch(`/api/v1/pos/sales/${saleId}/receipt/print?copy_type=customer`);
                
                if (response.ok) {
                    const receiptBlob = await response.blob();
                    const receiptText = await receiptBlob.text();
                    
                    // Create a new window for printing
                    const printWindow = window.open('', '_blank');
                    printWindow.document.write(`
                        <html>
                        <head>
                            <title>Receipt Print</title>
                            <style>
                                body { 
                                    font-family: 'Courier New', monospace; 
                                    font-size: 10px; 
                                    line-height: 1.1; 
                                    margin: 0; 
                                    padding: 10px; 
                                    white-space: pre-wrap;
                                }
                                @media print {
                                    body { margin: 0; padding: 5px; font-size: 9px; }
                                }
                            </style>
                        </head>
                        <body>
    ${receiptText}</body>
                        </html>
                    `);
                    printWindow.document.close();
                    
                    // Wait a moment then print
                    setTimeout(() => printWindow.print(), 500);
                    
                    if (window.modernUI) {
                        window.modernUI.showNotification('Receipt sent to printer', 'success');
                    }
                } else {
                    throw new Error('Failed to print receipt');
                }
            } catch (error) {
                console.error('Error printing receipt:', error);
                if (window.modernUI) {
                    window.modernUI.showNotification('Error printing receipt: ' + error.message, 'error');
                } else {
                    alert('Error printing receipt: ' + error.message);
                }
            }
        }

        async function downloadCashSaleReceipt(saleId) {
            try {
                const response = await fetch(`/api/v1/pos/sales/${saleId}/receipt/print?copy_type=customer`);
                
                if (response.ok) {
                    const receiptBlob = await response.blob();
                    const url = URL.createObjectURL(receiptBlob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `receipt_${saleId}.txt`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                    
                    if (window.modernUI) {
                        window.modernUI.showNotification('Receipt downloaded', 'success');
                    }
                } else {
                    throw new Error('Failed to download receipt');
                }
            } catch (error) {
                console.error('Error downloading receipt:', error);
                if (window.modernUI) {
                    window.modernUI.showNotification('Error downloading receipt: ' + error.message, 'error');
                } else {
                    alert('Error downloading receipt: ' + error.message);
                }
            }
        }

        function viewCashSaleInvoice(saleId) {
            // This would link to the invoice view - could open in new tab or modal
            if (window.modernUI) {
                window.modernUI.showNotification('Invoice viewing functionality - integrate with invoice management system', 'info');
            } else {
                alert('This would show the related invoice for sale ID: ' + saleId);
            }
        }

        function hideCashSaleReceiptBar() {
            const receiptBar = document.getElementById('cashSaleReceiptBar');
            if (receiptBar) {
                receiptBar.style.display = 'none';
            }
        }
    </script>
</body>
    
    
</html>