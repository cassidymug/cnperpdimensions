<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Branch Sales - Real-time Monitoring</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #0d6efd;
            --success-color: #198754;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --info-color: #0dcaf0;
            --dark-bg: #212529;
            --light-bg: #f8f9fa;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .page-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--success-color) 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .page-header h1 {
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .real-time-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            background: #00ff00;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.7);
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .metrics-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .metric-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border-left: 4px solid var(--primary-color);
        }

        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
        }

        .metric-card.success {
            border-left-color: var(--success-color);
        }

        .metric-card.warning {
            border-left-color: var(--warning-color);
        }

        .metric-card.info {
            border-left-color: var(--info-color);
        }

        .metric-card h6 {
            color: #6c757d;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }

        .metric-card .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .metric-card .metric-unit {
            font-size: 0.875rem;
            color: #6c757d;
            margin-left: 0.5rem;
        }

        .metric-card .metric-change {
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }

        .metric-card .metric-change.up {
            color: var(--success-color);
        }

        .metric-card .metric-change.down {
            color: var(--danger-color);
        }

        .branch-table-container {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            margin-bottom: 2rem;
        }

        .branch-table-container h5 {
            margin-bottom: 1rem;
            color: var(--dark-bg);
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .table {
            margin-bottom: 0;
        }

        .table thead th {
            background: var(--light-bg);
            color: var(--dark-bg);
            font-weight: 600;
            border: none;
            padding: 1rem;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .table tbody td {
            padding: 1rem;
            vertical-align: middle;
            border-color: #e9ecef;
        }

        .table tbody tr {
            transition: background-color 0.3s ease;
        }

        .table tbody tr:hover {
            background-color: var(--light-bg);
        }

        .branch-name {
            font-weight: 600;
            color: var(--primary-color);
        }

        .sales-amount {
            color: var(--success-color);
            font-weight: 600;
        }

        .transaction-count {
            background: var(--light-bg);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--primary-color);
            display: inline-block;
        }

        .status-badge {
            padding: 0.35rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-badge.active {
            background: rgba(25, 135, 84, 0.1);
            color: var(--success-color);
        }

        .status-badge.inactive {
            background: rgba(108, 117, 125, 0.1);
            color: #6c757d;
        }

        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            margin-bottom: 2rem;
            position: relative;
        }

        .chart-container h5 {
            margin-bottom: 1rem;
            color: var(--dark-bg);
            font-weight: 700;
        }

        .chart-wrapper {
            position: relative;
            height: 400px;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .refresh-button {
            background: var(--primary-color);
            border: none;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .refresh-button:hover {
            background: #0b5ed7;
            transform: rotate(180deg);
        }

        .refresh-button.refreshing {
            opacity: 0.6;
            pointer-events: none;
        }

        .filter-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .filter-select {
            flex: 1;
            min-width: 200px;
            padding: 0.5rem;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            background: white;
            color: var(--dark-bg);
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .comparison-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        }

        .comparison-card h6 {
            font-weight: 700;
            margin-bottom: 1rem;
            color: var(--dark-bg);
        }

        .comparison-stat {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid #e9ecef;
        }

        .comparison-stat:last-child {
            border-bottom: none;
        }

        .comparison-stat label {
            font-size: 0.875rem;
            color: #6c757d;
        }

        .comparison-stat value {
            font-weight: 600;
            color: var(--primary-color);
        }

        @media (max-width: 768px) {
            .metrics-container {
                grid-template-columns: 1fr;
            }

            .chart-wrapper {
                height: 300px;
            }

            .table {
                font-size: 0.875rem;
            }

            .table thead th,
            .table tbody td {
                padding: 0.75rem 0.5rem;
            }
        }

        .toast-notification {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--success-color);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Card Grid View Styles */
        .branch-grid-container {
            display: none;
            /* Hidden by default, shown when card view is active */
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
            padding: 1rem;
        }

        .branch-grid-container.active {
            display: grid;
        }

        .branch-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            border-left: 5px solid var(--primary-color);
        }

        .branch-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
        }

        .branch-card.status-active {
            border-left-color: var(--success-color);
        }

        .branch-card.status-inactive {
            border-left-color: #6c757d;
            opacity: 0.7;
        }

        .branch-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        /* Clickable branch rows */
        .branch-row {
            transition: background-color 0.2s ease, transform 0.2s ease;
        }

        .branch-row:hover {
            background-color: rgba(13, 110, 253, 0.05) !important;
            transform: scale(1.01);
        }

        .branch-row:active {
            transform: scale(0.99);
        }

        /* Modal styles */
        .modal-xl {
            max-width: 1200px;
        }

        #branchDetailContent .card {
            border: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        #recentTransactionsBody tr {
            transition: background-color 0.2s ease;
        }

        #recentTransactionsBody tr:hover {
            background-color: rgba(13, 110, 253, 0.05);
        }

        .branch-card-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--dark-bg);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .branch-card-status {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .branch-card-status.active {
            background: rgba(25, 135, 84, 0.15);
            color: var(--success-color);
        }

        .branch-card-status.inactive {
            background: rgba(108, 117, 125, 0.15);
            color: #6c757d;
        }

        .branch-card-metric {
            margin-bottom: 1rem;
        }

        .branch-card-metric-label {
            font-size: 0.75rem;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.25rem;
        }

        .branch-card-metric-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .branch-card-metric-value.large {
            font-size: 2rem;
        }

        .branch-card-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e9ecef;
        }

        .branch-card-stat {
            text-align: center;
        }

        .branch-card-stat-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--dark-bg);
            display: block;
        }

        .branch-card-stat-label {
            font-size: 0.7rem;
            color: #6c757d;
            display: block;
            margin-top: 0.25rem;
        }

        .branch-card-footer {
            margin-top: 1rem;
            padding-top: 0.75rem;
            border-top: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.75rem;
            color: #6c757d;
        }

        .branch-card-pulse {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 10px;
            height: 10px;
            background: var(--success-color);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .branch-card-pulse.inactive {
            background: #6c757d;
            animation: none;
        }

        .view-toggle-buttons {
            display: flex;
            gap: 0.5rem;
            background: white;
            padding: 0.25rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .view-toggle-btn {
            padding: 0.5rem 1rem;
            border: none;
            background: transparent;
            color: #6c757d;
            font-weight: 500;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .view-toggle-btn:hover {
            background: #f8f9fa;
            color: var(--primary-color);
        }

        .view-toggle-btn.active {
            background: var(--primary-color);
            color: white;
        }

        .branch-table-container.hidden {
            display: none;
        }
    </style>
</head>

<body>
    <!-- Navigation Bar Container -->
    <div id="navbar-container"></div>
    <script src="js/navbar.js?v=20250106001"></script>

    <!-- Spacer to prevent content from being hidden under fixed navbar -->
    <div style="height: 70px;"></div>

    <!-- Page Header -->
    <div class="page-header">
        <div class="container-fluid">
            <h1>
                <i class="bi bi-graph-up-arrow"></i>
                Branch Sales - Real-time Monitoring
                <span class="real-time-indicator ms-2" title="Real-time data"></span>
            </h1>
            <p class="mb-0 opacity-75">Monitor sales performance across all branches in real-time</p>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container-fluid">
        <!-- Top Metrics -->
        <div class="metrics-container" id="metricsContainer">
            <div class="metric-card info">
                <h6>Network Sales Today</h6>
                <div class="metric-value" id="totalSalesToday">---</div>
                <div class="metric-unit">Total Revenue</div>
            </div>

            <div class="metric-card success">
                <h6>Active Branches</h6>
                <div class="metric-value" id="activeBranches">---</div>
                <div class="metric-unit">Reporting Sales</div>
            </div>

            <div class="metric-card warning">
                <h6>Average Transaction</h6>
                <div class="metric-value" id="avgTransaction">---</div>
                <div class="metric-unit">Network Average</div>
            </div>

            <div class="metric-card">
                <h6>Data Refresh</h6>
                <button class="refresh-button" id="refreshBtn" onclick="refreshData()">
                    <i class="bi bi-arrow-clockwise"></i>
                    <span>Refresh Now</span>
                </button>
                <div class="metric-change" id="lastUpdate" style="margin-top: 1rem;">
                    Last update: Just now
                </div>
            </div>
        </div>

        <!-- Filter Controls -->
        <div class="filter-controls">
            <select class="filter-select" id="timeFilter" onchange="handleTimeFilterChange()">
                <option value="today">Today</option>
                <option value="week">This Week</option>
                <option value="month" selected>This Month</option>
                <option value="year">This Year</option>
            </select>

            <select class="filter-select" id="sortFilter" onchange="handleSortChange()">
                <option value="sales">Sort by Sales</option>
                <option value="transactions">Sort by Transactions</option>
                <option value="average">Sort by Avg Transaction</option>
                <option value="name">Sort by Name</option>
            </select>

            <label class="form-check" style="margin-top: 0.5rem;">
                <input type="checkbox" class="form-check-input" id="excludeEmpty" onchange="refreshData()">
                <span class="form-check-label">Hide branches with no sales</span>
            </label>

            <div class="view-toggle-buttons">
                <button class="view-toggle-btn active" id="tableViewBtn" onclick="switchView('table')">
                    <i class="bi bi-table"></i> Table
                </button>
                <button class="view-toggle-btn" id="cardViewBtn" onclick="switchView('card')">
                    <i class="bi bi-grid-3x3-gap"></i> Cards
                </button>
            </div>
        </div>

        <!-- Branches Table -->
        <div class="branch-table-container">
            <h5>
                <i class="bi bi-table"></i>
                Branch Performance Details
            </h5>
            <div style="overflow-x: auto;">
                <table class="table table-hover" id="branchesTable">
                    <thead>
                        <tr>
                            <th>Branch Name</th>
                            <th>Sales Today</th>
                            <th>Sales This Month</th>
                            <th>Transactions</th>
                            <th>Avg Transaction</th>
                            <th>Status</th>
                            <th>Last Updated</th>
                        </tr>
                    </thead>
                    <tbody id="branchesTableBody">
                        <tr>
                            <td colspan="7" class="text-center">
                                <div class="loading-spinner"></div> Loading data...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Branch Cards Grid (hidden by default) -->
        <div class="branch-grid-container" id="branchCardsGrid">
            <!-- Cards populated by JavaScript -->
        </div>

        <!-- Charts Section -->
        <div class="row">
            <div class="col-lg-6">
                <div class="chart-container">
                    <h5>
                        <i class="bi bi-pie-chart"></i>
                        Sales Distribution by Branch
                    </h5>
                    <div class="chart-wrapper">
                        <canvas id="distributionChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="col-lg-6">
                <div class="chart-container">
                    <h5>
                        <i class="bi bi-bar-chart"></i>
                        Top Performing Branches
                    </h5>
                    <div class="chart-wrapper">
                        <canvas id="performanceChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Hourly Sales Trend -->
        <div class="chart-container">
            <h5>
                <i class="bi bi-graph-up"></i>
                Network Sales Trend (24 Hours)
            </h5>
            <div class="chart-wrapper" style="height: 300px;">
                <canvas id="trendChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Branch Detail Modal -->
    <div class="modal fade" id="branchDetailModal" tabindex="-1" aria-labelledby="branchDetailModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="branchDetailModalLabel">
                        <i class="bi bi-shop"></i>
                        <span id="modalBranchName">Branch Details</span>
                        <span class="real-time-indicator ms-2" title="Live data"></span>
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="branchDetailLoading" class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-3">Loading real-time sales data...</p>
                    </div>
                    <div id="branchDetailContent" class="d-none">
                        <!-- Branch Metrics -->
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <div class="card border-primary">
                                    <div class="card-body">
                                        <h6 class="text-muted text-uppercase mb-2">Total Sales</h6>
                                        <h3 class="mb-0" id="detailTotalSales">P0.00</h3>
                                        <small class="text-muted" id="detailTimeRange">Last 24 hours</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card border-success">
                                    <div class="card-body">
                                        <h6 class="text-muted text-uppercase mb-2">Transactions</h6>
                                        <h3 class="mb-0" id="detailTransactionCount">0</h3>
                                        <small class="text-muted" id="detailAvgTransaction">Avg: P0.00</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card border-info">
                                    <div class="card-body">
                                        <h6 class="text-muted text-uppercase mb-2">Last Sale</h6>
                                        <h3 class="mb-0" id="detailLastSaleAmount">P0.00</h3>
                                        <small class="text-muted" id="detailLastSaleTime">Never</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card border-warning">
                                    <div class="card-body">
                                        <h6 class="text-muted text-uppercase mb-2">Payment Methods</h6>
                                        <div id="detailPaymentMethods" style="font-size: 0.9rem;">
                                            <div class="text-muted">No data</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Recent Transactions -->
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">
                                    <i class="bi bi-clock-history"></i>
                                    Recent Transactions (Live)
                                </h6>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                    <table class="table table-sm table-hover mb-0">
                                        <thead class="sticky-top bg-light">
                                            <tr>
                                                <th>Time</th>
                                                <th>Receipt #</th>
                                                <th>Customer</th>
                                                <th>Items</th>
                                                <th>Payment</th>
                                                <th class="text-end">Amount</th>
                                            </tr>
                                        </thead>
                                        <tbody id="recentTransactionsBody">
                                            <tr>
                                                <td colspan="6" class="text-center text-muted py-4">
                                                    No transactions yet
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Hourly Breakdown Chart -->
                        <div class="card">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">
                                    <i class="bi bi-graph-up"></i>
                                    Hourly Sales Breakdown
                                </h6>
                            </div>
                            <div class="card-body">
                                <canvas id="branchHourlyChart" height="100"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="refreshBranchDetail()">
                        <i class="bi bi-arrow-clockwise"></i> Refresh
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>

    <script>
        // Global state
        let realtimeSalesData = null;
        let charts = {};
        let autoRefreshInterval = null;
        let currentSort = 'sales';
        let appSettings = null; // Application settings including currency, locale

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async function () {
            await loadAppSettings(); // Load settings first
            updatePageWithSettings(); // Update page elements with settings
            loadRealtimeData();
            setupAutoRefresh();
        });

        // Load application settings (currency, locale, etc.)
        async function loadAppSettings() {
            try {
                const response = await fetch('/api/v1/settings/simple');
                if (response.ok) {
                    const result = await response.json();
                    appSettings = result.data;
                    console.log('App settings loaded:', appSettings);
                } else {
                    // Use defaults if settings can't be loaded
                    appSettings = {
                        currency: 'BWP',
                        locale: 'en',
                        company_name: 'Company',
                        vat_rate: 14.0
                    };
                }
            } catch (error) {
                console.error('Error loading app settings:', error);
                // Use defaults
                appSettings = {
                    currency: 'BWP',
                    locale: 'en',
                    company_name: 'Company',
                    vat_rate: 14.0
                };
            }
        }

        // Update page elements with app settings
        function updatePageWithSettings() {
            if (!appSettings) return;

            // Update page title
            if (appSettings.company_name) {
                document.title = `Branch Sales - ${appSettings.company_name}`;
            }

            // Update header subtitle if company name is available
            const headerSubtitle = document.querySelector('.page-header p');
            if (headerSubtitle && appSettings.company_name) {
                headerSubtitle.textContent = `Monitor sales performance across all ${appSettings.company_name} branches in real-time`;
            }
        }

        // Format currency with proper symbol
        function formatCurrency(amount) {
            if (!appSettings) return `P ${amount.toFixed(2)}`;

            const currencySymbols = {
                'BWP': 'P',
                'USD': '$',
                'EUR': '€',
                'GBP': '£',
                'ZAR': 'R'
            };

            const symbol = currencySymbols[appSettings.currency] || appSettings.currency;
            return `${symbol} ${amount.toLocaleString(appSettings.locale || 'en', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        }

        // Format number with locale
        function formatNumber(num) {
            if (!appSettings) return num.toFixed(2);
            return num.toLocaleString(appSettings.locale || 'en', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function () {
            loadRealtimeData();
            setupAutoRefresh();
        });

        // Setup auto-refresh every 5 seconds
        function setupAutoRefresh() {
            autoRefreshInterval = setInterval(() => {
                loadRealtimeData(false);
            }, 5000);
        }

        // Load real-time data from API
        async function loadRealtimeData(showNotification = true) {
            const refreshBtn = document.getElementById('refreshBtn');
            refreshBtn.classList.add('refreshing');

            try {
                const excludeEmpty = document.getElementById('excludeEmpty').checked;
                const response = await fetch(`/api/v1/v1/branch-sales/realtime?exclude_empty=${excludeEmpty}`);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                realtimeSalesData = await response.json();

                // Update UI
                updateMetrics();
                updateTable();
                updateCharts();
                updateLastUpdate();

                if (showNotification) {
                    showNotificationToast('Data refreshed successfully');
                }
            } catch (error) {
                console.error('Error loading real-time data:', error);
                showNotificationToast('Error loading data', 'error');
            } finally {
                refreshBtn.classList.remove('refreshing');
            }
        }

        // Update top metrics
        function updateMetrics() {
            if (!realtimeSalesData) return;

            // Total sales
            const totalSales = realtimeSalesData.total_network_sales;
            document.getElementById('totalSalesToday').textContent = formatCurrency(totalSales);

            // Active branches
            const activeBranches = realtimeSalesData.active_branches;
            document.getElementById('activeBranches').textContent = activeBranches;

            // Calculate network average
            const totalTransactions = realtimeSalesData.branches.reduce((sum, b) => sum + b.transaction_count_today, 0);
            const avgTransaction = totalTransactions > 0 ? totalSales / totalTransactions : 0;
            document.getElementById('avgTransaction').textContent = formatCurrency(avgTransaction);
        }

        // Update branches table
        function updateTable() {
            if (!realtimeSalesData) return;

            const tbody = document.getElementById('branchesTableBody');
            let branches = [...realtimeSalesData.branches];

            // Sort branches
            branches.sort((a, b) => {
                switch (currentSort) {
                    case 'sales':
                        return b.total_sales_today - a.total_sales_today;
                    case 'transactions':
                        return b.transaction_count_today - a.transaction_count_today;
                    case 'average':
                        return b.average_transaction - a.average_transaction;
                    case 'name':
                        return a.branch_name.localeCompare(b.branch_name);
                    default:
                        return 0;
                }
            });

            let html = '';
            branches.forEach((branch, index) => {
                const status = branch.transaction_count_today > 0 ? 'active' : 'inactive';
                const statusText = branch.transaction_count_today > 0 ? 'Active' : 'Inactive';

                html += `
                    <tr class="branch-row" style="cursor: pointer;" onclick="showBranchDetail('${branch.branch_id}', '${escapeHtml(branch.branch_name).replace(/'/g, "\\'")}')">
                        <td>
                            <span class="branch-name">
                                <i class="bi bi-shop me-2 text-primary"></i>${escapeHtml(branch.branch_name)}
                            </span>
                        </td>
                        <td>
                            <span class="sales-amount">${formatCurrency(branch.total_sales_today)}</span>
                        </td>
                        <td>${formatCurrency(branch.total_sales_this_month)}</td>
                        <td>
                            <span class="transaction-count">${branch.transaction_count_today}</span>
                        </td>
                        <td>${formatCurrency(branch.average_transaction)}</td>
                        <td>
                            <span class="status-badge ${status}">${statusText}</span>
                        </td>
                        <td>
                            <small class="text-muted">${formatTime(branch.last_updated)}</small>
                        </td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;

            // Also update cards if in card view
            if (currentView === 'card') {
                updateCards();
            }
        }

        // Update charts
        function updateCharts() {
            if (!realtimeSalesData || realtimeSalesData.branches.length === 0) return;

            updateDistributionChart();
            updatePerformanceChart();
            updateTrendChart();
        }

        // Update pie chart - sales distribution
        function updateDistributionChart() {
            const ctx = document.getElementById('distributionChart').getContext('2d');
            const labels = realtimeSalesData.branches.map(b => b.branch_name);
            const data = realtimeSalesData.branches.map(b => b.total_sales_today);
            const colors = generateColors(labels.length);

            if (charts.distribution) {
                charts.distribution.destroy();
            }

            charts.distribution = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        borderColor: '#fff',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: { size: 11 },
                                usePointStyle: true,
                                padding: 15
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    const value = formatCurrency(context.parsed);
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return `${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Update bar chart - top performers
        function updatePerformanceChart() {
            const ctx = document.getElementById('performanceChart').getContext('2d');

            const sortedBranches = [...realtimeSalesData.branches]
                .sort((a, b) => b.total_sales_today - a.total_sales_today)
                .slice(0, 8);

            const labels = sortedBranches.map(b => b.branch_name);
            const data = sortedBranches.map(b => b.total_sales_today);

            if (charts.performance) {
                charts.performance.destroy();
            }

            charts.performance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Sales Today',
                        data: data,
                        backgroundColor: '#198754',
                        borderColor: '#155724',
                        borderWidth: 1,
                        borderRadius: 6
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return formatCurrency(context.parsed.x);
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                callback: function (value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        // Update trend chart - 24 hour sales
        function updateTrendChart() {
            const ctx = document.getElementById('trendChart').getContext('2d');

            // Generate hourly data (simulated - in real scenario, fetch from API)
            const now = new Date();
            const hours = [];
            const salesData = [];

            for (let i = 23; i >= 0; i--) {
                const hour = new Date(now);
                hour.setHours(hour.getHours() - i);
                hours.push(hour.getHours().toString().padStart(2, '0') + ':00');

                // Simulate data - in reality, this would come from the API
                const baseSales = realtimeSalesData.total_network_sales;
                const randomFactor = 0.5 + Math.random();
                const hourSales = (baseSales / 24) * randomFactor;
                salesData.push(hourSales);
            }

            if (charts.trend) {
                charts.trend.destroy();
            }

            charts.trend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: hours,
                    datasets: [{
                        label: 'Network Sales',
                        data: salesData,
                        borderColor: '#0d6efd',
                        backgroundColor: 'rgba(13, 110, 253, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 4,
                        pointBackgroundColor: '#0d6efd',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                usePointStyle: true,
                                padding: 15
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return 'Sales: ' + formatCurrency(context.parsed.y);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            ticks: {
                                callback: function (value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        // Utility functions
        function formatTime(isoString) {
            const date = new Date(isoString);
            const now = new Date();
            const diffMs = now - date;
            const diffSecs = Math.floor(diffMs / 1000);

            if (diffSecs < 60) return 'Just now';
            if (diffSecs < 3600) return `${Math.floor(diffSecs / 60)}m ago`;
            if (diffSecs < 86400) return `${Math.floor(diffSecs / 3600)}h ago`;
            return date.toLocaleDateString();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function generateColors(count) {
            const colors = [
                '#0d6efd', '#198754', '#ffc107', '#dc3545',
                '#0dcaf0', '#d63384', '#fd7e14', '#6f42c1'
            ];
            const result = [];
            for (let i = 0; i < count; i++) {
                result.push(colors[i % colors.length]);
            }
            return result;
        }

        function updateLastUpdate() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('en-US', { hour12: true });
            document.getElementById('lastUpdate').textContent = `Last update: ${timeString}`;
        }

        function showNotificationToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast-notification`;
            toast.style.backgroundColor = type === 'error' ? '#dc3545' : '#198754';
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function refreshData() {
            loadRealtimeData(true);
        }

        function handleTimeFilterChange() {
            // In a real scenario, this would filter data
            console.log('Time filter changed');
        }

        function handleSortChange() {
            currentSort = document.getElementById('sortFilter').value;
            updateTable();
        }

        // View switching functionality
        let currentView = 'table'; // Default to table view

        function switchView(viewType) {
            currentView = viewType;
            const tableContainer = document.querySelector('.branch-table-container');
            const cardsGrid = document.getElementById('branchCardsGrid');
            const tableBtn = document.getElementById('tableViewBtn');
            const cardBtn = document.getElementById('cardViewBtn');

            if (viewType === 'table') {
                tableContainer.classList.remove('hidden');
                cardsGrid.classList.remove('active');
                tableBtn.classList.add('active');
                cardBtn.classList.remove('active');
            } else {
                tableContainer.classList.add('hidden');
                cardsGrid.classList.add('active');
                tableBtn.classList.remove('active');
                cardBtn.classList.add('active');
                updateCards();
            }

            // Save preference
            localStorage.setItem('branchViewPreference', viewType);
        }

        function updateCards() {
            if (!realtimeSalesData || currentView !== 'card') return;

            const cardsGrid = document.getElementById('branchCardsGrid');
            let branches = realtimeSalesData.branches || [];

            // Apply filters
            const excludeEmpty = document.getElementById('excludeEmpty').checked;
            if (excludeEmpty) {
                branches = branches.filter(b => b.total_sales_today > 0);
            }

            // Apply sorting
            branches = applySorting(branches);

            let html = '';
            branches.forEach(branch => {
                const isActive = branch.transaction_count_today > 0;
                const statusClass = isActive ? 'active' : 'inactive';

                html += `
                    <div class="branch-card status-${statusClass}">
                        <div class="branch-card-pulse ${statusClass}"></div>
                        <div class="branch-card-header">
                            <h3 class="branch-card-title">
                                <i class="bi bi-shop"></i>
                                ${escapeHtml(branch.branch_name)}
                            </h3>
                            <span class="branch-card-status ${statusClass}">
                                ${isActive ? 'Active' : 'Inactive'}
                            </span>
                        </div>

                        <div class="branch-card-metric">
                            <div class="branch-card-metric-label">
                                <i class="bi bi-cash-coin"></i> Sales Today
                            </div>
                            <div class="branch-card-metric-value large">
                                ${formatCurrency(branch.total_sales_today || 0)}
                            </div>
                        </div>

                        <div class="branch-card-metric">
                            <div class="branch-card-metric-label">
                                <i class="bi bi-calendar3"></i> Sales This Month
                            </div>
                            <div class="branch-card-metric-value">
                                ${formatCurrency(branch.total_sales_this_month || 0)}
                            </div>
                        </div>

                        <div class="branch-card-stats">
                            <div class="branch-card-stat">
                                <span class="branch-card-stat-value">
                                    ${formatNumber(branch.transaction_count_today || 0)}
                                </span>
                                <span class="branch-card-stat-label">
                                    <i class="bi bi-receipt"></i> Transactions
                                </span>
                            </div>
                            <div class="branch-card-stat">
                                <span class="branch-card-stat-value">
                                    ${formatCurrency(branch.average_transaction || 0)}
                                </span>
                                <span class="branch-card-stat-label">
                                    <i class="bi bi-graph-up"></i> Avg Value
                                </span>
                            </div>
                        </div>

                        <div class="branch-card-footer">
                            <span>
                                <i class="bi bi-clock"></i> ${formatTime(branch.last_updated)}
                            </span>
                        </div>
                    </div>
                `;
            });

            if (branches.length === 0) {
                html = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 3rem;">
                        <i class="bi bi-inbox" style="font-size: 3rem; color: #6c757d;"></i>
                        <p style="margin-top: 1rem; color: #6c757d;">No branches to display</p>
                    </div>
                `;
            }

            cardsGrid.innerHTML = html;
        }

        function applySorting(branches) {
            const sortBy = document.getElementById('sortFilter').value;
            const sorted = [...branches];

            switch (sortBy) {
                case 'sales':
                    sorted.sort((a, b) => (b.total_sales_today || 0) - (a.total_sales_today || 0));
                    break;
                case 'transactions':
                    sorted.sort((a, b) => (b.transaction_count_today || 0) - (a.transaction_count_today || 0));
                    break;
                case 'average':
                    sorted.sort((a, b) => (b.average_transaction || 0) - (a.average_transaction || 0));
                    break;
                case 'name':
                    sorted.sort((a, b) => a.branch_name.localeCompare(b.branch_name));
                    break;
            }

            return sorted;
        }

        // Restore view preference on page load
        window.addEventListener('DOMContentLoaded', () => {
            const savedView = localStorage.getItem('branchViewPreference');
            if (savedView === 'card') {
                switchView('card');
            }
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            Object.values(charts).forEach(chart => {
                if (chart) chart.destroy();
            });
        });

        // ==================== BRANCH DETAIL MODAL ====================
        let currentBranchId = null;
        let branchDetailModal = null;
        let branchDetailInterval = null;
        let branchHourlyChart = null;

        // Show branch detail modal
        async function showBranchDetail(branchId, branchName) {
            currentBranchId = branchId;

            // Initialize modal if not already done
            if (!branchDetailModal) {
                const modalElement = document.getElementById('branchDetailModal');
                branchDetailModal = new bootstrap.Modal(modalElement);

                // Setup auto-refresh when modal is shown
                modalElement.addEventListener('shown.bs.modal', () => {
                    startBranchDetailRefresh();
                });

                // Stop auto-refresh when modal is closed
                modalElement.addEventListener('hidden.bs.modal', () => {
                    stopBranchDetailRefresh();
                    if (branchHourlyChart) {
                        branchHourlyChart.destroy();
                        branchHourlyChart = null;
                    }
                });
            }

            // Set branch name
            document.getElementById('modalBranchName').textContent = branchName;

            // Show modal
            branchDetailModal.show();

            // Load data
            await loadBranchDetail();
        }

        // Load branch detail data
        async function loadBranchDetail() {
            if (!currentBranchId) return;

            const loadingDiv = document.getElementById('branchDetailLoading');
            const contentDiv = document.getElementById('branchDetailContent');

            loadingDiv.classList.remove('d-none');
            contentDiv.classList.add('d-none');

            try {
                const response = await fetch(`/api/v1/v1/branch-sales/${currentBranchId}/detail?hours=24`);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                // Update metrics
                document.getElementById('detailTotalSales').textContent = formatCurrency(data.total_sales);
                document.getElementById('detailTimeRange').textContent = `Last ${data.hours_covered} hours`;
                document.getElementById('detailTransactionCount').textContent = data.transaction_count;
                document.getElementById('detailAvgTransaction').textContent = `Avg: ${formatCurrency(data.avg_transaction)}`;

                // Last sale
                if (data.last_sale_time) {
                    document.getElementById('detailLastSaleAmount').textContent = formatCurrency(data.last_sale_amount || 0);
                    document.getElementById('detailLastSaleTime').textContent = formatDateTime(data.last_sale_time);
                } else {
                    document.getElementById('detailLastSaleAmount').textContent = 'No sales';
                    document.getElementById('detailLastSaleTime').textContent = 'Never';
                }

                // Payment methods
                const paymentMethodsDiv = document.getElementById('detailPaymentMethods');
                if (data.payment_breakdown && Object.keys(data.payment_breakdown).length > 0) {
                    let paymentHtml = '';
                    for (const [method, amount] of Object.entries(data.payment_breakdown)) {
                        paymentHtml += `<div><small>${method}: ${formatCurrency(amount)}</small></div>`;
                    }
                    paymentMethodsDiv.innerHTML = paymentHtml;
                } else {
                    paymentMethodsDiv.innerHTML = '<div class="text-muted">No data</div>';
                }

                // Recent transactions
                updateRecentTransactions(data.recent_sales || []);

                // Hourly chart
                updateBranchHourlyChart(data.hourly_data || []);

                // Show content
                loadingDiv.classList.add('d-none');
                contentDiv.classList.remove('d-none');

            } catch (error) {
                console.error('Error loading branch detail:', error);
                loadingDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle"></i>
                        Error loading branch data: ${error.message}
                    </div>
                `;
            }
        }

        // Update recent transactions table
        function updateRecentTransactions(sales) {
            const tbody = document.getElementById('recentTransactionsBody');

            if (!sales || sales.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-muted py-4">
                            No transactions in the selected time period
                        </td>
                    </tr>
                `;
                return;
            }

            let html = '';
            sales.forEach(sale => {
                const saleTime = new Date(sale.date);
                const timeStr = saleTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                const customerName = sale.customer_name || 'Walk-in Customer';
                const receiptNum = sale.receipt_number || sale.id?.substring(0, 8) || 'N/A';
                const itemCount = sale.item_count || '-';
                const paymentMethod = sale.payment_method || 'Cash';

                html += `
                    <tr>
                        <td><small>${timeStr}</small></td>
                        <td><small><code>${receiptNum}</code></small></td>
                        <td><small>${escapeHtml(customerName)}</small></td>
                        <td class="text-center"><small>${itemCount}</small></td>
                        <td><small><span class="badge bg-secondary">${paymentMethod}</span></small></td>
                        <td class="text-end"><strong>${formatCurrency(sale.total_amount)}</strong></td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;
        }

        // Update hourly chart
        function updateBranchHourlyChart(hourlyData) {
            const ctx = document.getElementById('branchHourlyChart');

            if (branchHourlyChart) {
                branchHourlyChart.destroy();
            }

            const labels = hourlyData.map(h => {
                const date = new Date(h.hour);
                return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            });

            const salesData = hourlyData.map(h => h.sales_amount);
            const countData = hourlyData.map(h => h.sales_count);

            branchHourlyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Sales Amount',
                            data: salesData,
                            backgroundColor: 'rgba(13, 110, 253, 0.7)',
                            borderColor: 'rgba(13, 110, 253, 1)',
                            borderWidth: 1,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Transaction Count',
                            data: countData,
                            type: 'line',
                            borderColor: 'rgba(25, 135, 84, 1)',
                            backgroundColor: 'rgba(25, 135, 84, 0.1)',
                            borderWidth: 2,
                            yAxisID: 'y1',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Sales Amount'
                            },
                            ticks: {
                                callback: function (value) {
                                    return formatCurrency(value);
                                }
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Transaction Count'
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.datasetIndex === 0) {
                                        label += formatCurrency(context.parsed.y);
                                    } else {
                                        label += context.parsed.y;
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Start auto-refresh for branch detail
        function startBranchDetailRefresh() {
            // Clear any existing interval
            stopBranchDetailRefresh();

            // Refresh every 10 seconds
            branchDetailInterval = setInterval(() => {
                loadBranchDetail();
            }, 10000);
        }

        // Stop auto-refresh
        function stopBranchDetailRefresh() {
            if (branchDetailInterval) {
                clearInterval(branchDetailInterval);
                branchDetailInterval = null;
            }
        }

        // Manual refresh button
        function refreshBranchDetail() {
            loadBranchDetail();
        }

        // Format date and time
        function formatDateTime(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);

            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins} min ago`;
            if (diffMins < 1440) return `${Math.floor(diffMins / 60)} hr ago`;

            return date.toLocaleString('en-US', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
    </script>
</body>

</html>
