<!DOCTYPE html>
<html lang="en" class="light-mode">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CNPERP - General & Subsidiary Ledgers</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --primary-color: #0d6efd;
            --success-color: #198754;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #0dcaf0;
            --dark-color: #212529;
            --light-color: #f8f9fa;
        }

        .light-mode {
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --border-color: #dee2e6;
        }

        .dark-mode {
            --bg-primary: #212529;
            --bg-secondary: #343a40;
            --text-primary: #ffffff;
            --text-secondary: #adb5bd;
            --border-color: #495057;
        }

        body {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            transition: all 0.3s ease;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .card {
            background-color: var(--bg-primary);
            border-color: var(--border-color);
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .navbar {
            background: linear-gradient(135deg, var(--primary-color), #0056b3) !important;
        }

        .stats-card {
            background: linear-gradient(135deg, var(--primary-color), #0056b3);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            transition: transform 0.2s ease;
        }

        .stats-card:hover {
            transform: translateY(-2px);
        }

        .filter-section {
            background-color: var(--bg-primary);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }

        .ledger-card {
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .ledger-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.15);
        }

        .ledger-card.active {
            border-color: var(--primary-color);
            background: linear-gradient(135deg, rgba(13, 110, 253, 0.1), rgba(0, 86, 179, 0.1));
        }

        .account-list-card {
            max-height: 65vh;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--border-color) transparent;
        }

        .account-list-card::-webkit-scrollbar {
            width: 6px;
        }

        .account-list-card::-webkit-scrollbar-track {
            background: transparent;
        }

        .account-list-card::-webkit-scrollbar-thumb {
            background-color: var(--border-color);
            border-radius: 10px;
        }

        .account-item {
            transition: all 0.2s ease;
            border-radius: 8px;
            margin-bottom: 5px;
            padding: 12px 15px;
            border: 1px solid transparent;
        }

        .account-item:hover {
            background-color: var(--bg-secondary);
            transform: translateX(5px);
            border-color: var(--primary-color);
        }

        .account-item.active {
            background: linear-gradient(135deg, var(--primary-color), #0056b3);
            color: white;
        }

        .ledger-table {
            border-radius: 10px;
            overflow: hidden;
        }

        .ledger-table thead {
            background: linear-gradient(135deg, var(--dark-color), #495057);
        }

        .ledger-table tbody tr {
            transition: all 0.2s ease;
        }

        .ledger-table tbody tr:hover {
            background-color: var(--bg-secondary);
            transform: scale(1.01);
        }

        .debit-amount {
            color: var(--danger-color);
            font-weight: bold;
        }

        .credit-amount {
            color: var(--success-color);
            font-weight: bold;
        }

        .balance-amount {
            font-weight: bold;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .balance-positive {
            background-color: rgba(25, 135, 84, 0.1);
            color: var(--success-color);
        }

        .balance-negative {
            background-color: rgba(220, 53, 69, 0.1);
            color: var(--danger-color);
        }

        .customer-item {
            border: none;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .customer-item:hover {
            background-color: var(--hover-color);
            transform: translateX(2px);
        }

        .customer-item.active {
            background-color: var(--primary-color);
            color: white;
        }

        .customer-item.active .text-muted {
            color: rgba(255, 255, 255, 0.8) !important;
        }

        #customerLedgerView .card {
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        #customerDetailsPanel .card {
            border: none;
            background-color: var(--bg-secondary);
        }

        /* Inventory Ledger Styles */
        #inventoryLedgerView .card {
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        #productDetailsPanel .card {
            border: none;
            background-color: var(--bg-secondary);
        }

        .product-item {
            transition: all 0.2s ease;
            border-radius: 8px;
            margin: 2px;
        }

        .product-item:hover {
            background-color: var(--bg-secondary) !important;
            transform: translateX(5px);
        }

        .product-item.active {
            background: linear-gradient(135deg, rgba(13, 202, 240, 0.15), rgba(13, 202, 240, 0.25)) !important;
            border-left: 4px solid var(--info-color);
        }

        .product-item.active strong {
            color: var(--info-color);
        }

        .product-item.active .text-muted {
            color: rgba(255, 255, 255, 0.8) !important;
        }

        .movement-type-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }

        .stock-status-badge {
            font-size: 0.7rem;
            padding: 0.2rem 0.4rem;
        }

        .transaction-type-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }

        .summary-card {
            border-radius: 12px;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            background-color: var(--bg-primary);
        }

        .summary-item {
            background-color: var(--bg-secondary);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            transition: all 0.2s ease;
        }

        .summary-item:hover {
            transform: translateY(-2px);
        }

        .btn {
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .btn:hover {
            transform: translateY(-1px);
        }

        /* Scrollable dropdown styles */
        .dropdown-menu.scrollable-dropdown {
            max-height: 400px;
            overflow-y: auto;
            width: 350px;
        }

        .dropdown-menu.scrollable-dropdown .dropdown-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 1020;
        }

        /* Dark theme support */
        body[data-theme="dark"] .dropdown-menu.scrollable-dropdown {
            background-color: #343a40;
            border-color: #495057;
        }

        body[data-theme="dark"] .dropdown-menu.scrollable-dropdown .dropdown-header {
            background-color: #495057;
            border-bottom-color: #6c757d;
            color: #ffffff;
        }

        body[data-theme="dark"] .dropdown-menu.scrollable-dropdown .dropdown-item {
            color: #ffffff;
        }

        body[data-theme="dark"] .dropdown-menu.scrollable-dropdown .dropdown-item:hover {
            background-color: #495057;
            color: #ffffff;
        }

        /* Print Styles */
        @media print {
            .no-print {
                display: none !important;
            }
            
            /* Hide navigation and other non-essential elements */
            .navbar, .sidebar, .card-header .btn-group, .btn, .dropdown, nav {
                display: none !important;
            }
            
            /* Show only the content area */
            .container-fluid, .row, .col-md-8 {
                margin: 0 !important;
                padding: 0 !important;
                width: 100% !important;
                max-width: 100% !important;
            }
            
            .print-header {
                text-align: center;
                margin-bottom: 20px;
                border-bottom: 2px solid #000;
                padding-bottom: 10px;
            }
            
            .print-title {
                font-size: 24px;
                font-weight: bold;
                margin-bottom: 10px;
            }
            
            .print-subtitle {
                font-size: 16px;
                margin-bottom: 5px;
            }
            
            .print-date {
                font-size: 12px;
                color: #666;
            }
            
            .table {
                font-size: 11px;
            }
            
            .table th {
                border-top: 2px solid #000 !important;
                border-bottom: 1px solid #000 !important;
                background-color: #f8f9fa !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            .table td {
                border-bottom: 1px solid #ddd !important;
            }
            
            .customer-summary {
                border: 1px solid #000;
                padding: 10px;
                margin-bottom: 20px;
                background-color: #f8f9fa;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            .account-summary {
                border: 1px solid #000;
                padding: 10px;
                margin-bottom: 20px;
                background-color: #f8f9fa;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            .product-summary {
                border: 1px solid #000;
                padding: 10px;
                margin-bottom: 20px;
                background-color: #f8f9fa;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            .inventory-ledger-print {
                margin: 0;
                padding: 20px;
            }
            
            .inventory-ledger-print .card-header,
            .inventory-ledger-print .btn,
            .inventory-ledger-print .dropdown,
            .inventory-ledger-print .form-control,
            .inventory-ledger-print .input-group {
                display: none !important;
            }
            
            .page-break {
                page-break-before: always;
            }
            
            .print-footer {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                text-align: center;
                font-size: 10px;
                color: #666;
                border-top: 1px solid #ddd;
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation Bar Container -->
    <div id="navbar-container"></div>
    <!-- Navbar Scripts -->
    <script src="js/navbar.js?v=20250106001"></script>
    
    <!-- Spacer to prevent content from being hidden under fixed navbar -->
    <div style="height: 70px;"></div>

    <div class="container-fluid mt-4">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="h3 mb-0">
                    <i class="bi bi-journal-text text-primary me-2"></i>General & Subsidiary Ledgers
                </h1>
                <p class="text-muted mb-0">Comprehensive ledger views and transaction analysis</p>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-outline-primary" onclick="openLedgerFilters()">
                    <i class="bi bi-funnel me-2"></i>Advanced Filters
                </button>
                <button class="btn btn-primary" onclick="generateLedgerReport()">
                    <i class="bi bi-file-earmark-text me-2"></i>Generate Report
                </button>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="row mb-4">
            <div class="col-md-2">
                <div class="stats-card">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="mb-1">Total Accounts</h6>
                            <h3 class="mb-0" id="totalAccounts">0</h3>
                        </div>
                        <i class="bi bi-list fs-1"></i>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="stats-card">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="mb-1">Active Accounts</h6>
                            <h3 class="mb-0" id="activeAccounts">0</h3>
                        </div>
                        <i class="bi bi-check-circle fs-1"></i>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="stats-card">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="mb-1">Total Entries</h6>
                            <h3 class="mb-0" id="totalEntries">0</h3>
                        </div>
                        <i class="bi bi-journal-text fs-1"></i>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="stats-card">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="mb-1">Total Debits</h6>
                            <h3 class="mb-0" id="totalDebits">P 0.00</h3>
                        </div>
                        <i class="bi bi-arrow-down-circle fs-1"></i>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="stats-card">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="mb-1">Total Credits</h6>
                            <h3 class="mb-0" id="totalCredits">P 0.00</h3>
                        </div>
                        <i class="bi bi-arrow-up-circle fs-1"></i>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="stats-card">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="mb-1">Net Balance</h6>
                            <h3 class="mb-0" id="netBalance">P 0.00</h3>
                        </div>
                        <i class="bi bi-calculator fs-1"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ledger Type Selection Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card ledger-card border-primary" onclick="showGeneralLedger()">
                    <div class="card-body text-center">
                        <i class="bi bi-journal-text fs-1 text-primary mb-3"></i>
                        <h5>General Ledger</h5>
                        <p class="text-muted">Complete account ledgers</p>
                        <span class="badge bg-primary">All Accounts</span>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card ledger-card border-success" onclick="showCustomerLedger()">
                    <div class="card-body text-center">
                        <i class="bi bi-people fs-1 text-success mb-3"></i>
                        <h5>Customer Ledger</h5>
                        <p class="text-muted">Accounts receivable details</p>
                        <span class="badge bg-success">Debtors</span>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card ledger-card border-warning" onclick="showSupplierLedger()">
                    <div class="card-body text-center">
                        <i class="bi bi-building fs-1 text-warning mb-3"></i>
                        <h5>Supplier Ledger</h5>
                        <p class="text-muted">Accounts payable details</p>
                        <span class="badge bg-warning text-dark">Creditors</span>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card ledger-card border-info" onclick="showInventoryLedger()">
                    <div class="card-body text-center">
                        <i class="bi bi-box-seam fs-1 text-info mb-3"></i>
                        <h5>Inventory Ledger</h5>
                        <p class="text-muted">Stock movement tracking</p>
                        <span class="badge bg-info">Stock</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="filter-section">
            <div class="row">
                <div class="col-md-2">
                    <label class="form-label">Account Type</label>
                    <select class="form-select" id="accountTypeFilter">
                        <option value="">All Types</option>
                        <option value="asset">Assets</option>
                        <option value="liability">Liabilities</option>
                        <option value="equity">Equity</option>
                        <option value="revenue">Revenue</option>
                        <option value="expense">Expenses</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Account</label>
                    <select class="form-select" id="accountFilter">
                        <option value="">All Accounts</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">From Date</label>
                    <input type="date" class="form-control" id="fromDateFilter">
                </div>
                <div class="col-md-2">
                    <label class="form-label">To Date</label>
                    <input type="date" class="form-control" id="toDateFilter">
                </div>
                <div class="col-md-2">
                    <label class="form-label">Search</label>
                    <input type="text" class="form-control" id="searchFilter" placeholder="Search transactions...">
                </div>
                <div class="col-md-2">
                    <label class="form-label">&nbsp;</label>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-secondary" onclick="clearFilters()">
                            <i class="bi bi-arrow-clockwise"></i> Clear
                        </button>
                        <button class="btn btn-outline-primary" onclick="exportLedger()">
                            <i class="bi bi-download"></i> Export
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Ledger Content -->
        <div class="row">
            <!-- Account List -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">
                                <i class="bi bi-list me-2"></i>Chart of Accounts
                            </h6>
                            <button class="btn btn-sm btn-light" id="refreshAccountsBtn">
                                <i class="bi bi-arrow-clockwise"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="account-list-card" id="accountsList">
                            <div class="text-center py-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2 text-muted">Loading accounts...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ledger Details -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header bg-light">
                        <div class="d-flex justify-content-between align-items-center">
                            <h6 class="mb-0" id="selectedAccountName">Select an account to view ledger</h6>
                            <div class="d-flex gap-2">
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-outline-primary btn-sm dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false" id="exportLedgerBtn" disabled>
                                        <i class="bi bi-download"></i> Export
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item" href="#" onclick="printGeneralLedger()"><i class="fas fa-print me-2"></i>Print</a></li>
                                        <li><a class="dropdown-item" href="#" onclick="exportGeneralLedger('pdf')"><i class="fas fa-file-pdf me-2"></i>Export PDF</a></li>
                                        <li><a class="dropdown-item" href="#" onclick="exportGeneralLedger('excel')"><i class="fas fa-file-excel me-2"></i>Export Excel</a></li>
                                        <li><a class="dropdown-item" href="#" onclick="exportGeneralLedger('csv')"><i class="fas fa-file-csv me-2"></i>Export CSV</a></li>
                                    </ul>
                                </div>
                                <button class="btn btn-outline-secondary btn-sm" onclick="refreshLedger()" id="refreshLedgerBtn">
                                    <i class="bi bi-arrow-clockwise"></i> Refresh
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Account Summary -->
                        <div class="row mb-3" id="accountSummary" style="display: none;">
                            <div class="col-md-3">
                                <div class="summary-item">
                                    <small class="text-muted">Opening Balance</small>
                                    <div class="fw-bold" id="openingBalance">P 0.00</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="summary-item">
                                    <small class="text-muted">Total Debits</small>
                                    <div class="fw-bold debit-amount" id="totalDebitsDetail">P 0.00</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="summary-item">
                                    <small class="text-muted">Total Credits</small>
                                    <div class="fw-bold credit-amount" id="totalCreditsDetail">P 0.00</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="summary-item bg-primary text-white">
                                    <small>Closing Balance</small>
                                    <div class="fw-bold" id="closingBalance">P 0.00</div>
                                </div>
                            </div>
                        </div>

                        <!-- Transactions Table -->
                        <div class="table-responsive">
                            <table class="table table-striped table-hover ledger-table">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Date</th>
                                        <th>Reference</th>
                                        <th>Description</th>
                                        <th class="text-end">Debit</th>
                                        <th class="text-end">Credit</th>
                                        <th class="text-end">Balance</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="transactionsTableBody">
                                    <tr>
                                        <td colspan="7" class="text-center text-muted py-4">
                                            <i class="bi bi-info-circle me-2"></i>Select an account to view transactions
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    
    
    <!-- Modern Interactions -->
    <script src="/static/js/modern-interactions.js"></script>

    <script>
        // Global data storage
        let ledgerEntries = [];
        let accountingCodes = [];
        let currentAccountId = null;
        let loading = false;

        // Currency settings
        let currentCurrency = 'BWP';
        let currencySymbol = 'P';
        let currencyCode = 'BWP';

        // API endpoints - Updated for new IFRS-compliant general ledger
        const API_BASE = '/api/v1';
        const GENERAL_LEDGER_ENDPOINT = `${API_BASE}/general-ledger`;

        // Format currency amount
        function formatCurrency(amount) {
            return `${currencySymbol} ${parseFloat(amount).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
        }

        // Format date
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-GB');
        }

        // Get account type badge color
        function getAccountTypeBadge(type) {
            if (!type) return 'secondary';
            const typeMap = {
                'asset': 'primary',
                'liability': 'warning',
                'equity': 'info',
                'revenue': 'success',
                'expense': 'danger'
            };
            return typeMap[type.toLowerCase()] || 'secondary';
        }

        // Fetch chart of accounts using new IFRS endpoint
        async function fetchAccountingCodes() {
            try {
                const response = await fetch(`${GENERAL_LEDGER_ENDPOINT}/chart-of-accounts`);
                if (!response.ok) throw new Error('Failed to fetch chart of accounts');
                
                accountingCodes = await response.json();
                
                // Flatten hierarchical structure for easier use
                const flatAccounts = [];
                function flattenAccounts(accounts, level = 0) {
                    accounts.forEach(account => {
                        account.level = level;
                        flatAccounts.push(account);
                        if (account.children && account.children.length > 0) {
                            flattenAccounts(account.children, level + 1);
                        }
                    });
                }
                flattenAccounts(accountingCodes);
                accountingCodes = flatAccounts;
                
                renderAccountsList();
                updateStatsCards();
                
                // Populate account filter dropdown
                const accountFilter = document.getElementById('accountFilter');
                if (accountFilter) {
                    accountFilter.innerHTML = '<option value="">All Accounts</option>';
                    accountingCodes.forEach(account => {
                        const option = document.createElement('option');
                        option.value = account.code;
                        option.textContent = `${account.code} - ${account.name}`;
                        accountFilter.appendChild(option);
                    });
                }
                
            } catch (error) {
                console.error('Error fetching chart of accounts:', error);
                const accountsList = document.getElementById('accountsList');
                if (accountsList) {
                    accountsList.innerHTML = `
                        <div class="text-center py-4">
                            <i class="bi bi-exclamation-triangle text-warning fs-1"></i>
                            <p class="mt-2 text-danger">Failed to load accounts</p>
                            <button class="btn btn-sm btn-outline-primary" onclick="fetchAccountingCodes()">
                                <i class="bi bi-arrow-clockwise"></i> Retry
                            </button>
                        </div>
                    `;
                }
            }
        }

        // Render accounts list with hierarchical structure
        function renderAccountsList() {
            const accountsList = document.getElementById('accountsList');
            if (!accountsList) return;
            
            if (!accountingCodes.length) {
                accountsList.innerHTML = `
                    <div class="text-center py-4">
                        <i class="bi bi-inbox text-muted fs-1"></i>
                        <p class="mt-2 text-muted">No accounts found</p>
                    </div>
                `;
                return;
            }

            accountsList.innerHTML = '';
            
            accountingCodes.forEach(account => {
                const accountItem = document.createElement('div');
                accountItem.className = 'account-item';
                
                // Add indentation for child accounts
                const indent = '&nbsp;'.repeat(account.level * 4);
                const isParent = account.is_parent ? '<i class="bi bi-folder text-warning me-1"></i>' : '<i class="bi bi-circle-fill text-primary me-1" style="font-size: 0.5rem;"></i>';
                
                accountItem.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            ${indent}${isParent}<strong>${account.code}</strong>
                            <div class="small text-muted" style="margin-left: ${account.level * 16 + 16}px;">${account.name}</div>
                            <div class="small" style="margin-left: ${account.level * 16 + 16}px;">
                                Balance: <span class="${account.balance >= 0 ? 'text-success' : 'text-danger'}">${formatCurrency(account.balance)}</span>
                            </div>
                        </div>
                        <div class="text-end">
                            <span class="badge bg-${getAccountTypeBadge(account.account_type)}">
                                ${account.account_type || 'N/A'}
                            </span>
                            <div class="small text-muted mt-1">${account.normal_balance || ''}</div>
                        </div>
                    </div>
                `;
                
                accountItem.onclick = () => selectAccount(account);
                accountsList.appendChild(accountItem);
            });
        }

        // Select account and fetch its specific ledger
        async function selectAccount(account) {
            currentAccountId = account.id;
            
            // Update UI
            const selectedAccountNameEl = document.getElementById('selectedAccountName');
            if (selectedAccountNameEl) {
                selectedAccountNameEl.textContent = `${account.code} - ${account.name}`;
            }
            
            const exportBtn = document.getElementById('exportLedgerBtn');
            const printBtn = document.getElementById('printLedgerBtn');
            if (exportBtn) exportBtn.disabled = true;
            if (printBtn) printBtn.disabled = true;
            
            // Highlight selected account
            document.querySelectorAll('.account-item').forEach(item => {
                item.classList.remove('active');
            });
            event.currentTarget.classList.add('active');
            
            await fetchAccountLedger();
        }

        // Fetch specific account ledger using new IFRS endpoint
        async function fetchAccountLedger() {
            if (!currentAccountId) return;

            const tbody = document.getElementById('transactionsTableBody');
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center py-4">
                        <div class="spinner-border spinner-border-sm text-primary"></div>
                        <span class="ms-2">Loading transactions...</span>
                    </td>
                </tr>
            `;

            try {
                const params = new URLSearchParams();
                
                const fromDate = document.getElementById('fromDateFilter').value;
                const toDate = document.getElementById('toDateFilter').value;
                
                if (fromDate) params.append('from_date', fromDate);
                if (toDate) params.append('to_date', toDate);

                const response = await fetch(`${GENERAL_LEDGER_ENDPOINT}/account-ledger/${currentAccountId}?${params}`);
                if (!response.ok) throw new Error('Failed to fetch account ledger');

                const accountLedgerData = await response.json();
                ledgerEntries = accountLedgerData.entries;
                
                renderLedgerTable();
                updateAccountSummary(accountLedgerData);
                
                // Enable/disable export button based on data availability
                const exportBtn = document.getElementById('exportLedgerBtn');
                if (exportBtn) {
                    exportBtn.disabled = !ledgerEntries.length;
                }

            } catch (error) {
                console.error('Error fetching account ledger:', error);
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-4">
                            <i class="bi bi-exclamation-triangle text-warning"></i>
                            <span class="ms-2 text-danger">Failed to load transactions</span>
                        </td>
                    </tr>
                `;
            }
        }

        // Fetch general ledger entries for overview
        async function fetchGeneralLedgerEntries() {
            const tbody = document.getElementById('transactionsTableBody');
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center py-4">
                        <div class="spinner-border spinner-border-sm text-primary"></div>
                        <span class="ms-2">Loading transactions...</span>
                    </td>
                </tr>
            `;

            try {
                const params = new URLSearchParams();
                params.append('limit', '500'); // Increased limit for comprehensive view
                
                const accountType = document.getElementById('accountTypeFilter').value;
                const accountCode = document.getElementById('accountFilter').value;
                const fromDate = document.getElementById('fromDateFilter').value;
                const toDate = document.getElementById('toDateFilter').value;
                const search = document.getElementById('searchFilter').value;
                
                if (accountType) params.append('account_type', accountType);
                if (accountCode) params.append('account_code', accountCode);
                if (fromDate) params.append('from_date', fromDate);
                if (toDate) params.append('to_date', toDate);
                if (search) params.append('search', search);

                const response = await fetch(`${GENERAL_LEDGER_ENDPOINT}/general-ledger?${params}`);
                if (!response.ok) throw new Error('Failed to fetch general ledger');

                const generalLedgerData = await response.json();
                ledgerEntries = generalLedgerData.entries;
                
                renderGeneralLedgerTable();
                updateGeneralLedgerSummary(generalLedgerData.summary);
                
                // Enable/disable export button based on data availability
                const exportBtn = document.getElementById('exportLedgerBtn');
                if (exportBtn) {
                    exportBtn.disabled = !ledgerEntries.length;
                }

            } catch (error) {
                console.error('Error fetching general ledger:', error);
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-4">
                            <i class="bi bi-exclamation-triangle text-warning"></i>
                            <span class="ms-2 text-danger">Failed to load transactions</span>
                        </td>
                    </tr>
                `;
            }
        }

        // Render account-specific ledger table
        function renderLedgerTable() {
            const tbody = document.getElementById('transactionsTableBody');
            
            if (!ledgerEntries.length) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-4">
                            <i class="bi bi-inbox text-muted"></i>
                            <span class="ms-2 text-muted">No transactions found</span>
                        </td>
                    </tr>
                `;
                return;
            }

            const rows = [];
            
            ledgerEntries.forEach(entry => {
                const balanceClass = entry.running_balance >= 0 ? 'balance-positive' : 'balance-negative';
                
                rows.push(`
                    <tr>
                        <td>${formatDate(entry.date)}</td>
                        <td>${entry.reference || ''}</td>
                        <td>
                            <div>${entry.description}</div>
                            <small class="text-muted">${entry.particulars || ''}</small>
                        </td>
                        <td class="text-end">${entry.debit_amount > 0 ? `<span class="debit-amount">${formatCurrency(entry.debit_amount)}</span>` : ''}</td>
                        <td class="text-end">${entry.credit_amount > 0 ? `<span class="credit-amount">${formatCurrency(entry.credit_amount)}</span>` : ''}</td>
                        <td class="text-end">
                            <span class="balance-amount ${balanceClass}">
                                ${formatCurrency(Math.abs(entry.running_balance))}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-secondary" onclick="viewEntry('${entry.id}')">
                                <i class="bi bi-eye"></i>
                            </button>
                        </td>
                    </tr>
                `);
            });
            
            tbody.innerHTML = rows.join('');
        }

        // Render general ledger table (multi-account view)
        function renderGeneralLedgerTable() {
            const tbody = document.getElementById('transactionsTableBody');
            
            if (!ledgerEntries.length) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-4">
                            <i class="bi bi-inbox text-muted"></i>
                            <span class="ms-2 text-muted">No transactions found</span>
                        </td>
                    </tr>
                `;
                return;
            }

            const rows = [];
            
            ledgerEntries.forEach(entry => {
                const balanceClass = entry.running_balance >= 0 ? 'balance-positive' : 'balance-negative';
                
                rows.push(`
                    <tr>
                        <td>${formatDate(entry.date)}</td>
                        <td>${entry.reference || ''}</td>
                        <td>
                            <div><strong>${entry.account_code}</strong> - ${entry.account_name}</div>
                            <div class="small">${entry.description}</div>
                            <small class="text-muted">${entry.particulars || ''}</small>
                        </td>
                        <td class="text-end">${entry.debit_amount > 0 ? `<span class="debit-amount">${formatCurrency(entry.debit_amount)}</span>` : ''}</td>
                        <td class="text-end">${entry.credit_amount > 0 ? `<span class="credit-amount">${formatCurrency(entry.credit_amount)}</span>` : ''}</td>
                        <td class="text-end">
                            <span class="balance-amount ${balanceClass}">
                                ${formatCurrency(Math.abs(entry.running_balance))}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-secondary" onclick="viewEntry('${entry.id}')">
                                <i class="bi bi-eye"></i>
                            </button>
                        </td>
                    </tr>
                `);
            });
            
            tbody.innerHTML = rows.join('');
        }

        // Update account summary with new data structure
        function updateAccountSummary(accountLedgerData) {
            const summary = document.getElementById('accountSummary');
            
            if (!accountLedgerData || !accountLedgerData.entries.length) {
                summary.style.display = 'none';
                return;
            }

            document.getElementById('openingBalance').textContent = formatCurrency(accountLedgerData.opening_balance);
            document.getElementById('totalDebitsDetail').textContent = formatCurrency(
                accountLedgerData.entries.reduce((sum, entry) => sum + entry.debit_amount, 0)
            );
            document.getElementById('totalCreditsDetail').textContent = formatCurrency(
                accountLedgerData.entries.reduce((sum, entry) => sum + entry.credit_amount, 0)
            );
            document.getElementById('closingBalance').textContent = formatCurrency(accountLedgerData.closing_balance);

            summary.style.display = 'flex';
        }

        // Update general ledger summary
        function updateGeneralLedgerSummary(summaryData) {
            const summary = document.getElementById('accountSummary');
            
            if (!summaryData) {
                summary.style.display = 'none';
                return;
            }

            document.getElementById('openingBalance').textContent = 'N/A';
            document.getElementById('totalDebitsDetail').textContent = formatCurrency(summaryData.total_debits);
            document.getElementById('totalCreditsDetail').textContent = formatCurrency(summaryData.total_credits);
            document.getElementById('closingBalance').textContent = formatCurrency(summaryData.net_difference);

            summary.style.display = 'flex';
        }

        // Update stats cards with new API data
        async function updateStatsCards() {
            try {
                // Get statistics from new endpoint
                const response = await fetch(`${GENERAL_LEDGER_ENDPOINT}/statistics`);
                if (response.ok) {
                    const stats = await response.json();
                    
                    const totalAccountsEl = document.getElementById('totalAccounts');
                    const activeAccountsEl = document.getElementById('activeAccounts');
                    const totalTransactionsEl = document.getElementById('totalEntries');
                    
                    if (totalAccountsEl) totalAccountsEl.textContent = stats.account_counts.total_accounts;
                    if (activeAccountsEl) activeAccountsEl.textContent = stats.account_counts.total_accounts;
                    if (totalTransactionsEl) totalTransactionsEl.textContent = stats.transaction_stats.total_entries;
                    
                    // Show balance status
                    if (totalAccountsEl) {
                        const balanceStatus = document.createElement('div');
                        balanceStatus.className = `small ${stats.trial_balance_status.is_balanced ? 'text-success' : 'text-danger'}`;
                        balanceStatus.innerHTML = `<i class="bi bi-${stats.trial_balance_status.is_balanced ? 'check-circle' : 'exclamation-circle'}"></i> ${stats.trial_balance_status.is_balanced ? 'Balanced' : 'Unbalanced'}`;
                        
                        const totalAccountsElement = totalAccountsEl.parentElement;
                        const existingStatus = totalAccountsElement.querySelector('.balance-status');
                        if (existingStatus) existingStatus.remove();
                        balanceStatus.classList.add('balance-status');
                        totalAccountsElement.appendChild(balanceStatus);
                    }
                    
                } else {
                    // Fallback to local data
                    const totalAccountsEl = document.getElementById('totalAccounts');
                    const activeAccountsEl = document.getElementById('activeAccounts');
                    if (totalAccountsEl) totalAccountsEl.textContent = accountingCodes.length;
                    if (activeAccountsEl) activeAccountsEl.textContent = accountingCodes.filter(a => a.active !== false).length;
                }
            } catch (error) {
                console.error('Error updating stats:', error);
                // Fallback to local data
                const totalAccountsEl = document.getElementById('totalAccounts');
                const activeAccountsEl = document.getElementById('activeAccounts');
                if (totalAccountsEl) totalAccountsEl.textContent = accountingCodes.length;
                if (activeAccountsEl) activeAccountsEl.textContent = accountingCodes.filter(a => a.active !== false).length;
            }
            
            if (ledgerEntries.length) {
                const totalDebits = ledgerEntries.reduce((sum, entry) => sum + Number(entry.debit || 0), 0);
                const totalCredits = ledgerEntries.reduce((sum, entry) => sum + Number(entry.credit || 0), 0);
                const netBalance = totalDebits - totalCredits;
                
                const totalEntriesEl = document.getElementById('totalEntries');
                const totalDebitsEl = document.getElementById('totalDebits');
                const totalCreditsEl = document.getElementById('totalCredits');
                const netBalanceEl = document.getElementById('netBalance');
                
                if (totalEntriesEl) totalEntriesEl.textContent = ledgerEntries.length;
                if (totalDebitsEl) totalDebitsEl.textContent = formatCurrency(totalDebits);
                if (totalCreditsEl) totalCreditsEl.textContent = formatCurrency(totalCredits);
                if (netBalanceEl) netBalanceEl.textContent = formatCurrency(netBalance);
            }
        }

        // Filter functions
        function applyFilters() {
            // Reset current selection and show general ledger
            currentAccountId = null;
            const selectedAccountNameEl = document.getElementById('selectedAccountName');
            if (selectedAccountNameEl) {
                selectedAccountNameEl.textContent = 'All Accounts';
            }
            document.querySelectorAll('.account-item').forEach(item => {
                item.classList.remove('active');
            });
            
            fetchGeneralLedgerEntries();
        }

        // Clear all filters
        function clearAllFilters() {
            document.getElementById('accountFilter').value = '';
            document.getElementById('accountTypeFilter').value = '';
            document.getElementById('fromDateFilter').value = '';
            document.getElementById('toDateFilter').value = '';
            document.getElementById('searchFilter').value = '';
            
            applyFilters();
        }

        // Show trial balance
        async function showTrialBalance() {
            try {
                const response = await fetch(`${GENERAL_LEDGER_ENDPOINT}/trial-balance`);
                if (!response.ok) throw new Error('Failed to fetch trial balance');
                
                const trialBalance = await response.json();
                
                // Create modal for trial balance
                const modal = document.createElement('div');
                modal.className = 'modal fade';
                modal.innerHTML = `
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="bi bi-bar-chart text-primary"></i>
                                    Trial Balance as of ${trialBalance.as_of_date}
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row mb-3">
                                    <div class="col-md-4">
                                        <div class="card text-center">
                                            <div class="card-body">
                                                <h6>Total Debits</h6>
                                                <h4 class="text-danger">${formatCurrency(trialBalance.totals.total_debits)}</h4>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card text-center">
                                            <div class="card-body">
                                                <h6>Total Credits</h6>
                                                <h4 class="text-success">${formatCurrency(trialBalance.totals.total_credits)}</h4>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card text-center ${trialBalance.totals.is_balanced ? 'bg-success' : 'bg-danger'} text-white">
                                            <div class="card-body">
                                                <h6>Status</h6>
                                                <h4>
                                                    <i class="bi bi-${trialBalance.totals.is_balanced ? 'check-circle' : 'exclamation-circle'}"></i>
                                                    ${trialBalance.totals.is_balanced ? 'Balanced' : 'Unbalanced'}
                                                </h4>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-striped">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>Account Code</th>
                                                <th>Account Name</th>
                                                <th>Type</th>
                                                <th class="text-end">Debit Balance</th>
                                                <th class="text-end">Credit Balance</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${trialBalance.trial_balance.map(account => `
                                                <tr>
                                                    <td><strong>${account.account_code}</strong></td>
                                                    <td>${account.account_name}</td>
                                                    <td><span class="badge bg-${getAccountTypeBadge(account.account_type)}">${account.account_type || 'N/A'}</span></td>
                                                    <td class="text-end">${account.debit_balance > 0 ? `<span class="text-danger">${formatCurrency(account.debit_balance)}</span>` : ''}</td>
                                                    <td class="text-end">${account.credit_balance > 0 ? `<span class="text-success">${formatCurrency(account.credit_balance)}</span>` : ''}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                        <tfoot class="table-dark">
                                            <tr>
                                                <th colspan="3">TOTAL</th>
                                                <th class="text-end text-danger">${formatCurrency(trialBalance.totals.total_debits)}</th>
                                                <th class="text-end text-success">${formatCurrency(trialBalance.totals.total_credits)}</th>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <button type="button" class="btn btn-primary" onclick="exportTrialBalance()">
                                    <i class="bi bi-download"></i> Export
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                const modalInstance = new bootstrap.Modal(modal);
                modalInstance.show();
                
                // Clean up modal when hidden
                modal.addEventListener('hidden.bs.modal', () => {
                    document.body.removeChild(modal);
                });
                
            } catch (error) {
                console.error('Error showing trial balance:', error);
                alert('Failed to load trial balance. Please try again.');
            }
        }

        // View entry details
        function viewEntry(entryId) {
            if (!entryId) return;
            // Placeholder - implement entry detail view
            console.log('View entry:', entryId);
            alert('Entry detail view - Coming soon!');
        }

        // Export functions
        function exportLedger() {
            if (!ledgerEntries.length) {
                alert('No data to export');
                return;
            }
            
            // Create CSV content
            const headers = ['Date', 'Reference', 'Description', 'Debit', 'Credit', 'Balance'];
            const csvContent = [
                headers.join(','),
                ...ledgerEntries.map(entry => [
                    entry.date,
                    `"${entry.reference || ''}"`,
                    `"${entry.description || ''}"`,
                    entry.debit_amount || 0,
                    entry.credit_amount || 0,
                    entry.running_balance || 0
                ].join(','))
            ].join('\n');
            
            // Download file
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ledger_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function printLedger() {
            if (!ledgerEntries.length) {
                alert('No data to print');
                return;
            }
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>General Ledger</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f2f2f2; }
                        .text-end { text-align: right; }
                        .debit { color: #d63384; font-weight: bold; }
                        .credit { color: #198754; font-weight: bold; }
                    </style>
                </head>
                <body>
                    <h1>General Ledger</h1>
                    <p>Generated on: ${new Date().toLocaleDateString()}</p>
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Reference</th>
                                <th>Description</th>
                                <th>Debit</th>
                                <th>Credit</th>
                                <th>Balance</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${ledgerEntries.map(entry => `
                                <tr>
                                    <td>${formatDate(entry.date)}</td>
                                    <td>${entry.reference || ''}</td>
                                    <td>${entry.description || ''}</td>
                                    <td class="text-end ${entry.debit_amount > 0 ? 'debit' : ''}">${entry.debit_amount > 0 ? formatCurrency(entry.debit_amount) : ''}</td>
                                    <td class="text-end ${entry.credit_amount > 0 ? 'credit' : ''}">${entry.credit_amount > 0 ? formatCurrency(entry.credit_amount) : ''}</td>
                                    <td class="text-end">${formatCurrency(entry.running_balance)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Load navbar using the included script
            try {
                if (typeof createNavbar === 'function') {
                    createNavbar();
                } else if (typeof loadNavbar === 'function') {
                    loadNavbar();
                } else {
                    console.warn('Navbar loading function not found');
                }
            } catch (error) {
                console.error('Error loading navbar:', error);
            }
            
            // Load initial data
            fetchAccountingCodes();
            
            // Set up filter event listeners with null checks
            const accountFilter = document.getElementById('accountFilter');
            const accountTypeFilter = document.getElementById('accountTypeFilter');
            const fromDateFilter = document.getElementById('fromDateFilter');
            const toDateFilter = document.getElementById('toDateFilter');
            const searchFilter = document.getElementById('searchFilter');
            
            if (accountFilter) accountFilter.addEventListener('change', applyFilters);
            if (accountTypeFilter) accountTypeFilter.addEventListener('change', applyFilters);
            if (fromDateFilter) fromDateFilter.addEventListener('change', applyFilters);
            if (toDateFilter) toDateFilter.addEventListener('change', applyFilters);
            if (searchFilter) searchFilter.addEventListener('input', debounce(applyFilters, 500));
            
            // Set up button event listeners - Export now uses dropdown, no direct click needed
            // document.getElementById('clearFiltersBtn').addEventListener('click', clearAllFilters);
            // document.getElementById('trialBalanceBtn').addEventListener('click', showTrialBalance);
            // Export button now uses dropdown menu instead of direct click
            
            // Load general ledger by default
            setTimeout(() => {
                fetchGeneralLedgerEntries();
            }, 1000);
        });

        // Utility function for debouncing
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Missing function implementations
        function showGeneralLedger() {
            console.log('Showing general ledger...');
            
            // Hide customer ledger view if it exists
            const customerView = document.getElementById('customerLedgerView');
            if (customerView) {
                customerView.style.display = 'none';
            }
            
            // Hide inventory ledger view if it exists
            const inventoryView = document.getElementById('inventoryLedgerView');
            if (inventoryView) {
                inventoryView.style.display = 'none';
            }
            
            // Show the original account list and general ledger
            const mainRow = document.querySelector('.row:has(.col-md-4)');
            if (mainRow) {
                const accountsList = mainRow.querySelector('.col-md-4');
                const generalLedger = mainRow.querySelector('.col-md-8');
                
                if (accountsList) accountsList.style.display = 'block';
                if (generalLedger) generalLedger.style.display = 'block';
            }
            
            // Reset filters and show general ledger view
            clearAllFilters();
            applyFilters();
        }

        function showCustomerLedger() {
            console.log('Showing customer ledger...');
            
            // Hide inventory ledger view if it exists
            const inventoryView = document.getElementById('inventoryLedgerView');
            if (inventoryView) {
                inventoryView.style.display = 'none';
            }
            
            // Hide general ledger view and show customer-specific view
            const generalView = document.querySelector('.col-md-8');
            const accountsList = document.querySelector('.col-md-4');
            
            if (generalView && accountsList) {
                // Create customer ledger container
                createCustomerLedgerView();
                fetchCustomers();
            }
        }

        function showSupplierLedger() {
            console.log('Showing supplier ledger...');
            // Filter to show only supplier accounts
            document.getElementById('accountTypeFilter').value = 'liability';
            applyFilters();
        }

        function showInventoryLedger() {
            console.log('Showing inventory ledger...');
            
            // Hide general ledger view and show inventory-specific view
            const generalView = document.querySelector('.col-md-8');
            const accountsList = document.querySelector('.col-md-4');
            
            if (generalView && accountsList) {
                // Create inventory ledger container
                createInventoryLedgerView();
                fetchInventoryProducts();
            }
        }

        function generateLedgerReport() {
            console.log('Generating ledger report...');
            // Show trial balance modal
            showTrialBalance();
        }

        function openLedgerFilters() {
            console.log('Opening advanced filters...');
            // Focus on the filters section
            document.getElementById('accountFilter').focus();
        }

        function exportLedger() {
            console.log('Exporting ledger...');
            // Legacy function - redirect to new export
            exportGeneralLedger('csv');
        }

        function printLedger() {
            console.log('Printing ledger...');
            // Legacy function - redirect to new print
            printGeneralLedger();
        }

        function clearFilters() {
            console.log('Clearing filters...');
            clearAllFilters();
        }

        // Customer Ledger Functions
        function createCustomerLedgerView() {
            const mainRow = document.querySelector('.row:has(.col-md-4)');
            if (!mainRow) return;
            
            // Hide the current account list and general ledger
            const accountsList = mainRow.querySelector('.col-md-4');
            const generalLedger = mainRow.querySelector('.col-md-8');
            
            if (accountsList) accountsList.style.display = 'none';
            if (generalLedger) generalLedger.style.display = 'none';
            
            // Create customer ledger view
            let customerView = document.getElementById('customerLedgerView');
            if (!customerView) {
                customerView = document.createElement('div');
                customerView.id = 'customerLedgerView';
                customerView.className = 'col-12';
                customerView.innerHTML = `
                    <div class="row">
                        <!-- Customer List -->
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header bg-success text-white">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0">
                                            <i class="bi bi-people me-2"></i>Customers
                                        </h6>
                                        <div class="d-flex gap-2">
                                            <div class="btn-group" role="group">
                                                <button type="button" class="btn btn-sm btn-light dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                                    <i class="fas fa-download"></i>
                                                </button>
                                                <ul class="dropdown-menu">
                                                    <li><a class="dropdown-item" href="#" onclick="exportCustomerList('pdf')"><i class="fas fa-file-pdf me-2"></i>Export PDF</a></li>
                                                    <li><a class="dropdown-item" href="#" onclick="exportCustomerList('excel')"><i class="fas fa-file-excel me-2"></i>Export Excel</a></li>
                                                    <li><a class="dropdown-item" href="#" onclick="exportCustomerList('csv')"><i class="fas fa-file-csv me-2"></i>Export CSV</a></li>
                                                </ul>
                                            </div>
                                            <button class="btn btn-sm btn-light" id="refreshCustomersBtn">
                                                <i class="bi bi-arrow-clockwise"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-light" onclick="showGeneralLedger()">
                                                <i class="bi bi-arrow-left"></i> Back
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body p-0">
                                    <div class="input-group p-2">
                                        <span class="input-group-text">
                                            <i class="bi bi-search"></i>
                                        </span>
                                        <input type="text" class="form-control" id="customerSearchInput" 
                                               placeholder="Search customers...">
                                    </div>
                                    <div id="customersList" style="max-height: 500px; overflow-y: auto;">
                                        <div class="text-center p-3">
                                            <div class="spinner-border spinner-border-sm" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                            <div class="mt-2">Loading customers...</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Customer Summary Card -->
                            <div class="card mt-3">
                                <div class="card-header">
                                    <h6 class="mb-0">Customer Summary</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row text-center">
                                        <div class="col-6">
                                            <div class="text-muted small">Total Customers</div>
                                            <div class="h5 mb-0" id="totalCustomersCount">0</div>
                                        </div>
                                        <div class="col-6">
                                            <div class="text-muted small">Active Customers</div>
                                            <div class="h5 mb-0" id="activeCustomersCount">0</div>
                                        </div>
                                    </div>
                                    <hr>
                                    <div class="row text-center">
                                        <div class="col-12">
                                            <div class="text-muted small">Total Outstanding</div>
                                            <div class="h5 mb-0 text-danger" id="totalOutstanding">P 0.00</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Customer Ledger Details -->
                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-header">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0" id="selectedCustomerName">Select a customer to view ledger</h6>
                                        <div class="d-flex gap-2">
                                            <button class="btn btn-outline-primary btn-sm" id="exportCustomerLedgerBtn" disabled>
                                                <i class="bi bi-download me-1"></i>Export
                                            </button>
                                            <button class="btn btn-outline-secondary btn-sm" id="printCustomerLedgerBtn" disabled>
                                                <i class="bi bi-printer me-1"></i>Print
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <!-- Customer Details Panel -->
                                    <div id="customerDetailsPanel" style="display: none;">
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <div class="card bg-light">
                                                    <div class="card-body">
                                                        <h6 class="card-title">Customer Information</h6>
                                                        <div class="row">
                                                            <div class="col-6">
                                                                <small class="text-muted">Customer Type</small>
                                                                <div id="customerType">-</div>
                                                            </div>
                                                            <div class="col-6">
                                                                <small class="text-muted">Credit Limit</small>
                                                                <div id="customerCreditLimit">P 0.00</div>
                                                            </div>
                                                        </div>
                                                        <div class="row mt-2">
                                                            <div class="col-6">
                                                                <small class="text-muted">Payment Terms</small>
                                                                <div id="customerPaymentTerms">30 days</div>
                                                            </div>
                                                            <div class="col-6">
                                                                <small class="text-muted">Status</small>
                                                                <div id="customerStatus">
                                                                    <span class="badge bg-success">Active</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="card bg-light">
                                                    <div class="card-body">
                                                        <h6 class="card-title">Account Balance</h6>
                                                        <div class="row">
                                                            <div class="col-6">
                                                                <small class="text-muted">Current Balance</small>
                                                                <div class="h5 mb-0" id="customerCurrentBalance">P 0.00</div>
                                                            </div>
                                                            <div class="col-6">
                                                                <small class="text-muted">Credit Available</small>
                                                                <div class="h5 mb-0 text-success" id="customerCreditAvailable">P 0.00</div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Transaction History -->
                                    <div id="customerTransactionsContainer">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <h6 class="mb-0">Transaction History</h6>
                                            <div class="d-flex gap-2">
                                                <select class="form-select form-select-sm" id="customerTransactionFilter" style="width: auto;">
                                                    <option value="">All Transactions</option>
                                                    <option value="sale">All Sales</option>
                                                    <option value="payment">Payments & Receipts</option>
                                                    <option value="invoice">Invoices</option>
                                                    <option value="credit">Credit Transactions</option>
                                                    <option value="journal">Journal Entries</option>
                                                </select>
                                                <input type="date" class="form-control form-control-sm" id="customerFromDate" style="width: auto;">
                                                <input type="date" class="form-control form-control-sm" id="customerToDate" style="width: auto;">
                                                <div class="btn-group" role="group">
                                                    <button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                                        <i class="fas fa-download"></i> Export
                                                    </button>
                                                    <ul class="dropdown-menu">
                                                        <li><a class="dropdown-item" href="#" onclick="printCustomerLedger()"><i class="fas fa-print me-2"></i>Print</a></li>
                                                        <li><a class="dropdown-item" href="#" onclick="exportCustomerLedger('pdf')"><i class="fas fa-file-pdf me-2"></i>Export PDF</a></li>
                                                        <li><a class="dropdown-item" href="#" onclick="exportCustomerLedger('excel')"><i class="fas fa-file-excel me-2"></i>Export Excel</a></li>
                                                        <li><a class="dropdown-item" href="#" onclick="exportCustomerLedger('csv')"><i class="fas fa-file-csv me-2"></i>Export CSV</a></li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="table-responsive">
                                            <table class="table table-sm table-hover">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th>Date</th>
                                                        <th>Reference</th>
                                                        <th>Description</th>
                                                        <th>Type</th>
                                                        <th class="text-end">Debit</th>
                                                        <th class="text-end">Credit</th>
                                                        <th class="text-end">Balance</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="customerTransactionsBody">
                                                    <tr>
                                                        <td colspan="7" class="text-center text-muted">
                                                            Select a customer to view transactions
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                mainRow.appendChild(customerView);
                
                // Add event listeners for customer view
                setupCustomerLedgerEventListeners();
            }
            
            customerView.style.display = 'block';
        }

        function setupCustomerLedgerEventListeners() {
            // Customer search
            const searchInput = document.getElementById('customerSearchInput');
            if (searchInput) {
                searchInput.addEventListener('input', debounce(filterCustomers, 300));
            }
            
            // Refresh customers button
            const refreshBtn = document.getElementById('refreshCustomersBtn');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', fetchCustomers);
            }
            
            // Transaction filters
            const transactionFilter = document.getElementById('customerTransactionFilter');
            const fromDate = document.getElementById('customerFromDate');
            const toDate = document.getElementById('customerToDate');
            
            if (transactionFilter) {
                transactionFilter.addEventListener('change', () => {
                    if (window.currentCustomerId) {
                        fetchCustomerTransactions(window.currentCustomerId);
                    }
                });
            }
            
            if (fromDate) {
                fromDate.addEventListener('change', () => {
                    if (window.currentCustomerId) {
                        fetchCustomerTransactions(window.currentCustomerId);
                    }
                });
            }
            
            if (toDate) {
                toDate.addEventListener('change', () => {
                    if (window.currentCustomerId) {
                        fetchCustomerTransactions(window.currentCustomerId);
                    }
                });
            }
        }

        async function fetchCustomers() {
            try {
                const response = await fetch('/api/v1/sales/customers?limit=1000');
                if (response.ok) {
                    const customers = await response.json();
                    displayCustomers(customers);
                    updateCustomerSummary(customers);
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                console.error('Error fetching customers:', error);
                const customersList = document.getElementById('customersList');
                if (customersList) {
                    customersList.innerHTML = `
                        <div class="text-center p-3 text-danger">
                            <i class="bi bi-exclamation-triangle"></i>
                            <div class="mt-2">Error loading customers</div>
                        </div>
                    `;
                }
            }
        }

        function displayCustomers(customers) {
            const customersList = document.getElementById('customersList');
            if (!customersList) return;
            
            if (customers.length === 0) {
                customersList.innerHTML = `
                    <div class="text-center p-3 text-muted">
                        <i class="bi bi-people"></i>
                        <div class="mt-2">No customers found</div>
                    </div>
                `;
                return;
            }
            
            customersList.innerHTML = customers.map(customer => `
                <div class="list-group-item list-group-item-action customer-item" 
                     onclick="selectCustomer('${customer.id}')" 
                     data-customer-id="${customer.id}"
                     data-customer-name="${customer.name || 'Unknown Customer'}"
                     data-search-text="${(customer.name || '').toLowerCase()} ${(customer.email || '').toLowerCase()} ${(customer.phone || '').toLowerCase()}">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <h6 class="mb-1">${customer.name || 'Unknown Customer'}</h6>
                            <p class="mb-1 text-muted small">
                                ${customer.email ? `<i class="bi bi-envelope me-1"></i>${customer.email}` : ''}
                                ${customer.phone ? `<i class="bi bi-phone ms-2 me-1"></i>${customer.phone}` : ''}
                            </p>
                            <small class="text-muted">
                                ${customer.customer_type || 'retail'}  
                                ${customer.active ? '<span class="text-success">Active</span>' : '<span class="text-danger">Inactive</span>'}
                            </small>
                        </div>
                        <div class="text-end">
                            <div class="small ${(customer.account_balance || 0) > 0 ? 'text-danger' : 'text-success'}">
                                ${formatCurrency(customer.account_balance || 0)}
                            </div>
                            <div class="small text-muted">
                                Credit: ${formatCurrency(customer.credit_limit || 0)}
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            
            // Store customers data for filtering
            window.allCustomers = customers;
        }

        function updateCustomerSummary(customers) {
            const totalCount = customers.length;
            const activeCount = customers.filter(c => c.active !== false).length;
            const totalOutstanding = customers.reduce((sum, c) => sum + (c.account_balance || 0), 0);
            
            const totalCustomersEl = document.getElementById('totalCustomersCount');
            const activeCustomersEl = document.getElementById('activeCustomersCount');
            const totalOutstandingEl = document.getElementById('totalOutstanding');
            
            if (totalCustomersEl) totalCustomersEl.textContent = totalCount;
            if (activeCustomersEl) activeCustomersEl.textContent = activeCount;
            if (totalOutstandingEl) totalOutstandingEl.textContent = formatCurrency(totalOutstanding);
        }

        function filterCustomers() {
            const searchInput = document.getElementById('customerSearchInput');
            if (!searchInput || !window.allCustomers) return;
            
            const searchTerm = searchInput.value.toLowerCase();
            const customerItems = document.querySelectorAll('.customer-item');
            
            customerItems.forEach(item => {
                const searchText = item.getAttribute('data-search-text');
                if (searchText && searchText.includes(searchTerm)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        async function selectCustomer(customerId) {
            window.currentCustomerId = customerId;
            
            // Highlight selected customer
            document.querySelectorAll('.customer-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[data-customer-id="${customerId}"]`)?.classList.add('active');
            
            // Find customer data
            const customer = window.allCustomers?.find(c => c.id === customerId);
            if (!customer) return;
            
            // Update selected customer name
            const selectedCustomerNameEl = document.getElementById('selectedCustomerName');
            if (selectedCustomerNameEl) {
                selectedCustomerNameEl.textContent = customer.name || 'Unknown Customer';
            }
            
            // Show customer details panel
            displayCustomerDetails(customer);
            
            // Fetch and display customer transactions
            await fetchCustomerTransactions(customerId);
            
            // Enable export/print buttons
            const exportBtn = document.getElementById('exportCustomerLedgerBtn');
            const printBtn = document.getElementById('printCustomerLedgerBtn');
            if (exportBtn) exportBtn.disabled = false;
            if (printBtn) printBtn.disabled = false;
        }

        function displayCustomerDetails(customer) {
            const detailsPanel = document.getElementById('customerDetailsPanel');
            if (!detailsPanel) return;
            
            // Update customer information
            const customerTypeEl = document.getElementById('customerType');
            const creditLimitEl = document.getElementById('customerCreditLimit');
            const paymentTermsEl = document.getElementById('customerPaymentTerms');
            const statusEl = document.getElementById('customerStatus');
            const currentBalanceEl = document.getElementById('customerCurrentBalance');
            const creditAvailableEl = document.getElementById('customerCreditAvailable');
            
            if (customerTypeEl) customerTypeEl.textContent = customer.customer_type || 'retail';
            if (creditLimitEl) creditLimitEl.textContent = formatCurrency(customer.credit_limit || 0);
            if (paymentTermsEl) paymentTermsEl.textContent = `${customer.payment_terms || 30} days`;
            
            if (statusEl) {
                const isActive = customer.active !== false;
                statusEl.innerHTML = `<span class="badge ${isActive ? 'bg-success' : 'bg-danger'}">${isActive ? 'Active' : 'Inactive'}</span>`;
            }
            
            if (currentBalanceEl) {
                const balance = customer.account_balance || 0;
                currentBalanceEl.textContent = formatCurrency(balance);
                currentBalanceEl.className = `h5 mb-0 ${balance > 0 ? 'text-danger' : 'text-success'}`;
            }
            
            if (creditAvailableEl) {
                const available = (customer.credit_limit || 0) - (customer.account_balance || 0);
                creditAvailableEl.textContent = formatCurrency(Math.max(0, available));
            }
            
            detailsPanel.style.display = 'block';
        }

        async function fetchCustomerTransactions(customerId) {
            try {
                // Show loading state
                const transactionsBody = document.getElementById('customerTransactionsBody');
                if (transactionsBody) {
                    transactionsBody.innerHTML = `
                        <tr>
                            <td colspan="7" class="text-center">
                                <div class="spinner-border spinner-border-sm" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                Loading transactions...
                            </td>
                        </tr>
                    `;
                }
                
                // Get customer details first
                const customer = window.allCustomers?.find(c => c.id === customerId);
                
                // Try to get customer balance
                try {
                    const balanceResponse = await fetch(`/api/v1/sales/customers/${customerId}/balance`);
                    if (balanceResponse.ok) {
                        const balanceData = await balanceResponse.json();
                        updateCustomerBalanceDisplay(balanceData);
                    }
                } catch (e) {
                    console.log('Balance endpoint not available:', e);
                }
                
                const transactionFilter = document.getElementById('customerTransactionFilter');
                const fromDate = document.getElementById('customerFromDate');
                const toDate = document.getElementById('customerToDate');
                
                let allTransactions = [];
                
                // 1. Get Sales Transactions (both cash and credit)
                try {
                    const salesParams = new URLSearchParams();
                    salesParams.append('limit', '500');
                    if (fromDate?.value) salesParams.append('from_date', fromDate.value);
                    if (toDate?.value) salesParams.append('to_date', toDate.value);
                    
                    const salesUrl = `/api/v1/sales/sales?${salesParams.toString()}`;
                    const salesResponse = await fetch(salesUrl);
                    if (salesResponse.ok) {
                        const allSales = await salesResponse.json();
                        // Filter sales for this customer
                        const customerSales = allSales.filter(sale => sale.customer_id === customerId);
                        
                        customerSales.forEach(sale => {
                            allTransactions.push({
                                date: sale.date,
                                reference: sale.receipt_number || `SALE-${sale.id?.slice(-8) || 'N/A'}`,
                                description: `Sale - ${sale.payment_method || 'Cash'} ${sale.notes ? '(' + sale.notes + ')' : ''}`,
                                debit: sale.payment_method === 'credit' ? sale.total_amount : 0,
                                credit: sale.payment_method !== 'credit' ? sale.total_amount : 0,
                                type: 'sale',
                                payment_method: sale.payment_method,
                                amount: sale.total_amount
                            });
                        });
                    }
                } catch (e) {
                    console.log('Sales endpoint error:', e);
                }
                
                // 2. Get Journal Entries related to this customer
                try {
                    const journalParams = new URLSearchParams();
                    journalParams.append('limit', '500');
                    if (fromDate?.value) journalParams.append('from_date', fromDate.value);
                    if (toDate?.value) journalParams.append('to_date', toDate.value);
                    
                    const journalUrl = `/api/v1/accounting/entries?${journalParams.toString()}`;
                    const journalResponse = await fetch(journalUrl);
                    if (journalResponse.ok) {
                        const journalEntries = await journalResponse.json();
                        
                        // Filter journal entries that mention this customer or are related to customer accounts
                        const customerJournalEntries = journalEntries.filter(entry => {
                            const description = (entry.description || '').toLowerCase();
                            const reference = (entry.reference || '').toLowerCase();
                            const customerName = (customer?.name || '').toLowerCase();
                            
                            return description.includes(customerName) || 
                                   reference.includes(customerName) ||
                                   description.includes('customer') ||
                                   description.includes('sale') ||
                                   description.includes('payment') ||
                                   description.includes('receipt');
                        });
                        
                        customerJournalEntries.forEach(entry => {
                            allTransactions.push({
                                date: entry.date,
                                reference: entry.reference || entry.id?.slice(-8) || 'N/A',
                                description: entry.description || 'Journal Entry',
                                debit: entry.debit || 0,
                                credit: entry.credit || 0,
                                type: 'journal',
                                accounting_code: entry.accounting_code?.name
                            });
                        });
                    }
                } catch (e) {
                    console.log('Journal entries endpoint error:', e);
                }
                
                // 3. Get Customer Receivables (if any)
                try {
                    const receivablesParams = new URLSearchParams();
                    if (fromDate?.value) receivablesParams.append('from_date', fromDate.value);
                    if (toDate?.value) receivablesParams.append('to_date', toDate.value);
                    receivablesParams.append('limit', '500');
                    
                    const receivablesUrl = `/api/v1/accounting/ledger/customers?${receivablesParams.toString()}`;
                    const receivablesResponse = await fetch(receivablesUrl);
                    if (receivablesResponse.ok) {
                        const receivables = await receivablesResponse.json();
                        receivables.forEach(entry => {
                            // Only add if it seems related to this customer
                            const description = (entry.description || '').toLowerCase();
                            const customerName = (customer?.name || '').toLowerCase();
                            
                            if (description.includes(customerName) || !customerName) {
                                allTransactions.push({
                                    date: entry.date,
                                    reference: entry.reference || 'AR-' + (entry.id?.slice(-8) || 'N/A'),
                                    description: entry.description || 'Accounts Receivable',
                                    debit: entry.debit || 0,
                                    credit: entry.credit || 0,
                                    type: 'receivable',
                                    accounting_code: entry.accounting_code?.name
                                });
                            }
                        });
                    }
                } catch (e) {
                    console.log('Receivables endpoint error:', e);
                }
                
                // 4. Get Invoices for this customer
                try {
                    const invoicesUrl = `/api/v1/invoices/?customer_id=${customerId}&limit=500`;
                    const invoicesResponse = await fetch(invoicesUrl);
                    if (invoicesResponse.ok) {
                        const invoices = await invoicesResponse.json();
                        invoices.forEach(invoice => {
                            allTransactions.push({
                                date: invoice.created_at || invoice.date,
                                reference: invoice.invoice_number || `INV-${invoice.id?.slice(-8) || 'N/A'}`,
                                description: `Invoice - ${invoice.status || 'Pending'}`,
                                debit: invoice.total_amount || 0,
                                credit: 0,
                                type: 'invoice',
                                status: invoice.status
                            });
                        });
                    }
                } catch (e) {
                    console.log('Invoices endpoint not available:', e);
                }
                
                // Apply transaction type filter
                const filterType = transactionFilter?.value;
                if (filterType) {
                    allTransactions = allTransactions.filter(t => {
                        switch (filterType) {
                            case 'sale': 
                                return t.type === 'sale';
                            case 'payment': 
                                return t.type === 'journal' && (
                                    t.description.toLowerCase().includes('payment') || 
                                    t.description.toLowerCase().includes('receipt') ||
                                    t.reference.toLowerCase().includes('pmt') ||
                                    t.reference.toLowerCase().includes('rcpt')
                                );
                            case 'invoice': 
                                return t.type === 'invoice';
                            case 'credit': 
                                return (t.type === 'sale' && t.payment_method === 'credit') ||
                                       (t.type === 'receivable') ||
                                       (t.description.toLowerCase().includes('credit'));
                            case 'journal':
                                return t.type === 'journal';
                            default: 
                                return true;
                        }
                    });
                }
                
                // Sort by date (newest first)
                allTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                displayCustomerTransactions(allTransactions);
                
            } catch (error) {
                console.error('Error fetching customer transactions:', error);
                const transactionsBody = document.getElementById('customerTransactionsBody');
                if (transactionsBody) {
                    transactionsBody.innerHTML = `
                        <tr>
                            <td colspan="7" class="text-center text-danger">
                                Error loading transactions: ${error.message}
                            </td>
                        </tr>
                    `;
                }
            }
        }

        function updateCustomerBalanceDisplay(balanceData) {
            if (!balanceData) return;
            
            const currentBalanceEl = document.getElementById('customerCurrentBalance');
            const creditAvailableEl = document.getElementById('customerCreditAvailable');
            
            if (currentBalanceEl && balanceData.balance !== undefined) {
                const balance = balanceData.balance;
                currentBalanceEl.textContent = formatCurrency(balance);
                currentBalanceEl.className = `h5 mb-0 ${balance > 0 ? 'text-danger' : 'text-success'}`;
            }
            
            if (creditAvailableEl && balanceData.credit_available !== undefined) {
                creditAvailableEl.textContent = formatCurrency(balanceData.credit_available);
            }
        }

        function displayCustomerTransactions(transactions) {
            const transactionsBody = document.getElementById('customerTransactionsBody');
            if (!transactionsBody) return;
            
            if (!transactions || transactions.length === 0) {
                transactionsBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-muted">
                            No transactions found for this customer
                        </td>
                    </tr>
                `;
                return;
            }
            
            let runningBalance = 0;
            transactionsBody.innerHTML = transactions.map(transaction => {
                const debit = parseFloat(transaction.debit || 0);
                const credit = parseFloat(transaction.credit || 0);
                runningBalance += debit - credit;
                
                const transactionType = determineTransactionType(transaction);
                
                return `
                    <tr>
                        <td>${formatDate(transaction.date)}</td>
                        <td>${transaction.reference || '-'}</td>
                        <td>${transaction.description || '-'}</td>
                        <td>
                            <span class="badge ${getTransactionTypeBadge(transactionType)}">${transactionType}</span>
                        </td>
                        <td class="text-end ${debit > 0 ? 'text-danger' : ''}">${debit > 0 ? formatCurrency(debit) : '-'}</td>
                        <td class="text-end ${credit > 0 ? 'text-success' : ''}">${credit > 0 ? formatCurrency(credit) : '-'}</td>
                        <td class="text-end ${runningBalance >= 0 ? 'text-danger' : 'text-success'}">${formatCurrency(runningBalance)}</td>
                    </tr>
                `;
            }).join('');
        }

        function determineTransactionType(transaction) {
            const desc = (transaction.description || '').toLowerCase();
            const ref = (transaction.reference || '').toLowerCase();
            const type = transaction.type;
            
            // Prioritize the transaction type if explicitly set
            if (type === 'sale') {
                if (transaction.payment_method === 'credit') return 'Credit Sale';
                if (transaction.payment_method === 'cash') return 'Cash Sale';
                return 'Sale';
            }
            if (type === 'invoice') return 'Invoice';
            if (type === 'receivable') return 'A/R Entry';
            if (type === 'journal') {
                if (desc.includes('payment') || desc.includes('receipt')) return 'Payment';
                if (desc.includes('refund')) return 'Refund';
                if (desc.includes('adjustment')) return 'Adjustment';
                return 'Journal Entry';
            }
            
            // Fallback to description-based detection
            if (desc.includes('sale') || ref.includes('sale')) {
                if (desc.includes('credit') || ref.includes('credit')) return 'Credit Sale';
                return 'Cash Sale';
            }
            if (desc.includes('payment') || ref.includes('payment') || ref.includes('pmt')) return 'Payment';
            if (desc.includes('invoice') || ref.includes('inv')) return 'Invoice';
            if (desc.includes('credit') || ref.includes('credit')) return 'Credit';
            if (desc.includes('refund') || ref.includes('refund')) return 'Refund';
            if (desc.includes('adjustment')) return 'Adjustment';
            if (desc.includes('receipt') || ref.includes('rcpt')) return 'Receipt';
            
            return 'Other';
        }

        function getTransactionTypeBadge(type) {
            switch (type.toLowerCase()) {
                case 'cash sale': return 'bg-success';
                case 'credit sale': return 'bg-warning';
                case 'sale': return 'bg-primary';
                case 'payment': return 'bg-success';
                case 'receipt': return 'bg-success';
                case 'invoice': return 'bg-info';
                case 'credit': return 'bg-warning';
                case 'refund': return 'bg-secondary';
                case 'adjustment': return 'bg-dark';
                case 'a/r entry': return 'bg-info';
                case 'journal entry': return 'bg-light text-dark';
                default: return 'bg-light text-dark';
            }
        }

        // Export and Print Functions
        function printCustomerLedger() {
            const selectedCustomer = document.querySelector('.customer-item.active');
            if (!selectedCustomer) {
                alert('Please select a customer first.');
                return;
            }

            const customerName = selectedCustomer.querySelector('strong').textContent;
            const customerBalance = selectedCustomer.querySelector('.fw-bold').textContent;
            
            // Create print content
            const printContent = createPrintableContent(customerName, customerBalance);
            
            // Open print window
            const printWindow = window.open('', '', 'width=800,height=600');
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
            printWindow.close();
        }

        function exportCustomerLedger(format) {
            const selectedCustomer = document.querySelector('.customer-item.active');
            if (!selectedCustomer) {
                alert('Please select a customer first.');
                return;
            }

            const customerName = selectedCustomer.querySelector('strong').textContent;
            const customerBalance = selectedCustomer.querySelector('.fw-bold').textContent;
            
            switch (format) {
                case 'pdf':
                    exportToPDF(customerName, customerBalance);
                    break;
                case 'excel':
                    exportToExcel(customerName, customerBalance);
                    break;
                case 'csv':
                    exportToCSV(customerName, customerBalance);
                    break;
                default:
                    alert('Unsupported export format');
            }
        }

        function createPrintableContent(customerName, customerBalance) {
            const transactions = getFilteredTransactions();
            const currentDate = new Date().toLocaleDateString();
            const filter = document.getElementById('customerTransactionFilter')?.value || 'All Transactions';
            const fromDate = document.getElementById('customerFromDate')?.value || '';
            const toDate = document.getElementById('customerToDate')?.value || '';
            
            let dateRange = '';
            if (fromDate || toDate) {
                dateRange = `<p class="print-subtitle">Date Range: ${fromDate || 'Beginning'} to ${toDate || 'End'}</p>`;
            }

            return `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Customer Ledger - ${customerName}</title>
                    <meta charset="utf-8">
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .print-header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #000; padding-bottom: 10px; }
                        .print-title { font-size: 24px; font-weight: bold; margin-bottom: 10px; }
                        .print-subtitle { font-size: 16px; margin-bottom: 5px; }
                        .print-date { font-size: 12px; color: #666; }
                        .customer-summary { border: 1px solid #000; padding: 15px; margin-bottom: 20px; background-color: #f8f9fa; }
                        table { width: 100%; border-collapse: collapse; font-size: 11px; }
                        th { border: 1px solid #000; padding: 8px; background-color: #f8f9fa; font-weight: bold; }
                        td { border: 1px solid #ddd; padding: 6px; }
                        .text-end { text-align: right; }
                        .fw-bold { font-weight: bold; }
                        .print-footer { margin-top: 30px; text-align: center; font-size: 10px; color: #666; border-top: 1px solid #ddd; padding-top: 10px; }
                    </style>
                </head>
                <body>
                    <div class="print-header">
                        <div class="print-title">Customer Ledger Report</div>
                        <p class="print-subtitle">Customer: ${customerName}</p>
                        <p class="print-subtitle">Filter: ${filter}</p>
                        ${dateRange}
                        <p class="print-date">Generated on: ${currentDate}</p>
                    </div>
                    
                    <div class="customer-summary">
                        <h4>Customer Summary</h4>
                        <p><strong>Name:</strong> ${customerName}</p>
                        <p><strong>Current Balance:</strong> ${customerBalance}</p>
                        <p><strong>Total Transactions:</strong> ${transactions.length}</p>
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Reference</th>
                                <th>Description</th>
                                <th>Type</th>
                                <th>Debit</th>
                                <th>Credit</th>
                                <th>Balance</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${generateTransactionRows(transactions)}
                        </tbody>
                    </table>
                    
                    <div class="print-footer">
                        <p>CNPERP - Customer Ledger Report | Page 1 | Generated: ${currentDate}</p>
                    </div>
                </body>
                </html>
            `;
        }

        function generateTransactionRows(transactions) {
            let runningBalance = 0;
            return transactions.map(transaction => {
                const debit = parseFloat(transaction.debit || 0);
                const credit = parseFloat(transaction.credit || 0);
                runningBalance += debit - credit;
                
                return `
                    <tr>
                        <td>${new Date(transaction.date).toLocaleDateString()}</td>
                        <td>${transaction.reference || '-'}</td>
                        <td>${transaction.description || '-'}</td>
                        <td>${determineTransactionType(transaction)}</td>
                        <td class="text-end">${debit > 0 ? debit.toFixed(2) : '-'}</td>
                        <td class="text-end">${credit > 0 ? credit.toFixed(2) : '-'}</td>
                        <td class="text-end fw-bold">${runningBalance.toFixed(2)}</td>
                    </tr>
                `;
            }).join('');
        }

        function getFilteredTransactions() {
            const table = document.querySelector('#customerTransactionsContainer table tbody');
            if (!table) return [];
            
            const transactions = [];
            const rows = table.querySelectorAll('tr');
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 7) {
                    transactions.push({
                        date: cells[0].textContent.trim(),
                        reference: cells[1].textContent.trim(),
                        description: cells[2].textContent.trim(),
                        type: cells[3].textContent.trim(),
                        debit: cells[4].textContent.trim() !== '-' ? parseFloat(cells[4].textContent.trim()) : 0,
                        credit: cells[5].textContent.trim() !== '-' ? parseFloat(cells[5].textContent.trim()) : 0,
                        balance: cells[6].textContent.trim()
                    });
                }
            });
            
            return transactions;
        }

        function exportToPDF(customerName, customerBalance) {
            // For PDF export, we'll use the browser's print to PDF functionality
            const printContent = createPrintableContent(customerName, customerBalance);
            
            const printWindow = window.open('', '', 'width=800,height=600');
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.focus();
            
            // Suggest to use Print to PDF
            alert('Please use your browser\'s "Print" function and select "Save as PDF" as the destination.');
            printWindow.print();
        }

        function exportToExcel(customerName, customerBalance) {
            const transactions = getFilteredTransactions();
            const currentDate = new Date().toLocaleDateString();
            
            // Create CSV content that Excel can open
            let csvContent = `Customer Ledger Report\n`;
            csvContent += `Customer: ${customerName}\n`;
            csvContent += `Current Balance: ${customerBalance}\n`;
            csvContent += `Generated: ${currentDate}\n\n`;
            csvContent += `Date,Reference,Description,Type,Debit,Credit,Balance\n`;
            
            transactions.forEach(transaction => {
                csvContent += `"${transaction.date}","${transaction.reference}","${transaction.description}","${transaction.type}",${transaction.debit},${transaction.credit},"${transaction.balance}"\n`;
            });
            
            // Create and download file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `Customer_Ledger_${customerName.replace(/[^a-z0-9]/gi, '_')}_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function exportToCSV(customerName, customerBalance) {
            const transactions = getFilteredTransactions();
            const currentDate = new Date().toLocaleDateString();
            
            let csvContent = `Date,Reference,Description,Type,Debit,Credit,Balance\n`;
            
            transactions.forEach(transaction => {
                csvContent += `"${transaction.date}","${transaction.reference}","${transaction.description}","${transaction.type}",${transaction.debit},${transaction.credit},"${transaction.balance}"\n`;
            });
            
            // Create and download file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `Customer_Ledger_${customerName.replace(/[^a-z0-9]/gi, '_')}_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function refreshCustomerTransactions() {
            const selectedCustomer = document.querySelector('.customer-item.active');
            if (selectedCustomer) {
                selectedCustomer.click(); // Re-trigger the customer selection
            }
        }

        // Customer List Export Functions
        function exportCustomerList(format) {
            const customers = getAllCustomersData();
            
            switch (format) {
                case 'pdf':
                    exportCustomerListToPDF(customers);
                    break;
                case 'excel':
                    exportCustomerListToExcel(customers);
                    break;
                case 'csv':
                    exportCustomerListToCSV(customers);
                    break;
                default:
                    alert('Unsupported export format');
            }
        }

        function getAllCustomersData() {
            const customerItems = document.querySelectorAll('.customer-item');
            const customers = [];
            
            customerItems.forEach(item => {
                const name = item.querySelector('strong')?.textContent || '';
                const balance = item.querySelector('.fw-bold')?.textContent || '0.00';
                const details = item.querySelector('.text-muted')?.textContent || '';
                
                customers.push({
                    name: name,
                    balance: balance,
                    details: details
                });
            });
            
            return customers;
        }

        function exportCustomerListToPDF(customers) {
            const currentDate = new Date().toLocaleDateString();
            
            const printContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Customer List Report</title>
                    <meta charset="utf-8">
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .print-header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #000; padding-bottom: 10px; }
                        .print-title { font-size: 24px; font-weight: bold; margin-bottom: 10px; }
                        .print-date { font-size: 12px; color: #666; }
                        table { width: 100%; border-collapse: collapse; font-size: 12px; }
                        th { border: 1px solid #000; padding: 8px; background-color: #f8f9fa; font-weight: bold; }
                        td { border: 1px solid #ddd; padding: 6px; }
                        .text-end { text-align: right; }
                        .print-footer { margin-top: 30px; text-align: center; font-size: 10px; color: #666; border-top: 1px solid #ddd; padding-top: 10px; }
                    </style>
                </head>
                <body>
                    <div class="print-header">
                        <div class="print-title">Customer List Report</div>
                        <p class="print-date">Generated on: ${currentDate}</p>
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>Customer Name</th>
                                <th>Current Balance</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${customers.map(customer => `
                                <tr>
                                    <td>${customer.name}</td>
                                    <td class="text-end">${customer.balance}</td>
                                    <td>${customer.details}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    
                    <div class="print-footer">
                        <p>CNPERP - Customer List Report | Total Customers: ${customers.length} | Generated: ${currentDate}</p>
                    </div>
                </body>
                </html>
            `;
            
            const printWindow = window.open('', '', 'width=800,height=600');
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.focus();
            
            alert('Please use your browser\'s "Print" function and select "Save as PDF" as the destination.');
            printWindow.print();
        }

        function exportCustomerListToExcel(customers) {
            const currentDate = new Date().toLocaleDateString();
            
            let csvContent = `Customer List Report\n`;
            csvContent += `Generated: ${currentDate}\n`;
            csvContent += `Total Customers: ${customers.length}\n\n`;
            csvContent += `Customer Name,Current Balance,Details\n`;
            
            customers.forEach(customer => {
                csvContent += `"${customer.name}","${customer.balance}","${customer.details}"\n`;
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `Customer_List_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function exportCustomerListToCSV(customers) {
            let csvContent = `Customer Name,Current Balance,Details\n`;
            
            customers.forEach(customer => {
                csvContent += `"${customer.name}","${customer.balance}","${customer.details}"\n`;
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `Customer_List_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Inventory Ledger Functions
        function createInventoryLedgerView() {
            const mainRow = document.querySelector('.row:has(.col-md-4)');
            if (!mainRow) return;
            
            // Hide the current account list and general ledger
            const accountsList = mainRow.querySelector('.col-md-4');
            const generalLedger = mainRow.querySelector('.col-md-8');
            
            if (accountsList) accountsList.style.display = 'none';
            if (generalLedger) generalLedger.style.display = 'none';
            
            // Hide customer ledger view if it exists
            const customerView = document.getElementById('customerLedgerView');
            if (customerView) customerView.style.display = 'none';
            
            // Create inventory ledger view
            let inventoryView = document.getElementById('inventoryLedgerView');
            if (!inventoryView) {
                inventoryView = document.createElement('div');
                inventoryView.id = 'inventoryLedgerView';
                inventoryView.className = 'col-12';
                inventoryView.innerHTML = `
                    <div class="row">
                        <!-- Product List -->
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header bg-info text-white">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0">
                                            <i class="bi bi-box-seam me-2"></i>Inventory Products
                                        </h6>
                                        <div class="d-flex gap-2">
                                            <div class="btn-group" role="group">
                                                <button type="button" class="btn btn-sm btn-light dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                                    <i class="fas fa-download"></i>
                                                </button>
                                                <ul class="dropdown-menu">
                                                    <li><a class="dropdown-item" href="#" onclick="exportInventoryList('pdf')"><i class="fas fa-file-pdf me-2"></i>Export PDF</a></li>
                                                    <li><a class="dropdown-item" href="#" onclick="exportInventoryList('excel')"><i class="fas fa-file-excel me-2"></i>Export Excel</a></li>
                                                    <li><a class="dropdown-item" href="#" onclick="exportInventoryList('csv')"><i class="fas fa-file-csv me-2"></i>Export CSV</a></li>
                                                </ul>
                                            </div>
                                            <button class="btn btn-sm btn-light" id="refreshInventoryBtn">
                                                <i class="bi bi-arrow-clockwise"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-light" onclick="showGeneralLedger()">
                                                <i class="bi bi-arrow-left"></i> Back
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body p-0">
                                    <div class="input-group p-2">
                                        <span class="input-group-text">
                                            <i class="bi bi-search"></i>
                                        </span>
                                        <input type="text" class="form-control" id="inventorySearchInput" 
                                               placeholder="Search products...">
                                    </div>
                                    <div class="p-2">
                                        <select class="form-select form-select-sm" id="inventoryCategoryFilter">
                                            <option value="">All Categories</option>
                                        </select>
                                    </div>
                                    <div id="inventoryList" style="max-height: 450px; overflow-y: auto;">
                                        <div class="text-center p-3">
                                            <div class="spinner-border spinner-border-sm" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                            <div class="mt-2">Loading products...</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Inventory Summary Card -->
                            <div class="card mt-3">
                                <div class="card-header">
                                    <h6 class="mb-0">Inventory Summary</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row text-center">
                                        <div class="col-6">
                                            <div class="text-muted small">Total Products</div>
                                            <div class="h5 mb-0" id="totalProductsCount">0</div>
                                        </div>
                                        <div class="col-6">
                                            <div class="text-muted small">Active Products</div>
                                            <div class="h5 mb-0" id="activeProductsCount">0</div>
                                        </div>
                                    </div>
                                    <hr>
                                    <div class="row text-center">
                                        <div class="col-6">
                                            <div class="text-muted small">Total Stock Value</div>
                                            <div class="h5 mb-0 text-success" id="totalStockValue">P 0.00</div>
                                        </div>
                                        <div class="col-6">
                                            <div class="text-muted small">Low Stock Items</div>
                                            <div class="h5 mb-0 text-warning" id="lowStockCount">0</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Inventory Ledger Details -->
                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-header">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0" id="selectedProductName">Select a product to view ledger</h6>
                                        <div class="d-flex gap-2">
                                            <div class="btn-group" role="group">
                                                <button type="button" class="btn btn-outline-primary btn-sm dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false" id="exportInventoryLedgerBtn" disabled>
                                                    <i class="fas fa-download"></i> Export
                                                </button>
                                                <ul class="dropdown-menu">
                                                    <li><a class="dropdown-item" href="#" onclick="printInventoryLedger()"><i class="fas fa-print me-2"></i>Print</a></li>
                                                    <li><a class="dropdown-item" href="#" onclick="exportInventoryLedger('pdf')"><i class="fas fa-file-pdf me-2"></i>Export PDF</a></li>
                                                    <li><a class="dropdown-item" href="#" onclick="exportInventoryLedger('excel')"><i class="fas fa-file-excel me-2"></i>Export Excel</a></li>
                                                    <li><a class="dropdown-item" href="#" onclick="exportInventoryLedger('csv')"><i class="fas fa-file-csv me-2"></i>Export CSV</a></li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <!-- Product Details Panel -->
                                    <div id="productDetailsPanel" style="display: none;">
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <div class="card bg-light">
                                                    <div class="card-body">
                                                        <h6 class="card-title">Product Information</h6>
                                                        <div class="row">
                                                            <div class="col-6">
                                                                <small class="text-muted">SKU</small>
                                                                <div id="productSKU">-</div>
                                                            </div>
                                                            <div class="col-6">
                                                                <small class="text-muted">Category</small>
                                                                <div id="productCategory">-</div>
                                                            </div>
                                                        </div>
                                                        <div class="row mt-2">
                                                            <div class="col-6">
                                                                <small class="text-muted">Cost Price</small>
                                                                <div id="productCostPrice">P 0.00</div>
                                                            </div>
                                                            <div class="col-6">
                                                                <small class="text-muted">Selling Price</small>
                                                                <div id="productSellingPrice">P 0.00</div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="card bg-light">
                                                    <div class="card-body">
                                                        <h6 class="card-title">Stock Information</h6>
                                                        <div class="row">
                                                            <div class="col-6">
                                                                <small class="text-muted">Current Stock</small>
                                                                <div class="h5 mb-0" id="productCurrentStock">0</div>
                                                            </div>
                                                            <div class="col-6">
                                                                <small class="text-muted">Reorder Point</small>
                                                                <div class="h5 mb-0" id="productReorderPoint">0</div>
                                                            </div>
                                                        </div>
                                                        <div class="row mt-2">
                                                            <div class="col-12">
                                                                <small class="text-muted">Stock Value</small>
                                                                <div class="h5 mb-0 text-success" id="productStockValue">P 0.00</div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Stock Movement History -->
                                    <div id="inventoryMovementsContainer">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <h6 class="mb-0">Stock Movement History</h6>
                                            <div class="d-flex gap-2">
                                                <select class="form-select form-select-sm" id="movementTypeFilter" style="width: auto;">
                                                    <option value="">All Movements</option>
                                                    <option value="sale">Sales</option>
                                                    <option value="purchase">Purchases</option>
                                                    <option value="adjustment">Adjustments</option>
                                                    <option value="transfer">Transfers</option>
                                                    <option value="return">Returns</option>
                                                </select>
                                                <input type="date" class="form-control form-control-sm" id="movementFromDate" style="width: auto;">
                                                <input type="date" class="form-control form-control-sm" id="movementToDate" style="width: auto;">
                                                <button class="btn btn-sm btn-outline-secondary" onclick="refreshInventoryMovements()">
                                                    <i class="bi bi-arrow-clockwise"></i>
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <div class="table-responsive">
                                            <table class="table table-sm table-hover">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th>Date</th>
                                                        <th>Reference</th>
                                                        <th>Type</th>
                                                        <th>Description</th>
                                                        <th class="text-end">Qty In</th>
                                                        <th class="text-end">Qty Out</th>
                                                        <th class="text-end">Balance</th>
                                                        <th class="text-end">Unit Cost</th>
                                                        <th class="text-end">Total Value</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="inventoryMovementsBody">
                                                    <tr>
                                                        <td colspan="9" class="text-center text-muted">
                                                            Select a product to view stock movements
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                mainRow.appendChild(inventoryView);
                
                // Add event listeners for inventory view
                setupInventoryLedgerEventListeners();
            }
            
            inventoryView.style.display = 'block';
        }

        function setupInventoryLedgerEventListeners() {
            // Product search
            const searchInput = document.getElementById('inventorySearchInput');
            if (searchInput) {
                searchInput.addEventListener('input', debounce(filterInventoryProducts, 300));
            }
            
            // Category filter
            const categoryFilter = document.getElementById('inventoryCategoryFilter');
            if (categoryFilter) {
                categoryFilter.addEventListener('change', filterInventoryProducts);
            }
            
            // Refresh button
            const refreshBtn = document.getElementById('refreshInventoryBtn');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', fetchInventoryProducts);
            }
            
            // Movement filters
            const movementTypeFilter = document.getElementById('movementTypeFilter');
            const fromDate = document.getElementById('movementFromDate');
            const toDate = document.getElementById('movementToDate');
            
            if (movementTypeFilter) {
                movementTypeFilter.addEventListener('change', () => {
                    if (window.currentProductId) {
                        fetchInventoryMovements(window.currentProductId);
                    }
                });
            }
            
            if (fromDate) {
                fromDate.addEventListener('change', () => {
                    if (window.currentProductId) {
                        fetchInventoryMovements(window.currentProductId);
                    }
                });
            }
            
            if (toDate) {
                toDate.addEventListener('change', () => {
                    if (window.currentProductId) {
                        fetchInventoryMovements(window.currentProductId);
                    }
                });
            }
        }

        async function fetchInventoryProducts() {
            try {
                const response = await fetch('/api/v1/inventory/products?include_stock=true&limit=1000');
                if (response.ok) {
                    const products = await response.json();
                    displayInventoryProducts(products);
                    updateInventorySummary(products);
                    await fetchProductCategories(products);
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                console.error('Error fetching products:', error);
                const inventoryList = document.getElementById('inventoryList');
                if (inventoryList) {
                    inventoryList.innerHTML = `
                        <div class="text-center p-3 text-danger">
                            <i class="bi bi-exclamation-triangle"></i>
                            <div class="mt-2">Error loading products</div>
                        </div>
                    `;
                }
            }
        }

        function displayInventoryProducts(products) {
            const inventoryList = document.getElementById('inventoryList');
            if (!inventoryList) return;

            window.allProducts = products; // Store for filtering

            if (!products || products.length === 0) {
                inventoryList.innerHTML = `
                    <div class="text-center p-3 text-muted">
                        <i class="bi bi-box"></i>
                        <div class="mt-2">No products found</div>
                    </div>
                `;
                return;
            }

            inventoryList.innerHTML = products.map(product => {
                const currentStock = product.current_stock || 0;
                const reorderPoint = product.reorder_point || 0;
                const isLowStock = currentStock <= reorderPoint;
                const stockValue = (product.cost_price || 0) * currentStock;

                return `
                    <div class="product-item p-3 border-bottom cursor-pointer" onclick="selectProduct('${product.id}', this)">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="d-flex align-items-center">
                                    <strong>${product.name}</strong>
                                    ${isLowStock ? '<span class="badge bg-warning ms-2">Low Stock</span>' : ''}
                                    ${currentStock === 0 ? '<span class="badge bg-danger ms-2">Out of Stock</span>' : ''}
                                </div>
                                <div class="text-muted small">
                                    SKU: ${product.sku || 'N/A'} | Category: ${product.category || 'Uncategorized'}
                                </div>
                                <div class="text-muted small">
                                    Cost: ${formatCurrency(product.cost_price || 0)} | Selling: ${formatCurrency(product.selling_price || 0)}
                                </div>
                            </div>
                            <div class="text-end">
                                <div class="fw-bold ${isLowStock ? 'text-warning' : 'text-primary'}">${currentStock} units</div>
                                <div class="text-muted small">${formatCurrency(stockValue)}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateInventorySummary(products) {
            const totalCount = products.length;
            const activeCount = products.filter(p => p.active !== false).length;
            const lowStockCount = products.filter(p => (p.current_stock || 0) <= (p.reorder_point || 0)).length;
            const totalValue = products.reduce((sum, p) => sum + ((p.cost_price || 0) * (p.current_stock || 0)), 0);

            document.getElementById('totalProductsCount').textContent = totalCount;
            document.getElementById('activeProductsCount').textContent = activeCount;
            document.getElementById('lowStockCount').textContent = lowStockCount;
            document.getElementById('totalStockValue').textContent = formatCurrency(totalValue);
        }

        async function fetchProductCategories(products) {
            const categories = [...new Set(products.map(p => p.category).filter(Boolean))];
            const categoryFilter = document.getElementById('inventoryCategoryFilter');
            if (categoryFilter) {
                categoryFilter.innerHTML = '<option value="">All Categories</option>' + 
                    categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
            }
        }

        function filterInventoryProducts() {
            const searchTerm = document.getElementById('inventorySearchInput')?.value.toLowerCase() || '';
            const categoryFilter = document.getElementById('inventoryCategoryFilter')?.value || '';
            
            if (!window.allProducts) return;

            const filteredProducts = window.allProducts.filter(product => {
                const matchesSearch = !searchTerm || 
                    product.name.toLowerCase().includes(searchTerm) ||
                    (product.sku || '').toLowerCase().includes(searchTerm) ||
                    (product.category || '').toLowerCase().includes(searchTerm);
                
                const matchesCategory = !categoryFilter || product.category === categoryFilter;
                
                return matchesSearch && matchesCategory;
            });

            displayInventoryProducts(filteredProducts);
        }

        function selectProduct(productId, element) {
            // Remove active class from all product items
            document.querySelectorAll('.product-item').forEach(item => {
                item.classList.remove('active', 'bg-light');
            });
            
            // Add active class to selected item
            element.classList.add('active', 'bg-light');
            
            // Store current product ID
            window.currentProductId = productId;
            
            // Get product details
            const product = window.allProducts?.find(p => p.id === productId);
            if (product) {
                updateProductDetails(product);
                fetchInventoryMovements(productId);
                
                // Enable export button
                const exportBtn = document.getElementById('exportInventoryLedgerBtn');
                if (exportBtn) exportBtn.disabled = false;
            }
        }

        function updateProductDetails(product) {
            // Update product name in header
            document.getElementById('selectedProductName').textContent = product.name;
            
            // Update product information
            document.getElementById('productSKU').textContent = product.sku || 'N/A';
            document.getElementById('productCategory').textContent = product.category || 'Uncategorized';
            document.getElementById('productCostPrice').textContent = formatCurrency(product.cost_price || 0);
            document.getElementById('productSellingPrice').textContent = formatCurrency(product.selling_price || 0);
            
            // Update stock information
            const currentStock = product.current_stock || 0;
            const stockValue = (product.cost_price || 0) * currentStock;
            
            document.getElementById('productCurrentStock').textContent = currentStock;
            document.getElementById('productReorderPoint').textContent = product.reorder_point || 0;
            document.getElementById('productStockValue').textContent = formatCurrency(stockValue);
            
            // Show the details panel
            document.getElementById('productDetailsPanel').style.display = 'block';
        }

        async function fetchInventoryMovements(productId) {
            try {
                // Show loading state
                const movementsBody = document.getElementById('inventoryMovementsBody');
                if (movementsBody) {
                    movementsBody.innerHTML = `
                        <tr>
                            <td colspan="9" class="text-center">
                                <div class="spinner-border spinner-border-sm" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                Loading movements...
                            </td>
                        </tr>
                    `;
                }

                // Get filter parameters
                const movementTypeFilter = document.getElementById('movementTypeFilter')?.value || '';
                const fromDate = document.getElementById('movementFromDate')?.value || '';
                const toDate = document.getElementById('movementToDate')?.value || '';

                let allMovements = [];

                // Get branch ID (you might need to implement branch selection)
                const branchId = await getCurrentBranchId();

                // 1. Get stock movements from branch stock API
                try {
                    const params = new URLSearchParams();
                    params.append('days', '365'); // Get last year of data
                    if (productId) params.append('product_id', productId);

                    const stockUrl = `/api/v1/branch-stock/${branchId}/stock-movements?${params.toString()}`;
                    const stockResponse = await fetch(stockUrl);
                    if (stockResponse.ok) {
                        const stockMovements = await stockResponse.json();
                        
                        stockMovements.forEach(movement => {
                            allMovements.push({
                                date: movement.created_at,
                                reference: movement.reference_number || movement.transaction_id?.slice(-8) || 'N/A',
                                type: movement.transaction_type,
                                description: movement.notes || movement.transaction_type,
                                qty_in: movement.transaction_type.includes('in') || movement.transaction_type.includes('purchase') ? movement.quantity : 0,
                                qty_out: movement.transaction_type.includes('out') || movement.transaction_type.includes('sale') ? movement.quantity : 0,
                                unit_cost: 0, // We'll calculate this from product data
                                source: 'stock_movement'
                            });
                        });
                    }
                } catch (e) {
                    console.log('Branch stock movements API error:', e);
                }

                // 2. Get sales data for this product
                try {
                    const salesParams = new URLSearchParams();
                    salesParams.append('limit', '500');
                    if (fromDate) salesParams.append('from_date', fromDate);
                    if (toDate) salesParams.append('to_date', toDate);

                    const salesUrl = `/api/v1/sales/sales?${salesParams.toString()}`;
                    const salesResponse = await fetch(salesUrl);
                    if (salesResponse.ok) {
                        const sales = await salesResponse.json();
                        
                        // Filter sales that contain this product
                        sales.forEach(sale => {
                            if (sale.items && sale.items.some(item => item.product_id === productId)) {
                                const productItem = sale.items.find(item => item.product_id === productId);
                                allMovements.push({
                                    date: sale.date,
                                    reference: sale.receipt_number || `SALE-${sale.id?.slice(-8) || 'N/A'}`,
                                    type: 'sale',
                                    description: `Sale - ${sale.payment_method || 'Cash'}`,
                                    qty_in: 0,
                                    qty_out: productItem.quantity,
                                    unit_cost: productItem.unit_price || 0,
                                    source: 'sale'
                                });
                            }
                        });
                    }
                } catch (e) {
                    console.log('Sales API error:', e);
                }

                // Apply movement type filter
                if (movementTypeFilter) {
                    allMovements = allMovements.filter(movement => {
                        return movement.type.toLowerCase().includes(movementTypeFilter.toLowerCase());
                    });
                }

                // Apply date filters
                if (fromDate || toDate) {
                    allMovements = allMovements.filter(movement => {
                        const movementDate = new Date(movement.date);
                        const from = fromDate ? new Date(fromDate) : new Date(0);
                        const to = toDate ? new Date(toDate) : new Date();
                        return movementDate >= from && movementDate <= to;
                    });
                }

                // Sort by date (newest first)
                allMovements.sort((a, b) => new Date(b.date) - new Date(a.date));

                displayInventoryMovements(allMovements);

            } catch (error) {
                console.error('Error fetching inventory movements:', error);
                const movementsBody = document.getElementById('inventoryMovementsBody');
                if (movementsBody) {
                    movementsBody.innerHTML = `
                        <tr>
                            <td colspan="9" class="text-center text-danger">
                                Error loading movements: ${error.message}
                            </td>
                        </tr>
                    `;
                }
            }
        }

        function displayInventoryMovements(movements) {
            const movementsBody = document.getElementById('inventoryMovementsBody');
            if (!movementsBody) return;

            if (!movements || movements.length === 0) {
                movementsBody.innerHTML = `
                    <tr>
                        <td colspan="9" class="text-center text-muted">
                            No stock movements found for this product
                        </td>
                    </tr>
                `;
                return;
            }

            let runningBalance = 0;
            movementsBody.innerHTML = movements.map(movement => {
                const qtyIn = parseFloat(movement.qty_in || 0);
                const qtyOut = parseFloat(movement.qty_out || 0);
                runningBalance += qtyIn - qtyOut;
                
                const unitCost = parseFloat(movement.unit_cost || 0);
                const totalValue = (qtyIn || qtyOut) * unitCost;

                const movementTypeBadge = getMovementTypeBadge(movement.type);

                return `
                    <tr>
                        <td>${formatDate(movement.date)}</td>
                        <td>${movement.reference || '-'}</td>
                        <td>
                            <span class="badge ${movementTypeBadge}">${movement.type}</span>
                        </td>
                        <td>${movement.description || '-'}</td>
                        <td class="text-end ${qtyIn > 0 ? 'text-success fw-bold' : ''}">${qtyIn > 0 ? qtyIn : '-'}</td>
                        <td class="text-end ${qtyOut > 0 ? 'text-danger fw-bold' : ''}">${qtyOut > 0 ? qtyOut : '-'}</td>
                        <td class="text-end fw-bold">${runningBalance}</td>
                        <td class="text-end">${unitCost > 0 ? formatCurrency(unitCost) : '-'}</td>
                        <td class="text-end">${totalValue > 0 ? formatCurrency(totalValue) : '-'}</td>
                    </tr>
                `;
            }).join('');
        }

        function getMovementTypeBadge(type) {
            const lowerType = type.toLowerCase();
            if (lowerType.includes('sale')) return 'bg-danger';
            if (lowerType.includes('purchase')) return 'bg-success';
            if (lowerType.includes('adjustment')) return 'bg-warning';
            if (lowerType.includes('transfer')) return 'bg-info';
            if (lowerType.includes('return')) return 'bg-secondary';
            return 'bg-light text-dark';
        }

        async function getCurrentBranchId() {
            // For now, return a default branch ID
            // In a real implementation, you would get this from user session or selection
            try {
                const response = await fetch('/api/v1/branches?limit=1');
                if (response.ok) {
                    const branches = await response.json();
                    return branches.length > 0 ? branches[0].id : 'default-branch';
                }
            } catch (e) {
                console.log('Could not fetch branches, using default');
            }
            return 'default-branch';
        }

        function refreshInventoryMovements() {
            if (window.currentProductId) {
                fetchInventoryMovements(window.currentProductId);
            }
        }

        // Inventory Ledger Export Functions
        function printInventoryLedger() {
            const selectedProductName = document.getElementById('selectedProductName').textContent;
            if (selectedProductName === 'Select a product to view ledger') {
                alert('Please select a product first.');
                return;
            }

            const product = window.allProducts?.find(p => p.id === window.currentProductId);
            const movements = getInventoryMovementsData();

            // Create print content
            const printContent = createInventoryLedgerPrintContent(selectedProductName, product, movements);

            // Open print window
            const printWindow = window.open('', '', 'width=800,height=600');
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
            printWindow.close();
        }

        function exportInventoryLedger(format) {
            const selectedProductName = document.getElementById('selectedProductName').textContent;
            if (selectedProductName === 'Select a product to view ledger') {
                alert('Please select a product first.');
                return;
            }

            const product = window.allProducts?.find(p => p.id === window.currentProductId);
            const movements = getInventoryMovementsData();

            switch (format) {
                case 'pdf':
                    exportInventoryLedgerToPDF(selectedProductName, product, movements);
                    break;
                case 'excel':
                    exportInventoryLedgerToExcel(selectedProductName, product, movements);
                    break;
                case 'csv':
                    exportInventoryLedgerToCSV(selectedProductName, product, movements);
                    break;
                default:
                    alert('Unsupported export format');
            }
        }

        function getInventoryMovementsData() {
            const table = document.querySelector('#inventoryMovementsBody');
            if (!table) return [];

            const movements = [];
            const rows = table.querySelectorAll('tr');

            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 9 && !cells[0].textContent.includes('Select a product')) {
                    movements.push({
                        date: cells[0].textContent.trim(),
                        reference: cells[1].textContent.trim(),
                        type: cells[2].textContent.trim(),
                        description: cells[3].textContent.trim(),
                        qty_in: cells[4].textContent.trim(),
                        qty_out: cells[5].textContent.trim(),
                        balance: cells[6].textContent.trim(),
                        unit_cost: cells[7].textContent.trim(),
                        total_value: cells[8].textContent.trim()
                    });
                }
            });

            return movements;
        }

        function createInventoryLedgerPrintContent(productName, product, movements) {
            const currentDate = new Date().toLocaleDateString();

            return `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Inventory Ledger - ${productName}</title>
                    <meta charset="utf-8">
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; font-size: 12px; }
                        .print-header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #000; padding-bottom: 10px; }
                        .print-title { font-size: 24px; font-weight: bold; margin-bottom: 10px; }
                        .print-subtitle { font-size: 16px; margin-bottom: 5px; }
                        .print-date { font-size: 12px; color: #666; }
                        .product-summary { border: 1px solid #000; padding: 15px; margin-bottom: 20px; background-color: #f8f9fa; }
                        .summary-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
                        .summary-item { text-align: center; }
                        .summary-label { font-size: 10px; color: #666; margin-bottom: 5px; }
                        .summary-value { font-size: 14px; font-weight: bold; }
                        table { width: 100%; border-collapse: collapse; font-size: 10px; margin-top: 20px; }
                        th { border: 1px solid #000; padding: 6px; background-color: #f8f9fa; font-weight: bold; text-align: center; }
                        td { border: 1px solid #ddd; padding: 4px; }
                        .text-end { text-align: right; }
                        .fw-bold { font-weight: bold; }
                        .print-footer { margin-top: 30px; text-align: center; font-size: 10px; color: #666; border-top: 1px solid #ddd; padding-top: 10px; }
                        @media print {
                            body { margin: 0; }
                            .print-header { page-break-inside: avoid; }
                        }
                    </style>
                </head>
                <body>
                    <div class="print-header">
                        <div class="print-title">Inventory Ledger Report</div>
                        <p class="print-subtitle">Product: ${productName}</p>
                        <p class="print-date">Generated on: ${currentDate}</p>
                    </div>

                    <div class="product-summary">
                        <h4 style="margin-top: 0;">Product Summary</h4>
                        <div class="summary-grid">
                            <div class="summary-item">
                                <div class="summary-label">SKU</div>
                                <div class="summary-value">${product?.sku || 'N/A'}</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-label">Category</div>
                                <div class="summary-value">${product?.category || 'N/A'}</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-label">Current Stock</div>
                                <div class="summary-value">${product?.current_stock || 0}</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-label">Stock Value</div>
                                <div class="summary-value">${formatCurrency((product?.cost_price || 0) * (product?.current_stock || 0))}</div>
                            </div>
                        </div>
                    </div>

                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Reference</th>
                                <th>Type</th>
                                <th>Description</th>
                                <th>Qty In</th>
                                <th>Qty Out</th>
                                <th>Balance</th>
                                <th>Unit Cost</th>
                                <th>Total Value</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${generateInventoryMovementRows(movements)}
                        </tbody>
                    </table>

                    <div class="print-footer">
                        <p>CNPERP - Inventory Ledger Report | Product: ${productName} | Total Movements: ${movements.length} | Generated: ${currentDate}</p>
                    </div>
                </body>
                </html>
            `;
        }

        function generateInventoryMovementRows(movements) {
            if (movements.length === 0) {
                return '<tr><td colspan="9" style="text-align: center; color: #666;">No movements found</td></tr>';
            }

            return movements.map(movement => `
                <tr>
                    <td>${movement.date}</td>
                    <td>${movement.reference}</td>
                    <td>${movement.type}</td>
                    <td>${movement.description}</td>
                    <td class="text-end">${movement.qty_in}</td>
                    <td class="text-end">${movement.qty_out}</td>
                    <td class="text-end fw-bold">${movement.balance}</td>
                    <td class="text-end">${movement.unit_cost}</td>
                    <td class="text-end">${movement.total_value}</td>
                </tr>
            `).join('');
        }

        function exportInventoryLedgerToPDF(productName, product, movements) {
            const printContent = createInventoryLedgerPrintContent(productName, product, movements);

            const printWindow = window.open('', '', 'width=800,height=600');
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.focus();

            alert('Please use your browser\'s "Print" function and select "Save as PDF" as the destination.');
            printWindow.print();
        }

        function exportInventoryLedgerToExcel(productName, product, movements) {
            const currentDate = new Date().toLocaleDateString();

            let csvContent = `Inventory Ledger Report\n`;
            csvContent += `Product: ${productName}\n`;
            csvContent += `SKU: ${product?.sku || 'N/A'}\n`;
            csvContent += `Category: ${product?.category || 'N/A'}\n`;
            csvContent += `Current Stock: ${product?.current_stock || 0}\n`;
            csvContent += `Generated: ${currentDate}\n\n`;
            csvContent += `Stock Movements\n`;
            csvContent += `Date,Reference,Type,Description,Qty In,Qty Out,Balance,Unit Cost,Total Value\n`;

            movements.forEach(movement => {
                csvContent += `"${movement.date}","${movement.reference}","${movement.type}","${movement.description}","${movement.qty_in}","${movement.qty_out}","${movement.balance}","${movement.unit_cost}","${movement.total_value}"\n`;
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `Inventory_Ledger_${productName.replace(/[^a-z0-9]/gi, '_')}_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function exportInventoryLedgerToCSV(productName, product, movements) {
            let csvContent = `Date,Reference,Type,Description,Qty In,Qty Out,Balance,Unit Cost,Total Value\n`;

            movements.forEach(movement => {
                csvContent += `"${movement.date}","${movement.reference}","${movement.type}","${movement.description}","${movement.qty_in}","${movement.qty_out}","${movement.balance}","${movement.unit_cost}","${movement.total_value}"\n`;
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `Inventory_Ledger_${productName.replace(/[^a-z0-9]/gi, '_')}_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function exportInventoryList(format) {
            const products = getAllInventoryData();

            switch (format) {
                case 'pdf':
                    exportInventoryListToPDF(products);
                    break;
                case 'excel':
                    exportInventoryListToExcel(products);
                    break;
                case 'csv':
                    exportInventoryListToCSV(products);
                    break;
                default:
                    alert('Unsupported export format');
            }
        }

        function getAllInventoryData() {
            const productItems = document.querySelectorAll('.product-item');
            const products = [];

            productItems.forEach(item => {
                const nameElement = item.querySelector('strong');
                const stockElement = item.querySelector('.fw-bold');
                const detailsElement = item.querySelector('.text-muted');
                
                if (nameElement && stockElement) {
                    products.push({
                        name: nameElement.textContent || '',
                        stock: stockElement.textContent || '0',
                        details: detailsElement ? detailsElement.textContent : ''
                    });
                }
            });

            return products;
        }

        function exportInventoryListToPDF(products) {
            const currentDate = new Date().toLocaleDateString();

            const printContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Inventory List Report</title>
                    <meta charset="utf-8">
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .print-header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #000; padding-bottom: 10px; }
                        .print-title { font-size: 24px; font-weight: bold; margin-bottom: 10px; }
                        .print-date { font-size: 12px; color: #666; }
                        table { width: 100%; border-collapse: collapse; font-size: 12px; }
                        th { border: 1px solid #000; padding: 8px; background-color: #f8f9fa; font-weight: bold; }
                        td { border: 1px solid #ddd; padding: 6px; }
                        .text-end { text-align: right; }
                        .print-footer { margin-top: 30px; text-align: center; font-size: 10px; color: #666; border-top: 1px solid #ddd; padding-top: 10px; }
                    </style>
                </head>
                <body>
                    <div class="print-header">
                        <div class="print-title">Inventory List Report</div>
                        <p class="print-date">Generated on: ${currentDate}</p>
                    </div>

                    <table>
                        <thead>
                            <tr>
                                <th>Product Name</th>
                                <th>Current Stock</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${products.map(product => `
                                <tr>
                                    <td>${product.name}</td>
                                    <td class="text-end">${product.stock}</td>
                                    <td>${product.details}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>

                    <div class="print-footer">
                        <p>CNPERP - Inventory List Report | Total Products: ${products.length} | Generated: ${currentDate}</p>
                    </div>
                </body>
                </html>
            `;

            const printWindow = window.open('', '', 'width=800,height=600');
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.focus();

            alert('Please use your browser\'s "Print" function and select "Save as PDF" as the destination.');
            printWindow.print();
        }

        function exportInventoryListToExcel(products) {
            const currentDate = new Date().toLocaleDateString();

            let csvContent = `Inventory List Report\n`;
            csvContent += `Generated: ${currentDate}\n`;
            csvContent += `Total Products: ${products.length}\n\n`;
            csvContent += `Product Name,Current Stock,Details\n`;

            products.forEach(product => {
                csvContent += `"${product.name}","${product.stock}","${product.details}"\n`;
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `Inventory_List_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function exportInventoryListToCSV(products) {
            let csvContent = `Product Name,Current Stock,Details\n`;

            products.forEach(product => {
                csvContent += `"${product.name}","${product.stock}","${product.details}"\n`;
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `Inventory_List_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // General Ledger Export Functions
        function printGeneralLedger() {
            const selectedAccountName = document.getElementById('selectedAccountName').textContent;
            if (selectedAccountName === 'Select an account to view ledger') {
                alert('Please select an account first.');
                return;
            }

            const accountSummary = getAccountSummaryData();
            const transactions = getGeneralLedgerTransactions();
            
            // Create print content
            const printContent = createGeneralLedgerPrintContent(selectedAccountName, accountSummary, transactions);
            
            // Open print window
            const printWindow = window.open('', '', 'width=800,height=600');
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
            printWindow.close();
        }

        function exportGeneralLedger(format) {
            const selectedAccountName = document.getElementById('selectedAccountName').textContent;
            if (selectedAccountName === 'Select an account to view ledger') {
                alert('Please select an account first.');
                return;
            }

            const accountSummary = getAccountSummaryData();
            const transactions = getGeneralLedgerTransactions();
            
            switch (format) {
                case 'pdf':
                    exportGeneralLedgerToPDF(selectedAccountName, accountSummary, transactions);
                    break;
                case 'excel':
                    exportGeneralLedgerToExcel(selectedAccountName, accountSummary, transactions);
                    break;
                case 'csv':
                    exportGeneralLedgerToCSV(selectedAccountName, accountSummary, transactions);
                    break;
                default:
                    alert('Unsupported export format');
            }
        }

        function getAccountSummaryData() {
            return {
                openingBalance: document.getElementById('openingBalance')?.textContent || 'P 0.00',
                totalDebits: document.getElementById('totalDebitsDetail')?.textContent || 'P 0.00',
                totalCredits: document.getElementById('totalCreditsDetail')?.textContent || 'P 0.00',
                closingBalance: document.getElementById('closingBalance')?.textContent || 'P 0.00'
            };
        }

        function getGeneralLedgerTransactions() {
            const table = document.querySelector('#transactionsTableBody');
            if (!table) return [];
            
            const transactions = [];
            const rows = table.querySelectorAll('tr');
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 6 && !cells[0].textContent.includes('Select an account')) {
                    transactions.push({
                        date: cells[0].textContent.trim(),
                        reference: cells[1].textContent.trim(),
                        description: cells[2].textContent.trim(),
                        debit: cells[3].textContent.trim(),
                        credit: cells[4].textContent.trim(),
                        balance: cells[5].textContent.trim()
                    });
                }
            });
            
            return transactions;
        }

        function createGeneralLedgerPrintContent(accountName, summary, transactions) {
            const currentDate = new Date().toLocaleDateString();
            
            return `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>General Ledger - ${accountName}</title>
                    <meta charset="utf-8">
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; font-size: 12px; }
                        .print-header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #000; padding-bottom: 10px; }
                        .print-title { font-size: 24px; font-weight: bold; margin-bottom: 10px; }
                        .print-subtitle { font-size: 16px; margin-bottom: 5px; }
                        .print-date { font-size: 12px; color: #666; }
                        .account-summary { border: 1px solid #000; padding: 15px; margin-bottom: 20px; background-color: #f8f9fa; }
                        .summary-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
                        .summary-item { text-align: center; }
                        .summary-label { font-size: 10px; color: #666; margin-bottom: 5px; }
                        .summary-value { font-size: 14px; font-weight: bold; }
                        table { width: 100%; border-collapse: collapse; font-size: 10px; margin-top: 20px; }
                        th { border: 1px solid #000; padding: 8px; background-color: #f8f9fa; font-weight: bold; text-align: center; }
                        td { border: 1px solid #ddd; padding: 6px; }
                        .text-end { text-align: right; }
                        .fw-bold { font-weight: bold; }
                        .print-footer { margin-top: 30px; text-align: center; font-size: 10px; color: #666; border-top: 1px solid #ddd; padding-top: 10px; }
                        @media print {
                            body { margin: 0; }
                            .print-header { page-break-inside: avoid; }
                        }
                    </style>
                </head>
                <body>
                    <div class="print-header">
                        <div class="print-title">General Ledger Report</div>
                        <p class="print-subtitle">Account: ${accountName}</p>
                        <p class="print-date">Generated on: ${currentDate}</p>
                    </div>
                    
                    <div class="account-summary">
                        <h4 style="margin-top: 0;">Account Summary</h4>
                        <div class="summary-grid">
                            <div class="summary-item">
                                <div class="summary-label">Opening Balance</div>
                                <div class="summary-value">${summary.openingBalance}</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-label">Total Debits</div>
                                <div class="summary-value">${summary.totalDebits}</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-label">Total Credits</div>
                                <div class="summary-value">${summary.totalCredits}</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-label">Closing Balance</div>
                                <div class="summary-value">${summary.closingBalance}</div>
                            </div>
                        </div>
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Reference</th>
                                <th>Description</th>
                                <th>Debit</th>
                                <th>Credit</th>
                                <th>Balance</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${generateGeneralLedgerRows(transactions)}
                        </tbody>
                    </table>
                    
                    <div class="print-footer">
                        <p>CNPERP - General Ledger Report | Account: ${accountName} | Total Transactions: ${transactions.length} | Generated: ${currentDate}</p>
                    </div>
                </body>
                </html>
            `;
        }

        function generateGeneralLedgerRows(transactions) {
            if (transactions.length === 0) {
                return '<tr><td colspan="6" style="text-align: center; color: #666;">No transactions found</td></tr>';
            }
            
            return transactions.map(transaction => `
                <tr>
                    <td>${transaction.date}</td>
                    <td>${transaction.reference}</td>
                    <td>${transaction.description}</td>
                    <td class="text-end">${transaction.debit}</td>
                    <td class="text-end">${transaction.credit}</td>
                    <td class="text-end fw-bold">${transaction.balance}</td>
                </tr>
            `).join('');
        }

        function exportGeneralLedgerToPDF(accountName, summary, transactions) {
            const printContent = createGeneralLedgerPrintContent(accountName, summary, transactions);
            
            const printWindow = window.open('', '', 'width=800,height=600');
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.focus();
            
            alert('Please use your browser\'s "Print" function and select "Save as PDF" as the destination.');
            printWindow.print();
        }

        function exportGeneralLedgerToExcel(accountName, summary, transactions) {
            const currentDate = new Date().toLocaleDateString();
            
            let csvContent = `General Ledger Report\n`;
            csvContent += `Account: ${accountName}\n`;
            csvContent += `Generated: ${currentDate}\n\n`;
            csvContent += `Account Summary\n`;
            csvContent += `Opening Balance,${summary.openingBalance}\n`;
            csvContent += `Total Debits,${summary.totalDebits}\n`;
            csvContent += `Total Credits,${summary.totalCredits}\n`;
            csvContent += `Closing Balance,${summary.closingBalance}\n\n`;
            csvContent += `Transactions\n`;
            csvContent += `Date,Reference,Description,Debit,Credit,Balance\n`;
            
            transactions.forEach(transaction => {
                csvContent += `"${transaction.date}","${transaction.reference}","${transaction.description}","${transaction.debit}","${transaction.credit}","${transaction.balance}"\n`;
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `General_Ledger_${accountName.replace(/[^a-z0-9]/gi, '_')}_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function exportGeneralLedgerToCSV(accountName, summary, transactions) {
            let csvContent = `Date,Reference,Description,Debit,Credit,Balance\n`;
            
            transactions.forEach(transaction => {
                csvContent += `"${transaction.date}","${transaction.reference}","${transaction.description}","${transaction.debit}","${transaction.credit}","${transaction.balance}"\n`;
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `General_Ledger_${accountName.replace(/[^a-z0-9]/gi, '_')}_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function refreshLedger() {
            const selectedElement = document.querySelector('.account-item.selected');
            if (selectedElement) {
                selectedElement.click(); // Re-trigger the account selection
            } else {
                // Refresh the account list
                fetchGeneralLedgerEntries();
            }
        }
    </script>
</body>
</html>
