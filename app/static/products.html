<!DOCTYPE html>
<html lang="en" class="light-mode">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CNPERP - Products & Inventory</title>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Auth and Branch Scripts -->
    <script src="/static/js/auth-bootstrap.js"></script>
    <script src="/static/js/auth.js"></script>
    <!-- Page Access Guard - Restrict POS users to POS page only -->
    <script src="/static/js/page-guard.js"></script>

    <!-- Branch Switcher (eligible roles) -->
    <script src="js/branch-switcher.js"></script>

    <style>
        :root {
            --primary-color: #0d6efd;
            --success-color: #198754;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #0dcaf0;
            --dark-color: #212529;
            --light-color: #f8f9fa;
        }

        .light-mode {
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --border-color: #dee2e6;
        }

        .dark-mode {
            --bg-primary: #212529;
            --bg-secondary: #343a40;
            --text-primary: #ffffff;
            --text-secondary: #adb5bd;
            --border-color: #495057;
        }

        body {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .card {
            background-color: var(--bg-primary);
            border-color: var(--border-color);
            transition: all 0.3s ease;
        }

        .navbar {
            background: linear-gradient(135deg, var(--primary-color), #0056b3) !important;
        }

        /* Original products styles below */
        :root {
            --primary-color: #0d6efd;
            --success-color: #198754;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #0dcaf0;
            --dark-color: #212529;
            --light-color: #f8f9fa;
        }

        .light-mode {
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --border-color: #dee2e6;
        }

        .dark-mode {
            --bg-primary: #212529;
            --bg-secondary: #343a40;
            --text-primary: #ffffff;
            --text-secondary: #adb5bd;
            --border-color: #495057;
        }

        body {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .card {
            background-color: var(--bg-primary);
            border-color: var(--border-color);
            transition: all 0.3s ease;
        }

        .navbar {
            background: linear-gradient(135deg, var(--primary-color), #0056b3) !important;
        }

        .product-card {
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease;
        }

        .product-card:hover {
            transform: translateY(-2px);
        }

        .low-stock {
            background-color: rgba(220, 53, 69, 0.1) !important;
            border-left: 4px solid var(--danger-color) !important;
        }

        .out-of-stock {
            background-color: rgba(220, 53, 69, 0.2) !important;
            border-left: 4px solid var(--danger-color) !important;
        }

        .serialized-product {
            background-color: rgba(13, 202, 240, 0.1) !important;
            border-left: 4px solid var(--info-color) !important;
        }

        .perishable-product {
            background-color: rgba(255, 193, 7, 0.1) !important;
            border-left: 4px solid var(--warning-color) !important;
        }

        .modal-content {
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }

        .form-control,
        .form-select {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            border-color: var(--border-color);
        }

        .form-control:focus,
        .form-select:focus {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            border-color: var(--primary-color);
        }

        /* Image Upload Styles */
        .image-upload-container {
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .image-upload-container:hover {
            border-color: var(--primary-color);
            background-color: rgba(13, 110, 253, 0.05);
        }

        .image-upload-area {
            cursor: pointer;
        }

        .upload-placeholder {
            color: var(--text-secondary);
        }

        .image-preview {
            text-align: center;
        }

        .image-preview img {
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .product-image-thumbnail {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 4px;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .product-image-thumbnail:hover {
            transform: scale(1.1);
        }

        .product-image-modal .modal-dialog {
            max-width: 600px;
        }

        .product-image-modal img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
        }

        .inventory-chart {
            max-height: 300px;
        }

        /* Accounting code section styling */
        #accountingCodeSection,
        #editAccountingCodeSection {
            background-color: rgba(13, 110, 253, 0.05);
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
            border: 1px solid rgba(13, 110, 253, 0.2);
        }

        #accountingCodeSection .form-label,
        #editAccountingCodeSection .form-label {
            font-weight: 600;
            color: var(--primary-color);
        }

        #accountingCodeSection small,
        #editAccountingCodeSection small {
            font-size: 0.875rem;
        }
    </style>
</head>

<body>
    <!-- Navigation Bar Container -->
    <div id="navbar-container"></div>
    <!-- Navbar Scripts -->
    <script src="js/navbar.js?v=20250121001"></script>

    <!-- Spacer to prevent content from being hidden under fixed navbar -->
    <div style="height: 70px;"></div>

    <!-- Main Content -->
    <div class="container-fluid mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="text-primary">
                <i class="bi bi-box-seam me-2"></i>Products & Inventory
            </h1>
            <div>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newProductModal">
                    <i class="bi bi-plus-circle me-2"></i>New Product
                </button>
                <button class="btn btn-success ms-2" data-bs-toggle="modal" data-bs-target="#inventoryAdjustmentModal">
                    <i class="bi bi-arrow-repeat me-2"></i>Inventory Adjustment
                </button>
                <button class="btn btn-warning ms-2" data-bs-toggle="modal"
                    data-bs-target="#productDimensionalReportModal">
                    <i class="bi bi-graph-up me-2"></i>Dimensional Reports
                </button>
                <button class="btn btn-info ms-2" id="downloadTemplateBtn">
                    <i class="bi bi-file-earmark-text me-2"></i>Download Import Template
                </button>
                <button class="btn btn-secondary ms-2" id="uploadTemplateBtn">
                    <i class="bi bi-upload me-2"></i>Upload Completed Template
                </button>
                <input type="file" id="productImportInput" accept=".xlsx,.xls" style="display:none;" />
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <div class="card text-center">
                    <div class="card-body">
                        <i class="bi bi-box-seam text-primary fs-1"></i>
                        <h4 class="mt-2" id="totalProducts">-</h4>
                        <p class="text-muted mb-0">Total Products</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card text-center">
                    <div class="card-body">
                        <i class="bi bi-exclamation-triangle text-warning fs-1"></i>
                        <h4 class="mt-2" id="lowStockCount">-</h4>
                        <p class="text-muted mb-0">Low Stock Items</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card text-center">
                    <div class="card-body">
                        <i class="bi bi-x-circle text-danger fs-1"></i>
                        <h4 class="mt-2" id="outOfStockCount">-</h4>
                        <p class="text-muted mb-0">Out of Stock</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card text-center">
                    <div class="card-body">
                        <i class="bi bi-currency-dollar text-success fs-1"></i>
                        <h4 class="mt-2" id="totalValue">-</h4>
                        <p class="text-muted mb-0">Total Inventory Value</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters and Search -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-2">
                        <label for="viewModeSwitch" class="form-label">View Mode</label>
                        <div class="form-check form-switch mt-1">
                            <input class="form-check-input" type="checkbox" id="viewModeSwitch" />
                            <label class="form-check-label" for="viewModeSwitch"><span
                                    id="viewModeLabel">HQ</span></label>
                        </div>
                        <small class="text-muted">Toggle to Branch to view per-branch stock</small>
                    </div>
                    <div class="col-md-2">
                        <label for="branchFilter" class="form-label">Branch (for branch view)</label>
                        <select class="form-select" id="branchFilter">
                            <option value="">All Branches</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="categoryFilter" class="form-label">Category</label>
                        <select class="form-select" id="categoryFilter">
                            <option value="">All Categories</option>
                            <option value="Electronics">Electronics</option>
                            <option value="Clothing">Clothing</option>
                            <option value="Food">Food</option>
                            <option value="Beverages">Beverages</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="stockFilter" class="form-label">Stock Status</label>
                        <select class="form-select" id="stockFilter">
                            <option value="">All Status</option>
                            <option value="in-stock">In Stock</option>
                            <option value="low-stock">Low Stock</option>
                            <option value="out-of-stock">Out of Stock</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="productTypeFilter" class="form-label">Product Type</label>
                        <select class="form-select" id="productTypeFilter">
                            <option value="">All Types</option>
                            <option value="inventory_item">Inventory Item</option>
                            <option value="service">Service</option>
                            <option value="assembly">Assembly</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="taxStatusFilter" class="form-label">Tax Status</label>
                        <select class="form-select" id="taxStatusFilter">
                            <option value="">All Tax Status</option>
                            <option value="taxable">Taxable</option>
                            <option value="non-taxable">Non-Taxable</option>
                        </select>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-2">
                        <label for="costCenterFilter" class="form-label">Cost Center</label>
                        <select class="form-select" id="costCenterFilter">
                            <option value="">All Cost Centers</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="projectFilter" class="form-label">Project</label>
                        <select class="form-select" id="projectFilter">
                            <option value="">All Projects</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="searchFilter" class="form-label">Search</label>
                        <input type="text" class="form-control" id="searchFilter" placeholder="Search products...">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">&nbsp;</label>
                        <div class="d-grid">
                            <button class="btn btn-outline-secondary" onclick="clearFilters()">
                                <i class="bi bi-x-circle me-2"></i>Clear
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Products Table -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-table me-2"></i>Product Inventory</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="productsTable">
                        <thead class="table-light">
                            <tr>
                                <th>Image</th>
                                <th>SKU</th>
                                <th>Name</th>
                                <th>Category</th>
                                <th>Unit</th>
                                <th>Quantity</th>
                                <th>Cost Center</th>
                                <th>Project</th>
                                <th class="text-end">Cost Price</th>
                                <th class="text-end">Selling Price</th>
                                <th class="text-end">Total Value</th>
                                <th>Tax Status</th>
                                <th>Status</th>
                                <th class="text-end">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="productsBody">
                            <!-- Products will be loaded here -->
                        </tbody>
                    </table>
                </div>
                <div id="branchAllocPanel" class="mt-3" style="display:none;">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0"><i class="bi bi-list-check me-2"></i>Allocations for Selected Branch</h6>
                        <button class="btn btn-outline-secondary btn-sm" id="btnBranchPanelRefresh"
                            title="Refresh branch allocations"><i class="bi bi-arrow-clockwise"></i></button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-sm table-hover align-middle">
                            <thead>
                                <tr>
                                    <th>Reference</th>
                                    <th>Product</th>
                                    <th class="text-end">Allocated</th>
                                    <th class="text-end">Received</th>
                                    <th class="text-end">Available</th>
                                    <th>Status</th>
                                    <th>Tracking</th>
                                </tr>
                            </thead>
                            <tbody id="branchAllocPanelBody"></tbody>
                        </table>
                    </div>
                    <small class="text-muted">Showing latest allocations for this branch</small>
                </div>
            </div>
        </div>
    </div>

    <!-- New Product Modal -->
    <div class="modal fade" id="newProductModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">New Product</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="newProductForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="productName" class="form-label">Product Name *</label>
                                    <input type="text" class="form-control" id="productName" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="productSku" class="form-label">SKU *</label>
                                    <input type="text" class="form-control" id="productSku" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="productCategory" class="form-label">Category</label>
                                    <select class="form-select" id="productCategory"
                                        onchange="toggleSellingPriceRequirement()">
                                        <option value="">Select Category</option>
                                        <option value="raw_material">Raw Materials</option>
                                        <option value="component">Components & Spares</option>
                                        <option value="manufactured">Manufactured Goods</option>
                                        <option value="service">Service</option>
                                        <option value="digital">Digital</option>
                                        <option value="Electronics">Electronics</option>
                                        <option value="Clothing">Clothing</option>
                                        <option value="Food">Food</option>
                                        <option value="Beverages">Beverages</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="productType" class="form-label">Product Type</label>
                                    <select class="form-select" id="productType" onchange="toggleAccountingFields()">
                                        <option value="inventory_item">Inventory Item</option>
                                        <option value="service">Service</option>
                                        <option value="assembly">Assembly</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="isRawMaterialOnly">
                                    <label class="form-check-label" for="isRawMaterialOnly">
                                        Raw material only (non-saleable)
                                    </label>
                                    <small class="text-muted d-block">Prevents selling this item directly; it can be
                                        used in manufacturing, repair, and upgrades only.</small>
                                </div>
                            </div>
                        </div>
                        <!-- Accounting Code Section (for inventory items) -->
                        <div id="accountingCodeSection" class="row" style="display: block;">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="accountingCodeType" class="form-label">Account Type *</label>
                                    <select class="form-select" id="accountingCodeType"
                                        onchange="updateAccountingCategories()" required>
                                        <option value="">Select Account Type</option>
                                        <option value="Asset" selected>Asset</option>
                                    </select>
                                    <small class="text-muted">For inventory items, Asset type is recommended</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="accountingCodeCategory" class="form-label">Account Category *</label>
                                    <select class="form-select" id="accountingCodeCategory"
                                        onchange="updateAccountingCodes()" required>
                                        <option value="">Select Category</option>
                                        <option value="Inventory" selected>Inventory</option>
                                        <option value="Current Asset">Current Asset</option>
                                        <option value="Fixed Asset">Fixed Asset</option>
                                    </select>
                                    <small class="text-muted">Categories appropriate for inventory tracking</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="accountingCode" class="form-label">Specific Account Code *</label>
                                    <select class="form-select" id="accountingCode" required>
                                        <option value="">Select Account Code</option>
                                    </select>
                                    <small class="text-muted">Choose the specific inventory account</small>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="costPrice" class="form-label">Cost Price *</label>
                                    <input type="number" class="form-control" id="costPrice" step="0.01" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="sellingPrice" class="form-label">Selling Price <span
                                            id="sellingPriceRequired">*</span></label>
                                    <input type="number" class="form-control" id="sellingPrice" step="0.01">
                                    <small class="text-muted" id="sellingPriceHint" style="display: none;">Optional for
                                        raw materials and components</small>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="initialQuantity" class="form-label">Initial Quantity</label>
                                    <input type="number" class="form-control" id="initialQuantity" value="0">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="unitOfMeasure" class="form-label">Unit of Measure *</label>
                                    <div class="input-group">
                                        <select class="form-select" id="unitOfMeasure" required>
                                            <option value="">Select Unit</option>
                                        </select>
                                        <button class="btn btn-outline-secondary" type="button" id="uomInfoBtn"
                                            title="Show base and conversion">UOM</button>
                                    </div>
                                    <small id="uomHint" class="text-muted d-block mt-1"></small>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="taxableStatus" class="form-label">Taxable Status *</label>
                                    <select class="form-select" id="taxableStatus" required>
                                        <option value="taxable">Taxable</option>
                                        <option value="non-taxable">Non-Taxable</option>
                                    </select>
                                    <small class="text-muted">Select 'Non-Taxable' if this product should not be levied
                                        any tax during purchase or sale.</small>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="productDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="productDescription" rows="3"></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="barcode" class="form-label">Barcode</label>
                                    <input type="text" class="form-control" id="barcode">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="reorderLevel" class="form-label">Reorder Level</label>
                                    <input type="number" class="form-control" id="reorderLevel" value="10">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="isSerialized">
                                    <label class="form-check-label" for="isSerialized">
                                        Serialized Product
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="isPerishable">
                                    <label class="form-check-label" for="isPerishable">
                                        Perishable Product
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="isTaxable" checked>
                                    <label class="form-check-label" for="isTaxable">
                                        Taxable Product
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Dimensional Accounting Section -->
                        <div class="row mt-3">
                            <div class="col-12">
                                <div class="card border-info">
                                    <div class="card-header bg-info text-white">
                                        <h6 class="mb-0">
                                            <i class="bi bi-diagram-3 me-2"></i>Dimensional Accounting
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="productCostCenter" class="form-label">Cost
                                                        Center</label>
                                                    <select class="form-select" id="productCostCenter">
                                                        <option value="">Select Cost Center</option>
                                                    </select>
                                                    <small class="text-muted">Assign this product to a specific cost
                                                        center for tracking</small>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="productProject" class="form-label">Project</label>
                                                    <select class="form-select" id="productProject">
                                                        <option value="">Select Project</option>
                                                    </select>
                                                    <small class="text-muted">Link this product to a specific
                                                        project</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Weight-Based Product Section (Meat, Fruits, Vegetables) -->
                        <div class="row mt-3">
                            <div class="col-12">
                                <div class="card border-warning">
                                    <div class="card-header bg-warning text-dark">
                                        <h6 class="mb-0">
                                            <i class="bi bi-speedometer2"></i> Weight-Based Product
                                            <small class="text-muted">(For meat, fruits, vegetables sold by
                                                weight)</small>
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-12 mb-3">
                                                <div class="form-check form-switch">
                                                    <input class="form-check-input" type="checkbox" id="isWeightBased"
                                                        onchange="toggleWeightFields()">
                                                    <label class="form-check-label" for="isWeightBased">
                                                        <strong>Enable Weight-Based Selling</strong>
                                                        <br><small class="text-muted">Products will be sold using weight
                                                            barcodes (barcode encodes weight)</small>
                                                    </label>
                                                </div>
                                            </div>
                                        </div>

                                        <div id="weightBasedFields" style="display: none;">
                                            <div class="row">
                                                <div class="col-md-4 mb-3">
                                                    <label for="weightCategory" class="form-label">Product Category
                                                        *</label>
                                                    <select class="form-select" id="weightCategory"
                                                        onchange="updateBarcodePrefix()">
                                                        <option value="">Select Category</option>
                                                        <option value="20">Meat (Code: 20)</option>
                                                        <option value="21">Fruits (Code: 21)</option>
                                                        <option value="22">Vegetables (Code: 22)</option>
                                                        <option value="23">Dairy (Code: 23)</option>
                                                        <option value="24">Bakery (Code: 24)</option>
                                                    </select>
                                                    <small class="text-muted">Determines barcode prefix for
                                                        scanning</small>
                                                </div>
                                                <div class="col-md-4 mb-3">
                                                    <label for="weightBarcodeSku" class="form-label">Product Code (5
                                                        digits) *</label>
                                                    <input type="text" class="form-control" id="weightBarcodeSku"
                                                        maxlength="5" pattern="[0-9]{5}" placeholder="e.g., 12345"
                                                        onkeyup="updateBarcodePreview()">
                                                    <small class="text-muted">Unique 5-digit code for this
                                                        product</small>
                                                </div>
                                                <div class="col-md-4 mb-3">
                                                    <label class="form-label">Sample Barcode</label>
                                                    <div class="alert alert-info py-2 px-3 mb-0">
                                                        <code id="barcodePreview" style="font-size: 0.9rem;">--</code>
                                                    </div>
                                                    <small class="text-muted">Preview for 1.5kg item</small>
                                                </div>
                                            </div>

                                            <div class="row">
                                                <div class="col-md-6 mb-3">
                                                    <label for="pricePerKg" class="form-label">Price per Kilogram (R)
                                                        *</label>
                                                    <div class="input-group">
                                                        <span class="input-group-text">R</span>
                                                        <input type="number" class="form-control" id="pricePerKg"
                                                            step="0.01" min="0" placeholder="e.g., 125.50"
                                                            onchange="calculatePricePerGram()">
                                                        <span class="input-group-text">/kg</span>
                                                    </div>
                                                    <small class="text-muted">Base price for weight calculation</small>
                                                </div>
                                                <div class="col-md-6 mb-3">
                                                    <label for="pricePerGram" class="form-label">Price per Gram
                                                        (R)</label>
                                                    <div class="input-group">
                                                        <span class="input-group-text">R</span>
                                                        <input type="number" class="form-control" id="pricePerGram"
                                                            step="0.0001" readonly>
                                                        <span class="input-group-text">/g</span>
                                                    </div>
                                                    <small class="text-muted">Auto-calculated from price per kg</small>
                                                </div>
                                            </div>

                                            <div class="row">
                                                <div class="col-md-4 mb-3">
                                                    <label for="tareWeight" class="form-label">Tare Weight
                                                        (grams)</label>
                                                    <div class="input-group">
                                                        <input type="number" class="form-control" id="tareWeight"
                                                            step="0.1" min="0" placeholder="e.g., 50" value="0">
                                                        <span class="input-group-text">g</span>
                                                    </div>
                                                    <small class="text-muted">Container/packaging weight to
                                                        deduct</small>
                                                </div>
                                                <div class="col-md-4 mb-3">
                                                    <label for="minWeight" class="form-label">Min Weight (grams)</label>
                                                    <div class="input-group">
                                                        <input type="number" class="form-control" id="minWeight"
                                                            step="1" min="0" placeholder="e.g., 100">
                                                        <span class="input-group-text">g</span>
                                                    </div>
                                                    <small class="text-muted">Minimum sellable weight</small>
                                                </div>
                                                <div class="col-md-4 mb-3">
                                                    <label for="maxWeight" class="form-label">Max Weight (grams)</label>
                                                    <div class="input-group">
                                                        <input type="number" class="form-control" id="maxWeight"
                                                            step="1" min="0" placeholder="e.g., 10000">
                                                        <span class="input-group-text">g</span>
                                                    </div>
                                                    <small class="text-muted">Maximum sellable weight (optional)</small>
                                                </div>
                                            </div>

                                            <div class="alert alert-info">
                                                <strong><i class="bi bi-info-circle"></i> How Weight Barcodes
                                                    Work:</strong>
                                                <ul class="mb-0 mt-2" style="font-size: 0.9rem;">
                                                    <li>Barcode Format:
                                                        <code>[Category:2][Product:5][Weight:5][Check:1]</code>
                                                    </li>
                                                    <li>Example: <code>20-12345-01500-7</code> = Meat, Product 12345,
                                                        1500g (1.5kg)</li>
                                                    <li>Generate barcodes at scale/counter with actual weight</li>
                                                    <li>POS automatically calculates price: Weight Ã— Price/kg</li>
                                                    <li>Tare weight is subtracted automatically</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Product Image Upload Section -->
                        <div class="row">
                            <div class="col-12">
                                <div class="mb-3">
                                    <label class="form-label">Product Image</label>
                                    <div class="image-upload-container">
                                        <div class="image-preview" id="imagePreview" style="display: none;">
                                            <img id="previewImg" src="" alt="Product Image" class="img-thumbnail"
                                                style="max-width: 200px; max-height: 200px;">
                                            <button type="button" class="btn btn-sm btn-danger mt-2"
                                                onclick="removeImage()">
                                                <i class="bi bi-trash"></i> Remove Image
                                            </button>
                                        </div>
                                        <div class="image-upload-area" id="imageUploadArea">
                                            <div class="upload-placeholder">
                                                <i class="bi bi-image fs-1 text-muted"></i>
                                                <p class="mt-2 mb-0">Click to upload product image</p>
                                                <small class="text-muted">Supports JPG, PNG, GIF (Max 10MB)</small>
                                            </div>
                                            <input type="file" id="productImage" accept="image/*" style="display: none;"
                                                onchange="handleImageUpload(event)">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row" id="perishableFields" style="display: none;">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="expiryDate" class="form-label">Expiry Date</label>
                                    <input type="date" class="form-control" id="expiryDate">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="batchNumber" class="form-label">Batch Number</label>
                                    <input type="text" class="form-control" id="batchNumber">
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveProduct()">Save Product</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Inventory Adjustment Modal -->
    <div class="modal fade" id="inventoryAdjustmentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Inventory Adjustment</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="adjustmentForm">
                        <div class="mb-3">
                            <label for="adjustmentProduct" class="form-label">Product *</label>
                            <select class="form-select" id="adjustmentProduct" required>
                                <option value="">Select Product</option>
                                <!-- Products will be loaded here -->
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="adjustmentQuantity" class="form-label">Quantity Change *</label>
                            <input type="number" class="form-control" id="adjustmentQuantity" required>
                            <small class="text-muted">Use positive numbers to add, negative to subtract</small>
                        </div>
                        <div class="mb-3">
                            <label for="adjustmentReason" class="form-label">Reason *</label>
                            <select class="form-select" id="adjustmentReason" required>
                                <option value="">Select Reason</option>
                                <option value="gain">Found/Gained Stock (Increase)</option>
                                <option value="damage">Damage/Loss (Decrease)</option>
                                <option value="theft">Theft (Decrease)</option>
                                <option value="expiry">Expiry (Decrease)</option>
                                <option value="correction">Count Correction</option>
                                <option value="opening_stock">Opening Stock Entry</option>
                            </select>
                            <small class="text-muted">Select reason for adjustment. Use positive quantity for increase,
                                negative for decrease.</small>
                        </div>
                        <div class="mb-3">
                            <label for="adjustmentNotes" class="form-label">Notes</label>
                            <textarea class="form-control" id="adjustmentNotes" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveAdjustment()">Save Adjustment</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Product View Modal -->
    <div class="modal fade" id="viewProductModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-eye me-2"></i>Product Details
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="bi bi-info-circle me-2"></i>Basic Information</h6>
                                </div>
                                <div class="card-body">
                                    <table class="table table-borderless">
                                        <tr>
                                            <td class="fw-bold">Name:</td>
                                            <td id="viewProductName">-</td>
                                        </tr>
                                        <tr>
                                            <td class="fw-bold">SKU:</td>
                                            <td id="viewProductSku">-</td>
                                        </tr>
                                        <tr>
                                            <td class="fw-bold">Category:</td>
                                            <td id="viewProductCategory">-</td>
                                        </tr>
                                        <tr>
                                            <td class="fw-bold">Product Type:</td>
                                            <td id="viewProductType">-</td>
                                        </tr>
                                        <tr>
                                            <td class="fw-bold">Brand:</td>
                                            <td id="viewProductBrand">-</td>
                                        </tr>
                                        <tr>
                                            <td class="fw-bold">Model:</td>
                                            <td id="viewProductModel">-</td>
                                        </tr>
                                        <tr>
                                            <td class="fw-bold">Barcode:</td>
                                            <td id="viewProductBarcode">-</td>
                                        </tr>
                                        <tr>
                                            <td class="fw-bold">Accounting Code:</td>
                                            <td id="viewProductAccountingCode">-</td>
                                        </tr>
                                        <tr>
                                            <td class="fw-bold">Accounting Category:</td>
                                            <td id="viewProductAccountingCategory">-</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="bi bi-currency-dollar me-2"></i>Pricing & Inventory</h6>
                                </div>
                                <div class="card-body">
                                    <table class="table table-borderless">
                                        <tr>
                                            <td class="fw-bold">Cost Price:</td>
                                            <td id="viewProductCostPrice">-</td>
                                        </tr>
                                        <tr>
                                            <td class="fw-bold">Selling Price:</td>
                                            <td id="viewProductSellingPrice">-</td>
                                        </tr>
                                        <tr>
                                            <td class="fw-bold">Current Quantity:</td>
                                            <td id="viewProductQuantity">-</td>
                                        </tr>
                                        <tr>
                                            <td class="fw-bold">Unit of Measure:</td>
                                            <td id="viewProductUnitOfMeasure">-</td>
                                        </tr>
                                        <tr>
                                            <td class="fw-bold">Minimum Stock:</td>
                                            <td id="viewProductMinStock">-</td>
                                        </tr>
                                        <tr>
                                            <td class="fw-bold">Reorder Point:</td>
                                            <td id="viewProductReorderPoint">-</td>
                                        </tr>
                                        <tr>
                                            <td class="fw-bold">Total Value:</td>
                                            <td id="viewProductTotalValue">-</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="bi bi-gear me-2"></i>Properties</h6>
                                </div>
                                <div class="card-body">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="viewProductSerialized"
                                            disabled>
                                        <label class="form-check-label" for="viewProductSerialized">
                                            Serialized Product
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="viewProductPerishable"
                                            disabled>
                                        <label class="form-check-label" for="viewProductPerishable">
                                            Perishable Product
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="viewProductActive" disabled>
                                        <label class="form-check-label" for="viewProductActive">
                                            Active Product
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="bi bi-rulers me-2"></i>Physical Properties</h6>
                                </div>
                                <div class="card-body">
                                    <table class="table table-borderless">
                                        <tr>
                                            <td class="fw-bold">Weight:</td>
                                            <td id="viewProductWeight">-</td>
                                        </tr>
                                        <tr>
                                            <td class="fw-bold">Dimensions:</td>
                                            <td id="viewProductDimensions">-</td>
                                        </tr>
                                        <tr>
                                            <td class="fw-bold">Expiry Date:</td>
                                            <td id="viewProductExpiryDate">-</td>
                                        </tr>
                                        <tr>
                                            <td class="fw-bold">Batch Number:</td>
                                            <td id="viewProductBatchNumber">-</td>
                                        </tr>
                                        <tr>
                                            <td class="fw-bold">Warranty (Months):</td>
                                            <td id="viewProductWarrantyMonths">-</td>
                                        </tr>
                                        <tr>
                                            <td class="fw-bold">Warranty (Years):</td>
                                            <td id="viewProductWarrantyYears">-</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="bi bi-file-text me-2"></i>Description & Notes</h6>
                                </div>
                                <div class="card-body">
                                    <p id="viewProductDescription" class="text-muted">No description available</p>
                                    <hr>
                                    <h6>Notes:</h6>
                                    <p id="viewProductNotes" class="text-muted">No notes available</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="editProductFromView()">
                        <i class="bi bi-pencil me-2"></i>Edit Product
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Product Modal -->
    <div class="modal fade" id="editProductModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-pencil me-2"></i>Edit Product
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editProductForm">
                        <input type="hidden" id="editProductId">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editProductName" class="form-label">Product Name *</label>
                                    <input type="text" class="form-control" id="editProductName" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editProductSku" class="form-label">SKU *</label>
                                    <input type="text" class="form-control" id="editProductSku" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editProductCategory" class="form-label">Category</label>
                                    <select class="form-select" id="editProductCategory"
                                        onchange="toggleEditSellingPriceRequirement()">
                                        <option value="">Select Category</option>
                                        <option value="raw_material">Raw Materials</option>
                                        <option value="component">Components & Spares</option>
                                        <option value="manufactured">Manufactured Goods</option>
                                        <option value="service">Service</option>
                                        <option value="digital">Digital</option>
                                        <option value="Electronics">Electronics</option>
                                        <option value="Clothing">Clothing</option>
                                        <option value="Food">Food</option>
                                        <option value="Beverages">Beverages</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editProductType" class="form-label">Product Type</label>
                                    <select class="form-select" id="editProductType"
                                        onchange="toggleEditAccountingFields()">
                                        <option value="inventory_item">Inventory Item</option>
                                        <option value="service">Service</option>
                                        <option value="assembly">Assembly</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <!-- Accounting Code Section (for inventory items) -->
                        <div id="editAccountingCodeSection" class="row" style="display: block;">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="editAccountingCodeType" class="form-label">Account Type *</label>
                                    <select class="form-select" id="editAccountingCodeType"
                                        onchange="updateEditAccountingCategories()" required>
                                        <option value="">Select Account Type</option>
                                        <option value="Asset" selected>Asset</option>
                                    </select>
                                    <small class="text-muted">For inventory items, Asset type is recommended</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="editAccountingCodeCategory" class="form-label">Account Category
                                        *</label>
                                    <select class="form-select" id="editAccountingCodeCategory"
                                        onchange="updateEditAccountingCodes()" required>
                                        <option value="">Select Category</option>
                                        <option value="Inventory" selected>Inventory</option>
                                        <option value="Current Asset">Current Asset</option>
                                        <option value="Fixed Asset">Fixed Asset</option>
                                    </select>
                                    <small class="text-muted">Categories appropriate for inventory tracking</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="editAccountingCode" class="form-label">Specific Account Code *</label>
                                    <select class="form-select" id="editAccountingCode" required>
                                        <option value="">Select Account Code</option>
                                    </select>
                                    <small class="text-muted">Choose the specific inventory account</small>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editCostPrice" class="form-label">Cost Price *</label>
                                    <input type="number" class="form-control" id="editCostPrice" step="0.01" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editSellingPrice" class="form-label">Selling Price <span
                                            id="editSellingPriceRequired">*</span></label>
                                    <input type="number" class="form-control" id="editSellingPrice" step="0.01">
                                    <small class="text-muted" id="editSellingPriceHint" style="display: none;">Optional
                                        for raw materials and components</small>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editQuantity" class="form-label">Quantity</label>
                                    <input type="number" class="form-control" id="editQuantity" readonly>
                                    <small class="text-muted">Use inventory adjustments to change quantity</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editUnitOfMeasure" class="form-label">Unit of Measure *</label>
                                    <div class="input-group">
                                        <select class="form-select" id="editUnitOfMeasure" required>
                                            <option value="">Select Unit</option>
                                        </select>
                                        <button class="btn btn-outline-secondary" type="button" id="editUomInfoBtn"
                                            title="Show base and conversion">UOM</button>
                                    </div>
                                    <small id="editUomHint" class="text-muted d-block mt-1"></small>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editBrand" class="form-label">Brand</label>
                                    <input type="text" class="form-control" id="editBrand">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editModel" class="form-label">Model</label>
                                    <input type="text" class="form-control" id="editModel">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editBarcode" class="form-label">Barcode</label>
                                    <input type="text" class="form-control" id="editBarcode">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editReorderLevel" class="form-label">Reorder Level</label>
                                    <input type="number" class="form-control" id="editReorderLevel">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editWeight" class="form-label">Weight</label>
                                    <input type="number" class="form-control" id="editWeight" step="0.01">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editDimensions" class="form-label">Dimensions</label>
                                    <input type="text" class="form-control" id="editDimensions" placeholder="L x W x H">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="editProductDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="editProductDescription" rows="3"></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="editIsSerialized">
                                    <label class="form-check-label" for="editIsSerialized">
                                        Serialized Product
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="editIsPerishable">
                                    <label class="form-check-label" for="editIsPerishable">
                                        Perishable Product
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="editIsTaxable">
                                    <label class="form-check-label" for="editIsTaxable">
                                        Taxable Product
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="editIsActive">
                                    <label class="form-check-label" for="editIsActive">
                                        Active Product
                                    </label>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveProductEdit()">
                        <i class="bi bi-check-lg me-2"></i>Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Product Dimensional Report Modal -->
    <div class="modal fade" id="productDimensionalReportModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Product Dimensional Reports</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="productReportType" class="form-label">Report Type</label>
                            <select class="form-select" id="productReportType">
                                <option value="cost_center">Products by Cost Center</option>
                                <option value="project">Products by Project</option>
                                <option value="combination">Products by Cost Center & Project</option>
                                <option value="value_analysis">Inventory Value by Dimensions</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="productReportCategory" class="form-label">Category Filter</label>
                            <select class="form-select" id="productReportCategory">
                                <option value="">All Categories</option>
                                <option value="Electronics">Electronics</option>
                                <option value="Clothing">Clothing</option>
                                <option value="Food">Food</option>
                                <option value="Beverages">Beverages</option>
                                <option value="raw_material">Raw Materials</option>
                                <option value="component">Components & Spares</option>
                                <option value="manufactured">Manufactured Goods</option>
                                <option value="service">Service</option>
                            </select>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="d-grid">
                                <button class="btn btn-primary" onclick="generateProductDimensionalReport()">
                                    <i class="bi bi-graph-up me-2"></i>Generate Report
                                </button>
                            </div>
                        </div>
                    </div>

                    <div id="productReportResults" class="mt-4">
                        <!-- Report results will be displayed here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-success" onclick="exportProductDimensionalReport()"
                        id="exportProductReportBtn" style="display: none;">
                        <i class="bi bi-file-earmark-text me-2"></i>Export Report
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>


    <script src="js/ui-guard.js"></script>
    <!-- Currency Utils -->
    <script src="js/currency-utils.js"></script>

    <script>
        // Global variables for currency and settings
        let currentCurrency = 'BWP';
        let currencySymbol = 'P';
        let currencyCode = 'BWP';

        // Load settings and currency
        async function loadSettings() {
            try {
                const response = await fetch('/api/v1/settings/currency');
                if (response.ok) {
                    const settings = await response.json();
                    // Handle different response structures
                    if (settings.data) {
                        // If response has a data property
                        currentCurrency = settings.data.currency || 'BWP';
                        currencySymbol = settings.data.currency_symbol || 'P';
                        currencyCode = settings.data.currency || 'BWP';
                    } else if (settings.currency) {
                        // If response has direct currency properties
                        currentCurrency = settings.currency || 'BWP';
                        currencySymbol = settings.currency_symbol || 'P';
                        currencyCode = settings.currency || 'BWP';
                    } else {
                        // Fallback to Botswana Pula
                        currentCurrency = 'BWP';
                        currencySymbol = 'P';
                        currencyCode = 'BWP';
                    }
                    console.log('Currency settings loaded:', { currentCurrency, currencySymbol, currencyCode });
                } else {
                    console.warn('Failed to load currency settings, using defaults');
                    // Use Botswana Pula as default
                    currentCurrency = 'BWP';
                    currencySymbol = 'P';
                    currencyCode = 'BWP';
                }
            } catch (error) {
                console.error('Error loading settings:', error);
                // Use Botswana Pula as fallback
                currentCurrency = 'BWP';
                currencySymbol = 'P';
                currencyCode = 'BWP';
            }
        }

        // Global variables
        let products = [];
        let loading = false;
        let currentProductId = null;

        // API endpoints
        const API_BASE = '/api/v1';
        const INVENTORY_ENDPOINT = `${API_BASE}/inventory`;
        const PRODUCTS_ENDPOINT = `${INVENTORY_ENDPOINT}/products`;
        const PRODUCT_TEMPLATE_ENDPOINT = `${INVENTORY_ENDPOINT}/products/template`;
        const BRANCHES_ENDPOINT = `${API_BASE}/branches/public`;
        const ALLOCATIONS_ENDPOINT = `${API_BASE}/inventory-allocation/allocations`;

        // Dimensional data storage
        let dimensionalData = {
            costCenters: [],
            projects: [],
            allDimensions: [] // Store all dimensions
        };

        // Load dimensional data from API
        async function loadDimensionalData() {
            try {
                const dimensionsResponse = await fetch('/api/v1/accounting/dimensions');
                if (!dimensionsResponse.ok) {
                    console.warn('Failed to load dimensions');
                    return;
                }
                const dimensions = await dimensionsResponse.json();

                // Store all dimensions
                dimensionalData.allDimensions = dimensions;

                // Find dimensions by type or code (case-insensitive, flexible)
                // Priority: 1) organizational/department types, 2) code contains 'dept', 3) first dimension
                const costCenterDimension = dimensions.find(d =>
                    d.is_active && (
                        d.dimension_type === 'organizational' ||
                        d.code.toUpperCase().includes('DEPT') ||
                        d.code.toUpperCase().includes('COST') ||
                        d.code.toUpperCase() === 'CC'
                    )
                ) || dimensions.find(d => d.is_active); // Fallback to first active dimension

                // Priority: 1) project type, 2) code contains 'proj', 3) second dimension
                const projectDimension = dimensions.find(d =>
                    d.is_active && (
                        d.dimension_type === 'project' ||
                        d.code.toUpperCase().includes('PROJ') ||
                        d.code.toUpperCase().includes('PROJECT')
                    )
                ) || dimensions.filter(d => d.is_active && d.id !== costCenterDimension?.id)[0]; // Different from cost center

                // Load values for cost center dimension
                if (costCenterDimension) {
                    console.log(`Loading cost center dimension: ${costCenterDimension.code} - ${costCenterDimension.name}`);
                    const costCentersResponse = await fetch(`/api/v1/accounting/dimensions/${costCenterDimension.id}/values`);
                    if (costCentersResponse.ok) {
                        dimensionalData.costCenters = await costCentersResponse.json();
                        dimensionalData.costCenterDimension = costCenterDimension;
                    }
                }

                // Load values for project dimension
                if (projectDimension) {
                    console.log(`Loading project dimension: ${projectDimension.code} - ${projectDimension.name}`);
                    const projectsResponse = await fetch(`/api/v1/accounting/dimensions/${projectDimension.id}/values`);
                    if (projectsResponse.ok) {
                        dimensionalData.projects = await projectsResponse.json();
                        dimensionalData.projectDimension = projectDimension;
                    }
                }

                // Populate dimensional options in dropdowns
                populateDimensionalOptions();

            } catch (error) {
                console.error('Error loading dimensional data:', error);
            }
        }

        // Populate dimensional dropdowns
        function populateDimensionalOptions() {
            // Update labels with actual dimension names
            const costCenterLabel = document.querySelector('label[for="productCostCenter"]');
            if (costCenterLabel && dimensionalData.costCenterDimension) {
                costCenterLabel.innerHTML = `${dimensionalData.costCenterDimension.name}`;
            }

            const projectLabel = document.querySelector('label[for="productProject"]');
            if (projectLabel && dimensionalData.projectDimension) {
                projectLabel.innerHTML = `${dimensionalData.projectDimension.name}`;
            }

            // Populate Cost Centers in Product Form
            const productCostCenterSelect = document.getElementById('productCostCenter');
            if (productCostCenterSelect) {
                const placeholder = dimensionalData.costCenterDimension
                    ? `Select ${dimensionalData.costCenterDimension.name}`
                    : 'Select Cost Center';
                productCostCenterSelect.innerHTML = `<option value="">${placeholder}</option>`;
                dimensionalData.costCenters.forEach(center => {
                    if (center.is_active) {
                        const option = document.createElement('option');
                        option.value = center.id;
                        option.textContent = `${center.code} - ${center.name}`;
                        productCostCenterSelect.appendChild(option);
                    }
                });
            }

            // Populate Projects in Product Form
            const productProjectSelect = document.getElementById('productProject');
            if (productProjectSelect) {
                const placeholder = dimensionalData.projectDimension
                    ? `Select ${dimensionalData.projectDimension.name}`
                    : 'Select Project';
                productProjectSelect.innerHTML = `<option value="">${placeholder}</option>`;
                dimensionalData.projects.forEach(project => {
                    if (project.is_active) {
                        const option = document.createElement('option');
                        option.value = project.id;
                        option.textContent = `${project.code} - ${project.name}`;
                        productProjectSelect.appendChild(option);
                    }
                });
            }

            // Populate Cost Centers in Filter
            const costCenterFilter = document.getElementById('costCenterFilter');
            if (costCenterFilter) {
                const filterLabel = dimensionalData.costCenterDimension
                    ? `All ${dimensionalData.costCenterDimension.name}s`
                    : 'All Cost Centers';
                costCenterFilter.innerHTML = `<option value="">${filterLabel}</option>`;
                dimensionalData.costCenters.forEach(center => {
                    if (center.is_active) {
                        const option = document.createElement('option');
                        option.value = center.id;
                        option.textContent = `${center.code} - ${center.name}`;
                        costCenterFilter.appendChild(option);
                    }
                });
            }

            // Populate Projects in Filter
            const projectFilter = document.getElementById('projectFilter');
            if (projectFilter) {
                const projectFilterLabel = dimensionalData.projectDimension
                    ? `All ${dimensionalData.projectDimension.name}s`
                    : 'All Projects';
                projectFilter.innerHTML = `<option value="">${projectFilterLabel}</option>`;
                dimensionalData.projects.forEach(project => {
                    if (project.is_active) {
                        const option = document.createElement('option');
                        option.value = project.id;
                        option.textContent = `${project.code} - ${project.name}`;
                        projectFilter.appendChild(option);
                    }
                });
            }
        }

        // Helper function to get dimensional display value
        function getDimensionalDisplayValue(dimensionalValue) {
            if (!dimensionalValue) return '<span class="text-muted">-</span>';

            // If it's just an ID, try to find the name from cached data
            if (typeof dimensionalValue === 'string') {
                if (dimensionalData) {
                    // Check cost centers
                    const costCenter = dimensionalData.costCenters?.find(cc => cc.id === dimensionalValue);
                    if (costCenter) {
                        return `<span class="badge bg-primary">${costCenter.code}</span>`;
                    }

                    // Check projects
                    const project = dimensionalData.projects?.find(p => p.id === dimensionalValue);
                    if (project) {
                        return `<span class="badge bg-success">${project.code}</span>`;
                    }
                }
                // Fallback to truncated ID
                return `<span class="text-muted small">${dimensionalValue.substring(0, 8)}...</span>`;
            }

            // If it's an object with code/name
            if (dimensionalValue.code) {
                return `<span class="badge bg-secondary">${dimensionalValue.code}</span>`;
            }

            return '<span class="text-muted">-</span>';
        }

        // Load branches for filtering
        async function loadBranches() {
            try {
                const response = await fetch(BRANCHES_ENDPOINT, { headers: (window.auth ? auth.authHeader() : {}) });
                if (response.ok) {
                    const branches = await response.json();
                    const branchFilter = document.getElementById('branchFilter');
                    if (branchFilter) {
                        branchFilter.innerHTML = '<option value="">All Branches</option>';
                        branches.forEach(branch => {
                            if (branch.active) {
                                const label = branch.code ? `${branch.name} (${branch.code})` : branch.name;
                                branchFilter.innerHTML += `<option value="${branch.id}">${label}</option>`;
                            }
                        });
                    }
                } else {
                    console.warn('Failed to load branches, status:', response.status);
                }
            } catch (error) {
                console.error('Error loading branches:', error);
            }
        }

        // Cache of branch allocations by product for current selection
        let branchAllocationsByProduct = {};
        let _branchAllocRows = [];

        async function loadBranchAllocationsForSelectedBranch() {
            const branchId = document.getElementById('branchFilter')?.value;
            branchAllocationsByProduct = {};
            _branchAllocRows = [];
            if (!branchId) return [];
            try {
                const url = `${ALLOCATIONS_ENDPOINT}?branch_id=${encodeURIComponent(branchId)}`;
                const resp = await fetch(url, { headers: (window.auth ? auth.authHeader() : {}) });
                if (!resp.ok) return [];
                const rows = await resp.json();
                _branchAllocRows = Array.isArray(rows) ? rows : [];
                // Build a map product_id -> totals from received allocations
                _branchAllocRows.forEach(a => {
                    const pid = a.product_id;
                    if (!pid) return;
                    const qty = parseInt(a.available_quantity || 0, 10);
                    const rec = parseInt(a.received_quantity || 0, 10) || 0;
                    const alloc = parseInt(a.allocated_quantity || 0, 10) || 0;
                    if (!branchAllocationsByProduct[pid]) {
                        branchAllocationsByProduct[pid] = { available: 0, received: 0, allocated: 0 };
                    }
                    branchAllocationsByProduct[pid].available += qty;
                    branchAllocationsByProduct[pid].received += rec;
                    branchAllocationsByProduct[pid].allocated += alloc;
                });
                return _branchAllocRows;
            } catch (e) {
                console.warn('Failed to load branch allocations', e);
                return [];
            }
        }

        function getViewModeIsBranch() {
            const sw = document.getElementById('viewModeSwitch');
            return !!(sw && sw.checked);
        }

        function setBranchUIVisibility() {
            const isBranch = getViewModeIsBranch();
            const branchSelect = document.getElementById('branchFilter');
            const panel = document.getElementById('branchAllocPanel');
            const label = document.getElementById('viewModeLabel');
            if (label) label.textContent = isBranch ? 'Branch' : 'HQ';
            if (branchSelect) branchSelect.disabled = !isBranch;
            // show panel only when in branch mode and a branch is selected
            const hasBranch = !!branchSelect?.value;
            if (panel) panel.style.display = (isBranch && hasBranch) ? 'block' : 'none';
        }

        function renderBranchAllocPanelRows(rows) {
            const body = document.getElementById('branchAllocPanelBody');
            if (!body) return;
            body.innerHTML = '';
            const data = Array.isArray(rows) ? rows : _branchAllocRows;
            if (!data || data.length === 0) {
                body.innerHTML = '<tr><td colspan="7" class="text-muted">No allocations for this branch.</td></tr>';
                return;
            }
            const prodNameById = new Map(products.map(p => [p.id, p.name]));
            data.slice(0, 200).forEach(a => {
                const tr = document.createElement('tr');
                const ref = a.reference || a.allocation_reference || a.request_reference || a.id || '-';
                const name = prodNameById.get(a.product_id) || a.product_name || a.sku || a.product_id || '-';
                const alloc = Number(a.allocated_quantity || 0);
                const rec = Number(a.received_quantity || 0);
                const avail = Number(a.available_quantity || (alloc - rec) || 0);
                const status = a.status || a.state || '-';
                const tracking = a.tracking_code || a.tracking_number || a.shipment_reference || '-';
                tr.innerHTML = `
                    <td>${ref}</td>
                    <td>${name}</td>
                    <td class="text-end">${alloc.toLocaleString()}</td>
                    <td class="text-end">${rec.toLocaleString()}</td>
                    <td class="text-end">${avail.toLocaleString()}</td>
                    <td>${status}</td>
                    <td>${tracking}</td>
                `;
                body.appendChild(tr);
            });
        }

        async function refreshBranchAllocPanel() {
            if (!getViewModeIsBranch()) { return; }
            const branchId = document.getElementById('branchFilter')?.value;
            if (!branchId) { renderBranchAllocPanelRows([]); return; }
            const rows = await loadBranchAllocationsForSelectedBranch();
            renderBranchAllocPanelRows(rows);
        }

        async function loadProducts() {
            try {
                console.log('Fetching products from database...');
                loading = true;
                showLoadingState();

                const response = await fetch(PRODUCTS_ENDPOINT);
                console.log('Response status:', response.status);

                if (!response.ok) {
                    let errorMessage = `HTTP error! status: ${response.status}`;
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.detail || errorMessage;
                    } catch (parseError) {
                        // If response is not JSON (e.g., HTML error page), get text content
                        const errorText = await response.text();
                        console.error('Server returned non-JSON error:', errorText);
                        errorMessage = `Server error (${response.status}): ${response.statusText}`;
                    }
                    throw new Error(errorMessage);
                }

                const data = await response.json();
                console.log('Products data received:', data);
                console.log('Number of products:', data.length);
                products = data;

                console.log('Rendering products...');
                renderProducts();
                console.log('Updating statistics...');
                updateStatistics();

                if (window.modernUI) {
                    window.modernUI.showNotification('Products loaded successfully', 'success');
                }
            } catch (error) {
                console.error('Error fetching products:', error);
                if (window.modernUI) {
                    window.modernUI.showNotification('Failed to load products', 'error');
                }
            } finally {
                loading = false;
                hideLoadingState();
            }
        }

        async function downloadBlankProductTemplate() {
            try {
                const response = await fetch(PRODUCT_TEMPLATE_ENDPOINT, {
                    headers: (window.auth ? auth.authHeader() : {})
                });

                if (!response.ok) {
                    throw new Error(`Failed to download template (status ${response.status})`);
                }

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `product_import_template.xlsx`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);

                if (window.modernUI) {
                    window.modernUI.showNotification('Blank import template downloaded.', 'success');
                }
            } catch (error) {
                console.error('Template download failed:', error);
                if (window.modernUI) {
                    window.modernUI.showNotification(`Failed to download template: ${error.message}`, 'error');
                } else {
                    alert(`Failed to download template: ${error.message}`);
                }
            }
        }

        function triggerProductImport() {
            const fileInput = document.getElementById('productImportInput');
            if (fileInput) {
                fileInput.click();
            }
        }

        function handleProductImport(event) {
            const file = event.target?.files?.[0];
            if (!file) {
                return;
            }

            if (window.modernUI) {
                window.modernUI.showNotification('Import processing is not available yet. Template captured for future upload.', 'info');
            } else {
                alert('Import processing is not available yet.');
            }

            event.target.value = '';
        }

        // Show loading state
        function showLoadingState() {
            const tbody = document.getElementById('productsBody');
            if (tbody) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="11" class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Loading products...</p>
                        </td>
                    </tr>
                `;
            }
        }

        // Hide loading state
        function hideLoadingState() {
            // Loading state will be replaced by render functions
        }

        // Update statistics
        function updateStatistics() {
            const totalProducts = products.length;
            const totalValue = products.reduce((sum, p) => sum + (parseFloat(p.quantity) * parseFloat(p.cost_price)), 0);
            const lowStockCount = products.filter(p => p.quantity <= (p.reorder_point || 5)).length;
            const outOfStockCount = products.filter(p => p.quantity === 0).length;

            // Update statistics cards if they exist
            const totalProductsEl = document.getElementById('totalProducts');
            const totalValueEl = document.getElementById('totalValue');
            const lowStockEl = document.getElementById('lowStockCount');
            const outOfStockEl = document.getElementById('outOfStockCount');

            if (totalProductsEl) totalProductsEl.textContent = totalProducts;
            if (totalValueEl) totalValueEl.textContent = formatCurrency(totalValue);
            if (lowStockEl) lowStockEl.textContent = lowStockCount;
            if (outOfStockEl) outOfStockEl.textContent = outOfStockCount;
        }

        // Render products
        async function renderProducts() {
            const tbody = document.getElementById('productsBody');
            if (!tbody) return;

            tbody.innerHTML = '';

            // Respect explicit view mode for branch context
            const selectedBranch = getViewModeIsBranch() ? (document.getElementById('branchFilter')?.value || '') : '';
            if (selectedBranch) {
                await loadBranchAllocationsForSelectedBranch();
            }
            setBranchUIVisibility();

            if (products.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="14" class="text-center">
                            <i class="bi bi-box fs-1 text-muted"></i>
                            <h5 class="mt-3">No products found</h5>
                            <p class="text-muted">No products match your current filters.</p>
                            <button class="btn btn-primary" onclick="clearFilters()">
                                <i class="bi bi-arrow-clockwise"></i> Clear Filters
                            </button>
                        </td>
                    </tr>
                `;
                return;
            }

            products.forEach(product => {
                const row = document.createElement('tr');

                // Determine status based on quantity
                let status = 'in-stock';
                if (product.quantity === 0) {
                    status = 'out-of-stock';
                } else if (product.quantity <= (product.reorder_point || 5)) {
                    status = 'low-stock';
                }

                // Add status-based classes
                if (status === 'out-of-stock') {
                    row.className = 'out-of-stock';
                } else if (status === 'low-stock') {
                    row.className = 'low-stock';
                } else if (product.is_serialized) {
                    row.className = 'serialized-product';
                } else if (product.is_perishable) {
                    row.className = 'perishable-product';
                }

                const statusBadge = getStatusBadge(status);
                const serializedIcon = product.is_serialized ? '<i class="bi bi-upc-scan text-info ms-1" title="Serialized"></i>' : '';
                const perishableIcon = product.is_perishable ? '<i class="bi bi-clock text-warning ms-1" title="Perishable"></i>' : '';
                // If viewing a branch, show branch available quantity; otherwise show global
                const branchView = !!selectedBranch;
                const branchEntry = branchAllocationsByProduct[product.id];
                const qtyToShow = branchView ? (branchEntry?.available || 0) : (product.quantity || 0);
                const totalValue = parseFloat(qtyToShow) * parseFloat(product.cost_price);

                // Tax status
                const isTaxable = product.is_taxable !== false; // Default to true if not specified
                const taxStatusBadge = isTaxable ?
                    '<span class="badge bg-warning text-dark">Taxable</span>' :
                    '<span class="badge bg-success">Non-Taxable</span>';

                row.innerHTML = `
                    <td>
                        ${product.image_url ?
                        `<img src="${product.image_url}" alt="${product.name}" class="product-image-thumbnail" onclick="viewProductImage('${product.image_url}', '${product.name}')" title="Click to view full image">` :
                        `<div class="text-muted text-center"><i class="bi bi-image fs-4"></i><br><small>No Image</small></div>`
                    }
                    </td>
                    <td>
                        ${product.sku || 'N/A'}
                        ${serializedIcon}
                        ${perishableIcon}
                    </td>
                    <td>${product.name}</td>
                    <td>${product.category || 'Uncategorized'}</td>
                    <td>${getUnitOfMeasureName(product.unit_of_measure_id) || 'N/A'}</td>
                    <td>
                        <span class="fw-bold">${qtyToShow}</span>
                        ${qtyToShow <= (product.reorder_point || 5) ? '<i class="bi bi-exclamation-triangle text-warning ms-1" title="Low Stock"></i>' : ''}
                        ${branchView ? '<span class="badge bg-secondary ms-2" title="Branch available">Branch</span>' : ''}
                    </td>
                    <td>${getDimensionalDisplayValue(product.cost_center)}</td>
                    <td>${getDimensionalDisplayValue(product.project)}</td>
                    <td class="text-end">${formatCurrency(product.cost_price)}</td>
                    <td class="text-end">${formatCurrency(product.selling_price)}</td>
                    <td class="text-end">${formatCurrency(totalValue)}</td>
                    <td>${taxStatusBadge}</td>
                    <td>${statusBadge}</td>
                    <td class="text-end">
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" onclick="viewProduct('${product.id}')" title="View">
                                <i class="bi bi-eye"></i>
                            </button>
                            <button class="btn btn-outline-secondary" onclick="editProduct('${product.id}')" title="Edit">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-outline-success" onclick="adjustInventory('${product.id}')" title="Adjust">
                                <i class="bi bi-arrow-repeat"></i>
                            </button>
                            <button class="btn btn-outline-danger" onclick="deleteProduct('${product.id}', '${product.name}')" title="Delete">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
            // Also refresh the branch panel if in branch mode
            if (getViewModeIsBranch() && selectedBranch) {
                renderBranchAllocPanelRows(_branchAllocRows);
            }
        }

        function getStatusBadge(status) {
            switch (status) {
                case 'in-stock':
                    return '<span class="badge bg-success">In Stock</span>';
                case 'low-stock':
                    return '<span class="badge bg-warning">Low Stock</span>';
                case 'out-of-stock':
                    return '<span class="badge bg-danger">Out of Stock</span>';
                default:
                    return '<span class="badge bg-secondary">Unknown</span>';
            }
        }

        // Format currency amount
        function formatCurrency(amount) {
            return `${currencySymbol}${parseFloat(amount).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        }

        // Toggle accounting fields visibility based on product type
        function toggleAccountingFields() {
            const productType = document.getElementById('productType').value;
            const accountingSection = document.getElementById('accountingCodeSection');
            const accountingType = document.getElementById('accountingCodeType');
            const accountingCategory = document.getElementById('accountingCodeCategory');
            const accountingCode = document.getElementById('accountingCode');

            console.log('toggleAccountingFields called - productType:', productType);
            console.log('accountingSection element:', accountingSection);

            if (productType === 'inventory_item') {
                if (accountingSection) {
                    accountingSection.style.display = 'block';
                    console.log('Set accounting section to visible');
                }
                if (accountingType) {
                    accountingType.required = true;
                    accountingType.value = 'Asset';
                }
                if (accountingCategory) {
                    accountingCategory.required = true;
                }
                if (accountingCode) {
                    accountingCode.required = true;
                }
                updateAccountingCategories();
            } else {
                if (accountingSection) {
                    accountingSection.style.display = 'none';
                    console.log('Set accounting section to hidden');
                }
                if (accountingType) accountingType.required = false;
                if (accountingCategory) accountingCategory.required = false;
                if (accountingCode) accountingCode.required = false;
            }
        }        // Update accounting categories based on selected type
        function updateAccountingCategories() {
            const accountingType = document.getElementById('accountingCodeType').value;
            const categorySelect = document.getElementById('accountingCodeCategory');

            // Clear existing options
            categorySelect.innerHTML = '<option value="">Select Category</option>';

            // Define inventory-appropriate categories for Asset type
            const inventoryCategories = {
                'Asset': [
                    { value: 'Inventory', label: 'Inventory', selected: true },
                    { value: 'Current Asset', label: 'Current Asset' },
                    { value: 'Fixed Asset', label: 'Fixed Asset' },
                    { value: 'Prepaid Assets', label: 'Prepaid Assets' },
                    { value: 'Trade Receivables', label: 'Trade Receivables' }
                ]
            };

            if (accountingType && inventoryCategories[accountingType]) {
                inventoryCategories[accountingType].forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.value;
                    option.textContent = category.label;
                    if (category.selected) {
                        option.selected = true;
                    }
                    categorySelect.appendChild(option);
                });

                // Auto-load accounting codes for inventory
                if (accountingType === 'Asset') {
                    updateAccountingCodes();
                }
            }
        }

        // Toggle selling price requirement based on product category
        function toggleSellingPriceRequirement() {
            const category = document.getElementById('productCategory').value;
            const sellingPriceInput = document.getElementById('sellingPrice');
            const sellingPriceRequired = document.getElementById('sellingPriceRequired');
            const sellingPriceHint = document.getElementById('sellingPriceHint');

            // Raw materials and components don't require selling price
            const optionalCategories = ['raw_material', 'component'];
            const isOptional = optionalCategories.includes(category);

            if (sellingPriceInput) {
                if (isOptional) {
                    sellingPriceInput.removeAttribute('required');
                    if (sellingPriceRequired) sellingPriceRequired.style.display = 'none';
                    if (sellingPriceHint) sellingPriceHint.style.display = 'block';
                } else {
                    sellingPriceInput.setAttribute('required', 'required');
                    if (sellingPriceRequired) sellingPriceRequired.style.display = 'inline';
                    if (sellingPriceHint) sellingPriceHint.style.display = 'none';
                }
            }
        }

        // Toggle selling price requirement for edit form
        function toggleEditSellingPriceRequirement() {
            const category = document.getElementById('editProductCategory').value;
            const sellingPriceInput = document.getElementById('editSellingPrice');
            const sellingPriceRequired = document.getElementById('editSellingPriceRequired');
            const sellingPriceHint = document.getElementById('editSellingPriceHint');

            // Raw materials and components don't require selling price
            const optionalCategories = ['raw_material', 'component'];
            const isOptional = optionalCategories.includes(category);

            if (sellingPriceInput) {
                if (isOptional) {
                    sellingPriceInput.removeAttribute('required');
                    if (sellingPriceRequired) sellingPriceRequired.style.display = 'none';
                    if (sellingPriceHint) sellingPriceHint.style.display = 'block';
                } else {
                    sellingPriceInput.setAttribute('required', 'required');
                    if (sellingPriceRequired) sellingPriceRequired.style.display = 'inline';
                    if (sellingPriceHint) sellingPriceHint.style.display = 'none';
                }
            }
        }

        // Cached accounting codes
        window._allAccountingCodes = null;

        async function loadAllAccountingCodes(force = false) {
            if (window._allAccountingCodes && !force) return window._allAccountingCodes;
            try {
                const resp = await fetch('/api/v1/accounting-codes');
                if (!resp.ok) {
                    console.error('Failed to fetch accounting codes endpoint', resp.status);
                    return [];
                }
                const data = await resp.json();
                // Handle possible unified response in the future
                const list = Array.isArray(data) ? data : (data.data || []);
                window._allAccountingCodes = list;
                console.log('Accounting codes cached:', list.length);
                return list;
            } catch (e) {
                console.error('Error fetching accounting codes:', e);
                return [];
            }
        }

        function filterAccountingCodes(rawCodes, { type, category }) {
            if (!rawCodes) return [];
            // Primary filter: exact account_type match & non-parent
            let filtered = rawCodes.filter(c => c.account_type === type && !c.is_parent);
            if (category) {
                let exact = filtered.filter(c => (c.category || '').toLowerCase() === category.toLowerCase());
                if (exact.length) return exact;
                // Fallback heuristics for "Inventory" style selection
                if (category.toLowerCase() === 'inventory') {
                    const invHeuristic = filtered.filter(c =>
                        /inv/i.test(c.name) || /stock/i.test(c.name) || /invent/i.test(c.code || '')
                    );
                    if (invHeuristic.length) return invHeuristic;
                }
            }
            return filtered;
        }

        function populateAccountingCodeSelect(selectEl, codes, autoSelect = true) {
            if (!selectEl) return;
            selectEl.innerHTML = '<option value="">Select Account Code</option>';
            codes.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.id;
                opt.textContent = `${c.code} - ${c.name}`;
                selectEl.appendChild(opt);
            });
            if (autoSelect && codes.length === 1) {
                selectEl.value = codes[0].id;
            }
        }

        // Load and populate accounting codes based on category (CREATE)
        async function updateAccountingCodes() {
            const accountingType = document.getElementById('accountingCodeType').value;
            const accountingCategory = document.getElementById('accountingCodeCategory').value;
            const codeSelect = document.getElementById('accountingCode');
            codeSelect.innerHTML = '<option value="">Loading...</option>';
            if (!accountingType) { codeSelect.innerHTML = '<option value="">Select Account Code</option>'; return; }
            const allCodes = await loadAllAccountingCodes();
            const filtered = filterAccountingCodes(allCodes, { type: accountingType, category: accountingCategory });
            populateAccountingCodeSelect(codeSelect, filtered, true);
            if (!filtered.length) {
                console.warn('No accounting codes matched filters', { accountingType, accountingCategory });
            }
        }

        // Initialize accounting fields when modal opens
        function initializeNewProductModal() {
            console.log('initializeNewProductModal called');

            // Reset all form fields
            document.getElementById('newProductForm').reset();

            // Set default product type and trigger accounting field display
            document.getElementById('productType').value = 'inventory_item';
            toggleAccountingFields();

            // Set initial selling price requirement state
            toggleSellingPriceRequirement();

            // Multiple attempts to ensure accounting codes are populated
            setTimeout(() => {
                console.log('First retry: Re-triggering accounting codes population');
                updateAccountingCodes();
            }, 50);

            setTimeout(() => {
                console.log('Second retry: Re-triggering accounting codes population');
                updateAccountingCodes();

                // Force a refresh of the dropdown
                const dropdown = document.getElementById('accountingCode');
                console.log('Final dropdown state:', dropdown.innerHTML);
                console.log('Final dropdown children:', dropdown.children.length);
            }, 200);

            console.log('New product modal initialized with inventory_item type');
        }

        // Toggle accounting fields visibility for edit modal
        function toggleEditAccountingFields() {
            const productType = document.getElementById('editProductType').value;
            const accountingSection = document.getElementById('editAccountingCodeSection');
            const accountingType = document.getElementById('editAccountingCodeType');
            const accountingCategory = document.getElementById('editAccountingCodeCategory');
            const accountingCode = document.getElementById('editAccountingCode');

            console.log('toggleEditAccountingFields called - productType:', productType);
            console.log('accountingSection element:', accountingSection);

            if (productType === 'inventory_item') {
                if (accountingSection) {
                    accountingSection.style.display = 'block';
                    console.log('Set edit accounting section to visible');
                }
                if (accountingType) {
                    accountingType.required = true;
                    accountingType.value = 'Asset';
                }
                if (accountingCategory) {
                    accountingCategory.required = true;
                }
                if (accountingCode) {
                    accountingCode.required = true;
                }
                updateEditAccountingCategories();
            } else {
                if (accountingSection) {
                    accountingSection.style.display = 'none';
                    console.log('Set edit accounting section to hidden');
                }
                if (accountingType) accountingType.required = false;
                if (accountingCategory) accountingCategory.required = false;
                if (accountingCode) accountingCode.required = false;
            }
        }        // Update accounting categories for edit modal
        function updateEditAccountingCategories() {
            const accountingType = document.getElementById('editAccountingCodeType').value;
            const categorySelect = document.getElementById('editAccountingCodeCategory');

            // Clear existing options
            categorySelect.innerHTML = '<option value="">Select Category</option>';

            // Define inventory-appropriate categories for Asset type
            const inventoryCategories = {
                'Asset': [
                    { value: 'Inventory', label: 'Inventory', selected: true },
                    { value: 'Current Asset', label: 'Current Asset' },
                    { value: 'Fixed Asset', label: 'Fixed Asset' },
                    { value: 'Prepaid Assets', label: 'Prepaid Assets' },
                    { value: 'Trade Receivables', label: 'Trade Receivables' }
                ]
            };

            if (accountingType && inventoryCategories[accountingType]) {
                inventoryCategories[accountingType].forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.value;
                    option.textContent = category.label;
                    if (category.selected) {
                        option.selected = true;
                    }
                    categorySelect.appendChild(option);
                });

                // Auto-load accounting codes for inventory
                if (accountingType === 'Asset') {
                    updateEditAccountingCodes();
                }
            }
        }

        // Load and populate accounting codes for edit modal
        async function updateEditAccountingCodes() {
            const accountingType = document.getElementById('editAccountingCodeType').value;
            const accountingCategory = document.getElementById('editAccountingCodeCategory').value;
            const codeSelect = document.getElementById('editAccountingCode');
            codeSelect.innerHTML = '<option value="">Loading...</option>';
            if (!accountingType) { codeSelect.innerHTML = '<option value="">Select Account Code</option>'; return; }
            const allCodes = await loadAllAccountingCodes();
            const filtered = filterAccountingCodes(allCodes, { type: accountingType, category: accountingCategory });
            populateAccountingCodeSelect(codeSelect, filtered, false);
            if (!filtered.length) console.warn('No edit accounting codes matched filters', { accountingType, accountingCategory });
        }

        // Save product
        async function saveProduct() {
            const form = document.getElementById('newProductForm');

            // Custom validation for inventory items
            const productType = document.getElementById('productType').value;
            if (productType === 'inventory_item') {
                const accountingType = document.getElementById('accountingCodeType').value;
                const accountingCategory = document.getElementById('accountingCodeCategory').value;
                const accountingCode = document.getElementById('accountingCode').value;

                if (!accountingType || !accountingCategory || !accountingCode) {
                    if (window.modernUI) {
                        window.modernUI.showNotification('Please select account type, category, and specific accounting code for inventory items.', 'error');
                    } else {
                        alert('Please select account type, category, and specific accounting code for inventory items.');
                    }
                    return;
                }
            }

            if (form && form.checkValidity()) {
                try {
                    // Collect form data
                    const rawOnlyChecked = document.getElementById('isRawMaterialOnly')?.checked;
                    const isWeightBased = document.getElementById('isWeightBased')?.checked || false;

                    const productData = {
                        name: document.getElementById('productName').value,
                        sku: document.getElementById('productSku').value,
                        description: document.getElementById('productDescription').value || null,
                        quantity: parseInt(document.getElementById('initialQuantity').value) || 0,
                        barcode: document.getElementById('barcode').value || null,
                        cost_price: parseFloat(document.getElementById('costPrice').value) || 0,
                        selling_price: rawOnlyChecked ? 0 : (parseFloat(document.getElementById('sellingPrice').value) || 0),
                        is_serialized: document.getElementById('isSerialized').checked,
                        is_perishable: document.getElementById('isPerishable').checked,
                        is_taxable: document.getElementById('isTaxable').checked,
                        category: rawOnlyChecked ? 'raw_material' : (document.getElementById('productCategory').value || null),
                        product_type: document.getElementById('productType').value,
                        minimum_stock_level: parseInt(document.getElementById('reorderLevel').value) || 0,
                        reorder_point: parseInt(document.getElementById('reorderLevel').value) || 0,
                        unit_of_measure_id: document.getElementById('unitOfMeasure').value || null,
                        active: true,
                        non_saleable: !!rawOnlyChecked,
                        // Dimensional accounting fields
                        cost_center: document.getElementById('productCostCenter').value || null,
                        project: document.getElementById('productProject').value || null,
                        // Weight-based product fields
                        is_weight_based: isWeightBased,
                        weight_barcode_prefix: isWeightBased ? document.getElementById('weightCategory').value : null,
                        weight_barcode_sku: isWeightBased ? document.getElementById('weightBarcodeSku').value : null,
                        price_per_kg: isWeightBased ? parseFloat(document.getElementById('pricePerKg').value) : null,
                        price_per_gram: isWeightBased ? parseFloat(document.getElementById('pricePerGram').value) : null,
                        tare_weight: isWeightBased ? parseFloat(document.getElementById('tareWeight').value) || 0 : null,
                        min_weight: isWeightBased ? parseFloat(document.getElementById('minWeight').value) : null,
                        max_weight: isWeightBased ? parseFloat(document.getElementById('maxWeight').value) : null
                    };

                    // Add accounting code data for inventory items
                    const productType = document.getElementById('productType').value;
                    if (productType === 'inventory_item') {
                        const accountingType = document.getElementById('accountingCodeType').value;
                        const accountingCategory = document.getElementById('accountingCodeCategory').value;
                        const accountingCodeId = document.getElementById('accountingCode').value;

                        if (accountingType && accountingCategory && accountingCodeId) {
                            // Store the selected accounting code ID
                            productData.accounting_code_id = accountingCodeId;
                        }
                    }

                    console.log('Saving product data:', productData);

                    // Send to backend
                    const response = await fetch(PRODUCTS_ENDPOINT, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(productData)
                    });

                    if (!response.ok) {
                        let errorMessage = 'Failed to save product';
                        try {
                            const errorData = await response.json();
                            errorMessage = errorData.detail || errorMessage;
                        } catch (parseError) {
                            // If response is not JSON (e.g., HTML error page), get text content
                            const errorText = await response.text();
                            console.error('Server returned non-JSON error:', errorText);
                            errorMessage = `Server error (${response.status}): ${response.statusText}`;
                        }
                        throw new Error(errorMessage);
                    }

                    const savedProduct = await response.json();
                    console.log('Product saved successfully:', savedProduct);

                    // Show success message
                    if (window.modernUI) {
                        window.modernUI.showNotification('Product saved successfully!', 'success');
                    } else {
                        alert('Product saved successfully!');
                    }

                    // Close modal and reset form
                    const modal = bootstrap.Modal.getInstance(document.getElementById('newProductModal'));
                    if (modal) modal.hide();
                    form.reset();

                    // Refresh products list
                    await loadProducts();

                } catch (error) {
                    console.error('Error saving product:', error);
                    if (window.modernUI) {
                        window.modernUI.showNotification(`Failed to save product: ${error.message}`, 'error');
                    } else {
                        alert(`Failed to save product: ${error.message}`);
                    }
                }
            } else if (form) {
                form.reportValidity();
            }
        }

        // Delete product
        async function deleteProduct(productId, productName) {
            if (confirm(`Are you sure you want to delete product "${productName}"? This action cannot be undone.`)) {
                try {
                    console.log('Deleting product:', productId);

                    const response = await fetch(`${PRODUCTS_ENDPOINT}/${productId}`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });

                    if (!response.ok) {
                        let errorMessage = 'Failed to delete product';
                        try {
                            const errorData = await response.json();
                            errorMessage = errorData.detail || errorMessage;
                        } catch (parseError) {
                            // If response is not JSON (e.g., HTML error page), get text content
                            const errorText = await response.text();
                            console.error('Server returned non-JSON error:', errorText);
                            errorMessage = `Server error (${response.status}): ${response.statusText}`;
                        }
                        throw new Error(errorMessage);
                    }

                    const result = await response.json();
                    console.log('Product deleted successfully:', result);

                    // Show success message
                    if (window.modernUI) {
                        window.modernUI.showNotification(`Product "${productName}" deleted successfully!`, 'success');
                    } else {
                        alert(`Product "${productName}" deleted successfully!`);
                    }

                    // Refresh products list
                    await loadProducts();

                } catch (error) {
                    console.error('Error deleting product:', error);
                    if (window.modernUI) {
                        window.modernUI.showNotification(`Failed to delete product: ${error.message}`, 'error');
                    } else {
                        alert(`Failed to delete product: ${error.message}`);
                    }
                }
            }
        }

        // Save adjustment
        async function saveAdjustment() {
            const form = document.getElementById('adjustmentForm');
            if (form && form.checkValidity()) {
                try {
                    const productId = document.getElementById('adjustmentProduct').value;
                    const quantityChange = parseInt(document.getElementById('adjustmentQuantity').value);
                    const reasonSelect = document.getElementById('adjustmentReason').value;
                    const notes = document.getElementById('adjustmentNotes').value || '';

                    // Map UI reason to adjustment_type
                    let adjustmentType = reasonSelect;  // Most reasons map directly

                    // For expiry, treat as damage
                    if (reasonSelect === 'expiry') {
                        adjustmentType = 'damage';
                    }

                    // For correction, determine based on quantity direction
                    if (reasonSelect === 'correction') {
                        adjustmentType = quantityChange > 0 ? 'gain' : 'loss';
                    }

                    // Create descriptive reason text
                    let reasonText = '';
                    switch (reasonSelect) {
                        case 'gain':
                            reasonText = 'Found stock during count - inventory increase';
                            break;
                        case 'damage':
                            reasonText = 'Damaged or spoiled goods removed';
                            break;
                        case 'theft':
                            reasonText = 'Theft or missing inventory';
                            break;
                        case 'expiry':
                            reasonText = 'Expired products removed from inventory';
                            break;
                        case 'correction':
                            reasonText = 'Physical inventory count correction';
                            break;
                        case 'opening_stock':
                            reasonText = 'Opening stock entry';
                            break;
                        default:
                            reasonText = 'Inventory adjustment';
                    }

                    if (notes) {
                        reasonText += ' - ' + notes;
                    }

                    const adjustmentData = {
                        product_id: productId,
                        quantity_change: quantityChange,  // Fixed: was 'quantity'
                        adjustment_type: adjustmentType,   // Fixed: was missing
                        reason: reasonText,                 // Fixed: include notes in reason
                        notes: notes || null
                    };

                    console.log('Saving adjustment data:', adjustmentData);

                    // Send to backend
                    const response = await fetch(`${CNPERP.API.BASE_URL}/inventory/adjustments`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(adjustmentData)
                    });

                    if (!response.ok) {
                        let errorMessage = 'Failed to save adjustment';
                        try {
                            const errorData = await response.json();
                            errorMessage = errorData.detail || errorMessage;
                        } catch (parseError) {
                            // If response is not JSON (e.g., HTML error page), get text content
                            const errorText = await response.text();
                            console.error('Server returned non-JSON error:', errorText);
                            errorMessage = `Server error (${response.status}): ${response.statusText}`;
                        }
                        throw new Error(errorMessage);
                    }

                    const savedAdjustment = await response.json();
                    console.log('Adjustment saved successfully:', savedAdjustment);

                    // Show success message with details
                    const product = products.find(p => p.id === productId);
                    const message = `Inventory adjusted: ${product?.name || 'Product'} - ${quantityChange > 0 ? '+' : ''}${quantityChange} units. New qty: ${savedAdjustment.new_quantity}`;

                    if (window.CNPERP && window.CNPERP.UI) {
                        window.CNPERP.UI.showNotification(message, 'success');
                    } else {
                        alert(message);
                    }

                    // Close modal and reset form
                    const modal = bootstrap.Modal.getInstance(document.getElementById('inventoryAdjustmentModal'));
                    if (modal) modal.hide();
                    form.reset();

                    // Refresh products list
                    await loadProducts();

                } catch (error) {
                    console.error('Error saving adjustment:', error);
                    if (window.modernUI) {
                        window.modernUI.showNotification(`Failed to save adjustment: ${error.message}`, 'error');
                    } else {
                        alert(`Failed to save adjustment: ${error.message}`);
                    }
                }
            } else if (form) {
                form.reportValidity();
            }
        }

        // View product details
        async function viewProduct(id) {
            const product = products.find(p => p.id === id);
            if (!product) return;

            try {
                // Fetch fresh product data
                const response = await fetch(`${PRODUCTS_ENDPOINT}/${id}`);
                if (response.ok) {
                    const freshProduct = await response.json();
                    populateViewModal(freshProduct);
                } else {
                    console.warn('Failed to fetch fresh product data, using cached data');
                    populateViewModal(product);
                }

                // Show the modal
                new bootstrap.Modal(document.getElementById('viewProductModal')).show();
            } catch (error) {
                console.error('Error fetching product details:', error);
                populateViewModal(product);
                new bootstrap.Modal(document.getElementById('viewProductModal')).show();
            }
        }

        // Populate view modal with product data
        function populateViewModal(product) {
            document.getElementById('viewProductName').textContent = product.name || '-';
            document.getElementById('viewProductSku').textContent = product.sku || '-';
            document.getElementById('viewProductCategory').textContent = product.category || 'Uncategorized';
            document.getElementById('viewProductType').textContent = product.product_type || '-';
            document.getElementById('viewProductBrand').textContent = product.brand || '-';
            document.getElementById('viewProductModel').textContent = product.model || '-';
            document.getElementById('viewProductBarcode').textContent = product.barcode || '-';
            document.getElementById('viewProductCostPrice').textContent = formatCurrency(product.cost_price);
            document.getElementById('viewProductSellingPrice').textContent = formatCurrency(product.selling_price);
            document.getElementById('viewProductQuantity').textContent = product.quantity || 0;
            document.getElementById('viewProductUnitOfMeasure').textContent = getUnitOfMeasureName(product.unit_of_measure_id) || '-';
            document.getElementById('viewProductMinStock').textContent = product.minimum_stock_level || '-';
            document.getElementById('viewProductReorderPoint').textContent = product.reorder_point || '-';
            document.getElementById('viewProductTotalValue').textContent = formatCurrency((product.quantity || 0) * (product.cost_price || 0));
            document.getElementById('viewProductSerialized').checked = product.is_serialized || false;
            document.getElementById('viewProductPerishable').checked = product.is_perishable || false;
            document.getElementById('viewProductActive').checked = product.active !== false;
            document.getElementById('viewProductWeight').textContent = product.weight || '-';
            document.getElementById('viewProductDimensions').textContent = product.dimensions || '-';
            document.getElementById('viewProductExpiryDate').textContent = product.expiry_date || '-';
            document.getElementById('viewProductBatchNumber').textContent = product.batch_number || '-';
            document.getElementById('viewProductWarrantyMonths').textContent = product.warranty_period_months || '-';
            document.getElementById('viewProductWarrantyYears').textContent = product.warranty_period_years || '-';
            document.getElementById('viewProductDescription').textContent = product.description || 'No description available';
            document.getElementById('viewProductNotes').textContent = product.notes || 'No notes available';

            // Handle accounting code information
            const accountingCodeElement = document.getElementById('viewProductAccountingCode');
            const accountingCategoryElement = document.getElementById('viewProductAccountingCategory');

            if (product.accounting_code_id) {
                // Fetch accounting code details
                fetchAccountingCodeDetails(product.accounting_code_id);
            } else {
                // No accounting code assigned
                if (accountingCodeElement) accountingCodeElement.textContent = 'Not Assigned';
                if (accountingCategoryElement) accountingCategoryElement.textContent = 'Not Assigned';
            }

            // Store current product for edit functionality
            window.currentViewProduct = product;
        }

        // Fetch accounting code details for view modal
        async function fetchAccountingCodeDetails(accountingCodeId) {
            const accountingCodeElement = document.getElementById('viewProductAccountingCode');
            const accountingCategoryElement = document.getElementById('viewProductAccountingCategory');

            console.log('Fetching accounting code details for ID:', accountingCodeId);

            try {
                const url = `/api/v1/accounting-codes/${accountingCodeId}`;
                console.log('Fetching from URL:', url);

                const response = await fetch(url);
                console.log('Response status:', response.status);

                if (response.ok) {
                    const accountingCode = await response.json();
                    console.log('Accounting code data received:', accountingCode);

                    // Populate the accounting code fields
                    if (accountingCodeElement) {
                        accountingCodeElement.textContent = `${accountingCode.code} - ${accountingCode.name}`;
                    }
                    if (accountingCategoryElement) {
                        accountingCategoryElement.textContent = accountingCode.category || 'Unknown';
                    }

                    console.log('Successfully populated accounting code details');
                } else {
                    console.error('Failed to fetch accounting code details, status:', response.status);
                    let errorMessage = 'Failed to load accounting code';
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.detail || errorMessage;
                        console.error('Error details:', errorData);
                    } catch (parseError) {
                        // If response is not JSON (e.g., HTML error page), get text content
                        const errorText = await response.text();
                        console.error('Server returned non-JSON error for accounting code:', errorText);
                        errorMessage = `Server error (${response.status}): ${response.statusText}`;
                    }

                    // Show error in the fields
                    if (accountingCodeElement) accountingCodeElement.textContent = 'Error loading';
                    if (accountingCategoryElement) accountingCategoryElement.textContent = 'Error loading';

                    console.error('Error fetching accounting code details:', errorMessage);
                }
            } catch (error) {
                console.error('Network error fetching accounting code details:', error);
                // Show error in the fields
                if (accountingCodeElement) accountingCodeElement.textContent = 'Error loading';
                if (accountingCategoryElement) accountingCategoryElement.textContent = 'Error loading';
            }
        }

        // Helper function to get unit of measure name
        function getUnitOfMeasureName(unitId) {
            if (!window.unitsOfMeasure || !unitId) return null;
            const unit = window.unitsOfMeasure.find(u => u.id === unitId);
            return unit ? `${unit.name} (${unit.abbreviation})` : null;
        }

        // Edit product from view modal
        function editProductFromView() {
            if (window.currentViewProduct) {
                // Close view modal
                const viewModal = bootstrap.Modal.getInstance(document.getElementById('viewProductModal'));
                if (viewModal) viewModal.hide();

                // Open edit modal
                editProduct(window.currentViewProduct.id);
            }
        }

        // Edit product
        async function editProduct(id) {
            const product = products.find(p => p.id === id);
            if (!product) return;

            try {
                // Fetch fresh product data
                const response = await fetch(`${PRODUCTS_ENDPOINT}/${id}`);
                if (response.ok) {
                    const freshProduct = await response.json();
                    populateEditModal(freshProduct);
                } else {
                    console.warn('Failed to fetch fresh product data for edit, using cached data');
                    populateEditModal(product);
                }

                // Show the modal
                new bootstrap.Modal(document.getElementById('editProductModal')).show();
            } catch (error) {
                console.error('Error fetching product details for edit:', error);
                populateEditModal(product);
                new bootstrap.Modal(document.getElementById('editProductModal')).show();
            }
        }

        // Populate edit modal with product data
        function populateEditModal(product) {
            document.getElementById('editProductId').value = product.id;
            document.getElementById('editProductName').value = product.name || '';
            document.getElementById('editProductSku').value = product.sku || '';
            document.getElementById('editProductCategory').value = product.category || '';
            document.getElementById('editProductType').value = product.product_type || 'inventory_item';
            document.getElementById('editCostPrice').value = product.cost_price || 0;
            document.getElementById('editSellingPrice').value = product.selling_price || 0;
            document.getElementById('editQuantity').value = product.quantity || 0;
            document.getElementById('editUnitOfMeasure').value = product.unit_of_measure_id || '';
            document.getElementById('editBrand').value = product.brand || '';
            document.getElementById('editModel').value = product.model || '';
            document.getElementById('editBarcode').value = product.barcode || '';
            document.getElementById('editReorderLevel').value = product.reorder_point || 0;
            document.getElementById('editWeight').value = product.weight || '';
            document.getElementById('editDimensions').value = product.dimensions || '';
            document.getElementById('editProductDescription').value = product.description || '';
            document.getElementById('editIsSerialized').checked = product.is_serialized || false;
            document.getElementById('editIsPerishable').checked = product.is_perishable || false;
            document.getElementById('editIsTaxable').checked = product.is_taxable !== false; // Default to true if not specified
            document.getElementById('editIsActive').checked = product.active !== false;

            // Populate accounting fields if available
            if (product.accounting_code_id) {
                // Set defaults for inventory items with accounting codes
                document.getElementById('editAccountingCodeType').value = 'Asset';
                updateEditAccountingCategories(); // Populate categories first

                setTimeout(async () => {
                    document.getElementById('editAccountingCodeCategory').value = 'Inventory';
                    await updateEditAccountingCodes(); // Load codes for the category

                    // Set the specific accounting code
                    document.getElementById('editAccountingCode').value = product.accounting_code_id;
                }, 100);
            } else {
                // Set defaults for inventory items without accounting codes
                if (product.product_type === 'inventory_item') {
                    document.getElementById('editAccountingCodeType').value = 'Asset';
                    updateEditAccountingCategories();

                    setTimeout(async () => {
                        document.getElementById('editAccountingCodeCategory').value = 'Inventory';
                        await updateEditAccountingCodes();
                    }, 100);
                }
            }

            // Toggle accounting fields visibility based on product type
            toggleEditAccountingFields();

            // Toggle selling price requirement based on category
            toggleEditSellingPriceRequirement();

            // Populate units of measure dropdown
            populateEditUnitsDropdown();
        }

        // Populate units dropdown in edit modal
        function populateEditUnitsDropdown() {
            const select = document.getElementById('editUnitOfMeasure');
            if (select && window.unitsOfMeasure) {
                const currentValue = select.value;
                select.innerHTML = '<option value="">Select Unit</option>';
                window.unitsOfMeasure.forEach(unit => {
                    const option = document.createElement('option');
                    option.value = unit.id;
                    option.textContent = `${unit.name} (${unit.abbreviation})`;
                    select.appendChild(option);
                });
                select.value = currentValue;
            }
        }

        // Save product edit
        async function saveProductEdit() {
            const form = document.getElementById('editProductForm');

            // Custom validation for inventory items
            const productType = document.getElementById('editProductType').value;
            if (productType === 'inventory_item') {
                const accountingType = document.getElementById('editAccountingCodeType').value;
                const accountingCategory = document.getElementById('editAccountingCodeCategory').value;
                const accountingCode = document.getElementById('editAccountingCode').value;

                if (!accountingType || !accountingCategory || !accountingCode) {
                    if (window.modernUI) {
                        window.modernUI.showNotification('Please select account type, category, and specific accounting code for inventory items.', 'error');
                    } else {
                        alert('Please select account type, category, and specific accounting code for inventory items.');
                    }
                    return;
                }
            }

            if (form && form.checkValidity()) {
                try {
                    const productId = document.getElementById('editProductId').value;

                    // Collect form data
                    const productData = {
                        name: document.getElementById('editProductName').value,
                        sku: document.getElementById('editProductSku').value,
                        description: document.getElementById('editProductDescription').value || null,
                        barcode: document.getElementById('editBarcode').value || null,
                        cost_price: parseFloat(document.getElementById('editCostPrice').value) || 0,
                        selling_price: parseFloat(document.getElementById('editSellingPrice').value) || 0,
                        is_serialized: document.getElementById('editIsSerialized').checked,
                        is_perishable: document.getElementById('editIsPerishable').checked,
                        is_taxable: document.getElementById('editIsTaxable').checked,
                        category: document.getElementById('editProductCategory').value || null,
                        product_type: document.getElementById('editProductType').value,
                        brand: document.getElementById('editBrand').value || null,
                        model: document.getElementById('editModel').value || null,
                        weight: parseFloat(document.getElementById('editWeight').value) || null,
                        dimensions: document.getElementById('editDimensions').value || null,
                        minimum_stock_level: parseInt(document.getElementById('editReorderLevel').value) || 0,
                        reorder_point: parseInt(document.getElementById('editReorderLevel').value) || 0,
                        unit_of_measure_id: document.getElementById('editUnitOfMeasure').value || null,
                        active: document.getElementById('editIsActive').checked
                    };

                    // Add accounting code data for inventory items
                    if (productType === 'inventory_item') {
                        const accountingType = document.getElementById('editAccountingCodeType').value;
                        const accountingCategory = document.getElementById('editAccountingCodeCategory').value;
                        const accountingCodeId = document.getElementById('editAccountingCode').value;

                        if (accountingType && accountingCategory && accountingCodeId) {
                            // Store the selected accounting code ID
                            productData.accounting_code_id = accountingCodeId;
                        }
                    }

                    console.log('Updating product data:', productData);

                    // Send to backend
                    const response = await fetch(`${PRODUCTS_ENDPOINT}/${productId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(productData)
                    });

                    if (!response.ok) {
                        let errorMessage = 'Failed to update product';
                        try {
                            const errorData = await response.json();
                            errorMessage = errorData.detail || errorMessage;
                        } catch (parseError) {
                            // If response is not JSON (e.g., HTML error page), get text content
                            const errorText = await response.text();
                            console.error('Server returned non-JSON error:', errorText);
                            errorMessage = `Server error (${response.status}): ${response.statusText}`;
                        }
                        throw new Error(errorMessage);
                    }

                    const updatedProduct = await response.json();
                    console.log('Product updated successfully:', updatedProduct);

                    // Show success message
                    if (window.modernUI) {
                        window.modernUI.showNotification('Product updated successfully!', 'success');
                    } else {
                        alert('Product updated successfully!');
                    }

                    // Close modal and reset form
                    const modal = bootstrap.Modal.getInstance(document.getElementById('editProductModal'));
                    if (modal) modal.hide();
                    form.reset();

                    // Refresh products list
                    await loadProducts();

                } catch (error) {
                    console.error('Error updating product:', error);
                    if (window.modernUI) {
                        window.modernUI.showNotification(`Failed to update product: ${error.message}`, 'error');
                    } else {
                        alert(`Failed to update product: ${error.message}`);
                    }
                }
            } else if (form) {
                form.reportValidity();
            }
        }

        // Adjust inventory
        function adjustInventory(id) {
            const product = products.find(p => p.id === id);
            if (product) {
                // Populate the product dropdown
                const productSelect = document.getElementById('adjustmentProduct');
                productSelect.innerHTML = '<option value="">Select Product</option>';

                // Add all products to dropdown
                products.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p.id;
                    option.textContent = `${p.name} (Current: ${p.quantity})`;
                    if (p.id === id) {
                        option.selected = true;
                    }
                    productSelect.appendChild(option);
                });

                // Clear form fields
                document.getElementById('adjustmentQuantity').value = '';
                document.getElementById('adjustmentReason').value = '';
                document.getElementById('adjustmentNotes').value = '';

                // Show modal
                new bootstrap.Modal(document.getElementById('inventoryAdjustmentModal')).show();
            }
        }

        // Clear filters
        function clearFilters() {
            const searchFilter = document.getElementById('searchFilter');
            const branchFilter = document.getElementById('branchFilter');
            const categoryFilter = document.getElementById('categoryFilter');
            const stockFilter = document.getElementById('stockFilter');
            const productTypeFilter = document.getElementById('productTypeFilter');
            const taxStatusFilter = document.getElementById('taxStatusFilter');
            const costCenterFilter = document.getElementById('costCenterFilter');
            const projectFilter = document.getElementById('projectFilter');

            if (searchFilter) searchFilter.value = '';
            if (branchFilter) branchFilter.value = '';
            if (categoryFilter) categoryFilter.value = '';
            if (stockFilter) stockFilter.value = '';
            if (productTypeFilter) productTypeFilter.value = '';
            if (taxStatusFilter) taxStatusFilter.value = '';
            if (costCenterFilter) costCenterFilter.value = '';
            if (projectFilter) projectFilter.value = '';

            loadProducts();
        }

        // Toggle perishable fields
        document.getElementById('isPerishable').addEventListener('change', function () {
            const perishableFields = document.getElementById('perishableFields');
            perishableFields.style.display = this.checked ? 'block' : 'none';
        });

        // Load data when page loads
        document.addEventListener('DOMContentLoaded', async function () {
            await loadSettings();
            await loadUnitsOfMeasure();
            await loadDimensionalData();
            await loadProducts();

            const templateBtn = document.getElementById('downloadTemplateBtn');
            if (templateBtn) {
                templateBtn.addEventListener('click', downloadBlankProductTemplate);
            }

            const uploadBtn = document.getElementById('uploadTemplateBtn');
            if (uploadBtn) {
                uploadBtn.addEventListener('click', triggerProductImport);
            }

            const importInput = document.getElementById('productImportInput');
            if (importInput) {
                importInput.addEventListener('change', handleProductImport);
            }
        });

        // Load units of measure
        async function loadUnitsOfMeasure() {
            try {
                // Use enhanced UOM API with filtering
                const response = await fetch('/api/v1/uom?is_active=true');
                if (response.ok) {
                    const data = await response.json();
                    const units = data.units || [];

                    // Store globally for use in other functions
                    window.unitsOfMeasure = units;

                    // Group units by category
                    const unitsByCategory = {};
                    const categoryOrder = {
                        'quantity': '1-Quantity',
                        'length': '2-Length/Distance',
                        'area': '3-Area',
                        'volume': '4-Volume',
                        'weight': '5-Weight/Mass',
                        'temperature': '6-Temperature',
                        'pressure': '7-Pressure',
                        'speed': '8-Speed',
                        'time': '9-Time',
                        'angle': '10-Angle',
                        'energy': '11-Energy',
                        'power': '12-Power',
                        'nautical': '13-Nautical'
                    };

                    units.forEach(unit => {
                        const cat = unit.category || 'other';
                        if (!unitsByCategory[cat]) {
                            unitsByCategory[cat] = [];
                        }
                        unitsByCategory[cat].push(unit);
                    });

                    // Sort each category by display_order
                    Object.keys(unitsByCategory).forEach(cat => {
                        unitsByCategory[cat].sort((a, b) => (a.display_order || 0) - (b.display_order || 0));
                    });

                    // Populate new product form dropdown with categorized optgroups
                    const select = document.getElementById('unitOfMeasure');
                    if (select) {
                        select.innerHTML = '<option value="">Select Unit</option>';

                        // Sort categories by defined order
                        const sortedCategories = Object.keys(unitsByCategory).sort((a, b) => {
                            const orderA = categoryOrder[a] || `99-${a}`;
                            const orderB = categoryOrder[b] || `99-${b}`;
                            return orderA.localeCompare(orderB);
                        });

                        sortedCategories.forEach(category => {
                            const optgroup = document.createElement('optgroup');
                            const displayName = (categoryOrder[category] || category).replace(/^\d+-/, '');
                            optgroup.label = displayName;

                            unitsByCategory[category].forEach(unit => {
                                const option = document.createElement('option');
                                option.value = unit.id;
                                const subcatMark = unit.subcategory ? ` [${unit.subcategory}]` : '';
                                const baseMark = unit.is_base_unit ? ' â˜…' : '';
                                option.textContent = `${unit.name} (${unit.symbol || unit.abbreviation})${subcatMark}${baseMark}`;
                                if (unit.usage_hint) {
                                    option.title = unit.usage_hint;
                                }
                                optgroup.appendChild(option);
                            });

                            select.appendChild(optgroup);
                        });
                    }

                    // Populate edit dropdown if present
                    const editSelect = document.getElementById('editUnitOfMeasure');
                    if (editSelect) {
                        editSelect.innerHTML = '<option value="">Select Unit</option>';

                        const sortedCategories = Object.keys(unitsByCategory).sort((a, b) => {
                            const orderA = categoryOrder[a] || `99-${a}`;
                            const orderB = categoryOrder[b] || `99-${b}`;
                            return orderA.localeCompare(orderB);
                        });

                        sortedCategories.forEach(category => {
                            const optgroup = document.createElement('optgroup');
                            const displayName = (categoryOrder[category] || category).replace(/^\d+-/, '');
                            optgroup.label = displayName;

                            unitsByCategory[category].forEach(unit => {
                                const option = document.createElement('option');
                                option.value = unit.id;
                                const subcatMark = unit.subcategory ? ` [${unit.subcategory}]` : '';
                                const baseMark = unit.is_base_unit ? ' â˜…' : '';
                                option.textContent = `${unit.name} (${unit.symbol || unit.abbreviation})${subcatMark}${baseMark}`;
                                if (unit.usage_hint) {
                                    option.title = unit.usage_hint;
                                }
                                optgroup.appendChild(option);
                            });

                            editSelect.appendChild(optgroup);
                        });
                    }
                    // Wire info buttons
                    const uomBtn = document.getElementById('uomInfoBtn');
                    if (uomBtn) uomBtn.onclick = () => {
                        const sel = document.getElementById('unitOfMeasure');
                        const hint = document.getElementById('uomHint');
                        showUomHintFor(sel?.value, hint);
                    };
                    const editUomBtn = document.getElementById('editUomInfoBtn');
                    if (editUomBtn) editUomBtn.onclick = () => {
                        const sel = document.getElementById('editUnitOfMeasure');
                        const hint = document.getElementById('editUomHint');
                        showUomHintFor(sel?.value, hint);
                    };
                } else {
                    console.warn('Failed to load units of measure, status:', response.status);
                    let errorMessage = 'Failed to load units of measure';
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.detail || errorMessage;
                    } catch (parseError) {
                        // If response is not JSON (e.g., HTML error page), get text content
                        const errorText = await response.text();
                        console.error('Server returned non-JSON error for units:', errorText);
                        errorMessage = `Server error (${response.status}): ${response.statusText}`;
                    }
                    console.error('Error loading units of measure:', errorMessage);
                }
            } catch (error) {
                console.error('Error loading units of measure:', error);
            }
        }

        function showUomHintFor(unitId, hintEl) {
            if (!hintEl) return;
            const unit = (window.unitsOfMeasure || []).find(u => u.id === unitId);
            if (!unit) { hintEl.textContent = ''; return; }
            const base = unit.base_unit;
            if (unit.is_base_unit || !base) {
                hintEl.textContent = `Base unit: ${unit.name} (${unit.abbreviation}).`;
            } else {
                const factor = unit.conversion_factor || 1;
                hintEl.textContent = `Conversion: 1 ${unit.abbreviation} = ${factor} ${base.abbreviation} (base: ${base.name}).`;
            }
        }

        // Image handling functions
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                // Validate file type
                if (!file.type.startsWith('image/')) {
                    alert('Please select a valid image file.');
                    return;
                }

                // Validate file size (10MB)
                if (file.size > 10 * 1024 * 1024) {
                    alert('Image size must be less than 10MB.');
                    return;
                }

                // Show preview
                const reader = new FileReader();
                reader.onload = function (e) {
                    document.getElementById('previewImg').src = e.target.result;
                    document.getElementById('imagePreview').style.display = 'block';
                    document.getElementById('imageUploadArea').style.display = 'none';
                };
                reader.readAsDataURL(file);
            }
        }

        function removeImage() {
            document.getElementById('productImage').value = '';
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('imageUploadArea').style.display = 'block';
        }

        function viewProductImage(imageUrl, productName) {
            if (imageUrl) {
                document.getElementById('modalProductImage').src = imageUrl;
                document.getElementById('productImageModal').querySelector('.modal-title').textContent = `Product Image - ${productName}`;
                new bootstrap.Modal(document.getElementById('productImageModal')).show();
            }
        }

        function downloadImage() {
            const img = document.getElementById('modalProductImage');
            const link = document.createElement('a');
            link.href = img.src;
            link.download = 'product-image.jpg';
            link.click();
        }

        async function optimizeImage() {
            // This would call the optimize endpoint
            alert('Image optimization feature coming soon!');
        }

        async function addWatermark() {
            // This would call the watermark endpoint
            alert('Watermark feature coming soon!');
        }

        // Filter products based on current filter values
        function filterProducts() {
            const searchTerm = document.getElementById('searchFilter')?.value.toLowerCase() || '';
            const branchFilter = document.getElementById('branchFilter')?.value || '';
            const categoryFilter = document.getElementById('categoryFilter')?.value || '';
            const stockFilter = document.getElementById('stockFilter')?.value || '';
            const productTypeFilter = document.getElementById('productTypeFilter')?.value || '';
            const taxStatusFilter = document.getElementById('taxStatusFilter')?.value || '';

            const filteredProducts = products.filter(product => {
                // Search filter
                const matchesSearch = !searchTerm ||
                    product.name.toLowerCase().includes(searchTerm) ||
                    (product.sku && product.sku.toLowerCase().includes(searchTerm)) ||
                    (product.description && product.description.toLowerCase().includes(searchTerm));

                // Branch filter
                // Product master isn't per-branch; branch view is handled by the toggle and renderProducts()
                const matchesBranch = true;

                // Category filter
                const matchesCategory = !categoryFilter || product.category === categoryFilter;

                // Stock filter
                let matchesStock = true;
                if (stockFilter === 'in-stock') {
                    matchesStock = product.quantity > 0;
                } else if (stockFilter === 'low-stock') {
                    matchesStock = product.quantity > 0 && product.quantity <= (product.reorder_point || 5);
                } else if (stockFilter === 'out-of-stock') {
                    matchesStock = product.quantity === 0;
                }

                // Product type filter
                const matchesType = !productTypeFilter || product.product_type === productTypeFilter;

                // Tax status filter
                const isTaxable = product.is_taxable !== false; // Default to true if not specified
                let matchesTaxStatus = true;
                if (taxStatusFilter === 'taxable') {
                    matchesTaxStatus = isTaxable;
                } else if (taxStatusFilter === 'non-taxable') {
                    matchesTaxStatus = !isTaxable;
                }

                return matchesSearch && matchesBranch && matchesCategory && matchesStock && matchesType && matchesTaxStatus;
            });

            // Update the displayed products
            products = filteredProducts;
            renderProducts();
        }

        // Add click handler for image upload area
        document.addEventListener('DOMContentLoaded', function () {
            const uploadArea = document.getElementById('imageUploadArea');
            if (uploadArea) {
                uploadArea.addEventListener('click', function () {
                    document.getElementById('productImage').click();
                });
            }

            // Initialize data loading
            Promise.all([
                loadProducts(),
                loadBranches()
            ]);

            // Add filter event listeners
            const searchFilter = document.getElementById('searchFilter');
            const branchFilter = document.getElementById('branchFilter');
            const categoryFilter = document.getElementById('categoryFilter');
            const stockFilter = document.getElementById('stockFilter');
            const productTypeFilter = document.getElementById('productTypeFilter');
            const taxStatusFilter = document.getElementById('taxStatusFilter');

            if (searchFilter) searchFilter.addEventListener('input', filterProducts);
            // In branch mode, branch selection drives render and panel; in HQ mode it does nothing
            if (branchFilter) branchFilter.addEventListener('change', async () => {
                setBranchUIVisibility();
                await renderProducts();
                await refreshBranchAllocPanel();
            });
            if (categoryFilter) categoryFilter.addEventListener('change', filterProducts);
            if (stockFilter) stockFilter.addEventListener('change', filterProducts);
            if (productTypeFilter) productTypeFilter.addEventListener('change', filterProducts);
            if (taxStatusFilter) taxStatusFilter.addEventListener('change', filterProducts);

            // View mode switch handlers
            const viewSwitch = document.getElementById('viewModeSwitch');
            if (viewSwitch) {
                // default to HQ mode
                viewSwitch.checked = false;
                setBranchUIVisibility();
                viewSwitch.addEventListener('change', async () => {
                    setBranchUIVisibility();
                    // If switching off Branch, clear branch selection for clarity
                    if (!getViewModeIsBranch() && branchFilter) {
                        branchFilter.value = '';
                    }
                    await renderProducts();
                    await refreshBranchAllocPanel();
                });
            }

            // Branch panel refresh button
            const btnRefresh = document.getElementById('btnBranchPanelRefresh');
            if (btnRefresh) {
                btnRefresh.addEventListener('click', async () => {
                    await refreshBranchAllocPanel();
                });
            }

            // Initialize new product modal when it's shown
            const newProductModal = document.getElementById('newProductModal');
            if (newProductModal) {
                newProductModal.addEventListener('show.bs.modal', function (event) {
                    initializeNewProductModal();
                });
            }

            // Initialize edit product modal when it's shown
            const editProductModal = document.getElementById('editProductModal');
            if (editProductModal) {
                editProductModal.addEventListener('show.bs.modal', function (event) {
                    // The modal is populated by populateEditModal function which is called before showing
                    // We just need to ensure accounting fields are properly initialized
                    setTimeout(() => {
                        toggleEditAccountingFields();
                        toggleEditSellingPriceRequirement();
                    }, 100);
                });
            }
        });

        // ============================================================================
        // WEIGHT-BASED PRODUCT FUNCTIONS
        // ============================================================================

        // Toggle weight-based fields visibility
        function toggleWeightFields() {
            const isWeightBased = document.getElementById('isWeightBased').checked;
            const weightFields = document.getElementById('weightBasedFields');

            if (weightFields) {
                weightFields.style.display = isWeightBased ? 'block' : 'none';
            }

            // If enabling weight mode, update barcode preview
            if (isWeightBased) {
                updateBarcodePreview();
            }
        }

        // Update barcode prefix when category changes
        function updateBarcodePrefix() {
            updateBarcodePreview();
        }

        // Calculate price per gram from price per kg
        function calculatePricePerGram() {
            const pricePerKg = parseFloat(document.getElementById('pricePerKg').value) || 0;
            const pricePerGram = pricePerKg / 1000;
            document.getElementById('pricePerGram').value = pricePerGram.toFixed(4);
        }

        // Update barcode preview
        function updateBarcodePreview() {
            const categoryCode = document.getElementById('weightCategory').value;
            const productSku = document.getElementById('weightBarcodeSku').value;

            if (!categoryCode || !productSku || productSku.length !== 5) {
                document.getElementById('barcodePreview').textContent = '--';
                return;
            }

            // Sample barcode for 1.5kg (1500g)
            const sampleWeight = '01500';
            const barcode12 = categoryCode + productSku + sampleWeight;
            const checkDigit = calculateBarcodeChecksum(barcode12);
            const fullBarcode = barcode12 + checkDigit;

            // Format as XX-XXXXX-XXXXX-X
            const formatted = `${fullBarcode.substring(0, 2)}-${fullBarcode.substring(2, 7)}-${fullBarcode.substring(7, 12)}-${fullBarcode[12]}`;
            document.getElementById('barcodePreview').textContent = formatted;
        }

        // Calculate EAN-13 checksum
        function calculateBarcodeChecksum(barcode12) {
            if (barcode12.length !== 12) return '0';

            let oddSum = 0, evenSum = 0;
            for (let i = 0; i < 12; i++) {
                if (i % 2 === 0) oddSum += parseInt(barcode12[i]);
                else evenSum += parseInt(barcode12[i]);
            }

            const total = oddSum + (evenSum * 3);
            return ((10 - (total % 10)) % 10).toString();
        }

        // ============================================================================
        // Product Dimensional Report Functions

        async function generateProductDimensionalReport() {
            const reportType = document.getElementById('productReportType').value;
            const categoryFilter = document.getElementById('productReportCategory').value;
            const resultsDiv = document.getElementById('productReportResults');
            const exportBtn = document.getElementById('exportProductReportBtn');

            try {
                // Show loading
                resultsDiv.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"></div><p class="mt-2">Generating report...</p></div>';

                // Filter products by category if specified
                let filteredProducts = products;
                if (categoryFilter) {
                    filteredProducts = products.filter(product => product.category === categoryFilter);
                }

                // Process data based on report type
                let reportData = {};
                let reportTitle = '';

                if (reportType === 'cost_center') {
                    reportTitle = 'Products by Cost Center';
                    reportData = processProductsByDimension(filteredProducts, 'cost_center', 'costCenters');
                } else if (reportType === 'project') {
                    reportTitle = 'Products by Project';
                    reportData = processProductsByDimension(filteredProducts, 'project', 'projects');
                } else if (reportType === 'combination') {
                    reportTitle = 'Products by Cost Center & Project';
                    reportData = processProductsByCombination(filteredProducts);
                } else if (reportType === 'value_analysis') {
                    reportTitle = 'Inventory Value by Dimensions';
                    reportData = processProductsValueAnalysis(filteredProducts);
                }

                // Display results
                displayProductReportResults(reportData, reportTitle, categoryFilter);
                exportBtn.style.display = 'block';

            } catch (error) {
                console.error('Error generating product dimensional report:', error);
                resultsDiv.innerHTML = '<div class="alert alert-danger">Failed to generate report. Please try again.</div>';
                exportBtn.style.display = 'none';
            }
        }

        function processProductsByDimension(products, dimensionField, dimensionType) {
            const summary = {};
            let totalProducts = 0;
            let totalValue = 0;

            products.forEach(product => {
                const dimensionValue = product[dimensionField];
                const key = dimensionValue || 'Unassigned';
                const productValue = (parseFloat(product.quantity || 0) * parseFloat(product.cost_price || 0));

                if (!summary[key]) {
                    summary[key] = {
                        name: getDimensionName(dimensionValue, dimensionType),
                        count: 0,
                        totalValue: 0,
                        percentage: 0
                    };
                }

                summary[key].count++;
                summary[key].totalValue += productValue;
                totalProducts++;
                totalValue += productValue;
            });

            // Calculate percentages
            Object.keys(summary).forEach(key => {
                summary[key].percentage = totalValue > 0 ? (summary[key].totalValue / totalValue * 100) : 0;
            });

            return {
                summary,
                totals: { count: totalProducts, value: totalValue }
            };
        }

        function processProductsByCombination(products) {
            const summary = {};
            let totalProducts = 0;
            let totalValue = 0;

            products.forEach(product => {
                const costCenter = product.cost_center || 'Unassigned';
                const project = product.project || 'Unassigned';
                const key = `${getDimensionName(costCenter, 'costCenters')} | ${getDimensionName(project, 'projects')}`;
                const productValue = (parseFloat(product.quantity || 0) * parseFloat(product.cost_price || 0));

                if (!summary[key]) {
                    summary[key] = {
                        name: key,
                        count: 0,
                        totalValue: 0,
                        percentage: 0
                    };
                }

                summary[key].count++;
                summary[key].totalValue += productValue;
                totalProducts++;
                totalValue += productValue;
            });

            // Calculate percentages
            Object.keys(summary).forEach(key => {
                summary[key].percentage = totalValue > 0 ? (summary[key].totalValue / totalValue * 100) : 0;
            });

            return {
                summary,
                totals: { count: totalProducts, value: totalValue }
            };
        }

        function processProductsValueAnalysis(products) {
            const summary = {};
            let totalProducts = 0;
            let totalValue = 0;

            products.forEach(product => {
                const costCenter = product.cost_center || 'Unassigned';
                const project = product.project || 'Unassigned';
                const productValue = (parseFloat(product.quantity || 0) * parseFloat(product.cost_price || 0));

                // Group by cost center first
                if (!summary[costCenter]) {
                    summary[costCenter] = {
                        name: getDimensionName(costCenter, 'costCenters'),
                        projects: {},
                        totalValue: 0,
                        count: 0
                    };
                }

                // Then by project within cost center
                if (!summary[costCenter].projects[project]) {
                    summary[costCenter].projects[project] = {
                        name: getDimensionName(project, 'projects'),
                        products: [],
                        totalValue: 0,
                        count: 0
                    };
                }

                summary[costCenter].projects[project].products.push({
                    name: product.name,
                    sku: product.sku,
                    quantity: product.quantity || 0,
                    cost_price: product.cost_price || 0,
                    value: productValue
                });

                summary[costCenter].projects[project].totalValue += productValue;
                summary[costCenter].projects[project].count++;
                summary[costCenter].totalValue += productValue;
                summary[costCenter].count++;
                totalProducts++;
                totalValue += productValue;
            });

            return {
                summary,
                totals: { count: totalProducts, value: totalValue }
            };
        }

        function getDimensionName(dimensionValue, dimensionType) {
            if (!dimensionValue || dimensionValue === 'Unassigned') return 'Unassigned';

            if (dimensionalData && dimensionalData[dimensionType]) {
                const dimension = dimensionalData[dimensionType].find(d => d.id === dimensionValue);
                if (dimension) {
                    return `${dimension.code} - ${dimension.name}`;
                }
            }

            return dimensionValue.substring(0, 8) + '...';
        }

        function displayProductReportResults(reportData, title, categoryFilter) {
            const resultsDiv = document.getElementById('productReportResults');

            let html = `
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">${title}</h6>
                        ${categoryFilter ? `<small class="text-muted">Category: ${categoryFilter}</small>` : '<small class="text-muted">All Categories</small>'}
                    </div>
                    <div class="card-body">
            `;

            if (title.includes('Value by Dimensions')) {
                // Special handling for value analysis report
                html += '<div class="table-responsive">';
                Object.entries(reportData.summary).forEach(([costCenterKey, costCenterData]) => {
                    html += `
                        <h6 class="mt-3">${costCenterData.name}</h6>
                        <table class="table table-sm table-striped">
                            <thead>
                                <tr>
                                    <th>Project</th>
                                    <th class="text-end">Product Count</th>
                                    <th class="text-end">Total Value</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;

                    Object.entries(costCenterData.projects).forEach(([projectKey, projectData]) => {
                        html += `
                            <tr>
                                <td>${projectData.name}</td>
                                <td class="text-end">${projectData.count}</td>
                                <td class="text-end">${formatCurrency(projectData.totalValue)}</td>
                            </tr>
                        `;
                    });

                    html += `
                            <tr class="table-light">
                                <td><strong>Cost Center Total</strong></td>
                                <td class="text-end"><strong>${costCenterData.count}</strong></td>
                                <td class="text-end"><strong>${formatCurrency(costCenterData.totalValue)}</strong></td>
                            </tr>
                        </tbody>
                    </table>
                    `;
                });
                html += '</div>';
            } else {
                // Standard dimensional report
                html += `
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Dimension</th>
                                    <th class="text-end">Product Count</th>
                                    <th class="text-end">Total Value</th>
                                    <th class="text-end">Percentage</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                // Sort by total value descending
                const sortedEntries = Object.entries(reportData.summary)
                    .sort(([, a], [, b]) => b.totalValue - a.totalValue);

                sortedEntries.forEach(([key, data]) => {
                    html += `
                        <tr>
                            <td>${data.name}</td>
                            <td class="text-end">${data.count}</td>
                            <td class="text-end">${formatCurrency(data.totalValue)}</td>
                            <td class="text-end">${data.percentage.toFixed(1)}%</td>
                        </tr>
                    `;
                });

                html += `
                            </tbody>
                            <tfoot class="table-light">
                                <tr>
                                    <th>Total</th>
                                    <th class="text-end">${reportData.totals.count}</th>
                                    <th class="text-end">${formatCurrency(reportData.totals.value)}</th>
                                    <th class="text-end">100.0%</th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                `;
            }

            html += `
                    </div>
                </div>
            `;

            resultsDiv.innerHTML = html;
        }

        function exportProductDimensionalReport() {
            // This function could be enhanced to export the report data to CSV/Excel
            // For now, it will show a simple download of the current report data
            alert('Export functionality would be implemented here to download the report as CSV/Excel');
        }

    </script>

    <!-- Product Image Modal -->
    <div class="modal fade product-image-modal" id="productImageModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Product Image</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="modalProductImage" src="" alt="Product Image" class="img-fluid">
                    <div class="mt-3">
                        <button type="button" class="btn btn-primary btn-sm" onclick="downloadImage()">
                            <i class="bi bi-download"></i> Download
                        </button>
                        <button type="button" class="btn btn-info btn-sm" onclick="optimizeImage()">
                            <i class="bi bi-gear"></i> Optimize
                        </button>
                        <button type="button" class="btn btn-warning btn-sm" onclick="addWatermark()">
                            <i class="bi bi-water"></i> Add Watermark
                        </button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>


</body>

</html>
