<!DOCTYPE html>
<html lang="en" class="light-mode">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CNPERP - Accounting Codes</title>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

    <style>
        :root {
            --primary-color: #0d6efd;
            --success-color: #198754;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #0dcaf0;
            --dark-color: #212529;
            --light-color: #f8f9fa;
        }

        .light-mode {
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --border-color: #dee2e6;
        }

        .dark-mode {
            --bg-primary: #212529;
            --bg-secondary: #343a40;
            --text-primary: #ffffff;
            --text-secondary: #adb5bd;
            --border-color: #495057;
        }

        body {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .card {
            background-color: var(--bg-primary);
            border-color: var(--border-color);
            transition: all 0.3s ease;
        }

        .navbar {
            background: linear-gradient(135deg, var(--primary-color), #0056b3) !important;
        }

        .parent-account {
            background-color: rgba(13, 110, 253, 0.1) !important;
            border-left: 4px solid var(--primary-color) !important;
            font-weight: 600;
        }

        .sub-account {
            background-color: rgba(25, 135, 84, 0.05) !important;
            border-left: 4px solid var(--success-color) !important;
            font-size: 0.95em;
        }

        .sub-account td {
            border-top: 1px solid rgba(25, 135, 84, 0.2) !important;
        }

        .parent-account td {
            border-top: 2px solid rgba(13, 110, 253, 0.3) !important;
        }

        .hierarchy-indicator {
            color: var(--success-color);
            font-weight: bold;
        }

        .parent-balance {
            font-weight: bold;
            color: var(--primary-color);
        }

        .account-type-badge {
            font-size: 0.75rem;
        }

        .balance-positive {
            color: var(--success-color);
        }

        .balance-negative {
            color: var(--danger-color);
        }

        .modal-content {
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }

        .form-control,
        .form-select {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            border-color: var(--border-color);
        }

        .form-control:focus,
        .form-select:focus {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
        }

        #addSubAccountBtn {
            transition: all 0.3s ease;
        }

        #addSubAccountBtn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        /* Transaction Details Styles */
        .transaction-summary-cards .card {
            border: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease;
        }

        .transaction-summary-cards .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        #transactionDetailsTable {
            font-size: 0.9rem;
        }

        #transactionDetailsTable thead th {
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: var(--dark-color) !important;
            color: white;
        }

        .transaction-filters {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 0.375rem;
        }

        .form-label-sm {
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .tab-content {
            min-height: 400px;
        }

        .nav-tabs .nav-link {
            color: var(--text-secondary);
            border-color: transparent;
        }

        .nav-tabs .nav-link.active {
            color: var(--primary-color);
            background-color: var(--bg-primary);
            border-color: var(--border-color) var(--border-color) var(--bg-primary);
        }

        .nav-tabs .nav-link:hover {
            color: var(--primary-color);
            border-color: var(--border-color) var(--border-color) transparent;
        }

        #subAccountsSummary .card {
            border: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
            background-color: var(--bg-secondary);
        }

        #subAccountsSummary .card h6 {
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-secondary);
        }

        #subAccountsSummary .card .display-6 {
            font-weight: 600;
            color: var(--primary-color);
        }

        #subAccountsSummary .card small {
            color: var(--text-secondary);
        }

        #viewAccountModal .nav-tabs,
        #viewTransactionsModal .nav-tabs,
        #editAccountModal .nav-tabs,
        #editSubAccountModal .nav-tabs {
            --bs-nav-link-color: #6f42c1;
            --bs-nav-link-hover-color: #5a189a;
            --bs-nav-tabs-link-active-color: #5a189a;
        }

        .modal .nav-tabs .nav-link {
            color: var(--bs-nav-link-color) !important;
        }

        .modal .nav-tabs .nav-link:hover,
        .modal .nav-tabs .nav-link:focus {
            color: var(--bs-nav-link-hover-color) !important;
        }

        .modal .nav-tabs .nav-link.active {
            color: var(--bs-nav-tabs-link-active-color) !important;
            border-color: var(--border-color) var(--border-color) var(--bg-primary);
        }

        /* Print Options Styles */
        .print-option-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .print-option-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .print-option-card .card-body {
            padding: 1.5rem;
        }

        @media print {
            .print-header {
                text-align: center;
                margin-bottom: 2rem;
                border-bottom: 2px solid #000;
                padding-bottom: 1rem;
            }

            .print-title {
                font-size: 1.5rem;
                font-weight: bold;
                margin-bottom: 0.5rem;
            }

            .print-subtitle {
                font-size: 1rem;
                color: #666;
                margin-bottom: 0.25rem;
            }

            .print-date {
                font-size: 0.9rem;
                color: #888;
            }

            .print-table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 1rem;
                font-size: 0.9rem;
            }

            .print-table th,
            .print-table td {
                border: 1px solid #ddd;
                padding: 8px;
                text-align: left;
            }

            .print-table th {
                background-color: #f8f9fa;
                font-weight: bold;
            }

            .print-table .text-end {
                text-align: right;
            }

            .print-summary {
                margin-top: 2rem;
                padding-top: 1rem;
                border-top: 2px solid #000;
            }

            .print-footer {
                position: fixed;
                bottom: 0;
                width: 100%;
                text-align: center;
                font-size: 0.8rem;
                color: #666;
                border-top: 1px solid #ddd;
                padding-top: 0.5rem;
            }
        }
    </style>
</head>

<body>
    <!-- Navigation Bar Container -->
    <div id="navbar-container"></div>
    <!-- Navbar Scripts -->
    <script src="js/navbar.js?v=20250106001"></script>

    <!-- Spacer to prevent content from being hidden under fixed navbar -->
    <div style="height: 70px;"></div>

    <!-- Main Content -->
    <div class="container-fluid mt-4">


        <!-- Main Content -->
        <div class="container-fluid">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="text-primary">
                    <i class="bi bi-calculator me-2"></i>Accounting Codes
                </h1>
                <div>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newParentAccountModal">
                        <i class="bi bi-plus-circle me-2"></i>New Parent Account
                    </button>
                    <button class="btn btn-secondary ms-2" data-bs-toggle="modal" data-bs-target="#newSubAccountModal">
                        <i class="bi bi-plus-circle me-2"></i>Add Sub-Account
                    </button>
                    <div class="btn-group ms-2">
                        <button class="btn btn-info dropdown-toggle" data-bs-toggle="dropdown">
                            <i class="bi bi-file-earmark-text me-2"></i>Financial Reports
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="javascript:void(0)" onclick="generateProfitLossReport()">
                                    <i class="bi bi-graph-up me-2"></i>Profit & Loss Statement
                                </a></li>
                            <li><a class="dropdown-item" href="javascript:void(0)"
                                    onclick="generateBalanceSheetReport()">
                                    <i class="bi bi-clipboard-data me-2"></i>Balance Sheet
                                </a></li>
                            <li><a class="dropdown-item" href="javascript:void(0)"
                                    onclick="generateGeneralLedgerReport()">
                                    <i class="bi bi-journal-text me-2"></i>General Ledger
                                </a></li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li><a class="dropdown-item" href="javascript:void(0)"
                                    onclick="showDimensionalReportModal()">
                                    <i class="bi bi-grid-3x3-gap me-2"></i>Dimensional Analysis Reports
                                </a></li>
                        </ul>
                    </div>
                    <button class="btn btn-success ms-2" data-bs-toggle="modal" data-bs-target="#printOptionsModal">
                        <i class="bi bi-printer me-2"></i>Print Reports
                    </button>
                </div>
            </div>

            <!-- Help Information -->
            <div class="alert alert-info mb-4">
                <h6><i class="bi bi-info-circle me-2"></i>Adding Sub-Accounts</h6>
                <p class="mb-2">Parent accounts (marked with <span class="badge bg-primary">Parent</span> badge) can
                    have sub-accounts. You can:</p>
                <ul class="mb-0">
                    <li>Click the "Add Sub-Account" button in the Actions column for any parent account</li>
                    <li>Use the "Add Sub-Account" button at the top to create a new sub-account</li>
                    <li>Parent accounts are automatically detected based on their configuration</li>
                </ul>
            </div>

            <!-- Summary Statistics -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title text-primary" id="total-accounts">0</h5>
                            <p class="card-text">Total Accounts</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title text-success" id="parent-accounts">0</h5>
                            <p class="card-text">Parent Accounts</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title text-info" id="sub-accounts-count">0</h5>
                            <p class="card-text">Sub Accounts</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title text-warning" id="accounts-with-subs">0</h5>
                            <p class="card-text">Accounts with Sub-Accounts</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Cost Center & Project Management -->
            <div class="card mb-4">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-0">
                                <i class="bi bi-diagram-3 me-2"></i>Default Dimensions Management
                            </h5>
                            <small class="text-muted">
                                Manage Cost Centers and Projects as default dimensions per ERPNext standards
                            </small>
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-outline-primary" onclick="manageCostCenters()">
                                <i class="bi bi-building me-2"></i>Cost Centers
                            </button>
                            <button class="btn btn-outline-info" onclick="manageProjects()">
                                <i class="bi bi-kanban me-2"></i>Projects
                            </button>
                            <button class="btn btn-outline-success" onclick="showBulkDimensionSettings()">
                                <i class="bi bi-gear me-2"></i>Bulk Settings
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h6 class="card-title text-primary">Cost Centers</h6>
                                    <h4 id="costCenterCount" class="text-primary">-</h4>
                                    <small class="text-muted">Active cost centers for expense tracking</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h6 class="card-title text-info">Projects</h6>
                                    <h4 id="projectCount" class="text-info">-</h4>
                                    <small class="text-muted">Active projects for revenue/expense tracking</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h6 class="card-title text-success">Accounts with Dimensions</h6>
                                    <h4 id="dimensionalAccountsCount" class="text-success">-</h4>
                                    <small class="text-muted">Accounts requiring dimensional data</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filters -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <label for="accountTypeFilter" class="form-label">Account Type</label>
                            <select class="form-select" id="accountTypeFilter">
                                <option value="">All Types</option>
                                <option value="Asset">Asset</option>
                                <option value="Liability">Liability</option>
                                <option value="Equity">Equity</option>
                                <option value="Revenue">Revenue</option>
                                <option value="Expense">Expense</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="categoryFilter" class="form-label">Category</label>
                            <select class="form-select" id="categoryFilter">
                                <option value="">All Categories</option>
                                <option value="Current Assets">Current Assets</option>
                                <option value="Fixed Assets">Fixed Assets</option>
                                <option value="Current Liabilities">Current Liabilities</option>
                                <option value="Long-term Liabilities">Long-term Liabilities</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="searchFilter" class="form-label">Search</label>
                            <input type="text" class="form-control" id="searchFilter" placeholder="Search accounts...">
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <button class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                                <i class="bi bi-x-circle me-2"></i>Clear Filters
                            </button>
                        </div>
                    </div>
                    <!-- Dimensional Analysis Filters -->
                    <div class="row mt-3 pt-3 border-top">
                        <div class="col-md-12">
                            <h6 class="text-muted mb-3">
                                <i class="bi bi-grid-3x3-gap me-1"></i>Dimensional Analysis Filters
                            </h6>
                        </div>
                        <div class="col-md-3">
                            <label for="dimensionFilter" class="form-label">Has Dimension Requirements</label>
                            <select class="form-select" id="dimensionFilter">
                                <option value="">All Accounts</option>
                                <option value="has-requirements">With Dimension Requirements</option>
                                <option value="no-requirements">No Dimension Requirements</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="specificDimensionFilter" class="form-label">Specific Dimension</label>
                            <select class="form-select" id="specificDimensionFilter">
                                <option value="">Any Dimension</option>
                                <!-- Will be populated dynamically -->
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="requirementTypeFilter" class="form-label">Requirement Type</label>
                            <select class="form-select" id="requirementTypeFilter">
                                <option value="">All Types</option>
                                <option value="required">Required Only</option>
                                <option value="optional">Optional Only</option>
                            </select>
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <button class="btn btn-outline-info w-100" onclick="showDimensionalSummary()">
                                <i class="bi bi-bar-chart me-2"></i>Dimensional Summary
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Print Reports Section -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-printer me-2"></i>Print Reports</h5>
                    <small class="text-muted">Generate PDF reports for accounting codes and transaction history.</small>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="d-grid">
                                <button class="btn btn-primary" onclick="printCashEquivalentsReport(this)">
                                    <i class="bi bi-file-earmark-pdf me-2"></i>Cash & Cash Equivalents Report
                                </button>
                                <small class="text-muted mt-1">Transaction history for all Cash and Cash Equivalents
                                    accounts (1110)</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="row">
                                <div class="col-6">
                                    <label for="reportStartDate" class="form-label">Start Date</label>
                                    <input type="date" class="form-control" id="reportStartDate">
                                </div>
                                <div class="col-6">
                                    <label for="reportEndDate" class="form-label">End Date</label>
                                    <input type="date" class="form-control" id="reportEndDate">
                                </div>
                            </div>
                            <small class="text-muted">Leave dates empty for all-time report</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Accounting Codes Table -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-0"><i class="bi bi-table me-2"></i>Chart of Accounts</h5>
                        <small class="text-muted">Parent accounts show aggregated balances from sub-accounts.
                            Sub-accounts are indented and show individual balances.</small>
                    </div>
                    <div>
                        <button class="btn btn-warning btn-sm me-2" onclick="testTransactionModal()"
                            title="Test Transaction Modal">
                            <i class="bi bi-bug"></i> Test Modal
                        </button>
                        <button class="btn btn-info btn-sm me-2" onclick="testDirectTransactionCall()"
                            title="Test Direct Modal">
                            <i class="bi bi-gear"></i> Direct Test
                        </button>
                        <button class="btn btn-primary btn-sm" onclick="addAccountModal()" title="Add New Account">
                            <i class="bi bi-plus-circle"></i> Add Account
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="accountingCodesTable">
                            <thead class="table-light">
                                <tr>
                                    <th>Code</th>
                                    <th>Name</th>
                                    <th>Account Type</th>
                                    <th>Category</th>
                                    <th class="text-end">Debits</th>
                                    <th class="text-end">Credits</th>
                                    <th class="text-end">Balance</th>
                                    <th class="text-end">Sub-Accounts</th>
                                    <th class="text-end">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="accountingCodesBody">
                                <!-- Accounting codes will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Print Options Modal -->
        <div class="modal fade" id="printOptionsModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="bi bi-printer me-2"></i>Print Reports
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-12">
                                <p class="text-muted mb-4">
                                    Select the type of report you'd like to print. All reports will include current data
                                    and be formatted for professional presentation.
                                </p>
                            </div>
                        </div>

                        <!-- Report Options -->
                        <div class="row g-3">
                            <!-- Chart of Accounts -->
                            <div class="col-md-6">
                                <div class="card h-100 print-option-card">
                                    <div class="card-body text-center">
                                        <i class="bi bi-diagram-3 fs-1 text-primary mb-3"></i>
                                        <h6 class="card-title">Chart of Accounts</h6>
                                        <p class="card-text small text-muted">
                                            Complete list of all accounts with codes, names, and hierarchy structure.
                                        </p>
                                        <button class="btn btn-primary btn-sm" onclick="printChartOfAccounts()">
                                            <i class="bi bi-printer me-1"></i>Print
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Account Balances Report -->
                            <div class="col-md-6">
                                <div class="card h-100 print-option-card">
                                    <div class="card-body text-center">
                                        <i class="bi bi-currency-dollar fs-1 text-success mb-3"></i>
                                        <h6 class="card-title">Account Balances</h6>
                                        <p class="card-text small text-muted">
                                            All accounts with current balances, debits, and credits totals.
                                        </p>
                                        <button class="btn btn-success btn-sm" onclick="printAccountBalances()">
                                            <i class="bi bi-printer me-1"></i>Print
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Filtered Account List -->
                            <div class="col-md-6">
                                <div class="card h-100 print-option-card">
                                    <div class="card-body text-center">
                                        <i class="bi bi-funnel fs-1 text-info mb-3"></i>
                                        <h6 class="card-title">Filtered Account List</h6>
                                        <p class="card-text small text-muted">
                                            Currently filtered/searched accounts as displayed on screen.
                                        </p>
                                        <button class="btn btn-info btn-sm" onclick="printFilteredAccounts()">
                                            <i class="bi bi-printer me-1"></i>Print
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Account Summary by Type -->
                            <div class="col-md-6">
                                <div class="card h-100 print-option-card">
                                    <div class="card-body text-center">
                                        <i class="bi bi-pie-chart fs-1 text-warning mb-3"></i>
                                        <h6 class="card-title">Summary by Type</h6>
                                        <p class="card-text small text-muted">
                                            Account summary grouped by type (Assets, Liabilities, etc.).
                                        </p>
                                        <button class="btn btn-warning btn-sm" onclick="printAccountSummaryByType()">
                                            <i class="bi bi-printer me-1"></i>Print
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Print Options -->
                        <div class="row mt-4">
                            <div class="col-md-12">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0"><i class="bi bi-gear me-2"></i>Print Options</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row g-3">
                                            <div class="col-md-4">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="includeTotals"
                                                        checked>
                                                    <label class="form-check-label" for="includeTotals">
                                                        Include totals and summaries
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="includeDate"
                                                        checked>
                                                    <label class="form-check-label" for="includeDate">
                                                        Include report date/time
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox"
                                                        id="includeCompanyInfo" checked>
                                                    <label class="form-check-label" for="includeCompanyInfo">
                                                        Include company information
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="bi bi-x-circle me-1"></i>Close
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- New Parent Account Modal -->
        <div class="modal fade" id="newParentAccountModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">New Parent Account</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="newParentAccountForm">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="accountCode" class="form-label">Account Code *</label>
                                        <input type="text" class="form-control" id="accountCode" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="accountName" class="form-label">Account Name *</label>
                                        <input type="text" class="form-control" id="accountName" required>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="accountType" class="form-label">Account Type *</label>
                                        <select class="form-select" id="accountType" required>
                                            <option value="">Select Account Type</option>
                                            <option value="Asset">Asset</option>
                                            <option value="Liability">Liability</option>
                                            <option value="Equity">Equity</option>
                                            <option value="Revenue">Revenue</option>
                                            <option value="Expense">Expense</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="accountCategory" class="form-label">Category</label>
                                        <select class="form-select" id="accountCategory">
                                            <option value="">Select Category</option>
                                            <option value="Current Assets">Current Assets</option>
                                            <option value="Fixed Assets">Fixed Assets</option>
                                            <option value="Current Liabilities">Current Liabilities</option>
                                            <option value="Long-term Liabilities">Long-term Liabilities</option>
                                            <option value="Owner's Equity">Owner's Equity</option>
                                            <option value="Operating Revenue">Operating Revenue</option>
                                            <option value="Operating Expenses">Operating Expenses</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Currency</label>
                                        <input type="text" class="form-control" value="BWP (Botswana Pula)" readonly>
                                        <small class="form-text text-muted">Currency is automatically set from
                                            application settings</small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Reporting Tag</label>
                                        <input type="text" class="form-control" value="Auto-generated" readonly>
                                        <small class="form-text text-muted">Reporting tag is automatically generated
                                            based on account type and category</small>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="isParent" checked>
                                    <label class="form-check-label" for="isParent">
                                        This is a parent account (can have sub-accounts)
                                    </label>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="saveParentAccount()">Save
                            Account</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- New Sub Account Modal -->
        <div class="modal fade" id="newSubAccountModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">New Sub-Account</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="newSubAccountForm">
                            <div class="mb-3">
                                <label for="parentAccount" class="form-label">Parent Account *</label>
                                <select class="form-select" id="parentAccount" required>
                                    <option value="">Select Parent Account</option>
                                    <!-- Parent accounts will be loaded here -->
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="subAccountCode" class="form-label">Sub-Account Code *</label>
                                <input type="text" class="form-control" id="subAccountCode" required>
                            </div>
                            <div class="mb-3">
                                <label for="subAccountName" class="form-label">Sub-Account Name *</label>
                                <input type="text" class="form-control" id="subAccountName" required>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="subAccountType" class="form-label">Account Type *</label>
                                        <select class="form-select" id="subAccountType" required>
                                            <option value="">Select Account Type</option>
                                            <option value="Asset">Asset</option>
                                            <option value="Liability">Liability</option>
                                            <option value="Equity">Equity</option>
                                            <option value="Revenue">Revenue</option>
                                            <option value="Expense">Expense</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="subAccountCategory" class="form-label">Category</label>
                                        <select class="form-select" id="subAccountCategory">
                                            <option value="">Select Category</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Currency</label>
                                <input type="text" class="form-control" value="BWP (Botswana Pula)" readonly>
                                <small class="form-text text-muted">Currency is automatically set from application
                                    settings</small>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="saveSubAccount()">Save
                            Sub-Account</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- View Account Modal -->
        <div class="modal fade" id="viewAccountModal" tabindex="-1">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Account Details</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <!-- Navigation Tabs -->
                        <ul class="nav nav-tabs" id="accountDetailsTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="account-info-tab" data-bs-toggle="tab"
                                    data-bs-target="#account-info" type="button" role="tab">
                                    <i class="bi bi-info-circle me-1"></i>Account Information
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="transaction-details-tab" data-bs-toggle="tab"
                                    data-bs-target="#transaction-details" type="button" role="tab">
                                    <i class="bi bi-list-ul me-1"></i>Transaction Details
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="sub-accounts-tab" data-bs-toggle="tab"
                                    data-bs-target="#sub-accounts" type="button" role="tab">
                                    <i class="bi bi-diagram-3 me-1"></i>Sub-Accounts
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="dimensions-tab" data-bs-toggle="tab"
                                    data-bs-target="#dimensions" type="button" role="tab">
                                    <i class="bi bi-grid-3x3-gap me-1"></i>Dimensions
                                </button>
                            </li>
                        </ul>

                        <!-- Tab Content -->
                        <div class="tab-content mt-3" id="accountDetailsTabContent">
                            <!-- Account Information Tab -->
                            <div class="tab-pane fade show active" id="account-info" role="tabpanel">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Account Code</label>
                                            <p id="viewAccountCode" class="form-control-plaintext"></p>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Account Name</label>
                                            <p id="viewAccountName" class="form-control-plaintext"></p>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Account Type</label>
                                            <p id="viewAccountType" class="form-control-plaintext"></p>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Category</label>
                                            <p id="viewAccountCategory" class="form-control-plaintext"></p>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Currency</label>
                                            <p id="viewAccountCurrency" class="form-control-plaintext"></p>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Reporting Tag</label>
                                            <p id="viewAccountReportingTag" class="form-control-plaintext"></p>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label class="form-label fw-bold text-danger">Total Debits</label>
                                            <p id="viewAccountDebits" class="form-control-plaintext text-danger"></p>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label class="form-label fw-bold text-success">Total Credits</label>
                                            <p id="viewAccountCredits" class="form-control-plaintext text-success"></p>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Current Balance</label>
                                            <p id="viewAccountBalance" class="form-control-plaintext"></p>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Parent Account</label>
                                            <p id="viewAccountParent" class="form-control-plaintext"></p>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Account Type</label>
                                            <p id="viewAccountIsParent" class="form-control-plaintext"></p>
                                        </div>
                                    </div>
                                </div>

                            </div>

                            <!-- Transaction Details Tab -->
                            <div class="tab-pane fade" id="transaction-details" role="tabpanel">
                                <div class="row mb-3">
                                    <div class="col-md-12">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <h6 class="mb-0">Transaction History</h6>
                                            <div class="btn-group">
                                                <button type="button" class="btn btn-sm btn-outline-primary"
                                                    onclick="refreshTransactionDetails()">
                                                    <i class="bi bi-arrow-clockwise me-1"></i>Refresh
                                                </button>
                                                <button type="button" class="btn btn-sm btn-outline-success"
                                                    onclick="exportTransactionDetails()">
                                                    <i class="bi bi-download me-1"></i>Export
                                                </button>
                                                <button type="button" class="btn btn-sm btn-outline-info"
                                                    onclick="printTransactionDetails()">
                                                    <i class="bi bi-printer me-1"></i>Print
                                                </button>
                                            </div>
                                        </div>

                                        <!-- Transaction Filters -->
                                        <div class="card mb-3">
                                            <div class="card-body py-2">
                                                <div class="row g-2">
                                                    <div class="col-md-3">
                                                        <label class="form-label form-label-sm">From Date</label>
                                                        <input type="date" class="form-control form-control-sm"
                                                            id="transactionFromDate">
                                                    </div>
                                                    <div class="col-md-3">
                                                        <label class="form-label form-label-sm">To Date</label>
                                                        <input type="date" class="form-control form-control-sm"
                                                            id="transactionToDate">
                                                    </div>
                                                    <div class="col-md-3">
                                                        <label class="form-label form-label-sm">Transaction Type</label>
                                                        <select class="form-select form-select-sm"
                                                            id="transactionTypeFilter">
                                                            <option value="">All Transactions</option>
                                                            <option value="debit">Debits Only</option>
                                                            <option value="credit">Credits Only</option>
                                                        </select>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <label class="form-label form-label-sm">Amount Range</label>
                                                        <div class="input-group">
                                                            <input type="number" class="form-control form-control-sm"
                                                                id="minAmount" placeholder="Min" step="0.01">
                                                            <input type="number" class="form-control form-control-sm"
                                                                id="maxAmount" placeholder="Max" step="0.01">
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="row mt-2">
                                                    <div class="col-md-12">
                                                        <button type="button" class="btn btn-sm btn-primary"
                                                            onclick="applyTransactionFilters()">
                                                            <i class="bi bi-funnel me-1"></i>Apply Filters
                                                        </button>
                                                        <button type="button" class="btn btn-sm btn-secondary ms-2"
                                                            onclick="clearTransactionFilters()">
                                                            <i class="bi bi-x-circle me-1"></i>Clear
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Transaction Summary Cards -->
                                        <div class="row mb-3 transaction-summary-cards">
                                            <div class="col-md-4">
                                                <div class="card text-center">
                                                    <div class="card-body py-2">
                                                        <h6 class="card-title text-danger mb-1">Total Debits</h6>
                                                        <h5 class="text-danger mb-0" id="transactionTotalDebits">P 0.00
                                                        </h5>
                                                        <small class="text-muted" id="transactionDebitCount">0
                                                            transactions</small>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="card text-center">
                                                    <div class="card-body py-2">
                                                        <h6 class="card-title text-success mb-1">Total Credits</h6>
                                                        <h5 class="text-success mb-0" id="transactionTotalCredits">P
                                                            0.00</h5>
                                                        <small class="text-muted" id="transactionCreditCount">0
                                                            transactions</small>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="card text-center">
                                                    <div class="card-body py-2">
                                                        <h6 class="card-title mb-1">Net Balance</h6>
                                                        <h5 class="mb-0" id="transactionNetBalance">P 0.00</h5>
                                                        <small class="text-muted" id="transactionTotalCount">0 total
                                                            transactions</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Transaction Details Table -->
                                        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                            <table class="table table-sm table-hover table-striped"
                                                id="transactionDetailsTable">
                                                <thead class="table-dark sticky-top">
                                                    <tr>
                                                        <th>Date</th>
                                                        <th>Reference</th>
                                                        <th>Description</th>
                                                        <th class="text-end">Debit</th>
                                                        <th class="text-end">Credit</th>
                                                        <th class="text-end">Balance</th>
                                                        <th>Source</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="transactionDetailsList">
                                                    <tr>
                                                        <td colspan="7" class="text-center text-muted py-4">
                                                            <i class="bi bi-hourglass-split fs-1 d-block mb-2"></i>
                                                            Loading transaction details...
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Sub-Accounts Tab -->
                            <div class="tab-pane fade" id="sub-accounts" role="tabpanel">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 class="mb-0">Sub-Accounts</h6>
                                    <button type="button" class="btn btn-sm btn-primary" id="addSubAccountBtn"
                                        style="display: none;" data-bs-toggle="tooltip" data-bs-placement="top"
                                        title="Add a new sub-account to this parent account">
                                        <i class="bi bi-plus-circle me-1"></i> Add Sub-Account
                                    </button>
                                </div>
                                <div id="subAccountsContainer">
                                    <div class="alert alert-danger d-none" id="subAccountsErrorAlert"></div>
                                    <div class="row g-3 mb-3" id="subAccountsSummary" style="display: none;">
                                        <div class="col-md-3 col-sm-6">
                                            <div class="card h-100">
                                                <div class="card-body">
                                                    <h6 class="text-uppercase mb-1">Sub-Accounts</h6>
                                                    <div class="display-6" id="subAccountsSummaryCount">0</div>
                                                    <small>Total linked to this parent</small>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3 col-sm-6">
                                            <div class="card h-100">
                                                <div class="card-body">
                                                    <h6 class="text-uppercase mb-1">Total Debits</h6>
                                                    <div class="display-6 text-danger" id="subAccountsSummaryDebits">
                                                        0.00</div>
                                                    <small>Aggregated debit activity</small>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3 col-sm-6">
                                            <div class="card h-100">
                                                <div class="card-body">
                                                    <h6 class="text-uppercase mb-1">Total Credits</h6>
                                                    <div class="display-6 text-success" id="subAccountsSummaryCredits">
                                                        0.00</div>
                                                    <small>Aggregated credit activity</small>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3 col-sm-6">
                                            <div class="card h-100">
                                                <div class="card-body">
                                                    <h6 class="text-uppercase mb-1">Net Balance</h6>
                                                    <div class="display-6" id="subAccountsSummaryBalance">0.00</div>
                                                    <small>Debits minus credits</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="text-center text-muted py-3" id="noSubAccountsMessage">
                                        No sub-accounts found. Click 'Add Sub-Account' to create one.
                                    </div>
                                    <div class="table-responsive">
                                        <table class="table table-sm table-hover align-middle" id="subAccountsTable"
                                            style="display: none;">
                                            <thead>
                                                <tr>
                                                    <th style="width: 120px;">Code</th>
                                                    <th>Name &amp; Type</th>
                                                    <th class="text-end" style="width: 140px;">Debits</th>
                                                    <th class="text-end" style="width: 140px;">Credits</th>
                                                    <th class="text-end" style="width: 140px;">Balance</th>
                                                    <th style="width: 150px;">Reporting Tag</th>
                                                    <th style="width: 150px;">Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="subAccountsList">
                                                <!-- Sub-accounts will be loaded here -->
                                            </tbody>
                                            <tfoot id="subAccountsTotal" style="display: none;">
                                                <tr class="table-active">
                                                    <td></td>
                                                    <td class="text-end fw-bold">Totals:</td>
                                                    <td class="text-end fw-bold" id="subAccountsTotalDebits">0.00</td>
                                                    <td class="text-end fw-bold" id="subAccountsTotalCredits">0.00</td>
                                                    <td class="text-end fw-bold" id="subAccountsTotalBalance">0.00</td>
                                                    <td colspan="2"></td>
                                                </tr>
                                            </tfoot>
                                        </table>
                                    </div>
                                    <div class="row g-3 mt-2" id="subAccountsFallbackList" style="display: none;"></div>
                                </div>
                            </div>

                            <!-- Dimensions Tab -->
                            <div class="tab-pane fade" id="dimensions" role="tabpanel">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 class="mb-0">Dimension Requirements</h6>
                                    <button type="button" class="btn btn-sm btn-primary" id="addDimensionRequirementBtn"
                                        data-bs-toggle="tooltip" data-bs-placement="top"
                                        title="Add a dimension requirement for this account">
                                        <i class="bi bi-plus-circle me-1"></i> Add Dimension Requirement
                                    </button>
                                </div>

                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle me-2"></i>
                                    Configure which dimensions are required or optional when posting transactions to
                                    this account.
                                    Required dimensions must be assigned to all journal entries using this account.
                                </div>

                                <div id="dimensionRequirementsContainer">
                                    <div class="alert alert-danger d-none" id="dimensionRequirementsErrorAlert"></div>

                                    <!-- Dimension Requirements List -->
                                    <div id="dimensionRequirementsList">
                                        <div class="text-center text-muted py-4" id="noDimensionRequirementsMessage">
                                            <i class="bi bi-grid-3x3-gap fs-1 d-block mb-2"></i>
                                            No dimension requirements configured for this account.
                                            <br>Click 'Add Dimension Requirement' to set up dimensional accounting.
                                        </div>
                                    </div>

                                    <!-- Dimension Balance Breakdown -->
                                    <div class="mt-4" id="dimensionBalancesSection" style="display: none;">
                                        <h6 class="border-bottom pb-2">Balance by Dimensions</h6>
                                        <div id="dimensionBalancesContainer">
                                            <div class="text-center text-muted py-3">
                                                <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                                Loading dimension balances...
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" onclick="editCurrentAccount()">Edit
                            Account</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- View Transactions Modal -->
        <div class="modal fade" id="viewTransactionsModal" tabindex="-1">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="bi bi-list-ul me-2"></i>Transaction History -
                            <span id="transactionAccountName"></span>
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h6 class="card-title text-primary">Current Balance</h6>
                                        <h5 id="modalTransactionCurrentBalance" class="card-text">-</h5>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h6 class="card-title text-danger">Total Debits</h6>
                                        <h5 id="modalTransactionTotalDebits" class="card-text">-</h5>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h6 class="card-title text-success">Total Credits</h6>
                                        <h5 id="modalTransactionTotalCredits" class="card-text">-</h5>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h6 class="card-title text-info">Total Transactions</h6>
                                        <h5 id="modalTransactionCount" class="card-text">-</h5>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="transactionsLoading" class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading transactions...</span>
                            </div>
                            <p class="mt-2">Loading transaction history...</p>
                        </div>

                        <div id="transactionsContent" style="display: none;">
                            <div class="table-responsive">
                                <table class="table table-hover table-sm">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Date</th>
                                            <th>Description</th>
                                            <th>Reference</th>
                                            <th class="text-end">Debit</th>
                                            <th class="text-end">Credit</th>
                                            <th class="text-end">Running Balance</th>
                                        </tr>
                                    </thead>
                                    <tbody id="transactionsTableBody">
                                    </tbody>
                                </table>
                            </div>

                            <div id="noTransactionsMessage" class="text-center text-muted py-4" style="display: none;">
                                <i class="bi bi-inbox display-4"></i>
                                <p class="mt-2">No transactions found for this account.</p>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Edit Account Modal -->
        <div class="modal fade" id="editAccountModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Edit Account</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="editAccountForm">
                            <input type="hidden" id="editAccountId">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="editAccountCode" class="form-label">Account Code *</label>
                                        <input type="text" class="form-control" id="editAccountCode" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="editAccountName" class="form-label">Account Name *</label>
                                        <input type="text" class="form-control" id="editAccountName" required>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="editAccountType" class="form-label">Account Type *</label>
                                        <select class="form-select" id="editAccountType" required>
                                            <option value="">Select Account Type</option>
                                            <option value="Asset">Asset</option>
                                            <option value="Liability">Liability</option>
                                            <option value="Equity">Equity</option>
                                            <option value="Revenue">Revenue</option>
                                            <option value="Expense">Expense</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="editAccountCategory" class="form-label">Category</label>
                                        <input type="text" class="form-control" id="editAccountCategory">
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Currency</label>
                                        <input type="text" class="form-control" value="BWP (Botswana Pula)" readonly>
                                        <small class="form-text text-muted">Currency is automatically set from
                                            application settings</small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Reporting Tag</label>
                                        <input type="text" class="form-control" value="Auto-generated" readonly>
                                        <small class="form-text text-muted">Reporting tag is automatically generated
                                            based on account type and category</small>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="editAccountIsParent">
                                    <label class="form-check-label" for="editAccountIsParent">
                                        This is a parent account (can have sub-accounts)
                                    </label>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="saveEditedAccount()">Save
                            Changes</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Delete Account Confirmation Modal -->
        <div class="modal fade" id="deleteAccountModal" tabindex="-1" data-account-id="" data-has-children="false">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title text-danger">
                            <i class="bi bi-exclamation-triangle me-2"></i>Confirm Delete
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p>Are you sure you want to delete the account <strong id="deleteAccountName"></strong>?</p>
                        <div id="deleteDescendantsInfo" class="mb-3" style="display:none;">
                            <div class="alert alert-warning mb-2">
                                <i class="bi bi-diagram-3-fill me-2"></i>
                                <span id="descendantCountText"></span>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="confirmCascadeCheckbox">
                                <label class="form-check-label" for="confirmCascadeCheckbox">
                                    Also delete all descendant sub-accounts (cascade)
                                </label>
                            </div>
                            <small class="text-muted d-block mt-1">You must check this box to proceed when sub-accounts
                                exist.</small>
                        </div>
                        <div class="alert alert-danger d-flex align-items-start" id="deleteFinalWarning"
                            style="display:none;">
                            <i class="bi bi-exclamation-octagon me-2 mt-1"></i>
                            <div>
                                <strong>Irreversible:</strong> This deletion cannot be undone.
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-danger" id="deleteAccountBtn" disabled
                            onclick="confirmDeleteAccount()">
                            <i class="bi bi-trash me-2"></i><span id="deleteBtnLabel">Delete Account</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Edit Sub Account Modal -->
        <div class="modal fade" id="editSubAccountModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Edit Sub-Account</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="editSubAccountForm">
                            <input type="hidden" id="editSubAccountId">
                            <div class="mb-3">
                                <label for="editSubParentAccount" class="form-label">Parent Account *</label>
                                <select class="form-select" id="editSubParentAccount" required>
                                    <option value="">Select Parent Account</option>
                                    <!-- Parent accounts will be loaded here -->
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="editSubAccountCode" class="form-label">Sub-Account Code *</label>
                                <input type="text" class="form-control" id="editSubAccountCode" required>
                            </div>
                            <div class="mb-3">
                                <label for="editSubAccountName" class="form-label">Sub-Account Name *</label>
                                <input type="text" class="form-control" id="editSubAccountName" required>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="editSubAccountType" class="form-label">Account Type *</label>
                                        <select class="form-select" id="editSubAccountType" required>
                                            <option value="">Select Account Type</option>
                                            <option value="Asset">Asset</option>
                                            <option value="Liability">Liability</option>
                                            <option value="Equity">Equity</option>
                                            <option value="Revenue">Revenue</option>
                                            <option value="Expense">Expense</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="editSubAccountCategory" class="form-label">Category</label>
                                        <select class="form-select" id="editSubAccountCategory">
                                            <option value="">Select Category</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Currency</label>
                                <input type="text" class="form-control" value="BWP (Botswana Pula)" readonly>
                                <small class="form-text text-muted">Currency is automatically set from application
                                    settings</small>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="saveEditedSubAccount()">Save
                            Changes</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dimension Requirement Modal -->
        <div class="modal fade" id="dimensionRequirementModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="bi bi-grid-3x3-gap me-2"></i>
                            <span id="dimensionRequirementModalTitle">Add Dimension Requirement</span>
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="dimensionRequirementForm">
                            <input type="hidden" id="requirementAccountId" />
                            <input type="hidden" id="requirementId" />

                            <!-- Dimension Selection -->
                            <div class="mb-4">
                                <label for="dimensionSelect" class="form-label fw-bold">
                                    <i class="bi bi-grid-3x3-gap me-1"></i>Dimension *
                                </label>
                                <select class="form-select" id="dimensionSelect" required>
                                    <option value="">Select a dimension...</option>
                                </select>
                                <div class="form-text">Choose which dimension to configure for this account</div>
                            </div>

                            <!-- Requirement Type -->
                            <div class="mb-4">
                                <label class="form-label fw-bold">
                                    <i class="bi bi-shield-check me-1"></i>Requirement Type *
                                </label>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-check form-check-lg">
                                            <input class="form-check-input" type="radio" name="requirementType"
                                                id="requirementRequired" value="true" checked>
                                            <label class="form-check-label fw-bold text-danger"
                                                for="requirementRequired">
                                                <i class="bi bi-exclamation-triangle me-1"></i>Required
                                                <small class="d-block text-muted fw-normal">
                                                    Dimension must be specified for all transactions
                                                </small>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check form-check-lg">
                                            <input class="form-check-input" type="radio" name="requirementType"
                                                id="requirementOptional" value="false">
                                            <label class="form-check-label fw-bold text-secondary"
                                                for="requirementOptional">
                                                <i class="bi bi-circle me-1"></i>Optional
                                                <small class="d-block text-muted fw-normal">
                                                    Dimension can be specified but is not mandatory
                                                </small>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Account Type-Based Requirements -->
                            <div class="mb-4">
                                <label class="form-label fw-bold">
                                    <i class="bi bi-diagram-3 me-1"></i>Account Type Requirements
                                </label>
                                <div class="alert alert-info">
                                    <h6><i class="bi bi-info-circle me-2"></i>Automatic Requirements for Account Types
                                    </h6>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="mandatoryForPL">
                                                <label class="form-check-label" for="mandatoryForPL">
                                                    <strong>Mandatory for Profit & Loss Accounts</strong>
                                                    <small class="d-block text-muted">
                                                        Automatically require this dimension for all Income and Expense
                                                        accounts
                                                    </small>
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="mandatoryForBS">
                                                <label class="form-check-label" for="mandatoryForBS">
                                                    <strong>Mandatory for Balance Sheet Accounts</strong>
                                                    <small class="d-block text-muted">
                                                        Automatically require this dimension for all Asset, Liability,
                                                        and Equity accounts
                                                    </small>
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Default Value Selection -->
                            <div class="mb-4">
                                <label for="defaultValueSelect" class="form-label fw-bold">
                                    <i class="bi bi-bookmark me-1"></i>Default Value
                                </label>
                                <select class="form-select" id="defaultValueSelect">
                                    <option value="">No default value</option>
                                </select>
                                <div class="form-text">
                                    Optional: Set a default dimension value that will be pre-selected in transactions
                                </div>
                            </div>

                            <!-- Priority -->
                            <div class="mb-4">
                                <label for="priorityInput" class="form-label fw-bold">
                                    <i class="bi bi-sort-numeric-down me-1"></i>Priority
                                </label>
                                <input type="number" class="form-control" id="priorityInput" value="1" min="1" max="100"
                                    step="1">
                                <div class="form-text">
                                    Display order in forms (1 = highest priority, 100 = lowest)
                                </div>
                            </div>

                            <!-- Description -->
                            <div class="mb-3">
                                <label for="descriptionInput" class="form-label fw-bold">
                                    <i class="bi bi-chat-text me-1"></i>Description
                                </label>
                                <textarea class="form-control" id="descriptionInput" rows="3"
                                    placeholder="Optional description or notes about this requirement..."></textarea>
                            </div>

                            <!-- Preview Section -->
                            <div class="border rounded p-3 bg-light">
                                <h6 class="mb-2">
                                    <i class="bi bi-eye me-1"></i>Preview
                                </h6>
                                <div id="requirementPreview" class="text-muted">
                                    Select a dimension to see the preview
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" id="saveDimensionRequirement">
                            <i class="bi bi-check-circle me-1"></i>
                            <span id="saveButtonText">Create Requirement</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bootstrap JS -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
        <!-- API Configuration -->
        <script src="js/api-config.js"></script>
        <!-- Auth Bootstrap (load first) -->
        <script src="js/auth-bootstrap.js"></script>


        <script src="/static/js/auth.js"></script>
    <!-- Page Access Guard - Restrict POS users to POS page only -->
    <script src="/static/js/page-guard.js"></script>

        <script src="js/auth-fetch.js"></script>

        <script src="js/branch-switcher.js"></script>
        <script>document.addEventListener('DOMContentLoaded', () => { if (window.auth) { auth.requireAuth(); } });</script>
        <!-- Currency and Settings -->
        <script src="js/settings-loader.js"></script>
        <script src="js/currency-utils.js"></script>
        <!-- Modern Interactions -->
        <script src="js/modern-interactions.js"></script>

        <script>
            // Accounting codes are now fetched from the API

            function notify(message, type = 'info') {
                if (typeof showAlert === 'function') {
                    showAlert(message, type);
                } else {
                    window.alert(message);
                }
            }

            function loadAccountingCodes() {
                const tbody = document.getElementById('accountingCodesBody');
                tbody.innerHTML = '';

                // Fetch accounting codes from API
                fetch(API_CONFIG.ENDPOINTS.ACCOUNTING_CODES)
                    .then(response => {
                        if (!response.ok) {
                            let errorMessage = 'Failed to fetch accounting codes';
                            return response.json().catch(() => {
                                // If response is not JSON (e.g., HTML error page), get text content
                                return response.text().then(text => {
                                    console.error('Server returned non-JSON error:', text);
                                    throw new Error(`Server error (${response.status}): ${response.statusText}`);
                                });
                            }).then(errorData => {
                                throw new Error(errorData.detail || errorMessage);
                            });
                        }
                        return response.json();
                    })
                    .then(async accounts => {
                        // Show loading message
                        const tbody = document.getElementById('accountingCodesBody');
                        tbody.innerHTML = '<tr><td colspan="8" class="text-center text-info"><div class="spinner-border spinner-border-sm me-2" role="status"></div>Preparing accounting codes...</td></tr>';

                        if (!Array.isArray(accounts)) {
                            throw new Error('Unexpected response format while loading accounting codes');
                        }

                        console.log('Loaded', accounts.length, 'accounts from API');

                        // Calculate account-specific balances from transaction data when missing
                        const accountsWithCalculatedBalances = await calculateAccountSpecificBalances(accounts);

                        // Calculate parent account balances as aggregates of sub-accounts
                        const accountsWithParentBalances = calculateParentAccountBalances(accountsWithCalculatedBalances);

                        // Store all accounts in global variable for filtering and exports
                        const currencySettings = typeof getCurrentCurrencySettings === 'function' ? getCurrentCurrencySettings() : null;
                        const derivedChildrenMap = new Map();
                        accountsWithParentBalances.forEach(account => {
                            if (!('parent_id' in account) && account.parent) {
                                account.parent_id = account.parent.id;
                            }
                            if (!account.currency) {
                                account.currency = currencySettings?.code || 'BWP';
                            }
                            if (account.parent_id) {
                                const list = derivedChildrenMap.get(account.parent_id) || [];
                                list.push(account);
                                derivedChildrenMap.set(account.parent_id, list);
                            }
                        });

                        accountsWithParentBalances.forEach(account => {
                            const derivedChildren = derivedChildrenMap.get(account.id);
                            if (Array.isArray(account.sub_accounts) && account.sub_accounts.length && !derivedChildren) {
                                derivedChildrenMap.set(account.id, account.sub_accounts);
                            }
                            account.sub_accounts = derivedChildrenMap.get(account.id) || account.sub_accounts || [];
                        });

                        allAccountingCodes = accountsWithParentBalances;
                        window.allAccountingCodes = accountsWithParentBalances;
                        window.accountingCodes = accountsWithParentBalances;
                        window.currentAccountData = accountsWithParentBalances;

                        accountingCodesById.clear();
                        accountsWithParentBalances.forEach(account => {
                            accountingCodesById.set(account.id, account);
                        });
                        window.accountingCodesById = accountingCodesById;

                        console.log(' Accounting codes prepared for display:', accountingCodesById.size);

                        // Show success notification via modern UI when available
                        if (window.modernUI) {
                            window.modernUI.showNotification('Accounting codes loaded successfully', 'success');
                        } else {
                            console.info('Accounting codes loaded successfully');
                        }

                        // Load dimension requirements for filtering (non-blocking)
                        loadAllAccountDimensionRequirements().then(() => {
                            console.log(' Dimension requirements loaded for filtering');
                            populateSpecificDimensionFilter();
                        }).catch(error => {
                            console.warn('Could not load dimension requirements for filtering:', error);
                        });

                        // Apply current filters or show all accounts
                        filterAccountingCodes();
                        loadParentAccounts();
                        loadParentAccountsForEditSub();
                    })
                    .catch(error => {
                        console.error('Error loading accounting codes:', error);
                        tbody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">Error loading accounting codes</td></tr>';
                        notify('Error loading accounting codes: ' + error.message, 'danger');
                    });
            }

            function getAccountTypeColor(type) {
                switch (type) {
                    case 'Asset': return 'success';
                    case 'Liability': return 'danger';
                    case 'Equity': return 'warning';
                    case 'Revenue': return 'info';
                    case 'Expense': return 'secondary';
                    default: return 'secondary';
                }
            }

            function updateStatistics() {
                // Use the global filtered data for statistics
                const accounts = allAccountingCodes || [];
                const totalAccounts = accounts.length;
                const parentAccounts = accounts.filter(acc => acc.is_parent || !acc.parent_id).length;
                const subAccounts = accounts.filter(acc => acc.parent_id && !acc.is_parent).length;
                const accountsWithSubs = accounts.filter(acc => {
                    const hasChildren = accounts.some(sub => sub.parent_id === acc.id);
                    return (acc.is_parent || !acc.parent_id) && hasChildren;
                }).length;

                // Calculate total balances
                let totalBalance = 0;
                let totalDebits = 0;
                let totalCredits = 0;

                accounts.forEach(account => {
                    totalDebits += account.total_debits || 0;
                    totalCredits += account.total_credits || 0;
                    totalBalance += account.balance || 0;
                });

                document.getElementById('total-accounts').textContent = totalAccounts;
                document.getElementById('parent-accounts').textContent = parentAccounts;
                document.getElementById('sub-accounts-count').textContent = subAccounts;
                document.getElementById('accounts-with-subs').textContent = accountsWithSubs;
            }

            // Global state for accounting codes and currently viewed account context
            let allAccountingCodes = [];
            let accountingCodesById = new Map();
            let currentViewedAccountId = null;
            let currentViewedAccountData = null;
            let currentSubAccounts = [];
            let reopenViewAccountModalAfterSubSave = false;

            // Function to edit the currently viewed account
            // Intelligently routes to either editAccount or editSubAccount based on account type
            function editCurrentAccount() {
                if (!currentViewedAccountId || !currentViewedAccountData) {
                    notify('No account is currently being viewed', 'warning');
                    return;
                }

                // Check if this is a sub-account (has a parent)
                if (currentViewedAccountData.parent_id || currentViewedAccountData.parent) {
                    // This is a sub-account, use the sub-account editor
                    editSubAccount(currentViewedAccountId);
                } else {
                    // This is a parent or standalone account, use the regular editor
                    editAccount(currentViewedAccountId);
                }
            }

            // Function to calculate account-specific balances from transaction data
            async function calculateAccountSpecificBalances(accounts) {
                if (!Array.isArray(accounts) || accounts.length === 0) {
                    return accounts || [];
                }

                const needsRefresh = accounts.filter(account => {
                    const hasTotals = typeof account.total_debits === 'number'
                        && typeof account.total_credits === 'number'
                        && typeof account.balance === 'number';
                    return !hasTotals;
                });

                if (needsRefresh.length === 0) {
                    console.log(' All accounting codes already include balance totals from API. Skipping incremental fetch.');
                    return accounts;
                }

                console.log(` Refreshing balances for ${needsRefresh.length} accounting code(s) missing totals`);

                let totalTransactionsProcessed = 0;
                let accountsWithTransactions = 0;

                try {
                    // Process each account individually using account-specific transaction endpoint
                    for (const account of needsRefresh) {
                        try {
                            console.log(` Fetching transactions for account ${account.code}...`);

                            // Use the account-specific transactions endpoint
                            const response = await fetch(API_CONFIG.buildUrl(`/accounting-codes/${account.id}/transactions`));

                            if (response.ok) {
                                const data = await response.json();

                                // Extract the account-specific balance data from the response
                                if (data && typeof data === 'object') {
                                    // Update account with calculated balances from the backend
                                    account.total_debits = data.total_debits || 0;
                                    account.total_credits = data.total_credits || 0;
                                    account.balance = data.current_balance || 0;

                                    const transactionCount = data.transactions ? data.transactions.length : 0;
                                    totalTransactionsProcessed += transactionCount;

                                    if (transactionCount > 0) {
                                        accountsWithTransactions++;
                                        console.log(`    Account ${account.code}: ${transactionCount} transactions, Balance: ${account.balance.toFixed(2)}, Debits: ${account.total_debits.toFixed(2)}, Credits: ${account.total_credits.toFixed(2)}`);
                                    } else {
                                        console.log(`    Account ${account.code}: No transactions found, Balance: ${(account.balance || 0).toFixed(2)}`);
                                    }
                                } else {
                                    console.warn(`    Invalid response format for account ${account.code}`);
                                    // Keep original balance if response is invalid
                                    console.log(`    Account ${account.code}: Keeping original balance: ${(account.balance || 0).toFixed(2)}`);
                                }
                            } else if (response.status === 404) {
                                // Account has no transactions - this is normal
                                console.log(`    Account ${account.code}: No transactions found (404), Balance: ${(account.balance || 0).toFixed(2)}`);
                            } else {
                                console.warn(`    HTTP ${response.status} for account ${account.code}`);
                                // Keep original balance on error
                                console.log(`    Account ${account.code}: Using original balance due to error: ${(account.balance || 0).toFixed(2)}`);
                            }
                        } catch (error) {
                            console.warn(`    Error fetching transactions for account ${account.code}:`, error.message);
                            // Keep original balance on error
                            console.log(`    Account ${account.code}: Using original balance due to error: ${(account.balance || 0).toFixed(2)}`);
                        }
                    }

                    console.log(` Account-specific balance calculation completed:`);
                    console.log(`    Total transactions processed: ${totalTransactionsProcessed}`);
                    console.log(`    Accounts with transactions: ${accountsWithTransactions}/${needsRefresh.length}`);
                    console.log(`    Accounts kept with provided totals: ${accounts.length - needsRefresh.length}/${accounts.length}`);

                } catch (error) {
                    console.error(' Error calculating account-specific balances:', error);
                    console.warn(' Using original balance data due to calculation error');

                    // Show error notification
                    if (window.modernUI) {
                        window.modernUI.showNotification('Balance calculation failed, using original data', 'warning');
                    } else {
                        notify('Balance calculation failed, using original data', 'warning');
                    }
                }

                return accounts;
            }

            // Function to calculate parent account balances as aggregates of their sub-accounts
            function calculateParentAccountBalances(accounts) {
                // DO NOT override backend-calculated balances!
                // The backend already correctly calculates parent account balances
                // by aggregating all child account transactions.
                // This function now just logs the hierarchy for debugging.

                const parentAccounts = accounts.filter(acc => acc.is_parent);

                parentAccounts.forEach(parent => {
                    const subAccounts = accounts.filter(acc => acc.parent_id === parent.id);

                    if (subAccounts.length > 0) {
                        console.log(` Parent account ${parent.code} (${parent.name}) has ${subAccounts.length} sub-accounts:`);
                        console.log(`    Backend-calculated balance: ${parent.balance?.toFixed(2) || '0.00'}`);
                        console.log(`    Backend-calculated debits: ${parent.total_debits?.toFixed(2) || '0.00'}`);
                        console.log(`    Backend-calculated credits: ${parent.total_credits?.toFixed(2) || '0.00'}`);

                        // Log child accounts for debugging
                        subAccounts.forEach(sub => {
                            console.log(`      ${sub.code} (${sub.name}): Balance ${sub.balance?.toFixed(2) || '0.00'}`);
                        });
                    } else {
                        console.log(` Parent account ${parent.code} has no sub-accounts, balance: ${parent.balance?.toFixed(2) || '0.00'}`);
                    }
                });

                // Return accounts unchanged - backend balances are already correct
                return accounts;
            }

            function filterAccountingCodes() {
                const accountTypeFilter = document.getElementById('accountTypeFilter').value;
                const categoryFilter = document.getElementById('categoryFilter').value;
                const searchFilter = document.getElementById('searchFilter').value.toLowerCase();

                // Dimensional filters
                const dimensionFilter = document.getElementById('dimensionFilter').value;
                const specificDimensionFilter = document.getElementById('specificDimensionFilter').value;
                const requirementTypeFilter = document.getElementById('requirementTypeFilter').value;

                const tbody = document.getElementById('accountingCodesBody');
                tbody.innerHTML = '';

                if (!allAccountingCodes || allAccountingCodes.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No data available</td></tr>';
                    return;
                }

                // Filter the data
                let filteredAccounts = allAccountingCodes.filter(account => {
                    // Account type filter
                    if (accountTypeFilter && account.account_type !== accountTypeFilter) {
                        return false;
                    }

                    // Category filter
                    if (categoryFilter && account.category !== categoryFilter) {
                        return false;
                    }

                    // Search filter (search in code, name, and category)
                    if (searchFilter) {
                        const searchText = `${account.code} ${account.name} ${account.category || ''}`.toLowerCase();
                        if (!searchText.includes(searchFilter)) {
                            return false;
                        }
                    }

                    // Dimensional filters
                    if (dimensionFilter || specificDimensionFilter || requirementTypeFilter) {
                        if (!applyDimensionalFilters(account, dimensionFilter, specificDimensionFilter, requirementTypeFilter)) {
                            return false;
                        }
                    }

                    return true;
                });

                // Organize filtered accounts hierarchically
                const parentAccounts = filteredAccounts.filter(acc => acc.is_parent || (!acc.parent_id && !acc.parent));
                const subAccounts = filteredAccounts.filter(acc => (acc.parent_id && !acc.is_parent) || (acc.parent && !acc.is_parent));

                // Create a map of parent accounts with their sub-accounts
                const accountHierarchy = {};
                console.log('DEBUG: parentAccounts:', parentAccounts.length);
                console.log('DEBUG: subAccounts:', subAccounts.length);
                parentAccounts.forEach(parent => {
                    const children = subAccounts.filter(sub =>
                        sub.parent_id === parent.id ||
                        (sub.parent && sub.parent.id === parent.id)
                    );
                    console.log(`DEBUG: Parent ${parent.name} has ${children.length} children:`, children);
                    accountHierarchy[parent.id] = {
                        ...parent,
                        children: children
                    };
                });

                // Render filtered accounts hierarchically
                Object.values(accountHierarchy).forEach(parentAccount => {
                    // Render parent account
                    const parentRow = document.createElement('tr');
                    parentRow.className = 'parent-account';

                    // We'll compute the final display balance from parent's own postings plus all children
                    // and base styling on that combined value.

                    // Calculate total balance from children if parent has children
                    let totalChildBalance = 0;
                    let totalChildDebits = 0;
                    let totalChildCredits = 0;

                    if (parentAccount.children && parentAccount.children.length > 0) {
                        parentAccount.children.forEach(child => {
                            totalChildBalance += child.balance || 0;
                            totalChildDebits += child.total_debits || 0;
                            totalChildCredits += child.total_credits || 0;
                        });
                    }

                    // For parent accounts, display only the aggregate from sub-accounts
                    // The balance calculation function should have already set these correctly
                    const displayBalance = parentAccount.balance || 0;
                    const displayDebits = parentAccount.total_debits || 0;
                    const displayCredits = parentAccount.total_credits || 0;
                    const parentBalanceClass = displayBalance >= 0 ? 'balance-positive' : 'balance-negative';
                    const parentBalanceText = formatCurrency(Math.abs(displayBalance));

                    parentRow.innerHTML = `
                    <td>
                        <strong>${parentAccount.code}</strong>
                        <span class="badge bg-primary ms-1">Parent</span>
                        <i class="bi bi-plus-circle text-success ms-1" title="Can add sub-accounts"></i>
                    </td>
                    <td>
                        <strong>${parentAccount.name}</strong>
                        ${parentAccount.children && parentAccount.children.length > 0 ?
                            `<br><small class="text-muted">Total from ${parentAccount.children.length} sub-account(s)</small>` : ''}
                    </td>
                    <td>
                        <span class="badge bg-${getAccountTypeColor(parentAccount.account_type)} account-type-badge">
                            ${parentAccount.account_type}
                        </span>
                    </td>
                    <td>${parentAccount.category || '-'}</td>
                    <td class="text-end text-danger">${formatCurrency(displayDebits)}</td>
                    <td class="text-end text-success">${formatCurrency(displayCredits)}</td>
                    <td class="text-end ${parentBalanceClass}">
                        <strong>${parentBalanceText}</strong>
                    </td>
                    <td class="text-end">${parentAccount.children ? parentAccount.children.length : 0}</td>
                    <td class="text-end">
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary btn-sm" onclick="viewAccount('${parentAccount.id}')" title="View">
                                <i class="bi bi-eye"></i>
                            </button>
                            <button class="btn btn-outline-info btn-sm" onclick="viewTransactions('${parentAccount.id}')" title="View Transactions">
                                <i class="bi bi-list-ul"></i> Transactions
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" onclick="editAccount('${parentAccount.id}')" title="Edit">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-outline-danger btn-sm" onclick="deleteAccount('${parentAccount.id}', '${parentAccount.name}')" title="Delete">
                                <i class="bi bi-trash"></i>
                            </button>
                            <button class="btn btn-outline-success" onclick="addSubAccount('${parentAccount.id}')" title="Add Sub-Account">
                                <i class="bi bi-plus-circle"></i>
                            </button>
                        </div>
                    </td>
                `;
                    tbody.appendChild(parentRow);

                    // Render sub-accounts under parent
                    if (parentAccount.children && parentAccount.children.length > 0) {
                        console.log(`DEBUG: Rendering ${parentAccount.children.length} children for ${parentAccount.name}`);
                        parentAccount.children.forEach(child => {
                            console.log(`DEBUG: Rendering child: ${child.name} (${child.id})`);
                            const childRow = document.createElement('tr');
                            childRow.className = 'sub-account';

                            const childBalanceClass = child.balance >= 0 ? 'balance-positive' : 'balance-negative';
                            const childBalanceText = formatCurrency(Math.abs(child.balance || 0));

                            childRow.innerHTML = `
                            <td>
                                <span class="ms-4 text-muted"> ${child.code}</span>
                            </td>
                            <td>
                                <span class="ms-4 text-muted">${child.name}</span>
                                <br><small class="text-muted ms-4">Contributes to parent balance</small>
                            </td>
                            <td>
                                <span class="badge bg-${getAccountTypeColor(child.account_type)} account-type-badge ms-4">
                                    ${child.account_type}
                                </span>
                            </td>
                            <td class="ms-4">${child.category || '-'}</td>
                            <td class="text-end text-danger">${formatCurrency(child.total_debits || 0)}</td>
                            <td class="text-end text-success">${formatCurrency(child.total_credits || 0)}</td>
                            <td class="text-end ${childBalanceClass}">${childBalanceText}</td>
                            <td class="text-end">-</td>
                            <td class="text-end">
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary btn-sm" onclick="viewAccount('${child.id}')" title="View">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    <button class="btn btn-outline-info btn-sm" onclick="viewTransactions('${child.id}')" title="View Transactions">
                                        <i class="bi bi-list-ul"></i> Transactions
                                    </button>
                                    <button class="btn btn-outline-secondary btn-sm" onclick="editSubAccount('${child.id}')" title="Edit Sub-Account">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-outline-danger btn-sm" onclick="deleteAccount('${child.id}', '${child.name}')" title="Delete">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </td>
                        `;
                            tbody.appendChild(childRow);
                        });
                    }
                });

                // Show message if no results
                if (Object.keys(accountHierarchy).length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No accounts match the current filters</td></tr>';
                }

                updateStatistics();
            }

            // Dimensional filtering functions
            let accountDimensionRequirements = new Map(); // Cache for dimension requirements

            // Apply dimensional filters to an account
            function applyDimensionalFilters(account, dimensionFilter, specificDimensionFilter, requirementTypeFilter) {
                const requirements = accountDimensionRequirements.get(account.id) || [];

                // Filter by existence of dimension requirements
                if (dimensionFilter === 'has-requirements' && requirements.length === 0) {
                    return false;
                }
                if (dimensionFilter === 'no-requirements' && requirements.length > 0) {
                    return false;
                }

                // Filter by specific dimension
                if (specificDimensionFilter) {
                    const hasSpecificDimension = requirements.some(req => req.dimension_id === specificDimensionFilter);
                    if (!hasSpecificDimension) {
                        return false;
                    }
                }

                // Filter by requirement type
                if (requirementTypeFilter) {
                    const hasRequiredType = requirements.some(req => {
                        if (requirementTypeFilter === 'required') return req.is_required;
                        if (requirementTypeFilter === 'optional') return !req.is_required;
                        return false;
                    });
                    if (!hasRequiredType) {
                        return false;
                    }
                }

                return true;
            }

            // Load dimension requirements for all accounts (for filtering)
            async function loadAllAccountDimensionRequirements() {
                if (!allAccountingCodes || allAccountingCodes.length === 0) {
                    return;
                }

                try {
                    // Clear existing cache
                    accountDimensionRequirements.clear();

                    // Load requirements for each account (in batches to avoid overwhelming the server)
                    const batchSize = 10;
                    for (let i = 0; i < allAccountingCodes.length; i += batchSize) {
                        const batch = allAccountingCodes.slice(i, i + batchSize);
                        const promises = batch.map(async (account) => {
                            try {
                                const response = await fetch(`/api/v1/accounting/codes/${account.id}/dimension-requirements`);
                                if (response.ok) {
                                    const data = await response.json();
                                    accountDimensionRequirements.set(account.id, data.requirements || []);
                                }
                            } catch (error) {
                                console.warn(`Failed to load dimension requirements for account ${account.code}:`, error);
                                accountDimensionRequirements.set(account.id, []);
                            }
                        });
                        await Promise.all(promises);

                        // Small delay between batches
                        if (i + batchSize < allAccountingCodes.length) {
                            await new Promise(resolve => setTimeout(resolve, 100));
                        }
                    }

                    console.log(`Loaded dimension requirements for ${accountDimensionRequirements.size} accounts`);
                } catch (error) {
                    console.error('Error loading account dimension requirements:', error);
                }
            }

            // Populate specific dimension filter dropdown
            function populateSpecificDimensionFilter() {
                const select = document.getElementById('specificDimensionFilter');
                if (!select) return;

                select.innerHTML = '<option value="">Any Dimension</option>';

                if (availableDimensions && availableDimensions.length > 0) {
                    availableDimensions.forEach(dimension => {
                        const option = document.createElement('option');
                        option.value = dimension.id;
                        option.textContent = `${dimension.name} (${dimension.code})`;
                        select.appendChild(option);
                    });
                }
            }

            // Show dimensional summary modal
            function showDimensionalSummary() {
                if (!allAccountingCodes || allAccountingCodes.length === 0) {
                    notify('No accounts loaded for analysis', 'warning');
                    return;
                }

                // Generate summary data
                const summary = generateDimensionalSummary();
                displayDimensionalSummary(summary);
            }

            // Generate dimensional summary statistics
            function generateDimensionalSummary() {
                const summary = {
                    totalAccounts: allAccountingCodes.length,
                    accountsWithRequirements: 0,
                    accountsWithoutRequirements: 0,
                    dimensionUsage: new Map(),
                    requirementTypes: {
                        required: 0,
                        optional: 0
                    },
                    accountsByType: {}
                };

                allAccountingCodes.forEach(account => {
                    const requirements = accountDimensionRequirements.get(account.id) || [];

                    // Track account type
                    if (!summary.accountsByType[account.account_type]) {
                        summary.accountsByType[account.account_type] = {
                            total: 0,
                            withRequirements: 0
                        };
                    }
                    summary.accountsByType[account.account_type].total++;

                    if (requirements.length > 0) {
                        summary.accountsWithRequirements++;
                        summary.accountsByType[account.account_type].withRequirements++;

                        requirements.forEach(req => {
                            // Track dimension usage
                            const dimensionName = req.dimension?.name || 'Unknown Dimension';
                            if (!summary.dimensionUsage.has(dimensionName)) {
                                summary.dimensionUsage.set(dimensionName, {
                                    total: 0,
                                    required: 0,
                                    optional: 0
                                });
                            }
                            const usage = summary.dimensionUsage.get(dimensionName);
                            usage.total++;
                            if (req.is_required) {
                                usage.required++;
                                summary.requirementTypes.required++;
                            } else {
                                usage.optional++;
                                summary.requirementTypes.optional++;
                            }
                        });
                    } else {
                        summary.accountsWithoutRequirements++;
                    }
                });

                return summary;
            }

            // Display dimensional summary in a modal
            function displayDimensionalSummary(summary) {
                const modalHtml = `
                    <div class="modal fade" id="dimensionalSummaryModal" tabindex="-1">
                        <div class="modal-dialog modal-xl">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">
                                        <i class="bi bi-bar-chart me-2"></i>Dimensional Analysis Summary
                                    </h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    ${generateSummaryContent(summary)}
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                    <button type="button" class="btn btn-primary" onclick="exportDimensionalSummary()">
                                        <i class="bi bi-download me-1"></i>Export Summary
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // Remove existing modal
                const existingModal = document.getElementById('dimensionalSummaryModal');
                if (existingModal) {
                    existingModal.remove();
                }

                // Add and show modal
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                const modal = new bootstrap.Modal(document.getElementById('dimensionalSummaryModal'));
                modal.show();

                // Clean up when hidden
                document.getElementById('dimensionalSummaryModal').addEventListener('hidden.bs.modal', function () {
                    this.remove();
                });
            }

            // Generate summary content HTML
            function generateSummaryContent(summary) {
                const dimensionRows = Array.from(summary.dimensionUsage.entries())
                    .map(([name, usage]) => `
                        <tr>
                            <td><strong>${name}</strong></td>
                            <td class="text-center">${usage.total}</td>
                            <td class="text-center text-danger">${usage.required}</td>
                            <td class="text-center text-secondary">${usage.optional}</td>
                            <td class="text-center">
                                <div class="progress" style="height: 20px;">
                                    <div class="progress-bar bg-danger" style="width: ${(usage.required / usage.total * 100).toFixed(1)}%"></div>
                                    <div class="progress-bar bg-secondary" style="width: ${(usage.optional / usage.total * 100).toFixed(1)}%"></div>
                                </div>
                            </td>
                        </tr>
                    `)
                    .join('');

                const accountTypeRows = Object.entries(summary.accountsByType)
                    .map(([type, data]) => `
                        <tr>
                            <td><strong>${type}</strong></td>
                            <td class="text-center">${data.total}</td>
                            <td class="text-center">${data.withRequirements}</td>
                            <td class="text-center">${((data.withRequirements / data.total) * 100).toFixed(1)}%</td>
                        </tr>
                    `)
                    .join('');

                return `
                    <div class="row">
                        <div class="col-md-12 mb-4">
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="card bg-primary text-white text-center">
                                        <div class="card-body">
                                            <h4>${summary.totalAccounts}</h4>
                                            <small>Total Accounts</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-success text-white text-center">
                                        <div class="card-body">
                                            <h4>${summary.accountsWithRequirements}</h4>
                                            <small>With Dimensions</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-danger text-white text-center">
                                        <div class="card-body">
                                            <h4>${summary.requirementTypes.required}</h4>
                                            <small>Required Dimensions</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-secondary text-white text-center">
                                        <div class="card-body">
                                            <h4>${summary.requirementTypes.optional}</h4>
                                            <small>Optional Dimensions</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <h6>Dimension Usage</h6>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Dimension</th>
                                            <th class="text-center">Total</th>
                                            <th class="text-center">Required</th>
                                            <th class="text-center">Optional</th>
                                            <th class="text-center">Distribution</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${dimensionRows || '<tr><td colspan="5" class="text-center text-muted">No dimensions configured</td></tr>'}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>Account Types</h6>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Account Type</th>
                                            <th class="text-center">Total</th>
                                            <th class="text-center">With Dimensions</th>
                                            <th class="text-center">Percentage</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${accountTypeRows}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
            }

            function clearFilters() {
                document.getElementById('accountTypeFilter').value = '';
                document.getElementById('categoryFilter').value = '';
                document.getElementById('searchFilter').value = '';

                // Clear dimensional filters
                document.getElementById('dimensionFilter').value = '';
                document.getElementById('specificDimensionFilter').value = '';
                document.getElementById('requirementTypeFilter').value = '';

                loadAccountingCodes();
            }

            // Function to load account types from the backend
            async function loadAccountTypes(targetSelectId, selectedType = '') {
                try {
                    const select = document.getElementById(targetSelectId);
                    if (!select) return;

                    // Clear existing options except the first one
                    const firstOption = select.options[0] ? select.options[0] : document.createElement('option');
                    firstOption.value = '';
                    firstOption.textContent = 'Select Account Type';
                    select.innerHTML = '';
                    select.appendChild(firstOption);

                    // Get account types from the backend or use our constants
                    const accountTypes = [
                        'Asset', 'Liability', 'Equity', 'Revenue', 'Expense'
                    ];

                    // Add account types to select
                    accountTypes.forEach(type => {
                        const option = document.createElement('option');
                        option.value = type;
                        option.textContent = type;
                        if (type === selectedType) {
                            option.selected = true;
                        }
                        select.appendChild(option);
                    });

                    // If a type is selected, also load its categories
                    if (selectedType) {
                        await loadCategoriesByAccountType(selectedType, targetSelectId.replace('Type', 'Category'));
                    }
                } catch (error) {
                    console.error('Error loading account types:', error);
                }
            }

            // Function to load categories based on selected account type
            async function loadCategoriesByAccountType(accountType, targetSelectId) {
                try {
                    const select = document.getElementById(targetSelectId);
                    if (!select) {
                        console.warn('Select element not found:', targetSelectId);
                        return;
                    }

                    // Clear existing options except the first one
                    const firstOption = (select.options && select.options.length > 0) ? select.options[0] : document.createElement('option');
                    firstOption.value = '';
                    firstOption.textContent = 'Select Category';
                    select.innerHTML = '';
                    select.appendChild(firstOption);

                    // If no account type selected, return
                    if (!accountType) return;

                    // Get categories from the backend or use our constants
                    const categories = {
                        'Asset': ['Current Asset', 'Fixed Asset', 'Inventory', 'Trade Receivables', 'Cash', 'Bank', 'Prepaid Expenses', 'Investments'],
                        'Liability': ['Current Liability', 'Long-Term Liability', 'Trade Payables', 'Accrued Liabilities', 'VAT Payable', 'Tax Payable', 'Loans Payable'],
                        'Equity': ['Equity Capital', 'Retained Earnings', 'Opening Balance Equity', 'Owner Equity', 'Common Stock', 'Preferred Stock', 'Treasury Stock', 'Dividends', 'Drawings'],
                        'Revenue': ['Sales Revenue', 'Service Revenue', 'Other Revenue', 'Operating Revenue', 'Interest Income', 'Rental Income', 'Dividend Income', 'Gain on Sale of Assets'],
                        'Expense': ['Operating Expense', 'Depreciation', 'Cost of Sales', 'Tax Expense', 'Salaries and Wages', 'Rent Expense', 'Utilities', 'Insurance', 'Office Supplies', 'Marketing', 'Professional Fees', 'Interest Expense', 'Repairs and Maintenance', 'Travel Expense', 'Bad Debts']
                    };

                    // Add categories to select
                    const accountCategories = categories[accountType] || [];
                    accountCategories.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category;
                        option.textContent = category;
                        select.appendChild(option);
                    });

                    // Enable the select if there are options
                    select.disabled = accountCategories.length === 0;
                } catch (error) {
                    console.error('Error loading categories:', error);
                }
            }

            async function saveParentAccount() {
                try {
                    // Get form data
                    const accountCode = document.getElementById('accountCode').value.trim();
                    const accountName = document.getElementById('accountName').value.trim();
                    const accountType = document.getElementById('accountType').value;
                    const accountCategory = document.getElementById('accountCategory').value;
                    const isParent = document.getElementById('isParent').checked;
                    const currency = document.getElementById('currency')?.value || getCurrentCurrencySettings().code;
                    const reportingTag = document.getElementById('reportingTag')?.value || '';

                    // Validate required fields
                    if (!accountCode || !accountName || !accountType || !accountCategory) {
                        notify('Please fill in all required fields', 'warning');
                        return;
                    }

                    // Validate account code format (4 digits for parent accounts)
                    if (!/^\d{4}$/.test(accountCode)) {
                        notify('Account code must be a 4-digit number for parent accounts', 'warning');
                        return;
                    }

                    // Prepare data for API call
                    const accountData = {
                        code: accountCode,
                        name: accountName,
                        account_type: accountType,
                        category: accountCategory,
                        is_parent: isParent,
                        currency: currency,
                        reporting_tag: reportingTag || null
                    };

                    // Show loading state
                    const saveBtn = document.querySelector('#newParentAccountModal .btn-primary');
                    const originalBtnText = saveBtn.innerHTML;
                    saveBtn.disabled = true;
                    saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...';

                    // Call API to create accounting code
                    const response = await fetch(API_CONFIG.ENDPOINTS.ACCOUNTING_CODES, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(accountData)
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.detail || 'Failed to create accounting code');
                    }

                    const data = await response.json();

                    // Show success message
                    notify('Parent account saved successfully!', 'success');

                    // Reset form and close modal
                    document.getElementById('newParentAccountForm').reset();
                    const modal = bootstrap.Modal.getInstance(document.getElementById('newParentAccountModal'));
                    modal.hide();

                    // Reload accounting codes
                    loadAccountingCodes();

                } catch (error) {
                    console.error('Error:', error);
                    notify('Error saving parent account: ' + (error.message || 'Please check the form and try again'), 'danger');
                } finally {
                    // Reset button state
                    const saveBtn = document.querySelector('#newParentAccountModal .btn-primary');
                    if (saveBtn) {
                        saveBtn.disabled = false;
                        saveBtn.innerHTML = 'Save Account';
                    }
                }
            }

            async function saveSubAccount() {
                try {
                    // Get form data
                    const parentAccount = document.getElementById('parentAccount').value;
                    const subAccountCode = document.getElementById('subAccountCode').value.trim();
                    const subAccountName = document.getElementById('subAccountName').value.trim();
                    const subAccountType = document.getElementById('subAccountType').value;
                    const subAccountCategory = document.getElementById('subAccountCategory').value;
                    const currency = document.getElementById('subAccountCurrency')?.value || 'BWP';
                    const reportingTag = document.getElementById('subAccountReportingTag')?.value || '';

                    // Validate required fields
                    if (!parentAccount || !subAccountCode || !subAccountName || !subAccountType || !subAccountCategory) {
                        notify('Please fill in all required fields', 'warning');
                        return;
                    }

                    // Validate sub-account code format (parent code + dash + 2 digits)
                    if (!/^\d{4}-\d{2}$/.test(subAccountCode)) {
                        notify('Sub-account code must be in the format XXXX-YY where XXXX is the parent code and YY is a 2-digit number', 'warning');
                        return;
                    }

                    // Verify parent code matches
                    const parentCode = subAccountCode.split('-')[0];
                    const parentSelect = document.getElementById('parentAccount');
                    const selectedParent = parentSelect.options[parentSelect.selectedIndex];
                    const selectedParentCode = selectedParent ? selectedParent.getAttribute('data-code') : null;

                    if (!selectedParentCode) {
                        // Fallback: get parent code from the option text
                        const optionText = selectedParent ? selectedParent.textContent : '';
                        const codeMatch = optionText.match(/^(\d{4})/);
                        const fallbackParentCode = codeMatch ? codeMatch[1] : null;

                        if (!fallbackParentCode) {
                            notify('Unable to determine parent account code. Please refresh the page and try again.', 'danger');
                            return;
                        }

                        if (parentCode !== fallbackParentCode) {
                            notify(`Sub-account code must start with the parent account code (${fallbackParentCode})`, 'warning');
                            return;
                        }
                    } else {
                        if (parentCode !== selectedParentCode) {
                            notify(`Sub-account code must start with the parent account code (${selectedParentCode})`, 'warning');
                            return;
                        }
                    }

                    // Prepare data for API call
                    const subAccountData = {
                        code: subAccountCode,
                        name: subAccountName,
                        account_type: subAccountType,
                        category: subAccountCategory,
                        is_parent: false,
                        parent_id: parentAccount,
                        currency: currency,
                        reporting_tag: reportingTag || null
                    };

                    // Show loading state
                    const saveBtn = document.querySelector('#newSubAccountModal .btn-primary');
                    const originalBtnText = saveBtn.innerHTML;
                    saveBtn.disabled = true;
                    saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...';

                    // Call API to create sub-account
                    const response = await fetch(API_CONFIG.buildUrl(`/accounting-codes/${parentAccount}/sub-accounts`), {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(subAccountData)
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.detail || 'Failed to create sub-account');
                    }

                    const data = await response.json();

                    // Show success message
                    notify('Sub-account saved successfully!', 'success');

                    // Reset form and close modal
                    document.getElementById('newSubAccountForm').reset();
                    const modal = bootstrap.Modal.getInstance(document.getElementById('newSubAccountModal'));
                    modal.hide();

                    // Reload accounting codes
                    loadAccountingCodes();

                } catch (error) {
                    console.error('Error:', error);
                    notify('Error saving sub-account: ' + (error.message || 'Please check the form and try again'), 'danger');
                } finally {
                    // Reset button state
                    const saveBtn = document.querySelector('#newSubAccountModal .btn-primary');
                    if (saveBtn) {
                        saveBtn.disabled = false;
                        saveBtn.innerHTML = 'Save Sub-account';
                    }
                }
            }

            function viewAccount(id) {
                try {
                    // Reset sub-accounts UI
                    const subAccountsList = document.getElementById('subAccountsList');
                    const subAccountsTable = document.getElementById('subAccountsTable');
                    const noSubAccountsMessage = document.getElementById('noSubAccountsMessage');
                    const subAccountsTotal = document.getElementById('subAccountsTotal');

                    // Only proceed if required elements exist
                    if (!subAccountsList || !subAccountsTable || !noSubAccountsMessage || !subAccountsTotal) {
                        throw new Error('Required DOM elements not found');
                    }

                    subAccountsList.innerHTML = '';
                    subAccountsTable.style.display = 'none';
                    noSubAccountsMessage.style.display = 'block';
                    subAccountsTotal.style.display = 'none';

                    // Show loading state
                    const loadingRow = document.createElement('tr');
                    loadingRow.id = 'loadingSubAccounts';
                    loadingRow.innerHTML = '<td colspan="5" class="text-center py-3"><div class="spinner-border spinner-border-sm" role="status"><span class="visually-hidden">Loading...</span></div> Loading sub-accounts...</td>';
                    subAccountsList.appendChild(loadingRow);

                    // Fetch account details from API
                    fetch(API_CONFIG.buildUrl(`/accounting-codes/${id}`))
                        .then(response => {
                            if (!response.ok) {
                                let errorMessage = 'Failed to fetch account details';
                                return response.json().catch(() => {
                                    // If response is not JSON (e.g., HTML error page), get text content
                                    return response.text().then(text => {
                                        console.error('Server returned non-JSON error:', text);
                                        throw new Error(`Server error (${response.status}): ${response.statusText}`);
                                    });
                                }).then(errorData => {
                                    throw new Error(errorData.detail || errorMessage);
                                });
                            }
                            return response.json();
                        })
                        .then(account => {
                            // Helper function to safely set text content
                            const setTextContent = (elementId, text) => {
                                const element = document.getElementById(elementId);
                                if (element) element.textContent = text || '-';
                            };

                            const subAccountCount = Array.isArray(account.sub_accounts) ? account.sub_accounts.length : 0;
                            const hasSubAccounts = subAccountCount > 0;
                            const isParentAccount = Boolean(account.is_parent) || hasSubAccounts;

                            currentViewedAccountId = account.id;
                            currentViewedAccountData = { ...account, is_parent: isParentAccount };

                            // Populate the view modal with null checks
                            setTextContent('viewAccountCode', account.code);
                            setTextContent('viewAccountName', account.name);
                            setTextContent('viewAccountType', account.account_type);
                            setTextContent('viewAccountCategory', account.category);
                            setTextContent('viewAccountCurrency', account.currency || 'BWP');
                            setTextContent('viewAccountReportingTag', account.reporting_tag);

                            // Format numbers safely
                            const formatNumber = (num) => (num || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                            const currency = account.currency || 'BWP';

                            setTextContent('viewAccountDebits', `${currency} ${formatNumber(account.total_debits)}`);
                            setTextContent('viewAccountCredits', `${currency} ${formatNumber(account.total_credits)}`);
                            setTextContent('viewAccountBalance', `${currency} ${formatNumber(account.balance)}`);

                            // Handle parent account display
                            const parentText = account.parent ?
                                `${account.parent.code || ''} - ${account.parent.name || ''}`.trim() : 'None';
                            setTextContent('viewAccountParent', parentText);

                            const accountTypeElement = document.getElementById('viewAccountIsParent');
                            if (accountTypeElement) {
                                if (isParentAccount) {
                                    accountTypeElement.textContent = 'Parent Account';
                                } else if (account.parent) {
                                    accountTypeElement.textContent = 'Sub Account';
                                } else {
                                    accountTypeElement.textContent = 'Standalone Account';
                                }
                            }

                            // Store the account ID for editing
                            const editIdElement = document.getElementById('editAccountId');
                            if (editIdElement) {
                                editIdElement.value = account.id;
                            }

                            // Handle Add Sub-Account button
                            const addSubAccountBtn = document.getElementById('addSubAccountBtn');
                            if (addSubAccountBtn) {
                                addSubAccountBtn.setAttribute('data-account-id', account.id);
                                addSubAccountBtn.onclick = function () {
                                    const viewModal = bootstrap.Modal.getInstance(document.getElementById('viewAccountModal'));
                                    if (viewModal) viewModal.hide();

                                    document.getElementById('parentAccount').value = account.id;

                                    const subAccountModal = new bootstrap.Modal(document.getElementById('newSubAccountModal'));
                                    subAccountModal.show();

                                    setTimeout(() => {
                                        loadParentAccounts();
                                    }, 200);
                                };

                                if (isParentAccount) {
                                    addSubAccountBtn.style.display = 'block';
                                } else {
                                    addSubAccountBtn.style.display = 'none';
                                }
                            }

                            loadSubAccounts(account.id);

                            // Initialize dimensions for this account
                            initializeDimensionsForAccount(account.id);

                            // Show the modal
                            const modalElement = document.getElementById('viewAccountModal');
                            if (modalElement) {
                                const modal = new bootstrap.Modal(modalElement);
                                modal.show();

                                // Initialize tooltips after modal is shown
                                modalElement.addEventListener('shown.bs.modal', function handleViewModalShown() {
                                    modalElement.setAttribute('aria-hidden', 'false');
                                    if (typeof modalElement.focus === 'function') {
                                        modalElement.focus({ preventScroll: true });
                                    }

                                    requestAnimationFrame(() => {
                                        ensureSubAccountsVisibility('modal-shown');
                                    });

                                    const tooltipTriggerList = [].slice.call(modalElement.querySelectorAll('[data-bs-toggle="tooltip"]'));
                                    tooltipTriggerList.map(function (tooltipTriggerEl) {
                                        return new bootstrap.Tooltip(tooltipTriggerEl);
                                    });

                                    // Set up tab event listeners
                                    const transactionDetailsTab = document.getElementById('transaction-details-tab');
                                    if (transactionDetailsTab) {
                                        transactionDetailsTab.addEventListener('shown.bs.tab', function () {
                                            // Load transaction details when tab is shown
                                            loadTransactionDetails(account.code, account.id);
                                        });
                                    }

                                    // Initialize date filters with reasonable defaults
                                    const today = new Date();
                                    const sixMonthsAgo = new Date();
                                    sixMonthsAgo.setMonth(today.getMonth() - 6);

                                    document.getElementById('transactionFromDate').value = sixMonthsAgo.toISOString().split('T')[0];
                                    document.getElementById('transactionToDate').value = today.toISOString().split('T')[0];
                                }, { once: true });
                            } else {
                                console.error('Modal element not found');
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            notify('Error fetching account details: ' + error.message, 'danger');
                        });

                } catch (error) {
                    console.error('Error in viewAccount:', error);
                    notify('Error loading account: ' + error.message, 'danger');
                }
            }

            async function viewTransactions(accountId) {
                console.log('viewTransactions called with accountId:', accountId);
                try {
                    // Show the modal
                    const modal = new bootstrap.Modal(document.getElementById('viewTransactionsModal'));
                    modal.show();
                    console.log('Modal shown');

                    // Show loading state
                    document.getElementById('transactionsLoading').style.display = 'block';
                    document.getElementById('transactionsContent').style.display = 'none';

                    // First get account details for the title
                    console.log('Fetching account details...');
                    const accountResponse = await fetch(API_CONFIG.buildUrl(`/accounting-codes/${accountId}`));
                    if (!accountResponse.ok) {
                        let errorMessage = 'Failed to fetch account details';
                        try {
                            const errorData = await accountResponse.json();
                            errorMessage = errorData.detail || errorMessage;
                        } catch (parseError) {
                            // If response is not JSON (e.g., HTML error page), get text content
                            const errorText = await accountResponse.text();
                            console.error('Server returned non-JSON error:', errorText);
                            errorMessage = `Server error (${accountResponse.status}): ${accountResponse.statusText}`;
                        }
                        throw new Error(errorMessage);
                    }
                    const account = await accountResponse.json();
                    console.log('Account details:', account);

                    // Update modal title
                    document.getElementById('transactionAccountName').textContent = `${account.code} - ${account.name}`;

                    // Fetch transactions for the account
                    console.log('Fetching transactions...');
                    const transactionsResponse = await fetch(API_CONFIG.buildUrl(`/accounting-codes/${accountId}/transactions`));
                    if (!transactionsResponse.ok) {
                        let errorMessage = 'Failed to fetch transactions';
                        try {
                            const errorData = await transactionsResponse.json();
                            errorMessage = errorData.detail || errorMessage;
                        } catch (parseError) {
                            // If response is not JSON (e.g., HTML error page), get text content
                            const errorText = await transactionsResponse.text();
                            console.error('Server returned non-JSON error:', errorText);
                            errorMessage = `Server error (${transactionsResponse.status}): ${transactionsResponse.statusText}`;
                        }
                        throw new Error(errorMessage);
                    }
                    const data = await transactionsResponse.json();
                    console.log('Transaction data:', data);

                    // Hide loading, show content
                    document.getElementById('transactionsLoading').style.display = 'none';
                    document.getElementById('transactionsContent').style.display = 'block';

                    // Update summary cards
                    document.getElementById('modalTransactionCurrentBalance').textContent =
                        formatCurrency(data.current_balance || 0);
                    document.getElementById('modalTransactionTotalDebits').textContent =
                        formatCurrency(data.total_debits || 0);
                    document.getElementById('modalTransactionTotalCredits').textContent =
                        formatCurrency(data.total_credits || 0);
                    document.getElementById('modalTransactionCount').textContent =
                        data.transactions ? data.transactions.length : 0;

                    // Populate transactions table
                    const tbody = document.getElementById('transactionsTableBody');
                    tbody.innerHTML = '';

                    if (data.transactions && data.transactions.length > 0) {
                        document.getElementById('noTransactionsMessage').style.display = 'none';

                        data.transactions.forEach((transaction, index) => {
                            const row = document.createElement('tr');

                            const debitAmount = transaction.debit_amount || 0;
                            const creditAmount = transaction.credit_amount || 0;
                            const balanceAfter = transaction.balance_after || 0;

                            row.innerHTML = `
                            <td>
                                <small class="text-muted">${new Date(transaction.date).toLocaleDateString()}</small>
                            </td>
                            <td>
                                <strong>${transaction.description || '-'}</strong>
                                ${transaction.narration ? `<br><small class="text-muted">${transaction.narration}</small>` : ''}
                            </td>
                            <td>
                                <small class="text-muted">${transaction.reference || '-'}</small>
                                ${transaction.entry_type ? `<br><span class="badge bg-secondary">${transaction.entry_type}</span>` : ''}
                            </td>
                            <td class="text-end">
                                ${debitAmount > 0 ?
                                    `<span class="text-danger fw-bold">${formatCurrency(debitAmount)}</span>` :
                                    '-'
                                }
                            </td>
                            <td class="text-end">
                                ${creditAmount > 0 ?
                                    `<span class="text-success fw-bold">${formatCurrency(creditAmount)}</span>` :
                                    '-'
                                }
                            </td>
                            <td class="text-end">
                                <span class="fw-bold ${balanceAfter >= 0 ? 'text-primary' : 'text-warning'}">
                                    ${formatCurrency(balanceAfter)}
                                </span>
                            </td>
                        `;

                            tbody.appendChild(row);
                        });
                    } else {
                        document.getElementById('noTransactionsMessage').style.display = 'block';
                    }

                } catch (error) {
                    console.error('Error loading transactions:', error);

                    // Hide loading, show content
                    document.getElementById('transactionsLoading').style.display = 'none';
                    document.getElementById('transactionsContent').style.display = 'block';

                    // Show error message in the table
                    const tbody = document.getElementById('transactionsTableBody');
                    tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-danger py-4">
                            <i class="bi bi-exclamation-triangle fs-1 mb-3"></i>
                            <h5>Error Loading Transactions</h5>
                            <p class="mb-2">Unable to load transaction data for this account.</p>
                            <small class="text-muted">Error: ${error.message}</small>
                        </td>
                    </tr>
                `;

                    // Clear summary cards on error
                    document.getElementById('modalTransactionCurrentBalance').textContent = 'Error';
                    document.getElementById('modalTransactionTotalDebits').textContent = 'Error';
                    document.getElementById('modalTransactionTotalCredits').textContent = 'Error';
                    document.getElementById('modalTransactionCount').textContent = '0';

                    // Show alert
                    notify(`Failed to load transactions: ${error.message}`, 'danger');
                }
            }

            function setSubAccountsError(message) {
                const alert = document.getElementById('subAccountsErrorAlert');
                if (!alert) {
                    return;
                }
                if (message) {
                    alert.textContent = message;
                    alert.classList.remove('d-none');
                } else {
                    alert.textContent = '';
                    alert.classList.add('d-none');
                }
            }

            function updateSubAccountSummary(subAccounts = [], currency = 'BWP') {
                const summaryRow = document.getElementById('subAccountsSummary');
                const countEl = document.getElementById('subAccountsSummaryCount');
                const debitEl = document.getElementById('subAccountsSummaryDebits');
                const creditEl = document.getElementById('subAccountsSummaryCredits');
                const balanceEl = document.getElementById('subAccountsSummaryBalance');

                if (!summaryRow || !countEl || !debitEl || !creditEl || !balanceEl) {
                    return;
                }

                if (!Array.isArray(subAccounts) || subAccounts.length === 0) {
                    summaryRow.style.display = 'none';
                    countEl.textContent = '0';
                    debitEl.textContent = formatCurrency(0);
                    creditEl.textContent = formatCurrency(0);
                    balanceEl.textContent = formatCurrency(0);
                    balanceEl.classList.remove('text-success', 'text-danger');
                    return;
                }

                const totalDebits = subAccounts.reduce((sum, account) => sum + (parseFloat(account.total_debits) || 0), 0);
                const totalCredits = subAccounts.reduce((sum, account) => sum + (parseFloat(account.total_credits) || 0), 0);
                const totalBalance = subAccounts.reduce((sum, account) => sum + (parseFloat(account.balance) || 0), 0);

                summaryRow.style.display = '';
                countEl.textContent = subAccounts.length;
                debitEl.textContent = formatCurrency(totalDebits);
                creditEl.textContent = formatCurrency(totalCredits);

                balanceEl.textContent = formatCurrency(totalBalance);
                balanceEl.classList.remove('text-success', 'text-danger');
                if (totalBalance > 0) {
                    balanceEl.classList.add('text-success');
                } else if (totalBalance < 0) {
                    balanceEl.classList.add('text-danger');
                }
            }

            function ensureSubAccountsVisibility(reason = 'manual') {
                const subAccountsTabPane = document.getElementById('sub-accounts');
                const subAccountsTable = document.getElementById('subAccountsTable');
                const subAccountsFallbackList = document.getElementById('subAccountsFallbackList');

                if (!subAccountsTabPane || !subAccountsTable) {
                    return;
                }

                const isActive = subAccountsTabPane.classList.contains('show') && subAccountsTabPane.classList.contains('active');
                const tableWrapper = subAccountsTable.closest('.table-responsive');
                const rowCount = subAccountsTable.querySelectorAll('tbody tr').length;
                const fallbackChildren = subAccountsFallbackList ? subAccountsFallbackList.children.length : 0;

                if (!isActive) {
                    subAccountsTabPane.dataset.needsVisibilityRefresh = 'true';
                    console.debug('[SubAccounts] Tab hidden; deferring visibility refresh.', { reason, rowCount, fallbackChildren });
                    return;
                }

                delete subAccountsTabPane.dataset.needsVisibilityRefresh;

                let forcedFallback = false;

                if (rowCount > 0) {
                    if (tableWrapper) {
                        tableWrapper.classList.remove('d-none');
                        tableWrapper.style.removeProperty('display');
                    }

                    subAccountsTable.classList.remove('d-none');
                    subAccountsTable.style.setProperty('display', 'table', 'important');
                    subAccountsTable.style.visibility = 'visible';

                    const tableHeight = subAccountsTable.offsetHeight;

                    if (tableHeight < 5 && fallbackChildren > 0) {
                        forcedFallback = true;
                        subAccountsTable.style.display = 'none';
                        subAccountsTable.classList.add('d-none');
                        console.warn('[SubAccounts] Table remained collapsed after tab activation. Switching to fallback cards.', {
                            reason,
                            tableHeight,
                            fallbackChildren
                        });
                    } else if (tableHeight < 5) {
                        subAccountsTable.style.minHeight = '1rem';
                    } else if (subAccountsFallbackList) {
                        subAccountsFallbackList.style.display = 'none';
                        subAccountsFallbackList.classList.add('d-none');
                    }
                }

                if ((rowCount === 0 || forcedFallback) && subAccountsFallbackList && fallbackChildren > 0) {
                    subAccountsFallbackList.style.setProperty('display', 'flex', 'important');
                    subAccountsFallbackList.classList.remove('d-none');
                    subAccountsFallbackList.style.visibility = 'visible';
                }

                if (rowCount === 0 && (!subAccountsFallbackList || fallbackChildren === 0)) {
                    console.debug('[SubAccounts] No sub-account rows or cards present to display.', { reason });
                }

                console.debug('[SubAccounts] Visibility refresh applied:', {
                    reason,
                    rowCount,
                    tableHeight: subAccountsTable.offsetHeight,
                    fallbackChildren,
                    fallbackDisplay: subAccountsFallbackList ? window.getComputedStyle(subAccountsFallbackList).display : 'n/a'
                });
            }

            function resetSubAccountsSection({ message = "No sub-accounts found. Click 'Add Sub-Account' to create one." } = {}) {
                const subAccountsList = document.getElementById('subAccountsList');
                const subAccountsTable = document.getElementById('subAccountsTable');
                const noSubAccountsMessage = document.getElementById('noSubAccountsMessage');
                const subAccountsTotal = document.getElementById('subAccountsTotal');
                const subAccountsSummary = document.getElementById('subAccountsSummary');
                const subAccountsFallbackList = document.getElementById('subAccountsFallbackList');
                const subAccountsTabPane = document.getElementById('sub-accounts');

                currentSubAccounts = [];

                if (subAccountsList) {
                    subAccountsList.innerHTML = '';
                }
                if (subAccountsTable) {
                    subAccountsTable.style.display = 'none';
                    subAccountsTable.classList.remove('table-loaded');
                    subAccountsTable.classList.add('d-none');
                    subAccountsTable.style.removeProperty('min-height');
                }
                if (subAccountsTotal) {
                    subAccountsTotal.style.display = 'none';
                }
                if (subAccountsSummary) {
                    subAccountsSummary.style.display = 'none';
                }
                if (subAccountsFallbackList) {
                    subAccountsFallbackList.innerHTML = '';
                    subAccountsFallbackList.style.display = 'none';
                    subAccountsFallbackList.classList.add('d-none');
                }
                if (noSubAccountsMessage) {
                    noSubAccountsMessage.textContent = message;
                    noSubAccountsMessage.style.display = 'block';
                    noSubAccountsMessage.classList.remove('d-none');
                }

                if (subAccountsTabPane && subAccountsTabPane.dataset.needsVisibilityRefresh) {
                    delete subAccountsTabPane.dataset.needsVisibilityRefresh;
                }

                updateSubAccountSummary([]);
                setSubAccountsError(null);
            }

            async function loadSubAccounts(parentId) {
                const subAccountsList = document.getElementById('subAccountsList');
                const subAccountsTable = document.getElementById('subAccountsTable');
                const noSubAccountsMessage = document.getElementById('noSubAccountsMessage');
                const subAccountsTotal = document.getElementById('subAccountsTotal');
                const subAccountsFallbackList = document.getElementById('subAccountsFallbackList');

                if (!subAccountsList || !subAccountsTable || !noSubAccountsMessage || !subAccountsTotal) {
                    console.warn('Sub-account table elements are missing from the DOM.');
                    return;
                }

                setSubAccountsError(null);
                currentSubAccounts = [];

                if (!parentId) {
                    resetSubAccountsSection({ message: 'Select a parent account to view sub-accounts.' });
                    return;
                }

                console.debug('[SubAccounts] Loading sub-accounts for parent:', parentId);
                subAccountsList.innerHTML = `
                <tr id="loadingSubAccounts">
                    <td colspan="7" class="text-center py-3">
                        <div class="spinner-border spinner-border-sm" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        Loading sub-accounts...
                    </td>
                </tr>
            `;
                noSubAccountsMessage.style.display = 'none';
                noSubAccountsMessage.classList.add('d-none');
                subAccountsTable.style.display = 'none';
                subAccountsTable.classList.add('d-none');
                subAccountsTotal.style.display = 'none';
                if (subAccountsFallbackList) {
                    subAccountsFallbackList.innerHTML = '';
                    subAccountsFallbackList.style.display = 'none';
                    subAccountsFallbackList.classList.add('d-none');
                }

                try {
                    const response = await fetch(API_CONFIG.buildUrl(`/accounting-codes/${parentId}/sub-accounts`));
                    if (!response.ok) {
                        let detail = 'Failed to fetch sub-accounts';
                        try {
                            const errorData = await response.json();
                            detail = errorData.detail || detail;
                        } catch (parseError) {
                            detail = `${detail} (HTTP ${response.status})`;
                        }
                        throw new Error(detail);
                    }

                    const subAccounts = await response.json();
                    let fetchedSubAccounts = Array.isArray(subAccounts) ? subAccounts : [];

                    if (!Array.isArray(subAccounts)) {
                        console.warn('[SubAccounts] Unexpected response format. Received:', subAccounts);
                    }

                    if (fetchedSubAccounts.length === 0) {
                        const fallback = (allAccountingCodes || []).filter(acc => {
                            return acc.parent_id === parentId || acc.parent?.id === parentId;
                        });

                        if (fallback.length > 0) {
                            console.warn('[SubAccounts] API returned no rows; falling back to cached hierarchy snapshot.', {
                                parentId,
                                fallbackCount: fallback.length
                            });
                            fetchedSubAccounts = fallback.map(acc => ({ ...acc }));
                        } else {
                            console.debug('[SubAccounts] No cached fallback available for parent:', parentId);
                        }
                    }

                    currentSubAccounts = fetchedSubAccounts;

                    if (currentViewedAccountId === parentId) {
                        const inferredParent = currentSubAccounts.length > 0;
                        currentViewedAccountData = {
                            ...(currentViewedAccountData || {}),
                            id: parentId,
                            is_parent: Boolean(currentViewedAccountData?.is_parent) || inferredParent
                        };

                        const addSubAccountBtn = document.getElementById('addSubAccountBtn');
                        if (addSubAccountBtn) {
                            if (currentViewedAccountData.is_parent || inferredParent) {
                                addSubAccountBtn.style.display = 'block';
                                addSubAccountBtn.setAttribute('data-account-id', parentId);
                            } else {
                                addSubAccountBtn.style.display = 'none';
                            }
                        }
                    }

                    if (currentSubAccounts.length === 0) {
                        resetSubAccountsSection({
                            message: 'No sub-accounts yet. Use the button above to add one.'
                        });
                        return;
                    }

                    const subAccountsWithBalances = await calculateAccountSpecificBalances(currentSubAccounts);
                    currentSubAccounts = subAccountsWithBalances;

                    let totalDebits = 0;
                    let totalCredits = 0;
                    let totalBalance = 0;
                    const currency = subAccountsWithBalances[0]?.currency || currentViewedAccountData?.currency || 'BWP';

                    subAccountsList.innerHTML = '';

                    subAccountsWithBalances.forEach(subAccount => {
                        accountingCodesById.set(subAccount.id, subAccount);

                        const existingIndex = allAccountingCodes.findIndex(acc => acc.id === subAccount.id);
                        if (existingIndex >= 0) {
                            allAccountingCodes[existingIndex] = { ...allAccountingCodes[existingIndex], ...subAccount };
                        } else {
                            allAccountingCodes.push(subAccount);
                        }

                        const debits = parseFloat(subAccount.total_debits || 0);
                        const credits = parseFloat(subAccount.total_credits || 0);
                        const balance = parseFloat(subAccount.balance || 0);

                        totalDebits += debits;
                        totalCredits += credits;
                        totalBalance += balance;

                        const balanceClass = balance >= 0 ? 'text-success' : 'text-danger';
                        const safeName = (subAccount.name || '').replace(/'/g, "\\'");

                        const row = document.createElement('tr');
                        row.innerHTML = `
                        <td><span class="fw-semibold">${subAccount.code}</span></td>
                        <td>
                            <div class="fw-semibold">${subAccount.name}</div>
                            <div class="small text-muted">${subAccount.account_type || ''}  ${subAccount.currency || currency}</div>
                        </td>
                        <td class="text-end text-danger">${formatCurrency(debits)}</td>
                        <td class="text-end text-success">${formatCurrency(credits)}</td>
                        <td class="text-end fw-semibold ${balanceClass}">${formatCurrency(balance)}</td>
                        <td>
                            ${subAccount.reporting_tag ? `<span class="badge bg-light text-dark border">${subAccount.reporting_tag}</span>` : '<span class="text-muted"></span>'}
                        </td>
                        <td class="text-nowrap">
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="viewAccount('${subAccount.id}')" title="View Details">
                                    <i class="bi bi-eye"></i>
                                </button>
                                <button class="btn btn-outline-secondary" onclick="editSubAccount('${subAccount.id}')" title="Edit Sub-Account">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="deleteSubAccount('${parentId}','${subAccount.id}','${safeName}')" title="Delete Sub-Account">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    `;
                        subAccountsList.appendChild(row);

                        if (subAccountsFallbackList) {
                            const col = document.createElement('div');
                            col.className = 'col-md-6 col-lg-4';
                            col.innerHTML = `
                            <div class="card h-100 shadow-sm border-light">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <h6 class="mb-1">${subAccount.code}</h6>
                                            <p class="mb-1 fw-semibold">${subAccount.name}</p>
                                        </div>
                                        <span class="badge bg-${getAccountTypeColor(subAccount.account_type)}">${subAccount.account_type || ''}</span>
                                    </div>
                                    <p class="mb-1 small text-muted">Reporting Tag: ${subAccount.reporting_tag || ''}</p>
                                    <div class="d-flex justify-content-between small">
                                        <span class="text-danger">Debit: ${formatCurrency(debits)}</span>
                                        <span class="text-success">Credit: ${formatCurrency(credits)}</span>
                                    </div>
                                    <div class="mt-2">
                                        <span class="fw-bold ${balanceClass}">Balance: ${formatCurrency(balance)}</span>
                                    </div>
                                    <div class="mt-3 d-flex gap-2 flex-wrap">
                                        <button class="btn btn-sm btn-outline-primary" onclick="viewAccount('${subAccount.id}')">View</button>
                                        <button class="btn btn-sm btn-outline-secondary" onclick="editSubAccount('${subAccount.id}')">Edit</button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="deleteSubAccount('${parentId}','${subAccount.id}','${safeName}')">Delete</button>
                                    </div>
                                </div>
                            </div>
                        `;
                            subAccountsFallbackList.appendChild(col);
                        }
                    });

                    document.getElementById('subAccountsTotalDebits').textContent = formatCurrency(totalDebits);
                    document.getElementById('subAccountsTotalCredits').textContent = formatCurrency(totalCredits);
                    document.getElementById('subAccountsTotalBalance').textContent = formatCurrency(totalBalance);

                    subAccountsTable.style.display = 'table';
                    subAccountsTable.classList.remove('d-none');
                    subAccountsTable.classList.add('table-loaded');
                    subAccountsTotal.style.display = 'table-footer-group';
                    noSubAccountsMessage.style.display = 'none';
                    noSubAccountsMessage.classList.add('d-none');
                    if (subAccountsFallbackList) {
                        subAccountsFallbackList.style.display = 'flex';
                        subAccountsFallbackList.classList.remove('d-none');
                    }

                    updateSubAccountSummary(subAccountsWithBalances, currency);
                    const subAccountsTabPane = document.getElementById('sub-accounts');
                    const subAccountsTabButton = document.getElementById('sub-accounts-tab');
                    const tableWrapper = subAccountsTable.closest('.table-responsive');

                    const visibilitySnapshot = {
                        parentId,
                        rowCount: subAccountsList.children.length,
                        tableDisplay: window.getComputedStyle(subAccountsTable).display,
                        tableHeight: subAccountsTable.offsetHeight,
                        tableWrapperDisplay: tableWrapper ? window.getComputedStyle(tableWrapper).display : 'n/a',
                        messageDisplay: window.getComputedStyle(noSubAccountsMessage).display,
                        fallbackDisplay: subAccountsFallbackList ? window.getComputedStyle(subAccountsFallbackList).display : 'n/a',
                        tabPaneClasses: subAccountsTabPane ? subAccountsTabPane.className : 'n/a',
                        tabButtonActive: subAccountsTabButton ? subAccountsTabButton.classList.contains('active') : 'n/a'
                    };
                    console.debug('[SubAccounts] Loaded sub-accounts:', {
                        parentId,
                        count: subAccountsWithBalances.length,
                        totals: {
                            debits: totalDebits,
                            credits: totalCredits,
                            balance: totalBalance
                        }
                    });
                    console.debug('[SubAccounts] Visibility snapshot:', visibilitySnapshot);

                    requestAnimationFrame(() => {
                        ensureSubAccountsVisibility('post-load');
                    });
                } catch (error) {
                    console.error('Error loading sub-accounts:', error);
                    setSubAccountsError(error.message || 'Unable to load sub-accounts.');
                    resetSubAccountsSection({
                        message: 'Unable to load sub-accounts. Please try again.'
                    });
                } finally {
                    const loadingRow = document.getElementById('loadingSubAccounts');
                    if (loadingRow) {
                        loadingRow.remove();
                    }
                }
            }

            async function editAccount(id) {
                try {
                    // Show loading state
                    const editForm = document.getElementById('editAccountForm');
                    if (!editForm) throw new Error('Edit form not found');

                    // Get the submit button safely
                    const submitBtn = editForm.querySelector('button[type="submit"]');
                    let originalBtnText = '';

                    // If submit button exists, update its state
                    if (submitBtn) {
                        originalBtnText = submitBtn.innerHTML;
                        submitBtn.disabled = true;
                        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Loading...';
                    }

                    // Fetch account details
                    const response = await fetch(API_CONFIG.buildUrl(`/accounting-codes/${id}`));
                    if (!response.ok) {
                        let errorMessage = 'Failed to fetch account details';
                        try {
                            const errorData = await response.json();
                            errorMessage = errorData.detail || errorMessage;
                        } catch (parseError) {
                            // If response is not JSON (e.g., HTML error page), get text content
                            const errorText = await response.text();
                            console.error('Server returned non-JSON error:', errorText);
                            errorMessage = `Server error (${response.status}): ${response.statusText}`;
                        }
                        throw new Error(errorMessage);
                    }

                    const account = await response.json();

                    // Store the original account code for validation
                    window.currentEditingAccount = account;

                    // Populate form fields
                    document.getElementById('editAccountId').value = account.id;
                    document.getElementById('editAccountCode').value = account.code;
                    document.getElementById('editAccountName').value = account.name;

                    // Load account types and set the selected one
                    await loadAccountTypes('editAccountType', account.account_type);

                    // Set category after a small delay to ensure the account type is set
                    setTimeout(() => {
                        const categorySelect = document.getElementById('editAccountCategory');
                        if (categorySelect) {
                            // Since editAccountCategory is an input field, not a select, just set the value directly
                            if (account.category) {
                                categorySelect.value = account.category;
                            }
                        }
                    }, 100);

                    // Set other fields
                    document.getElementById('editAccountIsParent').checked = account.is_parent || false;

                    // Note: Currency and reporting tag are readonly fields in this form
                    // They don't need to be set programmatically

                    // Set reporting tag if it exists
                    if (document.getElementById('editReportingTag')) {
                        document.getElementById('editReportingTag').value = account.reporting_tag || '';
                    }

                    // Show the modal
                    const editModal = new bootstrap.Modal(document.getElementById('editAccountModal'));
                    editModal.show();

                } catch (error) {
                    console.error('Error:', error);
                    notify('Error loading account details: ' + (error.message || 'Please try again'), 'danger');
                } finally {
                    // Reset button state
                    const submitBtn = document.querySelector('#editAccountForm button[type="submit"]');
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = 'Save Changes';
                    }
                }
            }

            async function saveEditedAccount() {
                try {
                    // Get form data
                    const accountId = document.getElementById('editAccountId').value;
                    const accountCode = document.getElementById('editAccountCode').value.trim();
                    const accountName = document.getElementById('editAccountName').value.trim();
                    const accountType = document.getElementById('editAccountType').value;
                    const accountCategory = document.getElementById('editAccountCategory').value;
                    const isParent = document.getElementById('editAccountIsParent').checked;
                    // Note: Currency and reporting tag are not editable in this form
                    const currency = 'BWP'; // Fixed currency
                    const reportingTag = ''; // Auto-generated

                    // Validate required fields
                    if (!accountId || !accountCode || !accountName || !accountType || !accountCategory) {
                        notify('Please fill in all required fields', 'warning');
                        return;
                    }

                    // Get the original account data
                    const originalAccount = window.currentEditingAccount;
                    if (!originalAccount) {
                        throw new Error('Cannot find original account data');
                    }

                    // Validate account code format based on whether it's a parent or sub-account
                    if (originalAccount.is_parent) {
                        // Parent account code must be 4 digits
                        if (!/^\d{4}$/.test(accountCode)) {
                            notify('Parent account code must be a 4-digit number', 'warning');
                            return;
                        }
                    } else {
                        // Sub-account code must be in format XXXX-YY
                        if (!/^\d{4}-\d{2}$/.test(accountCode)) {
                            notify('Sub-account code must be in the format XXXX-YY where XXXX is the parent code and YY is a 2-digit number', 'warning');
                            return;
                        }

                        // Verify parent code matches for sub-accounts
                        if (originalAccount.parent_id) {
                            const parentCode = accountCode.split('-')[0];
                            // Get parent code from the original account data
                            const originalParentCode = originalAccount.parent ? originalAccount.parent.code : null;

                            if (!originalParentCode) {
                                notify('Unable to determine parent account code. Please refresh the page and try again.', 'danger');
                                return;
                            }

                            if (parentCode !== originalParentCode) {
                                notify(`Sub-account code must start with the parent account code (${originalParentCode})`, 'warning');
                                return;
                            }
                        }
                    }

                    // Prepare data for API call
                    const accountData = {
                        code: accountCode,
                        name: accountName,
                        account_type: accountType,
                        category: accountCategory,
                        is_parent: isParent,
                        currency: currency,
                        reporting_tag: reportingTag || null
                    };

                    // Show loading state
                    const saveBtn = document.querySelector('#editAccountModal .btn-primary');
                    const originalBtnText = saveBtn.innerHTML;
                    saveBtn.disabled = true;
                    saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...';

                    // Call API to update accounting code
                    const response = await fetch(API_CONFIG.buildUrl(`/accounting-codes/${accountId}`), {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(accountData)
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.detail || 'Failed to update accounting code');
                    }

                    const data = await response.json();

                    // Show success message
                    notify('Account updated successfully!', 'success');

                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('editAccountModal'));
                    modal.hide();

                    // Reload accounting codes
                    loadAccountingCodes();

                } catch (error) {
                    console.error('Error:', error);
                    notify('Error updating account: ' + (error.message || 'Please check the form and try again'), 'danger');
                } finally {
                    // Reset button state
                    const saveBtn = document.querySelector('#editAccountModal .btn-primary');
                    if (saveBtn) {
                        saveBtn.disabled = false;
                        saveBtn.innerHTML = 'Save Changes';
                    }
                }
            }

            function addSubAccount(parentId) {
                console.log('addSubAccount called with parentId:', parentId);

                // Set the parent account in the dropdown
                const parentSelect = document.getElementById('parentAccount');
                if (parentSelect) {
                    parentSelect.value = parentId;
                }

                // Open the modal
                const modal = new bootstrap.Modal(document.getElementById('newSubAccountModal'));
                modal.show();

                // Load parent accounts to populate dropdown
                setTimeout(() => {
                    console.log('Loading parent accounts from addSubAccount...');
                    loadParentAccounts();
                }, 200);
            }

            function loadParentAccounts(forceRefresh = false) {
                const parentSelect = document.getElementById('parentAccount');
                if (!parentSelect) {
                    console.error('Parent select element not found!');
                    return Promise.resolve();
                }

                console.log('Loading parent accounts...');

                const populateOptions = (accounts) => {
                    const currentValue = parentSelect.value;
                    parentSelect.innerHTML = '<option value="">Select Parent Account</option>';

                    const parentAccounts = accounts.filter(acc => acc.is_parent);
                    parentAccounts.forEach(account => {
                        const option = document.createElement('option');
                        option.value = account.id;
                        option.setAttribute('data-code', account.code);
                        option.textContent = `${account.code} - ${account.name}`;
                        parentSelect.appendChild(option);
                    });

                    if (currentValue) {
                        parentSelect.value = currentValue;
                    }
                };

                if (!forceRefresh && allAccountingCodes.length > 0) {
                    populateOptions(allAccountingCodes);
                    return Promise.resolve();
                }

                return fetch(API_CONFIG.ENDPOINTS.ACCOUNTING_CODES)
                    .then(response => response.json())
                    .then(accounts => {
                        if (!Array.isArray(accounts)) {
                            throw new Error('Unexpected response format while loading parent accounts');
                        }

                        // Ensure globals stay in sync for downstream operations
                        allAccountingCodes = accounts;
                        window.allAccountingCodes = accounts;
                        window.accountingCodes = accounts;
                        accountingCodesById.clear();
                        accounts.forEach(account => accountingCodesById.set(account.id, account));
                        window.accountingCodesById = accountingCodesById;

                        populateOptions(accounts);
                    })
                    .catch(error => {
                        console.error('Error loading parent accounts:', error);
                        notify('Unable to load parent accounts: ' + error.message, 'danger');
                    });
            }

            // Transaction Details Functions
            let currentAccountTransactions = [];
            let filteredTransactions = [];
            let currentAccountCode = '';

            async function loadTransactionDetails(accountCode, accountId = null) {
                try {
                    console.log('Loading transaction details for account:', accountCode, 'ID:', accountId);
                    currentAccountCode = accountCode;

                    // Show loading state
                    document.getElementById('transactionDetailsList').innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-muted py-4">
                            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                            Loading transaction details...
                        </td>
                    </tr>
                `;

                    // If account ID not provided, find it by account code
                    if (!accountId) {
                        if (window.currentAccountData) {
                            const account = window.currentAccountData.find(acc => acc.code === accountCode);
                            if (account) {
                                accountId = account.id;
                            }
                        }

                        if (!accountId) {
                            console.warn('Account ID not found for code:', accountCode);
                            // Fallback: try to fetch all accounts to find the ID
                            try {
                                const accountsResponse = await fetch(API_CONFIG.buildUrl('/accounting-codes/'));
                                if (accountsResponse.ok) {
                                    const accountsData = await accountsResponse.json();
                                    const account = accountsData.find(acc => acc.code === accountCode);
                                    if (account) {
                                        accountId = account.id;
                                    }
                                }
                            } catch (error) {
                                console.error('Error fetching accounts to find ID:', error);
                            }
                        }

                        if (!accountId) {
                            throw new Error(`Account ID not found for account code: ${accountCode}`);
                        }
                    }

                    // Use the account-specific transactions endpoint
                    console.log('Fetching transactions for account ID:', accountId);
                    const response = await fetch(API_CONFIG.buildUrl(`/accounting-codes/${accountId}/transactions`));

                    let transactions = [];

                    if (response.ok) {
                        const data = await response.json();
                        console.log('Account transactions response:', data);

                        if (data && data.transactions && Array.isArray(data.transactions)) {
                            // Convert backend transaction format to display format
                            transactions = data.transactions.map(transaction => ({
                                date: transaction.date,
                                reference: transaction.reference || transaction.id,
                                description: transaction.description || transaction.narration || 'Transaction',
                                debit: parseFloat(transaction.debit_amount || 0),
                                credit: parseFloat(transaction.credit_amount || 0),
                                balance: parseFloat(transaction.balance_after || 0),
                                source: transaction.origin || transaction.entry_type || 'Journal Entry',
                                source_id: transaction.id
                            }));

                            // Store the API-provided totals for accurate summary display
                            window.currentAccountTotals = {
                                total_debits: data.total_debits || 0,
                                total_credits: data.total_credits || 0,
                                current_balance: data.current_balance || 0,
                                account_name: data.account_name || accountCode
                            };

                            console.log(`Loaded ${transactions.length} transactions for account ${accountCode}`);
                            console.log(`API Totals - Debits: ${data.total_debits}, Credits: ${data.total_credits}, Balance: ${data.current_balance}`);
                        } else {
                            console.log('No transactions found in response for account:', accountCode);
                            // Clear totals if no transactions
                            window.currentAccountTotals = {
                                total_debits: 0,
                                total_credits: 0,
                                current_balance: 0,
                                account_name: accountCode
                            };
                        }
                    } else if (response.status === 404) {
                        console.log('No transactions found for account:', accountCode);
                        // Clear totals for 404
                        window.currentAccountTotals = {
                            total_debits: 0,
                            total_credits: 0,
                            current_balance: 0,
                            account_name: accountCode
                        };
                    } else {
                        console.error('Error response:', response.status, response.statusText);
                        throw new Error(`Failed to fetch transactions: ${response.status} ${response.statusText}`);
                    }

                    // Transactions are already sorted by date from the backend (chronological order)
                    // We want most recent first for display
                    transactions.reverse();

                    currentAccountTransactions = transactions;
                    filteredTransactions = transactions;

                    renderTransactionDetails();
                    updateTransactionSummary();

                } catch (error) {
                    console.error('Error loading transaction details:', error);
                    document.getElementById('transactionDetailsList').innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-danger py-4">
                            <i class="bi bi-exclamation-triangle fs-1 d-block mb-2"></i>
                            Error loading transaction details: ${error.message}
                        </td>
                    </tr>
                `;
                }
            }

            function renderTransactionDetails() {
                const tbody = document.getElementById('transactionDetailsList');

                if (filteredTransactions.length === 0) {
                    tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-muted py-4">
                            <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                            No transactions found for this account
                        </td>
                    </tr>
                `;
                    return;
                }

                const currencySymbol = window.appSettings?.currency_symbol || 'P';

                tbody.innerHTML = filteredTransactions.map(transaction => {
                    const debitAmount = parseFloat(transaction.debit) || 0;
                    const creditAmount = parseFloat(transaction.credit) || 0;
                    const balance = parseFloat(transaction.balance) || 0;

                    return `
                    <tr>
                        <td>${new Date(transaction.date).toLocaleDateString()}</td>
                        <td><span class="badge bg-secondary">${transaction.reference || 'N/A'}</span></td>
                        <td>${transaction.description || 'No description'}</td>
                        <td class="text-end text-danger">${debitAmount > 0 ? `${currencySymbol} ${debitAmount.toFixed(2)}` : '-'}</td>
                        <td class="text-end text-success">${creditAmount > 0 ? `${currencySymbol} ${creditAmount.toFixed(2)}` : '-'}</td>
                        <td class="text-end fw-bold ${balance >= 0 ? 'text-success' : 'text-danger'}">${currencySymbol} ${Math.abs(balance).toFixed(2)}</td>
                        <td><span class="badge bg-info">${transaction.source}</span></td>
                    </tr>
                `;
                }).join('');
            }

            function updateTransactionSummary() {
                const currencySymbol = window.appSettings?.currency_symbol || 'P';

                // Use API-provided totals for accuracy (handles pagination, rounding, etc.)
                const apiTotals = window.currentAccountTotals || {};
                const totalDebits = apiTotals.total_debits || 0;
                const totalCredits = apiTotals.total_credits || 0;
                const netBalance = apiTotals.current_balance || 0;

                // Calculate filtered transaction counts for display
                const debitCount = filteredTransactions.filter(t => (parseFloat(t.debit) || 0) > 0).length;
                const creditCount = filteredTransactions.filter(t => (parseFloat(t.credit) || 0) > 0).length;

                // Update total amounts (from API for accuracy)
                document.getElementById('transactionTotalDebits').textContent = `${currencySymbol} ${totalDebits.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                document.getElementById('transactionTotalCredits').textContent = `${currencySymbol} ${totalCredits.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                document.getElementById('transactionNetBalance').textContent = `${currencySymbol} ${Math.abs(netBalance).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

                // Update transaction counts (from filtered display transactions)
                document.getElementById('transactionDebitCount').textContent = `${debitCount} debit transaction${debitCount !== 1 ? 's' : ''}`;
                document.getElementById('transactionCreditCount').textContent = `${creditCount} credit transaction${creditCount !== 1 ? 's' : ''}`;
                document.getElementById('transactionTotalCount').textContent = `${filteredTransactions.length} total transaction${filteredTransactions.length !== 1 ? 's' : ''} shown`;

                // Update balance color
                const balanceElement = document.getElementById('transactionNetBalance');
                balanceElement.className = `mb-0 ${netBalance >= 0 ? 'text-success' : 'text-danger'}`;

                console.log(` Transaction Summary Updated: Debits: ${totalDebits}, Credits: ${totalCredits}, Balance: ${netBalance}, Displayed: ${filteredTransactions.length} transactions`);
            }

            function refreshTransactionDetails() {
                if (currentAccountCode) {
                    loadTransactionDetails(currentAccountCode);
                }
            }

            function applyTransactionFilters() {
                const fromDate = document.getElementById('transactionFromDate').value;
                const toDate = document.getElementById('transactionToDate').value;
                const transactionType = document.getElementById('transactionTypeFilter').value;
                const minAmount = parseFloat(document.getElementById('minAmount').value) || 0;
                const maxAmount = parseFloat(document.getElementById('maxAmount').value) || Infinity;

                filteredTransactions = currentAccountTransactions.filter(transaction => {
                    const transactionDate = new Date(transaction.date);
                    const debitAmount = parseFloat(transaction.debit) || 0;
                    const creditAmount = parseFloat(transaction.credit) || 0;
                    const totalAmount = Math.max(debitAmount, creditAmount);

                    // Date filter
                    if (fromDate && transactionDate < new Date(fromDate)) return false;
                    if (toDate && transactionDate > new Date(toDate)) return false;

                    // Transaction type filter
                    if (transactionType === 'debit' && debitAmount === 0) return false;
                    if (transactionType === 'credit' && creditAmount === 0) return false;

                    // Amount filter
                    if (totalAmount < minAmount || totalAmount > maxAmount) return false;

                    return true;
                });

                renderTransactionDetails();
                updateTransactionSummary();
            }

            function clearTransactionFilters() {
                document.getElementById('transactionFromDate').value = '';
                document.getElementById('transactionToDate').value = '';
                document.getElementById('transactionTypeFilter').value = '';
                document.getElementById('minAmount').value = '';
                document.getElementById('maxAmount').value = '';

                filteredTransactions = currentAccountTransactions;
                renderTransactionDetails();
                updateTransactionSummary();
            }

            function exportTransactionDetails() {
                if (filteredTransactions.length === 0) {
                    notify('No transactions to export', 'warning');
                    return;
                }

                const currencySymbol = window.appSettings?.currency_symbol || 'P';
                const csvContent = [
                    ['Date', 'Reference', 'Description', 'Debit', 'Credit', 'Balance', 'Source'],
                    ...filteredTransactions.map(t => [
                        new Date(t.date).toLocaleDateString(),
                        t.reference || '',
                        t.description || '',
                        (parseFloat(t.debit) || 0).toFixed(2),
                        (parseFloat(t.credit) || 0).toFixed(2),
                        (parseFloat(t.balance) || 0).toFixed(2),
                        t.source
                    ])
                ].map(row => row.join(',')).join('\n');

                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `account_${currentAccountCode}_transactions.csv`;
                a.click();
                window.URL.revokeObjectURL(url);
            }

            function printTransactionDetails() {
                if (filteredTransactions.length === 0) {
                    notify('No transactions to print', 'warning');
                    return;
                }

                const currencySymbol = window.appSettings?.currency_symbol || 'P';
                const totalDebits = filteredTransactions.reduce((sum, t) => sum + (parseFloat(t.debit) || 0), 0);
                const totalCredits = filteredTransactions.reduce((sum, t) => sum + (parseFloat(t.credit) || 0), 0);

                const printContent = `
                <html>
                <head>
                    <title>Account Transaction Details - ${currentAccountCode}</title>
                    <style>
                        body { font-family: Arial, sans-serif; font-size: 12px; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f2f2f2; font-weight: bold; }
                        .text-right { text-align: right; }
                        .header { text-align: center; margin-bottom: 20px; }
                        .summary { margin-top: 20px; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h2>Account Transaction Details</h2>
                        <h3>Account Code: ${currentAccountCode}</h3>
                        <p>Report Generated: ${new Date().toLocaleString()}</p>
                    </div>

                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Reference</th>
                                <th>Description</th>
                                <th class="text-right">Debit</th>
                                <th class="text-right">Credit</th>
                                <th class="text-right">Balance</th>
                                <th>Source</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${filteredTransactions.map(t => `
                                <tr>
                                    <td>${new Date(t.date).toLocaleDateString()}</td>
                                    <td>${t.reference || 'N/A'}</td>
                                    <td>${t.description || 'No description'}</td>
                                    <td class="text-right">${(parseFloat(t.debit) || 0) > 0 ? `${currencySymbol} ${(parseFloat(t.debit) || 0).toFixed(2)}` : '-'}</td>
                                    <td class="text-right">${(parseFloat(t.credit) || 0) > 0 ? `${currencySymbol} ${(parseFloat(t.credit) || 0).toFixed(2)}` : '-'}</td>
                                    <td class="text-right">${currencySymbol} ${Math.abs(parseFloat(t.balance) || 0).toFixed(2)}</td>
                                    <td>${t.source}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>

                    <div class="summary">
                        <h4>Summary</h4>
                        <p>Total Debits: ${currencySymbol} ${totalDebits.toFixed(2)}</p>
                        <p>Total Credits: ${currencySymbol} ${totalCredits.toFixed(2)}</p>
                        <p>Net Balance: ${currencySymbol} ${Math.abs(totalDebits - totalCredits).toFixed(2)}</p>
                        <p>Total Transactions: ${filteredTransactions.length}</p>
                    </div>
                </body>
                </html>
            `;

                const printWindow = window.open('', '_blank');
                printWindow.document.write(printContent);
                printWindow.document.close();
                printWindow.print();
            }

            // Load data when page loads
            document.addEventListener('DOMContentLoaded', async function () {
                console.log('Initial DOMContentLoaded event fired');

                try {
                    // Load initial data sequentially to ensure settings and caches are ready
                    if (window.settingsLoader?.init) {
                        await window.settingsLoader.init();
                    }

                    await loadAccountingCodes();
                    await loadParentAccounts();

                    // Initialize currency displays
                    updateAllCurrencyDisplays();
                    updateCurrencyDisplayFields();

                    // Set up event listeners for account type changes
                    const accountTypeFilter = document.getElementById('accountTypeFilter');
                    if (accountTypeFilter) {
                        accountTypeFilter.addEventListener('change', function () {
                            // Load categories based on selected account type
                            loadCategoriesByAccountType(this.value, 'categoryFilter');
                            // Apply filters
                            filterAccountingCodes();
                        });
                    }

                    const categoryFilter = document.getElementById('categoryFilter');
                    if (categoryFilter) {
                        categoryFilter.addEventListener('change', function () {
                            filterAccountingCodes();
                        });
                    }

                    const searchFilter = document.getElementById('searchFilter');
                    if (searchFilter) {
                        searchFilter.addEventListener('input', function () {
                            filterAccountingCodes();
                        });
                    }

                    // Set up event listeners for dimensional filters
                    const dimensionFilter = document.getElementById('dimensionFilter');
                    if (dimensionFilter) {
                        dimensionFilter.addEventListener('change', function () {
                            filterAccountingCodes();
                        });
                    }

                    const specificDimensionFilter = document.getElementById('specificDimensionFilter');
                    if (specificDimensionFilter) {
                        specificDimensionFilter.addEventListener('change', function () {
                            filterAccountingCodes();
                        });
                    }

                    const requirementTypeFilter = document.getElementById('requirementTypeFilter');
                    if (requirementTypeFilter) {
                        requirementTypeFilter.addEventListener('change', function () {
                            filterAccountingCodes();
                        });
                    }

                    const newParentForm = document.getElementById('newParentAccountForm');
                    if (newParentForm) {
                        newParentForm.addEventListener('submit', function (e) {
                            e.preventDefault();
                            saveParentAccount();
                        });
                    }

                    // Keep parent account category dropdown in sync with type selection
                    const accountTypeEl = document.getElementById('accountType');
                    if (accountTypeEl) {
                        accountTypeEl.addEventListener('change', function () {
                            loadCategoriesByAccountType(this.value, 'accountCategory');
                        });
                    }

                    // Populate category dropdown when newParentAccountModal is shown
                    const newParentAccountModal = document.getElementById('newParentAccountModal');
                    if (newParentAccountModal) {
                        newParentAccountModal.addEventListener('shown.bs.modal', function () {
                            // If there's already a type selected, populate categories
                            const currentType = document.getElementById('accountType')?.value;
                            if (currentType) {
                                loadCategoriesByAccountType(currentType, 'accountCategory');
                            }
                        });
                    }

                    const newSubAccountForm = document.getElementById('newSubAccountForm');
                    if (newSubAccountForm) {
                        newSubAccountForm.addEventListener('submit', function (e) {
                            e.preventDefault();
                            saveSubAccount();
                        });
                    }

                    // Keep sub-account category dropdown in sync with type selection
                    const subAccountTypeEl = document.getElementById('subAccountType');
                    if (subAccountTypeEl) {
                        subAccountTypeEl.addEventListener('change', function () {
                            loadCategoriesByAccountType(this.value, 'subAccountCategory');
                        });
                    }

                    // Populate category dropdown when newSubAccountModal is shown
                    const newSubAccountModal = document.getElementById('newSubAccountModal');
                    if (newSubAccountModal) {
                        newSubAccountModal.addEventListener('shown.bs.modal', function () {
                            // If there's already a type selected, populate categories
                            const currentType = document.getElementById('subAccountType')?.value;
                            if (currentType) {
                                loadCategoriesByAccountType(currentType, 'subAccountCategory');
                            }
                        });
                    }

                    const editAccountForm = document.getElementById('editAccountForm');
                    if (editAccountForm) {
                        editAccountForm.addEventListener('submit', function (e) {
                            e.preventDefault();
                            saveEditedAccount();
                        });
                    }

                    // Keep edit sub-account category dropdown in sync with type selection
                    const editSubAccountTypeEl = document.getElementById('editSubAccountType');
                    if (editSubAccountTypeEl) {
                        editSubAccountTypeEl.addEventListener('change', function () {
                            loadCategoriesByAccountType(this.value, 'editSubAccountCategory');
                        });
                    }

                    // Populate category dropdown when editSubAccountModal is shown
                    const editSubAccountModal = document.getElementById('editSubAccountModal');
                    if (editSubAccountModal) {
                        editSubAccountModal.addEventListener('shown.bs.modal', function () {
                            // If there's already a type selected, populate categories
                            const currentType = document.getElementById('editSubAccountType')?.value;
                            if (currentType) {
                                loadCategoriesByAccountType(currentType, 'editSubAccountCategory');
                            }
                        });
                    }

                    // Initialize tooltips
                    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                    tooltipTriggerList.map(function (tooltipTriggerEl) {
                        return new bootstrap.Tooltip(tooltipTriggerEl);
                    });

                    const subAccountsTabButton = document.getElementById('sub-accounts-tab');
                    if (subAccountsTabButton) {
                        subAccountsTabButton.addEventListener('shown.bs.tab', function () {
                            ensureSubAccountsVisibility('tab-shown');
                        });
                    }

                    // Add click handler for the "Add Sub-Account" button in the view modal
                    const viewModal = document.getElementById('viewAccountModal');
                    if (viewModal) {
                        viewModal.addEventListener('shown.bs.modal', function () {
                            const addSubAccountBtn = document.getElementById('addSubAccountBtn');
                            if (addSubAccountBtn) {
                                addSubAccountBtn.addEventListener('click', function () {
                                    const accountId = this.getAttribute('data-account-id');
                                    if (accountId) {
                                        // Close view modal
                                        const modal = bootstrap.Modal.getInstance(viewModal);
                                        if (modal) modal.hide();

                                        // Open new sub-account modal after a small delay
                                        setTimeout(() => {
                                            console.log('Loading parent accounts from button click...');
                                            loadParentAccounts();
                                        }, 300);
                                    }
                                });
                            }
                        });
                    }
                } catch (error) {
                    console.error('Error initializing page:', error);
                    notify('Error initializing page: ' + (error.message || 'Please refresh the page and try again'), 'danger');
                }

                // Load parent accounts when sub-account modal is opened
                const subAccountModal = document.getElementById('newSubAccountModal');
                console.log('Sub account modal element:', subAccountModal);
                if (subAccountModal) {
                    subAccountModal.addEventListener('show.bs.modal', async function () {
                        console.log('Modal show event triggered');
                        // Add a small delay to ensure modal is fully rendered
                        await new Promise(resolve => setTimeout(resolve, 100));
                        console.log('Loading parent accounts after modal show...');
                        await loadParentAccounts();
                        // Populate categories for current selected sub-account type
                        const currentType = document.getElementById('subAccountType')?.value || '';
                        await loadCategoriesByAccountType(currentType, 'subAccountCategory');
                    });
                } else {
                    console.error('Sub account modal not found!');
                }

                // Also add event listener for the "Add Sub-Account" button at the top
                const addSubAccountBtn = document.querySelector('button[data-bs-target="#newSubAccountModal"]');
                console.log('Add Sub-Account button:', addSubAccountBtn);
                if (addSubAccountBtn) {
                    addSubAccountBtn.addEventListener('click', async function () {
                        console.log('Add Sub-Account button clicked');
                        await new Promise(resolve => setTimeout(resolve, 300));
                        console.log('Loading parent accounts from button click...');
                        await loadParentAccounts();
                        const currentType = document.getElementById('subAccountType')?.value || '';
                        await loadCategoriesByAccountType(currentType, 'subAccountCategory');
                    });
                }
            });

            // Improved alert system
            function showAlert(message, type = 'info', duration = 5000) {
                // Remove any existing alerts
                const existingAlert = document.querySelector('.custom-alert');
                if (existingAlert) {
                    existingAlert.remove();
                }

                // Create alert element
                const alertDiv = document.createElement('div');
                alertDiv.className = `alert alert-${type} alert-dismissible fade show custom-alert`;
                alertDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px; max-width: 500px;';
                alertDiv.innerHTML = `
                <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

                document.body.appendChild(alertDiv);

                // Auto-remove after duration
                if (duration > 0) {
                    setTimeout(() => {
                        if (alertDiv && alertDiv.parentNode) {
                            alertDiv.remove();
                        }
                    }, duration);
                }
            }

            // Show delete error dialog with option to cascade delete
            function showDeleteErrorDialog(accountName, errorDetail, accountId) {
                // Create modal HTML
                const modalHtml = `
                <div class="modal fade" id="deleteErrorModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="bi bi-exclamation-triangle text-warning me-2"></i>
                                    Cannot Delete Account
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <p><strong>${accountName}</strong> cannot be deleted because it has sub-accounts.</p>
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle me-2"></i>
                                    <strong>Details:</strong> ${errorDetail}
                                </div>
                                <p>You have these options:</p>
                                <ul>
                                    <li><strong>Delete sub-accounts first:</strong> Manually delete all sub-accounts, then delete this account</li>
                                    <li><strong>Cascade delete:</strong> Delete this account and all its sub-accounts at once</li>
                                </ul>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-danger" onclick="cascadeDeleteAccount('${accountId}', '${accountName.replace(/'/g, "\\'")}')">
                                    <i class="bi bi-trash me-2"></i>Cascade Delete All
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

                // Remove any existing error modal
                const existingModal = document.getElementById('deleteErrorModal');
                if (existingModal) {
                    existingModal.remove();
                }

                // Add modal to page and show it
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                const modal = new bootstrap.Modal(document.getElementById('deleteErrorModal'));
                modal.show();

                // Clean up when modal is hidden
                document.getElementById('deleteErrorModal').addEventListener('hidden.bs.modal', function () {
                    this.remove();
                });
            }

            // Cascade delete function
            function cascadeDeleteAccount(accountId, accountName) {
                const modal = bootstrap.Modal.getInstance(document.getElementById('deleteErrorModal'));
                modal.hide();

                if (!confirm(`Are you sure you want to delete "${accountName}" and ALL its sub-accounts?\n\nThis action cannot be undone.`)) {
                    return;
                }

                const url = API_CONFIG.buildUrl(`/accounting-codes/${accountId}`, { cascade: 'true' });

                showAlert('Deleting account and sub-accounts...', 'info', 0);

                fetch(url, { method: 'DELETE', headers: { 'Content-Type': 'application/json' } })
                    .then(async response => {
                        if (!response.ok) {
                            let detail = 'Failed to delete accounting code';
                            try {
                                const data = await response.json();
                                if (data && data.detail) detail = data.detail;
                            } catch (parseError) {
                                // If response is not JSON (e.g., HTML error page), get text content
                                const errorText = await response.text();
                                console.error('Server returned non-JSON error for delete:', errorText);
                                detail = `Server error (${response.status}): ${response.statusText}`;
                            }
                            throw new Error(detail + ` (HTTP ${response.status})`);
                        }
                        showAlert('Account and all sub-accounts deleted successfully', 'success');
                        loadAccountingCodes();
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showAlert('Error during cascade delete: ' + error.message, 'danger');
                    });
            }

            async function deleteSubAccount(parentId, subAccountId, subAccountName) {
                try {
                    if (!parentId || !subAccountId) {
                        throw new Error('Missing parent or sub-account identifier');
                    }

                    const nameForDisplay = subAccountName || 'this sub-account';
                    const confirmed = window.confirm(`Are you sure you want to delete ${nameForDisplay}? This action cannot be undone.`);
                    if (!confirmed) {
                        return;
                    }

                    const response = await fetch(
                        API_CONFIG.buildUrl(`/accounting-codes/${parentId}/sub-accounts/${subAccountId}`),
                        {
                            method: 'DELETE',
                            headers: { 'Content-Type': 'application/json' }
                        }
                    );

                    if (!response.ok) {
                        let detail = 'Failed to delete sub-account';
                        try {
                            const errorData = await response.json();
                            detail = errorData.detail || detail;
                        } catch (parseError) {
                            detail = `${detail} (HTTP ${response.status})`;
                        }
                        throw new Error(detail);
                    }

                    notify('Sub-account deleted successfully', 'success');
                    await loadAccountingCodes();

                    if (currentViewedAccountId === parentId) {
                        await loadSubAccounts(parentId);
                    }
                } catch (error) {
                    console.error('Error deleting sub-account:', error);
                    notify('Error deleting sub-account: ' + error.message, 'danger');
                    setSubAccountsError(error.message);
                }
            }

            // Delete account functionality
            let accountToDelete = null;

            async function deleteAccount(id, name) {
                accountToDelete = id;
                const modalEl = document.getElementById('deleteAccountModal');
                const nameEl = document.getElementById('deleteAccountName');
                const descendantsInfo = document.getElementById('deleteDescendantsInfo');
                const descendantCountText = document.getElementById('descendantCountText');
                const cascadeCheckbox = document.getElementById('confirmCascadeCheckbox');
                const deleteBtn = document.getElementById('deleteAccountBtn');
                const deleteBtnLabel = document.getElementById('deleteBtnLabel');
                const finalWarning = document.getElementById('deleteFinalWarning');

                nameEl.textContent = name;
                descendantsInfo.style.display = 'none';
                finalWarning.style.display = 'none';
                cascadeCheckbox.checked = false;
                deleteBtn.disabled = true; // enable after checks
                deleteBtnLabel.textContent = 'Delete Account';

                // Determine descendant count using already loaded accounts (if available)
                let descendantCount = 0;
                let hasChildren = false;
                if (window.allAccountingCodes && Array.isArray(window.allAccountingCodes)) {
                    const target = window.allAccountingCodes.find(a => a.id === id);
                    if (target && target.sub_accounts && target.sub_accounts.length) {
                        const stack = [...target.sub_accounts];
                        while (stack.length) {
                            const node = stack.pop();
                            descendantCount++;
                            if (node.sub_accounts && node.sub_accounts.length) {
                                stack.push(...node.sub_accounts);
                            }
                        }
                        hasChildren = descendantCount > 0;
                    }
                }

                if (hasChildren) {
                    descendantsInfo.style.display = '';
                    finalWarning.style.display = '';
                    descendantCountText.textContent = `This account has ${descendantCount} descendant sub-account${descendantCount !== 1 ? 's' : ''}.`;
                    deleteBtnLabel.textContent = 'Cascade Delete';
                    // Require checkbox confirmation
                    cascadeCheckbox.addEventListener('change', () => {
                        deleteBtn.disabled = !cascadeCheckbox.checked;
                    }, { once: true });
                } else {
                    // No children: simple delete
                    deleteBtn.disabled = false;
                    finalWarning.style.display = '';
                }

                const modal = new bootstrap.Modal(modalEl);
                modal.show();
            }

            function confirmDeleteAccount() {
                if (!accountToDelete) {
                    showAlert('No account selected for deletion', 'warning');
                    return;
                }
                const cascadeCheckbox = document.getElementById('confirmCascadeCheckbox');
                const target = window.allAccountingCodes?.find(a => a.id === accountToDelete);
                const hasChildren = target && target.sub_accounts && target.sub_accounts.length > 0;
                const cascade = hasChildren && cascadeCheckbox && cascadeCheckbox.checked;
                const url = cascade
                    ? API_CONFIG.buildUrl(`/accounting-codes/${accountToDelete}`, { cascade: 'true' })
                    : API_CONFIG.buildUrl(`/accounting-codes/${accountToDelete}`);

                // Disable the delete button during request
                const deleteBtn = document.getElementById('deleteAccountBtn');
                deleteBtn.disabled = true;
                deleteBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Deleting...';

                fetch(url, { method: 'DELETE', headers: { 'Content-Type': 'application/json' } })
                    .then(async response => {
                        if (!response.ok) {
                            let detail = 'Failed to delete accounting code';
                            try {
                                const data = await response.json();
                                if (data && data.detail) detail = data.detail;
                            } catch (parseError) {
                                // If response is not JSON (e.g., HTML error page), get text content
                                const errorText = await response.text();
                                console.error('Server returned non-JSON error for delete:', errorText);
                                detail = `Server error (${response.status}): ${response.statusText}`;
                            }

                            // Check if this is a sub-accounts error
                            if (detail.includes('sub-accounts') && detail.includes('cascade=true')) {
                                // Close the modal first
                                const modal = bootstrap.Modal.getInstance(document.getElementById('deleteAccountModal'));
                                modal.hide();

                                // Show a more user-friendly error with option to try cascade delete
                                const accountName = target ? target.name : 'this account';
                                showDeleteErrorDialog(accountName, detail, accountToDelete);
                                return;
                            }

                            throw new Error(detail + ` (HTTP ${response.status})`);
                        }
                        showAlert('Account deleted successfully', 'success');
                        const modal = bootstrap.Modal.getInstance(document.getElementById('deleteAccountModal'));
                        modal.hide();
                        accountToDelete = null;
                        loadAccountingCodes();
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showAlert('Error deleting account: ' + error.message, 'danger');
                    })
                    .finally(() => {
                        // Re-enable the delete button
                        deleteBtn.disabled = false;
                        deleteBtn.innerHTML = '<i class="bi bi-trash me-2"></i><span id="deleteBtnLabel">Delete Account</span>';
                    });
            }

            // Edit Sub-Account Functions
            function editSubAccount(accountId) {
                console.log('editSubAccount called with accountId:', accountId);

                // Find the account data
                const account = accountingCodesById.get(accountId) || allAccountingCodes.find(acc => acc.id === accountId);
                if (!account) {
                    notify('Account not found', 'danger');
                    return;
                }

                // Verify this is a sub-account
                if (!account.parent_id) {
                    notify('This function is for editing sub-accounts only', 'warning');
                    return;
                }

                // Store the account data for later use
                window.currentEditingSubAccount = account;

                // Close any open view modal first to avoid z-index/stacking issues
                const viewModalElement = document.getElementById('viewAccountModal');
                if (viewModalElement) {
                    const viewModal = bootstrap.Modal.getInstance(viewModalElement);
                    if (viewModal) {
                        viewModal.hide();
                    }
                }

                // Load parent accounts dropdown
                loadParentAccountsForEditSub().then(() => {
                    // Populate the form
                    document.getElementById('editSubAccountId').value = account.id;
                    document.getElementById('editSubParentAccount').value = account.parent_id;
                    document.getElementById('editSubAccountCode').value = account.code;
                    document.getElementById('editSubAccountName').value = account.name;
                    document.getElementById('editSubAccountType').value = account.account_type;
                    document.getElementById('editSubAccountCategory').value = account.category || '';

                    // Show the edit modal after a brief delay to ensure view modal is fully closed
                    setTimeout(() => {
                        const editModalElement = document.getElementById('editSubAccountModal');
                        if (editModalElement) {
                            const modal = new bootstrap.Modal(editModalElement);
                            modal.show();
                        } else {
                            console.error('Edit sub account modal element not found!');
                            notify('Unable to open edit modal', 'danger');
                        }
                    }, 300);
                });
            }

            function loadParentAccountsForEditSub(forceRefresh = false) {
                const parentSelect = document.getElementById('editSubParentAccount');
                if (!parentSelect) {
                    console.error('Edit sub parent select element not found!');
                    return Promise.resolve();
                }

                const populate = (accounts) => {
                    const currentValue = parentSelect.value;
                    parentSelect.innerHTML = '<option value="">Select Parent Account</option>';

                    accounts.filter(acc => acc.is_parent).forEach(account => {
                        const option = document.createElement('option');
                        option.value = account.id;
                        option.setAttribute('data-code', account.code);
                        option.textContent = `${account.code} - ${account.name}`;
                        parentSelect.appendChild(option);
                    });

                    if (currentValue) {
                        parentSelect.value = currentValue;
                    }
                };

                if (!forceRefresh && allAccountingCodes.length > 0) {
                    populate(allAccountingCodes);
                    return Promise.resolve();
                }

                return fetch(API_CONFIG.ENDPOINTS.ACCOUNTING_CODES)
                    .then(response => response.json())
                    .then(accounts => {
                        if (!Array.isArray(accounts)) {
                            throw new Error('Unexpected response format while loading parent accounts');
                        }

                        allAccountingCodes = accounts;
                        window.allAccountingCodes = accounts;
                        window.accountingCodes = accounts;
                        accountingCodesById.clear();
                        accounts.forEach(account => accountingCodesById.set(account.id, account));
                        window.accountingCodesById = accountingCodesById;

                        populate(accounts);
                    })
                    .catch(error => {
                        console.error('Error loading parent accounts for edit:', error);
                        notify('Unable to load parent accounts: ' + error.message, 'danger');
                    });
            }

            async function saveEditedSubAccount() {
                try {
                    // Get form data
                    const accountId = document.getElementById('editSubAccountId').value;
                    const parentId = document.getElementById('editSubParentAccount').value;
                    const accountCode = document.getElementById('editSubAccountCode').value.trim();
                    const accountName = document.getElementById('editSubAccountName').value.trim();
                    const accountType = document.getElementById('editSubAccountType').value;
                    const accountCategory = document.getElementById('editSubAccountCategory').value;

                    // Validate required fields
                    if (!accountId || !parentId || !accountCode || !accountName || !accountType) {
                        notify('Please fill in all required fields', 'warning');
                        return;
                    }

                    // Validate sub-account code format (XXXX-YY)
                    if (!/^\d{4}-\d{2}$/.test(accountCode)) {
                        notify('Sub-account code must be in the format XXXX-YY where XXXX is the parent code and YY is a 2-digit number', 'warning');
                        return;
                    }

                    // Get parent account to validate code consistency
                    const parentAccount = accountingCodesById.get(parentId) || allAccountingCodes.find(acc => acc.id === parentId);
                    if (!parentAccount) {
                        notify('Selected parent account not found', 'danger');
                        return;
                    }

                    // Validate that sub-account code starts with parent code
                    const parentCode = parentAccount.code;
                    if (!accountCode.startsWith(parentCode + '-')) {
                        notify(`Sub-account code must start with parent code ${parentCode}-`, 'warning');
                        return;
                    }

                    // Disable save button and show loading
                    const saveBtn = document.querySelector('#editSubAccountModal .btn-primary');
                    if (saveBtn) {
                        saveBtn.disabled = true;
                        saveBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Saving...';
                    }

                    // Prepare account data
                    const accountData = {
                        code: accountCode,
                        name: accountName,
                        account_type: accountType,
                        category: accountCategory,
                        is_parent: false,
                        parent_id: parentId
                    };

                    console.log('Updating sub-account with data:', accountData);

                    // Send PUT request
                    const response = await fetch(API_CONFIG.buildUrl(`/accounting-codes/${accountId}`), {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(accountData)
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.detail || 'Failed to update sub-account');
                    }

                    const data = await response.json();

                    // Show success message
                    notify('Sub-account updated successfully!', 'success');

                    // Close edit modal
                    const editModal = bootstrap.Modal.getInstance(document.getElementById('editSubAccountModal'));
                    if (editModal) {
                        editModal.hide();
                    }

                    // Reload accounting codes
                    await loadAccountingCodes();

                    // Optionally reopen the view modal to show updated data
                    // This provides better UX so user can see their changes
                    setTimeout(() => {
                        if (accountId) {
                            viewAccount(accountId);
                        }
                    }, 400);

                } catch (error) {
                    console.error('Error:', error);
                    notify('Error updating sub-account: ' + (error.message || 'Please check the form and try again'), 'danger');
                } finally {
                    // Reset button state
                    const saveBtn = document.querySelector('#editSubAccountModal .btn-primary');
                    if (saveBtn) {
                        saveBtn.disabled = false;
                        saveBtn.innerHTML = 'Save Changes';
                    }
                }
            }

            // Function to update all currency display fields with current settings
            function updateCurrencyDisplayFields() {
                const settings = getCurrentCurrencySettings();
                if (settings) {
                    const currencyDisplayText = `${settings.code} (${settings.name})`;

                    // Update all currency display fields by value
                    const currencyInputs = document.querySelectorAll('input[readonly][value*="BWP"]');
                    currencyInputs.forEach(input => {
                        if (input.value.includes('BWP (Botswana Pula)')) {
                            input.value = currencyDisplayText;
                        }
                    });

                    // Update view modal currency field
                    const viewCurrency = document.getElementById('viewAccountCurrency');
                    if (viewCurrency) {
                        viewCurrency.textContent = currencyDisplayText;
                    }
                }
            }

            // Test function to verify transaction modal works
            function testTransactionModal() {
                console.log('Testing transaction modal with VAT Payable account...');
                // Test with a simple alert first
                notify('Test button clicked! Now testing transaction modal...', 'info');
                viewTransactions('f9fcecc7-cc01-4fff-9fdc-24572e89a5c2');
            }

            // Alternative direct test function
            function testDirectTransactionCall() {
                console.log('Direct transaction test...');
                const modal = new bootstrap.Modal(document.getElementById('viewTransactionsModal'));
                modal.show();
                document.getElementById('transactionAccountName').textContent = 'Test Account';
                console.log('Modal should be visible now');
            }

            // Function to print Cash & Cash Equivalents PDF report
            function printCashEquivalentsReport(buttonRef) {
                const startDate = document.getElementById('reportStartDate').value;
                const endDate = document.getElementById('reportEndDate').value;

                let url = '/api/reports/cash-equivalents/pdf';
                const params = new URLSearchParams();

                if (startDate) params.append('start_date', startDate);
                if (endDate) params.append('end_date', endDate);

                if (params.toString()) {
                    url += '?' + params.toString();
                }

                // Show loading state
                const button = buttonRef instanceof HTMLElement ? buttonRef : null;
                const originalContent = button ? button.innerHTML : '';
                if (button) {
                    button.disabled = true;
                    button.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Generating PDF...';
                }

                fetch(url)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.blob();
                    })
                    .then(blob => {
                        // Create a temporary URL for the blob
                        const blobUrl = window.URL.createObjectURL(blob);

                        // Create a temporary link to download the file
                        const link = document.createElement('a');
                        link.href = blobUrl;

                        // Generate filename with date range
                        let filename = 'Cash_and_Cash_Equivalents_Report';
                        if (startDate && endDate) {
                            filename += `_${startDate}_to_${endDate}`;
                        } else if (startDate) {
                            filename += `_from_${startDate}`;
                        } else if (endDate) {
                            filename += `_until_${endDate}`;
                        } else {
                            filename += '_All_Time';
                        }
                        filename += '.pdf';

                        link.download = filename;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);

                        // Clean up the blob URL
                        window.URL.revokeObjectURL(blobUrl);

                        notify('PDF report generated successfully!', 'success');
                    })
                    .catch(error => {
                        console.error('Error generating PDF:', error);
                        notify('Error generating PDF report: ' + error.message, 'danger');
                    })
                    .finally(() => {
                        // Restore button state
                        if (button) {
                            button.disabled = false;
                            button.innerHTML = originalContent;
                        }
                    });
            }

            // Comprehensive Print Functions
            function getCompanyInfo() {
                return {
                    name: window.appSettings?.company_name || 'CNPERP System',
                    address: window.appSettings?.company_address || '',
                    phone: window.appSettings?.company_phone || '',
                    email: window.appSettings?.company_email || '',
                    currency: window.appSettings?.currency_symbol || 'P'
                };
            }

            function getPrintOptions() {
                return {
                    includeTotals: document.getElementById('includeTotals')?.checked ?? true,
                    includeDate: document.getElementById('includeDate')?.checked ?? true,
                    includeCompanyInfo: document.getElementById('includeCompanyInfo')?.checked ?? true
                };
            }

            function generatePrintHeader(title, subtitle = '') {
                const options = getPrintOptions();
                const company = getCompanyInfo();
                const now = new Date().toLocaleString();

                let header = '';

                if (options.includeCompanyInfo) {
                    header += `
                    <div class="print-header">
                        <div class="print-title">${company.name}</div>
                        <div class="print-subtitle">${company.address}</div>
                        <div class="print-subtitle">${company.phone} | ${company.email}</div>
                        <hr style="margin: 1rem 0;">
                        <div class="print-title">${title}</div>
                        ${subtitle ? `<div class="print-subtitle">${subtitle}</div>` : ''}
                        ${options.includeDate ? `<div class="print-date">Generated on: ${now}</div>` : ''}
                    </div>
                `;
                } else {
                    header += `
                    <div class="print-header">
                        <div class="print-title">${title}</div>
                        ${subtitle ? `<div class="print-subtitle">${subtitle}</div>` : ''}
                        ${options.includeDate ? `<div class="print-date">Generated on: ${now}</div>` : ''}
                    </div>
                `;
                }

                return header;
            }

            function printChartOfAccounts() {
                const company = getCompanyInfo();
                const options = getPrintOptions();

                // Get current accounts data
                const accounts = window.accountingCodes || [];

                if (accounts.length === 0) {
                    notify('No accounts available to print. Please load the data first.', 'warning');
                    return;
                }

                // Close the modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('printOptionsModal'));
                if (modal) modal.hide();

                // Group accounts by parent/child hierarchy
                const parentAccounts = accounts.filter(acc => acc.is_parent);
                const subAccounts = accounts.filter(acc => !acc.is_parent);

                let accountsHtml = '';

                parentAccounts.forEach(parent => {
                    accountsHtml += `
                    <tr class="table-primary">
                        <td><strong>${parent.code}</strong></td>
                        <td><strong>${parent.name}</strong></td>
                        <td><strong>${parent.account_type}</strong></td>
                        <td><strong>${parent.category || '-'}</strong></td>
                        <td class="text-end"><strong>${company.currency} ${(parent.balance || 0).toLocaleString(undefined, { minimumFractionDigits: 2 })}</strong></td>
                    </tr>
                `;

                    // Add sub-accounts for this parent
                    const children = subAccounts.filter(sub => sub.parent_id === parent.id);
                    children.forEach(child => {
                        accountsHtml += `
                        <tr>
                            <td style="padding-left: 2rem;">${child.code}</td>
                            <td style="padding-left: 2rem;">${child.name}</td>
                            <td>${child.account_type}</td>
                            <td>${child.category || '-'}</td>
                            <td class="text-end">${company.currency} ${(child.balance || 0).toLocaleString(undefined, { minimumFractionDigits: 2 })}</td>
                        </tr>
                    `;
                    });
                });

                // Add standalone accounts (those without parents)
                const standaloneAccounts = subAccounts.filter(acc => !acc.parent_id);
                standaloneAccounts.forEach(account => {
                    accountsHtml += `
                    <tr>
                        <td>${account.code}</td>
                        <td>${account.name}</td>
                        <td>${account.account_type}</td>
                        <td>${account.category || '-'}</td>
                        <td class="text-end">${company.currency} ${(account.balance || 0).toLocaleString(undefined, { minimumFractionDigits: 2 })}</td>
                    </tr>
                `;
                });

                const totalBalance = accounts.reduce((sum, acc) => sum + (parseFloat(acc.balance) || 0), 0);

                const printContent = `
                <html>
                <head>
                    <title>Chart of Accounts - ${company.name}</title>
                    <style>
                        body { font-family: Arial, sans-serif; font-size: 12px; margin: 0; padding: 20px; }
                        .print-header { text-align: center; margin-bottom: 2rem; border-bottom: 2px solid #000; padding-bottom: 1rem; }
                        .print-title { font-size: 1.5rem; font-weight: bold; margin-bottom: 0.5rem; }
                        .print-subtitle { font-size: 1rem; color: #666; margin-bottom: 0.25rem; }
                        .print-date { font-size: 0.9rem; color: #888; }
                        .print-table { width: 100%; border-collapse: collapse; margin-top: 1rem; font-size: 0.9rem; }
                        .print-table th, .print-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        .print-table th { background-color: #f8f9fa; font-weight: bold; }
                        .print-table .text-end { text-align: right; }
                        .table-primary td { background-color: #e7f1ff; }
                        .print-summary { margin-top: 2rem; padding-top: 1rem; border-top: 2px solid #000; }
                        .print-footer { margin-top: 2rem; text-align: center; font-size: 0.8rem; color: #666; }
                    </style>
                </head>
                <body>
                    ${generatePrintHeader('Chart of Accounts', 'Complete list of all accounts with hierarchy')}

                    <table class="print-table">
                        <thead>
                            <tr>
                                <th>Account Code</th>
                                <th>Account Name</th>
                                <th>Type</th>
                                <th>Category</th>
                                <th class="text-end">Current Balance</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${accountsHtml}
                        </tbody>
                    </table>

                    ${options.includeTotals ? `
                        <div class="print-summary">
                            <h4>Summary</h4>
                            <p><strong>Total Accounts:</strong> ${accounts.length}</p>
                            <p><strong>Parent Accounts:</strong> ${parentAccounts.length}</p>
                            <p><strong>Sub-Accounts:</strong> ${subAccounts.length}</p>
                            <p><strong>Total Balance:</strong> ${company.currency} ${totalBalance.toLocaleString(undefined, { minimumFractionDigits: 2 })}</p>
                        </div>
                    ` : ''}

                    <div class="print-footer">
                        <p>Chart of Accounts Report - ${company.name}</p>
                    </div>
                </body>
                </html>
            `;

                const printWindow = window.open('', '_blank');
                printWindow.document.write(printContent);
                printWindow.document.close();
                printWindow.print();
            }

            function printAccountBalances() {
                const company = getCompanyInfo();
                const options = getPrintOptions();

                // Get current accounts data
                const accounts = window.accountingCodes || [];

                if (accounts.length === 0) {
                    notify('No accounts available to print. Please load the data first.', 'warning');
                    return;
                }

                // Close the modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('printOptionsModal'));
                if (modal) modal.hide();

                // Sort accounts by type and code
                const sortedAccounts = [...accounts].sort((a, b) => {
                    if (a.account_type !== b.account_type) {
                        return a.account_type.localeCompare(b.account_type);
                    }
                    return a.code.localeCompare(b.code);
                });

                let accountsHtml = '';
                let currentType = '';
                let typeTotal = 0;
                let grandTotalDebits = 0;
                let grandTotalCredits = 0;
                let grandTotalBalance = 0;

                sortedAccounts.forEach((account, index) => {
                    // Add type header
                    if (account.account_type !== currentType) {
                        if (currentType !== '' && options.includeTotals) {
                            accountsHtml += `
                            <tr class="table-secondary">
                                <td colspan="3"><strong>Subtotal - ${currentType}:</strong></td>
                                <td class="text-end"><strong>${company.currency} ${typeTotal.toLocaleString(undefined, { minimumFractionDigits: 2 })}</strong></td>
                            </tr>
                        `;
                        }
                        currentType = account.account_type;
                        typeTotal = 0;
                        accountsHtml += `
                        <tr class="table-primary">
                            <td colspan="4"><strong>${currentType.toUpperCase()}</strong></td>
                        </tr>
                    `;
                    }

                    const debits = parseFloat(account.total_debits) || 0;
                    const credits = parseFloat(account.total_credits) || 0;
                    const balance = parseFloat(account.balance) || 0;

                    typeTotal += balance;
                    grandTotalDebits += debits;
                    grandTotalCredits += credits;
                    grandTotalBalance += balance;

                    accountsHtml += `
                    <tr>
                        <td>${account.code}</td>
                        <td>${account.name}</td>
                        <td class="text-end">${company.currency} ${debits.toLocaleString(undefined, { minimumFractionDigits: 2 })}</td>
                        <td class="text-end">${company.currency} ${credits.toLocaleString(undefined, { minimumFractionDigits: 2 })}</td>
                        <td class="text-end">${company.currency} ${Math.abs(balance).toLocaleString(undefined, { minimumFractionDigits: 2 })}</td>
                    </tr>
                `;

                    // Add final subtotal
                    if (index === sortedAccounts.length - 1 && options.includeTotals) {
                        accountsHtml += `
                        <tr class="table-secondary">
                            <td colspan="4"><strong>Subtotal - ${currentType}:</strong></td>
                            <td class="text-end"><strong>${company.currency} ${typeTotal.toLocaleString(undefined, { minimumFractionDigits: 2 })}</strong></td>
                        </tr>
                    `;
                    }
                });

                const printContent = `
                <html>
                <head>
                    <title>Account Balances Report - ${company.name}</title>
                    <style>
                        body { font-family: Arial, sans-serif; font-size: 12px; margin: 0; padding: 20px; }
                        .print-header { text-align: center; margin-bottom: 2rem; border-bottom: 2px solid #000; padding-bottom: 1rem; }
                        .print-title { font-size: 1.5rem; font-weight: bold; margin-bottom: 0.5rem; }
                        .print-subtitle { font-size: 1rem; color: #666; margin-bottom: 0.25rem; }
                        .print-date { font-size: 0.9rem; color: #888; }
                        .print-table { width: 100%; border-collapse: collapse; margin-top: 1rem; font-size: 0.9rem; }
                        .print-table th, .print-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        .print-table th { background-color: #f8f9fa; font-weight: bold; }
                        .print-table .text-end { text-align: right; }
                        .table-primary td { background-color: #e7f1ff; font-weight: bold; }
                        .table-secondary td { background-color: #f8f9fa; font-weight: bold; }
                        .print-summary { margin-top: 2rem; padding-top: 1rem; border-top: 2px solid #000; }
                        .print-footer { margin-top: 2rem; text-align: center; font-size: 0.8rem; color: #666; }
                    </style>
                </head>
                <body>
                    ${generatePrintHeader('Account Balances Report', 'Current balances for all accounts grouped by type')}

                    <table class="print-table">
                        <thead>
                            <tr>
                                <th>Code</th>
                                <th>Account Name</th>
                                <th class="text-end">Total Debits</th>
                                <th class="text-end">Total Credits</th>
                                <th class="text-end">Balance</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${accountsHtml}
                        </tbody>
                    </table>

                    ${options.includeTotals ? `
                        <div class="print-summary">
                            <h4>Grand Totals</h4>
                            <table class="print-table" style="width: 60%; margin: 0 auto;">
                                <tr>
                                    <td><strong>Total Debits:</strong></td>
                                    <td class="text-end"><strong>${company.currency} ${grandTotalDebits.toLocaleString(undefined, { minimumFractionDigits: 2 })}</strong></td>
                                </tr>
                                <tr>
                                    <td><strong>Total Credits:</strong></td>
                                    <td class="text-end"><strong>${company.currency} ${grandTotalCredits.toLocaleString(undefined, { minimumFractionDigits: 2 })}</strong></td>
                                </tr>
                                <tr>
                                    <td><strong>Net Balance:</strong></td>
                                    <td class="text-end"><strong>${company.currency} ${Math.abs(grandTotalBalance).toLocaleString(undefined, { minimumFractionDigits: 2 })}</strong></td>
                                </tr>
                                <tr>
                                    <td><strong>Total Accounts:</strong></td>
                                    <td class="text-end"><strong>${accounts.length}</strong></td>
                                </tr>
                            </table>
                        </div>
                    ` : ''}

                    <div class="print-footer">
                        <p>Account Balances Report - ${company.name}</p>
                    </div>
                </body>
                </html>
            `;

                const printWindow = window.open('', '_blank');
                printWindow.document.write(printContent);
                printWindow.document.close();
                printWindow.print();
            }

            function printFilteredAccounts() {
                const company = getCompanyInfo();
                const options = getPrintOptions();

                // Get currently displayed/filtered accounts
                const visibleRows = document.querySelectorAll('#accountingCodesTable tbody tr:not([style*="display: none"])');

                if (visibleRows.length === 0) {
                    notify('No accounts are currently visible to print. Please adjust your filters.', 'warning');
                    return;
                }

                // Close the modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('printOptionsModal'));
                if (modal) modal.hide();

                let accountsHtml = '';
                let totalBalance = 0;

                visibleRows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    if (cells.length >= 5) {
                        const code = cells[0].textContent.trim();
                        const name = cells[1].textContent.trim();
                        const type = cells[2].textContent.trim();
                        const category = cells[3].textContent.trim();
                        const balanceText = cells[4].textContent.trim();

                        // Extract numeric balance
                        const balanceMatch = balanceText.match(/([\d,.-]+)/);
                        const balance = balanceMatch ? parseFloat(balanceMatch[1].replace(/,/g, '')) : 0;
                        totalBalance += balance;

                        accountsHtml += `
                        <tr>
                            <td>${code}</td>
                            <td>${name}</td>
                            <td>${type}</td>
                            <td>${category}</td>
                            <td class="text-end">${balanceText}</td>
                        </tr>
                    `;
                    }
                });

                // Get current filter values for subtitle
                const searchFilter = document.getElementById('searchFilter')?.value || '';
                const typeFilter = document.getElementById('accountTypeFilter')?.value || '';
                const categoryFilter = document.getElementById('categoryFilter')?.value || '';

                let filterDescription = 'Showing ';
                const filters = [];
                if (searchFilter) filters.push(`search: "${searchFilter}"`);
                if (typeFilter) filters.push(`type: "${typeFilter}"`);
                if (categoryFilter) filters.push(`category: "${categoryFilter}"`);

                if (filters.length > 0) {
                    filterDescription += filters.join(', ');
                } else {
                    filterDescription += 'all accounts';
                }

                const printContent = `
                <html>
                <head>
                    <title>Filtered Account List - ${company.name}</title>
                    <style>
                        body { font-family: Arial, sans-serif; font-size: 12px; margin: 0; padding: 20px; }
                        .print-header { text-align: center; margin-bottom: 2rem; border-bottom: 2px solid #000; padding-bottom: 1rem; }
                        .print-title { font-size: 1.5rem; font-weight: bold; margin-bottom: 0.5rem; }
                        .print-subtitle { font-size: 1rem; color: #666; margin-bottom: 0.25rem; }
                        .print-date { font-size: 0.9rem; color: #888; }
                        .print-table { width: 100%; border-collapse: collapse; margin-top: 1rem; font-size: 0.9rem; }
                        .print-table th, .print-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        .print-table th { background-color: #f8f9fa; font-weight: bold; }
                        .print-table .text-end { text-align: right; }
                        .print-summary { margin-top: 2rem; padding-top: 1rem; border-top: 2px solid #000; }
                        .print-footer { margin-top: 2rem; text-align: center; font-size: 0.8rem; color: #666; }
                        .filter-info { background-color: #f8f9fa; padding: 1rem; margin-bottom: 1rem; border-left: 4px solid #007bff; }
                    </style>
                </head>
                <body>
                    ${generatePrintHeader('Filtered Account List', filterDescription)}

                    <div class="filter-info">
                        <strong>Filter Applied:</strong> ${filterDescription}
                    </div>

                    <table class="print-table">
                        <thead>
                            <tr>
                                <th>Code</th>
                                <th>Account Name</th>
                                <th>Type</th>
                                <th>Category</th>
                                <th class="text-end">Balance</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${accountsHtml}
                        </tbody>
                    </table>

                    ${options.includeTotals ? `
                        <div class="print-summary">
                            <h4>Summary</h4>
                            <p><strong>Total Filtered Accounts:</strong> ${visibleRows.length}</p>
                            <p><strong>Combined Balance:</strong> ${company.currency} ${totalBalance.toLocaleString(undefined, { minimumFractionDigits: 2 })}</p>
                        </div>
                    ` : ''}

                    <div class="print-footer">
                        <p>Filtered Account List - ${company.name}</p>
                    </div>
                </body>
                </html>
            `;

                const printWindow = window.open('', '_blank');
                printWindow.document.write(printContent);
                printWindow.document.close();
                printWindow.print();
            }

            function printAccountSummaryByType() {
                const company = getCompanyInfo();
                const options = getPrintOptions();

                // Get current accounts data
                const accounts = window.accountingCodes || [];

                if (accounts.length === 0) {
                    notify('No accounts available to print. Please load the data first.', 'warning');
                    return;
                }

                // Close the modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('printOptionsModal'));
                if (modal) modal.hide();

                // Group accounts by type
                const accountsByType = {};
                let grandTotal = 0;

                accounts.forEach(account => {
                    const type = account.account_type || 'Unspecified';
                    if (!accountsByType[type]) {
                        accountsByType[type] = {
                            accounts: [],
                            totalBalance: 0,
                            totalDebits: 0,
                            totalCredits: 0,
                            count: 0
                        };
                    }

                    const balance = parseFloat(account.balance) || 0;
                    const debits = parseFloat(account.total_debits) || 0;
                    const credits = parseFloat(account.total_credits) || 0;

                    accountsByType[type].accounts.push(account);
                    accountsByType[type].totalBalance += balance;
                    accountsByType[type].totalDebits += debits;
                    accountsByType[type].totalCredits += credits;
                    accountsByType[type].count++;
                    grandTotal += balance;
                });

                let summaryHtml = '';
                Object.keys(accountsByType).sort().forEach(type => {
                    const typeData = accountsByType[type];
                    summaryHtml += `
                    <tr class="table-primary">
                        <td><strong>${type}</strong></td>
                        <td class="text-end"><strong>${typeData.count}</strong></td>
                        <td class="text-end"><strong>${company.currency} ${typeData.totalDebits.toLocaleString(undefined, { minimumFractionDigits: 2 })}</strong></td>
                        <td class="text-end"><strong>${company.currency} ${typeData.totalCredits.toLocaleString(undefined, { minimumFractionDigits: 2 })}</strong></td>
                        <td class="text-end"><strong>${company.currency} ${Math.abs(typeData.totalBalance).toLocaleString(undefined, { minimumFractionDigits: 2 })}</strong></td>
                    </tr>
                `;
                });

                const printContent = `
                <html>
                <head>
                    <title>Account Summary by Type - ${company.name}</title>
                    <style>
                        body { font-family: Arial, sans-serif; font-size: 12px; margin: 0; padding: 20px; }
                        .print-header { text-align: center; margin-bottom: 2rem; border-bottom: 2px solid #000; padding-bottom: 1rem; }
                        .print-title { font-size: 1.5rem; font-weight: bold; margin-bottom: 0.5rem; }
                        .print-subtitle { font-size: 1rem; color: #666; margin-bottom: 0.25rem; }
                        .print-date { font-size: 0.9rem; color: #888; }
                        .print-table { width: 100%; border-collapse: collapse; margin-top: 1rem; font-size: 0.9rem; }
                        .print-table th, .print-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        .print-table th { background-color: #f8f9fa; font-weight: bold; }
                        .print-table .text-end { text-align: right; }
                        .table-primary td { background-color: #e7f1ff; }
                        .print-summary { margin-top: 2rem; padding-top: 1rem; border-top: 2px solid #000; }
                        .print-footer { margin-top: 2rem; text-align: center; font-size: 0.8rem; color: #666; }
                    </style>
                </head>
                <body>
                    ${generatePrintHeader('Account Summary by Type', 'Summary of accounts grouped by account type')}

                    <table class="print-table">
                        <thead>
                            <tr>
                                <th>Account Type</th>
                                <th class="text-end">Count</th>
                                <th class="text-end">Total Debits</th>
                                <th class="text-end">Total Credits</th>
                                <th class="text-end">Net Balance</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${summaryHtml}
                        </tbody>
                    </table>

                    ${options.includeTotals ? `
                        <div class="print-summary">
                            <h4>Overall Summary</h4>
                            <table class="print-table" style="width: 60%; margin: 0 auto;">
                                <tr>
                                    <td><strong>Total Account Types:</strong></td>
                                    <td class="text-end"><strong>${Object.keys(accountsByType).length}</strong></td>
                                </tr>
                                <tr>
                                    <td><strong>Total Accounts:</strong></td>
                                    <td class="text-end"><strong>${accounts.length}</strong></td>
                                </tr>
                                <tr>
                                    <td><strong>Grand Total Balance:</strong></td>
                                    <td class="text-end"><strong>${company.currency} ${Math.abs(grandTotal).toLocaleString(undefined, { minimumFractionDigits: 2 })}</strong></td>
                                </tr>
                            </table>
                        </div>
                    ` : ''}

                    <div class="print-footer">
                        <p>Account Summary by Type - ${company.name}</p>
                    </div>
                </body>
                </html>
            `;

                const printWindow = window.open('', '_blank');
                printWindow.document.write(printContent);
                printWindow.document.close();
                printWindow.print();
            }

            // Update dimensional statistics when page loads
            document.addEventListener('DOMContentLoaded', function () {
                // Call after other initialization is complete
                setTimeout(() => {
                    updateDimensionalStatistics();
                }, 1000);
            });

            // ===== BULK DIMENSION SETTINGS =====

            // Manage Cost Centers
            function manageCostCenters() {
                showDimensionModal('FUNCTIONAL', 'Cost Centers', 'Manage cost centers for expense tracking and organizational analysis');
            }

            // Manage Projects
            function manageProjects() {
                showDimensionModal('PROJECT', 'Projects', 'Manage projects for revenue and expense tracking across initiatives');
            }

            // Show bulk dimension settings
            function showBulkDimensionSettings() {
                showBulkDimensionModal();
            }

            // Show bulk dimension settings modal
            function showBulkDimensionModal() {
                const modalHtml = `
                    <div class="modal fade" id="bulkDimensionModal" tabindex="-1">
                        <div class="modal-dialog modal-xl">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">
                                        <i class="bi bi-gear-wide me-2"></i>Bulk Dimension Settings
                                    </h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="alert alert-warning">
                                        <i class="bi bi-exclamation-triangle me-2"></i>
                                        <strong>Enterprise Feature:</strong> Apply dimension requirements to multiple accounts
                                        simultaneously. Use with caution as this affects multiple accounting codes.
                                    </div>

                                    <!-- Account Type Selection -->
                                    <div class="mb-4">
                                        <label class="form-label fw-bold">Apply to Account Types</label>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="bulkIncomeAccounts" value="Revenue">
                                                    <label class="form-check-label" for="bulkIncomeAccounts">
                                                        <i class="bi bi-arrow-up-circle text-success me-1"></i>Revenue Accounts
                                                    </label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="bulkExpenseAccounts" value="Expense">
                                                    <label class="form-check-label" for="bulkExpenseAccounts">
                                                        <i class="bi bi-arrow-down-circle text-danger me-1"></i>Expense Accounts
                                                    </label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="bulkAssetAccounts" value="Asset">
                                                    <label class="form-check-label" for="bulkAssetAccounts">
                                                        <i class="bi bi-building text-primary me-1"></i>Asset Accounts
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="bulkLiabilityAccounts" value="Liability">
                                                    <label class="form-check-label" for="bulkLiabilityAccounts">
                                                        <i class="bi bi-credit-card text-warning me-1"></i>Liability Accounts
                                                    </label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="bulkEquityAccounts" value="Equity">
                                                    <label class="form-check-label" for="bulkEquityAccounts">
                                                        <i class="bi bi-pie-chart text-info me-1"></i>Equity Accounts
                                                    </label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="bulkAllAccounts">
                                                    <label class="form-check-label" for="bulkAllAccounts">
                                                        <strong>All Account Types</strong>
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Dimension Requirements -->
                                    <div class="mb-4">
                                        <label class="form-label fw-bold">
                                            <i class="bi bi-layers me-1"></i>Dimension Requirements to Apply
                                        </label>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="card">
                                                    <div class="card-header">
                                                        <h6 class="mb-0">
                                                            <i class="bi bi-building me-1"></i>Cost Center
                                                        </h6>
                                                    </div>
                                                    <div class="card-body">
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="radio" name="bulkCostCenter"
                                                                   id="bulkCostCenterNone" value="none" checked>
                                                            <label class="form-check-label" for="bulkCostCenterNone">
                                                                No Change
                                                            </label>
                                                        </div>
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="radio" name="bulkCostCenter"
                                                                   id="bulkCostCenterRequired" value="required">
                                                            <label class="form-check-label" for="bulkCostCenterRequired">
                                                                <strong>Required</strong>
                                                            </label>
                                                        </div>
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="radio" name="bulkCostCenter"
                                                                   id="bulkCostCenterOptional" value="optional">
                                                            <label class="form-check-label" for="bulkCostCenterOptional">
                                                                Optional
                                                            </label>
                                                        </div>
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="radio" name="bulkCostCenter"
                                                                   id="bulkCostCenterRemove" value="remove">
                                                            <label class="form-check-label" for="bulkCostCenterRemove">
                                                                Remove Requirement
                                                            </label>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="card">
                                                    <div class="card-header">
                                                        <h6 class="mb-0">
                                                            <i class="bi bi-kanban me-1"></i>Project
                                                        </h6>
                                                    </div>
                                                    <div class="card-body">
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="radio" name="bulkProject"
                                                                   id="bulkProjectNone" value="none" checked>
                                                            <label class="form-check-label" for="bulkProjectNone">
                                                                No Change
                                                            </label>
                                                        </div>
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="radio" name="bulkProject"
                                                                   id="bulkProjectRequired" value="required">
                                                            <label class="form-check-label" for="bulkProjectRequired">
                                                                <strong>Required</strong>
                                                            </label>
                                                        </div>
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="radio" name="bulkProject"
                                                                   id="bulkProjectOptional" value="optional">
                                                            <label class="form-check-label" for="bulkProjectOptional">
                                                                Optional
                                                            </label>
                                                        </div>
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="radio" name="bulkProject"
                                                                   id="bulkProjectRemove" value="remove">
                                                            <label class="form-check-label" for="bulkProjectRemove">
                                                                Remove Requirement
                                                            </label>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Preview -->
                                    <div class="mb-4">
                                        <label class="form-label fw-bold">Preview Affected Accounts</label>
                                        <div id="bulkPreviewContainer">
                                            <div class="text-muted">
                                                <i class="bi bi-info-circle me-1"></i>
                                                Select account types above to see which accounts will be affected
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                    <button type="button" class="btn btn-info" onclick="previewBulkDimensionChanges()">
                                        <i class="bi bi-eye me-1"></i>Preview Changes
                                    </button>
                                    <button type="button" class="btn btn-warning" onclick="applyBulkDimensionSettings()">
                                        <i class="bi bi-gear-wide me-1"></i>Apply Bulk Settings
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // Remove existing modal
                const existingModal = document.getElementById('bulkDimensionModal');
                if (existingModal) {
                    existingModal.remove();
                }

                // Add and show modal
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                const modal = new bootstrap.Modal(document.getElementById('bulkDimensionModal'));
                modal.show();

                // Add event listeners
                setupBulkDimensionModalListeners();

                // Clean up when hidden
                document.getElementById('bulkDimensionModal').addEventListener('hidden.bs.modal', function () {
                    this.remove();
                });
            }

            // Setup bulk dimension modal event listeners
            function setupBulkDimensionModalListeners() {
                // Account type checkboxes
                const accountTypeCheckboxes = [
                    'bulkIncomeAccounts', 'bulkExpenseAccounts', 'bulkAssetAccounts',
                    'bulkLiabilityAccounts', 'bulkEquityAccounts'
                ];

                accountTypeCheckboxes.forEach(id => {
                    document.getElementById(id).addEventListener('change', updateBulkPreview);
                });

                // All accounts checkbox
                document.getElementById('bulkAllAccounts').addEventListener('change', function () {
                    const checked = this.checked;
                    accountTypeCheckboxes.forEach(id => {
                        document.getElementById(id).checked = checked;
                    });
                    updateBulkPreview();
                });

                // Dimension requirement radios
                const dimensionRadios = document.querySelectorAll('input[name="bulkCostCenter"], input[name="bulkProject"]');
                dimensionRadios.forEach(radio => {
                    radio.addEventListener('change', updateBulkPreview);
                });
            }

            // Update bulk preview
            function updateBulkPreview() {
                const selectedAccountTypes = getSelectedAccountTypes();
                const container = document.getElementById('bulkPreviewContainer');

                if (selectedAccountTypes.length === 0) {
                    container.innerHTML = `
                        <div class="text-muted">
                            <i class="bi bi-info-circle me-1"></i>
                            Select account types above to see which accounts will be affected
                        </div>
                    `;
                    return;
                }

                // Filter accounts by selected types
                const affectedAccounts = allAccountingCodes.filter(account =>
                    selectedAccountTypes.includes(account.account_type) ||
                    selectedAccountTypes.includes('All')
                );

                if (affectedAccounts.length === 0) {
                    container.innerHTML = `
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle me-1"></i>
                            No accounts found for the selected account types
                        </div>
                    `;
                    return;
                }

                // Show preview
                let html = `
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle me-1"></i>
                        <strong>${affectedAccounts.length}</strong> accounts will be affected by this bulk operation
                    </div>
                    <div class="table-responsive" style="max-height: 200px; overflow-y: auto;">
                        <table class="table table-sm table-hover">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th>Code</th>
                                    <th>Name</th>
                                    <th>Type</th>
                                    <th>Current Dimensions</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                affectedAccounts.forEach(account => {
                    const requirements = accountDimensionRequirements.get(account.id) || [];
                    const reqText = requirements.length > 0 ?
                        requirements.map(r => `${r.dimension_name} (${r.is_required ? 'Required' : 'Optional'})`).join(', ') :
                        'None';

                    html += `
                        <tr>
                            <td><code>${account.code}</code></td>
                            <td>${account.name}</td>
                            <td><span class="badge bg-secondary">${account.account_type}</span></td>
                            <td><small>${reqText}</small></td>
                        </tr>
                    `;
                });

                html += `
                            </tbody>
                        </table>
                    </div>
                `;

                container.innerHTML = html;
            }

            // Get selected account types
            function getSelectedAccountTypes() {
                const types = [];
                const accountTypeMap = {
                    'bulkIncomeAccounts': 'Revenue',
                    'bulkExpenseAccounts': 'Expense',
                    'bulkAssetAccounts': 'Asset',
                    'bulkLiabilityAccounts': 'Liability',
                    'bulkEquityAccounts': 'Equity'
                };

                if (document.getElementById('bulkAllAccounts').checked) {
                    return ['All'];
                }

                Object.entries(accountTypeMap).forEach(([id, type]) => {
                    if (document.getElementById(id).checked) {
                        types.push(type);
                    }
                });

                return types;
            }

            // Preview bulk dimension changes
            function previewBulkDimensionChanges() {
                updateBulkPreview();
                notify('Preview updated. Review the affected accounts below.', 'info');
            }

            // Apply bulk dimension settings
            async function applyBulkDimensionSettings() {
                const selectedAccountTypes = getSelectedAccountTypes();

                if (selectedAccountTypes.length === 0) {
                    notify('Please select at least one account type', 'warning');
                    return;
                }

                const costCenterSetting = document.querySelector('input[name="bulkCostCenter"]:checked').value;
                const projectSetting = document.querySelector('input[name="bulkProject"]:checked').value;

                if (costCenterSetting === 'none' && projectSetting === 'none') {
                    notify('Please select at least one dimension setting to apply', 'warning');
                    return;
                }

                // Confirm the operation
                const affectedAccounts = allAccountingCodes.filter(account =>
                    selectedAccountTypes.includes(account.account_type) ||
                    selectedAccountTypes.includes('All')
                );

                if (!confirm(`This will modify dimension requirements for ${affectedAccounts.length} accounts. Continue?`)) {
                    return;
                }

                try {
                    // Apply to each account
                    for (const account of affectedAccounts) {
                        if (costCenterSetting !== 'none') {
                            await applyDimensionSettingToAccount(account.id, 'FUNCTIONAL', costCenterSetting);
                        }
                        if (projectSetting !== 'none') {
                            await applyDimensionSettingToAccount(account.id, 'PROJECT', projectSetting);
                        }
                    }

                    notify(`Bulk dimension settings applied to ${affectedAccounts.length} accounts`, 'success');

                    // Close modal and refresh
                    const modal = bootstrap.Modal.getInstance(document.getElementById('bulkDimensionModal'));
                    modal.hide();

                    // Refresh requirements
                    await loadAllDimensionRequirements();
                    filterAccountingCodes();

                } catch (error) {
                    console.error('Error applying bulk dimension settings:', error);
                    notify('Error applying bulk settings: ' + error.message, 'danger');
                }
            }

            // Apply dimension setting to a single account
            async function applyDimensionSettingToAccount(accountId, dimensionType, setting) {
                if (setting === 'none') return;

                // Find the dimension
                const dimension = availableDimensions.find(d => d.dimension_type === dimensionType);
                if (!dimension) {
                    throw new Error(`${dimensionType} dimension not found`);
                }

                if (setting === 'remove') {
                    // Remove requirement
                    const currentReqs = accountDimensionRequirements.get(accountId) || [];
                    const existingReq = currentReqs.find(r => r.dimension_id === dimension.id);

                    if (existingReq) {
                        const response = await fetch(`/api/v1/accounting/codes/${accountId}/dimension-requirements/${existingReq.id}`, {
                            method: 'DELETE'
                        });

                        if (!response.ok) {
                            throw new Error(`Failed to remove ${dimensionType} requirement`);
                        }
                    }
                } else {
                    // Add or update requirement
                    const isRequired = setting === 'required';

                    const requirementData = {
                        dimension_id: dimension.id,
                        is_required: isRequired,
                        priority_order: isRequired ? 1 : 2
                    };

                    // Check if requirement already exists
                    const currentReqs = accountDimensionRequirements.get(accountId) || [];
                    const existingReq = currentReqs.find(r => r.dimension_id === dimension.id);

                    if (existingReq) {
                        // Update existing
                        const response = await fetch(`/api/v1/accounting/codes/${accountId}/dimension-requirements/${existingReq.id}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(requirementData)
                        });

                        if (!response.ok) {
                            throw new Error(`Failed to update ${dimensionType} requirement`);
                        }
                    } else {
                        // Create new
                        const response = await fetch(`/api/v1/accounting/codes/${accountId}/dimension-requirements`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(requirementData)
                        });

                        if (!response.ok) {
                            throw new Error(`Failed to create ${dimensionType} requirement`);
                        }
                    }
                }
            }

            // Show bulk dimension settings
            function showBulkDimensionSettings() {
                showBulkDimensionModal();
            }

            // Show dimension management modal
            function showDimensionModal(dimensionType, title, description) {
                const modalHtml = `
                    <div class="modal fade" id="dimensionManagementModal" tabindex="-1">
                        <div class="modal-dialog modal-xl">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">
                                        <i class="bi bi-${dimensionType === 'FUNCTIONAL' ? 'building' : 'kanban'} me-2"></i>
                                        ${title} Management
                                    </h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="alert alert-info">
                                        <i class="bi bi-info-circle me-2"></i>
                                        ${description}
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h6>Active ${title}</h6>
                                        <button class="btn btn-primary btn-sm" onclick="addNewDimensionValue('${dimensionType}')">
                                            <i class="bi bi-plus-circle me-1"></i>Add New ${dimensionType === 'FUNCTIONAL' ? 'Cost Center' : 'Project'}
                                        </button>
                                    </div>
                                    <div id="dimensionValuesList">
                                        <div class="text-center py-4">
                                            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                            Loading ${title.toLowerCase()}...
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                    <button type="button" class="btn btn-success" onclick="applyDimensionToAccounts('${dimensionType}')">
                                        <i class="bi bi-check-all me-1"></i>Apply to Accounts
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // Remove existing modal
                const existingModal = document.getElementById('dimensionManagementModal');
                if (existingModal) {
                    existingModal.remove();
                }

                // Add and show modal
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                const modal = new bootstrap.Modal(document.getElementById('dimensionManagementModal'));
                modal.show();

                // Load dimension values
                loadDimensionValuesByType(dimensionType);

                // Clean up when hidden
                document.getElementById('dimensionManagementModal').addEventListener('hidden.bs.modal', function () {
                    this.remove();
                });
            }

            // Load dimension values by type
            async function loadDimensionValuesByType(dimensionType) {
                try {
                    // First get the dimension
                    const dimensionsResponse = await fetch('/api/v1/accounting/dimensions');
                    if (!dimensionsResponse.ok) {
                        throw new Error('Failed to load dimensions');
                    }

                    const dimensions = await dimensionsResponse.json();

                    // Map dimension types to existing dimension codes
                    let dimension;
                    if (dimensionType === 'FUNCTIONAL') {
                        // Look for organizational dimension (departments/cost centers)
                        dimension = dimensions.find(d => d.dimension_type === 'organizational' || d.code === 'DEPT');
                    } else if (dimensionType === 'PROJECT') {
                        // Look for project dimension
                        dimension = dimensions.find(d => d.dimension_type === 'project' || d.code === 'PROJ');
                    } else {
                        // Fallback to exact match
                        const targetType = dimensionType.toLowerCase();
                        dimension = dimensions.find(d => d.dimension_type === targetType);
                    }

                    if (!dimension) {
                        throw new Error(`No dimension found for type: ${dimensionType}. Available dimensions: ${dimensions.map(d => `${d.code}(${d.dimension_type})`).join(', ')}`);
                    }

                    // Load values for this dimension
                    const valuesResponse = await fetch(`/api/v1/accounting/dimensions/${dimension.id}/values`);
                    if (!valuesResponse.ok) {
                        throw new Error('Failed to load dimension values');
                    }

                    const values = await valuesResponse.json();
                    displayDimensionValues(dimension, values);

                } catch (error) {
                    console.error('Error loading dimension values:', error);
                    document.getElementById('dimensionValuesList').innerHTML = `
                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            Error loading dimension values: ${error.message}
                        </div>
                    `;
                }
            }

            // Add new dimension value
            async function addNewDimensionValue(dimensionType) {
                // Create a simple prompt modal
                const code = prompt(`Enter ${dimensionType === 'FUNCTIONAL' ? 'Cost Center' : 'Project'} Code:`);
                if (!code) return;

                const name = prompt(`Enter ${dimensionType === 'FUNCTIONAL' ? 'Cost Center' : 'Project'} Name:`);
                if (!name) return;

                try {
                    // Find the dimension ID
                    const dimensionsResponse = await fetch('/api/v1/accounting/dimensions');
                    if (!dimensionsResponse.ok) {
                        throw new Error('Failed to load dimensions');
                    }

                    const dimensions = await dimensionsResponse.json();

                    // Map dimension types to existing dimension codes
                    let targetDimension;
                    if (dimensionType === 'FUNCTIONAL') {
                        // Look for organizational dimension (departments/cost centers)
                        targetDimension = dimensions.find(d => d.dimension_type === 'organizational' || d.code === 'DEPT');
                    } else if (dimensionType === 'PROJECT') {
                        // Look for project dimension
                        targetDimension = dimensions.find(d => d.dimension_type === 'project' || d.code === 'PROJ');
                    }

                    if (!targetDimension) {
                        notify(`${dimensionType === 'FUNCTIONAL' ? 'Cost Center' : 'Project'} dimension not found`, 'error');
                        return;
                    }

                    // Create the dimension value
                    const valueData = {
                        code: code.toUpperCase(),
                        name: name,
                        dimension_id: targetDimension.id,
                        is_active: true
                    };

                    const response = await fetch(`/api/v1/accounting/dimensions/${targetDimension.id}/values`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(valueData)
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('Error creating dimension value:', errorText);
                        throw new Error(`Failed to create ${dimensionType === 'FUNCTIONAL' ? 'cost center' : 'project'}`);
                    }

                    notify(`${dimensionType === 'FUNCTIONAL' ? 'Cost Center' : 'Project'} "${name}" created successfully`, 'success');

                    // Reload the dimension values list
                    loadDimensionValuesByType(dimensionType);

                } catch (error) {
                    console.error('Error adding dimension value:', error);
                    notify(`Error: ${error.message}`, 'error');
                }
            }

            // Apply dimension requirements to accounts
            async function applyDimensionToAccounts(dimensionType) {
                try {
                    // For now, just show a notification that this feature is available
                    notify(`${dimensionType === 'FUNCTIONAL' ? 'Cost Center' : 'Project'} dimension is ready for use in purchases and transactions`, 'info');

                    // Close the modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('dimensionManagementModal'));
                    if (modal) {
                        modal.hide();
                    }
                } catch (error) {
                    console.error('Error applying dimension to accounts:', error);
                    notify(`Error: ${error.message}`, 'error');
                }
            }

            // Edit dimension value
            async function editDimensionValue(valueId) {
                try {
                    // Get current value details
                    const response = await fetch(`/api/v1/accounting/dimensions/values/${valueId}`);
                    if (!response.ok) {
                        throw new Error('Failed to load dimension value details');
                    }

                    const value = await response.json();

                    // Prompt for new values
                    const newCode = prompt('Edit Code:', value.code);
                    if (newCode === null) return; // User cancelled

                    const newName = prompt('Edit Name:', value.name);
                    if (newName === null) return; // User cancelled

                    // Update the value
                    const updateData = {
                        code: newCode.toUpperCase(),
                        name: newName,
                        is_active: value.is_active
                    };

                    const updateResponse = await fetch(`/api/v1/accounting/dimensions/values/${valueId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(updateData)
                    });

                    if (!updateResponse.ok) {
                        const errorText = await updateResponse.text();
                        throw new Error(`Failed to update: ${errorText}`);
                    }

                    notify(`Updated "${newName}" successfully`, 'success');

                    // Get dimension info to determine how to reload
                    const dimensionResponse = await fetch(`/api/v1/accounting/dimensions/${value.dimension_id}`);
                    const dimension = dimensionResponse.ok ? await dimensionResponse.json() : null;
                    const dimensionType = (dimension?.dimension_type === 'organizational' || dimension?.code === 'DEPT') ? 'FUNCTIONAL' : 'PROJECT';
                    loadDimensionValuesByType(dimensionType);

                } catch (error) {
                    console.error('Error editing dimension value:', error);
                    notify(`Error: ${error.message}`, 'error');
                }
            }

            // Toggle dimension value status (pause/activate)
            async function toggleDimensionValueStatus(valueId, currentStatus) {
                try {
                    const action = currentStatus ? 'deactivate' : 'activate';
                    const confirmation = confirm(`Are you sure you want to ${action} this ${currentStatus ? 'cost center/project' : 'cost center/project'}?`);

                    if (!confirmation) return;

                    // Get current value details first
                    const getResponse = await fetch(`/api/v1/accounting/dimensions/values/${valueId}`);
                    if (!getResponse.ok) {
                        throw new Error('Failed to load dimension value details');
                    }

                    const value = await getResponse.json();

                    // Update just the status
                    const updateData = {
                        code: value.code,
                        name: value.name,
                        is_active: !currentStatus
                    };

                    const response = await fetch(`/api/v1/accounting/dimensions/values/${valueId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(updateData)
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`Failed to ${action}: ${errorText}`);
                    }

                    notify(`${value.name} ${action}d successfully`, 'success');

                    // Get dimension info to determine how to reload
                    const dimensionResponse = await fetch(`/api/v1/accounting/dimensions/${value.dimension_id}`);
                    const dimension = dimensionResponse.ok ? await dimensionResponse.json() : null;
                    const dimensionType = (dimension?.dimension_type === 'organizational' || dimension?.code === 'DEPT') ? 'FUNCTIONAL' : 'PROJECT';
                    loadDimensionValuesByType(dimensionType);

                } catch (error) {
                    console.error('Error toggling dimension value status:', error);
                    notify(`Error: ${error.message}`, 'error');
                }
            }

            // View dimension value usage
            async function viewDimensionValueUsage(valueId) {
                try {
                    // Get value details
                    const response = await fetch(`/api/v1/accounting/dimensions/values/${valueId}`);
                    if (!response.ok) {
                        throw new Error('Failed to load dimension value details');
                    }

                    const value = await response.json();

                    // Get dimension info to determine type
                    const dimensionResponse = await fetch(`/api/v1/accounting/dimensions/${value.dimension_id}`);
                    const dimension = dimensionResponse.ok ? await dimensionResponse.json() : null;

                    // Determine if this is a cost center or project
                    const isOrganizational = dimension?.dimension_type === 'organizational' || dimension?.code === 'DEPT';
                    const dimensionLabel = isOrganizational ? 'cost center' : 'project';

                    // For now, show a simple info modal
                    const usageInfo = `
                        <div class="modal fade" id="usageModal" tabindex="-1">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title">Usage Information</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                    </div>
                                    <div class="modal-body">
                                        <h6><strong>${value.name}</strong> (${value.code})</h6>
                                        <p class="text-muted">This feature will show:</p>
                                        <ul>
                                            <li>Purchases using this ${dimensionLabel}</li>
                                            <li>Journal entries with dimensional assignments</li>
                                            <li>Account balances by dimension</li>
                                            <li>Usage trends and analytics</li>
                                        </ul>
                                        <div class="alert alert-info">
                                            <i class="bi bi-info-circle me-2"></i>
                                            Full usage tracking is available in the reporting section.
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;

                    // Remove any existing usage modal
                    const existingModal = document.getElementById('usageModal');
                    if (existingModal) {
                        existingModal.remove();
                    }

                    // Add the modal to the document
                    document.body.insertAdjacentHTML('beforeend', usageInfo);

                    // Show the modal
                    const modal = new bootstrap.Modal(document.getElementById('usageModal'));
                    modal.show();

                    // Clean up when hidden
                    document.getElementById('usageModal').addEventListener('hidden.bs.modal', function () {
                        this.remove();
                    });

                } catch (error) {
                    console.error('Error viewing dimension value usage:', error);
                    notify(`Error: ${error.message}`, 'error');
                }
            }

            // Display dimension values
            function displayDimensionValues(dimension, values) {
                const container = document.getElementById('dimensionValuesList');

                if (values.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-4 text-muted">
                            <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                            No ${dimension.dimension_type === 'FUNCTIONAL' ? 'cost centers' : 'projects'} found.
                            <br>Click "Add New" to create your first entry.
                        </div>
                    `;
                    return;
                }

                let html = `
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Code</th>
                                    <th>Name</th>
                                    <th>Path</th>
                                    <th>Status</th>
                                    <th>Assigned Accounts</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                values.forEach(value => {
                    html += `
                        <tr>
                            <td><code>${value.code}</code></td>
                            <td><strong>${value.name}</strong></td>
                            <td>${value.full_path || value.name}</td>
                            <td>
                                <span class="badge bg-${value.is_active ? 'success' : 'secondary'}">
                                    ${value.is_active ? 'Active' : 'Inactive'}
                                </span>
                            </td>
                            <td>
                                <span class="badge bg-info">${value.assigned_accounts || 0} accounts</span>
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary" onclick="editDimensionValue('${value.id}')" title="Edit">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-outline-info" onclick="viewDimensionValueUsage('${value.id}')" title="View Usage">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    <button class="btn btn-outline-${value.is_active ? 'warning' : 'success'}"
                                            onclick="toggleDimensionValueStatus('${value.id}', ${value.is_active})"
                                            title="${value.is_active ? 'Deactivate' : 'Activate'}">
                                        <i class="bi bi-${value.is_active ? 'pause' : 'play'}"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });

                html += `
                            </tbody>
                        </table>
                    </div>
                `;

                container.innerHTML = html;
            }

            // Generate Profit & Loss report with dimensional filtering
            function generateProfitLossReport() {
                showDimensionalReportModal('profit_loss', 'Profit & Loss Statement');
            }

            // Generate Balance Sheet report with dimensional filtering
            function generateBalanceSheetReport() {
                showDimensionalReportModal('balance_sheet', 'Balance Sheet');
            }

            // Generate General Ledger report with dimensional filtering
            function generateGeneralLedgerReport() {
                showDimensionalReportModal('general_ledger', 'General Ledger');
            }

            // Show dimensional report modal
            function showDimensionalReportModal(reportType = null, reportTitle = 'Dimensional Analysis Reports') {
                const modalHtml = `
                    <div class="modal fade" id="dimensionalReportModal" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">
                                        <i class="bi bi-bar-chart me-2"></i>${reportTitle}
                                    </h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="alert alert-info">
                                        <i class="bi bi-info-circle me-2"></i>
                                        Generate financial reports with dimensional filtering to analyze performance by
                                        cost center, project, or other business dimensions.
                                    </div>

                                    <!-- Report Type Selection -->
                                    ${!reportType ? `
                                    <div class="mb-4">
                                        <label class="form-label fw-bold">Report Type</label>
                                        <select class="form-select" id="reportTypeSelect">
                                            <option value="">Select Report Type</option>
                                            <option value="profit_loss">Profit & Loss Statement</option>
                                            <option value="balance_sheet">Balance Sheet</option>
                                            <option value="general_ledger">General Ledger</option>
                                            <option value="trial_balance">Trial Balance</option>
                                            <option value="cash_flow">Cash Flow Statement</option>
                                        </select>
                                    </div>
                                    ` : `<input type="hidden" id="reportTypeSelect" value="${reportType}">`}

                                    <!-- Date Range -->
                                    <div class="row mb-4">
                                        <div class="col-md-6">
                                            <label class="form-label fw-bold">From Date</label>
                                            <input type="date" class="form-control" id="reportFromDate">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label fw-bold">To Date</label>
                                            <input type="date" class="form-control" id="reportToDate">
                                        </div>
                                    </div>

                                    <!-- Dimensional Filters -->
                                    <div class="mb-4">
                                        <label class="form-label fw-bold">
                                            <i class="bi bi-funnel me-1"></i>Dimensional Filters
                                        </label>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <label class="form-label">Cost Center</label>
                                                <select class="form-select" id="reportCostCenterFilter">
                                                    <option value="">All Cost Centers</option>
                                                </select>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Project</label>
                                                <select class="form-select" id="reportProjectFilter">
                                                    <option value="">All Projects</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Additional Options -->
                                    <div class="mb-4">
                                        <label class="form-label fw-bold">Options</label>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="includeInactiveAccounts">
                                                    <label class="form-check-label" for="includeInactiveAccounts">
                                                        Include inactive accounts
                                                    </label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="showZeroBalances">
                                                    <label class="form-check-label" for="showZeroBalances">
                                                        Show accounts with zero balances
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="groupByDimension" checked>
                                                    <label class="form-check-label" for="groupByDimension">
                                                        Group by dimensions
                                                    </label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="showComparativePeriod">
                                                    <label class="form-check-label" for="showComparativePeriod">
                                                        Show comparative period
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                    <button type="button" class="btn btn-info" onclick="previewDimensionalReport()">
                                        <i class="bi bi-eye me-1"></i>Preview
                                    </button>
                                    <button type="button" class="btn btn-primary" onclick="generateDimensionalReport()">
                                        <i class="bi bi-file-earmark-pdf me-1"></i>Generate Report
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // Remove existing modal
                const existingModal = document.getElementById('dimensionalReportModal');
                if (existingModal) {
                    existingModal.remove();
                }

                // Add and show modal
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                const modal = new bootstrap.Modal(document.getElementById('dimensionalReportModal'));
                modal.show();

                // Initialize date fields with current month
                initializeReportDates();

                // Load dimensional filter options
                loadDimensionalFilterOptions();

                // Clean up when hidden
                document.getElementById('dimensionalReportModal').addEventListener('hidden.bs.modal', function () {
                    this.remove();
                });
            }

            // Initialize report dates
            function initializeReportDates() {
                const today = new Date();
                const firstOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);

                document.getElementById('reportFromDate').value = firstOfMonth.toISOString().split('T')[0];
                document.getElementById('reportToDate').value = today.toISOString().split('T')[0];
            }

            // Load dimensional filter options
            async function loadDimensionalFilterOptions() {
                try {
                    // Load cost centers
                    const costCenterSelect = document.getElementById('reportCostCenterFilter');
                    const projectSelect = document.getElementById('reportProjectFilter');

                    if (costCenterSelect && projectSelect) {
                        await Promise.all([
                            loadFilterOptionsForDimensionType('FUNCTIONAL', costCenterSelect),
                            loadFilterOptionsForDimensionType('PROJECT', projectSelect)
                        ]);
                    }
                } catch (error) {
                    console.error('Error loading dimensional filter options:', error);
                }
            }

            // Load filter options for specific dimension type
            async function loadFilterOptionsForDimensionType(dimensionType, selectElement) {
                try {
                    // Get dimension
                    const dimensionsResponse = await fetch('/api/v1/accounting/dimensions');
                    if (!dimensionsResponse.ok) return;

                    const dimensions = await dimensionsResponse.json();
                    const dimension = dimensions.find(d => d.dimension_type === dimensionType);

                    if (!dimension) return;

                    // Get values
                    const valuesResponse = await fetch(`/api/v1/accounting/dimensions/${dimension.id}/values`);
                    if (!valuesResponse.ok) return;

                    const values = await valuesResponse.json();

                    // Populate select
                    values.forEach(value => {
                        if (value.is_active) {
                            const option = document.createElement('option');
                            option.value = value.id;
                            option.textContent = value.full_path || value.name;
                            selectElement.appendChild(option);
                        }
                    });

                } catch (error) {
                    console.error(`Error loading ${dimensionType} options:`, error);
                }
            }

            // Generate dimensional report
            async function generateDimensionalReport() {
                const reportType = document.getElementById('reportTypeSelect').value;
                const fromDate = document.getElementById('reportFromDate').value;
                const toDate = document.getElementById('reportToDate').value;

                if (!reportType) {
                    notify('Please select a report type', 'warning');
                    return;
                }

                if (!fromDate || !toDate) {
                    notify('Please select date range', 'warning');
                    return;
                }

                const costCenter = document.getElementById('reportCostCenterFilter').value;
                const project = document.getElementById('reportProjectFilter').value;
                const groupByDimension = document.getElementById('groupByDimension').checked;
                const showZeroBalances = document.getElementById('showZeroBalances').checked;

                try {
                    // Build query parameters
                    const params = new URLSearchParams({
                        report_type: reportType,
                        from_date: fromDate,
                        to_date: toDate,
                        group_by_dimension: groupByDimension,
                        show_zero_balances: showZeroBalances
                    });

                    if (costCenter) params.append('cost_center', costCenter);
                    if (project) params.append('project', project);

                    // Generate report
                    const response = await fetch(`/api/v1/reports/dimensional-analysis?${params}`);

                    if (!response.ok) {
                        throw new Error('Failed to generate report');
                    }

                    const blob = await response.blob();

                    // Download the report
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${reportType}_dimensional_report_${fromDate}_to_${toDate}.pdf`;
                    a.click();
                    window.URL.revokeObjectURL(url);

                    notify('Dimensional report generated successfully', 'success');

                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('dimensionalReportModal'));
                    modal.hide();

                } catch (error) {
                    console.error('Error generating report:', error);
                    notify('Error generating report: ' + error.message, 'danger');
                }
            }

            // Preview dimensional report
            function previewDimensionalReport() {
                notify('Report preview functionality will be implemented in a future update', 'info');
            }

            // Update statistics to include dimensional data
            async function updateDimensionalStatistics() {
                try {
                    // Load cost center count
                    const costCenters = await loadDimensionValuesByTypeForStats('FUNCTIONAL');
                    document.getElementById('costCenterCount').textContent = costCenters.length;

                    // Load project count
                    const projects = await loadDimensionValuesByTypeForStats('PROJECT');
                    document.getElementById('projectCount').textContent = projects.length;

                    // Count accounts with dimension requirements
                    const accountsWithDimensions = Array.from(accountDimensionRequirements.values())
                        .filter(reqs => reqs.length > 0).length;
                    document.getElementById('dimensionalAccountsCount').textContent = accountsWithDimensions;

                } catch (error) {
                    console.error('Error updating dimensional statistics:', error);
                }
            }

            // Load dimension values for statistics
            async function loadDimensionValuesByTypeForStats(dimensionType) {
                try {
                    const dimensionsResponse = await fetch('/api/v1/accounting/dimensions');
                    if (!dimensionsResponse.ok) return [];

                    const dimensions = await dimensionsResponse.json();
                    const dimension = dimensions.find(d => d.dimension_type === dimensionType);

                    if (!dimension) return [];

                    const valuesResponse = await fetch(`/api/v1/accounting/dimensions/${dimension.id}/values`);
                    if (!valuesResponse.ok) return [];

                    return await valuesResponse.json();
                } catch (error) {
                    console.error(`Error loading ${dimensionType} values:`, error);
                    return [];
                }
            }
            let currentAccountId = null;

            // Load available dimensions for dropdown
            async function loadAvailableDimensions() {
                try {
                    const response = await fetch('/api/v1/accounting/dimensions');
                    if (!response.ok) {
                        throw new Error(`Failed to load dimensions (${response.status})`);
                    }
                    availableDimensions = await response.json();
                    console.log('Loaded dimensions:', availableDimensions.length);
                } catch (error) {
                    console.error('Error loading dimensions:', error);
                    availableDimensions = [];
                }
            }

            // Load dimension requirements for the current account
            async function loadAccountDimensionRequirements(accountId) {
                if (!accountId) return;

                currentAccountId = accountId;
                const container = document.getElementById('dimensionRequirementsList');
                const errorAlert = document.getElementById('dimensionRequirementsErrorAlert');
                const noReqsMessage = document.getElementById('noDimensionRequirementsMessage');

                // Check if required elements exist
                if (!container) {
                    console.warn('dimensionRequirementsList container not found');
                    return;
                }

                try {
                    // Show loading
                    container.innerHTML = `
                    <div class="text-center py-3">
                        <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                        Loading dimension requirements...
                    </div>
                `;

                    const response = await fetch(`/api/v1/accounting/codes/${accountId}/dimension-requirements`);
                    if (!response.ok) {
                        throw new Error(`Failed to load dimension requirements (${response.status})`);
                    }

                    const data = await response.json();
                    const requirements = data.requirements || [];

                    if (requirements.length === 0) {
                        container.innerHTML = '';
                        if (noReqsMessage) {
                            noReqsMessage.style.display = 'block';
                        }
                    } else {
                        if (noReqsMessage) {
                            noReqsMessage.style.display = 'none';
                        }
                        displayDimensionRequirements(requirements);
                    }

                    if (errorAlert) {
                        errorAlert.classList.add('d-none');
                    }

                    // Also load dimension balances
                    loadAccountDimensionBalances(accountId);

                } catch (error) {
                    console.error('Error loading dimension requirements:', error);
                    if (errorAlert) {
                        errorAlert.textContent = error.message;
                        errorAlert.classList.remove('d-none');
                    }
                    container.innerHTML = '';
                    if (noReqsMessage) {
                        noReqsMessage.style.display = 'block';
                    }
                }
            }

            // Display dimension requirements
            function displayDimensionRequirements(requirements) {
                const container = document.getElementById('dimensionRequirementsList');

                let html = `
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Dimension</th>
                                <th>Requirement</th>
                                <th>Default Value</th>
                                <th>Priority</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

                requirements.forEach(req => {
                    const reqType = req.is_required ?
                        '<span class="badge bg-danger">Required</span>' :
                        '<span class="badge bg-secondary">Optional</span>';

                    const defaultValue = req.default_dimension_value ?
                        req.default_dimension_value.full_path :
                        '<em class="text-muted">None</em>';

                    html += `
                    <tr>
                        <td>
                            <strong>${req.dimension.name}</strong><br>
                            <small class="text-muted">${req.dimension.code} - ${req.dimension.dimension_type}</small>
                        </td>
                        <td>${reqType}</td>
                        <td>${defaultValue}</td>
                        <td>${req.priority}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="showEditDimensionRequirementModal('${req.id}')" title="Edit">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteDimensionRequirement('${req.id}')" title="Delete">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
                });

                html += `
                        </tbody>
                    </table>
                </div>
            `;

                container.innerHTML = html;
            }

            // Add dimension requirement button handler
            document.addEventListener('DOMContentLoaded', function () {
                const addBtn = document.getElementById('addDimensionRequirementBtn');
                if (addBtn) {
                    addBtn.addEventListener('click', function () {
                        showAddDimensionRequirementModal();
                    });
                }
            });

            // Show add dimension requirement modal (enhanced version)
            function showAddDimensionRequirementModal() {
                if (!currentAccountId) {
                    notify('No account selected', 'danger');
                    return;
                }

                if (availableDimensions.length === 0) {
                    notify('No dimensions available. Please create dimensions first.', 'warning');
                    return;
                }

                // Reset form for new requirement
                resetDimensionRequirementForm();

                // Set modal title and button text for creating
                document.getElementById('dimensionRequirementModalTitle').textContent = 'Add Dimension Requirement';
                document.getElementById('saveButtonText').textContent = 'Create Requirement';
                document.getElementById('requirementAccountId').value = currentAccountId;
                document.getElementById('requirementId').value = '';

                // Populate dimensions dropdown
                populateDimensionsDropdown();

                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('dimensionRequirementModal'));
                modal.show();
            }

            // Show edit dimension requirement modal
            function showEditDimensionRequirementModal(requirementId) {
                if (!currentAccountId) {
                    notify('No account selected', 'danger');
                    return;
                }

                // Reset form for editing
                resetDimensionRequirementForm();

                // Set modal title and button text for editing
                document.getElementById('dimensionRequirementModalTitle').textContent = 'Edit Dimension Requirement';
                document.getElementById('saveButtonText').textContent = 'Update Requirement';
                document.getElementById('requirementAccountId').value = currentAccountId;
                document.getElementById('requirementId').value = requirementId;

                // Populate dimensions dropdown
                populateDimensionsDropdown();

                // Load existing requirement data
                loadRequirementForEditing(requirementId);

                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('dimensionRequirementModal'));
                modal.show();
            }

            // Reset dimension requirement form
            function resetDimensionRequirementForm() {
                document.getElementById('dimensionRequirementForm').reset();
                document.getElementById('dimensionSelect').innerHTML = '<option value="">Select a dimension...</option>';
                document.getElementById('defaultValueSelect').innerHTML = '<option value="">No default value</option>';
                document.getElementById('priorityInput').value = '1';
                document.getElementById('requirementRequired').checked = true;
                updateRequirementPreview();
            }

            // Populate dimensions dropdown
            function populateDimensionsDropdown() {
                const select = document.getElementById('dimensionSelect');
                select.innerHTML = '<option value="">Select a dimension...</option>';

                availableDimensions.forEach(dimension => {
                    const option = document.createElement('option');
                    option.value = dimension.id;
                    option.textContent = `${dimension.name} (${dimension.code}) - ${dimension.dimension_type}`;
                    option.dataset.dimensionId = dimension.id;
                    select.appendChild(option);
                });
            }

            // Load dimension values when dimension is selected
            async function loadDimensionValues(dimensionId) {
                if (!dimensionId) {
                    document.getElementById('defaultValueSelect').innerHTML = '<option value="">No default value</option>';
                    return;
                }

                const select = document.getElementById('defaultValueSelect');
                select.innerHTML = '<option value="">Loading values...</option>';

                try {
                    const response = await fetch(`/api/v1/accounting/dimensions/${dimensionId}/values`);
                    if (!response.ok) {
                        throw new Error(`Failed to load dimension values (${response.status})`);
                    }

                    const values = await response.json();

                    select.innerHTML = '<option value="">No default value</option>';
                    values.forEach(value => {
                        const option = document.createElement('option');
                        option.value = value.id;
                        option.textContent = value.full_path || `${value.code} - ${value.name}`;
                        select.appendChild(option);
                    });

                    updateRequirementPreview();
                } catch (error) {
                    console.error('Error loading dimension values:', error);
                    select.innerHTML = '<option value="">Error loading values</option>';
                    notify('Failed to load dimension values: ' + error.message, 'danger');
                }
            }

            // Update requirement preview
            function updateRequirementPreview() {
                const dimensionSelect = document.getElementById('dimensionSelect');
                const isRequired = document.querySelector('input[name="requirementType"]:checked').value === 'true';
                const defaultValue = document.getElementById('defaultValueSelect');
                const priority = document.getElementById('priorityInput').value;

                const preview = document.getElementById('requirementPreview');

                if (!dimensionSelect.value) {
                    preview.innerHTML = '<em class="text-muted">Select a dimension to see the preview</em>';
                    return;
                }

                const selectedDimension = availableDimensions.find(d => d.id === dimensionSelect.value);
                if (!selectedDimension) {
                    preview.innerHTML = '<em class="text-muted">Invalid dimension selected</em>';
                    return;
                }

                const reqType = isRequired ?
                    '<span class="badge bg-danger">Required</span>' :
                    '<span class="badge bg-secondary">Optional</span>';

                const defaultText = defaultValue.selectedOptions[0]?.text || 'No default value';

                preview.innerHTML = `
                    <div class="d-flex align-items-center mb-2">
                        <strong class="me-2">${selectedDimension.name}</strong>
                        ${reqType}
                        <small class="text-muted ms-2">Priority: ${priority}</small>
                    </div>
                    <div class="small text-muted">
                        <strong>Type:</strong> ${selectedDimension.dimension_type}<br>
                        <strong>Code:</strong> ${selectedDimension.code}<br>
                        <strong>Default Value:</strong> ${defaultText}
                    </div>
                `;
            }

            // Load requirement for editing
            async function loadRequirementForEditing(requirementId) {
                try {
                    // Find the requirement in the current loaded requirements
                    // This assumes we have the requirements loaded already
                    const response = await fetch(`/api/v1/accounting/codes/${currentAccountId}/dimension-requirements`);
                    if (!response.ok) {
                        throw new Error(`Failed to load requirement details (${response.status})`);
                    }

                    const data = await response.json();
                    const requirement = data.requirements.find(r => r.id === requirementId);

                    if (!requirement) {
                        throw new Error('Requirement not found');
                    }

                    // Populate form with existing data
                    document.getElementById('dimensionSelect').value = requirement.dimension_id;
                    document.querySelector(`input[name="requirementType"][value="${requirement.is_required}"]`).checked = true;
                    document.getElementById('priorityInput').value = requirement.priority;
                    document.getElementById('descriptionInput').value = requirement.description || '';

                    // Load dimension values and set default
                    await loadDimensionValues(requirement.dimension_id);
                    if (requirement.default_dimension_value_id) {
                        document.getElementById('defaultValueSelect').value = requirement.default_dimension_value_id;
                    }

                    updateRequirementPreview();
                } catch (error) {
                    console.error('Error loading requirement for editing:', error);
                    notify('Failed to load requirement details: ' + error.message, 'danger');
                }
            }

            // Save dimension requirement (create or update)
            async function saveDimensionRequirement() {
                const form = document.getElementById('dimensionRequirementForm');
                const formData = new FormData(form);

                const accountId = document.getElementById('requirementAccountId').value;
                const requirementId = document.getElementById('requirementId').value;
                const dimensionId = document.getElementById('dimensionSelect').value;
                const isRequired = document.querySelector('input[name="requirementType"]:checked').value === 'true';
                const defaultValueId = document.getElementById('defaultValueSelect').value || null;
                const priority = parseInt(document.getElementById('priorityInput').value) || 1;
                const description = document.getElementById('descriptionInput').value || null;

                if (!dimensionId) {
                    notify('Please select a dimension', 'warning');
                    return;
                }

                const saveButton = document.getElementById('saveDimensionRequirement');
                const originalText = saveButton.innerHTML;
                saveButton.innerHTML = '<i class="bi bi-spinner-grow spinner-border-sm me-1"></i>Saving...';
                saveButton.disabled = true;

                try {
                    const url = requirementId ?
                        `/api/v1/accounting/codes/dimension-requirements/${requirementId}` :
                        `/api/v1/accounting/codes/${accountId}/dimension-requirements`;

                    const method = requirementId ? 'PUT' : 'POST';

                    const requestBody = {
                        dimension_id: dimensionId,
                        is_required: isRequired,
                        default_dimension_value_id: defaultValueId,
                        priority: priority,
                        description: description
                    };

                    const response = await fetch(url, {
                        method: method,
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestBody)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.detail || `Failed to ${requirementId ? 'update' : 'create'} dimension requirement`);
                    }

                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('dimensionRequirementModal'));
                    modal.hide();

                    // Reload requirements
                    loadAccountDimensionRequirements(currentAccountId);
                    notify(`Dimension requirement ${requirementId ? 'updated' : 'created'} successfully`, 'success');

                } catch (error) {
                    console.error('Error saving dimension requirement:', error);
                    notify(error.message, 'danger');
                } finally {
                    saveButton.innerHTML = originalText;
                    saveButton.disabled = false;
                }
            }

            // Create dimension requirement (deprecated - kept for compatibility)
            async function createDimensionRequirement(dimensionId, isRequired) {
                // This function is now deprecated in favor of the modal-based saveDimensionRequirement
                console.warn('createDimensionRequirement is deprecated, use saveDimensionRequirement instead');
                return saveDimensionRequirement();
            }

            // Delete dimension requirement
            async function deleteDimensionRequirement(requirementId) {
                if (!confirm('Are you sure you want to delete this dimension requirement?')) {
                    return;
                }

                try {
                    const response = await fetch(`/api/v1/accounting/codes/dimension-requirements/${requirementId}`, {
                        method: 'DELETE'
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.detail || 'Failed to delete dimension requirement');
                    }

                    // Reload requirements
                    loadAccountDimensionRequirements(currentAccountId);
                    notify('Dimension requirement deleted successfully', 'success');

                } catch (error) {
                    console.error('Error deleting dimension requirement:', error);
                    notify(error.message, 'danger');
                }
            }

            // Load dimension balances for account
            async function loadAccountDimensionBalances(accountId) {
                if (!accountId) return;

                const section = document.getElementById('dimensionBalancesSection');
                const container = document.getElementById('dimensionBalancesContainer');

                try {
                    const response = await fetch(`/api/v1/accounting/codes/${accountId}/dimension-balances`);
                    if (!response.ok) {
                        throw new Error(`Failed to load dimension balances (${response.status})`);
                    }

                    const data = await response.json();

                    if (data.dimension_balances && data.dimension_balances.length > 0) {
                        displayDimensionBalances(data.dimension_balances);
                        section.style.display = 'block';
                    } else {
                        container.innerHTML = `
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle me-2"></i>
                            ${data.message || 'No dimension-based balance data available for this account.'}
                        </div>
                    `;
                        section.style.display = 'block';
                    }

                } catch (error) {
                    console.error('Error loading dimension balances:', error);
                    container.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        Unable to load dimension balances: ${error.message}
                    </div>
                `;
                    section.style.display = 'block';
                }
            }

            // Display dimension balances
            function displayDimensionBalances(balances) {
                const container = document.getElementById('dimensionBalancesContainer');

                let html = `
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead class="table-light">
                            <tr>
                                <th>Dimension</th>
                                <th>Value</th>
                                <th class="text-end">Debits</th>
                                <th class="text-end">Credits</th>
                                <th class="text-end">Balance</th>
                                <th class="text-end">Transactions</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

                balances.forEach(balance => {
                    html += `
                    <tr>
                        <td><strong>${balance.dimension_name}</strong></td>
                        <td>${balance.dimension_value_path}</td>
                        <td class="text-end text-danger">${balance.debit_total.toFixed(2)}</td>
                        <td class="text-end text-success">${balance.credit_total.toFixed(2)}</td>
                        <td class="text-end">${balance.balance.toFixed(2)}</td>
                        <td class="text-end">${balance.transaction_count}</td>
                    </tr>
                `;
                });

                html += `
                        </tbody>
                    </table>
                </div>
            `;

                container.innerHTML = html;
            }

            // Initialize dimensions when viewing an account
            function initializeDimensionsForAccount(accountId) {
                if (availableDimensions.length === 0) {
                    loadAvailableDimensions().then(() => {
                        loadAccountDimensionRequirements(accountId);
                    });
                } else {
                    loadAccountDimensionRequirements(accountId);
                }
            }

            // Load available dimensions on page load
            document.addEventListener('DOMContentLoaded', function () {
                loadAvailableDimensions();

                // Initialize dimension requirement modal event listeners
                initializeDimensionModalEventListeners();
            });

            // Initialize dimension modal event listeners
            function initializeDimensionModalEventListeners() {
                // Save button click
                const saveButton = document.getElementById('saveDimensionRequirement');
                if (saveButton) {
                    saveButton.addEventListener('click', saveDimensionRequirement);
                }

                // Dimension selection change
                const dimensionSelect = document.getElementById('dimensionSelect');
                if (dimensionSelect) {
                    dimensionSelect.addEventListener('change', function () {
                        loadDimensionValues(this.value);
                    });
                }

                // Requirement type change
                const requirementTypeRadios = document.querySelectorAll('input[name="requirementType"]');
                requirementTypeRadios.forEach(radio => {
                    radio.addEventListener('change', updateRequirementPreview);
                });

                // Default value selection change
                const defaultValueSelect = document.getElementById('defaultValueSelect');
                if (defaultValueSelect) {
                    defaultValueSelect.addEventListener('change', updateRequirementPreview);
                }

                // Priority input change
                const priorityInput = document.getElementById('priorityInput');
                if (priorityInput) {
                    priorityInput.addEventListener('input', updateRequirementPreview);
                }

                // Form validation
                const form = document.getElementById('dimensionRequirementForm');
                if (form) {
                    form.addEventListener('submit', function (e) {
                        e.preventDefault();
                        saveDimensionRequirement();
                    });
                }
            }
        </script>


</body>

</html>
