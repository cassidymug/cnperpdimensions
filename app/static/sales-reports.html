<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .navbar { background: linear-gradient(135deg, var(--primary-color), #0056b3) !important; }
    </style>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="version" content="20250927-v2">
    <title>CNPERP - Sales Reports</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Modern Styles -->
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Include Standardized Navbar -->
    <div id="navbar-container"></div>
    <div style="height: 70px;"></div>
    

    <!-- Main Content -->
    <div class="container-fluid mt-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="h3 mb-0">
                            <i class="bi bi-cart text-success"></i> Sales Reports
                        </h1>
                        <p class="text-muted mb-0">Comprehensive sales analytics and insights</p>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn-modern btn-outline-success" onclick="exportReport()">
                            <i class="bi bi-download"></i> Export
                        </button>
                        <button class="btn-modern btn-success" onclick="printReport()">
                            <i class="bi bi-printer"></i> Print
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Report Filters -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="modern-card">
                    <div class="card-body">
                        <div class="row">
            <div class="col-md-3">
                                <label class="form-label">Start Date</label>
                                <input type="date" class="form-control" id="startDate" onchange="loadSalesData()">
            </div>
            <div class="col-md-3">
                                <label class="form-label">End Date</label>
                                <input type="date" class="form-control" id="endDate" onchange="loadSalesData()">
            </div>
            <div class="col-md-3">
                                <label class="form-label">Branch</label>
                                <select class="form-select" id="branchFilter" onchange="loadSalesData()">
                                    <option value="">All Branches</option>
                                </select>
            </div>
            <div class="col-md-3">
                                <label class="form-label">Report Type</label>
                                <select class="form-select" id="reportType" onchange="loadSalesData()">
                                    <option value="summary">Sales Summary</option>
                                    <option value="daily">Daily Sales Report</option>
                                    <option value="customers">Customer Analysis</option>
                                    <option value="receivables">Receivables Aging</option>
                                    <option value="performance">Performance Dashboard</option>
                                </select>
                        </div>
                        </div>
                        
                        <!-- Daily Sales Report Filters (hidden by default) -->
                        <div class="row mt-3" id="dailySalesFilters" style="display: none;">
                            <div class="col-md-3">
                                <label class="form-label">User/Cashier</label>
                                <select class="form-select" id="userFilter" onchange="loadDailySalesData()">
                                    <option value="">All Users</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">POS Session</label>
                                <select class="form-select" id="sessionFilter" onchange="loadDailySalesData()">
                                    <option value="">All Sessions</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Payment Method</label>
                                <select class="form-select" id="paymentMethodFilter" onchange="loadDailySalesData()">
                                    <option value="">All Methods</option>
                                    <option value="cash">Cash Only</option>
                                    <option value="card">Card Only</option>
                                    <option value="cash,card">Cash & Card</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Include Float</label>
                                <select class="form-select" id="includeFloat">
                                    <option value="false">Exclude Float</option>
                                    <option value="true">Include Float</option>
                                </select>
                            </div>
                        </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sales Summary -->
        <div id="salesSummary" class="report-section">
        <div class="row mb-4">
            <div class="col-md-3">
                    <div class="modern-card">
                    <div class="card-body text-center">
                            <i class="bi bi-cart-check fs-1 text-success mb-2"></i>
                            <h4 id="totalSales">0</h4>
                            <p class="text-muted mb-0">Total Sales</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                    <div class="modern-card">
                    <div class="card-body text-center">
                            <i class="bi bi-currency-dollar fs-1 text-primary mb-2"></i>
                            <h4 id="totalAmount">-</h4>
                            <p class="text-muted mb-0">Total Amount</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                    <div class="modern-card">
                    <div class="card-body text-center">
                            <i class="bi bi-receipt fs-1 text-warning mb-2"></i>
                            <h4 id="totalVat">-</h4>
                            <p class="text-muted mb-0">Total VAT</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                    <div class="modern-card">
                    <div class="card-body text-center">
                            <i class="bi bi-graph-up fs-1 text-info mb-2"></i>
                            <h4 id="averageSale">-</h4>
                            <p class="text-muted mb-0">Average Sale</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
                <div class="col-md-6">
                <div class="modern-card">
                    <div class="card-header">
                            <h6 class="mb-0">
                                <i class="bi bi-pie-chart"></i> Payment Methods
                            </h6>
                    </div>
                    <div class="card-body">
                            <canvas id="paymentMethodsChart" width="400" height="200"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                <div class="modern-card">
                    <div class="card-header">
                            <h6 class="mb-0">
                                <i class="bi bi-people"></i> Top Customers
                            </h6>
                    </div>
                    <div class="card-body">
                            <div id="topCustomersList"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Daily Sales Report -->
        <div id="dailySalesReport" class="report-section" style="display: none;">
            <div class="row mb-4">
                <div class="col-12">
                    <div class="modern-card">
                        <div class="card-header bg-primary text-white">
                            <div class="d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">
                                    <i class="bi bi-calendar-day me-2"></i>Daily Sales Report
                                </h6>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-light btn-sm" onclick="exportDailySales()">
                                        <i class="bi bi-download"></i> Export
                                    </button>
                                    <button class="btn btn-light btn-sm" onclick="printDailySales()">
                                        <i class="bi bi-printer"></i> Print
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- POS Session Summary -->
                            <div class="row mb-4">
                                <div class="col-md-2">
                                    <div class="card bg-light">
                                        <div class="card-body text-center">
                                            <h6 class="card-title">Sessions</h6>
                                            <h4 class="text-primary" id="dailySessionsCount">0</h4>
                                            <small>Active Sessions</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="card bg-light">
                                        <div class="card-body text-center">
                                            <h6 class="card-title">Total Float</h6>
                                            <h4 class="text-info" id="dailyTotalFloat">P 0.00</h4>
                                            <small>Opening Float</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="card bg-light">
                                        <div class="card-body text-center">
                                            <h6 class="card-title">Cash Sales</h6>
                                            <h4 class="text-success" id="dailyCashSales">P 0.00</h4>
                                            <small>Minus Float</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="card bg-light">
                                        <div class="card-body text-center">
                                            <h6 class="card-title">Card Sales</h6>
                                            <h4 class="text-warning" id="dailyCardSales">P 0.00</h4>
                                            <small>All Cards</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="card bg-light">
                                        <div class="card-body text-center">
                                            <h6 class="card-title">Net Sales</h6>
                                            <h4 class="text-primary" id="dailyNetSales">P 0.00</h4>
                                            <small>Cash + Card</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="card bg-light">
                                        <div class="card-body text-center">
                                            <h6 class="card-title">Transactions</h6>
                                            <h4 class="text-dark" id="dailyTransactionCount">0</h4>
                                            <small>Total Count</small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- POS Sessions Table -->
                            <div class="mb-4">
                                <h6><i class="bi bi-tv me-2"></i>POS Sessions</h6>
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>Session ID</th>
                                                <th>User/Cashier</th>
                                                <th>Branch</th>
                                                <th>Till ID</th>
                                                <th>Opened</th>
                                                <th>Closed</th>
                                                <th>Float Amount</th>
                                                <th>Cash Sales</th>
                                                <th>Card Sales</th>
                                                <th>Net Sales</th>
                                                <th>Status</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="dailySessionsTableBody">
                                            <!-- Sessions will be populated here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Detailed Transactions -->
                            <div class="mb-4">
                                <h6><i class="bi bi-receipt me-2"></i>Sales Transactions</h6>
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>Time</th>
                                                <th>Sale ID</th>
                                                <th>Customer</th>
                                                <th>Payment Method</th>
                                                <th>Amount Ex-VAT</th>
                                                <th>VAT Amount</th>
                                                <th>Total Amount</th>
                                                <th>Tendered</th>
                                                <th>Change</th>
                                                <th>User</th>
                                                <th>Status</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="dailyTransactionsTableBody">
                                            <!-- Transactions will be populated here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Summary Calculations -->
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card border-primary">
                                        <div class="card-header bg-primary text-white">
                                            <h6 class="mb-0"><i class="bi bi-calculator me-2"></i>Cash Summary</h6>
                                        </div>
                                        <div class="card-body">
                                            <table class="table table-sm">
                                                <tr>
                                                    <td>Opening Float:</td>
                                                    <td class="text-end fw-bold" id="summaryOpeningFloat">P 0.00</td>
                                                </tr>
                                                <tr>
                                                    <td>Cash Sales:</td>
                                                    <td class="text-end" id="summaryCashSales">P 0.00</td>
                                                </tr>
                                                <tr class="table-active">
                                                    <td><strong>Total Cash Expected:</strong></td>
                                                    <td class="text-end fw-bold" id="summaryTotalExpected">P 0.00</td>
                                                </tr>
                                                <tr>
                                                    <td>Cash Submitted:</td>
                                                    <td class="text-end" id="summaryCashSubmitted">P 0.00</td>
                                                </tr>
                                                <tr class="table-warning">
                                                    <td><strong>Variance:</strong></td>
                                                    <td class="text-end fw-bold" id="summaryVariance">P 0.00</td>
                                                </tr>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card border-success">
                                        <div class="card-header bg-success text-white">
                                            <h6 class="mb-0"><i class="bi bi-credit-card me-2"></i>Payment Methods</h6>
                                        </div>
                                        <div class="card-body">
                                            <canvas id="paymentMethodsChart" width="300" height="200"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Customer Analysis -->
        <div id="customerAnalysis" class="report-section" style="display: none;">
            <div class="row mb-4">
                <div class="col-12">
        <div class="modern-card">
            <div class="card-header">
                            <h6 class="mb-0">
                                <i class="bi bi-people"></i> Customer Analysis
                            </h6>
            </div>
            <div class="card-body">
                            <div class="row mb-4">
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <h4 id="totalCustomers">0</h4>
                                        <p class="text-muted">Total Customers</p>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <h4 id="activeCustomers">0</h4>
                                        <p class="text-muted">Active Customers</p>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <h4 id="totalReceivables">-</h4>
                                        <p class="text-muted">Total Receivables</p>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <h4 id="customerActivityRate">0%</h4>
                                        <p class="text-muted">Activity Rate</p>
                                    </div>
                                </div>
                            </div>
                            <div id="customerAnalysisTable"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Receivables Aging -->
        <div id="receivablesAging" class="report-section" style="display: none;">
            <div class="row mb-4">
                <div class="col-12">
                <div class="modern-card">
                    <div class="card-header">
                            <h6 class="mb-0">
                                <i class="bi bi-clock-history"></i> Receivables Aging Report
                            </h6>
                    </div>
                    <div class="card-body">
                            <div class="row mb-4">
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <h4 id="totalReceivablesAging">-</h4>
                                        <p class="text-muted">Total Receivables</p>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <h4 id="currentReceivables">-</h4>
                                        <p class="text-success">Current (0-30 days)</p>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <h4 id="overdueReceivables">-</h4>
                                        <p class="text-warning">Overdue (>30 days)</p>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <h4 id="criticalReceivables">-</h4>
                                        <p class="text-danger">Critical (>90 days)</p>
                                    </div>
                                </div>
                            </div>
                            <div id="receivablesAgingTable"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

        <!-- Performance Dashboard -->
        <div id="performanceDashboard" class="report-section" style="display: none;">
            <div class="row mb-4">
                            <div class="col-md-6">
                    <div class="modern-card">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="bi bi-graph-up"></i> Sales Performance
                            </h6>
                        </div>
                        <div class="card-body">
                            <canvas id="salesPerformanceChart" width="400" height="200"></canvas>
                        </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                    <div class="modern-card">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="bi bi-calendar"></i> Monthly Trends
                            </h6>
                        </div>
                        <div class="card-body">
                            <canvas id="monthlyTrendsChart" width="400" height="200"></canvas>
                        </div>
                </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Customer Details Modal -->
    <div class="modal fade" id="customerDetailsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="customerDetailsTitle">
                        <i class="bi bi-person-vcard me-2"></i>Customer Details
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="customerDetailsLoading" class="text-center py-4 d-none">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                    <div id="customerDetailsError" class="alert alert-danger d-none" role="alert"></div>
                    <div id="customerDetailsBody"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- API Configuration -->
    <script src="js/api-config.js"></script>
    
    
    <script src="js/navbar-loader.js?v=20250927-2"></script>
    <!-- Modern Interactions -->
    <script src="js/modern-interactions.js?v=20250927-2"></script>
    <!-- Currency Utils -->
    <script src="js/currency-utils.js?v=20250927-2"></script>
    <!-- Settings Loader -->
    <script src="js/settings-loader.js?v=20250927-2"></script>
    
    <script>
        function escapeHtml(value) {
            return String(value ?? '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        // Global variables
        let salesData = {};
        let charts = {};
        const CACHE_BUSTER = Date.now(); // Prevent caching issues
        
        // Debug information
        console.log('üîß Sales Reports Debug Info:', {
            apiBase: API_BASE,
            cacheBuster: CACHE_BUSTER,
            userAgent: navigator.userAgent,
            timestamp: new Date().toISOString()
        });
        
        // Test API connection
        async function testAPIConnection() {
            try {
                const response = await fetch(API_CONFIG.ENDPOINTS.SETTINGS, {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                });
                
                if (response.ok) {
                    console.log('‚úÖ API connection successful');
                    return true;
                } else {
                    console.error('‚ùå API connection failed:', response.status, response.statusText);
                    return false;
                }
            } catch (error) {
                console.error('‚ùå API connection error:', error);
                showError(`Unable to connect to server. Please check if the server is running on ${API_CONFIG.BASE_URL}`);
                return false;
            }
        }
        
        // ========================================================================
        // RECEIVABLES AGING REPORT FUNCTIONS
        // ========================================================================
        
        async function loadReceivablesAging() {
            try {
                console.log('üîç Loading receivables aging report...');
                
                const url = API_CONFIG.ENDPOINTS.REPORTS_DEBTORS_AGING;
                console.log('üîó Fetching aging data from:', url);
                
                const response = await fetch(url, {
                    headers: {
                        'Accept': 'application/json',
                        'Cache-Control': 'no-cache'
                    }
                });
                
                if (response.ok) {
                    const agingData = await response.json();
                    console.log('üìä Received aging data:', agingData);
                    
                    if (agingData.success && agingData.data) {
                        renderReceivablesAging(agingData.data);
                    } else {
                        throw new Error('Invalid aging data format');
                    }
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
            } catch (error) {
                console.error('Error loading receivables aging:', error);
                showError('Failed to load receivables aging report: ' + error.message);
                // Show empty state
                renderReceivablesAging({
                    debtors: [],
                    summary: { current: 0, days_31_60: 0, days_61_90: 0, days_91_120: 0, days_120_plus: 0, total: 0 },
                    customer_count: 0,
                    total_outstanding: 0
                });
            }
            
            showReportSection('receivablesAging');
        }
        
        function renderReceivablesAging(data) {
            console.log('üé® Rendering receivables aging report:', data);
            
            // Update summary cards
            const summaryElements = {
                'agingTotalOutstanding': formatCurrency(data.total_outstanding || 0),
                'agingCustomerCount': data.customer_count || 0,
                'agingCurrentAmount': formatCurrency(data.summary?.current || 0),
                'aging31to60Amount': formatCurrency(data.summary?.days_31_60 || 0),
                'aging61to90Amount': formatCurrency(data.summary?.days_61_90 || 0),
                'aging90PlusAmount': formatCurrency((data.summary?.days_91_120 || 0) + (data.summary?.days_120_plus || 0))
            };
            
            Object.entries(summaryElements).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = value;
                }
            });
            
            // Render aging table
            renderAgingTable(data.debtors || []);
            
            // Update aging chart
            updateAgingChart(data.summary || {});
            
            // Show IFRS compliance info
            renderIFRSCompliance(data.expected_credit_loss, data.ifrs_compliance);
        }
        
        function renderAgingTable(debtors) {
            const tbody = document.getElementById('agingTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            if (debtors.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center text-muted py-4">
                            <i class="bi bi-info-circle fs-1 mb-2"></i><br>
                            No outstanding receivables found<br>
                            <small>All customers have paid their invoices</small>
                        </td>
                    </tr>
                `;
                return;
            }
            
            debtors.forEach(debtor => {
                const row = document.createElement('tr');
                const totalOverdue = (debtor.days_31_60 || 0) + (debtor.days_61_90 || 0) + 
                                   (debtor.days_91_120 || 0) + (debtor.days_120_plus || 0);
                
                // Color code based on overdue amount
                let rowClass = '';
                if (totalOverdue > 0) {
                    if (debtor.days_120_plus > 0) rowClass = 'table-danger';
                    else if (debtor.days_91_120 > 0) rowClass = 'table-warning';
                    else if (debtor.days_61_90 > 0) rowClass = 'table-info';
                }
                
                row.className = rowClass;
                row.innerHTML = `
                    <td>
                        <strong>${debtor.customer_name}</strong><br>
                        <small class="text-muted">${debtor.phone || 'No phone'} | ${debtor.email || 'No email'}</small>
                    </td>
                    <td class="text-end">${formatCurrency(debtor.current || 0)}</td>
                    <td class="text-end">${formatCurrency(debtor.days_31_60 || 0)}</td>
                    <td class="text-end">${formatCurrency(debtor.days_61_90 || 0)}</td>
                    <td class="text-end">${formatCurrency((debtor.days_91_120 || 0) + (debtor.days_120_plus || 0))}</td>
                    <td class="text-end"><strong>${formatCurrency(debtor.total_outstanding || 0)}</strong></td>
                    <td class="text-center">${debtor.invoice_count || 0}</td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-outline-primary" onclick="showCustomerDetails('${debtor.customer_id}')">
                            <i class="bi bi-eye"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function updateAgingChart(summary) {
            const ctx = document.getElementById('agingChart');
            if (!ctx) return;
            
            // Destroy existing chart
            if (window.agingChart) {
                window.agingChart.destroy();
            }
            
            const data = {
                labels: ['Current', '31-60 Days', '61-90 Days', '90+ Days'],
                datasets: [{
                    label: 'Outstanding Amount',
                    data: [
                        summary.current || 0,
                        summary.days_31_60 || 0,
                        summary.days_61_90 || 0,
                        (summary.days_91_120 || 0) + (summary.days_120_plus || 0)
                    ],
                    backgroundColor: [
                        '#28a745', // Green for current
                        '#ffc107', // Yellow for 31-60
                        '#fd7e14', // Orange for 61-90
                        '#dc3545'  // Red for 90+
                    ],
                    borderWidth: 1
                }]
            };
            
            window.agingChart = new Chart(ctx, {
                type: 'doughnut',
                data: data,
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = formatCurrency(context.parsed);
                                    return context.label + ': ' + value;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function renderIFRSCompliance(ecl, compliance) {
            const container = document.getElementById('ifrsCompliance');
            if (!container || !ecl || !compliance) return;
            
            container.innerHTML = `
                <div class="card border-info">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0"><i class="bi bi-shield-check"></i> IFRS Compliance</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Standard:</strong> ${compliance.standard}</p>
                                <p><strong>Method:</strong> ${compliance.ecl_method}</p>
                                <p><strong>Provision Rate:</strong> ${(compliance.provision_rate * 100).toFixed(2)}%</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Total ECL Provision:</strong> ${formatCurrency(compliance.total_provision)}</p>
                                <p><strong>Methodology:</strong> ${ecl.ecl_methodology}</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        async function showCustomerDetails(customerId) {
            if (!customerId) {
                return;
            }

            const modalElement = document.getElementById('customerDetailsModal');
            const modalInstance = bootstrap.Modal.getOrCreateInstance(modalElement);
            const loadingIndicator = document.getElementById('customerDetailsLoading');
            const bodyContainer = document.getElementById('customerDetailsBody');
            const errorAlert = document.getElementById('customerDetailsError');
            const titleElement = document.getElementById('customerDetailsTitle');

            // Reset state
            bodyContainer.innerHTML = '';
            errorAlert.classList.add('d-none');
            errorAlert.textContent = '';
            loadingIndicator.classList.remove('d-none');
            titleElement.textContent = 'Customer Details';

            modalInstance.show();

            try {
                const detailUrl = `${API_CONFIG.ENDPOINTS.SALES_CUSTOMERS}/${customerId}`;
                const balanceUrl = `${API_CONFIG.ENDPOINTS.SALES_CUSTOMERS}/${customerId}/balance`;
                const recentSalesUrl = API_CONFIG.buildUrl('/sales/', {
                    customer_id: customerId,
                    limit: 5,
                    skip: 0
                });

                const [detailResponse, balanceResponse, salesResponse] = await Promise.all([
                    fetch(detailUrl, { headers: { Accept: 'application/json' } }),
                    fetch(balanceUrl, { headers: { Accept: 'application/json' } }),
                    fetch(recentSalesUrl, { headers: { Accept: 'application/json' } })
                ]);

                if (!detailResponse.ok) {
                    throw new Error(`Unable to load customer record (HTTP ${detailResponse.status})`);
                }

                const detailData = await detailResponse.json();
                const balanceData = balanceResponse.ok ? await balanceResponse.json() : { balance: 0 };
                const salesPayload = salesResponse.ok ? await salesResponse.json() : [];
                const salesData = Array.isArray(salesPayload) ? salesPayload : (salesPayload.data || salesPayload.value || salesPayload.results || []);

                const customerName = escapeHtml(detailData.name || 'Customer');
                titleElement.innerHTML = `<i class="bi bi-person-vcard me-2"></i>${customerName}`;

                const balanceAmount = typeof balanceData.balance === 'number' ? balanceData.balance : parseFloat(balanceData.balance || 0);
                const creditLimit = typeof detailData.credit_limit === 'number' ? detailData.credit_limit : parseFloat(detailData.credit_limit || 0);
                const contactLines = [detailData.email, detailData.phone, detailData.address].filter(Boolean).map((line) => `<p class="mb-1">${escapeHtml(line)}</p>`);
                const customerType = escapeHtml(detailData.customer_type || 'Retail');
                const paymentTerms = detailData.payment_terms ? `${Number(detailData.payment_terms)} days` : 'Standard';
                const vatNumber = detailData.vat_reg_number ? escapeHtml(detailData.vat_reg_number) : '';
                const notesMarkup = detailData.notes ? `<p class="mt-2 small text-muted">${escapeHtml(detailData.notes)}</p>` : '';

                const summaryHtml = `
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="card border-light">
                                <div class="card-body">
                                    <h6 class="fw-semibold mb-2"><i class="bi bi-person-lines-fill me-2"></i>Profile</h6>
                                    <p class="mb-1"><strong>Type:</strong> ${customerType}</p>
                                    <p class="mb-1"><strong>Status:</strong> ${(detailData.active ?? true) ? '<span class="badge bg-success">Active</span>' : '<span class="badge bg-secondary">Inactive</span>'}</p>
                                    ${contactLines.join('') || '<p class="text-muted mb-0">No contact information on file.</p>'}
                                    ${notesMarkup}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card border-light">
                                <div class="card-body">
                                    <h6 class="fw-semibold mb-2"><i class="bi bi-cash-coin me-2"></i>Account</h6>
                                    <p class="mb-1"><strong>Balance:</strong> ${formatCurrency(balanceAmount)}</p>
                                    <p class="mb-1"><strong>Credit Limit:</strong> ${creditLimit ? formatCurrency(creditLimit) : 'Not set'}</p>
                                    <p class="mb-1"><strong>Payment Terms:</strong> ${escapeHtml(paymentTerms)}</p>
                                    ${vatNumber ? `<p class="mb-0"><strong>VAT #:</strong> ${vatNumber}</p>` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                const salesRows = Array.isArray(salesData) && salesData.length
                    ? salesData.map((sale) => {
                        const saleDate = sale.date ? new Date(sale.date).toLocaleString() : '--';
                        const reference = escapeHtml(sale.reference || sale.id || 'Sale');
                        const paymentLabel = escapeHtml(sale.payment_method || 'N/A');
                        const status = escapeHtml(sale.status || 'Posted');
                        return `
                            <tr>
                                <td>${reference}</td>
                                <td>${escapeHtml(saleDate)}</td>
                                <td>${paymentLabel}</td>
                                <td class="text-end">${formatCurrency(sale.total_amount || 0)}</td>
                                <td class="text-end">${formatCurrency(sale.total_vat_amount || 0)}</td>
                                <td>${status}</td>
                            </tr>
                        `;
                    }).join('')
                    : `<tr><td colspan="6" class="text-center text-muted py-3">No recent sales found for this customer.</td></tr>`;

                const salesHtml = `
                    <div class="card border-light mt-4">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="bi bi-receipt-cutoff me-2"></i>Recent Sales</h6>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-sm table-striped mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Reference</th>
                                            <th>Date</th>
                                            <th>Payment</th>
                                            <th class="text-end">Total</th>
                                            <th class="text-end">VAT</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>${salesRows}</tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;

                bodyContainer.innerHTML = summaryHtml + salesHtml;
            } catch (error) {
                console.error('Failed to load customer details:', error);
                errorAlert.textContent = error.message || 'Unable to load customer details. Please try again.';
                errorAlert.classList.remove('d-none');
                bodyContainer.innerHTML = '';
            } finally {
                loadingIndicator.classList.add('d-none');
            }
        }
        
        // ========================================================================
        // PERFORMANCE DASHBOARD FUNCTIONS
        // ========================================================================
        
        async function loadPerformanceDashboard(branchId) {
            try {
                console.log('üîç Loading performance dashboard...');
                
                // Load multiple performance metrics in parallel
                const promises = [
                    fetch(`${API_BASE}/api/v1/reports/management/kpi-metrics`, {
                        headers: { 'Accept': 'application/json', 'Cache-Control': 'no-cache' }
                    }),
                    fetch(`${API_BASE}/api/v1/reports/performance/dashboard`, {
                        headers: { 'Accept': 'application/json', 'Cache-Control': 'no-cache' }
                    }),
                    fetch(`${API_BASE}/api/v1/reports/management/sales-report`, {
                        headers: { 'Accept': 'application/json', 'Cache-Control': 'no-cache' }
                    })
                ];
                
                const responses = await Promise.all(promises);
                const [kpiResponse, perfResponse, salesResponse] = responses;
                
                let kpiData = {}, perfData = {}, salesData = {};
                
                if (kpiResponse.ok) {
                    kpiData = await kpiResponse.json();
                }
                
                if (perfResponse.ok) {
                    const perfResult = await perfResponse.json();
                    perfData = perfResult.success ? perfResult.data : {};
                }
                
                if (salesResponse.ok) {
                    const salesResult = await salesResponse.json();
                    salesData = salesResult.sales_data || {};
                }
                
                console.log('üìä Performance data loaded:', { kpiData, perfData, salesData });
                
                renderPerformanceDashboard({ kpi: kpiData, performance: perfData, sales: salesData });
                
            } catch (error) {
                console.error('Error loading performance dashboard:', error);
                showError('Failed to load performance dashboard: ' + error.message);
                // Show empty state
                renderPerformanceDashboard({ 
                    kpi: {}, 
                    performance: {}, 
                    sales: {} 
                });
            }
            
            showReportSection('performanceDashboard');
        }
        
        function renderPerformanceDashboard(data) {
            console.log('üé® Rendering performance dashboard:', data);

            const kpi = (data.kpi && data.kpi.data) || data.kpi || {};
            const perf = (data.performance && data.performance.data) || data.performance || {};
            const sales = (data.sales && data.sales.data) || data.sales || {};
            const salesBreakdown = sales.sales_breakdown || {};

            const kpiElements = {
                perfTotalRevenue: formatCurrency(kpi.total_revenue || 0),
                perfNetProfit: formatCurrency(kpi.net_profit || 0),
                perfProfitMargin: `${((kpi.profit_margin || 0)).toFixed(1)}%`,
                perfTotalExpenses: formatCurrency(kpi.total_expenses || 0),
                perfRevenueGrowth: `${((kpi.revenue_trend || 0)).toFixed(1)}%`,
                perfProfitGrowth: `${((kpi.profit_trend || 0)).toFixed(1)}%`
            };

            Object.entries(kpiElements).forEach(([id, value]) => {
                const el = document.getElementById(id);
                if (!el) return;
                el.textContent = value;
                if (id.includes('Growth') || id.includes('Trend')) {
                    const numeric = parseFloat((value || '').toString().replace('%', '')) || 0;
                    el.classList.remove('text-success', 'text-danger', 'text-warning');
                    if (numeric > 0) el.classList.add('text-success');
                    else if (numeric < 0) el.classList.add('text-danger');
                    else el.classList.add('text-warning');
                }
            });

            const ratioElements = {
                perfInventoryTurnover: (perf.inventory_turnover || 0).toFixed(2),
                perfCurrentRatio: (perf.current_ratio || 0).toFixed(2),
                perfDebtRatio: `${(((perf.debt_ratio || 0) * 100)).toFixed(1)}%`,
                perfROA: `${(((perf.return_on_assets || 0) * 100)).toFixed(1)}%`
            };

            Object.entries(ratioElements).forEach(([id, value]) => {
                const el = document.getElementById(id);
                if (el) el.textContent = value;
            });

            const salesElements = {
                perfPOSSales: formatCurrency(salesBreakdown.pos_sales?.amount || 0),
                perfInvoiceSales: formatCurrency(salesBreakdown.invoices?.amount || 0),
                perfTotalOrders: sales.total_orders || 0,
                perfAvgOrderValue: formatCurrency(sales.average_order_value || 0)
            };

            Object.entries(salesElements).forEach(([id, value]) => {
                const el = document.getElementById(id);
                if (el) el.textContent = value;
            });

            const periodElement = document.getElementById('performancePeriod');
            if (periodElement && kpi.period_start && kpi.period_end) {
                periodElement.textContent = `${kpi.period_start} to ${kpi.period_end}`;
            }

            const monthlyTrend = perf.monthly_trend || sales.monthly_trend || kpi.monthly_trends || [];
            updatePerformanceCharts({
                today_sales: perf.today_sales || sales.today_sales || 0,
                yesterday_sales: perf.yesterday_sales || sales.yesterday_sales || 0,
                today_orders: perf.today_orders || sales.today_orders || 0,
                yesterday_orders: perf.yesterday_orders || sales.yesterday_orders || 0,
                growth_percentage: perf.growth_percentage ?? sales.growth_percentage ?? 0,
                monthly_trend: monthlyTrend
            });
        }

        // Currency formatting function
        function formatCurrency(amount) {
            if (typeof amount !== 'number') {
                amount = parseFloat(amount) || 0;
            }
            return new Intl.NumberFormat('en-BW', { 
                style: 'currency', 
                currency: 'BWP',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(amount);
        }

        // Initialize page with proper error handling
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                console.log('üöÄ Sales Reports page loaded');
                
                // Test API connection first
                const apiConnected = await testAPIConnection();
                if (!apiConnected) {
                    showError('Server connection failed. Please check if the application server is running.');
                    return;
                }
                
                // Wait for settings to load with timeout
                if (window.settingsLoader) {
                    await window.settingsLoader.init();
                } else {
                    console.warn('Settings loader not available, using defaults');
                }
                
                await initializePage();
                
            } catch (error) {
                console.error('Error initializing page:', error);
                showError('Failed to initialize page. Please refresh and try again.');
            }
        });
        
        // Initialize page components
        async function initializePage() {
            try {
                loadBranches();
                setDefaultDates();
                await loadSalesData();
            } catch (error) {
                console.error('Error in initializePage:', error);
                throw error;
            }
        }

        function setDefaultDates() {
            const today = new Date();
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(today.getDate() - 30);
            
            document.getElementById('startDate').value = thirtyDaysAgo.toISOString().split('T')[0];
            document.getElementById('endDate').value = today.toISOString().split('T')[0];
        }

        async function loadBranches() {
            try {
                const response = await fetch('/api/v1/branches/public');
                if (response.ok) {
                    const branches = await response.json();
                    const branchSelect = document.getElementById('branchFilter');
                    
                    if (branchSelect && Array.isArray(branches)) {
                        branches.forEach(branch => {
                            if (branch && branch.id && branch.name) {
                                const option = document.createElement('option');
                                option.value = branch.id;
                                option.textContent = branch.name;
                                branchSelect.appendChild(option);
                            }
                        });
                    }
                } else {
                    console.warn(`Failed to load branches: ${response.status}`);
                }
            } catch (error) {
                console.error('Error loading branches:', error);
                // Add fallback option
                const branchSelect = document.getElementById('branchFilter');
                if (branchSelect) {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'All Branches (Error loading branches)';
                    branchSelect.appendChild(option);
                }
            }
        }

        async function loadSalesData() {
            const reportType = document.getElementById('reportType').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const branchId = document.getElementById('branchFilter').value;

            showLoading();

            try {
                switch (reportType) {
                    case 'summary':
                        await loadSalesSummary(startDate, endDate, branchId);
                        break;
                    case 'daily':
                        await loadDailySalesReport(startDate, endDate, branchId);
                        showDailySalesFilters();
                        break;
                    case 'customers':
                        await loadCustomerAnalysis(branchId);
                        break;
                    case 'receivables':
                        await loadReceivablesAging(branchId);
                        break;
                    case 'performance':
                        await loadPerformanceDashboard(branchId);
                        break;
                }
                
                // Show/hide daily sales filters
                if (reportType === 'daily') {
                    showDailySalesFilters();
                } else {
                    hideDailySalesFilters();
                }
            } catch (error) {
                console.error('Error loading sales data:', error);
                showError(`Failed to load sales data: ${error.message}`);
                
                // Show default values to prevent UI errors
                if (reportType === 'summary') {
                    document.getElementById('totalSales').textContent = '0';
                    document.getElementById('totalAmount').textContent = formatCurrency(0);
                    document.getElementById('totalVat').textContent = formatCurrency(0);
                    document.getElementById('averageSale').textContent = formatCurrency(0);
                }
            } finally {
                hideLoading();
            }
        }

        async function loadSalesSummary(startDate, endDate, branchId) {
            console.log('üîç loadSalesSummary called with:', { startDate, endDate, branchId });
            
            const params = new URLSearchParams();
            if (startDate) params.append('start_date', startDate);
            if (endDate) params.append('end_date', endDate);
            if (branchId) params.append('branch_id', branchId);
            
            // Add cache busting parameter
            params.append('_t', Date.now());

            const url = API_CONFIG.buildUrl('/reports/management/sales-report', Object.fromEntries(new URLSearchParams(params)));
            console.log('üîó Fetching from URL:', url);
            
            const response = await fetch(url);
            console.log('üìä Response status:', response.status);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            console.log('üìà Received data:', data);
            
            const salesData = data.sales_data || {};
            console.log('üíº Sales data extracted:', salesData);

            // Update summary metrics - map from the actual data structure
            const totalSales = salesData.total_orders || 0;
            const totalAmount = salesData.total_sales || 0;
            const averageSale = salesData.average_order_value || 0;
            
            // Calculate VAT (assuming 14% VAT rate) - you may need to adjust this based on your actual VAT data
            const estimatedVat = totalAmount * 0.14;

            console.log('üìä Updating UI with metrics:', { totalSales, totalAmount, averageSale, estimatedVat });

            document.getElementById('totalSales').textContent = totalSales;
            document.getElementById('totalAmount').textContent = formatCurrency(totalAmount);
            document.getElementById('totalVat').textContent = formatCurrency(estimatedVat);
            document.getElementById('averageSale').textContent = formatCurrency(averageSale);
            
            // Update all components with enhanced data visualization
            updateSummaryCharts(salesData);
            updateTopCustomersList(salesData.top_customers || []);
            updateTopProductsList(salesData.top_products || []);
            updateDailyBreakdownChart(salesData.daily_breakdown || []);
            updateMonthlySalesChart(salesData.monthly_trend || []);
            updateSalesBreakdownSummary(salesData.sales_breakdown || {});

            console.log('‚úÖ Sales summary loaded successfully');
            showReportSection('salesSummary');
        }
        
        // Enhanced chart and data visualization functions
        function updateSummaryCharts(salesData) {
            // Update sales breakdown chart
            updateSalesMethodChart(salesData.sales_breakdown || {});
            
            // Update performance metrics
            const posCount = salesData.sales_breakdown?.pos_sales?.count || 0;
            const invoiceCount = salesData.sales_breakdown?.invoices?.count || 0;
            
            // Update additional metrics
            const metricsElements = {
                'totalPOSSales': formatCurrency(salesData.sales_breakdown?.pos_sales?.amount || 0),
                'totalInvoiceSales': formatCurrency(salesData.sales_breakdown?.invoices?.amount || 0),
                'posTransactionCount': posCount,
                'invoiceTransactionCount': invoiceCount
            };
            
            Object.entries(metricsElements).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = value;
                }
            });
        }
        
        function updateSalesMethodChart(salesBreakdown) {
            const ctx = document.getElementById('salesMethodChart');
            if (!ctx) return;
            
            // Destroy existing chart
            if (window.salesMethodChart) {
                window.salesMethodChart.destroy();
            }
            
            const posAmount = salesBreakdown.pos_sales?.amount || 0;
            const invoiceAmount = salesBreakdown.invoices?.amount || 0;
            
            window.salesMethodChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['POS Sales', 'Invoice Sales'],
                    datasets: [{
                        data: [posAmount, invoiceAmount],
                        backgroundColor: ['#28a745', '#007bff'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = posAmount + invoiceAmount;
                                    const percentage = total > 0 ? ((context.parsed / total) * 100).toFixed(1) : 0;
                                    return `${context.label}: ${formatCurrency(context.parsed)} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function updateTopProductsList(topProducts) {
            const container = document.getElementById('topProductsList');
            if (!container) return;
            
            if (!Array.isArray(topProducts) || topProducts.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted py-3">
                        <i class="bi bi-box-seam fs-1 mb-2"></i><br>
                        No product data available
                    </div>
                `;
                return;
            }
            
            const html = topProducts.slice(0, 5).map((product, index) => `
                <div class="d-flex justify-content-between align-items-center py-2 ${index < topProducts.length - 1 ? 'border-bottom' : ''}">
                    <div>
                        <div class="fw-bold">#${index + 1} ${product.name || 'Unknown Product'}</div>
                        <small class="text-muted">Sold: ${product.quantity || 0} units</small>
                    </div>
                    <div class="text-end">
                        <div class="fw-bold">${formatCurrency(product.total_revenue || 0)}</div>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = html;
        }
        
        function updateDailyBreakdownChart(dailyBreakdown) {
            const ctx = document.getElementById('dailyBreakdownChart');
            if (!ctx) return;
            
            // Destroy existing chart
            if (window.dailyBreakdownChart) {
                window.dailyBreakdownChart.destroy();
            }
            
            if (!Array.isArray(dailyBreakdown) || dailyBreakdown.length === 0) {
                return;
            }
            
            const labels = dailyBreakdown.map(day => {
                const date = new Date(day.date);
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            });
            const salesData = dailyBreakdown.map(day => day.sales || 0);
            const ordersData = dailyBreakdown.map(day => day.orders || 0);
            
            window.dailyBreakdownChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Sales Amount',
                        data: salesData,
                        borderColor: '#007bff',
                        backgroundColor: 'rgba(0, 123, 255, 0.1)',
                        tension: 0.4,
                        yAxisID: 'y'
                    }, {
                        label: 'Orders Count',
                        data: ordersData,
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        tension: 0.4,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        },
                        y1: {
                            type: 'linear',  
                            display: true,
                            position: 'right',
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    if (context.datasetIndex === 0) {
                                        return `Sales: ${formatCurrency(context.parsed.y)}`;
                                    } else {
                                        return `Orders: ${context.parsed.y}`;
                                    }
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function updateSalesBreakdownSummary(salesBreakdown) {
            // Update POS vs Invoice breakdown summary
            const posAmount = salesBreakdown.pos_sales?.amount || 0;
            const posVat = salesBreakdown.pos_sales?.vat || 0;
            const invoiceAmount = salesBreakdown.invoices?.amount || 0;
            const totalAmount = posAmount + invoiceAmount;
            
            // Calculate percentages
            const posPercentage = totalAmount > 0 ? ((posAmount / totalAmount) * 100).toFixed(1) : 0;
            const invoicePercentage = totalAmount > 0 ? ((invoiceAmount / totalAmount) * 100).toFixed(1) : 0;
            
            // Update breakdown summary elements
            const breakdownElements = {
                'posBreakdownAmount': formatCurrency(posAmount),
                'posBreakdownPercentage': `${posPercentage}%`,
                'invoiceBreakdownAmount': formatCurrency(invoiceAmount),
                'invoiceBreakdownPercentage': `${invoicePercentage}%`,
                'totalVatCollected': formatCurrency(posVat)
            };
            
            Object.entries(breakdownElements).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = value;
                }
            });
        }

        async function loadCustomerAnalysis(branchId) {
            const params = new URLSearchParams();
            if (branchId) params.append('branch_id', branchId);

            const response = await fetch(`/api/v1/reports/management/customer-analysis?${params}`);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();

            // The service returns data directly, not wrapped in 'summary'
            const customerData = data.data || data;
            document.getElementById('totalCustomers').textContent = customerData.total_customers || 0;
            document.getElementById('activeCustomers').textContent = customerData.total_customers || 0; // Service doesn't distinguish active/inactive
            document.getElementById('totalReceivables').textContent = formatCurrency(customerData.total_customer_value || 0);

            const activityRate = customerData.total_customers > 0 ? '100%' : '0%'; // Simplified since service doesn't track active
            document.getElementById('customerActivityRate').textContent = activityRate;

            // Update customer analysis table
            if (customerData.customers) {
                updateCustomerAnalysisTable(customerData.customers);
            }

            showReportSection('customerAnalysis');
        }
        function updatePaymentMethodsChart(paymentMethods) {
            const ctx = document.getElementById('paymentMethodsChart').getContext('2d');
            if (charts.paymentMethods) charts.paymentMethods.destroy();
            
            charts.paymentMethods = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: paymentMethods.map(pm => pm.method),
                    datasets: [{
                        data: paymentMethods.map(pm => pm.total),
                        backgroundColor: [
                            'rgba(75, 192, 192, 0.8)',
                            'rgba(255, 99, 132, 0.8)',
                            'rgba(255, 205, 86, 0.8)',
                            'rgba(54, 162, 235, 0.8)',
                            'rgba(153, 102, 255, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        }
                    }
                }
            });
        }

        function updateTopCustomersList(customers) {
            const container = document.getElementById('topCustomersList');
            
            let html = '';
            customers.forEach((customer, index) => {
                html += `
                    <div class="d-flex justify-content-between align-items-center mb-2">
                    <div>
                            <span class="fw-bold">${index + 1}. ${customer.customer_name || customer.name}</span>
                            <br>
                            <small class="text-muted">${customer.total_orders || customer.sales_count || 0} sales</small>
                        </div>
                        <span class="text-success fw-bold">${formatCurrency(customer.total_spent || customer.total_amount || 0)}</span>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function updateMonthlySalesChart(monthlyData) {
            console.log('üìä Updating monthly sales chart with data:', monthlyData);
            
            if (!monthlyData || !Array.isArray(monthlyData)) {
                console.warn('‚ö†Ô∏è Invalid monthly data for chart');
                return;
            }

            // Check if there's a chart container
            const chartContainer = document.getElementById('monthlySalesChart');
            if (!chartContainer) {
                console.warn('‚ö†Ô∏è Monthly sales chart container not found');
                return;
            }

            // Extract data for chart
            const labels = monthlyData.map(item => item.month || item.period);
            const salesData = monthlyData.map(item => item.sales || item.amount || 0);

            // If Chart.js is available, create/update chart
            if (typeof Chart !== 'undefined') {
                // Destroy existing chart if it exists
                if (window.monthlySalesChart) {
                    window.monthlySalesChart.destroy();
                }

                const ctx = chartContainer.getContext('2d');
                window.monthlySalesChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Monthly Sales',
                            data: salesData,
                            borderColor: '#0d6efd',
                            backgroundColor: 'rgba(13, 110, 253, 0.1)',
                            tension: 0.3,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return formatCurrency(value);
                                    }
                                }
                            }
                        }
                    }
                });
            } else {
                // Fallback: create a simple text representation
                let html = '<div class="monthly-sales-data">';
                monthlyData.forEach(item => {
                    const month = item.month || item.period;
                    const sales = item.sales || item.amount || 0;
                    html += `<div class="d-flex justify-content-between mb-2">
                        <span>${month}</span>
                        <span class="fw-bold">${formatCurrency(sales)}</span>
                    </div>`;
                });
                html += '</div>';
                chartContainer.innerHTML = html;
            }
        }

        function updateCustomerAnalysisTable(customers) {
            const container = document.getElementById('customerAnalysisTable');
            
            let html = `
                <div class="table-responsive">
                    <table class="table table-modern">
                        <thead>
                            <tr>
                                <th>Customer</th>
                                <th>Email</th>
                                <th>Sales Count</th>
                                <th>Total Sales</th>
                                <th>Account Balance</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            customers.forEach(customer => {
                html += `
                    <tr>
                        <td>${customer.customer_name || customer.name}</td>
                        <td>${customer.email || 'N/A'}</td>
                        <td>${customer.total_orders || customer.sales_count || 0}</td>
                        <td class="text-success">${formatCurrency(customer.total_spent || customer.total_sales || 0)}</td>
                        <td class="${(customer.account_balance || 0) >= 0 ? 'text-success' : 'text-danger'}">${formatCurrency(customer.account_balance || 0)}</td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = html;
        }

        function updateReceivablesAgingTable(data) {
            const container = document.getElementById('receivablesAgingTable');
            
            let html = `
                <div class="table-responsive">
                    <table class="table table-modern">
                        <thead>
                            <tr>
                                <th>Customer</th>
                                <th>Invoice</th>
                                <th>Due Date</th>
                                <th>Outstanding Amount</th>
                                <th>Days Overdue</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            // Add current receivables
            data.aging_buckets.current.forEach(invoice => {
                html += `
                    <tr class="table-success">
                        <td>${invoice.customer_name}</td>
                        <td>${invoice.invoice_number}</td>
                        <td>${invoice.due_date || 'N/A'}</td>
                        <td class="text-success">${formatCurrency(invoice.outstanding_amount)}</td>
                        <td>${invoice.days_overdue}</td>
                        <td><span class="badge-modern badge-success">Current</span></td>
                    </tr>
                `;
            });
            
            // Add overdue receivables
            [...data.aging_buckets['30_days'], ...data.aging_buckets['60_days']].forEach(invoice => {
                html += `
                    <tr class="table-warning">
                        <td>${invoice.customer_name}</td>
                        <td>${invoice.invoice_number}</td>
                        <td>${invoice.due_date || 'N/A'}</td>
                        <td class="text-warning">${formatCurrency(invoice.outstanding_amount)}</td>
                        <td>${invoice.days_overdue}</td>
                        <td><span class="badge-modern badge-warning">Overdue</span></td>
                    </tr>
                `;
            });
            
            // Add critical receivables
            [...data.aging_buckets['90_days'], ...data.aging_buckets['over_90_days']].forEach(invoice => {
                html += `
                    <tr class="table-danger">
                        <td>${invoice.customer_name}</td>
                        <td>${invoice.invoice_number}</td>
                        <td>${invoice.due_date || 'N/A'}</td>
                        <td class="text-danger">${formatCurrency(invoice.outstanding_amount)}</td>
                        <td>${invoice.days_overdue}</td>
                        <td><span class="badge-modern badge-danger">Critical</span></td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = html;
        }

        function updatePerformanceCharts(data) {
            const performanceCanvas = document.getElementById('salesPerformanceChart');
            if (performanceCanvas) {
                const performanceCtx = performanceCanvas.getContext('2d');
                if (charts.performance) charts.performance.destroy();

                charts.performance = new Chart(performanceCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Today', 'Yesterday'],
                        datasets: [{
                            label: 'Sales Amount',
                            data: [
                                data.today_sales || 0,
                                data.yesterday_sales || 0
                            ],
                            backgroundColor: [
                                'rgba(25, 135, 84, 0.8)',
                                'rgba(13, 110, 253, 0.8)'
                            ],
                            borderColor: ['#198754', '#0d6efd'],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: 'top' }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: (value) => formatCurrency(value)
                                }
                            }
                        }
                    }
                });
            }

            const monthlyCanvas = document.getElementById('monthlyTrendsChart');
            if (!monthlyCanvas) {
                return;
            }

            const trendData = Array.isArray(data.monthly_trend) ? data.monthly_trend.filter(Boolean) : [];
            const growth = Number(data.growth_percentage || 0);

            if (charts.trends) charts.trends.destroy();

            const monthlyCtx = monthlyCanvas.getContext('2d');

            if (trendData.length) {
                const labels = trendData.map((entry) => {
                    const label = entry.month || entry.period || entry.label || entry.date;
                    if (!label) return '';
                    const parsed = new Date(label);
                    if (!Number.isNaN(parsed.getTime())) {
                        return parsed.toLocaleDateString(undefined, { month: 'short', year: '2-digit' });
                    }
                    return label;
                });

                const revenueSeries = trendData.map((entry) => Number(entry.revenue ?? entry.sales ?? entry.amount ?? 0));
                const profitSeries = trendData.map((entry) => Number(entry.profit ?? entry.net_profit ?? entry.margin ?? 0));

                charts.trends = new Chart(monthlyCtx, {
                    type: 'line',
                    data: {
                        labels,
                        datasets: [
                            {
                                label: 'Revenue',
                                data: revenueSeries,
                                borderColor: '#0d6efd',
                                backgroundColor: 'rgba(13, 110, 253, 0.1)',
                                tension: 0.35,
                                fill: true
                            },
                            {
                                label: 'Profit',
                                data: profitSeries,
                                borderColor: '#198754',
                                backgroundColor: 'rgba(25, 135, 84, 0.1)',
                                tension: 0.35,
                                fill: true
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: 'bottom' },
                            tooltip: {
                                callbacks: {
                                    label: (context) => `${context.dataset.label}: ${formatCurrency(context.parsed.y)}`
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: (value) => formatCurrency(value)
                                }
                            }
                        }
                    }
                });
            } else {
                charts.trends = new Chart(monthlyCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Today Orders', 'Yesterday Orders', 'Growth %'],
                        datasets: [{
                            label: 'Performance Metrics',
                            data: [
                                data.today_orders || 0,
                                data.yesterday_orders || 0,
                                Math.abs(growth)
                            ],
                            backgroundColor: [
                                'rgba(25, 135, 84, 0.8)',
                                'rgba(255, 193, 7, 0.8)',
                                'rgba(220, 53, 69, 0.8)'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: 'bottom' }
                        }
                    }
                });
            }
        }

        function showReportSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.report-section').forEach(section => {
                section.style.display = 'none';
            });
            
            // Show selected section
            document.getElementById(sectionId).style.display = 'block';
        }

        function showLoading() {
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'loading';
            loadingDiv.className = 'position-fixed top-50 start-50 translate-middle';
            loadingDiv.innerHTML = `
                <div class="spinner-border text-success" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            `;
            document.body.appendChild(loadingDiv);
        }

        function hideLoading() {
            const loading = document.getElementById('loading');
            if (loading) {
                loading.remove();
            }
        }

        function showError(message) {
            console.error('üö® Error:', message);
            
            // Try to find error container first
            let errorContainer = document.getElementById('errorContainer');
            
            if (!errorContainer) {
                // Create error container if it doesn't exist
                errorContainer = document.createElement('div');
                errorContainer.id = 'errorContainer';
                errorContainer.className = 'position-fixed top-0 start-50 translate-middle-x mt-3';
                errorContainer.style.zIndex = '9999';
                document.body.appendChild(errorContainer);
            }
            
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger alert-dismissible fade show';
            alertDiv.innerHTML = `
                <i class="bi bi-exclamation-triangle"></i>
                <strong>Error:</strong> ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            errorContainer.appendChild(alertDiv);
            
            // Auto-remove after 8 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 8000);
        }

        async function exportReport() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const branchId = document.getElementById('branchFilter').value;
            const reportType = document.getElementById('reportType').value;

            const params = new URLSearchParams();
            if (startDate) params.append('start_date', startDate);
            if (endDate) params.append('end_date', endDate);
            if (branchId) params.append('branch_id', branchId);
            if (reportType) params.append('report_type', reportType);

            const exportUrl = `${API_CONFIG.ENDPOINTS.SALES_EXPORT}?${params.toString()}`;

            try {
                const response = await fetch(exportUrl, {
                    headers: {
                        Accept: 'text/csv, application/json',
                        'Cache-Control': 'no-cache'
                    }
                });

                if (!response.ok) {
                    throw new Error(`Export failed (HTTP ${response.status})`);
                }

                const blob = await response.blob();
                const contentDisposition = response.headers.get('Content-Disposition') || '';
                const filenameMatch = contentDisposition.match(/filename\*=UTF-8''([^;]+)|filename="?([^";]+)"?/);
                let filename = `sales-report-${Date.now()}.csv`;
                if (filenameMatch) {
                    const rawName = filenameMatch[1] || filenameMatch[2];
                    try {
                        filename = decodeURIComponent(rawName);
                    } catch (_) {
                        filename = rawName;
                    }
                }

                const downloadUrl = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = downloadUrl;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                link.remove();
                URL.revokeObjectURL(downloadUrl);
            } catch (error) {
                console.error('Sales report export failed:', error);
                showError(error.message || 'Unable to export sales report.');
            }
        }

        function printReport() {
            window.print();
        }

        // ========================================================================
        // DAILY SALES REPORT FUNCTIONS
        // ========================================================================

        function showDailySalesFilters() {
            document.getElementById('dailySalesFilters').style.display = 'block';
            loadUsersForFilter();
            loadDailySalesData();
        }

        function hideDailySalesFilters() {
            document.getElementById('dailySalesFilters').style.display = 'none';
        }

        async function loadUsersForFilter() {
            try {
                const response = await fetch(`${API_BASE}/api/v1/users/`, {
                    headers: {
                        'Accept': 'application/json',
                        'Cache-Control': 'no-cache'
                    }
                });
                
                if (response.ok) {
                    const users = await response.json();
                    const userFilter = document.getElementById('userFilter');
                    
                    if (userFilter && Array.isArray(users)) {
                        userFilter.innerHTML = '<option value="">All Users</option>';
                        
                        users.forEach(user => {
                            if (user && user.id) {
                                const option = document.createElement('option');
                                option.value = user.id;
                                const firstName = user.first_name || '';
                                const lastName = user.last_name || '';
                                const username = user.username || user.id;
                                option.textContent = `${firstName} ${lastName} (${username})`.trim();
                                userFilter.appendChild(option);
                            }
                        });
                    }
                } else {
                    console.warn(`Failed to load users: ${response.status} ${response.statusText}`);
                }
            } catch (error) {
                console.error('Error loading users:', error);
                // Add fallback option
                const userFilter = document.getElementById('userFilter');
                if (userFilter) {
                    userFilter.innerHTML = '<option value="">All Users</option><option value="error">Error loading users</option>';
                }
            }
        }

        async function loadDailySalesReport(startDate, endDate, branchId) {
            const reportDate = startDate || new Date().toISOString().split('T')[0];
            const endReportDate = endDate || reportDate;
            console.log('üîç loadDailySalesReport called with:', { startDate: reportDate, endDate: endReportDate, branchId });
            
            try {
                const params = new URLSearchParams({
                    start_date: reportDate,
                    end_date: endReportDate,
                    limit: 1000
                });
                
                if (branchId) params.append('branch_id', branchId);
                
                // Add cache busting parameter
                params.append('_t', Date.now());
                
                const url = API_CONFIG.buildUrl('/sales/', Object.fromEntries(new URLSearchParams(params)));
                console.log('üîó Fetching daily sales from URL:', url);
                
                const response = await fetch(url, {
                    headers: {
                        'Accept': 'application/json',
                        'Cache-Control': 'no-cache'
                    }
                });
                console.log('üìä Daily sales response status:', response.status);
                
                if (response.ok) {
                    const salesData = await response.json();
                    console.log('üìà Received daily sales data:', salesData);
                    
                    // Transform the sales data into a daily report format
                    const dailyReport = {
                        date: reportDate,
                        total_sales: Array.isArray(salesData) ? salesData.length : 0,
                        total_amount: Array.isArray(salesData) ? salesData.reduce((sum, sale) => sum + (sale.total_amount || 0), 0) : 0,
                        total_vat: Array.isArray(salesData) ? salesData.reduce((sum, sale) => sum + (sale.total_vat_amount || 0), 0) : 0,
                        total_ex_vat: Array.isArray(salesData) ? salesData.reduce((sum, sale) => sum + (sale.total_amount_ex_vat || 0), 0) : 0,
                        sales: Array.isArray(salesData) ? salesData : []
                    };
                    
                    // Aggregate payment methods (sum of amounts by method)
                    const paymentMethods = {};
                    const productsSold = {};
                    const salespersonStats = {};
                    
                    if (Array.isArray(salesData)) {
                        salesData.forEach(sale => {
                            // Payment methods aggregation
                            const method = (sale.payment_method || 'cash').toUpperCase();
                            paymentMethods[method] = (paymentMethods[method] || 0) + (sale.total_amount || 0);
                            
                            // Products sold aggregation
                            if (Array.isArray(sale.items)) {
                                sale.items.forEach(item => {
                                    const productName = item.product_name || 'Unknown Product';
                                    if (!productsSold[productName]) {
                                        productsSold[productName] = { quantity: 0, amount: 0 };
                                    }
                                    productsSold[productName].quantity += item.quantity || 0;
                                    productsSold[productName].amount += item.total_amount || 0;
                                });
                            }
                            
                            // Salesperson stats
                            const salesperson = sale.salesperson_name || 'Unknown';
                            if (!salespersonStats[salesperson]) {
                                salespersonStats[salesperson] = { sales: 0, amount: 0 };
                            }
                            salespersonStats[salesperson].sales += 1;
                            salespersonStats[salesperson].amount += sale.total_amount || 0;
                        });
                    }
                    
                    dailyReport.payment_methods = paymentMethods;
                    dailyReport.products_sold = productsSold;
                    dailyReport.salesperson_stats = salespersonStats;
                    
                    console.log('üìä Transformed daily report:', dailyReport);
                    renderDailySalesReport(dailyReport);
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
            } catch (error) {
                console.error('Error loading daily sales report:', error);
                showError('Failed to load daily sales report: ' + error.message);
                // Show empty state
                renderDailySalesReport({
                    date: reportDate,
                    total_sales: 0,
                    total_amount: 0,
                    total_vat: 0,
                    total_ex_vat: 0,
                    sales: [],
                    payment_methods: {},
                    products_sold: {},
                    salesperson_stats: {}
                });
            }
            
            showReportSection('dailySalesReport');
        }

        async function loadDailySalesData() {
            const startDate = document.getElementById('startDate').value || new Date().toISOString().split('T')[0];
            const branchId = document.getElementById('branchFilter').value;
            const userId = document.getElementById('userFilter').value;
            const sessionId = document.getElementById('sessionFilter').value;
            const paymentMethod = document.getElementById('paymentMethodFilter').value;
            const includeFloat = document.getElementById('includeFloat').value === 'true';
            
            // Override API host for data calls
            await loadDailySalesReport(startDate, null, branchId);
        }

        function renderDailySalesReport(data) {
            console.log('üé® Rendering daily sales report:', data);
            
            // Update summary cards
            const elements = {
                'dailyTransactionCount': data.total_sales || 0,
                'dailyTotalSales': formatCurrency(data.total_amount || 0),
                'dailyTotalVAT': formatCurrency(data.total_vat || 0),
                'dailyNetSales': formatCurrency(data.total_ex_vat || 0)
            };
            
            // Safe element updates
            Object.entries(elements).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = value;
                } else {
                    console.warn(`Element ${id} not found`);
                }
            });
            
            // Update payment method breakdown
            const paymentMethods = data.payment_methods || {};
            const cashSales = paymentMethods.CASH || 0;
            const cardSales = paymentMethods.CARD || paymentMethods.CREDIT_CARD || 0;
            const mobileSales = paymentMethods.MOBILE || paymentMethods.MOBILE_MONEY || 0;
            
            const paymentElements = {
                'dailyCashSales': formatCurrency(cashSales),
                'dailyCardSales': formatCurrency(cardSales),
                'dailyMobileSales': formatCurrency(mobileSales)
            };
            
            Object.entries(paymentElements).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = value;
                }
            });
            
            // Render transactions table
            renderDailyTransactionsTable(data.sales || []);
            
            // Update payment methods chart
            updateDailyPaymentMethodsChart(data.payment_methods || {});
            
            // Render top products
            renderTopProducts(data.products_sold || {});
            
            // Render salesperson performance
            renderSalespersonStats(data.salesperson_stats || {});
        }

        function renderTopProducts(productsSold) {
            const tbody = document.getElementById('topProductsTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            // Convert to array and sort by quantity sold
            const productsArray = Object.entries(productsSold)
                .map(([name, data]) => ({ name, ...data }))
                .sort((a, b) => b.quantity - a.quantity)
                .slice(0, 10); // Top 10 products
            
            if (productsArray.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center text-muted">
                            <i class="bi bi-info-circle me-2"></i>No products sold for selected date
                        </td>
                    </tr>
                `;
                return;
            }
            
            productsArray.forEach((product, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${product.name}</td>
                    <td>${product.quantity}</td>
                    <td>${formatCurrency(product.amount)}</td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function renderSalespersonStats(salespersonStats) {
            const tbody = document.getElementById('salespersonStatsTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            // Convert to array and sort by sales amount
            const statsArray = Object.entries(salespersonStats)
                .map(([name, data]) => ({ name, ...data }))
                .sort((a, b) => b.amount - a.amount);
            
            if (statsArray.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center text-muted">
                            <i class="bi bi-info-circle me-2"></i>No sales data available
                        </td>
                    </tr>
                `;
                return;
            }
            
            statsArray.forEach(stat => {
                const avgSale = stat.sales > 0 ? stat.amount / stat.sales : 0;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${stat.name}</td>
                    <td>${stat.sales}</td>
                    <td>${formatCurrency(stat.amount)}</td>
                    <td>${formatCurrency(avgSale)}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function renderPOSSessionsTable(sessions) {
            const tbody = document.getElementById('dailySessionsTableBody');
            if (!tbody) return;
            tbody.innerHTML = '';
            
            if (sessions.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="12" class="text-center text-muted">
                            <i class="bi bi-info-circle me-2"></i>No POS sessions found for selected date
                        </td>
                    </tr>
                `;
                return;
            }
            
            sessions.forEach(session => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <small class="font-monospace">${session.session_number || 'POS-' + (session.id?.substring(0, 8) || 'N/A')}</small>
                    </td>
                    <td>
                        <div class="d-flex align-items-center">
                            <i class="bi bi-person-circle me-2"></i>
                            <div>
                                <div class="fw-medium">${session.user_name || 'Unknown'}</div>
                                <small class="text-muted">${session.user_username || ''}</small>
                            </div>
                        </div>
                    </td>
                    <td>
                        <span class="badge bg-secondary">${session.branch_name || 'Main'}</span>
                    </td>
                    <td>
                        <span class="font-monospace">${session.till_id || 'TILL-01'}</span>
                    </td>
                    <td>
                        <small>${formatDateTime(session.opened_at)}</small>
                    </td>
                    <td>
                        <small>${session.closed_at ? formatDateTime(session.closed_at) : '<span class="text-warning">Open</span>'}</small>
                    </td>
                    <td>
                        <span class="fw-medium text-info">${formatCurrency(session.float_amount || 0)}</span>
                    </td>
                    <td>
                        <span class="fw-medium text-success">${formatCurrency(session.total_cash_sales || 0)}</span>
                    </td>
                    <td>
                        <span class="fw-medium text-warning">${formatCurrency(session.total_card_sales || 0)}</span>
                    </td>
                    <td>
                        <span class="fw-bold text-primary">${formatCurrency(session.total_sales || 0)}</span>
                    </td>
                    <td>
                        <span class="badge ${getSessionStatusBadge(session.status)}">${session.status || 'open'}</span>
                    </td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" onclick="viewSessionDetails('${session.id}')">
                                <i class="bi bi-eye"></i>
                            </button>
                            <button class="btn btn-outline-info" onclick="reconcileSession('${session.id}')">
                                <i class="bi bi-calculator"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function renderDailyTransactionsTable(transactions) {
            const tbody = document.getElementById('dailyTransactionsTableBody');
            tbody.innerHTML = '';
            
            if (transactions.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="12" class="text-center text-muted">
                            <i class="bi bi-info-circle me-2"></i>No transactions found for selected date
                        </td>
                    </tr>
                `;
                return;
            }
            
            transactions.forEach(transaction => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <small class="font-monospace">${formatTime(transaction.sale_time || transaction.created_at)}</small>
                    </td>
                    <td>
                        <small class="font-monospace">${transaction.id?.substring(0, 8) || 'N/A'}</small>
                    </td>
                    <td>
                        <div>
                            <div class="fw-medium">${transaction.customer_name || 'Walk-in Customer'}</div>
                            ${transaction.customer_phone ? `<small class="text-muted">${transaction.customer_phone}</small>` : ''}
                        </div>
                    </td>
                    <td>
                        <span class="badge ${getPaymentMethodBadge(transaction.payment_method)}">${transaction.payment_method || 'Cash'}</span>
                    </td>
                    <td>
                        <span class="text-muted">${formatCurrency(transaction.total_amount_ex_vat || 0)}</span>
                    </td>
                    <td>
                        <span class="text-info">${formatCurrency(transaction.total_vat_amount || 0)}</span>
                    </td>
                    <td>
                        <span class="fw-medium">${formatCurrency(transaction.total_amount || 0)}</span>
                    </td>
                    <td>
                        <span class="text-success">${formatCurrency(transaction.amount_tendered || 0)}</span>
                    </td>
                    <td>
                        <span class="text-warning">${formatCurrency(transaction.change_given || 0)}</span>
                    </td>
                    <td>
                        <small>${transaction.user_name || 'Unknown'}</small>
                    </td>
                    <td>
                        <span class="badge ${getSaleStatusBadge(transaction.status)}">${transaction.status || 'completed'}</span>
                    </td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" onclick="viewSaleDetails('${transaction.id}')">
                                <i class="bi bi-eye"></i>
                            </button>
                            <button class="btn btn-outline-success" onclick="printReceipt('${transaction.id}')">
                                <i class="bi bi-printer"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateCashSummary(summary) {
            document.getElementById('summaryOpeningFloat').textContent = formatCurrency(summary.total_float || 0);
            document.getElementById('summaryCashSales').textContent = formatCurrency(summary.cash_sales || 0);
            
            const totalExpected = (summary.total_float || 0) + (summary.cash_sales || 0);
            document.getElementById('summaryTotalExpected').textContent = formatCurrency(totalExpected);
            document.getElementById('summaryCashSubmitted').textContent = formatCurrency(summary.cash_submitted || 0);
            
            const variance = (summary.cash_submitted || 0) - totalExpected;
            const varianceElement = document.getElementById('summaryVariance');
            varianceElement.textContent = formatCurrency(variance);
            varianceElement.className = `text-end fw-bold ${variance >= 0 ? 'text-success' : 'text-danger'}`;
        }

        function updateDailyPaymentMethodsChart(paymentMethods) {
            const ctx = document.getElementById('paymentMethodsChart');
            if (!ctx) return;
            
            if (charts.paymentMethods) {
                charts.paymentMethods.destroy();
            }
            
            const labels = paymentMethods && typeof paymentMethods === 'object' ? Object.keys(paymentMethods) : [];
            const data = paymentMethods && typeof paymentMethods === 'object' ? Object.values(paymentMethods) : [];
            
            charts.paymentMethods = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            '#28a745', // Cash - Green
                            '#ffc107', // Card - Yellow
                            '#17a2b8', // Mobile Money - Cyan
                            '#6f42c1', // Other - Purple
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // Helper functions
        function formatDateTime(dateTimeString) {
            if (!dateTimeString) return 'N/A';
            const date = new Date(dateTimeString);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }

        function formatTime(dateTimeString) {
            if (!dateTimeString) return 'N/A';
            const date = new Date(dateTimeString);
            return date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }

        function getSessionStatusBadge(status) {
            switch (status?.toLowerCase()) {
                case 'open': return 'bg-success';
                case 'closed': return 'bg-secondary';
                case 'reconciled': return 'bg-primary';
                default: return 'bg-warning';
            }
        }

        function getPaymentMethodBadge(method) {
            switch (method?.toLowerCase()) {
                case 'cash': return 'bg-success';
                case 'card': return 'bg-warning';
                case 'mobile': return 'bg-info';
                default: return 'bg-secondary';
            }
        }

        function getSaleStatusBadge(status) {
            switch (status?.toLowerCase()) {
                case 'completed': return 'bg-success';
                case 'pending': return 'bg-warning';
                case 'cancelled': return 'bg-danger';
                default: return 'bg-secondary';
            }
        }

        function showErrorMessage(message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger alert-dismissible fade show';
            alertDiv.innerHTML = `
                <i class="bi bi-exclamation-triangle me-2"></i>
                <strong>Error:</strong> ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            const targetContainer = document.querySelector('#dailySalesReport .card-body') || document.querySelector('.container-fluid');
            targetContainer.insertBefore(alertDiv, targetContainer.firstChild);
        }

        // Export and action functions
        function exportDailySales() {
            alert('Daily sales export will be implemented');
        }

        function printDailySales() {
            window.print();
        }

        function viewSessionDetails(sessionId) {
            alert(`View session details: ${sessionId}`);
        }

        function reconcileSession(sessionId) {
            alert(`Reconcile session: ${sessionId}`);
        }

        function viewSaleDetails(saleId) {
            alert(`View sale details: ${saleId}`);
        }

        function printReceipt(saleId) {
            alert(`Print receipt for sale: ${saleId}`);
        }

        // Handle URL hash navigation
        window.addEventListener('hashchange', function() {
            const hash = window.location.hash.substring(1); // Remove the #
            if (hash === 'daily') {
                document.getElementById('reportType').value = 'daily';
                loadSalesData();
            }
        });

        // Check for hash on page load
        window.addEventListener('load', function() {
            const hash = window.location.hash.substring(1);
            if (hash === 'daily') {
                document.getElementById('reportType').value = 'daily';
                loadSalesData();
            }
        });
        
        // Real-time chart refresh system
        function refreshAllCharts() {
            console.log('üîÑ Refreshing all charts with latest data...');
            
            const reportType = document.getElementById('reportType')?.value || 'summary';
            const startDate = document.getElementById('startDate')?.value;
            const endDate = document.getElementById('endDate')?.value;
            const branchId = document.getElementById('branchFilter')?.value;
            
            switch (reportType) {
                case 'summary':
                    loadSalesSummary(startDate, endDate, branchId);
                    break;
                case 'daily':
                    loadDailySalesReport(startDate, endDate, branchId);
                    break;
                case 'receivables':
                    loadReceivablesAging(branchId); 
                    break;
                case 'performance':
                    loadPerformanceDashboard(branchId);
                    break;
            }
        }
        
        // Auto-refresh functionality
        let autoRefreshInterval = null;
        
        function startAutoRefresh(intervalMinutes = 5) {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            
            autoRefreshInterval = setInterval(refreshAllCharts, intervalMinutes * 60 * 1000);
            console.log(`‚úÖ Auto-refresh started (every ${intervalMinutes} minutes)`);
        }
        
        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                console.log('‚èπÔ∏è Auto-refresh stopped');
            }
        }
        
        // Start auto-refresh after page initialization
        window.addEventListener('load', function() {
            setTimeout(() => {
                startAutoRefresh(5); // Refresh every 5 minutes
            }, 10000); // Wait 10 seconds after page load
        });
    </script>
    <script src="../js/navbar.js?v=20250106001"></script>
</body>
    
    <script src="/static/js/navbar-loader.js"></script>
</html>